(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();function vc(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var dg={exports:{}},Zl={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var H_;function FO(){if(H_)return Zl;H_=1;var a=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(r,n,s){var l=null;if(s!==void 0&&(l=""+s),n.key!==void 0&&(l=""+n.key),"key"in n){s={};for(var c in n)c!=="key"&&(s[c]=n[c])}else s=n;return n=s.ref,{$$typeof:a,type:r,key:l,ref:n!==void 0?n:null,props:s}}return Zl.Fragment=e,Zl.jsx=t,Zl.jsxs=t,Zl}var z_;function qO(){return z_||(z_=1,dg.exports=FO()),dg.exports}var F=qO(),fg={exports:{}},Je={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var W_;function VO(){if(W_)return Je;W_=1;var a=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),t=Symbol.for("react.fragment"),r=Symbol.for("react.strict_mode"),n=Symbol.for("react.profiler"),s=Symbol.for("react.consumer"),l=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),v=Symbol.for("react.lazy"),p=Symbol.for("react.activity"),m=Symbol.iterator;function _(W){return W===null||typeof W!="object"?null:(W=m&&W[m]||W["@@iterator"],typeof W=="function"?W:null)}var b={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},E=Object.assign,M={};function O(W,ue,we){this.props=W,this.context=ue,this.refs=M,this.updater=we||b}O.prototype.isReactComponent={},O.prototype.setState=function(W,ue){if(typeof W!="object"&&typeof W!="function"&&W!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,W,ue,"setState")},O.prototype.forceUpdate=function(W){this.updater.enqueueForceUpdate(this,W,"forceUpdate")};function C(){}C.prototype=O.prototype;function U(W,ue,we){this.props=W,this.context=ue,this.refs=M,this.updater=we||b}var I=U.prototype=new C;I.constructor=U,E(I,O.prototype),I.isPureReactComponent=!0;var D=Array.isArray;function w(){}var N={H:null,A:null,T:null,S:null},A=Object.prototype.hasOwnProperty;function K(W,ue,we){var Z=we.ref;return{$$typeof:a,type:W,key:ue,ref:Z!==void 0?Z:null,props:we}}function z(W,ue){return K(W.type,ue,W.props)}function de(W){return typeof W=="object"&&W!==null&&W.$$typeof===a}function _e(W){var ue={"=":"=0",":":"=2"};return"$"+W.replace(/[=:]/g,function(we){return ue[we]})}var le=/\/+/g;function Ce(W,ue){return typeof W=="object"&&W!==null&&W.key!=null?_e(""+W.key):ue.toString(36)}function V(W){switch(W.status){case"fulfilled":return W.value;case"rejected":throw W.reason;default:switch(typeof W.status=="string"?W.then(w,w):(W.status="pending",W.then(function(ue){W.status==="pending"&&(W.status="fulfilled",W.value=ue)},function(ue){W.status==="pending"&&(W.status="rejected",W.reason=ue)})),W.status){case"fulfilled":return W.value;case"rejected":throw W.reason}}throw W}function B(W,ue,we,Z,pe){var G=typeof W;(G==="undefined"||G==="boolean")&&(W=null);var q=!1;if(W===null)q=!0;else switch(G){case"bigint":case"string":case"number":q=!0;break;case"object":switch(W.$$typeof){case a:case e:q=!0;break;case v:return q=W._init,B(q(W._payload),ue,we,Z,pe)}}if(q)return pe=pe(W),q=Z===""?"."+Ce(W,0):Z,D(pe)?(we="",q!=null&&(we=q.replace(le,"$&/")+"/"),B(pe,ue,we,"",function(P){return P})):pe!=null&&(de(pe)&&(pe=z(pe,we+(pe.key==null||W&&W.key===pe.key?"":(""+pe.key).replace(le,"$&/")+"/")+q)),ue.push(pe)),1;q=0;var x=Z===""?".":Z+":";if(D(W))for(var j=0;j<W.length;j++)Z=W[j],G=x+Ce(Z,j),q+=B(Z,ue,we,G,pe);else if(j=_(W),typeof j=="function")for(W=j.call(W),j=0;!(Z=W.next()).done;)Z=Z.value,G=x+Ce(Z,j++),q+=B(Z,ue,we,G,pe);else if(G==="object"){if(typeof W.then=="function")return B(V(W),ue,we,Z,pe);throw ue=String(W),Error("Objects are not valid as a React child (found: "+(ue==="[object Object]"?"object with keys {"+Object.keys(W).join(", ")+"}":ue)+"). If you meant to render a collection of children, use an array instead.")}return q}function te(W,ue,we){if(W==null)return W;var Z=[],pe=0;return B(W,Z,"","",function(G){return ue.call(we,G,pe++)}),Z}function he(W){if(W._status===-1){var ue=W._result;ue=ue(),ue.then(function(we){(W._status===0||W._status===-1)&&(W._status=1,W._result=we)},function(we){(W._status===0||W._status===-1)&&(W._status=2,W._result=we)}),W._status===-1&&(W._status=0,W._result=ue)}if(W._status===1)return W._result.default;throw W._result}var be=typeof reportError=="function"?reportError:function(W){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var ue=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof W=="object"&&W!==null&&typeof W.message=="string"?String(W.message):String(W),error:W});if(!window.dispatchEvent(ue))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",W);return}console.error(W)},De={map:te,forEach:function(W,ue,we){te(W,function(){ue.apply(this,arguments)},we)},count:function(W){var ue=0;return te(W,function(){ue++}),ue},toArray:function(W){return te(W,function(ue){return ue})||[]},only:function(W){if(!de(W))throw Error("React.Children.only expected to receive a single React element child.");return W}};return Je.Activity=p,Je.Children=De,Je.Component=O,Je.Fragment=t,Je.Profiler=n,Je.PureComponent=U,Je.StrictMode=r,Je.Suspense=d,Je.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=N,Je.__COMPILER_RUNTIME={__proto__:null,c:function(W){return N.H.useMemoCache(W)}},Je.cache=function(W){return function(){return W.apply(null,arguments)}},Je.cacheSignal=function(){return null},Je.cloneElement=function(W,ue,we){if(W==null)throw Error("The argument must be a React element, but you passed "+W+".");var Z=E({},W.props),pe=W.key;if(ue!=null)for(G in ue.key!==void 0&&(pe=""+ue.key),ue)!A.call(ue,G)||G==="key"||G==="__self"||G==="__source"||G==="ref"&&ue.ref===void 0||(Z[G]=ue[G]);var G=arguments.length-2;if(G===1)Z.children=we;else if(1<G){for(var q=Array(G),x=0;x<G;x++)q[x]=arguments[x+2];Z.children=q}return K(W.type,pe,Z)},Je.createContext=function(W){return W={$$typeof:l,_currentValue:W,_currentValue2:W,_threadCount:0,Provider:null,Consumer:null},W.Provider=W,W.Consumer={$$typeof:s,_context:W},W},Je.createElement=function(W,ue,we){var Z,pe={},G=null;if(ue!=null)for(Z in ue.key!==void 0&&(G=""+ue.key),ue)A.call(ue,Z)&&Z!=="key"&&Z!=="__self"&&Z!=="__source"&&(pe[Z]=ue[Z]);var q=arguments.length-2;if(q===1)pe.children=we;else if(1<q){for(var x=Array(q),j=0;j<q;j++)x[j]=arguments[j+2];pe.children=x}if(W&&W.defaultProps)for(Z in q=W.defaultProps,q)pe[Z]===void 0&&(pe[Z]=q[Z]);return K(W,G,pe)},Je.createRef=function(){return{current:null}},Je.forwardRef=function(W){return{$$typeof:c,render:W}},Je.isValidElement=de,Je.lazy=function(W){return{$$typeof:v,_payload:{_status:-1,_result:W},_init:he}},Je.memo=function(W,ue){return{$$typeof:h,type:W,compare:ue===void 0?null:ue}},Je.startTransition=function(W){var ue=N.T,we={};N.T=we;try{var Z=W(),pe=N.S;pe!==null&&pe(we,Z),typeof Z=="object"&&Z!==null&&typeof Z.then=="function"&&Z.then(w,be)}catch(G){be(G)}finally{ue!==null&&we.types!==null&&(ue.types=we.types),N.T=ue}},Je.unstable_useCacheRefresh=function(){return N.H.useCacheRefresh()},Je.use=function(W){return N.H.use(W)},Je.useActionState=function(W,ue,we){return N.H.useActionState(W,ue,we)},Je.useCallback=function(W,ue){return N.H.useCallback(W,ue)},Je.useContext=function(W){return N.H.useContext(W)},Je.useDebugValue=function(){},Je.useDeferredValue=function(W,ue){return N.H.useDeferredValue(W,ue)},Je.useEffect=function(W,ue){return N.H.useEffect(W,ue)},Je.useEffectEvent=function(W){return N.H.useEffectEvent(W)},Je.useId=function(){return N.H.useId()},Je.useImperativeHandle=function(W,ue,we){return N.H.useImperativeHandle(W,ue,we)},Je.useInsertionEffect=function(W,ue){return N.H.useInsertionEffect(W,ue)},Je.useLayoutEffect=function(W,ue){return N.H.useLayoutEffect(W,ue)},Je.useMemo=function(W,ue){return N.H.useMemo(W,ue)},Je.useOptimistic=function(W,ue){return N.H.useOptimistic(W,ue)},Je.useReducer=function(W,ue,we){return N.H.useReducer(W,ue,we)},Je.useRef=function(W){return N.H.useRef(W)},Je.useState=function(W){return N.H.useState(W)},Je.useSyncExternalStore=function(W,ue,we){return N.H.useSyncExternalStore(W,ue,we)},Je.useTransition=function(){return N.H.useTransition()},Je.version="19.2.4",Je}var Y_;function em(){return Y_||(Y_=1,fg.exports=VO()),fg.exports}var kt=em();const Ud=vc(kt);var hg={exports:{}},eu={},vg={exports:{}},gg={};/**
 * @license React
 * scheduler.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var J_;function GO(){return J_||(J_=1,(function(a){function e(B,te){var he=B.length;B.push(te);e:for(;0<he;){var be=he-1>>>1,De=B[be];if(0<n(De,te))B[be]=te,B[he]=De,he=be;else break e}}function t(B){return B.length===0?null:B[0]}function r(B){if(B.length===0)return null;var te=B[0],he=B.pop();if(he!==te){B[0]=he;e:for(var be=0,De=B.length,W=De>>>1;be<W;){var ue=2*(be+1)-1,we=B[ue],Z=ue+1,pe=B[Z];if(0>n(we,he))Z<De&&0>n(pe,we)?(B[be]=pe,B[Z]=he,be=Z):(B[be]=we,B[ue]=he,be=ue);else if(Z<De&&0>n(pe,he))B[be]=pe,B[Z]=he,be=Z;else break e}}return te}function n(B,te){var he=B.sortIndex-te.sortIndex;return he!==0?he:B.id-te.id}if(a.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var s=performance;a.unstable_now=function(){return s.now()}}else{var l=Date,c=l.now();a.unstable_now=function(){return l.now()-c}}var d=[],h=[],v=1,p=null,m=3,_=!1,b=!1,E=!1,M=!1,O=typeof setTimeout=="function"?setTimeout:null,C=typeof clearTimeout=="function"?clearTimeout:null,U=typeof setImmediate<"u"?setImmediate:null;function I(B){for(var te=t(h);te!==null;){if(te.callback===null)r(h);else if(te.startTime<=B)r(h),te.sortIndex=te.expirationTime,e(d,te);else break;te=t(h)}}function D(B){if(E=!1,I(B),!b)if(t(d)!==null)b=!0,w||(w=!0,_e());else{var te=t(h);te!==null&&V(D,te.startTime-B)}}var w=!1,N=-1,A=5,K=-1;function z(){return M?!0:!(a.unstable_now()-K<A)}function de(){if(M=!1,w){var B=a.unstable_now();K=B;var te=!0;try{e:{b=!1,E&&(E=!1,C(N),N=-1),_=!0;var he=m;try{t:{for(I(B),p=t(d);p!==null&&!(p.expirationTime>B&&z());){var be=p.callback;if(typeof be=="function"){p.callback=null,m=p.priorityLevel;var De=be(p.expirationTime<=B);if(B=a.unstable_now(),typeof De=="function"){p.callback=De,I(B),te=!0;break t}p===t(d)&&r(d),I(B)}else r(d);p=t(d)}if(p!==null)te=!0;else{var W=t(h);W!==null&&V(D,W.startTime-B),te=!1}}break e}finally{p=null,m=he,_=!1}te=void 0}}finally{te?_e():w=!1}}}var _e;if(typeof U=="function")_e=function(){U(de)};else if(typeof MessageChannel<"u"){var le=new MessageChannel,Ce=le.port2;le.port1.onmessage=de,_e=function(){Ce.postMessage(null)}}else _e=function(){O(de,0)};function V(B,te){N=O(function(){B(a.unstable_now())},te)}a.unstable_IdlePriority=5,a.unstable_ImmediatePriority=1,a.unstable_LowPriority=4,a.unstable_NormalPriority=3,a.unstable_Profiling=null,a.unstable_UserBlockingPriority=2,a.unstable_cancelCallback=function(B){B.callback=null},a.unstable_forceFrameRate=function(B){0>B||125<B?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):A=0<B?Math.floor(1e3/B):5},a.unstable_getCurrentPriorityLevel=function(){return m},a.unstable_next=function(B){switch(m){case 1:case 2:case 3:var te=3;break;default:te=m}var he=m;m=te;try{return B()}finally{m=he}},a.unstable_requestPaint=function(){M=!0},a.unstable_runWithPriority=function(B,te){switch(B){case 1:case 2:case 3:case 4:case 5:break;default:B=3}var he=m;m=B;try{return te()}finally{m=he}},a.unstable_scheduleCallback=function(B,te,he){var be=a.unstable_now();switch(typeof he=="object"&&he!==null?(he=he.delay,he=typeof he=="number"&&0<he?be+he:be):he=be,B){case 1:var De=-1;break;case 2:De=250;break;case 5:De=1073741823;break;case 4:De=1e4;break;default:De=5e3}return De=he+De,B={id:v++,callback:te,priorityLevel:B,startTime:he,expirationTime:De,sortIndex:-1},he>be?(B.sortIndex=he,e(h,B),t(d)===null&&B===t(h)&&(E?(C(N),N=-1):E=!0,V(D,he-be))):(B.sortIndex=De,e(d,B),b||_||(b=!0,w||(w=!0,_e()))),B},a.unstable_shouldYield=z,a.unstable_wrapCallback=function(B){var te=m;return function(){var he=m;m=te;try{return B.apply(this,arguments)}finally{m=he}}}})(gg)),gg}var Q_;function HO(){return Q_||(Q_=1,vg.exports=GO()),vg.exports}var pg={exports:{}},Dr={};/**
 * @license React
 * react-dom.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var X_;function zO(){if(X_)return Dr;X_=1;var a=em();function e(d){var h="https://react.dev/errors/"+d;if(1<arguments.length){h+="?args[]="+encodeURIComponent(arguments[1]);for(var v=2;v<arguments.length;v++)h+="&args[]="+encodeURIComponent(arguments[v])}return"Minified React error #"+d+"; visit "+h+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function t(){}var r={d:{f:t,r:function(){throw Error(e(522))},D:t,C:t,L:t,m:t,X:t,S:t,M:t},p:0,findDOMNode:null},n=Symbol.for("react.portal");function s(d,h,v){var p=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:n,key:p==null?null:""+p,children:d,containerInfo:h,implementation:v}}var l=a.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function c(d,h){if(d==="font")return"";if(typeof h=="string")return h==="use-credentials"?h:""}return Dr.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=r,Dr.createPortal=function(d,h){var v=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!h||h.nodeType!==1&&h.nodeType!==9&&h.nodeType!==11)throw Error(e(299));return s(d,h,null,v)},Dr.flushSync=function(d){var h=l.T,v=r.p;try{if(l.T=null,r.p=2,d)return d()}finally{l.T=h,r.p=v,r.d.f()}},Dr.preconnect=function(d,h){typeof d=="string"&&(h?(h=h.crossOrigin,h=typeof h=="string"?h==="use-credentials"?h:"":void 0):h=null,r.d.C(d,h))},Dr.prefetchDNS=function(d){typeof d=="string"&&r.d.D(d)},Dr.preinit=function(d,h){if(typeof d=="string"&&h&&typeof h.as=="string"){var v=h.as,p=c(v,h.crossOrigin),m=typeof h.integrity=="string"?h.integrity:void 0,_=typeof h.fetchPriority=="string"?h.fetchPriority:void 0;v==="style"?r.d.S(d,typeof h.precedence=="string"?h.precedence:void 0,{crossOrigin:p,integrity:m,fetchPriority:_}):v==="script"&&r.d.X(d,{crossOrigin:p,integrity:m,fetchPriority:_,nonce:typeof h.nonce=="string"?h.nonce:void 0})}},Dr.preinitModule=function(d,h){if(typeof d=="string")if(typeof h=="object"&&h!==null){if(h.as==null||h.as==="script"){var v=c(h.as,h.crossOrigin);r.d.M(d,{crossOrigin:v,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0})}}else h==null&&r.d.M(d)},Dr.preload=function(d,h){if(typeof d=="string"&&typeof h=="object"&&h!==null&&typeof h.as=="string"){var v=h.as,p=c(v,h.crossOrigin);r.d.L(d,v,{crossOrigin:p,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0,type:typeof h.type=="string"?h.type:void 0,fetchPriority:typeof h.fetchPriority=="string"?h.fetchPriority:void 0,referrerPolicy:typeof h.referrerPolicy=="string"?h.referrerPolicy:void 0,imageSrcSet:typeof h.imageSrcSet=="string"?h.imageSrcSet:void 0,imageSizes:typeof h.imageSizes=="string"?h.imageSizes:void 0,media:typeof h.media=="string"?h.media:void 0})}},Dr.preloadModule=function(d,h){if(typeof d=="string")if(h){var v=c(h.as,h.crossOrigin);r.d.m(d,{as:typeof h.as=="string"&&h.as!=="script"?h.as:void 0,crossOrigin:v,integrity:typeof h.integrity=="string"?h.integrity:void 0})}else r.d.m(d)},Dr.requestFormReset=function(d){r.d.r(d)},Dr.unstable_batchedUpdates=function(d,h){return d(h)},Dr.useFormState=function(d,h,v){return l.H.useFormState(d,h,v)},Dr.useFormStatus=function(){return l.H.useHostTransitionStatus()},Dr.version="19.2.4",Dr}var $_;function WO(){if($_)return pg.exports;$_=1;function a(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(a)}catch(e){console.error(e)}}return a(),pg.exports=zO(),pg.exports}var Z_;function YO(){if(Z_)return eu;Z_=1;/**
 * @license React
 * react-dom-client.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var a=HO(),e=em(),t=WO();function r(i){var o="https://react.dev/errors/"+i;if(1<arguments.length){o+="?args[]="+encodeURIComponent(arguments[1]);for(var u=2;u<arguments.length;u++)o+="&args[]="+encodeURIComponent(arguments[u])}return"Minified React error #"+i+"; visit "+o+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function n(i){return!(!i||i.nodeType!==1&&i.nodeType!==9&&i.nodeType!==11)}function s(i){var o=i,u=i;if(i.alternate)for(;o.return;)o=o.return;else{i=o;do o=i,(o.flags&4098)!==0&&(u=o.return),i=o.return;while(i)}return o.tag===3?u:null}function l(i){if(i.tag===13){var o=i.memoizedState;if(o===null&&(i=i.alternate,i!==null&&(o=i.memoizedState)),o!==null)return o.dehydrated}return null}function c(i){if(i.tag===31){var o=i.memoizedState;if(o===null&&(i=i.alternate,i!==null&&(o=i.memoizedState)),o!==null)return o.dehydrated}return null}function d(i){if(s(i)!==i)throw Error(r(188))}function h(i){var o=i.alternate;if(!o){if(o=s(i),o===null)throw Error(r(188));return o!==i?null:i}for(var u=i,f=o;;){var g=u.return;if(g===null)break;var S=g.alternate;if(S===null){if(f=g.return,f!==null){u=f;continue}break}if(g.child===S.child){for(S=g.child;S;){if(S===u)return d(g),i;if(S===f)return d(g),o;S=S.sibling}throw Error(r(188))}if(u.return!==f.return)u=g,f=S;else{for(var k=!1,L=g.child;L;){if(L===u){k=!0,u=g,f=S;break}if(L===f){k=!0,f=g,u=S;break}L=L.sibling}if(!k){for(L=S.child;L;){if(L===u){k=!0,u=S,f=g;break}if(L===f){k=!0,f=S,u=g;break}L=L.sibling}if(!k)throw Error(r(189))}}if(u.alternate!==f)throw Error(r(190))}if(u.tag!==3)throw Error(r(188));return u.stateNode.current===u?i:o}function v(i){var o=i.tag;if(o===5||o===26||o===27||o===6)return i;for(i=i.child;i!==null;){if(o=v(i),o!==null)return o;i=i.sibling}return null}var p=Object.assign,m=Symbol.for("react.element"),_=Symbol.for("react.transitional.element"),b=Symbol.for("react.portal"),E=Symbol.for("react.fragment"),M=Symbol.for("react.strict_mode"),O=Symbol.for("react.profiler"),C=Symbol.for("react.consumer"),U=Symbol.for("react.context"),I=Symbol.for("react.forward_ref"),D=Symbol.for("react.suspense"),w=Symbol.for("react.suspense_list"),N=Symbol.for("react.memo"),A=Symbol.for("react.lazy"),K=Symbol.for("react.activity"),z=Symbol.for("react.memo_cache_sentinel"),de=Symbol.iterator;function _e(i){return i===null||typeof i!="object"?null:(i=de&&i[de]||i["@@iterator"],typeof i=="function"?i:null)}var le=Symbol.for("react.client.reference");function Ce(i){if(i==null)return null;if(typeof i=="function")return i.$$typeof===le?null:i.displayName||i.name||null;if(typeof i=="string")return i;switch(i){case E:return"Fragment";case O:return"Profiler";case M:return"StrictMode";case D:return"Suspense";case w:return"SuspenseList";case K:return"Activity"}if(typeof i=="object")switch(i.$$typeof){case b:return"Portal";case U:return i.displayName||"Context";case C:return(i._context.displayName||"Context")+".Consumer";case I:var o=i.render;return i=i.displayName,i||(i=o.displayName||o.name||"",i=i!==""?"ForwardRef("+i+")":"ForwardRef"),i;case N:return o=i.displayName||null,o!==null?o:Ce(i.type)||"Memo";case A:o=i._payload,i=i._init;try{return Ce(i(o))}catch{}}return null}var V=Array.isArray,B=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,te=t.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,he={pending:!1,data:null,method:null,action:null},be=[],De=-1;function W(i){return{current:i}}function ue(i){0>De||(i.current=be[De],be[De]=null,De--)}function we(i,o){De++,be[De]=i.current,i.current=o}var Z=W(null),pe=W(null),G=W(null),q=W(null);function x(i,o){switch(we(G,o),we(pe,i),we(Z,null),o.nodeType){case 9:case 11:i=(i=o.documentElement)&&(i=i.namespaceURI)?v_(i):0;break;default:if(i=o.tagName,o=o.namespaceURI)o=v_(o),i=g_(o,i);else switch(i){case"svg":i=1;break;case"math":i=2;break;default:i=0}}ue(Z),we(Z,i)}function j(){ue(Z),ue(pe),ue(G)}function P(i){i.memoizedState!==null&&we(q,i);var o=Z.current,u=g_(o,i.type);o!==u&&(we(pe,i),we(Z,u))}function J(i){pe.current===i&&(ue(Z),ue(pe)),q.current===i&&(ue(q),Jl._currentValue=he)}var Y,X;function re(i){if(Y===void 0)try{throw Error()}catch(u){var o=u.stack.trim().match(/\n( *(at )?)/);Y=o&&o[1]||"",X=-1<u.stack.indexOf(`
    at`)?" (<anonymous>)":-1<u.stack.indexOf("@")?"@unknown:0:0":""}return`
`+Y+i+X}var fe=!1;function Ee(i,o){if(!i||fe)return"";fe=!0;var u=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var f={DetermineComponentFrameRoot:function(){try{if(o){var Se=function(){throw Error()};if(Object.defineProperty(Se.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(Se,[])}catch(ve){var oe=ve}Reflect.construct(i,[],Se)}else{try{Se.call()}catch(ve){oe=ve}i.call(Se.prototype)}}else{try{throw Error()}catch(ve){oe=ve}(Se=i())&&typeof Se.catch=="function"&&Se.catch(function(){})}}catch(ve){if(ve&&oe&&typeof ve.stack=="string")return[ve.stack,oe.stack]}return[null,null]}};f.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var g=Object.getOwnPropertyDescriptor(f.DetermineComponentFrameRoot,"name");g&&g.configurable&&Object.defineProperty(f.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var S=f.DetermineComponentFrameRoot(),k=S[0],L=S[1];if(k&&L){var H=k.split(`
`),ae=L.split(`
`);for(g=f=0;f<H.length&&!H[f].includes("DetermineComponentFrameRoot");)f++;for(;g<ae.length&&!ae[g].includes("DetermineComponentFrameRoot");)g++;if(f===H.length||g===ae.length)for(f=H.length-1,g=ae.length-1;1<=f&&0<=g&&H[f]!==ae[g];)g--;for(;1<=f&&0<=g;f--,g--)if(H[f]!==ae[g]){if(f!==1||g!==1)do if(f--,g--,0>g||H[f]!==ae[g]){var me=`
`+H[f].replace(" at new "," at ");return i.displayName&&me.includes("<anonymous>")&&(me=me.replace("<anonymous>",i.displayName)),me}while(1<=f&&0<=g);break}}}finally{fe=!1,Error.prepareStackTrace=u}return(u=i?i.displayName||i.name:"")?re(u):""}function je(i,o){switch(i.tag){case 26:case 27:case 5:return re(i.type);case 16:return re("Lazy");case 13:return i.child!==o&&o!==null?re("Suspense Fallback"):re("Suspense");case 19:return re("SuspenseList");case 0:case 15:return Ee(i.type,!1);case 11:return Ee(i.type.render,!1);case 1:return Ee(i.type,!0);case 31:return re("Activity");default:return""}}function Le(i){try{var o="",u=null;do o+=je(i,u),u=i,i=i.return;while(i);return o}catch(f){return`
Error generating stack: `+f.message+`
`+f.stack}}var Ne=Object.prototype.hasOwnProperty,it=a.unstable_scheduleCallback,dt=a.unstable_cancelCallback,Nt=a.unstable_shouldYield,Ae=a.unstable_requestPaint,Ge=a.unstable_now,Pn=a.unstable_getCurrentPriorityLevel,_n=a.unstable_ImmediatePriority,Kt=a.unstable_UserBlockingPriority,Vr=a.unstable_NormalPriority,gi=a.unstable_LowPriority,$n=a.unstable_IdlePriority,Xi=a.log,Me=a.unstable_setDisableYieldValue,Te=null,ne=null;function ce(i){if(typeof Xi=="function"&&Me(i),ne&&typeof ne.setStrictMode=="function")try{ne.setStrictMode(Te,i)}catch{}}var ge=Math.clz32?Math.clz32:Ke,Re=Math.log,xe=Math.LN2;function Ke(i){return i>>>=0,i===0?32:31-(Re(i)/xe|0)|0}var rt=256,Tt=262144,wt=4194304;function Vt(i){var o=i&42;if(o!==0)return o;switch(i&-i){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return i&261888;case 262144:case 524288:case 1048576:case 2097152:return i&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return i&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return i}}function rn(i,o,u){var f=i.pendingLanes;if(f===0)return 0;var g=0,S=i.suspendedLanes,k=i.pingedLanes;i=i.warmLanes;var L=f&134217727;return L!==0?(f=L&~S,f!==0?g=Vt(f):(k&=L,k!==0?g=Vt(k):u||(u=L&~i,u!==0&&(g=Vt(u))))):(L=f&~S,L!==0?g=Vt(L):k!==0?g=Vt(k):u||(u=f&~i,u!==0&&(g=Vt(u)))),g===0?0:o!==0&&o!==g&&(o&S)===0&&(S=g&-g,u=o&-o,S>=u||S===32&&(u&4194048)!==0)?o:g}function nn(i,o){return(i.pendingLanes&~(i.suspendedLanes&~i.pingedLanes)&o)===0}function OC(i,o){switch(i){case 1:case 2:case 4:case 8:case 64:return o+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return o+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function Jm(){var i=wt;return wt<<=1,(wt&62914560)===0&&(wt=4194304),i}function Zf(i){for(var o=[],u=0;31>u;u++)o.push(i);return o}function ul(i,o){i.pendingLanes|=o,o!==268435456&&(i.suspendedLanes=0,i.pingedLanes=0,i.warmLanes=0)}function kC(i,o,u,f,g,S){var k=i.pendingLanes;i.pendingLanes=u,i.suspendedLanes=0,i.pingedLanes=0,i.warmLanes=0,i.expiredLanes&=u,i.entangledLanes&=u,i.errorRecoveryDisabledLanes&=u,i.shellSuspendCounter=0;var L=i.entanglements,H=i.expirationTimes,ae=i.hiddenUpdates;for(u=k&~u;0<u;){var me=31-ge(u),Se=1<<me;L[me]=0,H[me]=-1;var oe=ae[me];if(oe!==null)for(ae[me]=null,me=0;me<oe.length;me++){var ve=oe[me];ve!==null&&(ve.lane&=-536870913)}u&=~Se}f!==0&&Qm(i,f,0),S!==0&&g===0&&i.tag!==0&&(i.suspendedLanes|=S&~(k&~o))}function Qm(i,o,u){i.pendingLanes|=o,i.suspendedLanes&=~o;var f=31-ge(o);i.entangledLanes|=o,i.entanglements[f]=i.entanglements[f]|1073741824|u&261930}function Xm(i,o){var u=i.entangledLanes|=o;for(i=i.entanglements;u;){var f=31-ge(u),g=1<<f;g&o|i[f]&o&&(i[f]|=o),u&=~g}}function $m(i,o){var u=o&-o;return u=(u&42)!==0?1:eh(u),(u&(i.suspendedLanes|o))!==0?0:u}function eh(i){switch(i){case 2:i=1;break;case 8:i=4;break;case 32:i=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:i=128;break;case 268435456:i=134217728;break;default:i=0}return i}function th(i){return i&=-i,2<i?8<i?(i&134217727)!==0?32:268435456:8:2}function Zm(){var i=te.p;return i!==0?i:(i=window.event,i===void 0?32:B_(i.type))}function ey(i,o){var u=te.p;try{return te.p=i,o()}finally{te.p=u}}var $i=Math.random().toString(36).slice(2),Er="__reactFiber$"+$i,Gr="__reactProps$"+$i,Bs="__reactContainer$"+$i,rh="__reactEvents$"+$i,AC="__reactListeners$"+$i,DC="__reactHandles$"+$i,ty="__reactResources$"+$i,cl="__reactMarker$"+$i;function nh(i){delete i[Er],delete i[Gr],delete i[rh],delete i[AC],delete i[DC]}function Ks(i){var o=i[Er];if(o)return o;for(var u=i.parentNode;u;){if(o=u[Bs]||u[Er]){if(u=o.alternate,o.child!==null||u!==null&&u.child!==null)for(i=E_(i);i!==null;){if(u=i[Er])return u;i=E_(i)}return o}i=u,u=i.parentNode}return null}function js(i){if(i=i[Er]||i[Bs]){var o=i.tag;if(o===5||o===6||o===13||o===31||o===26||o===27||o===3)return i}return null}function dl(i){var o=i.tag;if(o===5||o===26||o===27||o===6)return i.stateNode;throw Error(r(33))}function Fs(i){var o=i[ty];return o||(o=i[ty]={hoistableStyles:new Map,hoistableScripts:new Map}),o}function vr(i){i[cl]=!0}var ry=new Set,ny={};function Ga(i,o){qs(i,o),qs(i+"Capture",o)}function qs(i,o){for(ny[i]=o,i=0;i<o.length;i++)ry.add(o[i])}var MC=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),iy={},ay={};function NC(i){return Ne.call(ay,i)?!0:Ne.call(iy,i)?!1:MC.test(i)?ay[i]=!0:(iy[i]=!0,!1)}function Ec(i,o,u){if(NC(o))if(u===null)i.removeAttribute(o);else{switch(typeof u){case"undefined":case"function":case"symbol":i.removeAttribute(o);return;case"boolean":var f=o.toLowerCase().slice(0,5);if(f!=="data-"&&f!=="aria-"){i.removeAttribute(o);return}}i.setAttribute(o,""+u)}}function Tc(i,o,u){if(u===null)i.removeAttribute(o);else{switch(typeof u){case"undefined":case"function":case"symbol":case"boolean":i.removeAttribute(o);return}i.setAttribute(o,""+u)}}function pi(i,o,u,f){if(f===null)i.removeAttribute(u);else{switch(typeof f){case"undefined":case"function":case"symbol":case"boolean":i.removeAttribute(u);return}i.setAttributeNS(o,u,""+f)}}function En(i){switch(typeof i){case"bigint":case"boolean":case"number":case"string":case"undefined":return i;case"object":return i;default:return""}}function sy(i){var o=i.type;return(i=i.nodeName)&&i.toLowerCase()==="input"&&(o==="checkbox"||o==="radio")}function UC(i,o,u){var f=Object.getOwnPropertyDescriptor(i.constructor.prototype,o);if(!i.hasOwnProperty(o)&&typeof f<"u"&&typeof f.get=="function"&&typeof f.set=="function"){var g=f.get,S=f.set;return Object.defineProperty(i,o,{configurable:!0,get:function(){return g.call(this)},set:function(k){u=""+k,S.call(this,k)}}),Object.defineProperty(i,o,{enumerable:f.enumerable}),{getValue:function(){return u},setValue:function(k){u=""+k},stopTracking:function(){i._valueTracker=null,delete i[o]}}}}function ih(i){if(!i._valueTracker){var o=sy(i)?"checked":"value";i._valueTracker=UC(i,o,""+i[o])}}function oy(i){if(!i)return!1;var o=i._valueTracker;if(!o)return!0;var u=o.getValue(),f="";return i&&(f=sy(i)?i.checked?"true":"false":i.value),i=f,i!==u?(o.setValue(i),!0):!1}function wc(i){if(i=i||(typeof document<"u"?document:void 0),typeof i>"u")return null;try{return i.activeElement||i.body}catch{return i.body}}var PC=/[\n"\\]/g;function Tn(i){return i.replace(PC,function(o){return"\\"+o.charCodeAt(0).toString(16)+" "})}function ah(i,o,u,f,g,S,k,L){i.name="",k!=null&&typeof k!="function"&&typeof k!="symbol"&&typeof k!="boolean"?i.type=k:i.removeAttribute("type"),o!=null?k==="number"?(o===0&&i.value===""||i.value!=o)&&(i.value=""+En(o)):i.value!==""+En(o)&&(i.value=""+En(o)):k!=="submit"&&k!=="reset"||i.removeAttribute("value"),o!=null?sh(i,k,En(o)):u!=null?sh(i,k,En(u)):f!=null&&i.removeAttribute("value"),g==null&&S!=null&&(i.defaultChecked=!!S),g!=null&&(i.checked=g&&typeof g!="function"&&typeof g!="symbol"),L!=null&&typeof L!="function"&&typeof L!="symbol"&&typeof L!="boolean"?i.name=""+En(L):i.removeAttribute("name")}function ly(i,o,u,f,g,S,k,L){if(S!=null&&typeof S!="function"&&typeof S!="symbol"&&typeof S!="boolean"&&(i.type=S),o!=null||u!=null){if(!(S!=="submit"&&S!=="reset"||o!=null)){ih(i);return}u=u!=null?""+En(u):"",o=o!=null?""+En(o):u,L||o===i.value||(i.value=o),i.defaultValue=o}f=f??g,f=typeof f!="function"&&typeof f!="symbol"&&!!f,i.checked=L?i.checked:!!f,i.defaultChecked=!!f,k!=null&&typeof k!="function"&&typeof k!="symbol"&&typeof k!="boolean"&&(i.name=k),ih(i)}function sh(i,o,u){o==="number"&&wc(i.ownerDocument)===i||i.defaultValue===""+u||(i.defaultValue=""+u)}function Vs(i,o,u,f){if(i=i.options,o){o={};for(var g=0;g<u.length;g++)o["$"+u[g]]=!0;for(u=0;u<i.length;u++)g=o.hasOwnProperty("$"+i[u].value),i[u].selected!==g&&(i[u].selected=g),g&&f&&(i[u].defaultSelected=!0)}else{for(u=""+En(u),o=null,g=0;g<i.length;g++){if(i[g].value===u){i[g].selected=!0,f&&(i[g].defaultSelected=!0);return}o!==null||i[g].disabled||(o=i[g])}o!==null&&(o.selected=!0)}}function uy(i,o,u){if(o!=null&&(o=""+En(o),o!==i.value&&(i.value=o),u==null)){i.defaultValue!==o&&(i.defaultValue=o);return}i.defaultValue=u!=null?""+En(u):""}function cy(i,o,u,f){if(o==null){if(f!=null){if(u!=null)throw Error(r(92));if(V(f)){if(1<f.length)throw Error(r(93));f=f[0]}u=f}u==null&&(u=""),o=u}u=En(o),i.defaultValue=u,f=i.textContent,f===u&&f!==""&&f!==null&&(i.value=f),ih(i)}function Gs(i,o){if(o){var u=i.firstChild;if(u&&u===i.lastChild&&u.nodeType===3){u.nodeValue=o;return}}i.textContent=o}var LC=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function dy(i,o,u){var f=o.indexOf("--")===0;u==null||typeof u=="boolean"||u===""?f?i.setProperty(o,""):o==="float"?i.cssFloat="":i[o]="":f?i.setProperty(o,u):typeof u!="number"||u===0||LC.has(o)?o==="float"?i.cssFloat=u:i[o]=(""+u).trim():i[o]=u+"px"}function fy(i,o,u){if(o!=null&&typeof o!="object")throw Error(r(62));if(i=i.style,u!=null){for(var f in u)!u.hasOwnProperty(f)||o!=null&&o.hasOwnProperty(f)||(f.indexOf("--")===0?i.setProperty(f,""):f==="float"?i.cssFloat="":i[f]="");for(var g in o)f=o[g],o.hasOwnProperty(g)&&u[g]!==f&&dy(i,g,f)}else for(var S in o)o.hasOwnProperty(S)&&dy(i,S,o[S])}function oh(i){if(i.indexOf("-")===-1)return!1;switch(i){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var xC=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),BC=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Rc(i){return BC.test(""+i)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":i}function mi(){}var lh=null;function uh(i){return i=i.target||i.srcElement||window,i.correspondingUseElement&&(i=i.correspondingUseElement),i.nodeType===3?i.parentNode:i}var Hs=null,zs=null;function hy(i){var o=js(i);if(o&&(i=o.stateNode)){var u=i[Gr]||null;e:switch(i=o.stateNode,o.type){case"input":if(ah(i,u.value,u.defaultValue,u.defaultValue,u.checked,u.defaultChecked,u.type,u.name),o=u.name,u.type==="radio"&&o!=null){for(u=i;u.parentNode;)u=u.parentNode;for(u=u.querySelectorAll('input[name="'+Tn(""+o)+'"][type="radio"]'),o=0;o<u.length;o++){var f=u[o];if(f!==i&&f.form===i.form){var g=f[Gr]||null;if(!g)throw Error(r(90));ah(f,g.value,g.defaultValue,g.defaultValue,g.checked,g.defaultChecked,g.type,g.name)}}for(o=0;o<u.length;o++)f=u[o],f.form===i.form&&oy(f)}break e;case"textarea":uy(i,u.value,u.defaultValue);break e;case"select":o=u.value,o!=null&&Vs(i,!!u.multiple,o,!1)}}}var ch=!1;function vy(i,o,u){if(ch)return i(o,u);ch=!0;try{var f=i(o);return f}finally{if(ch=!1,(Hs!==null||zs!==null)&&(fd(),Hs&&(o=Hs,i=zs,zs=Hs=null,hy(o),i)))for(o=0;o<i.length;o++)hy(i[o])}}function fl(i,o){var u=i.stateNode;if(u===null)return null;var f=u[Gr]||null;if(f===null)return null;u=f[o];e:switch(o){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(f=!f.disabled)||(i=i.type,f=!(i==="button"||i==="input"||i==="select"||i==="textarea")),i=!f;break e;default:i=!1}if(i)return null;if(u&&typeof u!="function")throw Error(r(231,o,typeof u));return u}var yi=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),dh=!1;if(yi)try{var hl={};Object.defineProperty(hl,"passive",{get:function(){dh=!0}}),window.addEventListener("test",hl,hl),window.removeEventListener("test",hl,hl)}catch{dh=!1}var Zi=null,fh=null,Cc=null;function gy(){if(Cc)return Cc;var i,o=fh,u=o.length,f,g="value"in Zi?Zi.value:Zi.textContent,S=g.length;for(i=0;i<u&&o[i]===g[i];i++);var k=u-i;for(f=1;f<=k&&o[u-f]===g[S-f];f++);return Cc=g.slice(i,1<f?1-f:void 0)}function Ic(i){var o=i.keyCode;return"charCode"in i?(i=i.charCode,i===0&&o===13&&(i=13)):i=o,i===10&&(i=13),32<=i||i===13?i:0}function Oc(){return!0}function py(){return!1}function Hr(i){function o(u,f,g,S,k){this._reactName=u,this._targetInst=g,this.type=f,this.nativeEvent=S,this.target=k,this.currentTarget=null;for(var L in i)i.hasOwnProperty(L)&&(u=i[L],this[L]=u?u(S):S[L]);return this.isDefaultPrevented=(S.defaultPrevented!=null?S.defaultPrevented:S.returnValue===!1)?Oc:py,this.isPropagationStopped=py,this}return p(o.prototype,{preventDefault:function(){this.defaultPrevented=!0;var u=this.nativeEvent;u&&(u.preventDefault?u.preventDefault():typeof u.returnValue!="unknown"&&(u.returnValue=!1),this.isDefaultPrevented=Oc)},stopPropagation:function(){var u=this.nativeEvent;u&&(u.stopPropagation?u.stopPropagation():typeof u.cancelBubble!="unknown"&&(u.cancelBubble=!0),this.isPropagationStopped=Oc)},persist:function(){},isPersistent:Oc}),o}var Ha={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(i){return i.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},kc=Hr(Ha),vl=p({},Ha,{view:0,detail:0}),KC=Hr(vl),hh,vh,gl,Ac=p({},vl,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:ph,button:0,buttons:0,relatedTarget:function(i){return i.relatedTarget===void 0?i.fromElement===i.srcElement?i.toElement:i.fromElement:i.relatedTarget},movementX:function(i){return"movementX"in i?i.movementX:(i!==gl&&(gl&&i.type==="mousemove"?(hh=i.screenX-gl.screenX,vh=i.screenY-gl.screenY):vh=hh=0,gl=i),hh)},movementY:function(i){return"movementY"in i?i.movementY:vh}}),my=Hr(Ac),jC=p({},Ac,{dataTransfer:0}),FC=Hr(jC),qC=p({},vl,{relatedTarget:0}),gh=Hr(qC),VC=p({},Ha,{animationName:0,elapsedTime:0,pseudoElement:0}),GC=Hr(VC),HC=p({},Ha,{clipboardData:function(i){return"clipboardData"in i?i.clipboardData:window.clipboardData}}),zC=Hr(HC),WC=p({},Ha,{data:0}),yy=Hr(WC),YC={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},JC={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},QC={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function XC(i){var o=this.nativeEvent;return o.getModifierState?o.getModifierState(i):(i=QC[i])?!!o[i]:!1}function ph(){return XC}var $C=p({},vl,{key:function(i){if(i.key){var o=YC[i.key]||i.key;if(o!=="Unidentified")return o}return i.type==="keypress"?(i=Ic(i),i===13?"Enter":String.fromCharCode(i)):i.type==="keydown"||i.type==="keyup"?JC[i.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:ph,charCode:function(i){return i.type==="keypress"?Ic(i):0},keyCode:function(i){return i.type==="keydown"||i.type==="keyup"?i.keyCode:0},which:function(i){return i.type==="keypress"?Ic(i):i.type==="keydown"||i.type==="keyup"?i.keyCode:0}}),ZC=Hr($C),eI=p({},Ac,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Sy=Hr(eI),tI=p({},vl,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:ph}),rI=Hr(tI),nI=p({},Ha,{propertyName:0,elapsedTime:0,pseudoElement:0}),iI=Hr(nI),aI=p({},Ac,{deltaX:function(i){return"deltaX"in i?i.deltaX:"wheelDeltaX"in i?-i.wheelDeltaX:0},deltaY:function(i){return"deltaY"in i?i.deltaY:"wheelDeltaY"in i?-i.wheelDeltaY:"wheelDelta"in i?-i.wheelDelta:0},deltaZ:0,deltaMode:0}),sI=Hr(aI),oI=p({},Ha,{newState:0,oldState:0}),lI=Hr(oI),uI=[9,13,27,32],mh=yi&&"CompositionEvent"in window,pl=null;yi&&"documentMode"in document&&(pl=document.documentMode);var cI=yi&&"TextEvent"in window&&!pl,by=yi&&(!mh||pl&&8<pl&&11>=pl),_y=" ",Ey=!1;function Ty(i,o){switch(i){case"keyup":return uI.indexOf(o.keyCode)!==-1;case"keydown":return o.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function wy(i){return i=i.detail,typeof i=="object"&&"data"in i?i.data:null}var Ws=!1;function dI(i,o){switch(i){case"compositionend":return wy(o);case"keypress":return o.which!==32?null:(Ey=!0,_y);case"textInput":return i=o.data,i===_y&&Ey?null:i;default:return null}}function fI(i,o){if(Ws)return i==="compositionend"||!mh&&Ty(i,o)?(i=gy(),Cc=fh=Zi=null,Ws=!1,i):null;switch(i){case"paste":return null;case"keypress":if(!(o.ctrlKey||o.altKey||o.metaKey)||o.ctrlKey&&o.altKey){if(o.char&&1<o.char.length)return o.char;if(o.which)return String.fromCharCode(o.which)}return null;case"compositionend":return by&&o.locale!=="ko"?null:o.data;default:return null}}var hI={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Ry(i){var o=i&&i.nodeName&&i.nodeName.toLowerCase();return o==="input"?!!hI[i.type]:o==="textarea"}function Cy(i,o,u,f){Hs?zs?zs.push(f):zs=[f]:Hs=f,o=Sd(o,"onChange"),0<o.length&&(u=new kc("onChange","change",null,u,f),i.push({event:u,listeners:o}))}var ml=null,yl=null;function vI(i){l_(i,0)}function Dc(i){var o=dl(i);if(oy(o))return i}function Iy(i,o){if(i==="change")return o}var Oy=!1;if(yi){var yh;if(yi){var Sh="oninput"in document;if(!Sh){var ky=document.createElement("div");ky.setAttribute("oninput","return;"),Sh=typeof ky.oninput=="function"}yh=Sh}else yh=!1;Oy=yh&&(!document.documentMode||9<document.documentMode)}function Ay(){ml&&(ml.detachEvent("onpropertychange",Dy),yl=ml=null)}function Dy(i){if(i.propertyName==="value"&&Dc(yl)){var o=[];Cy(o,yl,i,uh(i)),vy(vI,o)}}function gI(i,o,u){i==="focusin"?(Ay(),ml=o,yl=u,ml.attachEvent("onpropertychange",Dy)):i==="focusout"&&Ay()}function pI(i){if(i==="selectionchange"||i==="keyup"||i==="keydown")return Dc(yl)}function mI(i,o){if(i==="click")return Dc(o)}function yI(i,o){if(i==="input"||i==="change")return Dc(o)}function SI(i,o){return i===o&&(i!==0||1/i===1/o)||i!==i&&o!==o}var an=typeof Object.is=="function"?Object.is:SI;function Sl(i,o){if(an(i,o))return!0;if(typeof i!="object"||i===null||typeof o!="object"||o===null)return!1;var u=Object.keys(i),f=Object.keys(o);if(u.length!==f.length)return!1;for(f=0;f<u.length;f++){var g=u[f];if(!Ne.call(o,g)||!an(i[g],o[g]))return!1}return!0}function My(i){for(;i&&i.firstChild;)i=i.firstChild;return i}function Ny(i,o){var u=My(i);i=0;for(var f;u;){if(u.nodeType===3){if(f=i+u.textContent.length,i<=o&&f>=o)return{node:u,offset:o-i};i=f}e:{for(;u;){if(u.nextSibling){u=u.nextSibling;break e}u=u.parentNode}u=void 0}u=My(u)}}function Uy(i,o){return i&&o?i===o?!0:i&&i.nodeType===3?!1:o&&o.nodeType===3?Uy(i,o.parentNode):"contains"in i?i.contains(o):i.compareDocumentPosition?!!(i.compareDocumentPosition(o)&16):!1:!1}function Py(i){i=i!=null&&i.ownerDocument!=null&&i.ownerDocument.defaultView!=null?i.ownerDocument.defaultView:window;for(var o=wc(i.document);o instanceof i.HTMLIFrameElement;){try{var u=typeof o.contentWindow.location.href=="string"}catch{u=!1}if(u)i=o.contentWindow;else break;o=wc(i.document)}return o}function bh(i){var o=i&&i.nodeName&&i.nodeName.toLowerCase();return o&&(o==="input"&&(i.type==="text"||i.type==="search"||i.type==="tel"||i.type==="url"||i.type==="password")||o==="textarea"||i.contentEditable==="true")}var bI=yi&&"documentMode"in document&&11>=document.documentMode,Ys=null,_h=null,bl=null,Eh=!1;function Ly(i,o,u){var f=u.window===u?u.document:u.nodeType===9?u:u.ownerDocument;Eh||Ys==null||Ys!==wc(f)||(f=Ys,"selectionStart"in f&&bh(f)?f={start:f.selectionStart,end:f.selectionEnd}:(f=(f.ownerDocument&&f.ownerDocument.defaultView||window).getSelection(),f={anchorNode:f.anchorNode,anchorOffset:f.anchorOffset,focusNode:f.focusNode,focusOffset:f.focusOffset}),bl&&Sl(bl,f)||(bl=f,f=Sd(_h,"onSelect"),0<f.length&&(o=new kc("onSelect","select",null,o,u),i.push({event:o,listeners:f}),o.target=Ys)))}function za(i,o){var u={};return u[i.toLowerCase()]=o.toLowerCase(),u["Webkit"+i]="webkit"+o,u["Moz"+i]="moz"+o,u}var Js={animationend:za("Animation","AnimationEnd"),animationiteration:za("Animation","AnimationIteration"),animationstart:za("Animation","AnimationStart"),transitionrun:za("Transition","TransitionRun"),transitionstart:za("Transition","TransitionStart"),transitioncancel:za("Transition","TransitionCancel"),transitionend:za("Transition","TransitionEnd")},Th={},xy={};yi&&(xy=document.createElement("div").style,"AnimationEvent"in window||(delete Js.animationend.animation,delete Js.animationiteration.animation,delete Js.animationstart.animation),"TransitionEvent"in window||delete Js.transitionend.transition);function Wa(i){if(Th[i])return Th[i];if(!Js[i])return i;var o=Js[i],u;for(u in o)if(o.hasOwnProperty(u)&&u in xy)return Th[i]=o[u];return i}var By=Wa("animationend"),Ky=Wa("animationiteration"),jy=Wa("animationstart"),_I=Wa("transitionrun"),EI=Wa("transitionstart"),TI=Wa("transitioncancel"),Fy=Wa("transitionend"),qy=new Map,wh="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");wh.push("scrollEnd");function Ln(i,o){qy.set(i,o),Ga(o,[i])}var Mc=typeof reportError=="function"?reportError:function(i){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var o=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof i=="object"&&i!==null&&typeof i.message=="string"?String(i.message):String(i),error:i});if(!window.dispatchEvent(o))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",i);return}console.error(i)},wn=[],Qs=0,Rh=0;function Nc(){for(var i=Qs,o=Rh=Qs=0;o<i;){var u=wn[o];wn[o++]=null;var f=wn[o];wn[o++]=null;var g=wn[o];wn[o++]=null;var S=wn[o];if(wn[o++]=null,f!==null&&g!==null){var k=f.pending;k===null?g.next=g:(g.next=k.next,k.next=g),f.pending=g}S!==0&&Vy(u,g,S)}}function Uc(i,o,u,f){wn[Qs++]=i,wn[Qs++]=o,wn[Qs++]=u,wn[Qs++]=f,Rh|=f,i.lanes|=f,i=i.alternate,i!==null&&(i.lanes|=f)}function Ch(i,o,u,f){return Uc(i,o,u,f),Pc(i)}function Ya(i,o){return Uc(i,null,null,o),Pc(i)}function Vy(i,o,u){i.lanes|=u;var f=i.alternate;f!==null&&(f.lanes|=u);for(var g=!1,S=i.return;S!==null;)S.childLanes|=u,f=S.alternate,f!==null&&(f.childLanes|=u),S.tag===22&&(i=S.stateNode,i===null||i._visibility&1||(g=!0)),i=S,S=S.return;return i.tag===3?(S=i.stateNode,g&&o!==null&&(g=31-ge(u),i=S.hiddenUpdates,f=i[g],f===null?i[g]=[o]:f.push(o),o.lane=u|536870912),S):null}function Pc(i){if(50<ql)throw ql=0,Pv=null,Error(r(185));for(var o=i.return;o!==null;)i=o,o=i.return;return i.tag===3?i.stateNode:null}var Xs={};function wI(i,o,u,f){this.tag=i,this.key=u,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=o,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=f,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function sn(i,o,u,f){return new wI(i,o,u,f)}function Ih(i){return i=i.prototype,!(!i||!i.isReactComponent)}function Si(i,o){var u=i.alternate;return u===null?(u=sn(i.tag,o,i.key,i.mode),u.elementType=i.elementType,u.type=i.type,u.stateNode=i.stateNode,u.alternate=i,i.alternate=u):(u.pendingProps=o,u.type=i.type,u.flags=0,u.subtreeFlags=0,u.deletions=null),u.flags=i.flags&65011712,u.childLanes=i.childLanes,u.lanes=i.lanes,u.child=i.child,u.memoizedProps=i.memoizedProps,u.memoizedState=i.memoizedState,u.updateQueue=i.updateQueue,o=i.dependencies,u.dependencies=o===null?null:{lanes:o.lanes,firstContext:o.firstContext},u.sibling=i.sibling,u.index=i.index,u.ref=i.ref,u.refCleanup=i.refCleanup,u}function Gy(i,o){i.flags&=65011714;var u=i.alternate;return u===null?(i.childLanes=0,i.lanes=o,i.child=null,i.subtreeFlags=0,i.memoizedProps=null,i.memoizedState=null,i.updateQueue=null,i.dependencies=null,i.stateNode=null):(i.childLanes=u.childLanes,i.lanes=u.lanes,i.child=u.child,i.subtreeFlags=0,i.deletions=null,i.memoizedProps=u.memoizedProps,i.memoizedState=u.memoizedState,i.updateQueue=u.updateQueue,i.type=u.type,o=u.dependencies,i.dependencies=o===null?null:{lanes:o.lanes,firstContext:o.firstContext}),i}function Lc(i,o,u,f,g,S){var k=0;if(f=i,typeof i=="function")Ih(i)&&(k=1);else if(typeof i=="string")k=kO(i,u,Z.current)?26:i==="html"||i==="head"||i==="body"?27:5;else e:switch(i){case K:return i=sn(31,u,o,g),i.elementType=K,i.lanes=S,i;case E:return Ja(u.children,g,S,o);case M:k=8,g|=24;break;case O:return i=sn(12,u,o,g|2),i.elementType=O,i.lanes=S,i;case D:return i=sn(13,u,o,g),i.elementType=D,i.lanes=S,i;case w:return i=sn(19,u,o,g),i.elementType=w,i.lanes=S,i;default:if(typeof i=="object"&&i!==null)switch(i.$$typeof){case U:k=10;break e;case C:k=9;break e;case I:k=11;break e;case N:k=14;break e;case A:k=16,f=null;break e}k=29,u=Error(r(130,i===null?"null":typeof i,"")),f=null}return o=sn(k,u,o,g),o.elementType=i,o.type=f,o.lanes=S,o}function Ja(i,o,u,f){return i=sn(7,i,f,o),i.lanes=u,i}function Oh(i,o,u){return i=sn(6,i,null,o),i.lanes=u,i}function Hy(i){var o=sn(18,null,null,0);return o.stateNode=i,o}function kh(i,o,u){return o=sn(4,i.children!==null?i.children:[],i.key,o),o.lanes=u,o.stateNode={containerInfo:i.containerInfo,pendingChildren:null,implementation:i.implementation},o}var zy=new WeakMap;function Rn(i,o){if(typeof i=="object"&&i!==null){var u=zy.get(i);return u!==void 0?u:(o={value:i,source:o,stack:Le(o)},zy.set(i,o),o)}return{value:i,source:o,stack:Le(o)}}var $s=[],Zs=0,xc=null,_l=0,Cn=[],In=0,ea=null,Zn=1,ei="";function bi(i,o){$s[Zs++]=_l,$s[Zs++]=xc,xc=i,_l=o}function Wy(i,o,u){Cn[In++]=Zn,Cn[In++]=ei,Cn[In++]=ea,ea=i;var f=Zn;i=ei;var g=32-ge(f)-1;f&=~(1<<g),u+=1;var S=32-ge(o)+g;if(30<S){var k=g-g%5;S=(f&(1<<k)-1).toString(32),f>>=k,g-=k,Zn=1<<32-ge(o)+g|u<<g|f,ei=S+i}else Zn=1<<S|u<<g|f,ei=i}function Ah(i){i.return!==null&&(bi(i,1),Wy(i,1,0))}function Dh(i){for(;i===xc;)xc=$s[--Zs],$s[Zs]=null,_l=$s[--Zs],$s[Zs]=null;for(;i===ea;)ea=Cn[--In],Cn[In]=null,ei=Cn[--In],Cn[In]=null,Zn=Cn[--In],Cn[In]=null}function Yy(i,o){Cn[In++]=Zn,Cn[In++]=ei,Cn[In++]=ea,Zn=o.id,ei=o.overflow,ea=i}var Tr=null,Lt=null,ft=!1,ta=null,On=!1,Mh=Error(r(519));function ra(i){var o=Error(r(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw El(Rn(o,i)),Mh}function Jy(i){var o=i.stateNode,u=i.type,f=i.memoizedProps;switch(o[Er]=i,o[Gr]=f,u){case"dialog":ot("cancel",o),ot("close",o);break;case"iframe":case"object":case"embed":ot("load",o);break;case"video":case"audio":for(u=0;u<Gl.length;u++)ot(Gl[u],o);break;case"source":ot("error",o);break;case"img":case"image":case"link":ot("error",o),ot("load",o);break;case"details":ot("toggle",o);break;case"input":ot("invalid",o),ly(o,f.value,f.defaultValue,f.checked,f.defaultChecked,f.type,f.name,!0);break;case"select":ot("invalid",o);break;case"textarea":ot("invalid",o),cy(o,f.value,f.defaultValue,f.children)}u=f.children,typeof u!="string"&&typeof u!="number"&&typeof u!="bigint"||o.textContent===""+u||f.suppressHydrationWarning===!0||f_(o.textContent,u)?(f.popover!=null&&(ot("beforetoggle",o),ot("toggle",o)),f.onScroll!=null&&ot("scroll",o),f.onScrollEnd!=null&&ot("scrollend",o),f.onClick!=null&&(o.onclick=mi),o=!0):o=!1,o||ra(i,!0)}function Qy(i){for(Tr=i.return;Tr;)switch(Tr.tag){case 5:case 31:case 13:On=!1;return;case 27:case 3:On=!0;return;default:Tr=Tr.return}}function eo(i){if(i!==Tr)return!1;if(!ft)return Qy(i),ft=!0,!1;var o=i.tag,u;if((u=o!==3&&o!==27)&&((u=o===5)&&(u=i.type,u=!(u!=="form"&&u!=="button")||Qv(i.type,i.memoizedProps)),u=!u),u&&Lt&&ra(i),Qy(i),o===13){if(i=i.memoizedState,i=i!==null?i.dehydrated:null,!i)throw Error(r(317));Lt=__(i)}else if(o===31){if(i=i.memoizedState,i=i!==null?i.dehydrated:null,!i)throw Error(r(317));Lt=__(i)}else o===27?(o=Lt,pa(i.type)?(i=tg,tg=null,Lt=i):Lt=o):Lt=Tr?An(i.stateNode.nextSibling):null;return!0}function Qa(){Lt=Tr=null,ft=!1}function Nh(){var i=ta;return i!==null&&(Jr===null?Jr=i:Jr.push.apply(Jr,i),ta=null),i}function El(i){ta===null?ta=[i]:ta.push(i)}var Uh=W(null),Xa=null,_i=null;function na(i,o,u){we(Uh,o._currentValue),o._currentValue=u}function Ei(i){i._currentValue=Uh.current,ue(Uh)}function Ph(i,o,u){for(;i!==null;){var f=i.alternate;if((i.childLanes&o)!==o?(i.childLanes|=o,f!==null&&(f.childLanes|=o)):f!==null&&(f.childLanes&o)!==o&&(f.childLanes|=o),i===u)break;i=i.return}}function Lh(i,o,u,f){var g=i.child;for(g!==null&&(g.return=i);g!==null;){var S=g.dependencies;if(S!==null){var k=g.child;S=S.firstContext;e:for(;S!==null;){var L=S;S=g;for(var H=0;H<o.length;H++)if(L.context===o[H]){S.lanes|=u,L=S.alternate,L!==null&&(L.lanes|=u),Ph(S.return,u,i),f||(k=null);break e}S=L.next}}else if(g.tag===18){if(k=g.return,k===null)throw Error(r(341));k.lanes|=u,S=k.alternate,S!==null&&(S.lanes|=u),Ph(k,u,i),k=null}else k=g.child;if(k!==null)k.return=g;else for(k=g;k!==null;){if(k===i){k=null;break}if(g=k.sibling,g!==null){g.return=k.return,k=g;break}k=k.return}g=k}}function to(i,o,u,f){i=null;for(var g=o,S=!1;g!==null;){if(!S){if((g.flags&524288)!==0)S=!0;else if((g.flags&262144)!==0)break}if(g.tag===10){var k=g.alternate;if(k===null)throw Error(r(387));if(k=k.memoizedProps,k!==null){var L=g.type;an(g.pendingProps.value,k.value)||(i!==null?i.push(L):i=[L])}}else if(g===q.current){if(k=g.alternate,k===null)throw Error(r(387));k.memoizedState.memoizedState!==g.memoizedState.memoizedState&&(i!==null?i.push(Jl):i=[Jl])}g=g.return}i!==null&&Lh(o,i,u,f),o.flags|=262144}function Bc(i){for(i=i.firstContext;i!==null;){if(!an(i.context._currentValue,i.memoizedValue))return!0;i=i.next}return!1}function $a(i){Xa=i,_i=null,i=i.dependencies,i!==null&&(i.firstContext=null)}function wr(i){return Xy(Xa,i)}function Kc(i,o){return Xa===null&&$a(i),Xy(i,o)}function Xy(i,o){var u=o._currentValue;if(o={context:o,memoizedValue:u,next:null},_i===null){if(i===null)throw Error(r(308));_i=o,i.dependencies={lanes:0,firstContext:o},i.flags|=524288}else _i=_i.next=o;return u}var RI=typeof AbortController<"u"?AbortController:function(){var i=[],o=this.signal={aborted:!1,addEventListener:function(u,f){i.push(f)}};this.abort=function(){o.aborted=!0,i.forEach(function(u){return u()})}},CI=a.unstable_scheduleCallback,II=a.unstable_NormalPriority,nr={$$typeof:U,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function xh(){return{controller:new RI,data:new Map,refCount:0}}function Tl(i){i.refCount--,i.refCount===0&&CI(II,function(){i.controller.abort()})}var wl=null,Bh=0,ro=0,no=null;function OI(i,o){if(wl===null){var u=wl=[];Bh=0,ro=Fv(),no={status:"pending",value:void 0,then:function(f){u.push(f)}}}return Bh++,o.then($y,$y),o}function $y(){if(--Bh===0&&wl!==null){no!==null&&(no.status="fulfilled");var i=wl;wl=null,ro=0,no=null;for(var o=0;o<i.length;o++)(0,i[o])()}}function kI(i,o){var u=[],f={status:"pending",value:null,reason:null,then:function(g){u.push(g)}};return i.then(function(){f.status="fulfilled",f.value=o;for(var g=0;g<u.length;g++)(0,u[g])(o)},function(g){for(f.status="rejected",f.reason=g,g=0;g<u.length;g++)(0,u[g])(void 0)}),f}var Zy=B.S;B.S=function(i,o){Lb=Ge(),typeof o=="object"&&o!==null&&typeof o.then=="function"&&OI(i,o),Zy!==null&&Zy(i,o)};var Za=W(null);function Kh(){var i=Za.current;return i!==null?i:At.pooledCache}function jc(i,o){o===null?we(Za,Za.current):we(Za,o.pool)}function eS(){var i=Kh();return i===null?null:{parent:nr._currentValue,pool:i}}var io=Error(r(460)),jh=Error(r(474)),Fc=Error(r(542)),qc={then:function(){}};function tS(i){return i=i.status,i==="fulfilled"||i==="rejected"}function rS(i,o,u){switch(u=i[u],u===void 0?i.push(o):u!==o&&(o.then(mi,mi),o=u),o.status){case"fulfilled":return o.value;case"rejected":throw i=o.reason,iS(i),i;default:if(typeof o.status=="string")o.then(mi,mi);else{if(i=At,i!==null&&100<i.shellSuspendCounter)throw Error(r(482));i=o,i.status="pending",i.then(function(f){if(o.status==="pending"){var g=o;g.status="fulfilled",g.value=f}},function(f){if(o.status==="pending"){var g=o;g.status="rejected",g.reason=f}})}switch(o.status){case"fulfilled":return o.value;case"rejected":throw i=o.reason,iS(i),i}throw ts=o,io}}function es(i){try{var o=i._init;return o(i._payload)}catch(u){throw u!==null&&typeof u=="object"&&typeof u.then=="function"?(ts=u,io):u}}var ts=null;function nS(){if(ts===null)throw Error(r(459));var i=ts;return ts=null,i}function iS(i){if(i===io||i===Fc)throw Error(r(483))}var ao=null,Rl=0;function Vc(i){var o=Rl;return Rl+=1,ao===null&&(ao=[]),rS(ao,i,o)}function Cl(i,o){o=o.props.ref,i.ref=o!==void 0?o:null}function Gc(i,o){throw o.$$typeof===m?Error(r(525)):(i=Object.prototype.toString.call(o),Error(r(31,i==="[object Object]"?"object with keys {"+Object.keys(o).join(", ")+"}":i)))}function aS(i){function o(ee,Q){if(i){var ie=ee.deletions;ie===null?(ee.deletions=[Q],ee.flags|=16):ie.push(Q)}}function u(ee,Q){if(!i)return null;for(;Q!==null;)o(ee,Q),Q=Q.sibling;return null}function f(ee){for(var Q=new Map;ee!==null;)ee.key!==null?Q.set(ee.key,ee):Q.set(ee.index,ee),ee=ee.sibling;return Q}function g(ee,Q){return ee=Si(ee,Q),ee.index=0,ee.sibling=null,ee}function S(ee,Q,ie){return ee.index=ie,i?(ie=ee.alternate,ie!==null?(ie=ie.index,ie<Q?(ee.flags|=67108866,Q):ie):(ee.flags|=67108866,Q)):(ee.flags|=1048576,Q)}function k(ee){return i&&ee.alternate===null&&(ee.flags|=67108866),ee}function L(ee,Q,ie,ye){return Q===null||Q.tag!==6?(Q=Oh(ie,ee.mode,ye),Q.return=ee,Q):(Q=g(Q,ie),Q.return=ee,Q)}function H(ee,Q,ie,ye){var qe=ie.type;return qe===E?me(ee,Q,ie.props.children,ye,ie.key):Q!==null&&(Q.elementType===qe||typeof qe=="object"&&qe!==null&&qe.$$typeof===A&&es(qe)===Q.type)?(Q=g(Q,ie.props),Cl(Q,ie),Q.return=ee,Q):(Q=Lc(ie.type,ie.key,ie.props,null,ee.mode,ye),Cl(Q,ie),Q.return=ee,Q)}function ae(ee,Q,ie,ye){return Q===null||Q.tag!==4||Q.stateNode.containerInfo!==ie.containerInfo||Q.stateNode.implementation!==ie.implementation?(Q=kh(ie,ee.mode,ye),Q.return=ee,Q):(Q=g(Q,ie.children||[]),Q.return=ee,Q)}function me(ee,Q,ie,ye,qe){return Q===null||Q.tag!==7?(Q=Ja(ie,ee.mode,ye,qe),Q.return=ee,Q):(Q=g(Q,ie),Q.return=ee,Q)}function Se(ee,Q,ie){if(typeof Q=="string"&&Q!==""||typeof Q=="number"||typeof Q=="bigint")return Q=Oh(""+Q,ee.mode,ie),Q.return=ee,Q;if(typeof Q=="object"&&Q!==null){switch(Q.$$typeof){case _:return ie=Lc(Q.type,Q.key,Q.props,null,ee.mode,ie),Cl(ie,Q),ie.return=ee,ie;case b:return Q=kh(Q,ee.mode,ie),Q.return=ee,Q;case A:return Q=es(Q),Se(ee,Q,ie)}if(V(Q)||_e(Q))return Q=Ja(Q,ee.mode,ie,null),Q.return=ee,Q;if(typeof Q.then=="function")return Se(ee,Vc(Q),ie);if(Q.$$typeof===U)return Se(ee,Kc(ee,Q),ie);Gc(ee,Q)}return null}function oe(ee,Q,ie,ye){var qe=Q!==null?Q.key:null;if(typeof ie=="string"&&ie!==""||typeof ie=="number"||typeof ie=="bigint")return qe!==null?null:L(ee,Q,""+ie,ye);if(typeof ie=="object"&&ie!==null){switch(ie.$$typeof){case _:return ie.key===qe?H(ee,Q,ie,ye):null;case b:return ie.key===qe?ae(ee,Q,ie,ye):null;case A:return ie=es(ie),oe(ee,Q,ie,ye)}if(V(ie)||_e(ie))return qe!==null?null:me(ee,Q,ie,ye,null);if(typeof ie.then=="function")return oe(ee,Q,Vc(ie),ye);if(ie.$$typeof===U)return oe(ee,Q,Kc(ee,ie),ye);Gc(ee,ie)}return null}function ve(ee,Q,ie,ye,qe){if(typeof ye=="string"&&ye!==""||typeof ye=="number"||typeof ye=="bigint")return ee=ee.get(ie)||null,L(Q,ee,""+ye,qe);if(typeof ye=="object"&&ye!==null){switch(ye.$$typeof){case _:return ee=ee.get(ye.key===null?ie:ye.key)||null,H(Q,ee,ye,qe);case b:return ee=ee.get(ye.key===null?ie:ye.key)||null,ae(Q,ee,ye,qe);case A:return ye=es(ye),ve(ee,Q,ie,ye,qe)}if(V(ye)||_e(ye))return ee=ee.get(ie)||null,me(Q,ee,ye,qe,null);if(typeof ye.then=="function")return ve(ee,Q,ie,Vc(ye),qe);if(ye.$$typeof===U)return ve(ee,Q,ie,Kc(Q,ye),qe);Gc(Q,ye)}return null}function Be(ee,Q,ie,ye){for(var qe=null,ht=null,Fe=Q,nt=Q=0,ut=null;Fe!==null&&nt<ie.length;nt++){Fe.index>nt?(ut=Fe,Fe=null):ut=Fe.sibling;var vt=oe(ee,Fe,ie[nt],ye);if(vt===null){Fe===null&&(Fe=ut);break}i&&Fe&&vt.alternate===null&&o(ee,Fe),Q=S(vt,Q,nt),ht===null?qe=vt:ht.sibling=vt,ht=vt,Fe=ut}if(nt===ie.length)return u(ee,Fe),ft&&bi(ee,nt),qe;if(Fe===null){for(;nt<ie.length;nt++)Fe=Se(ee,ie[nt],ye),Fe!==null&&(Q=S(Fe,Q,nt),ht===null?qe=Fe:ht.sibling=Fe,ht=Fe);return ft&&bi(ee,nt),qe}for(Fe=f(Fe);nt<ie.length;nt++)ut=ve(Fe,ee,nt,ie[nt],ye),ut!==null&&(i&&ut.alternate!==null&&Fe.delete(ut.key===null?nt:ut.key),Q=S(ut,Q,nt),ht===null?qe=ut:ht.sibling=ut,ht=ut);return i&&Fe.forEach(function(_a){return o(ee,_a)}),ft&&bi(ee,nt),qe}function He(ee,Q,ie,ye){if(ie==null)throw Error(r(151));for(var qe=null,ht=null,Fe=Q,nt=Q=0,ut=null,vt=ie.next();Fe!==null&&!vt.done;nt++,vt=ie.next()){Fe.index>nt?(ut=Fe,Fe=null):ut=Fe.sibling;var _a=oe(ee,Fe,vt.value,ye);if(_a===null){Fe===null&&(Fe=ut);break}i&&Fe&&_a.alternate===null&&o(ee,Fe),Q=S(_a,Q,nt),ht===null?qe=_a:ht.sibling=_a,ht=_a,Fe=ut}if(vt.done)return u(ee,Fe),ft&&bi(ee,nt),qe;if(Fe===null){for(;!vt.done;nt++,vt=ie.next())vt=Se(ee,vt.value,ye),vt!==null&&(Q=S(vt,Q,nt),ht===null?qe=vt:ht.sibling=vt,ht=vt);return ft&&bi(ee,nt),qe}for(Fe=f(Fe);!vt.done;nt++,vt=ie.next())vt=ve(Fe,ee,nt,vt.value,ye),vt!==null&&(i&&vt.alternate!==null&&Fe.delete(vt.key===null?nt:vt.key),Q=S(vt,Q,nt),ht===null?qe=vt:ht.sibling=vt,ht=vt);return i&&Fe.forEach(function(jO){return o(ee,jO)}),ft&&bi(ee,nt),qe}function It(ee,Q,ie,ye){if(typeof ie=="object"&&ie!==null&&ie.type===E&&ie.key===null&&(ie=ie.props.children),typeof ie=="object"&&ie!==null){switch(ie.$$typeof){case _:e:{for(var qe=ie.key;Q!==null;){if(Q.key===qe){if(qe=ie.type,qe===E){if(Q.tag===7){u(ee,Q.sibling),ye=g(Q,ie.props.children),ye.return=ee,ee=ye;break e}}else if(Q.elementType===qe||typeof qe=="object"&&qe!==null&&qe.$$typeof===A&&es(qe)===Q.type){u(ee,Q.sibling),ye=g(Q,ie.props),Cl(ye,ie),ye.return=ee,ee=ye;break e}u(ee,Q);break}else o(ee,Q);Q=Q.sibling}ie.type===E?(ye=Ja(ie.props.children,ee.mode,ye,ie.key),ye.return=ee,ee=ye):(ye=Lc(ie.type,ie.key,ie.props,null,ee.mode,ye),Cl(ye,ie),ye.return=ee,ee=ye)}return k(ee);case b:e:{for(qe=ie.key;Q!==null;){if(Q.key===qe)if(Q.tag===4&&Q.stateNode.containerInfo===ie.containerInfo&&Q.stateNode.implementation===ie.implementation){u(ee,Q.sibling),ye=g(Q,ie.children||[]),ye.return=ee,ee=ye;break e}else{u(ee,Q);break}else o(ee,Q);Q=Q.sibling}ye=kh(ie,ee.mode,ye),ye.return=ee,ee=ye}return k(ee);case A:return ie=es(ie),It(ee,Q,ie,ye)}if(V(ie))return Be(ee,Q,ie,ye);if(_e(ie)){if(qe=_e(ie),typeof qe!="function")throw Error(r(150));return ie=qe.call(ie),He(ee,Q,ie,ye)}if(typeof ie.then=="function")return It(ee,Q,Vc(ie),ye);if(ie.$$typeof===U)return It(ee,Q,Kc(ee,ie),ye);Gc(ee,ie)}return typeof ie=="string"&&ie!==""||typeof ie=="number"||typeof ie=="bigint"?(ie=""+ie,Q!==null&&Q.tag===6?(u(ee,Q.sibling),ye=g(Q,ie),ye.return=ee,ee=ye):(u(ee,Q),ye=Oh(ie,ee.mode,ye),ye.return=ee,ee=ye),k(ee)):u(ee,Q)}return function(ee,Q,ie,ye){try{Rl=0;var qe=It(ee,Q,ie,ye);return ao=null,qe}catch(Fe){if(Fe===io||Fe===Fc)throw Fe;var ht=sn(29,Fe,null,ee.mode);return ht.lanes=ye,ht.return=ee,ht}finally{}}}var rs=aS(!0),sS=aS(!1),ia=!1;function Fh(i){i.updateQueue={baseState:i.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function qh(i,o){i=i.updateQueue,o.updateQueue===i&&(o.updateQueue={baseState:i.baseState,firstBaseUpdate:i.firstBaseUpdate,lastBaseUpdate:i.lastBaseUpdate,shared:i.shared,callbacks:null})}function aa(i){return{lane:i,tag:0,payload:null,callback:null,next:null}}function sa(i,o,u){var f=i.updateQueue;if(f===null)return null;if(f=f.shared,(yt&2)!==0){var g=f.pending;return g===null?o.next=o:(o.next=g.next,g.next=o),f.pending=o,o=Pc(i),Vy(i,null,u),o}return Uc(i,f,o,u),Pc(i)}function Il(i,o,u){if(o=o.updateQueue,o!==null&&(o=o.shared,(u&4194048)!==0)){var f=o.lanes;f&=i.pendingLanes,u|=f,o.lanes=u,Xm(i,u)}}function Vh(i,o){var u=i.updateQueue,f=i.alternate;if(f!==null&&(f=f.updateQueue,u===f)){var g=null,S=null;if(u=u.firstBaseUpdate,u!==null){do{var k={lane:u.lane,tag:u.tag,payload:u.payload,callback:null,next:null};S===null?g=S=k:S=S.next=k,u=u.next}while(u!==null);S===null?g=S=o:S=S.next=o}else g=S=o;u={baseState:f.baseState,firstBaseUpdate:g,lastBaseUpdate:S,shared:f.shared,callbacks:f.callbacks},i.updateQueue=u;return}i=u.lastBaseUpdate,i===null?u.firstBaseUpdate=o:i.next=o,u.lastBaseUpdate=o}var Gh=!1;function Ol(){if(Gh){var i=no;if(i!==null)throw i}}function kl(i,o,u,f){Gh=!1;var g=i.updateQueue;ia=!1;var S=g.firstBaseUpdate,k=g.lastBaseUpdate,L=g.shared.pending;if(L!==null){g.shared.pending=null;var H=L,ae=H.next;H.next=null,k===null?S=ae:k.next=ae,k=H;var me=i.alternate;me!==null&&(me=me.updateQueue,L=me.lastBaseUpdate,L!==k&&(L===null?me.firstBaseUpdate=ae:L.next=ae,me.lastBaseUpdate=H))}if(S!==null){var Se=g.baseState;k=0,me=ae=H=null,L=S;do{var oe=L.lane&-536870913,ve=oe!==L.lane;if(ve?(lt&oe)===oe:(f&oe)===oe){oe!==0&&oe===ro&&(Gh=!0),me!==null&&(me=me.next={lane:0,tag:L.tag,payload:L.payload,callback:null,next:null});e:{var Be=i,He=L;oe=o;var It=u;switch(He.tag){case 1:if(Be=He.payload,typeof Be=="function"){Se=Be.call(It,Se,oe);break e}Se=Be;break e;case 3:Be.flags=Be.flags&-65537|128;case 0:if(Be=He.payload,oe=typeof Be=="function"?Be.call(It,Se,oe):Be,oe==null)break e;Se=p({},Se,oe);break e;case 2:ia=!0}}oe=L.callback,oe!==null&&(i.flags|=64,ve&&(i.flags|=8192),ve=g.callbacks,ve===null?g.callbacks=[oe]:ve.push(oe))}else ve={lane:oe,tag:L.tag,payload:L.payload,callback:L.callback,next:null},me===null?(ae=me=ve,H=Se):me=me.next=ve,k|=oe;if(L=L.next,L===null){if(L=g.shared.pending,L===null)break;ve=L,L=ve.next,ve.next=null,g.lastBaseUpdate=ve,g.shared.pending=null}}while(!0);me===null&&(H=Se),g.baseState=H,g.firstBaseUpdate=ae,g.lastBaseUpdate=me,S===null&&(g.shared.lanes=0),da|=k,i.lanes=k,i.memoizedState=Se}}function oS(i,o){if(typeof i!="function")throw Error(r(191,i));i.call(o)}function lS(i,o){var u=i.callbacks;if(u!==null)for(i.callbacks=null,i=0;i<u.length;i++)oS(u[i],o)}var so=W(null),Hc=W(0);function uS(i,o){i=Di,we(Hc,i),we(so,o),Di=i|o.baseLanes}function Hh(){we(Hc,Di),we(so,so.current)}function zh(){Di=Hc.current,ue(so),ue(Hc)}var on=W(null),kn=null;function oa(i){var o=i.alternate;we($t,$t.current&1),we(on,i),kn===null&&(o===null||so.current!==null||o.memoizedState!==null)&&(kn=i)}function Wh(i){we($t,$t.current),we(on,i),kn===null&&(kn=i)}function cS(i){i.tag===22?(we($t,$t.current),we(on,i),kn===null&&(kn=i)):la()}function la(){we($t,$t.current),we(on,on.current)}function ln(i){ue(on),kn===i&&(kn=null),ue($t)}var $t=W(0);function zc(i){for(var o=i;o!==null;){if(o.tag===13){var u=o.memoizedState;if(u!==null&&(u=u.dehydrated,u===null||Zv(u)||eg(u)))return o}else if(o.tag===19&&(o.memoizedProps.revealOrder==="forwards"||o.memoizedProps.revealOrder==="backwards"||o.memoizedProps.revealOrder==="unstable_legacy-backwards"||o.memoizedProps.revealOrder==="together")){if((o.flags&128)!==0)return o}else if(o.child!==null){o.child.return=o,o=o.child;continue}if(o===i)break;for(;o.sibling===null;){if(o.return===null||o.return===i)return null;o=o.return}o.sibling.return=o.return,o=o.sibling}return null}var Ti=0,Ze=null,Rt=null,ir=null,Wc=!1,oo=!1,ns=!1,Yc=0,Al=0,lo=null,AI=0;function Yt(){throw Error(r(321))}function Yh(i,o){if(o===null)return!1;for(var u=0;u<o.length&&u<i.length;u++)if(!an(i[u],o[u]))return!1;return!0}function Jh(i,o,u,f,g,S){return Ti=S,Ze=o,o.memoizedState=null,o.updateQueue=null,o.lanes=0,B.H=i===null||i.memoizedState===null?WS:cv,ns=!1,S=u(f,g),ns=!1,oo&&(S=fS(o,u,f,g)),dS(i),S}function dS(i){B.H=Nl;var o=Rt!==null&&Rt.next!==null;if(Ti=0,ir=Rt=Ze=null,Wc=!1,Al=0,lo=null,o)throw Error(r(300));i===null||ar||(i=i.dependencies,i!==null&&Bc(i)&&(ar=!0))}function fS(i,o,u,f){Ze=i;var g=0;do{if(oo&&(lo=null),Al=0,oo=!1,25<=g)throw Error(r(301));if(g+=1,ir=Rt=null,i.updateQueue!=null){var S=i.updateQueue;S.lastEffect=null,S.events=null,S.stores=null,S.memoCache!=null&&(S.memoCache.index=0)}B.H=YS,S=o(u,f)}while(oo);return S}function DI(){var i=B.H,o=i.useState()[0];return o=typeof o.then=="function"?Dl(o):o,i=i.useState()[0],(Rt!==null?Rt.memoizedState:null)!==i&&(Ze.flags|=1024),o}function Qh(){var i=Yc!==0;return Yc=0,i}function Xh(i,o,u){o.updateQueue=i.updateQueue,o.flags&=-2053,i.lanes&=~u}function $h(i){if(Wc){for(i=i.memoizedState;i!==null;){var o=i.queue;o!==null&&(o.pending=null),i=i.next}Wc=!1}Ti=0,ir=Rt=Ze=null,oo=!1,Al=Yc=0,lo=null}function Lr(){var i={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return ir===null?Ze.memoizedState=ir=i:ir=ir.next=i,ir}function Zt(){if(Rt===null){var i=Ze.alternate;i=i!==null?i.memoizedState:null}else i=Rt.next;var o=ir===null?Ze.memoizedState:ir.next;if(o!==null)ir=o,Rt=i;else{if(i===null)throw Ze.alternate===null?Error(r(467)):Error(r(310));Rt=i,i={memoizedState:Rt.memoizedState,baseState:Rt.baseState,baseQueue:Rt.baseQueue,queue:Rt.queue,next:null},ir===null?Ze.memoizedState=ir=i:ir=ir.next=i}return ir}function Jc(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Dl(i){var o=Al;return Al+=1,lo===null&&(lo=[]),i=rS(lo,i,o),o=Ze,(ir===null?o.memoizedState:ir.next)===null&&(o=o.alternate,B.H=o===null||o.memoizedState===null?WS:cv),i}function Qc(i){if(i!==null&&typeof i=="object"){if(typeof i.then=="function")return Dl(i);if(i.$$typeof===U)return wr(i)}throw Error(r(438,String(i)))}function Zh(i){var o=null,u=Ze.updateQueue;if(u!==null&&(o=u.memoCache),o==null){var f=Ze.alternate;f!==null&&(f=f.updateQueue,f!==null&&(f=f.memoCache,f!=null&&(o={data:f.data.map(function(g){return g.slice()}),index:0})))}if(o==null&&(o={data:[],index:0}),u===null&&(u=Jc(),Ze.updateQueue=u),u.memoCache=o,u=o.data[o.index],u===void 0)for(u=o.data[o.index]=Array(i),f=0;f<i;f++)u[f]=z;return o.index++,u}function wi(i,o){return typeof o=="function"?o(i):o}function Xc(i){var o=Zt();return ev(o,Rt,i)}function ev(i,o,u){var f=i.queue;if(f===null)throw Error(r(311));f.lastRenderedReducer=u;var g=i.baseQueue,S=f.pending;if(S!==null){if(g!==null){var k=g.next;g.next=S.next,S.next=k}o.baseQueue=g=S,f.pending=null}if(S=i.baseState,g===null)i.memoizedState=S;else{o=g.next;var L=k=null,H=null,ae=o,me=!1;do{var Se=ae.lane&-536870913;if(Se!==ae.lane?(lt&Se)===Se:(Ti&Se)===Se){var oe=ae.revertLane;if(oe===0)H!==null&&(H=H.next={lane:0,revertLane:0,gesture:null,action:ae.action,hasEagerState:ae.hasEagerState,eagerState:ae.eagerState,next:null}),Se===ro&&(me=!0);else if((Ti&oe)===oe){ae=ae.next,oe===ro&&(me=!0);continue}else Se={lane:0,revertLane:ae.revertLane,gesture:null,action:ae.action,hasEagerState:ae.hasEagerState,eagerState:ae.eagerState,next:null},H===null?(L=H=Se,k=S):H=H.next=Se,Ze.lanes|=oe,da|=oe;Se=ae.action,ns&&u(S,Se),S=ae.hasEagerState?ae.eagerState:u(S,Se)}else oe={lane:Se,revertLane:ae.revertLane,gesture:ae.gesture,action:ae.action,hasEagerState:ae.hasEagerState,eagerState:ae.eagerState,next:null},H===null?(L=H=oe,k=S):H=H.next=oe,Ze.lanes|=Se,da|=Se;ae=ae.next}while(ae!==null&&ae!==o);if(H===null?k=S:H.next=L,!an(S,i.memoizedState)&&(ar=!0,me&&(u=no,u!==null)))throw u;i.memoizedState=S,i.baseState=k,i.baseQueue=H,f.lastRenderedState=S}return g===null&&(f.lanes=0),[i.memoizedState,f.dispatch]}function tv(i){var o=Zt(),u=o.queue;if(u===null)throw Error(r(311));u.lastRenderedReducer=i;var f=u.dispatch,g=u.pending,S=o.memoizedState;if(g!==null){u.pending=null;var k=g=g.next;do S=i(S,k.action),k=k.next;while(k!==g);an(S,o.memoizedState)||(ar=!0),o.memoizedState=S,o.baseQueue===null&&(o.baseState=S),u.lastRenderedState=S}return[S,f]}function hS(i,o,u){var f=Ze,g=Zt(),S=ft;if(S){if(u===void 0)throw Error(r(407));u=u()}else u=o();var k=!an((Rt||g).memoizedState,u);if(k&&(g.memoizedState=u,ar=!0),g=g.queue,iv(pS.bind(null,f,g,i),[i]),g.getSnapshot!==o||k||ir!==null&&ir.memoizedState.tag&1){if(f.flags|=2048,uo(9,{destroy:void 0},gS.bind(null,f,g,u,o),null),At===null)throw Error(r(349));S||(Ti&127)!==0||vS(f,o,u)}return u}function vS(i,o,u){i.flags|=16384,i={getSnapshot:o,value:u},o=Ze.updateQueue,o===null?(o=Jc(),Ze.updateQueue=o,o.stores=[i]):(u=o.stores,u===null?o.stores=[i]:u.push(i))}function gS(i,o,u,f){o.value=u,o.getSnapshot=f,mS(o)&&yS(i)}function pS(i,o,u){return u(function(){mS(o)&&yS(i)})}function mS(i){var o=i.getSnapshot;i=i.value;try{var u=o();return!an(i,u)}catch{return!0}}function yS(i){var o=Ya(i,2);o!==null&&Qr(o,i,2)}function rv(i){var o=Lr();if(typeof i=="function"){var u=i;if(i=u(),ns){ce(!0);try{u()}finally{ce(!1)}}}return o.memoizedState=o.baseState=i,o.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:wi,lastRenderedState:i},o}function SS(i,o,u,f){return i.baseState=u,ev(i,Rt,typeof f=="function"?f:wi)}function MI(i,o,u,f,g){if(ed(i))throw Error(r(485));if(i=o.action,i!==null){var S={payload:g,action:i,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(k){S.listeners.push(k)}};B.T!==null?u(!0):S.isTransition=!1,f(S),u=o.pending,u===null?(S.next=o.pending=S,bS(o,S)):(S.next=u.next,o.pending=u.next=S)}}function bS(i,o){var u=o.action,f=o.payload,g=i.state;if(o.isTransition){var S=B.T,k={};B.T=k;try{var L=u(g,f),H=B.S;H!==null&&H(k,L),_S(i,o,L)}catch(ae){nv(i,o,ae)}finally{S!==null&&k.types!==null&&(S.types=k.types),B.T=S}}else try{S=u(g,f),_S(i,o,S)}catch(ae){nv(i,o,ae)}}function _S(i,o,u){u!==null&&typeof u=="object"&&typeof u.then=="function"?u.then(function(f){ES(i,o,f)},function(f){return nv(i,o,f)}):ES(i,o,u)}function ES(i,o,u){o.status="fulfilled",o.value=u,TS(o),i.state=u,o=i.pending,o!==null&&(u=o.next,u===o?i.pending=null:(u=u.next,o.next=u,bS(i,u)))}function nv(i,o,u){var f=i.pending;if(i.pending=null,f!==null){f=f.next;do o.status="rejected",o.reason=u,TS(o),o=o.next;while(o!==f)}i.action=null}function TS(i){i=i.listeners;for(var o=0;o<i.length;o++)(0,i[o])()}function wS(i,o){return o}function RS(i,o){if(ft){var u=At.formState;if(u!==null){e:{var f=Ze;if(ft){if(Lt){t:{for(var g=Lt,S=On;g.nodeType!==8;){if(!S){g=null;break t}if(g=An(g.nextSibling),g===null){g=null;break t}}S=g.data,g=S==="F!"||S==="F"?g:null}if(g){Lt=An(g.nextSibling),f=g.data==="F!";break e}}ra(f)}f=!1}f&&(o=u[0])}}return u=Lr(),u.memoizedState=u.baseState=o,f={pending:null,lanes:0,dispatch:null,lastRenderedReducer:wS,lastRenderedState:o},u.queue=f,u=GS.bind(null,Ze,f),f.dispatch=u,f=rv(!1),S=uv.bind(null,Ze,!1,f.queue),f=Lr(),g={state:o,dispatch:null,action:i,pending:null},f.queue=g,u=MI.bind(null,Ze,g,S,u),g.dispatch=u,f.memoizedState=i,[o,u,!1]}function CS(i){var o=Zt();return IS(o,Rt,i)}function IS(i,o,u){if(o=ev(i,o,wS)[0],i=Xc(wi)[0],typeof o=="object"&&o!==null&&typeof o.then=="function")try{var f=Dl(o)}catch(k){throw k===io?Fc:k}else f=o;o=Zt();var g=o.queue,S=g.dispatch;return u!==o.memoizedState&&(Ze.flags|=2048,uo(9,{destroy:void 0},NI.bind(null,g,u),null)),[f,S,i]}function NI(i,o){i.action=o}function OS(i){var o=Zt(),u=Rt;if(u!==null)return IS(o,u,i);Zt(),o=o.memoizedState,u=Zt();var f=u.queue.dispatch;return u.memoizedState=i,[o,f,!1]}function uo(i,o,u,f){return i={tag:i,create:u,deps:f,inst:o,next:null},o=Ze.updateQueue,o===null&&(o=Jc(),Ze.updateQueue=o),u=o.lastEffect,u===null?o.lastEffect=i.next=i:(f=u.next,u.next=i,i.next=f,o.lastEffect=i),i}function kS(){return Zt().memoizedState}function $c(i,o,u,f){var g=Lr();Ze.flags|=i,g.memoizedState=uo(1|o,{destroy:void 0},u,f===void 0?null:f)}function Zc(i,o,u,f){var g=Zt();f=f===void 0?null:f;var S=g.memoizedState.inst;Rt!==null&&f!==null&&Yh(f,Rt.memoizedState.deps)?g.memoizedState=uo(o,S,u,f):(Ze.flags|=i,g.memoizedState=uo(1|o,S,u,f))}function AS(i,o){$c(8390656,8,i,o)}function iv(i,o){Zc(2048,8,i,o)}function UI(i){Ze.flags|=4;var o=Ze.updateQueue;if(o===null)o=Jc(),Ze.updateQueue=o,o.events=[i];else{var u=o.events;u===null?o.events=[i]:u.push(i)}}function DS(i){var o=Zt().memoizedState;return UI({ref:o,nextImpl:i}),function(){if((yt&2)!==0)throw Error(r(440));return o.impl.apply(void 0,arguments)}}function MS(i,o){return Zc(4,2,i,o)}function NS(i,o){return Zc(4,4,i,o)}function US(i,o){if(typeof o=="function"){i=i();var u=o(i);return function(){typeof u=="function"?u():o(null)}}if(o!=null)return i=i(),o.current=i,function(){o.current=null}}function PS(i,o,u){u=u!=null?u.concat([i]):null,Zc(4,4,US.bind(null,o,i),u)}function av(){}function LS(i,o){var u=Zt();o=o===void 0?null:o;var f=u.memoizedState;return o!==null&&Yh(o,f[1])?f[0]:(u.memoizedState=[i,o],i)}function xS(i,o){var u=Zt();o=o===void 0?null:o;var f=u.memoizedState;if(o!==null&&Yh(o,f[1]))return f[0];if(f=i(),ns){ce(!0);try{i()}finally{ce(!1)}}return u.memoizedState=[f,o],f}function sv(i,o,u){return u===void 0||(Ti&1073741824)!==0&&(lt&261930)===0?i.memoizedState=o:(i.memoizedState=u,i=Bb(),Ze.lanes|=i,da|=i,u)}function BS(i,o,u,f){return an(u,o)?u:so.current!==null?(i=sv(i,u,f),an(i,o)||(ar=!0),i):(Ti&42)===0||(Ti&1073741824)!==0&&(lt&261930)===0?(ar=!0,i.memoizedState=u):(i=Bb(),Ze.lanes|=i,da|=i,o)}function KS(i,o,u,f,g){var S=te.p;te.p=S!==0&&8>S?S:8;var k=B.T,L={};B.T=L,uv(i,!1,o,u);try{var H=g(),ae=B.S;if(ae!==null&&ae(L,H),H!==null&&typeof H=="object"&&typeof H.then=="function"){var me=kI(H,f);Ml(i,o,me,dn(i))}else Ml(i,o,f,dn(i))}catch(Se){Ml(i,o,{then:function(){},status:"rejected",reason:Se},dn())}finally{te.p=S,k!==null&&L.types!==null&&(k.types=L.types),B.T=k}}function PI(){}function ov(i,o,u,f){if(i.tag!==5)throw Error(r(476));var g=jS(i).queue;KS(i,g,o,he,u===null?PI:function(){return FS(i),u(f)})}function jS(i){var o=i.memoizedState;if(o!==null)return o;o={memoizedState:he,baseState:he,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:wi,lastRenderedState:he},next:null};var u={};return o.next={memoizedState:u,baseState:u,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:wi,lastRenderedState:u},next:null},i.memoizedState=o,i=i.alternate,i!==null&&(i.memoizedState=o),o}function FS(i){var o=jS(i);o.next===null&&(o=i.alternate.memoizedState),Ml(i,o.next.queue,{},dn())}function lv(){return wr(Jl)}function qS(){return Zt().memoizedState}function VS(){return Zt().memoizedState}function LI(i){for(var o=i.return;o!==null;){switch(o.tag){case 24:case 3:var u=dn();i=aa(u);var f=sa(o,i,u);f!==null&&(Qr(f,o,u),Il(f,o,u)),o={cache:xh()},i.payload=o;return}o=o.return}}function xI(i,o,u){var f=dn();u={lane:f,revertLane:0,gesture:null,action:u,hasEagerState:!1,eagerState:null,next:null},ed(i)?HS(o,u):(u=Ch(i,o,u,f),u!==null&&(Qr(u,i,f),zS(u,o,f)))}function GS(i,o,u){var f=dn();Ml(i,o,u,f)}function Ml(i,o,u,f){var g={lane:f,revertLane:0,gesture:null,action:u,hasEagerState:!1,eagerState:null,next:null};if(ed(i))HS(o,g);else{var S=i.alternate;if(i.lanes===0&&(S===null||S.lanes===0)&&(S=o.lastRenderedReducer,S!==null))try{var k=o.lastRenderedState,L=S(k,u);if(g.hasEagerState=!0,g.eagerState=L,an(L,k))return Uc(i,o,g,0),At===null&&Nc(),!1}catch{}finally{}if(u=Ch(i,o,g,f),u!==null)return Qr(u,i,f),zS(u,o,f),!0}return!1}function uv(i,o,u,f){if(f={lane:2,revertLane:Fv(),gesture:null,action:f,hasEagerState:!1,eagerState:null,next:null},ed(i)){if(o)throw Error(r(479))}else o=Ch(i,u,f,2),o!==null&&Qr(o,i,2)}function ed(i){var o=i.alternate;return i===Ze||o!==null&&o===Ze}function HS(i,o){oo=Wc=!0;var u=i.pending;u===null?o.next=o:(o.next=u.next,u.next=o),i.pending=o}function zS(i,o,u){if((u&4194048)!==0){var f=o.lanes;f&=i.pendingLanes,u|=f,o.lanes=u,Xm(i,u)}}var Nl={readContext:wr,use:Qc,useCallback:Yt,useContext:Yt,useEffect:Yt,useImperativeHandle:Yt,useLayoutEffect:Yt,useInsertionEffect:Yt,useMemo:Yt,useReducer:Yt,useRef:Yt,useState:Yt,useDebugValue:Yt,useDeferredValue:Yt,useTransition:Yt,useSyncExternalStore:Yt,useId:Yt,useHostTransitionStatus:Yt,useFormState:Yt,useActionState:Yt,useOptimistic:Yt,useMemoCache:Yt,useCacheRefresh:Yt};Nl.useEffectEvent=Yt;var WS={readContext:wr,use:Qc,useCallback:function(i,o){return Lr().memoizedState=[i,o===void 0?null:o],i},useContext:wr,useEffect:AS,useImperativeHandle:function(i,o,u){u=u!=null?u.concat([i]):null,$c(4194308,4,US.bind(null,o,i),u)},useLayoutEffect:function(i,o){return $c(4194308,4,i,o)},useInsertionEffect:function(i,o){$c(4,2,i,o)},useMemo:function(i,o){var u=Lr();o=o===void 0?null:o;var f=i();if(ns){ce(!0);try{i()}finally{ce(!1)}}return u.memoizedState=[f,o],f},useReducer:function(i,o,u){var f=Lr();if(u!==void 0){var g=u(o);if(ns){ce(!0);try{u(o)}finally{ce(!1)}}}else g=o;return f.memoizedState=f.baseState=g,i={pending:null,lanes:0,dispatch:null,lastRenderedReducer:i,lastRenderedState:g},f.queue=i,i=i.dispatch=xI.bind(null,Ze,i),[f.memoizedState,i]},useRef:function(i){var o=Lr();return i={current:i},o.memoizedState=i},useState:function(i){i=rv(i);var o=i.queue,u=GS.bind(null,Ze,o);return o.dispatch=u,[i.memoizedState,u]},useDebugValue:av,useDeferredValue:function(i,o){var u=Lr();return sv(u,i,o)},useTransition:function(){var i=rv(!1);return i=KS.bind(null,Ze,i.queue,!0,!1),Lr().memoizedState=i,[!1,i]},useSyncExternalStore:function(i,o,u){var f=Ze,g=Lr();if(ft){if(u===void 0)throw Error(r(407));u=u()}else{if(u=o(),At===null)throw Error(r(349));(lt&127)!==0||vS(f,o,u)}g.memoizedState=u;var S={value:u,getSnapshot:o};return g.queue=S,AS(pS.bind(null,f,S,i),[i]),f.flags|=2048,uo(9,{destroy:void 0},gS.bind(null,f,S,u,o),null),u},useId:function(){var i=Lr(),o=At.identifierPrefix;if(ft){var u=ei,f=Zn;u=(f&~(1<<32-ge(f)-1)).toString(32)+u,o="_"+o+"R_"+u,u=Yc++,0<u&&(o+="H"+u.toString(32)),o+="_"}else u=AI++,o="_"+o+"r_"+u.toString(32)+"_";return i.memoizedState=o},useHostTransitionStatus:lv,useFormState:RS,useActionState:RS,useOptimistic:function(i){var o=Lr();o.memoizedState=o.baseState=i;var u={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return o.queue=u,o=uv.bind(null,Ze,!0,u),u.dispatch=o,[i,o]},useMemoCache:Zh,useCacheRefresh:function(){return Lr().memoizedState=LI.bind(null,Ze)},useEffectEvent:function(i){var o=Lr(),u={impl:i};return o.memoizedState=u,function(){if((yt&2)!==0)throw Error(r(440));return u.impl.apply(void 0,arguments)}}},cv={readContext:wr,use:Qc,useCallback:LS,useContext:wr,useEffect:iv,useImperativeHandle:PS,useInsertionEffect:MS,useLayoutEffect:NS,useMemo:xS,useReducer:Xc,useRef:kS,useState:function(){return Xc(wi)},useDebugValue:av,useDeferredValue:function(i,o){var u=Zt();return BS(u,Rt.memoizedState,i,o)},useTransition:function(){var i=Xc(wi)[0],o=Zt().memoizedState;return[typeof i=="boolean"?i:Dl(i),o]},useSyncExternalStore:hS,useId:qS,useHostTransitionStatus:lv,useFormState:CS,useActionState:CS,useOptimistic:function(i,o){var u=Zt();return SS(u,Rt,i,o)},useMemoCache:Zh,useCacheRefresh:VS};cv.useEffectEvent=DS;var YS={readContext:wr,use:Qc,useCallback:LS,useContext:wr,useEffect:iv,useImperativeHandle:PS,useInsertionEffect:MS,useLayoutEffect:NS,useMemo:xS,useReducer:tv,useRef:kS,useState:function(){return tv(wi)},useDebugValue:av,useDeferredValue:function(i,o){var u=Zt();return Rt===null?sv(u,i,o):BS(u,Rt.memoizedState,i,o)},useTransition:function(){var i=tv(wi)[0],o=Zt().memoizedState;return[typeof i=="boolean"?i:Dl(i),o]},useSyncExternalStore:hS,useId:qS,useHostTransitionStatus:lv,useFormState:OS,useActionState:OS,useOptimistic:function(i,o){var u=Zt();return Rt!==null?SS(u,Rt,i,o):(u.baseState=i,[i,u.queue.dispatch])},useMemoCache:Zh,useCacheRefresh:VS};YS.useEffectEvent=DS;function dv(i,o,u,f){o=i.memoizedState,u=u(f,o),u=u==null?o:p({},o,u),i.memoizedState=u,i.lanes===0&&(i.updateQueue.baseState=u)}var fv={enqueueSetState:function(i,o,u){i=i._reactInternals;var f=dn(),g=aa(f);g.payload=o,u!=null&&(g.callback=u),o=sa(i,g,f),o!==null&&(Qr(o,i,f),Il(o,i,f))},enqueueReplaceState:function(i,o,u){i=i._reactInternals;var f=dn(),g=aa(f);g.tag=1,g.payload=o,u!=null&&(g.callback=u),o=sa(i,g,f),o!==null&&(Qr(o,i,f),Il(o,i,f))},enqueueForceUpdate:function(i,o){i=i._reactInternals;var u=dn(),f=aa(u);f.tag=2,o!=null&&(f.callback=o),o=sa(i,f,u),o!==null&&(Qr(o,i,u),Il(o,i,u))}};function JS(i,o,u,f,g,S,k){return i=i.stateNode,typeof i.shouldComponentUpdate=="function"?i.shouldComponentUpdate(f,S,k):o.prototype&&o.prototype.isPureReactComponent?!Sl(u,f)||!Sl(g,S):!0}function QS(i,o,u,f){i=o.state,typeof o.componentWillReceiveProps=="function"&&o.componentWillReceiveProps(u,f),typeof o.UNSAFE_componentWillReceiveProps=="function"&&o.UNSAFE_componentWillReceiveProps(u,f),o.state!==i&&fv.enqueueReplaceState(o,o.state,null)}function is(i,o){var u=o;if("ref"in o){u={};for(var f in o)f!=="ref"&&(u[f]=o[f])}if(i=i.defaultProps){u===o&&(u=p({},u));for(var g in i)u[g]===void 0&&(u[g]=i[g])}return u}function XS(i){Mc(i)}function $S(i){console.error(i)}function ZS(i){Mc(i)}function td(i,o){try{var u=i.onUncaughtError;u(o.value,{componentStack:o.stack})}catch(f){setTimeout(function(){throw f})}}function eb(i,o,u){try{var f=i.onCaughtError;f(u.value,{componentStack:u.stack,errorBoundary:o.tag===1?o.stateNode:null})}catch(g){setTimeout(function(){throw g})}}function hv(i,o,u){return u=aa(u),u.tag=3,u.payload={element:null},u.callback=function(){td(i,o)},u}function tb(i){return i=aa(i),i.tag=3,i}function rb(i,o,u,f){var g=u.type.getDerivedStateFromError;if(typeof g=="function"){var S=f.value;i.payload=function(){return g(S)},i.callback=function(){eb(o,u,f)}}var k=u.stateNode;k!==null&&typeof k.componentDidCatch=="function"&&(i.callback=function(){eb(o,u,f),typeof g!="function"&&(fa===null?fa=new Set([this]):fa.add(this));var L=f.stack;this.componentDidCatch(f.value,{componentStack:L!==null?L:""})})}function BI(i,o,u,f,g){if(u.flags|=32768,f!==null&&typeof f=="object"&&typeof f.then=="function"){if(o=u.alternate,o!==null&&to(o,u,g,!0),u=on.current,u!==null){switch(u.tag){case 31:case 13:return kn===null?hd():u.alternate===null&&Jt===0&&(Jt=3),u.flags&=-257,u.flags|=65536,u.lanes=g,f===qc?u.flags|=16384:(o=u.updateQueue,o===null?u.updateQueue=new Set([f]):o.add(f),Bv(i,f,g)),!1;case 22:return u.flags|=65536,f===qc?u.flags|=16384:(o=u.updateQueue,o===null?(o={transitions:null,markerInstances:null,retryQueue:new Set([f])},u.updateQueue=o):(u=o.retryQueue,u===null?o.retryQueue=new Set([f]):u.add(f)),Bv(i,f,g)),!1}throw Error(r(435,u.tag))}return Bv(i,f,g),hd(),!1}if(ft)return o=on.current,o!==null?((o.flags&65536)===0&&(o.flags|=256),o.flags|=65536,o.lanes=g,f!==Mh&&(i=Error(r(422),{cause:f}),El(Rn(i,u)))):(f!==Mh&&(o=Error(r(423),{cause:f}),El(Rn(o,u))),i=i.current.alternate,i.flags|=65536,g&=-g,i.lanes|=g,f=Rn(f,u),g=hv(i.stateNode,f,g),Vh(i,g),Jt!==4&&(Jt=2)),!1;var S=Error(r(520),{cause:f});if(S=Rn(S,u),Fl===null?Fl=[S]:Fl.push(S),Jt!==4&&(Jt=2),o===null)return!0;f=Rn(f,u),u=o;do{switch(u.tag){case 3:return u.flags|=65536,i=g&-g,u.lanes|=i,i=hv(u.stateNode,f,i),Vh(u,i),!1;case 1:if(o=u.type,S=u.stateNode,(u.flags&128)===0&&(typeof o.getDerivedStateFromError=="function"||S!==null&&typeof S.componentDidCatch=="function"&&(fa===null||!fa.has(S))))return u.flags|=65536,g&=-g,u.lanes|=g,g=tb(g),rb(g,i,u,f),Vh(u,g),!1}u=u.return}while(u!==null);return!1}var vv=Error(r(461)),ar=!1;function Rr(i,o,u,f){o.child=i===null?sS(o,null,u,f):rs(o,i.child,u,f)}function nb(i,o,u,f,g){u=u.render;var S=o.ref;if("ref"in f){var k={};for(var L in f)L!=="ref"&&(k[L]=f[L])}else k=f;return $a(o),f=Jh(i,o,u,k,S,g),L=Qh(),i!==null&&!ar?(Xh(i,o,g),Ri(i,o,g)):(ft&&L&&Ah(o),o.flags|=1,Rr(i,o,f,g),o.child)}function ib(i,o,u,f,g){if(i===null){var S=u.type;return typeof S=="function"&&!Ih(S)&&S.defaultProps===void 0&&u.compare===null?(o.tag=15,o.type=S,ab(i,o,S,f,g)):(i=Lc(u.type,null,f,o,o.mode,g),i.ref=o.ref,i.return=o,o.child=i)}if(S=i.child,!Ev(i,g)){var k=S.memoizedProps;if(u=u.compare,u=u!==null?u:Sl,u(k,f)&&i.ref===o.ref)return Ri(i,o,g)}return o.flags|=1,i=Si(S,f),i.ref=o.ref,i.return=o,o.child=i}function ab(i,o,u,f,g){if(i!==null){var S=i.memoizedProps;if(Sl(S,f)&&i.ref===o.ref)if(ar=!1,o.pendingProps=f=S,Ev(i,g))(i.flags&131072)!==0&&(ar=!0);else return o.lanes=i.lanes,Ri(i,o,g)}return gv(i,o,u,f,g)}function sb(i,o,u,f){var g=f.children,S=i!==null?i.memoizedState:null;if(i===null&&o.stateNode===null&&(o.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),f.mode==="hidden"){if((o.flags&128)!==0){if(S=S!==null?S.baseLanes|u:u,i!==null){for(f=o.child=i.child,g=0;f!==null;)g=g|f.lanes|f.childLanes,f=f.sibling;f=g&~S}else f=0,o.child=null;return ob(i,o,S,u,f)}if((u&536870912)!==0)o.memoizedState={baseLanes:0,cachePool:null},i!==null&&jc(o,S!==null?S.cachePool:null),S!==null?uS(o,S):Hh(),cS(o);else return f=o.lanes=536870912,ob(i,o,S!==null?S.baseLanes|u:u,u,f)}else S!==null?(jc(o,S.cachePool),uS(o,S),la(),o.memoizedState=null):(i!==null&&jc(o,null),Hh(),la());return Rr(i,o,g,u),o.child}function Ul(i,o){return i!==null&&i.tag===22||o.stateNode!==null||(o.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),o.sibling}function ob(i,o,u,f,g){var S=Kh();return S=S===null?null:{parent:nr._currentValue,pool:S},o.memoizedState={baseLanes:u,cachePool:S},i!==null&&jc(o,null),Hh(),cS(o),i!==null&&to(i,o,f,!0),o.childLanes=g,null}function rd(i,o){return o=id({mode:o.mode,children:o.children},i.mode),o.ref=i.ref,i.child=o,o.return=i,o}function lb(i,o,u){return rs(o,i.child,null,u),i=rd(o,o.pendingProps),i.flags|=2,ln(o),o.memoizedState=null,i}function KI(i,o,u){var f=o.pendingProps,g=(o.flags&128)!==0;if(o.flags&=-129,i===null){if(ft){if(f.mode==="hidden")return i=rd(o,f),o.lanes=536870912,Ul(null,i);if(Wh(o),(i=Lt)?(i=b_(i,On),i=i!==null&&i.data==="&"?i:null,i!==null&&(o.memoizedState={dehydrated:i,treeContext:ea!==null?{id:Zn,overflow:ei}:null,retryLane:536870912,hydrationErrors:null},u=Hy(i),u.return=o,o.child=u,Tr=o,Lt=null)):i=null,i===null)throw ra(o);return o.lanes=536870912,null}return rd(o,f)}var S=i.memoizedState;if(S!==null){var k=S.dehydrated;if(Wh(o),g)if(o.flags&256)o.flags&=-257,o=lb(i,o,u);else if(o.memoizedState!==null)o.child=i.child,o.flags|=128,o=null;else throw Error(r(558));else if(ar||to(i,o,u,!1),g=(u&i.childLanes)!==0,ar||g){if(f=At,f!==null&&(k=$m(f,u),k!==0&&k!==S.retryLane))throw S.retryLane=k,Ya(i,k),Qr(f,i,k),vv;hd(),o=lb(i,o,u)}else i=S.treeContext,Lt=An(k.nextSibling),Tr=o,ft=!0,ta=null,On=!1,i!==null&&Yy(o,i),o=rd(o,f),o.flags|=4096;return o}return i=Si(i.child,{mode:f.mode,children:f.children}),i.ref=o.ref,o.child=i,i.return=o,i}function nd(i,o){var u=o.ref;if(u===null)i!==null&&i.ref!==null&&(o.flags|=4194816);else{if(typeof u!="function"&&typeof u!="object")throw Error(r(284));(i===null||i.ref!==u)&&(o.flags|=4194816)}}function gv(i,o,u,f,g){return $a(o),u=Jh(i,o,u,f,void 0,g),f=Qh(),i!==null&&!ar?(Xh(i,o,g),Ri(i,o,g)):(ft&&f&&Ah(o),o.flags|=1,Rr(i,o,u,g),o.child)}function ub(i,o,u,f,g,S){return $a(o),o.updateQueue=null,u=fS(o,f,u,g),dS(i),f=Qh(),i!==null&&!ar?(Xh(i,o,S),Ri(i,o,S)):(ft&&f&&Ah(o),o.flags|=1,Rr(i,o,u,S),o.child)}function cb(i,o,u,f,g){if($a(o),o.stateNode===null){var S=Xs,k=u.contextType;typeof k=="object"&&k!==null&&(S=wr(k)),S=new u(f,S),o.memoizedState=S.state!==null&&S.state!==void 0?S.state:null,S.updater=fv,o.stateNode=S,S._reactInternals=o,S=o.stateNode,S.props=f,S.state=o.memoizedState,S.refs={},Fh(o),k=u.contextType,S.context=typeof k=="object"&&k!==null?wr(k):Xs,S.state=o.memoizedState,k=u.getDerivedStateFromProps,typeof k=="function"&&(dv(o,u,k,f),S.state=o.memoizedState),typeof u.getDerivedStateFromProps=="function"||typeof S.getSnapshotBeforeUpdate=="function"||typeof S.UNSAFE_componentWillMount!="function"&&typeof S.componentWillMount!="function"||(k=S.state,typeof S.componentWillMount=="function"&&S.componentWillMount(),typeof S.UNSAFE_componentWillMount=="function"&&S.UNSAFE_componentWillMount(),k!==S.state&&fv.enqueueReplaceState(S,S.state,null),kl(o,f,S,g),Ol(),S.state=o.memoizedState),typeof S.componentDidMount=="function"&&(o.flags|=4194308),f=!0}else if(i===null){S=o.stateNode;var L=o.memoizedProps,H=is(u,L);S.props=H;var ae=S.context,me=u.contextType;k=Xs,typeof me=="object"&&me!==null&&(k=wr(me));var Se=u.getDerivedStateFromProps;me=typeof Se=="function"||typeof S.getSnapshotBeforeUpdate=="function",L=o.pendingProps!==L,me||typeof S.UNSAFE_componentWillReceiveProps!="function"&&typeof S.componentWillReceiveProps!="function"||(L||ae!==k)&&QS(o,S,f,k),ia=!1;var oe=o.memoizedState;S.state=oe,kl(o,f,S,g),Ol(),ae=o.memoizedState,L||oe!==ae||ia?(typeof Se=="function"&&(dv(o,u,Se,f),ae=o.memoizedState),(H=ia||JS(o,u,H,f,oe,ae,k))?(me||typeof S.UNSAFE_componentWillMount!="function"&&typeof S.componentWillMount!="function"||(typeof S.componentWillMount=="function"&&S.componentWillMount(),typeof S.UNSAFE_componentWillMount=="function"&&S.UNSAFE_componentWillMount()),typeof S.componentDidMount=="function"&&(o.flags|=4194308)):(typeof S.componentDidMount=="function"&&(o.flags|=4194308),o.memoizedProps=f,o.memoizedState=ae),S.props=f,S.state=ae,S.context=k,f=H):(typeof S.componentDidMount=="function"&&(o.flags|=4194308),f=!1)}else{S=o.stateNode,qh(i,o),k=o.memoizedProps,me=is(u,k),S.props=me,Se=o.pendingProps,oe=S.context,ae=u.contextType,H=Xs,typeof ae=="object"&&ae!==null&&(H=wr(ae)),L=u.getDerivedStateFromProps,(ae=typeof L=="function"||typeof S.getSnapshotBeforeUpdate=="function")||typeof S.UNSAFE_componentWillReceiveProps!="function"&&typeof S.componentWillReceiveProps!="function"||(k!==Se||oe!==H)&&QS(o,S,f,H),ia=!1,oe=o.memoizedState,S.state=oe,kl(o,f,S,g),Ol();var ve=o.memoizedState;k!==Se||oe!==ve||ia||i!==null&&i.dependencies!==null&&Bc(i.dependencies)?(typeof L=="function"&&(dv(o,u,L,f),ve=o.memoizedState),(me=ia||JS(o,u,me,f,oe,ve,H)||i!==null&&i.dependencies!==null&&Bc(i.dependencies))?(ae||typeof S.UNSAFE_componentWillUpdate!="function"&&typeof S.componentWillUpdate!="function"||(typeof S.componentWillUpdate=="function"&&S.componentWillUpdate(f,ve,H),typeof S.UNSAFE_componentWillUpdate=="function"&&S.UNSAFE_componentWillUpdate(f,ve,H)),typeof S.componentDidUpdate=="function"&&(o.flags|=4),typeof S.getSnapshotBeforeUpdate=="function"&&(o.flags|=1024)):(typeof S.componentDidUpdate!="function"||k===i.memoizedProps&&oe===i.memoizedState||(o.flags|=4),typeof S.getSnapshotBeforeUpdate!="function"||k===i.memoizedProps&&oe===i.memoizedState||(o.flags|=1024),o.memoizedProps=f,o.memoizedState=ve),S.props=f,S.state=ve,S.context=H,f=me):(typeof S.componentDidUpdate!="function"||k===i.memoizedProps&&oe===i.memoizedState||(o.flags|=4),typeof S.getSnapshotBeforeUpdate!="function"||k===i.memoizedProps&&oe===i.memoizedState||(o.flags|=1024),f=!1)}return S=f,nd(i,o),f=(o.flags&128)!==0,S||f?(S=o.stateNode,u=f&&typeof u.getDerivedStateFromError!="function"?null:S.render(),o.flags|=1,i!==null&&f?(o.child=rs(o,i.child,null,g),o.child=rs(o,null,u,g)):Rr(i,o,u,g),o.memoizedState=S.state,i=o.child):i=Ri(i,o,g),i}function db(i,o,u,f){return Qa(),o.flags|=256,Rr(i,o,u,f),o.child}var pv={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function mv(i){return{baseLanes:i,cachePool:eS()}}function yv(i,o,u){return i=i!==null?i.childLanes&~u:0,o&&(i|=cn),i}function fb(i,o,u){var f=o.pendingProps,g=!1,S=(o.flags&128)!==0,k;if((k=S)||(k=i!==null&&i.memoizedState===null?!1:($t.current&2)!==0),k&&(g=!0,o.flags&=-129),k=(o.flags&32)!==0,o.flags&=-33,i===null){if(ft){if(g?oa(o):la(),(i=Lt)?(i=b_(i,On),i=i!==null&&i.data!=="&"?i:null,i!==null&&(o.memoizedState={dehydrated:i,treeContext:ea!==null?{id:Zn,overflow:ei}:null,retryLane:536870912,hydrationErrors:null},u=Hy(i),u.return=o,o.child=u,Tr=o,Lt=null)):i=null,i===null)throw ra(o);return eg(i)?o.lanes=32:o.lanes=536870912,null}var L=f.children;return f=f.fallback,g?(la(),g=o.mode,L=id({mode:"hidden",children:L},g),f=Ja(f,g,u,null),L.return=o,f.return=o,L.sibling=f,o.child=L,f=o.child,f.memoizedState=mv(u),f.childLanes=yv(i,k,u),o.memoizedState=pv,Ul(null,f)):(oa(o),Sv(o,L))}var H=i.memoizedState;if(H!==null&&(L=H.dehydrated,L!==null)){if(S)o.flags&256?(oa(o),o.flags&=-257,o=bv(i,o,u)):o.memoizedState!==null?(la(),o.child=i.child,o.flags|=128,o=null):(la(),L=f.fallback,g=o.mode,f=id({mode:"visible",children:f.children},g),L=Ja(L,g,u,null),L.flags|=2,f.return=o,L.return=o,f.sibling=L,o.child=f,rs(o,i.child,null,u),f=o.child,f.memoizedState=mv(u),f.childLanes=yv(i,k,u),o.memoizedState=pv,o=Ul(null,f));else if(oa(o),eg(L)){if(k=L.nextSibling&&L.nextSibling.dataset,k)var ae=k.dgst;k=ae,f=Error(r(419)),f.stack="",f.digest=k,El({value:f,source:null,stack:null}),o=bv(i,o,u)}else if(ar||to(i,o,u,!1),k=(u&i.childLanes)!==0,ar||k){if(k=At,k!==null&&(f=$m(k,u),f!==0&&f!==H.retryLane))throw H.retryLane=f,Ya(i,f),Qr(k,i,f),vv;Zv(L)||hd(),o=bv(i,o,u)}else Zv(L)?(o.flags|=192,o.child=i.child,o=null):(i=H.treeContext,Lt=An(L.nextSibling),Tr=o,ft=!0,ta=null,On=!1,i!==null&&Yy(o,i),o=Sv(o,f.children),o.flags|=4096);return o}return g?(la(),L=f.fallback,g=o.mode,H=i.child,ae=H.sibling,f=Si(H,{mode:"hidden",children:f.children}),f.subtreeFlags=H.subtreeFlags&65011712,ae!==null?L=Si(ae,L):(L=Ja(L,g,u,null),L.flags|=2),L.return=o,f.return=o,f.sibling=L,o.child=f,Ul(null,f),f=o.child,L=i.child.memoizedState,L===null?L=mv(u):(g=L.cachePool,g!==null?(H=nr._currentValue,g=g.parent!==H?{parent:H,pool:H}:g):g=eS(),L={baseLanes:L.baseLanes|u,cachePool:g}),f.memoizedState=L,f.childLanes=yv(i,k,u),o.memoizedState=pv,Ul(i.child,f)):(oa(o),u=i.child,i=u.sibling,u=Si(u,{mode:"visible",children:f.children}),u.return=o,u.sibling=null,i!==null&&(k=o.deletions,k===null?(o.deletions=[i],o.flags|=16):k.push(i)),o.child=u,o.memoizedState=null,u)}function Sv(i,o){return o=id({mode:"visible",children:o},i.mode),o.return=i,i.child=o}function id(i,o){return i=sn(22,i,null,o),i.lanes=0,i}function bv(i,o,u){return rs(o,i.child,null,u),i=Sv(o,o.pendingProps.children),i.flags|=2,o.memoizedState=null,i}function hb(i,o,u){i.lanes|=o;var f=i.alternate;f!==null&&(f.lanes|=o),Ph(i.return,o,u)}function _v(i,o,u,f,g,S){var k=i.memoizedState;k===null?i.memoizedState={isBackwards:o,rendering:null,renderingStartTime:0,last:f,tail:u,tailMode:g,treeForkCount:S}:(k.isBackwards=o,k.rendering=null,k.renderingStartTime=0,k.last=f,k.tail=u,k.tailMode=g,k.treeForkCount=S)}function vb(i,o,u){var f=o.pendingProps,g=f.revealOrder,S=f.tail;f=f.children;var k=$t.current,L=(k&2)!==0;if(L?(k=k&1|2,o.flags|=128):k&=1,we($t,k),Rr(i,o,f,u),f=ft?_l:0,!L&&i!==null&&(i.flags&128)!==0)e:for(i=o.child;i!==null;){if(i.tag===13)i.memoizedState!==null&&hb(i,u,o);else if(i.tag===19)hb(i,u,o);else if(i.child!==null){i.child.return=i,i=i.child;continue}if(i===o)break e;for(;i.sibling===null;){if(i.return===null||i.return===o)break e;i=i.return}i.sibling.return=i.return,i=i.sibling}switch(g){case"forwards":for(u=o.child,g=null;u!==null;)i=u.alternate,i!==null&&zc(i)===null&&(g=u),u=u.sibling;u=g,u===null?(g=o.child,o.child=null):(g=u.sibling,u.sibling=null),_v(o,!1,g,u,S,f);break;case"backwards":case"unstable_legacy-backwards":for(u=null,g=o.child,o.child=null;g!==null;){if(i=g.alternate,i!==null&&zc(i)===null){o.child=g;break}i=g.sibling,g.sibling=u,u=g,g=i}_v(o,!0,u,null,S,f);break;case"together":_v(o,!1,null,null,void 0,f);break;default:o.memoizedState=null}return o.child}function Ri(i,o,u){if(i!==null&&(o.dependencies=i.dependencies),da|=o.lanes,(u&o.childLanes)===0)if(i!==null){if(to(i,o,u,!1),(u&o.childLanes)===0)return null}else return null;if(i!==null&&o.child!==i.child)throw Error(r(153));if(o.child!==null){for(i=o.child,u=Si(i,i.pendingProps),o.child=u,u.return=o;i.sibling!==null;)i=i.sibling,u=u.sibling=Si(i,i.pendingProps),u.return=o;u.sibling=null}return o.child}function Ev(i,o){return(i.lanes&o)!==0?!0:(i=i.dependencies,!!(i!==null&&Bc(i)))}function jI(i,o,u){switch(o.tag){case 3:x(o,o.stateNode.containerInfo),na(o,nr,i.memoizedState.cache),Qa();break;case 27:case 5:P(o);break;case 4:x(o,o.stateNode.containerInfo);break;case 10:na(o,o.type,o.memoizedProps.value);break;case 31:if(o.memoizedState!==null)return o.flags|=128,Wh(o),null;break;case 13:var f=o.memoizedState;if(f!==null)return f.dehydrated!==null?(oa(o),o.flags|=128,null):(u&o.child.childLanes)!==0?fb(i,o,u):(oa(o),i=Ri(i,o,u),i!==null?i.sibling:null);oa(o);break;case 19:var g=(i.flags&128)!==0;if(f=(u&o.childLanes)!==0,f||(to(i,o,u,!1),f=(u&o.childLanes)!==0),g){if(f)return vb(i,o,u);o.flags|=128}if(g=o.memoizedState,g!==null&&(g.rendering=null,g.tail=null,g.lastEffect=null),we($t,$t.current),f)break;return null;case 22:return o.lanes=0,sb(i,o,u,o.pendingProps);case 24:na(o,nr,i.memoizedState.cache)}return Ri(i,o,u)}function gb(i,o,u){if(i!==null)if(i.memoizedProps!==o.pendingProps)ar=!0;else{if(!Ev(i,u)&&(o.flags&128)===0)return ar=!1,jI(i,o,u);ar=(i.flags&131072)!==0}else ar=!1,ft&&(o.flags&1048576)!==0&&Wy(o,_l,o.index);switch(o.lanes=0,o.tag){case 16:e:{var f=o.pendingProps;if(i=es(o.elementType),o.type=i,typeof i=="function")Ih(i)?(f=is(i,f),o.tag=1,o=cb(null,o,i,f,u)):(o.tag=0,o=gv(null,o,i,f,u));else{if(i!=null){var g=i.$$typeof;if(g===I){o.tag=11,o=nb(null,o,i,f,u);break e}else if(g===N){o.tag=14,o=ib(null,o,i,f,u);break e}}throw o=Ce(i)||i,Error(r(306,o,""))}}return o;case 0:return gv(i,o,o.type,o.pendingProps,u);case 1:return f=o.type,g=is(f,o.pendingProps),cb(i,o,f,g,u);case 3:e:{if(x(o,o.stateNode.containerInfo),i===null)throw Error(r(387));f=o.pendingProps;var S=o.memoizedState;g=S.element,qh(i,o),kl(o,f,null,u);var k=o.memoizedState;if(f=k.cache,na(o,nr,f),f!==S.cache&&Lh(o,[nr],u,!0),Ol(),f=k.element,S.isDehydrated)if(S={element:f,isDehydrated:!1,cache:k.cache},o.updateQueue.baseState=S,o.memoizedState=S,o.flags&256){o=db(i,o,f,u);break e}else if(f!==g){g=Rn(Error(r(424)),o),El(g),o=db(i,o,f,u);break e}else{switch(i=o.stateNode.containerInfo,i.nodeType){case 9:i=i.body;break;default:i=i.nodeName==="HTML"?i.ownerDocument.body:i}for(Lt=An(i.firstChild),Tr=o,ft=!0,ta=null,On=!0,u=sS(o,null,f,u),o.child=u;u;)u.flags=u.flags&-3|4096,u=u.sibling}else{if(Qa(),f===g){o=Ri(i,o,u);break e}Rr(i,o,f,u)}o=o.child}return o;case 26:return nd(i,o),i===null?(u=C_(o.type,null,o.pendingProps,null))?o.memoizedState=u:ft||(u=o.type,i=o.pendingProps,f=bd(G.current).createElement(u),f[Er]=o,f[Gr]=i,Cr(f,u,i),vr(f),o.stateNode=f):o.memoizedState=C_(o.type,i.memoizedProps,o.pendingProps,i.memoizedState),null;case 27:return P(o),i===null&&ft&&(f=o.stateNode=T_(o.type,o.pendingProps,G.current),Tr=o,On=!0,g=Lt,pa(o.type)?(tg=g,Lt=An(f.firstChild)):Lt=g),Rr(i,o,o.pendingProps.children,u),nd(i,o),i===null&&(o.flags|=4194304),o.child;case 5:return i===null&&ft&&((g=f=Lt)&&(f=pO(f,o.type,o.pendingProps,On),f!==null?(o.stateNode=f,Tr=o,Lt=An(f.firstChild),On=!1,g=!0):g=!1),g||ra(o)),P(o),g=o.type,S=o.pendingProps,k=i!==null?i.memoizedProps:null,f=S.children,Qv(g,S)?f=null:k!==null&&Qv(g,k)&&(o.flags|=32),o.memoizedState!==null&&(g=Jh(i,o,DI,null,null,u),Jl._currentValue=g),nd(i,o),Rr(i,o,f,u),o.child;case 6:return i===null&&ft&&((i=u=Lt)&&(u=mO(u,o.pendingProps,On),u!==null?(o.stateNode=u,Tr=o,Lt=null,i=!0):i=!1),i||ra(o)),null;case 13:return fb(i,o,u);case 4:return x(o,o.stateNode.containerInfo),f=o.pendingProps,i===null?o.child=rs(o,null,f,u):Rr(i,o,f,u),o.child;case 11:return nb(i,o,o.type,o.pendingProps,u);case 7:return Rr(i,o,o.pendingProps,u),o.child;case 8:return Rr(i,o,o.pendingProps.children,u),o.child;case 12:return Rr(i,o,o.pendingProps.children,u),o.child;case 10:return f=o.pendingProps,na(o,o.type,f.value),Rr(i,o,f.children,u),o.child;case 9:return g=o.type._context,f=o.pendingProps.children,$a(o),g=wr(g),f=f(g),o.flags|=1,Rr(i,o,f,u),o.child;case 14:return ib(i,o,o.type,o.pendingProps,u);case 15:return ab(i,o,o.type,o.pendingProps,u);case 19:return vb(i,o,u);case 31:return KI(i,o,u);case 22:return sb(i,o,u,o.pendingProps);case 24:return $a(o),f=wr(nr),i===null?(g=Kh(),g===null&&(g=At,S=xh(),g.pooledCache=S,S.refCount++,S!==null&&(g.pooledCacheLanes|=u),g=S),o.memoizedState={parent:f,cache:g},Fh(o),na(o,nr,g)):((i.lanes&u)!==0&&(qh(i,o),kl(o,null,null,u),Ol()),g=i.memoizedState,S=o.memoizedState,g.parent!==f?(g={parent:f,cache:f},o.memoizedState=g,o.lanes===0&&(o.memoizedState=o.updateQueue.baseState=g),na(o,nr,f)):(f=S.cache,na(o,nr,f),f!==g.cache&&Lh(o,[nr],u,!0))),Rr(i,o,o.pendingProps.children,u),o.child;case 29:throw o.pendingProps}throw Error(r(156,o.tag))}function Ci(i){i.flags|=4}function Tv(i,o,u,f,g){if((o=(i.mode&32)!==0)&&(o=!1),o){if(i.flags|=16777216,(g&335544128)===g)if(i.stateNode.complete)i.flags|=8192;else if(qb())i.flags|=8192;else throw ts=qc,jh}else i.flags&=-16777217}function pb(i,o){if(o.type!=="stylesheet"||(o.state.loading&4)!==0)i.flags&=-16777217;else if(i.flags|=16777216,!D_(o))if(qb())i.flags|=8192;else throw ts=qc,jh}function ad(i,o){o!==null&&(i.flags|=4),i.flags&16384&&(o=i.tag!==22?Jm():536870912,i.lanes|=o,vo|=o)}function Pl(i,o){if(!ft)switch(i.tailMode){case"hidden":o=i.tail;for(var u=null;o!==null;)o.alternate!==null&&(u=o),o=o.sibling;u===null?i.tail=null:u.sibling=null;break;case"collapsed":u=i.tail;for(var f=null;u!==null;)u.alternate!==null&&(f=u),u=u.sibling;f===null?o||i.tail===null?i.tail=null:i.tail.sibling=null:f.sibling=null}}function xt(i){var o=i.alternate!==null&&i.alternate.child===i.child,u=0,f=0;if(o)for(var g=i.child;g!==null;)u|=g.lanes|g.childLanes,f|=g.subtreeFlags&65011712,f|=g.flags&65011712,g.return=i,g=g.sibling;else for(g=i.child;g!==null;)u|=g.lanes|g.childLanes,f|=g.subtreeFlags,f|=g.flags,g.return=i,g=g.sibling;return i.subtreeFlags|=f,i.childLanes=u,o}function FI(i,o,u){var f=o.pendingProps;switch(Dh(o),o.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return xt(o),null;case 1:return xt(o),null;case 3:return u=o.stateNode,f=null,i!==null&&(f=i.memoizedState.cache),o.memoizedState.cache!==f&&(o.flags|=2048),Ei(nr),j(),u.pendingContext&&(u.context=u.pendingContext,u.pendingContext=null),(i===null||i.child===null)&&(eo(o)?Ci(o):i===null||i.memoizedState.isDehydrated&&(o.flags&256)===0||(o.flags|=1024,Nh())),xt(o),null;case 26:var g=o.type,S=o.memoizedState;return i===null?(Ci(o),S!==null?(xt(o),pb(o,S)):(xt(o),Tv(o,g,null,f,u))):S?S!==i.memoizedState?(Ci(o),xt(o),pb(o,S)):(xt(o),o.flags&=-16777217):(i=i.memoizedProps,i!==f&&Ci(o),xt(o),Tv(o,g,i,f,u)),null;case 27:if(J(o),u=G.current,g=o.type,i!==null&&o.stateNode!=null)i.memoizedProps!==f&&Ci(o);else{if(!f){if(o.stateNode===null)throw Error(r(166));return xt(o),null}i=Z.current,eo(o)?Jy(o):(i=T_(g,f,u),o.stateNode=i,Ci(o))}return xt(o),null;case 5:if(J(o),g=o.type,i!==null&&o.stateNode!=null)i.memoizedProps!==f&&Ci(o);else{if(!f){if(o.stateNode===null)throw Error(r(166));return xt(o),null}if(S=Z.current,eo(o))Jy(o);else{var k=bd(G.current);switch(S){case 1:S=k.createElementNS("http://www.w3.org/2000/svg",g);break;case 2:S=k.createElementNS("http://www.w3.org/1998/Math/MathML",g);break;default:switch(g){case"svg":S=k.createElementNS("http://www.w3.org/2000/svg",g);break;case"math":S=k.createElementNS("http://www.w3.org/1998/Math/MathML",g);break;case"script":S=k.createElement("div"),S.innerHTML="<script><\/script>",S=S.removeChild(S.firstChild);break;case"select":S=typeof f.is=="string"?k.createElement("select",{is:f.is}):k.createElement("select"),f.multiple?S.multiple=!0:f.size&&(S.size=f.size);break;default:S=typeof f.is=="string"?k.createElement(g,{is:f.is}):k.createElement(g)}}S[Er]=o,S[Gr]=f;e:for(k=o.child;k!==null;){if(k.tag===5||k.tag===6)S.appendChild(k.stateNode);else if(k.tag!==4&&k.tag!==27&&k.child!==null){k.child.return=k,k=k.child;continue}if(k===o)break e;for(;k.sibling===null;){if(k.return===null||k.return===o)break e;k=k.return}k.sibling.return=k.return,k=k.sibling}o.stateNode=S;e:switch(Cr(S,g,f),g){case"button":case"input":case"select":case"textarea":f=!!f.autoFocus;break e;case"img":f=!0;break e;default:f=!1}f&&Ci(o)}}return xt(o),Tv(o,o.type,i===null?null:i.memoizedProps,o.pendingProps,u),null;case 6:if(i&&o.stateNode!=null)i.memoizedProps!==f&&Ci(o);else{if(typeof f!="string"&&o.stateNode===null)throw Error(r(166));if(i=G.current,eo(o)){if(i=o.stateNode,u=o.memoizedProps,f=null,g=Tr,g!==null)switch(g.tag){case 27:case 5:f=g.memoizedProps}i[Er]=o,i=!!(i.nodeValue===u||f!==null&&f.suppressHydrationWarning===!0||f_(i.nodeValue,u)),i||ra(o,!0)}else i=bd(i).createTextNode(f),i[Er]=o,o.stateNode=i}return xt(o),null;case 31:if(u=o.memoizedState,i===null||i.memoizedState!==null){if(f=eo(o),u!==null){if(i===null){if(!f)throw Error(r(318));if(i=o.memoizedState,i=i!==null?i.dehydrated:null,!i)throw Error(r(557));i[Er]=o}else Qa(),(o.flags&128)===0&&(o.memoizedState=null),o.flags|=4;xt(o),i=!1}else u=Nh(),i!==null&&i.memoizedState!==null&&(i.memoizedState.hydrationErrors=u),i=!0;if(!i)return o.flags&256?(ln(o),o):(ln(o),null);if((o.flags&128)!==0)throw Error(r(558))}return xt(o),null;case 13:if(f=o.memoizedState,i===null||i.memoizedState!==null&&i.memoizedState.dehydrated!==null){if(g=eo(o),f!==null&&f.dehydrated!==null){if(i===null){if(!g)throw Error(r(318));if(g=o.memoizedState,g=g!==null?g.dehydrated:null,!g)throw Error(r(317));g[Er]=o}else Qa(),(o.flags&128)===0&&(o.memoizedState=null),o.flags|=4;xt(o),g=!1}else g=Nh(),i!==null&&i.memoizedState!==null&&(i.memoizedState.hydrationErrors=g),g=!0;if(!g)return o.flags&256?(ln(o),o):(ln(o),null)}return ln(o),(o.flags&128)!==0?(o.lanes=u,o):(u=f!==null,i=i!==null&&i.memoizedState!==null,u&&(f=o.child,g=null,f.alternate!==null&&f.alternate.memoizedState!==null&&f.alternate.memoizedState.cachePool!==null&&(g=f.alternate.memoizedState.cachePool.pool),S=null,f.memoizedState!==null&&f.memoizedState.cachePool!==null&&(S=f.memoizedState.cachePool.pool),S!==g&&(f.flags|=2048)),u!==i&&u&&(o.child.flags|=8192),ad(o,o.updateQueue),xt(o),null);case 4:return j(),i===null&&Hv(o.stateNode.containerInfo),xt(o),null;case 10:return Ei(o.type),xt(o),null;case 19:if(ue($t),f=o.memoizedState,f===null)return xt(o),null;if(g=(o.flags&128)!==0,S=f.rendering,S===null)if(g)Pl(f,!1);else{if(Jt!==0||i!==null&&(i.flags&128)!==0)for(i=o.child;i!==null;){if(S=zc(i),S!==null){for(o.flags|=128,Pl(f,!1),i=S.updateQueue,o.updateQueue=i,ad(o,i),o.subtreeFlags=0,i=u,u=o.child;u!==null;)Gy(u,i),u=u.sibling;return we($t,$t.current&1|2),ft&&bi(o,f.treeForkCount),o.child}i=i.sibling}f.tail!==null&&Ge()>cd&&(o.flags|=128,g=!0,Pl(f,!1),o.lanes=4194304)}else{if(!g)if(i=zc(S),i!==null){if(o.flags|=128,g=!0,i=i.updateQueue,o.updateQueue=i,ad(o,i),Pl(f,!0),f.tail===null&&f.tailMode==="hidden"&&!S.alternate&&!ft)return xt(o),null}else 2*Ge()-f.renderingStartTime>cd&&u!==536870912&&(o.flags|=128,g=!0,Pl(f,!1),o.lanes=4194304);f.isBackwards?(S.sibling=o.child,o.child=S):(i=f.last,i!==null?i.sibling=S:o.child=S,f.last=S)}return f.tail!==null?(i=f.tail,f.rendering=i,f.tail=i.sibling,f.renderingStartTime=Ge(),i.sibling=null,u=$t.current,we($t,g?u&1|2:u&1),ft&&bi(o,f.treeForkCount),i):(xt(o),null);case 22:case 23:return ln(o),zh(),f=o.memoizedState!==null,i!==null?i.memoizedState!==null!==f&&(o.flags|=8192):f&&(o.flags|=8192),f?(u&536870912)!==0&&(o.flags&128)===0&&(xt(o),o.subtreeFlags&6&&(o.flags|=8192)):xt(o),u=o.updateQueue,u!==null&&ad(o,u.retryQueue),u=null,i!==null&&i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(u=i.memoizedState.cachePool.pool),f=null,o.memoizedState!==null&&o.memoizedState.cachePool!==null&&(f=o.memoizedState.cachePool.pool),f!==u&&(o.flags|=2048),i!==null&&ue(Za),null;case 24:return u=null,i!==null&&(u=i.memoizedState.cache),o.memoizedState.cache!==u&&(o.flags|=2048),Ei(nr),xt(o),null;case 25:return null;case 30:return null}throw Error(r(156,o.tag))}function qI(i,o){switch(Dh(o),o.tag){case 1:return i=o.flags,i&65536?(o.flags=i&-65537|128,o):null;case 3:return Ei(nr),j(),i=o.flags,(i&65536)!==0&&(i&128)===0?(o.flags=i&-65537|128,o):null;case 26:case 27:case 5:return J(o),null;case 31:if(o.memoizedState!==null){if(ln(o),o.alternate===null)throw Error(r(340));Qa()}return i=o.flags,i&65536?(o.flags=i&-65537|128,o):null;case 13:if(ln(o),i=o.memoizedState,i!==null&&i.dehydrated!==null){if(o.alternate===null)throw Error(r(340));Qa()}return i=o.flags,i&65536?(o.flags=i&-65537|128,o):null;case 19:return ue($t),null;case 4:return j(),null;case 10:return Ei(o.type),null;case 22:case 23:return ln(o),zh(),i!==null&&ue(Za),i=o.flags,i&65536?(o.flags=i&-65537|128,o):null;case 24:return Ei(nr),null;case 25:return null;default:return null}}function mb(i,o){switch(Dh(o),o.tag){case 3:Ei(nr),j();break;case 26:case 27:case 5:J(o);break;case 4:j();break;case 31:o.memoizedState!==null&&ln(o);break;case 13:ln(o);break;case 19:ue($t);break;case 10:Ei(o.type);break;case 22:case 23:ln(o),zh(),i!==null&&ue(Za);break;case 24:Ei(nr)}}function Ll(i,o){try{var u=o.updateQueue,f=u!==null?u.lastEffect:null;if(f!==null){var g=f.next;u=g;do{if((u.tag&i)===i){f=void 0;var S=u.create,k=u.inst;f=S(),k.destroy=f}u=u.next}while(u!==g)}}catch(L){Et(o,o.return,L)}}function ua(i,o,u){try{var f=o.updateQueue,g=f!==null?f.lastEffect:null;if(g!==null){var S=g.next;f=S;do{if((f.tag&i)===i){var k=f.inst,L=k.destroy;if(L!==void 0){k.destroy=void 0,g=o;var H=u,ae=L;try{ae()}catch(me){Et(g,H,me)}}}f=f.next}while(f!==S)}}catch(me){Et(o,o.return,me)}}function yb(i){var o=i.updateQueue;if(o!==null){var u=i.stateNode;try{lS(o,u)}catch(f){Et(i,i.return,f)}}}function Sb(i,o,u){u.props=is(i.type,i.memoizedProps),u.state=i.memoizedState;try{u.componentWillUnmount()}catch(f){Et(i,o,f)}}function xl(i,o){try{var u=i.ref;if(u!==null){switch(i.tag){case 26:case 27:case 5:var f=i.stateNode;break;case 30:f=i.stateNode;break;default:f=i.stateNode}typeof u=="function"?i.refCleanup=u(f):u.current=f}}catch(g){Et(i,o,g)}}function ti(i,o){var u=i.ref,f=i.refCleanup;if(u!==null)if(typeof f=="function")try{f()}catch(g){Et(i,o,g)}finally{i.refCleanup=null,i=i.alternate,i!=null&&(i.refCleanup=null)}else if(typeof u=="function")try{u(null)}catch(g){Et(i,o,g)}else u.current=null}function bb(i){var o=i.type,u=i.memoizedProps,f=i.stateNode;try{e:switch(o){case"button":case"input":case"select":case"textarea":u.autoFocus&&f.focus();break e;case"img":u.src?f.src=u.src:u.srcSet&&(f.srcset=u.srcSet)}}catch(g){Et(i,i.return,g)}}function wv(i,o,u){try{var f=i.stateNode;cO(f,i.type,u,o),f[Gr]=o}catch(g){Et(i,i.return,g)}}function _b(i){return i.tag===5||i.tag===3||i.tag===26||i.tag===27&&pa(i.type)||i.tag===4}function Rv(i){e:for(;;){for(;i.sibling===null;){if(i.return===null||_b(i.return))return null;i=i.return}for(i.sibling.return=i.return,i=i.sibling;i.tag!==5&&i.tag!==6&&i.tag!==18;){if(i.tag===27&&pa(i.type)||i.flags&2||i.child===null||i.tag===4)continue e;i.child.return=i,i=i.child}if(!(i.flags&2))return i.stateNode}}function Cv(i,o,u){var f=i.tag;if(f===5||f===6)i=i.stateNode,o?(u.nodeType===9?u.body:u.nodeName==="HTML"?u.ownerDocument.body:u).insertBefore(i,o):(o=u.nodeType===9?u.body:u.nodeName==="HTML"?u.ownerDocument.body:u,o.appendChild(i),u=u._reactRootContainer,u!=null||o.onclick!==null||(o.onclick=mi));else if(f!==4&&(f===27&&pa(i.type)&&(u=i.stateNode,o=null),i=i.child,i!==null))for(Cv(i,o,u),i=i.sibling;i!==null;)Cv(i,o,u),i=i.sibling}function sd(i,o,u){var f=i.tag;if(f===5||f===6)i=i.stateNode,o?u.insertBefore(i,o):u.appendChild(i);else if(f!==4&&(f===27&&pa(i.type)&&(u=i.stateNode),i=i.child,i!==null))for(sd(i,o,u),i=i.sibling;i!==null;)sd(i,o,u),i=i.sibling}function Eb(i){var o=i.stateNode,u=i.memoizedProps;try{for(var f=i.type,g=o.attributes;g.length;)o.removeAttributeNode(g[0]);Cr(o,f,u),o[Er]=i,o[Gr]=u}catch(S){Et(i,i.return,S)}}var Ii=!1,sr=!1,Iv=!1,Tb=typeof WeakSet=="function"?WeakSet:Set,gr=null;function VI(i,o){if(i=i.containerInfo,Yv=Id,i=Py(i),bh(i)){if("selectionStart"in i)var u={start:i.selectionStart,end:i.selectionEnd};else e:{u=(u=i.ownerDocument)&&u.defaultView||window;var f=u.getSelection&&u.getSelection();if(f&&f.rangeCount!==0){u=f.anchorNode;var g=f.anchorOffset,S=f.focusNode;f=f.focusOffset;try{u.nodeType,S.nodeType}catch{u=null;break e}var k=0,L=-1,H=-1,ae=0,me=0,Se=i,oe=null;t:for(;;){for(var ve;Se!==u||g!==0&&Se.nodeType!==3||(L=k+g),Se!==S||f!==0&&Se.nodeType!==3||(H=k+f),Se.nodeType===3&&(k+=Se.nodeValue.length),(ve=Se.firstChild)!==null;)oe=Se,Se=ve;for(;;){if(Se===i)break t;if(oe===u&&++ae===g&&(L=k),oe===S&&++me===f&&(H=k),(ve=Se.nextSibling)!==null)break;Se=oe,oe=Se.parentNode}Se=ve}u=L===-1||H===-1?null:{start:L,end:H}}else u=null}u=u||{start:0,end:0}}else u=null;for(Jv={focusedElem:i,selectionRange:u},Id=!1,gr=o;gr!==null;)if(o=gr,i=o.child,(o.subtreeFlags&1028)!==0&&i!==null)i.return=o,gr=i;else for(;gr!==null;){switch(o=gr,S=o.alternate,i=o.flags,o.tag){case 0:if((i&4)!==0&&(i=o.updateQueue,i=i!==null?i.events:null,i!==null))for(u=0;u<i.length;u++)g=i[u],g.ref.impl=g.nextImpl;break;case 11:case 15:break;case 1:if((i&1024)!==0&&S!==null){i=void 0,u=o,g=S.memoizedProps,S=S.memoizedState,f=u.stateNode;try{var Be=is(u.type,g);i=f.getSnapshotBeforeUpdate(Be,S),f.__reactInternalSnapshotBeforeUpdate=i}catch(He){Et(u,u.return,He)}}break;case 3:if((i&1024)!==0){if(i=o.stateNode.containerInfo,u=i.nodeType,u===9)$v(i);else if(u===1)switch(i.nodeName){case"HEAD":case"HTML":case"BODY":$v(i);break;default:i.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((i&1024)!==0)throw Error(r(163))}if(i=o.sibling,i!==null){i.return=o.return,gr=i;break}gr=o.return}}function wb(i,o,u){var f=u.flags;switch(u.tag){case 0:case 11:case 15:ki(i,u),f&4&&Ll(5,u);break;case 1:if(ki(i,u),f&4)if(i=u.stateNode,o===null)try{i.componentDidMount()}catch(k){Et(u,u.return,k)}else{var g=is(u.type,o.memoizedProps);o=o.memoizedState;try{i.componentDidUpdate(g,o,i.__reactInternalSnapshotBeforeUpdate)}catch(k){Et(u,u.return,k)}}f&64&&yb(u),f&512&&xl(u,u.return);break;case 3:if(ki(i,u),f&64&&(i=u.updateQueue,i!==null)){if(o=null,u.child!==null)switch(u.child.tag){case 27:case 5:o=u.child.stateNode;break;case 1:o=u.child.stateNode}try{lS(i,o)}catch(k){Et(u,u.return,k)}}break;case 27:o===null&&f&4&&Eb(u);case 26:case 5:ki(i,u),o===null&&f&4&&bb(u),f&512&&xl(u,u.return);break;case 12:ki(i,u);break;case 31:ki(i,u),f&4&&Ib(i,u);break;case 13:ki(i,u),f&4&&Ob(i,u),f&64&&(i=u.memoizedState,i!==null&&(i=i.dehydrated,i!==null&&(u=$I.bind(null,u),yO(i,u))));break;case 22:if(f=u.memoizedState!==null||Ii,!f){o=o!==null&&o.memoizedState!==null||sr,g=Ii;var S=sr;Ii=f,(sr=o)&&!S?Ai(i,u,(u.subtreeFlags&8772)!==0):ki(i,u),Ii=g,sr=S}break;case 30:break;default:ki(i,u)}}function Rb(i){var o=i.alternate;o!==null&&(i.alternate=null,Rb(o)),i.child=null,i.deletions=null,i.sibling=null,i.tag===5&&(o=i.stateNode,o!==null&&nh(o)),i.stateNode=null,i.return=null,i.dependencies=null,i.memoizedProps=null,i.memoizedState=null,i.pendingProps=null,i.stateNode=null,i.updateQueue=null}var jt=null,zr=!1;function Oi(i,o,u){for(u=u.child;u!==null;)Cb(i,o,u),u=u.sibling}function Cb(i,o,u){if(ne&&typeof ne.onCommitFiberUnmount=="function")try{ne.onCommitFiberUnmount(Te,u)}catch{}switch(u.tag){case 26:sr||ti(u,o),Oi(i,o,u),u.memoizedState?u.memoizedState.count--:u.stateNode&&(u=u.stateNode,u.parentNode.removeChild(u));break;case 27:sr||ti(u,o);var f=jt,g=zr;pa(u.type)&&(jt=u.stateNode,zr=!1),Oi(i,o,u),zl(u.stateNode),jt=f,zr=g;break;case 5:sr||ti(u,o);case 6:if(f=jt,g=zr,jt=null,Oi(i,o,u),jt=f,zr=g,jt!==null)if(zr)try{(jt.nodeType===9?jt.body:jt.nodeName==="HTML"?jt.ownerDocument.body:jt).removeChild(u.stateNode)}catch(S){Et(u,o,S)}else try{jt.removeChild(u.stateNode)}catch(S){Et(u,o,S)}break;case 18:jt!==null&&(zr?(i=jt,y_(i.nodeType===9?i.body:i.nodeName==="HTML"?i.ownerDocument.body:i,u.stateNode),Eo(i)):y_(jt,u.stateNode));break;case 4:f=jt,g=zr,jt=u.stateNode.containerInfo,zr=!0,Oi(i,o,u),jt=f,zr=g;break;case 0:case 11:case 14:case 15:ua(2,u,o),sr||ua(4,u,o),Oi(i,o,u);break;case 1:sr||(ti(u,o),f=u.stateNode,typeof f.componentWillUnmount=="function"&&Sb(u,o,f)),Oi(i,o,u);break;case 21:Oi(i,o,u);break;case 22:sr=(f=sr)||u.memoizedState!==null,Oi(i,o,u),sr=f;break;default:Oi(i,o,u)}}function Ib(i,o){if(o.memoizedState===null&&(i=o.alternate,i!==null&&(i=i.memoizedState,i!==null))){i=i.dehydrated;try{Eo(i)}catch(u){Et(o,o.return,u)}}}function Ob(i,o){if(o.memoizedState===null&&(i=o.alternate,i!==null&&(i=i.memoizedState,i!==null&&(i=i.dehydrated,i!==null))))try{Eo(i)}catch(u){Et(o,o.return,u)}}function GI(i){switch(i.tag){case 31:case 13:case 19:var o=i.stateNode;return o===null&&(o=i.stateNode=new Tb),o;case 22:return i=i.stateNode,o=i._retryCache,o===null&&(o=i._retryCache=new Tb),o;default:throw Error(r(435,i.tag))}}function od(i,o){var u=GI(i);o.forEach(function(f){if(!u.has(f)){u.add(f);var g=ZI.bind(null,i,f);f.then(g,g)}})}function Wr(i,o){var u=o.deletions;if(u!==null)for(var f=0;f<u.length;f++){var g=u[f],S=i,k=o,L=k;e:for(;L!==null;){switch(L.tag){case 27:if(pa(L.type)){jt=L.stateNode,zr=!1;break e}break;case 5:jt=L.stateNode,zr=!1;break e;case 3:case 4:jt=L.stateNode.containerInfo,zr=!0;break e}L=L.return}if(jt===null)throw Error(r(160));Cb(S,k,g),jt=null,zr=!1,S=g.alternate,S!==null&&(S.return=null),g.return=null}if(o.subtreeFlags&13886)for(o=o.child;o!==null;)kb(o,i),o=o.sibling}var xn=null;function kb(i,o){var u=i.alternate,f=i.flags;switch(i.tag){case 0:case 11:case 14:case 15:Wr(o,i),Yr(i),f&4&&(ua(3,i,i.return),Ll(3,i),ua(5,i,i.return));break;case 1:Wr(o,i),Yr(i),f&512&&(sr||u===null||ti(u,u.return)),f&64&&Ii&&(i=i.updateQueue,i!==null&&(f=i.callbacks,f!==null&&(u=i.shared.hiddenCallbacks,i.shared.hiddenCallbacks=u===null?f:u.concat(f))));break;case 26:var g=xn;if(Wr(o,i),Yr(i),f&512&&(sr||u===null||ti(u,u.return)),f&4){var S=u!==null?u.memoizedState:null;if(f=i.memoizedState,u===null)if(f===null)if(i.stateNode===null){e:{f=i.type,u=i.memoizedProps,g=g.ownerDocument||g;t:switch(f){case"title":S=g.getElementsByTagName("title")[0],(!S||S[cl]||S[Er]||S.namespaceURI==="http://www.w3.org/2000/svg"||S.hasAttribute("itemprop"))&&(S=g.createElement(f),g.head.insertBefore(S,g.querySelector("head > title"))),Cr(S,f,u),S[Er]=i,vr(S),f=S;break e;case"link":var k=k_("link","href",g).get(f+(u.href||""));if(k){for(var L=0;L<k.length;L++)if(S=k[L],S.getAttribute("href")===(u.href==null||u.href===""?null:u.href)&&S.getAttribute("rel")===(u.rel==null?null:u.rel)&&S.getAttribute("title")===(u.title==null?null:u.title)&&S.getAttribute("crossorigin")===(u.crossOrigin==null?null:u.crossOrigin)){k.splice(L,1);break t}}S=g.createElement(f),Cr(S,f,u),g.head.appendChild(S);break;case"meta":if(k=k_("meta","content",g).get(f+(u.content||""))){for(L=0;L<k.length;L++)if(S=k[L],S.getAttribute("content")===(u.content==null?null:""+u.content)&&S.getAttribute("name")===(u.name==null?null:u.name)&&S.getAttribute("property")===(u.property==null?null:u.property)&&S.getAttribute("http-equiv")===(u.httpEquiv==null?null:u.httpEquiv)&&S.getAttribute("charset")===(u.charSet==null?null:u.charSet)){k.splice(L,1);break t}}S=g.createElement(f),Cr(S,f,u),g.head.appendChild(S);break;default:throw Error(r(468,f))}S[Er]=i,vr(S),f=S}i.stateNode=f}else A_(g,i.type,i.stateNode);else i.stateNode=O_(g,f,i.memoizedProps);else S!==f?(S===null?u.stateNode!==null&&(u=u.stateNode,u.parentNode.removeChild(u)):S.count--,f===null?A_(g,i.type,i.stateNode):O_(g,f,i.memoizedProps)):f===null&&i.stateNode!==null&&wv(i,i.memoizedProps,u.memoizedProps)}break;case 27:Wr(o,i),Yr(i),f&512&&(sr||u===null||ti(u,u.return)),u!==null&&f&4&&wv(i,i.memoizedProps,u.memoizedProps);break;case 5:if(Wr(o,i),Yr(i),f&512&&(sr||u===null||ti(u,u.return)),i.flags&32){g=i.stateNode;try{Gs(g,"")}catch(Be){Et(i,i.return,Be)}}f&4&&i.stateNode!=null&&(g=i.memoizedProps,wv(i,g,u!==null?u.memoizedProps:g)),f&1024&&(Iv=!0);break;case 6:if(Wr(o,i),Yr(i),f&4){if(i.stateNode===null)throw Error(r(162));f=i.memoizedProps,u=i.stateNode;try{u.nodeValue=f}catch(Be){Et(i,i.return,Be)}}break;case 3:if(Td=null,g=xn,xn=_d(o.containerInfo),Wr(o,i),xn=g,Yr(i),f&4&&u!==null&&u.memoizedState.isDehydrated)try{Eo(o.containerInfo)}catch(Be){Et(i,i.return,Be)}Iv&&(Iv=!1,Ab(i));break;case 4:f=xn,xn=_d(i.stateNode.containerInfo),Wr(o,i),Yr(i),xn=f;break;case 12:Wr(o,i),Yr(i);break;case 31:Wr(o,i),Yr(i),f&4&&(f=i.updateQueue,f!==null&&(i.updateQueue=null,od(i,f)));break;case 13:Wr(o,i),Yr(i),i.child.flags&8192&&i.memoizedState!==null!=(u!==null&&u.memoizedState!==null)&&(ud=Ge()),f&4&&(f=i.updateQueue,f!==null&&(i.updateQueue=null,od(i,f)));break;case 22:g=i.memoizedState!==null;var H=u!==null&&u.memoizedState!==null,ae=Ii,me=sr;if(Ii=ae||g,sr=me||H,Wr(o,i),sr=me,Ii=ae,Yr(i),f&8192)e:for(o=i.stateNode,o._visibility=g?o._visibility&-2:o._visibility|1,g&&(u===null||H||Ii||sr||as(i)),u=null,o=i;;){if(o.tag===5||o.tag===26){if(u===null){H=u=o;try{if(S=H.stateNode,g)k=S.style,typeof k.setProperty=="function"?k.setProperty("display","none","important"):k.display="none";else{L=H.stateNode;var Se=H.memoizedProps.style,oe=Se!=null&&Se.hasOwnProperty("display")?Se.display:null;L.style.display=oe==null||typeof oe=="boolean"?"":(""+oe).trim()}}catch(Be){Et(H,H.return,Be)}}}else if(o.tag===6){if(u===null){H=o;try{H.stateNode.nodeValue=g?"":H.memoizedProps}catch(Be){Et(H,H.return,Be)}}}else if(o.tag===18){if(u===null){H=o;try{var ve=H.stateNode;g?S_(ve,!0):S_(H.stateNode,!1)}catch(Be){Et(H,H.return,Be)}}}else if((o.tag!==22&&o.tag!==23||o.memoizedState===null||o===i)&&o.child!==null){o.child.return=o,o=o.child;continue}if(o===i)break e;for(;o.sibling===null;){if(o.return===null||o.return===i)break e;u===o&&(u=null),o=o.return}u===o&&(u=null),o.sibling.return=o.return,o=o.sibling}f&4&&(f=i.updateQueue,f!==null&&(u=f.retryQueue,u!==null&&(f.retryQueue=null,od(i,u))));break;case 19:Wr(o,i),Yr(i),f&4&&(f=i.updateQueue,f!==null&&(i.updateQueue=null,od(i,f)));break;case 30:break;case 21:break;default:Wr(o,i),Yr(i)}}function Yr(i){var o=i.flags;if(o&2){try{for(var u,f=i.return;f!==null;){if(_b(f)){u=f;break}f=f.return}if(u==null)throw Error(r(160));switch(u.tag){case 27:var g=u.stateNode,S=Rv(i);sd(i,S,g);break;case 5:var k=u.stateNode;u.flags&32&&(Gs(k,""),u.flags&=-33);var L=Rv(i);sd(i,L,k);break;case 3:case 4:var H=u.stateNode.containerInfo,ae=Rv(i);Cv(i,ae,H);break;default:throw Error(r(161))}}catch(me){Et(i,i.return,me)}i.flags&=-3}o&4096&&(i.flags&=-4097)}function Ab(i){if(i.subtreeFlags&1024)for(i=i.child;i!==null;){var o=i;Ab(o),o.tag===5&&o.flags&1024&&o.stateNode.reset(),i=i.sibling}}function ki(i,o){if(o.subtreeFlags&8772)for(o=o.child;o!==null;)wb(i,o.alternate,o),o=o.sibling}function as(i){for(i=i.child;i!==null;){var o=i;switch(o.tag){case 0:case 11:case 14:case 15:ua(4,o,o.return),as(o);break;case 1:ti(o,o.return);var u=o.stateNode;typeof u.componentWillUnmount=="function"&&Sb(o,o.return,u),as(o);break;case 27:zl(o.stateNode);case 26:case 5:ti(o,o.return),as(o);break;case 22:o.memoizedState===null&&as(o);break;case 30:as(o);break;default:as(o)}i=i.sibling}}function Ai(i,o,u){for(u=u&&(o.subtreeFlags&8772)!==0,o=o.child;o!==null;){var f=o.alternate,g=i,S=o,k=S.flags;switch(S.tag){case 0:case 11:case 15:Ai(g,S,u),Ll(4,S);break;case 1:if(Ai(g,S,u),f=S,g=f.stateNode,typeof g.componentDidMount=="function")try{g.componentDidMount()}catch(ae){Et(f,f.return,ae)}if(f=S,g=f.updateQueue,g!==null){var L=f.stateNode;try{var H=g.shared.hiddenCallbacks;if(H!==null)for(g.shared.hiddenCallbacks=null,g=0;g<H.length;g++)oS(H[g],L)}catch(ae){Et(f,f.return,ae)}}u&&k&64&&yb(S),xl(S,S.return);break;case 27:Eb(S);case 26:case 5:Ai(g,S,u),u&&f===null&&k&4&&bb(S),xl(S,S.return);break;case 12:Ai(g,S,u);break;case 31:Ai(g,S,u),u&&k&4&&Ib(g,S);break;case 13:Ai(g,S,u),u&&k&4&&Ob(g,S);break;case 22:S.memoizedState===null&&Ai(g,S,u),xl(S,S.return);break;case 30:break;default:Ai(g,S,u)}o=o.sibling}}function Ov(i,o){var u=null;i!==null&&i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(u=i.memoizedState.cachePool.pool),i=null,o.memoizedState!==null&&o.memoizedState.cachePool!==null&&(i=o.memoizedState.cachePool.pool),i!==u&&(i!=null&&i.refCount++,u!=null&&Tl(u))}function kv(i,o){i=null,o.alternate!==null&&(i=o.alternate.memoizedState.cache),o=o.memoizedState.cache,o!==i&&(o.refCount++,i!=null&&Tl(i))}function Bn(i,o,u,f){if(o.subtreeFlags&10256)for(o=o.child;o!==null;)Db(i,o,u,f),o=o.sibling}function Db(i,o,u,f){var g=o.flags;switch(o.tag){case 0:case 11:case 15:Bn(i,o,u,f),g&2048&&Ll(9,o);break;case 1:Bn(i,o,u,f);break;case 3:Bn(i,o,u,f),g&2048&&(i=null,o.alternate!==null&&(i=o.alternate.memoizedState.cache),o=o.memoizedState.cache,o!==i&&(o.refCount++,i!=null&&Tl(i)));break;case 12:if(g&2048){Bn(i,o,u,f),i=o.stateNode;try{var S=o.memoizedProps,k=S.id,L=S.onPostCommit;typeof L=="function"&&L(k,o.alternate===null?"mount":"update",i.passiveEffectDuration,-0)}catch(H){Et(o,o.return,H)}}else Bn(i,o,u,f);break;case 31:Bn(i,o,u,f);break;case 13:Bn(i,o,u,f);break;case 23:break;case 22:S=o.stateNode,k=o.alternate,o.memoizedState!==null?S._visibility&2?Bn(i,o,u,f):Bl(i,o):S._visibility&2?Bn(i,o,u,f):(S._visibility|=2,co(i,o,u,f,(o.subtreeFlags&10256)!==0||!1)),g&2048&&Ov(k,o);break;case 24:Bn(i,o,u,f),g&2048&&kv(o.alternate,o);break;default:Bn(i,o,u,f)}}function co(i,o,u,f,g){for(g=g&&((o.subtreeFlags&10256)!==0||!1),o=o.child;o!==null;){var S=i,k=o,L=u,H=f,ae=k.flags;switch(k.tag){case 0:case 11:case 15:co(S,k,L,H,g),Ll(8,k);break;case 23:break;case 22:var me=k.stateNode;k.memoizedState!==null?me._visibility&2?co(S,k,L,H,g):Bl(S,k):(me._visibility|=2,co(S,k,L,H,g)),g&&ae&2048&&Ov(k.alternate,k);break;case 24:co(S,k,L,H,g),g&&ae&2048&&kv(k.alternate,k);break;default:co(S,k,L,H,g)}o=o.sibling}}function Bl(i,o){if(o.subtreeFlags&10256)for(o=o.child;o!==null;){var u=i,f=o,g=f.flags;switch(f.tag){case 22:Bl(u,f),g&2048&&Ov(f.alternate,f);break;case 24:Bl(u,f),g&2048&&kv(f.alternate,f);break;default:Bl(u,f)}o=o.sibling}}var Kl=8192;function fo(i,o,u){if(i.subtreeFlags&Kl)for(i=i.child;i!==null;)Mb(i,o,u),i=i.sibling}function Mb(i,o,u){switch(i.tag){case 26:fo(i,o,u),i.flags&Kl&&i.memoizedState!==null&&AO(u,xn,i.memoizedState,i.memoizedProps);break;case 5:fo(i,o,u);break;case 3:case 4:var f=xn;xn=_d(i.stateNode.containerInfo),fo(i,o,u),xn=f;break;case 22:i.memoizedState===null&&(f=i.alternate,f!==null&&f.memoizedState!==null?(f=Kl,Kl=16777216,fo(i,o,u),Kl=f):fo(i,o,u));break;default:fo(i,o,u)}}function Nb(i){var o=i.alternate;if(o!==null&&(i=o.child,i!==null)){o.child=null;do o=i.sibling,i.sibling=null,i=o;while(i!==null)}}function jl(i){var o=i.deletions;if((i.flags&16)!==0){if(o!==null)for(var u=0;u<o.length;u++){var f=o[u];gr=f,Pb(f,i)}Nb(i)}if(i.subtreeFlags&10256)for(i=i.child;i!==null;)Ub(i),i=i.sibling}function Ub(i){switch(i.tag){case 0:case 11:case 15:jl(i),i.flags&2048&&ua(9,i,i.return);break;case 3:jl(i);break;case 12:jl(i);break;case 22:var o=i.stateNode;i.memoizedState!==null&&o._visibility&2&&(i.return===null||i.return.tag!==13)?(o._visibility&=-3,ld(i)):jl(i);break;default:jl(i)}}function ld(i){var o=i.deletions;if((i.flags&16)!==0){if(o!==null)for(var u=0;u<o.length;u++){var f=o[u];gr=f,Pb(f,i)}Nb(i)}for(i=i.child;i!==null;){switch(o=i,o.tag){case 0:case 11:case 15:ua(8,o,o.return),ld(o);break;case 22:u=o.stateNode,u._visibility&2&&(u._visibility&=-3,ld(o));break;default:ld(o)}i=i.sibling}}function Pb(i,o){for(;gr!==null;){var u=gr;switch(u.tag){case 0:case 11:case 15:ua(8,u,o);break;case 23:case 22:if(u.memoizedState!==null&&u.memoizedState.cachePool!==null){var f=u.memoizedState.cachePool.pool;f!=null&&f.refCount++}break;case 24:Tl(u.memoizedState.cache)}if(f=u.child,f!==null)f.return=u,gr=f;else e:for(u=i;gr!==null;){f=gr;var g=f.sibling,S=f.return;if(Rb(f),f===u){gr=null;break e}if(g!==null){g.return=S,gr=g;break e}gr=S}}}var HI={getCacheForType:function(i){var o=wr(nr),u=o.data.get(i);return u===void 0&&(u=i(),o.data.set(i,u)),u},cacheSignal:function(){return wr(nr).controller.signal}},zI=typeof WeakMap=="function"?WeakMap:Map,yt=0,At=null,st=null,lt=0,_t=0,un=null,ca=!1,ho=!1,Av=!1,Di=0,Jt=0,da=0,ss=0,Dv=0,cn=0,vo=0,Fl=null,Jr=null,Mv=!1,ud=0,Lb=0,cd=1/0,dd=null,fa=null,ur=0,ha=null,go=null,Mi=0,Nv=0,Uv=null,xb=null,ql=0,Pv=null;function dn(){return(yt&2)!==0&&lt!==0?lt&-lt:B.T!==null?Fv():Zm()}function Bb(){if(cn===0)if((lt&536870912)===0||ft){var i=Tt;Tt<<=1,(Tt&3932160)===0&&(Tt=262144),cn=i}else cn=536870912;return i=on.current,i!==null&&(i.flags|=32),cn}function Qr(i,o,u){(i===At&&(_t===2||_t===9)||i.cancelPendingCommit!==null)&&(po(i,0),va(i,lt,cn,!1)),ul(i,u),((yt&2)===0||i!==At)&&(i===At&&((yt&2)===0&&(ss|=u),Jt===4&&va(i,lt,cn,!1)),ri(i))}function Kb(i,o,u){if((yt&6)!==0)throw Error(r(327));var f=!u&&(o&127)===0&&(o&i.expiredLanes)===0||nn(i,o),g=f?JI(i,o):xv(i,o,!0),S=f;do{if(g===0){ho&&!f&&va(i,o,0,!1);break}else{if(u=i.current.alternate,S&&!WI(u)){g=xv(i,o,!1),S=!1;continue}if(g===2){if(S=o,i.errorRecoveryDisabledLanes&S)var k=0;else k=i.pendingLanes&-536870913,k=k!==0?k:k&536870912?536870912:0;if(k!==0){o=k;e:{var L=i;g=Fl;var H=L.current.memoizedState.isDehydrated;if(H&&(po(L,k).flags|=256),k=xv(L,k,!1),k!==2){if(Av&&!H){L.errorRecoveryDisabledLanes|=S,ss|=S,g=4;break e}S=Jr,Jr=g,S!==null&&(Jr===null?Jr=S:Jr.push.apply(Jr,S))}g=k}if(S=!1,g!==2)continue}}if(g===1){po(i,0),va(i,o,0,!0);break}e:{switch(f=i,S=g,S){case 0:case 1:throw Error(r(345));case 4:if((o&4194048)!==o)break;case 6:va(f,o,cn,!ca);break e;case 2:Jr=null;break;case 3:case 5:break;default:throw Error(r(329))}if((o&62914560)===o&&(g=ud+300-Ge(),10<g)){if(va(f,o,cn,!ca),rn(f,0,!0)!==0)break e;Mi=o,f.timeoutHandle=p_(jb.bind(null,f,u,Jr,dd,Mv,o,cn,ss,vo,ca,S,"Throttled",-0,0),g);break e}jb(f,u,Jr,dd,Mv,o,cn,ss,vo,ca,S,null,-0,0)}}break}while(!0);ri(i)}function jb(i,o,u,f,g,S,k,L,H,ae,me,Se,oe,ve){if(i.timeoutHandle=-1,Se=o.subtreeFlags,Se&8192||(Se&16785408)===16785408){Se={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:mi},Mb(o,S,Se);var Be=(S&62914560)===S?ud-Ge():(S&4194048)===S?Lb-Ge():0;if(Be=DO(Se,Be),Be!==null){Mi=S,i.cancelPendingCommit=Be(Yb.bind(null,i,o,S,u,f,g,k,L,H,me,Se,null,oe,ve)),va(i,S,k,!ae);return}}Yb(i,o,S,u,f,g,k,L,H)}function WI(i){for(var o=i;;){var u=o.tag;if((u===0||u===11||u===15)&&o.flags&16384&&(u=o.updateQueue,u!==null&&(u=u.stores,u!==null)))for(var f=0;f<u.length;f++){var g=u[f],S=g.getSnapshot;g=g.value;try{if(!an(S(),g))return!1}catch{return!1}}if(u=o.child,o.subtreeFlags&16384&&u!==null)u.return=o,o=u;else{if(o===i)break;for(;o.sibling===null;){if(o.return===null||o.return===i)return!0;o=o.return}o.sibling.return=o.return,o=o.sibling}}return!0}function va(i,o,u,f){o&=~Dv,o&=~ss,i.suspendedLanes|=o,i.pingedLanes&=~o,f&&(i.warmLanes|=o),f=i.expirationTimes;for(var g=o;0<g;){var S=31-ge(g),k=1<<S;f[S]=-1,g&=~k}u!==0&&Qm(i,u,o)}function fd(){return(yt&6)===0?(Vl(0),!1):!0}function Lv(){if(st!==null){if(_t===0)var i=st.return;else i=st,_i=Xa=null,$h(i),ao=null,Rl=0,i=st;for(;i!==null;)mb(i.alternate,i),i=i.return;st=null}}function po(i,o){var u=i.timeoutHandle;u!==-1&&(i.timeoutHandle=-1,hO(u)),u=i.cancelPendingCommit,u!==null&&(i.cancelPendingCommit=null,u()),Mi=0,Lv(),At=i,st=u=Si(i.current,null),lt=o,_t=0,un=null,ca=!1,ho=nn(i,o),Av=!1,vo=cn=Dv=ss=da=Jt=0,Jr=Fl=null,Mv=!1,(o&8)!==0&&(o|=o&32);var f=i.entangledLanes;if(f!==0)for(i=i.entanglements,f&=o;0<f;){var g=31-ge(f),S=1<<g;o|=i[g],f&=~S}return Di=o,Nc(),u}function Fb(i,o){Ze=null,B.H=Nl,o===io||o===Fc?(o=nS(),_t=3):o===jh?(o=nS(),_t=4):_t=o===vv?8:o!==null&&typeof o=="object"&&typeof o.then=="function"?6:1,un=o,st===null&&(Jt=1,td(i,Rn(o,i.current)))}function qb(){var i=on.current;return i===null?!0:(lt&4194048)===lt?kn===null:(lt&62914560)===lt||(lt&536870912)!==0?i===kn:!1}function Vb(){var i=B.H;return B.H=Nl,i===null?Nl:i}function Gb(){var i=B.A;return B.A=HI,i}function hd(){Jt=4,ca||(lt&4194048)!==lt&&on.current!==null||(ho=!0),(da&134217727)===0&&(ss&134217727)===0||At===null||va(At,lt,cn,!1)}function xv(i,o,u){var f=yt;yt|=2;var g=Vb(),S=Gb();(At!==i||lt!==o)&&(dd=null,po(i,o)),o=!1;var k=Jt;e:do try{if(_t!==0&&st!==null){var L=st,H=un;switch(_t){case 8:Lv(),k=6;break e;case 3:case 2:case 9:case 6:on.current===null&&(o=!0);var ae=_t;if(_t=0,un=null,mo(i,L,H,ae),u&&ho){k=0;break e}break;default:ae=_t,_t=0,un=null,mo(i,L,H,ae)}}YI(),k=Jt;break}catch(me){Fb(i,me)}while(!0);return o&&i.shellSuspendCounter++,_i=Xa=null,yt=f,B.H=g,B.A=S,st===null&&(At=null,lt=0,Nc()),k}function YI(){for(;st!==null;)Hb(st)}function JI(i,o){var u=yt;yt|=2;var f=Vb(),g=Gb();At!==i||lt!==o?(dd=null,cd=Ge()+500,po(i,o)):ho=nn(i,o);e:do try{if(_t!==0&&st!==null){o=st;var S=un;t:switch(_t){case 1:_t=0,un=null,mo(i,o,S,1);break;case 2:case 9:if(tS(S)){_t=0,un=null,zb(o);break}o=function(){_t!==2&&_t!==9||At!==i||(_t=7),ri(i)},S.then(o,o);break e;case 3:_t=7;break e;case 4:_t=5;break e;case 7:tS(S)?(_t=0,un=null,zb(o)):(_t=0,un=null,mo(i,o,S,7));break;case 5:var k=null;switch(st.tag){case 26:k=st.memoizedState;case 5:case 27:var L=st;if(k?D_(k):L.stateNode.complete){_t=0,un=null;var H=L.sibling;if(H!==null)st=H;else{var ae=L.return;ae!==null?(st=ae,vd(ae)):st=null}break t}}_t=0,un=null,mo(i,o,S,5);break;case 6:_t=0,un=null,mo(i,o,S,6);break;case 8:Lv(),Jt=6;break e;default:throw Error(r(462))}}QI();break}catch(me){Fb(i,me)}while(!0);return _i=Xa=null,B.H=f,B.A=g,yt=u,st!==null?0:(At=null,lt=0,Nc(),Jt)}function QI(){for(;st!==null&&!Nt();)Hb(st)}function Hb(i){var o=gb(i.alternate,i,Di);i.memoizedProps=i.pendingProps,o===null?vd(i):st=o}function zb(i){var o=i,u=o.alternate;switch(o.tag){case 15:case 0:o=ub(u,o,o.pendingProps,o.type,void 0,lt);break;case 11:o=ub(u,o,o.pendingProps,o.type.render,o.ref,lt);break;case 5:$h(o);default:mb(u,o),o=st=Gy(o,Di),o=gb(u,o,Di)}i.memoizedProps=i.pendingProps,o===null?vd(i):st=o}function mo(i,o,u,f){_i=Xa=null,$h(o),ao=null,Rl=0;var g=o.return;try{if(BI(i,g,o,u,lt)){Jt=1,td(i,Rn(u,i.current)),st=null;return}}catch(S){if(g!==null)throw st=g,S;Jt=1,td(i,Rn(u,i.current)),st=null;return}o.flags&32768?(ft||f===1?i=!0:ho||(lt&536870912)!==0?i=!1:(ca=i=!0,(f===2||f===9||f===3||f===6)&&(f=on.current,f!==null&&f.tag===13&&(f.flags|=16384))),Wb(o,i)):vd(o)}function vd(i){var o=i;do{if((o.flags&32768)!==0){Wb(o,ca);return}i=o.return;var u=FI(o.alternate,o,Di);if(u!==null){st=u;return}if(o=o.sibling,o!==null){st=o;return}st=o=i}while(o!==null);Jt===0&&(Jt=5)}function Wb(i,o){do{var u=qI(i.alternate,i);if(u!==null){u.flags&=32767,st=u;return}if(u=i.return,u!==null&&(u.flags|=32768,u.subtreeFlags=0,u.deletions=null),!o&&(i=i.sibling,i!==null)){st=i;return}st=i=u}while(i!==null);Jt=6,st=null}function Yb(i,o,u,f,g,S,k,L,H){i.cancelPendingCommit=null;do gd();while(ur!==0);if((yt&6)!==0)throw Error(r(327));if(o!==null){if(o===i.current)throw Error(r(177));if(S=o.lanes|o.childLanes,S|=Rh,kC(i,u,S,k,L,H),i===At&&(st=At=null,lt=0),go=o,ha=i,Mi=u,Nv=S,Uv=g,xb=f,(o.subtreeFlags&10256)!==0||(o.flags&10256)!==0?(i.callbackNode=null,i.callbackPriority=0,eO(Vr,function(){return Zb(),null})):(i.callbackNode=null,i.callbackPriority=0),f=(o.flags&13878)!==0,(o.subtreeFlags&13878)!==0||f){f=B.T,B.T=null,g=te.p,te.p=2,k=yt,yt|=4;try{VI(i,o,u)}finally{yt=k,te.p=g,B.T=f}}ur=1,Jb(),Qb(),Xb()}}function Jb(){if(ur===1){ur=0;var i=ha,o=go,u=(o.flags&13878)!==0;if((o.subtreeFlags&13878)!==0||u){u=B.T,B.T=null;var f=te.p;te.p=2;var g=yt;yt|=4;try{kb(o,i);var S=Jv,k=Py(i.containerInfo),L=S.focusedElem,H=S.selectionRange;if(k!==L&&L&&L.ownerDocument&&Uy(L.ownerDocument.documentElement,L)){if(H!==null&&bh(L)){var ae=H.start,me=H.end;if(me===void 0&&(me=ae),"selectionStart"in L)L.selectionStart=ae,L.selectionEnd=Math.min(me,L.value.length);else{var Se=L.ownerDocument||document,oe=Se&&Se.defaultView||window;if(oe.getSelection){var ve=oe.getSelection(),Be=L.textContent.length,He=Math.min(H.start,Be),It=H.end===void 0?He:Math.min(H.end,Be);!ve.extend&&He>It&&(k=It,It=He,He=k);var ee=Ny(L,He),Q=Ny(L,It);if(ee&&Q&&(ve.rangeCount!==1||ve.anchorNode!==ee.node||ve.anchorOffset!==ee.offset||ve.focusNode!==Q.node||ve.focusOffset!==Q.offset)){var ie=Se.createRange();ie.setStart(ee.node,ee.offset),ve.removeAllRanges(),He>It?(ve.addRange(ie),ve.extend(Q.node,Q.offset)):(ie.setEnd(Q.node,Q.offset),ve.addRange(ie))}}}}for(Se=[],ve=L;ve=ve.parentNode;)ve.nodeType===1&&Se.push({element:ve,left:ve.scrollLeft,top:ve.scrollTop});for(typeof L.focus=="function"&&L.focus(),L=0;L<Se.length;L++){var ye=Se[L];ye.element.scrollLeft=ye.left,ye.element.scrollTop=ye.top}}Id=!!Yv,Jv=Yv=null}finally{yt=g,te.p=f,B.T=u}}i.current=o,ur=2}}function Qb(){if(ur===2){ur=0;var i=ha,o=go,u=(o.flags&8772)!==0;if((o.subtreeFlags&8772)!==0||u){u=B.T,B.T=null;var f=te.p;te.p=2;var g=yt;yt|=4;try{wb(i,o.alternate,o)}finally{yt=g,te.p=f,B.T=u}}ur=3}}function Xb(){if(ur===4||ur===3){ur=0,Ae();var i=ha,o=go,u=Mi,f=xb;(o.subtreeFlags&10256)!==0||(o.flags&10256)!==0?ur=5:(ur=0,go=ha=null,$b(i,i.pendingLanes));var g=i.pendingLanes;if(g===0&&(fa=null),th(u),o=o.stateNode,ne&&typeof ne.onCommitFiberRoot=="function")try{ne.onCommitFiberRoot(Te,o,void 0,(o.current.flags&128)===128)}catch{}if(f!==null){o=B.T,g=te.p,te.p=2,B.T=null;try{for(var S=i.onRecoverableError,k=0;k<f.length;k++){var L=f[k];S(L.value,{componentStack:L.stack})}}finally{B.T=o,te.p=g}}(Mi&3)!==0&&gd(),ri(i),g=i.pendingLanes,(u&261930)!==0&&(g&42)!==0?i===Pv?ql++:(ql=0,Pv=i):ql=0,Vl(0)}}function $b(i,o){(i.pooledCacheLanes&=o)===0&&(o=i.pooledCache,o!=null&&(i.pooledCache=null,Tl(o)))}function gd(){return Jb(),Qb(),Xb(),Zb()}function Zb(){if(ur!==5)return!1;var i=ha,o=Nv;Nv=0;var u=th(Mi),f=B.T,g=te.p;try{te.p=32>u?32:u,B.T=null,u=Uv,Uv=null;var S=ha,k=Mi;if(ur=0,go=ha=null,Mi=0,(yt&6)!==0)throw Error(r(331));var L=yt;if(yt|=4,Ub(S.current),Db(S,S.current,k,u),yt=L,Vl(0,!1),ne&&typeof ne.onPostCommitFiberRoot=="function")try{ne.onPostCommitFiberRoot(Te,S)}catch{}return!0}finally{te.p=g,B.T=f,$b(i,o)}}function e_(i,o,u){o=Rn(u,o),o=hv(i.stateNode,o,2),i=sa(i,o,2),i!==null&&(ul(i,2),ri(i))}function Et(i,o,u){if(i.tag===3)e_(i,i,u);else for(;o!==null;){if(o.tag===3){e_(o,i,u);break}else if(o.tag===1){var f=o.stateNode;if(typeof o.type.getDerivedStateFromError=="function"||typeof f.componentDidCatch=="function"&&(fa===null||!fa.has(f))){i=Rn(u,i),u=tb(2),f=sa(o,u,2),f!==null&&(rb(u,f,o,i),ul(f,2),ri(f));break}}o=o.return}}function Bv(i,o,u){var f=i.pingCache;if(f===null){f=i.pingCache=new zI;var g=new Set;f.set(o,g)}else g=f.get(o),g===void 0&&(g=new Set,f.set(o,g));g.has(u)||(Av=!0,g.add(u),i=XI.bind(null,i,o,u),o.then(i,i))}function XI(i,o,u){var f=i.pingCache;f!==null&&f.delete(o),i.pingedLanes|=i.suspendedLanes&u,i.warmLanes&=~u,At===i&&(lt&u)===u&&(Jt===4||Jt===3&&(lt&62914560)===lt&&300>Ge()-ud?(yt&2)===0&&po(i,0):Dv|=u,vo===lt&&(vo=0)),ri(i)}function t_(i,o){o===0&&(o=Jm()),i=Ya(i,o),i!==null&&(ul(i,o),ri(i))}function $I(i){var o=i.memoizedState,u=0;o!==null&&(u=o.retryLane),t_(i,u)}function ZI(i,o){var u=0;switch(i.tag){case 31:case 13:var f=i.stateNode,g=i.memoizedState;g!==null&&(u=g.retryLane);break;case 19:f=i.stateNode;break;case 22:f=i.stateNode._retryCache;break;default:throw Error(r(314))}f!==null&&f.delete(o),t_(i,u)}function eO(i,o){return it(i,o)}var pd=null,yo=null,Kv=!1,md=!1,jv=!1,ga=0;function ri(i){i!==yo&&i.next===null&&(yo===null?pd=yo=i:yo=yo.next=i),md=!0,Kv||(Kv=!0,rO())}function Vl(i,o){if(!jv&&md){jv=!0;do for(var u=!1,f=pd;f!==null;){if(i!==0){var g=f.pendingLanes;if(g===0)var S=0;else{var k=f.suspendedLanes,L=f.pingedLanes;S=(1<<31-ge(42|i)+1)-1,S&=g&~(k&~L),S=S&201326741?S&201326741|1:S?S|2:0}S!==0&&(u=!0,a_(f,S))}else S=lt,S=rn(f,f===At?S:0,f.cancelPendingCommit!==null||f.timeoutHandle!==-1),(S&3)===0||nn(f,S)||(u=!0,a_(f,S));f=f.next}while(u);jv=!1}}function tO(){r_()}function r_(){md=Kv=!1;var i=0;ga!==0&&fO()&&(i=ga);for(var o=Ge(),u=null,f=pd;f!==null;){var g=f.next,S=n_(f,o);S===0?(f.next=null,u===null?pd=g:u.next=g,g===null&&(yo=u)):(u=f,(i!==0||(S&3)!==0)&&(md=!0)),f=g}ur!==0&&ur!==5||Vl(i),ga!==0&&(ga=0)}function n_(i,o){for(var u=i.suspendedLanes,f=i.pingedLanes,g=i.expirationTimes,S=i.pendingLanes&-62914561;0<S;){var k=31-ge(S),L=1<<k,H=g[k];H===-1?((L&u)===0||(L&f)!==0)&&(g[k]=OC(L,o)):H<=o&&(i.expiredLanes|=L),S&=~L}if(o=At,u=lt,u=rn(i,i===o?u:0,i.cancelPendingCommit!==null||i.timeoutHandle!==-1),f=i.callbackNode,u===0||i===o&&(_t===2||_t===9)||i.cancelPendingCommit!==null)return f!==null&&f!==null&&dt(f),i.callbackNode=null,i.callbackPriority=0;if((u&3)===0||nn(i,u)){if(o=u&-u,o===i.callbackPriority)return o;switch(f!==null&&dt(f),th(u)){case 2:case 8:u=Kt;break;case 32:u=Vr;break;case 268435456:u=$n;break;default:u=Vr}return f=i_.bind(null,i),u=it(u,f),i.callbackPriority=o,i.callbackNode=u,o}return f!==null&&f!==null&&dt(f),i.callbackPriority=2,i.callbackNode=null,2}function i_(i,o){if(ur!==0&&ur!==5)return i.callbackNode=null,i.callbackPriority=0,null;var u=i.callbackNode;if(gd()&&i.callbackNode!==u)return null;var f=lt;return f=rn(i,i===At?f:0,i.cancelPendingCommit!==null||i.timeoutHandle!==-1),f===0?null:(Kb(i,f,o),n_(i,Ge()),i.callbackNode!=null&&i.callbackNode===u?i_.bind(null,i):null)}function a_(i,o){if(gd())return null;Kb(i,o,!0)}function rO(){vO(function(){(yt&6)!==0?it(_n,tO):r_()})}function Fv(){if(ga===0){var i=ro;i===0&&(i=rt,rt<<=1,(rt&261888)===0&&(rt=256)),ga=i}return ga}function s_(i){return i==null||typeof i=="symbol"||typeof i=="boolean"?null:typeof i=="function"?i:Rc(""+i)}function o_(i,o){var u=o.ownerDocument.createElement("input");return u.name=o.name,u.value=o.value,i.id&&u.setAttribute("form",i.id),o.parentNode.insertBefore(u,o),i=new FormData(i),u.parentNode.removeChild(u),i}function nO(i,o,u,f,g){if(o==="submit"&&u&&u.stateNode===g){var S=s_((g[Gr]||null).action),k=f.submitter;k&&(o=(o=k[Gr]||null)?s_(o.formAction):k.getAttribute("formAction"),o!==null&&(S=o,k=null));var L=new kc("action","action",null,f,g);i.push({event:L,listeners:[{instance:null,listener:function(){if(f.defaultPrevented){if(ga!==0){var H=k?o_(g,k):new FormData(g);ov(u,{pending:!0,data:H,method:g.method,action:S},null,H)}}else typeof S=="function"&&(L.preventDefault(),H=k?o_(g,k):new FormData(g),ov(u,{pending:!0,data:H,method:g.method,action:S},S,H))},currentTarget:g}]})}}for(var qv=0;qv<wh.length;qv++){var Vv=wh[qv],iO=Vv.toLowerCase(),aO=Vv[0].toUpperCase()+Vv.slice(1);Ln(iO,"on"+aO)}Ln(By,"onAnimationEnd"),Ln(Ky,"onAnimationIteration"),Ln(jy,"onAnimationStart"),Ln("dblclick","onDoubleClick"),Ln("focusin","onFocus"),Ln("focusout","onBlur"),Ln(_I,"onTransitionRun"),Ln(EI,"onTransitionStart"),Ln(TI,"onTransitionCancel"),Ln(Fy,"onTransitionEnd"),qs("onMouseEnter",["mouseout","mouseover"]),qs("onMouseLeave",["mouseout","mouseover"]),qs("onPointerEnter",["pointerout","pointerover"]),qs("onPointerLeave",["pointerout","pointerover"]),Ga("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Ga("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Ga("onBeforeInput",["compositionend","keypress","textInput","paste"]),Ga("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Ga("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Ga("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Gl="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),sO=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(Gl));function l_(i,o){o=(o&4)!==0;for(var u=0;u<i.length;u++){var f=i[u],g=f.event;f=f.listeners;e:{var S=void 0;if(o)for(var k=f.length-1;0<=k;k--){var L=f[k],H=L.instance,ae=L.currentTarget;if(L=L.listener,H!==S&&g.isPropagationStopped())break e;S=L,g.currentTarget=ae;try{S(g)}catch(me){Mc(me)}g.currentTarget=null,S=H}else for(k=0;k<f.length;k++){if(L=f[k],H=L.instance,ae=L.currentTarget,L=L.listener,H!==S&&g.isPropagationStopped())break e;S=L,g.currentTarget=ae;try{S(g)}catch(me){Mc(me)}g.currentTarget=null,S=H}}}}function ot(i,o){var u=o[rh];u===void 0&&(u=o[rh]=new Set);var f=i+"__bubble";u.has(f)||(u_(o,i,2,!1),u.add(f))}function Gv(i,o,u){var f=0;o&&(f|=4),u_(u,i,f,o)}var yd="_reactListening"+Math.random().toString(36).slice(2);function Hv(i){if(!i[yd]){i[yd]=!0,ry.forEach(function(u){u!=="selectionchange"&&(sO.has(u)||Gv(u,!1,i),Gv(u,!0,i))});var o=i.nodeType===9?i:i.ownerDocument;o===null||o[yd]||(o[yd]=!0,Gv("selectionchange",!1,o))}}function u_(i,o,u,f){switch(B_(o)){case 2:var g=UO;break;case 8:g=PO;break;default:g=sg}u=g.bind(null,o,u,i),g=void 0,!dh||o!=="touchstart"&&o!=="touchmove"&&o!=="wheel"||(g=!0),f?g!==void 0?i.addEventListener(o,u,{capture:!0,passive:g}):i.addEventListener(o,u,!0):g!==void 0?i.addEventListener(o,u,{passive:g}):i.addEventListener(o,u,!1)}function zv(i,o,u,f,g){var S=f;if((o&1)===0&&(o&2)===0&&f!==null)e:for(;;){if(f===null)return;var k=f.tag;if(k===3||k===4){var L=f.stateNode.containerInfo;if(L===g)break;if(k===4)for(k=f.return;k!==null;){var H=k.tag;if((H===3||H===4)&&k.stateNode.containerInfo===g)return;k=k.return}for(;L!==null;){if(k=Ks(L),k===null)return;if(H=k.tag,H===5||H===6||H===26||H===27){f=S=k;continue e}L=L.parentNode}}f=f.return}vy(function(){var ae=S,me=uh(u),Se=[];e:{var oe=qy.get(i);if(oe!==void 0){var ve=kc,Be=i;switch(i){case"keypress":if(Ic(u)===0)break e;case"keydown":case"keyup":ve=ZC;break;case"focusin":Be="focus",ve=gh;break;case"focusout":Be="blur",ve=gh;break;case"beforeblur":case"afterblur":ve=gh;break;case"click":if(u.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":ve=my;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":ve=FC;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":ve=rI;break;case By:case Ky:case jy:ve=GC;break;case Fy:ve=iI;break;case"scroll":case"scrollend":ve=KC;break;case"wheel":ve=sI;break;case"copy":case"cut":case"paste":ve=zC;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":ve=Sy;break;case"toggle":case"beforetoggle":ve=lI}var He=(o&4)!==0,It=!He&&(i==="scroll"||i==="scrollend"),ee=He?oe!==null?oe+"Capture":null:oe;He=[];for(var Q=ae,ie;Q!==null;){var ye=Q;if(ie=ye.stateNode,ye=ye.tag,ye!==5&&ye!==26&&ye!==27||ie===null||ee===null||(ye=fl(Q,ee),ye!=null&&He.push(Hl(Q,ye,ie))),It)break;Q=Q.return}0<He.length&&(oe=new ve(oe,Be,null,u,me),Se.push({event:oe,listeners:He}))}}if((o&7)===0){e:{if(oe=i==="mouseover"||i==="pointerover",ve=i==="mouseout"||i==="pointerout",oe&&u!==lh&&(Be=u.relatedTarget||u.fromElement)&&(Ks(Be)||Be[Bs]))break e;if((ve||oe)&&(oe=me.window===me?me:(oe=me.ownerDocument)?oe.defaultView||oe.parentWindow:window,ve?(Be=u.relatedTarget||u.toElement,ve=ae,Be=Be?Ks(Be):null,Be!==null&&(It=s(Be),He=Be.tag,Be!==It||He!==5&&He!==27&&He!==6)&&(Be=null)):(ve=null,Be=ae),ve!==Be)){if(He=my,ye="onMouseLeave",ee="onMouseEnter",Q="mouse",(i==="pointerout"||i==="pointerover")&&(He=Sy,ye="onPointerLeave",ee="onPointerEnter",Q="pointer"),It=ve==null?oe:dl(ve),ie=Be==null?oe:dl(Be),oe=new He(ye,Q+"leave",ve,u,me),oe.target=It,oe.relatedTarget=ie,ye=null,Ks(me)===ae&&(He=new He(ee,Q+"enter",Be,u,me),He.target=ie,He.relatedTarget=It,ye=He),It=ye,ve&&Be)t:{for(He=oO,ee=ve,Q=Be,ie=0,ye=ee;ye;ye=He(ye))ie++;ye=0;for(var qe=Q;qe;qe=He(qe))ye++;for(;0<ie-ye;)ee=He(ee),ie--;for(;0<ye-ie;)Q=He(Q),ye--;for(;ie--;){if(ee===Q||Q!==null&&ee===Q.alternate){He=ee;break t}ee=He(ee),Q=He(Q)}He=null}else He=null;ve!==null&&c_(Se,oe,ve,He,!1),Be!==null&&It!==null&&c_(Se,It,Be,He,!0)}}e:{if(oe=ae?dl(ae):window,ve=oe.nodeName&&oe.nodeName.toLowerCase(),ve==="select"||ve==="input"&&oe.type==="file")var ht=Iy;else if(Ry(oe))if(Oy)ht=yI;else{ht=pI;var Fe=gI}else ve=oe.nodeName,!ve||ve.toLowerCase()!=="input"||oe.type!=="checkbox"&&oe.type!=="radio"?ae&&oh(ae.elementType)&&(ht=Iy):ht=mI;if(ht&&(ht=ht(i,ae))){Cy(Se,ht,u,me);break e}Fe&&Fe(i,oe,ae),i==="focusout"&&ae&&oe.type==="number"&&ae.memoizedProps.value!=null&&sh(oe,"number",oe.value)}switch(Fe=ae?dl(ae):window,i){case"focusin":(Ry(Fe)||Fe.contentEditable==="true")&&(Ys=Fe,_h=ae,bl=null);break;case"focusout":bl=_h=Ys=null;break;case"mousedown":Eh=!0;break;case"contextmenu":case"mouseup":case"dragend":Eh=!1,Ly(Se,u,me);break;case"selectionchange":if(bI)break;case"keydown":case"keyup":Ly(Se,u,me)}var nt;if(mh)e:{switch(i){case"compositionstart":var ut="onCompositionStart";break e;case"compositionend":ut="onCompositionEnd";break e;case"compositionupdate":ut="onCompositionUpdate";break e}ut=void 0}else Ws?Ty(i,u)&&(ut="onCompositionEnd"):i==="keydown"&&u.keyCode===229&&(ut="onCompositionStart");ut&&(by&&u.locale!=="ko"&&(Ws||ut!=="onCompositionStart"?ut==="onCompositionEnd"&&Ws&&(nt=gy()):(Zi=me,fh="value"in Zi?Zi.value:Zi.textContent,Ws=!0)),Fe=Sd(ae,ut),0<Fe.length&&(ut=new yy(ut,i,null,u,me),Se.push({event:ut,listeners:Fe}),nt?ut.data=nt:(nt=wy(u),nt!==null&&(ut.data=nt)))),(nt=cI?dI(i,u):fI(i,u))&&(ut=Sd(ae,"onBeforeInput"),0<ut.length&&(Fe=new yy("onBeforeInput","beforeinput",null,u,me),Se.push({event:Fe,listeners:ut}),Fe.data=nt)),nO(Se,i,ae,u,me)}l_(Se,o)})}function Hl(i,o,u){return{instance:i,listener:o,currentTarget:u}}function Sd(i,o){for(var u=o+"Capture",f=[];i!==null;){var g=i,S=g.stateNode;if(g=g.tag,g!==5&&g!==26&&g!==27||S===null||(g=fl(i,u),g!=null&&f.unshift(Hl(i,g,S)),g=fl(i,o),g!=null&&f.push(Hl(i,g,S))),i.tag===3)return f;i=i.return}return[]}function oO(i){if(i===null)return null;do i=i.return;while(i&&i.tag!==5&&i.tag!==27);return i||null}function c_(i,o,u,f,g){for(var S=o._reactName,k=[];u!==null&&u!==f;){var L=u,H=L.alternate,ae=L.stateNode;if(L=L.tag,H!==null&&H===f)break;L!==5&&L!==26&&L!==27||ae===null||(H=ae,g?(ae=fl(u,S),ae!=null&&k.unshift(Hl(u,ae,H))):g||(ae=fl(u,S),ae!=null&&k.push(Hl(u,ae,H)))),u=u.return}k.length!==0&&i.push({event:o,listeners:k})}var lO=/\r\n?/g,uO=/\u0000|\uFFFD/g;function d_(i){return(typeof i=="string"?i:""+i).replace(lO,`
`).replace(uO,"")}function f_(i,o){return o=d_(o),d_(i)===o}function Ct(i,o,u,f,g,S){switch(u){case"children":typeof f=="string"?o==="body"||o==="textarea"&&f===""||Gs(i,f):(typeof f=="number"||typeof f=="bigint")&&o!=="body"&&Gs(i,""+f);break;case"className":Tc(i,"class",f);break;case"tabIndex":Tc(i,"tabindex",f);break;case"dir":case"role":case"viewBox":case"width":case"height":Tc(i,u,f);break;case"style":fy(i,f,S);break;case"data":if(o!=="object"){Tc(i,"data",f);break}case"src":case"href":if(f===""&&(o!=="a"||u!=="href")){i.removeAttribute(u);break}if(f==null||typeof f=="function"||typeof f=="symbol"||typeof f=="boolean"){i.removeAttribute(u);break}f=Rc(""+f),i.setAttribute(u,f);break;case"action":case"formAction":if(typeof f=="function"){i.setAttribute(u,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof S=="function"&&(u==="formAction"?(o!=="input"&&Ct(i,o,"name",g.name,g,null),Ct(i,o,"formEncType",g.formEncType,g,null),Ct(i,o,"formMethod",g.formMethod,g,null),Ct(i,o,"formTarget",g.formTarget,g,null)):(Ct(i,o,"encType",g.encType,g,null),Ct(i,o,"method",g.method,g,null),Ct(i,o,"target",g.target,g,null)));if(f==null||typeof f=="symbol"||typeof f=="boolean"){i.removeAttribute(u);break}f=Rc(""+f),i.setAttribute(u,f);break;case"onClick":f!=null&&(i.onclick=mi);break;case"onScroll":f!=null&&ot("scroll",i);break;case"onScrollEnd":f!=null&&ot("scrollend",i);break;case"dangerouslySetInnerHTML":if(f!=null){if(typeof f!="object"||!("__html"in f))throw Error(r(61));if(u=f.__html,u!=null){if(g.children!=null)throw Error(r(60));i.innerHTML=u}}break;case"multiple":i.multiple=f&&typeof f!="function"&&typeof f!="symbol";break;case"muted":i.muted=f&&typeof f!="function"&&typeof f!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(f==null||typeof f=="function"||typeof f=="boolean"||typeof f=="symbol"){i.removeAttribute("xlink:href");break}u=Rc(""+f),i.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",u);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":f!=null&&typeof f!="function"&&typeof f!="symbol"?i.setAttribute(u,""+f):i.removeAttribute(u);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":f&&typeof f!="function"&&typeof f!="symbol"?i.setAttribute(u,""):i.removeAttribute(u);break;case"capture":case"download":f===!0?i.setAttribute(u,""):f!==!1&&f!=null&&typeof f!="function"&&typeof f!="symbol"?i.setAttribute(u,f):i.removeAttribute(u);break;case"cols":case"rows":case"size":case"span":f!=null&&typeof f!="function"&&typeof f!="symbol"&&!isNaN(f)&&1<=f?i.setAttribute(u,f):i.removeAttribute(u);break;case"rowSpan":case"start":f==null||typeof f=="function"||typeof f=="symbol"||isNaN(f)?i.removeAttribute(u):i.setAttribute(u,f);break;case"popover":ot("beforetoggle",i),ot("toggle",i),Ec(i,"popover",f);break;case"xlinkActuate":pi(i,"http://www.w3.org/1999/xlink","xlink:actuate",f);break;case"xlinkArcrole":pi(i,"http://www.w3.org/1999/xlink","xlink:arcrole",f);break;case"xlinkRole":pi(i,"http://www.w3.org/1999/xlink","xlink:role",f);break;case"xlinkShow":pi(i,"http://www.w3.org/1999/xlink","xlink:show",f);break;case"xlinkTitle":pi(i,"http://www.w3.org/1999/xlink","xlink:title",f);break;case"xlinkType":pi(i,"http://www.w3.org/1999/xlink","xlink:type",f);break;case"xmlBase":pi(i,"http://www.w3.org/XML/1998/namespace","xml:base",f);break;case"xmlLang":pi(i,"http://www.w3.org/XML/1998/namespace","xml:lang",f);break;case"xmlSpace":pi(i,"http://www.w3.org/XML/1998/namespace","xml:space",f);break;case"is":Ec(i,"is",f);break;case"innerText":case"textContent":break;default:(!(2<u.length)||u[0]!=="o"&&u[0]!=="O"||u[1]!=="n"&&u[1]!=="N")&&(u=xC.get(u)||u,Ec(i,u,f))}}function Wv(i,o,u,f,g,S){switch(u){case"style":fy(i,f,S);break;case"dangerouslySetInnerHTML":if(f!=null){if(typeof f!="object"||!("__html"in f))throw Error(r(61));if(u=f.__html,u!=null){if(g.children!=null)throw Error(r(60));i.innerHTML=u}}break;case"children":typeof f=="string"?Gs(i,f):(typeof f=="number"||typeof f=="bigint")&&Gs(i,""+f);break;case"onScroll":f!=null&&ot("scroll",i);break;case"onScrollEnd":f!=null&&ot("scrollend",i);break;case"onClick":f!=null&&(i.onclick=mi);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!ny.hasOwnProperty(u))e:{if(u[0]==="o"&&u[1]==="n"&&(g=u.endsWith("Capture"),o=u.slice(2,g?u.length-7:void 0),S=i[Gr]||null,S=S!=null?S[u]:null,typeof S=="function"&&i.removeEventListener(o,S,g),typeof f=="function")){typeof S!="function"&&S!==null&&(u in i?i[u]=null:i.hasAttribute(u)&&i.removeAttribute(u)),i.addEventListener(o,f,g);break e}u in i?i[u]=f:f===!0?i.setAttribute(u,""):Ec(i,u,f)}}}function Cr(i,o,u){switch(o){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":ot("error",i),ot("load",i);var f=!1,g=!1,S;for(S in u)if(u.hasOwnProperty(S)){var k=u[S];if(k!=null)switch(S){case"src":f=!0;break;case"srcSet":g=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(r(137,o));default:Ct(i,o,S,k,u,null)}}g&&Ct(i,o,"srcSet",u.srcSet,u,null),f&&Ct(i,o,"src",u.src,u,null);return;case"input":ot("invalid",i);var L=S=k=g=null,H=null,ae=null;for(f in u)if(u.hasOwnProperty(f)){var me=u[f];if(me!=null)switch(f){case"name":g=me;break;case"type":k=me;break;case"checked":H=me;break;case"defaultChecked":ae=me;break;case"value":S=me;break;case"defaultValue":L=me;break;case"children":case"dangerouslySetInnerHTML":if(me!=null)throw Error(r(137,o));break;default:Ct(i,o,f,me,u,null)}}ly(i,S,L,H,ae,k,g,!1);return;case"select":ot("invalid",i),f=k=S=null;for(g in u)if(u.hasOwnProperty(g)&&(L=u[g],L!=null))switch(g){case"value":S=L;break;case"defaultValue":k=L;break;case"multiple":f=L;default:Ct(i,o,g,L,u,null)}o=S,u=k,i.multiple=!!f,o!=null?Vs(i,!!f,o,!1):u!=null&&Vs(i,!!f,u,!0);return;case"textarea":ot("invalid",i),S=g=f=null;for(k in u)if(u.hasOwnProperty(k)&&(L=u[k],L!=null))switch(k){case"value":f=L;break;case"defaultValue":g=L;break;case"children":S=L;break;case"dangerouslySetInnerHTML":if(L!=null)throw Error(r(91));break;default:Ct(i,o,k,L,u,null)}cy(i,f,g,S);return;case"option":for(H in u)if(u.hasOwnProperty(H)&&(f=u[H],f!=null))switch(H){case"selected":i.selected=f&&typeof f!="function"&&typeof f!="symbol";break;default:Ct(i,o,H,f,u,null)}return;case"dialog":ot("beforetoggle",i),ot("toggle",i),ot("cancel",i),ot("close",i);break;case"iframe":case"object":ot("load",i);break;case"video":case"audio":for(f=0;f<Gl.length;f++)ot(Gl[f],i);break;case"image":ot("error",i),ot("load",i);break;case"details":ot("toggle",i);break;case"embed":case"source":case"link":ot("error",i),ot("load",i);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(ae in u)if(u.hasOwnProperty(ae)&&(f=u[ae],f!=null))switch(ae){case"children":case"dangerouslySetInnerHTML":throw Error(r(137,o));default:Ct(i,o,ae,f,u,null)}return;default:if(oh(o)){for(me in u)u.hasOwnProperty(me)&&(f=u[me],f!==void 0&&Wv(i,o,me,f,u,void 0));return}}for(L in u)u.hasOwnProperty(L)&&(f=u[L],f!=null&&Ct(i,o,L,f,u,null))}function cO(i,o,u,f){switch(o){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var g=null,S=null,k=null,L=null,H=null,ae=null,me=null;for(ve in u){var Se=u[ve];if(u.hasOwnProperty(ve)&&Se!=null)switch(ve){case"checked":break;case"value":break;case"defaultValue":H=Se;default:f.hasOwnProperty(ve)||Ct(i,o,ve,null,f,Se)}}for(var oe in f){var ve=f[oe];if(Se=u[oe],f.hasOwnProperty(oe)&&(ve!=null||Se!=null))switch(oe){case"type":S=ve;break;case"name":g=ve;break;case"checked":ae=ve;break;case"defaultChecked":me=ve;break;case"value":k=ve;break;case"defaultValue":L=ve;break;case"children":case"dangerouslySetInnerHTML":if(ve!=null)throw Error(r(137,o));break;default:ve!==Se&&Ct(i,o,oe,ve,f,Se)}}ah(i,k,L,H,ae,me,S,g);return;case"select":ve=k=L=oe=null;for(S in u)if(H=u[S],u.hasOwnProperty(S)&&H!=null)switch(S){case"value":break;case"multiple":ve=H;default:f.hasOwnProperty(S)||Ct(i,o,S,null,f,H)}for(g in f)if(S=f[g],H=u[g],f.hasOwnProperty(g)&&(S!=null||H!=null))switch(g){case"value":oe=S;break;case"defaultValue":L=S;break;case"multiple":k=S;default:S!==H&&Ct(i,o,g,S,f,H)}o=L,u=k,f=ve,oe!=null?Vs(i,!!u,oe,!1):!!f!=!!u&&(o!=null?Vs(i,!!u,o,!0):Vs(i,!!u,u?[]:"",!1));return;case"textarea":ve=oe=null;for(L in u)if(g=u[L],u.hasOwnProperty(L)&&g!=null&&!f.hasOwnProperty(L))switch(L){case"value":break;case"children":break;default:Ct(i,o,L,null,f,g)}for(k in f)if(g=f[k],S=u[k],f.hasOwnProperty(k)&&(g!=null||S!=null))switch(k){case"value":oe=g;break;case"defaultValue":ve=g;break;case"children":break;case"dangerouslySetInnerHTML":if(g!=null)throw Error(r(91));break;default:g!==S&&Ct(i,o,k,g,f,S)}uy(i,oe,ve);return;case"option":for(var Be in u)if(oe=u[Be],u.hasOwnProperty(Be)&&oe!=null&&!f.hasOwnProperty(Be))switch(Be){case"selected":i.selected=!1;break;default:Ct(i,o,Be,null,f,oe)}for(H in f)if(oe=f[H],ve=u[H],f.hasOwnProperty(H)&&oe!==ve&&(oe!=null||ve!=null))switch(H){case"selected":i.selected=oe&&typeof oe!="function"&&typeof oe!="symbol";break;default:Ct(i,o,H,oe,f,ve)}return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var He in u)oe=u[He],u.hasOwnProperty(He)&&oe!=null&&!f.hasOwnProperty(He)&&Ct(i,o,He,null,f,oe);for(ae in f)if(oe=f[ae],ve=u[ae],f.hasOwnProperty(ae)&&oe!==ve&&(oe!=null||ve!=null))switch(ae){case"children":case"dangerouslySetInnerHTML":if(oe!=null)throw Error(r(137,o));break;default:Ct(i,o,ae,oe,f,ve)}return;default:if(oh(o)){for(var It in u)oe=u[It],u.hasOwnProperty(It)&&oe!==void 0&&!f.hasOwnProperty(It)&&Wv(i,o,It,void 0,f,oe);for(me in f)oe=f[me],ve=u[me],!f.hasOwnProperty(me)||oe===ve||oe===void 0&&ve===void 0||Wv(i,o,me,oe,f,ve);return}}for(var ee in u)oe=u[ee],u.hasOwnProperty(ee)&&oe!=null&&!f.hasOwnProperty(ee)&&Ct(i,o,ee,null,f,oe);for(Se in f)oe=f[Se],ve=u[Se],!f.hasOwnProperty(Se)||oe===ve||oe==null&&ve==null||Ct(i,o,Se,oe,f,ve)}function h_(i){switch(i){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function dO(){if(typeof performance.getEntriesByType=="function"){for(var i=0,o=0,u=performance.getEntriesByType("resource"),f=0;f<u.length;f++){var g=u[f],S=g.transferSize,k=g.initiatorType,L=g.duration;if(S&&L&&h_(k)){for(k=0,L=g.responseEnd,f+=1;f<u.length;f++){var H=u[f],ae=H.startTime;if(ae>L)break;var me=H.transferSize,Se=H.initiatorType;me&&h_(Se)&&(H=H.responseEnd,k+=me*(H<L?1:(L-ae)/(H-ae)))}if(--f,o+=8*(S+k)/(g.duration/1e3),i++,10<i)break}}if(0<i)return o/i/1e6}return navigator.connection&&(i=navigator.connection.downlink,typeof i=="number")?i:5}var Yv=null,Jv=null;function bd(i){return i.nodeType===9?i:i.ownerDocument}function v_(i){switch(i){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function g_(i,o){if(i===0)switch(o){case"svg":return 1;case"math":return 2;default:return 0}return i===1&&o==="foreignObject"?0:i}function Qv(i,o){return i==="textarea"||i==="noscript"||typeof o.children=="string"||typeof o.children=="number"||typeof o.children=="bigint"||typeof o.dangerouslySetInnerHTML=="object"&&o.dangerouslySetInnerHTML!==null&&o.dangerouslySetInnerHTML.__html!=null}var Xv=null;function fO(){var i=window.event;return i&&i.type==="popstate"?i===Xv?!1:(Xv=i,!0):(Xv=null,!1)}var p_=typeof setTimeout=="function"?setTimeout:void 0,hO=typeof clearTimeout=="function"?clearTimeout:void 0,m_=typeof Promise=="function"?Promise:void 0,vO=typeof queueMicrotask=="function"?queueMicrotask:typeof m_<"u"?function(i){return m_.resolve(null).then(i).catch(gO)}:p_;function gO(i){setTimeout(function(){throw i})}function pa(i){return i==="head"}function y_(i,o){var u=o,f=0;do{var g=u.nextSibling;if(i.removeChild(u),g&&g.nodeType===8)if(u=g.data,u==="/$"||u==="/&"){if(f===0){i.removeChild(g),Eo(o);return}f--}else if(u==="$"||u==="$?"||u==="$~"||u==="$!"||u==="&")f++;else if(u==="html")zl(i.ownerDocument.documentElement);else if(u==="head"){u=i.ownerDocument.head,zl(u);for(var S=u.firstChild;S;){var k=S.nextSibling,L=S.nodeName;S[cl]||L==="SCRIPT"||L==="STYLE"||L==="LINK"&&S.rel.toLowerCase()==="stylesheet"||u.removeChild(S),S=k}}else u==="body"&&zl(i.ownerDocument.body);u=g}while(u);Eo(o)}function S_(i,o){var u=i;i=0;do{var f=u.nextSibling;if(u.nodeType===1?o?(u._stashedDisplay=u.style.display,u.style.display="none"):(u.style.display=u._stashedDisplay||"",u.getAttribute("style")===""&&u.removeAttribute("style")):u.nodeType===3&&(o?(u._stashedText=u.nodeValue,u.nodeValue=""):u.nodeValue=u._stashedText||""),f&&f.nodeType===8)if(u=f.data,u==="/$"){if(i===0)break;i--}else u!=="$"&&u!=="$?"&&u!=="$~"&&u!=="$!"||i++;u=f}while(u)}function $v(i){var o=i.firstChild;for(o&&o.nodeType===10&&(o=o.nextSibling);o;){var u=o;switch(o=o.nextSibling,u.nodeName){case"HTML":case"HEAD":case"BODY":$v(u),nh(u);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(u.rel.toLowerCase()==="stylesheet")continue}i.removeChild(u)}}function pO(i,o,u,f){for(;i.nodeType===1;){var g=u;if(i.nodeName.toLowerCase()!==o.toLowerCase()){if(!f&&(i.nodeName!=="INPUT"||i.type!=="hidden"))break}else if(f){if(!i[cl])switch(o){case"meta":if(!i.hasAttribute("itemprop"))break;return i;case"link":if(S=i.getAttribute("rel"),S==="stylesheet"&&i.hasAttribute("data-precedence"))break;if(S!==g.rel||i.getAttribute("href")!==(g.href==null||g.href===""?null:g.href)||i.getAttribute("crossorigin")!==(g.crossOrigin==null?null:g.crossOrigin)||i.getAttribute("title")!==(g.title==null?null:g.title))break;return i;case"style":if(i.hasAttribute("data-precedence"))break;return i;case"script":if(S=i.getAttribute("src"),(S!==(g.src==null?null:g.src)||i.getAttribute("type")!==(g.type==null?null:g.type)||i.getAttribute("crossorigin")!==(g.crossOrigin==null?null:g.crossOrigin))&&S&&i.hasAttribute("async")&&!i.hasAttribute("itemprop"))break;return i;default:return i}}else if(o==="input"&&i.type==="hidden"){var S=g.name==null?null:""+g.name;if(g.type==="hidden"&&i.getAttribute("name")===S)return i}else return i;if(i=An(i.nextSibling),i===null)break}return null}function mO(i,o,u){if(o==="")return null;for(;i.nodeType!==3;)if((i.nodeType!==1||i.nodeName!=="INPUT"||i.type!=="hidden")&&!u||(i=An(i.nextSibling),i===null))return null;return i}function b_(i,o){for(;i.nodeType!==8;)if((i.nodeType!==1||i.nodeName!=="INPUT"||i.type!=="hidden")&&!o||(i=An(i.nextSibling),i===null))return null;return i}function Zv(i){return i.data==="$?"||i.data==="$~"}function eg(i){return i.data==="$!"||i.data==="$?"&&i.ownerDocument.readyState!=="loading"}function yO(i,o){var u=i.ownerDocument;if(i.data==="$~")i._reactRetry=o;else if(i.data!=="$?"||u.readyState!=="loading")o();else{var f=function(){o(),u.removeEventListener("DOMContentLoaded",f)};u.addEventListener("DOMContentLoaded",f),i._reactRetry=f}}function An(i){for(;i!=null;i=i.nextSibling){var o=i.nodeType;if(o===1||o===3)break;if(o===8){if(o=i.data,o==="$"||o==="$!"||o==="$?"||o==="$~"||o==="&"||o==="F!"||o==="F")break;if(o==="/$"||o==="/&")return null}}return i}var tg=null;function __(i){i=i.nextSibling;for(var o=0;i;){if(i.nodeType===8){var u=i.data;if(u==="/$"||u==="/&"){if(o===0)return An(i.nextSibling);o--}else u!=="$"&&u!=="$!"&&u!=="$?"&&u!=="$~"&&u!=="&"||o++}i=i.nextSibling}return null}function E_(i){i=i.previousSibling;for(var o=0;i;){if(i.nodeType===8){var u=i.data;if(u==="$"||u==="$!"||u==="$?"||u==="$~"||u==="&"){if(o===0)return i;o--}else u!=="/$"&&u!=="/&"||o++}i=i.previousSibling}return null}function T_(i,o,u){switch(o=bd(u),i){case"html":if(i=o.documentElement,!i)throw Error(r(452));return i;case"head":if(i=o.head,!i)throw Error(r(453));return i;case"body":if(i=o.body,!i)throw Error(r(454));return i;default:throw Error(r(451))}}function zl(i){for(var o=i.attributes;o.length;)i.removeAttributeNode(o[0]);nh(i)}var Dn=new Map,w_=new Set;function _d(i){return typeof i.getRootNode=="function"?i.getRootNode():i.nodeType===9?i:i.ownerDocument}var Ni=te.d;te.d={f:SO,r:bO,D:_O,C:EO,L:TO,m:wO,X:CO,S:RO,M:IO};function SO(){var i=Ni.f(),o=fd();return i||o}function bO(i){var o=js(i);o!==null&&o.tag===5&&o.type==="form"?FS(o):Ni.r(i)}var So=typeof document>"u"?null:document;function R_(i,o,u){var f=So;if(f&&typeof o=="string"&&o){var g=Tn(o);g='link[rel="'+i+'"][href="'+g+'"]',typeof u=="string"&&(g+='[crossorigin="'+u+'"]'),w_.has(g)||(w_.add(g),i={rel:i,crossOrigin:u,href:o},f.querySelector(g)===null&&(o=f.createElement("link"),Cr(o,"link",i),vr(o),f.head.appendChild(o)))}}function _O(i){Ni.D(i),R_("dns-prefetch",i,null)}function EO(i,o){Ni.C(i,o),R_("preconnect",i,o)}function TO(i,o,u){Ni.L(i,o,u);var f=So;if(f&&i&&o){var g='link[rel="preload"][as="'+Tn(o)+'"]';o==="image"&&u&&u.imageSrcSet?(g+='[imagesrcset="'+Tn(u.imageSrcSet)+'"]',typeof u.imageSizes=="string"&&(g+='[imagesizes="'+Tn(u.imageSizes)+'"]')):g+='[href="'+Tn(i)+'"]';var S=g;switch(o){case"style":S=bo(i);break;case"script":S=_o(i)}Dn.has(S)||(i=p({rel:"preload",href:o==="image"&&u&&u.imageSrcSet?void 0:i,as:o},u),Dn.set(S,i),f.querySelector(g)!==null||o==="style"&&f.querySelector(Wl(S))||o==="script"&&f.querySelector(Yl(S))||(o=f.createElement("link"),Cr(o,"link",i),vr(o),f.head.appendChild(o)))}}function wO(i,o){Ni.m(i,o);var u=So;if(u&&i){var f=o&&typeof o.as=="string"?o.as:"script",g='link[rel="modulepreload"][as="'+Tn(f)+'"][href="'+Tn(i)+'"]',S=g;switch(f){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":S=_o(i)}if(!Dn.has(S)&&(i=p({rel:"modulepreload",href:i},o),Dn.set(S,i),u.querySelector(g)===null)){switch(f){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(u.querySelector(Yl(S)))return}f=u.createElement("link"),Cr(f,"link",i),vr(f),u.head.appendChild(f)}}}function RO(i,o,u){Ni.S(i,o,u);var f=So;if(f&&i){var g=Fs(f).hoistableStyles,S=bo(i);o=o||"default";var k=g.get(S);if(!k){var L={loading:0,preload:null};if(k=f.querySelector(Wl(S)))L.loading=5;else{i=p({rel:"stylesheet",href:i,"data-precedence":o},u),(u=Dn.get(S))&&rg(i,u);var H=k=f.createElement("link");vr(H),Cr(H,"link",i),H._p=new Promise(function(ae,me){H.onload=ae,H.onerror=me}),H.addEventListener("load",function(){L.loading|=1}),H.addEventListener("error",function(){L.loading|=2}),L.loading|=4,Ed(k,o,f)}k={type:"stylesheet",instance:k,count:1,state:L},g.set(S,k)}}}function CO(i,o){Ni.X(i,o);var u=So;if(u&&i){var f=Fs(u).hoistableScripts,g=_o(i),S=f.get(g);S||(S=u.querySelector(Yl(g)),S||(i=p({src:i,async:!0},o),(o=Dn.get(g))&&ng(i,o),S=u.createElement("script"),vr(S),Cr(S,"link",i),u.head.appendChild(S)),S={type:"script",instance:S,count:1,state:null},f.set(g,S))}}function IO(i,o){Ni.M(i,o);var u=So;if(u&&i){var f=Fs(u).hoistableScripts,g=_o(i),S=f.get(g);S||(S=u.querySelector(Yl(g)),S||(i=p({src:i,async:!0,type:"module"},o),(o=Dn.get(g))&&ng(i,o),S=u.createElement("script"),vr(S),Cr(S,"link",i),u.head.appendChild(S)),S={type:"script",instance:S,count:1,state:null},f.set(g,S))}}function C_(i,o,u,f){var g=(g=G.current)?_d(g):null;if(!g)throw Error(r(446));switch(i){case"meta":case"title":return null;case"style":return typeof u.precedence=="string"&&typeof u.href=="string"?(o=bo(u.href),u=Fs(g).hoistableStyles,f=u.get(o),f||(f={type:"style",instance:null,count:0,state:null},u.set(o,f)),f):{type:"void",instance:null,count:0,state:null};case"link":if(u.rel==="stylesheet"&&typeof u.href=="string"&&typeof u.precedence=="string"){i=bo(u.href);var S=Fs(g).hoistableStyles,k=S.get(i);if(k||(g=g.ownerDocument||g,k={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},S.set(i,k),(S=g.querySelector(Wl(i)))&&!S._p&&(k.instance=S,k.state.loading=5),Dn.has(i)||(u={rel:"preload",as:"style",href:u.href,crossOrigin:u.crossOrigin,integrity:u.integrity,media:u.media,hrefLang:u.hrefLang,referrerPolicy:u.referrerPolicy},Dn.set(i,u),S||OO(g,i,u,k.state))),o&&f===null)throw Error(r(528,""));return k}if(o&&f!==null)throw Error(r(529,""));return null;case"script":return o=u.async,u=u.src,typeof u=="string"&&o&&typeof o!="function"&&typeof o!="symbol"?(o=_o(u),u=Fs(g).hoistableScripts,f=u.get(o),f||(f={type:"script",instance:null,count:0,state:null},u.set(o,f)),f):{type:"void",instance:null,count:0,state:null};default:throw Error(r(444,i))}}function bo(i){return'href="'+Tn(i)+'"'}function Wl(i){return'link[rel="stylesheet"]['+i+"]"}function I_(i){return p({},i,{"data-precedence":i.precedence,precedence:null})}function OO(i,o,u,f){i.querySelector('link[rel="preload"][as="style"]['+o+"]")?f.loading=1:(o=i.createElement("link"),f.preload=o,o.addEventListener("load",function(){return f.loading|=1}),o.addEventListener("error",function(){return f.loading|=2}),Cr(o,"link",u),vr(o),i.head.appendChild(o))}function _o(i){return'[src="'+Tn(i)+'"]'}function Yl(i){return"script[async]"+i}function O_(i,o,u){if(o.count++,o.instance===null)switch(o.type){case"style":var f=i.querySelector('style[data-href~="'+Tn(u.href)+'"]');if(f)return o.instance=f,vr(f),f;var g=p({},u,{"data-href":u.href,"data-precedence":u.precedence,href:null,precedence:null});return f=(i.ownerDocument||i).createElement("style"),vr(f),Cr(f,"style",g),Ed(f,u.precedence,i),o.instance=f;case"stylesheet":g=bo(u.href);var S=i.querySelector(Wl(g));if(S)return o.state.loading|=4,o.instance=S,vr(S),S;f=I_(u),(g=Dn.get(g))&&rg(f,g),S=(i.ownerDocument||i).createElement("link"),vr(S);var k=S;return k._p=new Promise(function(L,H){k.onload=L,k.onerror=H}),Cr(S,"link",f),o.state.loading|=4,Ed(S,u.precedence,i),o.instance=S;case"script":return S=_o(u.src),(g=i.querySelector(Yl(S)))?(o.instance=g,vr(g),g):(f=u,(g=Dn.get(S))&&(f=p({},u),ng(f,g)),i=i.ownerDocument||i,g=i.createElement("script"),vr(g),Cr(g,"link",f),i.head.appendChild(g),o.instance=g);case"void":return null;default:throw Error(r(443,o.type))}else o.type==="stylesheet"&&(o.state.loading&4)===0&&(f=o.instance,o.state.loading|=4,Ed(f,u.precedence,i));return o.instance}function Ed(i,o,u){for(var f=u.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),g=f.length?f[f.length-1]:null,S=g,k=0;k<f.length;k++){var L=f[k];if(L.dataset.precedence===o)S=L;else if(S!==g)break}S?S.parentNode.insertBefore(i,S.nextSibling):(o=u.nodeType===9?u.head:u,o.insertBefore(i,o.firstChild))}function rg(i,o){i.crossOrigin==null&&(i.crossOrigin=o.crossOrigin),i.referrerPolicy==null&&(i.referrerPolicy=o.referrerPolicy),i.title==null&&(i.title=o.title)}function ng(i,o){i.crossOrigin==null&&(i.crossOrigin=o.crossOrigin),i.referrerPolicy==null&&(i.referrerPolicy=o.referrerPolicy),i.integrity==null&&(i.integrity=o.integrity)}var Td=null;function k_(i,o,u){if(Td===null){var f=new Map,g=Td=new Map;g.set(u,f)}else g=Td,f=g.get(u),f||(f=new Map,g.set(u,f));if(f.has(i))return f;for(f.set(i,null),u=u.getElementsByTagName(i),g=0;g<u.length;g++){var S=u[g];if(!(S[cl]||S[Er]||i==="link"&&S.getAttribute("rel")==="stylesheet")&&S.namespaceURI!=="http://www.w3.org/2000/svg"){var k=S.getAttribute(o)||"";k=i+k;var L=f.get(k);L?L.push(S):f.set(k,[S])}}return f}function A_(i,o,u){i=i.ownerDocument||i,i.head.insertBefore(u,o==="title"?i.querySelector("head > title"):null)}function kO(i,o,u){if(u===1||o.itemProp!=null)return!1;switch(i){case"meta":case"title":return!0;case"style":if(typeof o.precedence!="string"||typeof o.href!="string"||o.href==="")break;return!0;case"link":if(typeof o.rel!="string"||typeof o.href!="string"||o.href===""||o.onLoad||o.onError)break;switch(o.rel){case"stylesheet":return i=o.disabled,typeof o.precedence=="string"&&i==null;default:return!0}case"script":if(o.async&&typeof o.async!="function"&&typeof o.async!="symbol"&&!o.onLoad&&!o.onError&&o.src&&typeof o.src=="string")return!0}return!1}function D_(i){return!(i.type==="stylesheet"&&(i.state.loading&3)===0)}function AO(i,o,u,f){if(u.type==="stylesheet"&&(typeof f.media!="string"||matchMedia(f.media).matches!==!1)&&(u.state.loading&4)===0){if(u.instance===null){var g=bo(f.href),S=o.querySelector(Wl(g));if(S){o=S._p,o!==null&&typeof o=="object"&&typeof o.then=="function"&&(i.count++,i=wd.bind(i),o.then(i,i)),u.state.loading|=4,u.instance=S,vr(S);return}S=o.ownerDocument||o,f=I_(f),(g=Dn.get(g))&&rg(f,g),S=S.createElement("link"),vr(S);var k=S;k._p=new Promise(function(L,H){k.onload=L,k.onerror=H}),Cr(S,"link",f),u.instance=S}i.stylesheets===null&&(i.stylesheets=new Map),i.stylesheets.set(u,o),(o=u.state.preload)&&(u.state.loading&3)===0&&(i.count++,u=wd.bind(i),o.addEventListener("load",u),o.addEventListener("error",u))}}var ig=0;function DO(i,o){return i.stylesheets&&i.count===0&&Cd(i,i.stylesheets),0<i.count||0<i.imgCount?function(u){var f=setTimeout(function(){if(i.stylesheets&&Cd(i,i.stylesheets),i.unsuspend){var S=i.unsuspend;i.unsuspend=null,S()}},6e4+o);0<i.imgBytes&&ig===0&&(ig=62500*dO());var g=setTimeout(function(){if(i.waitingForImages=!1,i.count===0&&(i.stylesheets&&Cd(i,i.stylesheets),i.unsuspend)){var S=i.unsuspend;i.unsuspend=null,S()}},(i.imgBytes>ig?50:800)+o);return i.unsuspend=u,function(){i.unsuspend=null,clearTimeout(f),clearTimeout(g)}}:null}function wd(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)Cd(this,this.stylesheets);else if(this.unsuspend){var i=this.unsuspend;this.unsuspend=null,i()}}}var Rd=null;function Cd(i,o){i.stylesheets=null,i.unsuspend!==null&&(i.count++,Rd=new Map,o.forEach(MO,i),Rd=null,wd.call(i))}function MO(i,o){if(!(o.state.loading&4)){var u=Rd.get(i);if(u)var f=u.get(null);else{u=new Map,Rd.set(i,u);for(var g=i.querySelectorAll("link[data-precedence],style[data-precedence]"),S=0;S<g.length;S++){var k=g[S];(k.nodeName==="LINK"||k.getAttribute("media")!=="not all")&&(u.set(k.dataset.precedence,k),f=k)}f&&u.set(null,f)}g=o.instance,k=g.getAttribute("data-precedence"),S=u.get(k)||f,S===f&&u.set(null,g),u.set(k,g),this.count++,f=wd.bind(this),g.addEventListener("load",f),g.addEventListener("error",f),S?S.parentNode.insertBefore(g,S.nextSibling):(i=i.nodeType===9?i.head:i,i.insertBefore(g,i.firstChild)),o.state.loading|=4}}var Jl={$$typeof:U,Provider:null,Consumer:null,_currentValue:he,_currentValue2:he,_threadCount:0};function NO(i,o,u,f,g,S,k,L,H){this.tag=1,this.containerInfo=i,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Zf(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Zf(0),this.hiddenUpdates=Zf(null),this.identifierPrefix=f,this.onUncaughtError=g,this.onCaughtError=S,this.onRecoverableError=k,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=H,this.incompleteTransitions=new Map}function M_(i,o,u,f,g,S,k,L,H,ae,me,Se){return i=new NO(i,o,u,k,H,ae,me,Se,L),o=1,S===!0&&(o|=24),S=sn(3,null,null,o),i.current=S,S.stateNode=i,o=xh(),o.refCount++,i.pooledCache=o,o.refCount++,S.memoizedState={element:f,isDehydrated:u,cache:o},Fh(S),i}function N_(i){return i?(i=Xs,i):Xs}function U_(i,o,u,f,g,S){g=N_(g),f.context===null?f.context=g:f.pendingContext=g,f=aa(o),f.payload={element:u},S=S===void 0?null:S,S!==null&&(f.callback=S),u=sa(i,f,o),u!==null&&(Qr(u,i,o),Il(u,i,o))}function P_(i,o){if(i=i.memoizedState,i!==null&&i.dehydrated!==null){var u=i.retryLane;i.retryLane=u!==0&&u<o?u:o}}function ag(i,o){P_(i,o),(i=i.alternate)&&P_(i,o)}function L_(i){if(i.tag===13||i.tag===31){var o=Ya(i,67108864);o!==null&&Qr(o,i,67108864),ag(i,67108864)}}function x_(i){if(i.tag===13||i.tag===31){var o=dn();o=eh(o);var u=Ya(i,o);u!==null&&Qr(u,i,o),ag(i,o)}}var Id=!0;function UO(i,o,u,f){var g=B.T;B.T=null;var S=te.p;try{te.p=2,sg(i,o,u,f)}finally{te.p=S,B.T=g}}function PO(i,o,u,f){var g=B.T;B.T=null;var S=te.p;try{te.p=8,sg(i,o,u,f)}finally{te.p=S,B.T=g}}function sg(i,o,u,f){if(Id){var g=og(f);if(g===null)zv(i,o,f,Od,u),K_(i,f);else if(xO(g,i,o,u,f))f.stopPropagation();else if(K_(i,f),o&4&&-1<LO.indexOf(i)){for(;g!==null;){var S=js(g);if(S!==null)switch(S.tag){case 3:if(S=S.stateNode,S.current.memoizedState.isDehydrated){var k=Vt(S.pendingLanes);if(k!==0){var L=S;for(L.pendingLanes|=2,L.entangledLanes|=2;k;){var H=1<<31-ge(k);L.entanglements[1]|=H,k&=~H}ri(S),(yt&6)===0&&(cd=Ge()+500,Vl(0))}}break;case 31:case 13:L=Ya(S,2),L!==null&&Qr(L,S,2),fd(),ag(S,2)}if(S=og(f),S===null&&zv(i,o,f,Od,u),S===g)break;g=S}g!==null&&f.stopPropagation()}else zv(i,o,f,null,u)}}function og(i){return i=uh(i),lg(i)}var Od=null;function lg(i){if(Od=null,i=Ks(i),i!==null){var o=s(i);if(o===null)i=null;else{var u=o.tag;if(u===13){if(i=l(o),i!==null)return i;i=null}else if(u===31){if(i=c(o),i!==null)return i;i=null}else if(u===3){if(o.stateNode.current.memoizedState.isDehydrated)return o.tag===3?o.stateNode.containerInfo:null;i=null}else o!==i&&(i=null)}}return Od=i,null}function B_(i){switch(i){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(Pn()){case _n:return 2;case Kt:return 8;case Vr:case gi:return 32;case $n:return 268435456;default:return 32}default:return 32}}var ug=!1,ma=null,ya=null,Sa=null,Ql=new Map,Xl=new Map,ba=[],LO="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function K_(i,o){switch(i){case"focusin":case"focusout":ma=null;break;case"dragenter":case"dragleave":ya=null;break;case"mouseover":case"mouseout":Sa=null;break;case"pointerover":case"pointerout":Ql.delete(o.pointerId);break;case"gotpointercapture":case"lostpointercapture":Xl.delete(o.pointerId)}}function $l(i,o,u,f,g,S){return i===null||i.nativeEvent!==S?(i={blockedOn:o,domEventName:u,eventSystemFlags:f,nativeEvent:S,targetContainers:[g]},o!==null&&(o=js(o),o!==null&&L_(o)),i):(i.eventSystemFlags|=f,o=i.targetContainers,g!==null&&o.indexOf(g)===-1&&o.push(g),i)}function xO(i,o,u,f,g){switch(o){case"focusin":return ma=$l(ma,i,o,u,f,g),!0;case"dragenter":return ya=$l(ya,i,o,u,f,g),!0;case"mouseover":return Sa=$l(Sa,i,o,u,f,g),!0;case"pointerover":var S=g.pointerId;return Ql.set(S,$l(Ql.get(S)||null,i,o,u,f,g)),!0;case"gotpointercapture":return S=g.pointerId,Xl.set(S,$l(Xl.get(S)||null,i,o,u,f,g)),!0}return!1}function j_(i){var o=Ks(i.target);if(o!==null){var u=s(o);if(u!==null){if(o=u.tag,o===13){if(o=l(u),o!==null){i.blockedOn=o,ey(i.priority,function(){x_(u)});return}}else if(o===31){if(o=c(u),o!==null){i.blockedOn=o,ey(i.priority,function(){x_(u)});return}}else if(o===3&&u.stateNode.current.memoizedState.isDehydrated){i.blockedOn=u.tag===3?u.stateNode.containerInfo:null;return}}}i.blockedOn=null}function kd(i){if(i.blockedOn!==null)return!1;for(var o=i.targetContainers;0<o.length;){var u=og(i.nativeEvent);if(u===null){u=i.nativeEvent;var f=new u.constructor(u.type,u);lh=f,u.target.dispatchEvent(f),lh=null}else return o=js(u),o!==null&&L_(o),i.blockedOn=u,!1;o.shift()}return!0}function F_(i,o,u){kd(i)&&u.delete(o)}function BO(){ug=!1,ma!==null&&kd(ma)&&(ma=null),ya!==null&&kd(ya)&&(ya=null),Sa!==null&&kd(Sa)&&(Sa=null),Ql.forEach(F_),Xl.forEach(F_)}function Ad(i,o){i.blockedOn===o&&(i.blockedOn=null,ug||(ug=!0,a.unstable_scheduleCallback(a.unstable_NormalPriority,BO)))}var Dd=null;function q_(i){Dd!==i&&(Dd=i,a.unstable_scheduleCallback(a.unstable_NormalPriority,function(){Dd===i&&(Dd=null);for(var o=0;o<i.length;o+=3){var u=i[o],f=i[o+1],g=i[o+2];if(typeof f!="function"){if(lg(f||u)===null)continue;break}var S=js(u);S!==null&&(i.splice(o,3),o-=3,ov(S,{pending:!0,data:g,method:u.method,action:f},f,g))}}))}function Eo(i){function o(H){return Ad(H,i)}ma!==null&&Ad(ma,i),ya!==null&&Ad(ya,i),Sa!==null&&Ad(Sa,i),Ql.forEach(o),Xl.forEach(o);for(var u=0;u<ba.length;u++){var f=ba[u];f.blockedOn===i&&(f.blockedOn=null)}for(;0<ba.length&&(u=ba[0],u.blockedOn===null);)j_(u),u.blockedOn===null&&ba.shift();if(u=(i.ownerDocument||i).$$reactFormReplay,u!=null)for(f=0;f<u.length;f+=3){var g=u[f],S=u[f+1],k=g[Gr]||null;if(typeof S=="function")k||q_(u);else if(k){var L=null;if(S&&S.hasAttribute("formAction")){if(g=S,k=S[Gr]||null)L=k.formAction;else if(lg(g)!==null)continue}else L=k.action;typeof L=="function"?u[f+1]=L:(u.splice(f,3),f-=3),q_(u)}}}function V_(){function i(S){S.canIntercept&&S.info==="react-transition"&&S.intercept({handler:function(){return new Promise(function(k){return g=k})},focusReset:"manual",scroll:"manual"})}function o(){g!==null&&(g(),g=null),f||setTimeout(u,20)}function u(){if(!f&&!navigation.transition){var S=navigation.currentEntry;S&&S.url!=null&&navigation.navigate(S.url,{state:S.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var f=!1,g=null;return navigation.addEventListener("navigate",i),navigation.addEventListener("navigatesuccess",o),navigation.addEventListener("navigateerror",o),setTimeout(u,100),function(){f=!0,navigation.removeEventListener("navigate",i),navigation.removeEventListener("navigatesuccess",o),navigation.removeEventListener("navigateerror",o),g!==null&&(g(),g=null)}}}function cg(i){this._internalRoot=i}Md.prototype.render=cg.prototype.render=function(i){var o=this._internalRoot;if(o===null)throw Error(r(409));var u=o.current,f=dn();U_(u,f,i,o,null,null)},Md.prototype.unmount=cg.prototype.unmount=function(){var i=this._internalRoot;if(i!==null){this._internalRoot=null;var o=i.containerInfo;U_(i.current,2,null,i,null,null),fd(),o[Bs]=null}};function Md(i){this._internalRoot=i}Md.prototype.unstable_scheduleHydration=function(i){if(i){var o=Zm();i={blockedOn:null,target:i,priority:o};for(var u=0;u<ba.length&&o!==0&&o<ba[u].priority;u++);ba.splice(u,0,i),u===0&&j_(i)}};var G_=e.version;if(G_!=="19.2.4")throw Error(r(527,G_,"19.2.4"));te.findDOMNode=function(i){var o=i._reactInternals;if(o===void 0)throw typeof i.render=="function"?Error(r(188)):(i=Object.keys(i).join(","),Error(r(268,i)));return i=h(o),i=i!==null?v(i):null,i=i===null?null:i.stateNode,i};var KO={bundleType:0,version:"19.2.4",rendererPackageName:"react-dom",currentDispatcherRef:B,reconcilerVersion:"19.2.4"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Nd=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Nd.isDisabled&&Nd.supportsFiber)try{Te=Nd.inject(KO),ne=Nd}catch{}}return eu.createRoot=function(i,o){if(!n(i))throw Error(r(299));var u=!1,f="",g=XS,S=$S,k=ZS;return o!=null&&(o.unstable_strictMode===!0&&(u=!0),o.identifierPrefix!==void 0&&(f=o.identifierPrefix),o.onUncaughtError!==void 0&&(g=o.onUncaughtError),o.onCaughtError!==void 0&&(S=o.onCaughtError),o.onRecoverableError!==void 0&&(k=o.onRecoverableError)),o=M_(i,1,!1,null,null,u,f,null,g,S,k,V_),i[Bs]=o.current,Hv(i),new cg(o)},eu.hydrateRoot=function(i,o,u){if(!n(i))throw Error(r(299));var f=!1,g="",S=XS,k=$S,L=ZS,H=null;return u!=null&&(u.unstable_strictMode===!0&&(f=!0),u.identifierPrefix!==void 0&&(g=u.identifierPrefix),u.onUncaughtError!==void 0&&(S=u.onUncaughtError),u.onCaughtError!==void 0&&(k=u.onCaughtError),u.onRecoverableError!==void 0&&(L=u.onRecoverableError),u.formState!==void 0&&(H=u.formState)),o=M_(i,1,!0,o,u??null,f,g,H,S,k,L,V_),o.context=N_(null),u=o.current,f=dn(),f=eh(f),g=aa(f),g.callback=null,sa(u,g,f),u=f,o.current.lanes=u,ul(o,u),ri(o),i[Bs]=o.current,Hv(i),new Md(o)},eu.version="19.2.4",eu}var eE;function JO(){if(eE)return hg.exports;eE=1;function a(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(a)}catch(e){console.error(e)}}return a(),hg.exports=YO(),hg.exports}var QO=JO();function tE(a,e,t,r,n,s,l){try{var c=a[s](l),d=c.value}catch(h){return void t(h)}c.done?e(d):Promise.resolve(d).then(r,n)}function R(a){return function(){var e=this,t=arguments;return new Promise(function(r,n){var s=a.apply(e,t);function l(d){tE(s,r,n,l,c,"next",d)}function c(d){tE(s,r,n,l,c,"throw",d)}l(void 0)})}}function Zu(a){"@babel/helpers - typeof";return Zu=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Zu(a)}function XO(a,e){if(Zu(a)!="object"||!a)return a;var t=a[Symbol.toPrimitive];if(t!==void 0){var r=t.call(a,e);if(Zu(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(a)}function $O(a){var e=XO(a,"string");return Zu(e)=="symbol"?e:e+""}function y(a,e,t){return(e=$O(e))in a?Object.defineProperty(a,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):a[e]=t,a}var nf={exports:{}},ZO=nf.exports,rE;function ek(){return rE||(rE=1,(function(a){(function(e,t){a.exports?a.exports=t():e.log=t()})(ZO,function(){var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],s={},l=null;function c(E,M){var O=E[M];if(typeof O.bind=="function")return O.bind(E);try{return Function.prototype.bind.call(O,E)}catch{return function(){return Function.prototype.apply.apply(O,[E,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function h(E){return E==="debug"&&(E="log"),typeof console===t?!1:E==="trace"&&r?d:console[E]!==void 0?c(console,E):console.log!==void 0?c(console,"log"):e}function v(){for(var E=this.getLevel(),M=0;M<n.length;M++){var O=n[M];this[O]=M<E?e:this.methodFactory(O,E,this.name)}if(this.log=this.debug,typeof console===t&&E<this.levels.SILENT)return"No console available for logging"}function p(E){return function(){typeof console!==t&&(v.call(this),this[E].apply(this,arguments))}}function m(E,M,O){return h(E)||p.apply(this,arguments)}function _(E,M){var O=this,C,U,I,D="loglevel";typeof E=="string"?D+=":"+E:typeof E=="symbol"&&(D=void 0);function w(de){var _e=(n[de]||"silent").toUpperCase();if(!(typeof window===t||!D)){try{window.localStorage[D]=_e;return}catch{}try{window.document.cookie=encodeURIComponent(D)+"="+_e+";"}catch{}}}function N(){var de;if(!(typeof window===t||!D)){try{de=window.localStorage[D]}catch{}if(typeof de===t)try{var _e=window.document.cookie,le=encodeURIComponent(D),Ce=_e.indexOf(le+"=");Ce!==-1&&(de=/^([^;]+)/.exec(_e.slice(Ce+le.length+1))[1])}catch{}return O.levels[de]===void 0&&(de=void 0),de}}function A(){if(!(typeof window===t||!D)){try{window.localStorage.removeItem(D)}catch{}try{window.document.cookie=encodeURIComponent(D)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function K(de){var _e=de;if(typeof _e=="string"&&O.levels[_e.toUpperCase()]!==void 0&&(_e=O.levels[_e.toUpperCase()]),typeof _e=="number"&&_e>=0&&_e<=O.levels.SILENT)return _e;throw new TypeError("log.setLevel() called with invalid level: "+de)}O.name=E,O.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},O.methodFactory=M||m,O.getLevel=function(){return I??U??C},O.setLevel=function(de,_e){return I=K(de),_e!==!1&&w(I),v.call(O)},O.setDefaultLevel=function(de){U=K(de),N()||O.setLevel(de,!1)},O.resetLevel=function(){I=null,A(),v.call(O)},O.enableAll=function(de){O.setLevel(O.levels.TRACE,de)},O.disableAll=function(de){O.setLevel(O.levels.SILENT,de)},O.rebuild=function(){if(l!==O&&(C=K(l.getLevel())),v.call(O),l===O)for(var de in s)s[de].rebuild()},C=K(l?l.getLevel():"WARN");var z=N();z!=null&&(I=K(z)),v.call(O)}l=new _,l.getLogger=function(M){if(typeof M!="symbol"&&typeof M!="string"||M==="")throw new TypeError("You must supply a name when creating a logger.");var O=s[M];return O||(O=s[M]=new _(M,l.methodFactory)),O};var b=typeof window!==t?window.log:void 0;return l.noConflict=function(){return typeof window!==t&&window.log===l&&(window.log=b),l},l.getLoggers=function(){return s},l.default=l,l})})(nf)),nf.exports}var tk=ek();const ec=vc(tk);var rw="matrix";ec.methodFactory=function(a,e,t){return function(){for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];this.prefix&&n.unshift(this.prefix);var l=a==="error"||a==="warn"||a==="trace"||a==="info"||a==="debug";return l?console[a](...n):console.log(...n)}};function nw(a){var e=a;e.getChild=e.withPrefix=function(t){var r=this.prefix||"";return rk(r+t)}}function rk(a){var e=ec.getLogger("".concat(rw,"-").concat(a));return e.prefix!==a&&(nw(e),e.prefix=a,e.setLevel(ec.levels.DEBUG,!1)),e}var T=ec.getLogger(rw);T.setLevel(ec.levels.DEBUG,!1);nw(T);class bP{constructor(e,t){this.parent=e,y(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}}const nk="l",ik="rn",ak={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":",:":","":":","":"::=","":":","":"!",:"!","":"!","":"!!","":"!?",:"?","":"?","":"?",:"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"<","":">",:">",:">",:"4",:"b",:"b",:"d",:"J",:"L",:"P",:"U",:"V",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'",:"'",:"'",:"'",:"'","":"'",:"'","":"'","":"'",:"'",:"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''",:"''",:"''","":"'''","":"'''","":"''''",:"'B",:"'D",:"'n",:"'P",:"'T",:"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"/","":"/",:"/",:"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\",:"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<",:"<",:"<","":"<","":"<",:"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">",:">","":">",:">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2",:"2",:"2","":"2",:"2","":"2","":"","":"","":"","":"","":"","":"",:"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3",:"3",:"3","":"3","":"3",:"3",:"3","":"3","":"3","":"","":"","":"","":"",:"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4",:"4","":"4","":"","":"","":"","":"4,","":"4.",:"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5",:"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6",:"6",:"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8",:"8",:"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a",:"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a",:"a",:"a","":"a","":"a","":"a","":"a","":"a",:"a","":"",:"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A",:"A","":"A","":"A","":"A","":"A","":"A",:"A",:"A",:"A","":"A","":"A","":"A","":"a",:"",:"",:"",:"",:"","":"a/c","":"a/s","":"aa","":"AA",:"ae",:"ae",:"AE",:"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"",:"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b",:"b",:"b",:"b",:"b",:"b",:"B",:"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B",:"B","":"B","":"B","":"B","":"B","":"B",:"B",:"B",:"B","":"B","":"B","":"B","":"B",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b'",:"bl",:"","":"",:"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c",:"c","":"c",:"c","":"c","":"c","":"","":"C","":"C","":"C",:"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C",:"c",:"c",:"C",:"C",:"C'","":"c/o","":"c/u","":"	","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d",:"d",:"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D",:"D",:"D",:"D","":"D",:"d",:"d",:"d",:"d",:"D",:"D",:"D","":"d","":"",:"d",:"d'",:"d",:"dz",:"dz",:"Dz",:"DZ",:"d",:"D",:"D",:"d","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"e",:"e",:"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e",:"e",:"e","":"","":"E",:"E",:"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E",:"E","":"E","":"E","":"E","":"E",:"",:"","":"e","":"E",:"e","":"",:"",:"","":"","":"","":"",:"","":"o","":"o","":"o",:"","":"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f",:"f","":"f",:"f","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F",:"F","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F",:"f",:"F","":"f","":"FAX",:"ff",:"ffi",:"ffl",:"fi",:"fl",:"f",:"","":"","":"",:"",:"g",:"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g",:"g","":"g",:"g",:"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G",:"G",:"G","":"G","":"",:"g",:"",:"",:"",:"g",:"G",:"G'","":"","":"","":"",:"h",:"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h",:"h",:"h",:"h",:"H",:"H",:"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H",:"H",:"H","":"H","":"H","":"",:"h","":"h",:"h","":"H",:"H",:"h",:"h",:"h",:"H","":"H",:"H",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"i","":"i",:"i","":"i",:"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i",:"i",:"i",:"i",:"i",:"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i","":"i","":"i",:"i","":"i","":"","":"i",:"",:"",:"i","":"i","":"i","":"ii","":"iii",:"ij","":"iv","":"ix",:"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j",:"j",:"j",:"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J",:"J",:"J",:"J","":"J","":"j","":"J",:"J","":"",:"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k",:"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K",:"K",:"K","":"K","":"K",:"k","":"K",:"K","":"K","":"K",:"K",:"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:nk,:"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l",:"l",:"l",:"l","":"l","":"l",:"l",:"l","":"l","":"l",:"l","":"l","":"l","":"l","":"l","":"L","":"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L",:"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L",:"l",:"l",:"l",:"L",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l","":"l,","":"l.",:"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9",:"lj",:"lJ",:"Lj",:"LJ","":"ll","":"ll","":"ll",:"ll",:"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll",:"lO","":"lO.","":"lO","":"lO","":"lO",:"ls","":"lt","":"lV","":"lX",:"l",:"lz",:"l",:"l",:"l",:"l",:"l",:"l",:"lo","":"l","":"l","":"l","":"","":"","":"",:"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M",:"M",:"M",:"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n",:"n",:"n",:"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"n",:"n",:"n","":"n","":"n","":"n","":"n","":"n",:"N","":"n",:"nj",:"Nj",:"NJ","":"No","":"",:"","":"",:"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o",:"o",:"o",:"o","":"o","":"o","":"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"",:"",:"","":"o",:"",:"o","":"o",:"O","":"O",:"O",:"o","":"o",:"o",:"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"o",:"o","":"O,","":"O.",:"o'",:"O'",:"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"oe",:"OE",:"o","":"oo","":"oo","":"oo","":"OO","":"OO",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"oo",:"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P",:"P",:"P","":"P","":"P",:"p","":"p",:"p",:"P'","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q",:"q",:"q",:"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q",:"q","":"QE","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r",:"r","":"r","":"R",:"R",:"R",:"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R",:"R",:"R",:"R","":"R",:"R","":"R","":"R",:"r",:"r","":"r",:"r","":"r",:"r'","":"rn",m:ik,"":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn",:"rn","":"rn","":"Rs","":"","":"",:"","":"","":"",:"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s",:"s",:"s","":"s","":"s","":"s",:"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S",:"S",:"S",:"S",:"S","":"S","":"S","":"S","":"S",:"s","":"s","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"sss",:"st","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"t","":"T","":"T",:"",:"T",:"T","":"T",:"t",:"T","":"t",:"","":"T3",:"t","":"TEL","":"tf",:"ts",:"t","":"t",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u",:"u",:"u","":"u","":"u","":"u","":"u","":"u",:"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U",:"U",:"U","":"U",:"U","":"U","":"U","":"U",:"",:"","":"u","":"u","":"U",:"U",:"U",:"U'","":"ue","":"uo",:"",:"",:"","":"",:"",:"","":"","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v",:"v",:"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"V",:"V",:"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w",:"w","":"w",:"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W",:"W",:"W","":"W",:"w","":"w","":"W","":"w","":"",:"","":"","":"","":"x","":"x","":"x","":"x","":"x",:"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x",:"x",:"x",:"x","":"","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"x",:"X","":"X","":"xi","":"xii","":"Xl","":"Xll",:"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y","":"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y",:"y",:"y","":"y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y",:"y","":"y",:"y","":"Y","":"Y",:"Y",:"","":"","":"",:"",:"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z",:"Z",:"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z",:"z",:"z",:"Z",:"z",:"Z","":"z",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"i","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"",:"",:"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"l","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"",:"",:"'",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"l","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo o ",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"l",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"l",:"l",:"l",:"l",:"l",:"l",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"l",:"l",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"","":"",:"",:"'","":"/","":"",:"","":"","":"",:"",:"'",:"",:"",:"'",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"<",:"b",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"b",:"b",:"d",:"P",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"J",:"",:"",:"",:"",:"",:"",:"",:"J",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"",:"","":"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":""};var mg,nE;function sk(){if(nE)return mg;nE=1;var a=ak;function e(s){return s.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var t=RegExp(Object.keys(a).map(e).join("|"),"g");function r(s){return a[s]}function n(s){return s.replace(t,r)}return mg=n,mg}var ok=sk();const lk=vc(ok);var tu={exports:{}},yg={},Sg,iE;function uk(){if(iE)return Sg;iE=1;function a(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Sg=a,a.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},a.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},a.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},r),this._options.unref&&this._timer.unref(),!0},a.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},a.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},a.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},a.prototype.start=a.prototype.try,a.prototype.errors=function(){return this._errors},a.prototype.attempts=function(){return this._attempts},a.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var s=this._errors[n],l=s.message,c=(e[l]||0)+1;e[l]=c,c>=r&&(t=s,r=c)}return t},Sg}var aE;function ck(){return aE||(aE=1,(function(a){var e=uk();a.operation=function(t){var r=a.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},a.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var n in t)r[n]=t[n];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],l=0;l<r.retries;l++)s.push(this.createTimeout(l,r));return t&&t.forever&&!s.length&&s.push(this.createTimeout(l,r)),s.sort(function(c,d){return c-d}),s},a.createTimeout=function(t,r){var n=r.randomize?Math.random()+1:1,s=Math.round(n*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return s=Math.min(s,r.maxTimeout),s},a.wrap=function(t,r,n){if(r instanceof Array&&(n=r,r=null),!n){n=[];for(var s in t)typeof t[s]=="function"&&n.push(s)}for(var l=0;l<n.length;l++){var c=n[l],d=t[c];t[c]=(function(v){var p=a.operation(r),m=Array.prototype.slice.call(arguments,1),_=m.pop();m.push(function(b){p.retry(b)||(b&&(arguments[0]=p.mainError()),_.apply(this,arguments))}),p.attempt(function(){v.apply(t,m)})}).bind(t,d),t[c].options=r}}})(yg)),yg}var bg,sE;function dk(){return sE||(sE=1,bg=ck()),bg}var oE;function fk(){if(oE)return tu.exports;oE=1;const a=dk(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class t extends Error{constructor(c){super(),c instanceof Error?(this.originalError=c,{message:c}=c):(this.originalError=new Error(c),this.originalError.stack=this.stack),this.name="AbortError",this.message=c}}const r=(l,c,d)=>{const h=d.retries-(c-1);return l.attemptNumber=c,l.retriesLeft=h,l},n=l=>e.includes(l),s=(l,c)=>new Promise((d,h)=>{c={onFailedAttempt:()=>{},retries:10,...c};const v=a.operation(c);v.attempt(async p=>{try{d(await l(p))}catch(m){if(!(m instanceof Error)){h(new TypeError(`Non-error was thrown: "${m}". You should only throw errors.`));return}if(m instanceof t)v.stop(),h(m.originalError);else if(m instanceof TypeError&&!n(m.message))v.stop(),h(m);else{r(m,p,c);try{await c.onFailedAttempt(m)}catch(_){h(_);return}v.retry(m)||h(v.mainError())}}})});return tu.exports=s,tu.exports.default=s,tu.exports.AbortError=t,tu.exports}var hk=fk();const iw=vc(hk);let Pf=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e==null?void 0:e[this.name]),!t&&this.altName&&(t=e==null?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class Lf extends Pf{constructor(){super(...arguments),y(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class Wt extends Pf{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var _g={},ru={},nu={},lE;function aw(){if(lE)return nu;lE=1,Object.defineProperty(nu,"__esModule",{value:!0}),nu.NamespacedMap=void 0;function a(d,h){var v=typeof Symbol<"u"&&d[Symbol.iterator]||d["@@iterator"];if(!v){if(Array.isArray(d)||(v=e(d))||h){v&&(d=v);var p=0,m=function(){};return{s:m,n:function(){return p>=d.length?{done:!0}:{done:!1,value:d[p++]}},e:function(O){throw O},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var _=!0,b=!1,E;return{s:function(){v=v.call(d)},n:function(){var O=v.next();return _=O.done,O},e:function(O){b=!0,E=O},f:function(){try{!_&&v.return!=null&&v.return()}finally{if(b)throw E}}}}function e(d,h){if(d){if(typeof d=="string")return t(d,h);var v=Object.prototype.toString.call(d).slice(8,-1);if(v==="Object"&&d.constructor&&(v=d.constructor.name),v==="Map"||v==="Set")return Array.from(d);if(v==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(v))return t(d,h)}}function t(d,h){(h==null||h>d.length)&&(h=d.length);for(var v=0,p=new Array(h);v<h;v++)p[v]=d[v];return p}function r(d,h){if(!(d instanceof h))throw new TypeError("Cannot call a class as a function")}function n(d,h){for(var v=0;v<h.length;v++){var p=h[v];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(d,p.key,p)}}function s(d,h,v){return h&&n(d.prototype,h),Object.defineProperty(d,"prototype",{writable:!1}),d}function l(d,h,v){return h in d?Object.defineProperty(d,h,{value:v,enumerable:!0,configurable:!0,writable:!0}):d[h]=v,d}var c=(function(){function d(h){if(r(this,d),l(this,"internalMap",new Map),h){var v=a(h),p;try{for(v.s();!(p=v.n()).done;){var m=p.value;this.set(m[0],m[1])}}catch(_){v.e(_)}finally{v.f()}}}return s(d,[{key:"get",value:function(v){return v.name&&this.internalMap.has(v.name)?this.internalMap.get(v.name):v.altName&&this.internalMap.has(v.altName)?this.internalMap.get(v.altName):null}},{key:"set",value:function(v,p){v.name&&this.internalMap.set(v.name,p),v.altName&&this.internalMap.set(v.altName,p)}},{key:"has",value:function(v){return!!this.get(v)}},{key:"delete",value:function(v){v.name&&this.internalMap.delete(v.name),v.altName&&this.internalMap.delete(v.altName)}},{key:"hasNamespaced",value:function(v){return this.internalMap.has(v)}},{key:"getNamespaced",value:function(v){return this.internalMap.get(v)}}]),d})();return nu.NamespacedMap=c,nu}var iu={},uE;function rl(){if(uE)return iu;uE=1;function a(b){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(E){return typeof E}:function(E){return E&&typeof Symbol=="function"&&E.constructor===Symbol&&E!==Symbol.prototype?"symbol":typeof E},a(b)}Object.defineProperty(iu,"__esModule",{value:!0}),iu.InvalidEventError=void 0;function e(b,E,M){return Object.defineProperty(b,"prototype",{writable:!1}),b}function t(b,E){if(!(b instanceof E))throw new TypeError("Cannot call a class as a function")}function r(b,E){if(typeof E!="function"&&E!==null)throw new TypeError("Super expression must either be null or a function");b.prototype=Object.create(E&&E.prototype,{constructor:{value:b,writable:!0,configurable:!0}}),Object.defineProperty(b,"prototype",{writable:!1}),E&&p(b,E)}function n(b){var E=h();return function(){var O=m(b),C;if(E){var U=m(this).constructor;C=Reflect.construct(O,arguments,U)}else C=O.apply(this,arguments);return s(this,C)}}function s(b,E){if(E&&(a(E)==="object"||typeof E=="function"))return E;if(E!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return l(b)}function l(b){if(b===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b}function c(b){var E=typeof Map=="function"?new Map:void 0;return c=function(O){if(O===null||!v(O))return O;if(typeof O!="function")throw new TypeError("Super expression must either be null or a function");if(typeof E<"u"){if(E.has(O))return E.get(O);E.set(O,C)}function C(){return d(O,arguments,m(this).constructor)}return C.prototype=Object.create(O.prototype,{constructor:{value:C,enumerable:!1,writable:!0,configurable:!0}}),p(C,O)},c(b)}function d(b,E,M){return h()?d=Reflect.construct:d=function(C,U,I){var D=[null];D.push.apply(D,U);var w=Function.bind.apply(C,D),N=new w;return I&&p(N,I.prototype),N},d.apply(null,arguments)}function h(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function v(b){return Function.toString.call(b).indexOf("[native code]")!==-1}function p(b,E){return p=Object.setPrototypeOf||function(O,C){return O.__proto__=C,O},p(b,E)}function m(b){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(M){return M.__proto__||Object.getPrototypeOf(M)},m(b)}var _=(function(b){r(M,b);var E=n(M);function M(O){return t(this,M),E.call(this,O)}return e(M)})(c(Error));return iu.InvalidEventError=_,iu}var To={},au={},su={},cE;function gc(){if(cE)return su;cE=1,Object.defineProperty(su,"__esModule",{value:!0}),su.ExtensibleEvent=void 0;function a(n,s){if(!(n instanceof s))throw new TypeError("Cannot call a class as a function")}function e(n,s){for(var l=0;l<s.length;l++){var c=s[l];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(n,c.key,c)}}function t(n,s,l){return s&&e(n.prototype,s),Object.defineProperty(n,"prototype",{writable:!1}),n}var r=(function(){function n(s){a(this,n),this.wireFormat=s}return t(n,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),n})();return su.ExtensibleEvent=r,su}var ou={},dE;function sw(){if(dE)return ou;dE=1,Object.defineProperty(ou,"__esModule",{value:!0}),ou.isOptionalAString=a,ou.isProvided=e;function a(t){return e(t)&&typeof t=="string"}function e(t){return t!=null}return ou}var fn={},os={},fE;function nl(){if(fE)return os;fE=1;function a(_){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(b){return typeof b}:function(b){return b&&typeof Symbol=="function"&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},a(_)}Object.defineProperty(os,"__esModule",{value:!0}),os.UnstableValue=os.NamespacedValue=void 0;function e(_,b){if(typeof b!="function"&&b!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(b&&b.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),b&&t(_,b)}function t(_,b){return t=Object.setPrototypeOf||function(M,O){return M.__proto__=O,M},t(_,b)}function r(_){var b=l();return function(){var M=c(_),O;if(b){var C=c(this).constructor;O=Reflect.construct(M,arguments,C)}else O=M.apply(this,arguments);return n(this,O)}}function n(_,b){if(b&&(a(b)==="object"||typeof b=="function"))return b;if(b!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return s(_)}function s(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}function l(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function c(_){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(E){return E.__proto__||Object.getPrototypeOf(E)},c(_)}function d(_,b){if(!(_ instanceof b))throw new TypeError("Cannot call a class as a function")}function h(_,b){for(var E=0;E<b.length;E++){var M=b[E];M.enumerable=M.enumerable||!1,M.configurable=!0,"value"in M&&(M.writable=!0),Object.defineProperty(_,M.key,M)}}function v(_,b,E){return b&&h(_.prototype,b),Object.defineProperty(_,"prototype",{writable:!1}),_}var p=(function(){function _(b,E){if(d(this,_),this.stable=b,this.unstable=E,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return v(_,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(E){return!!this.name&&this.name===E||!!this.altName&&this.altName===E}},{key:"findIn",value:function(E){var M;return this.name&&(M=E==null?void 0:E[this.name]),!M&&this.altName&&(M=E==null?void 0:E[this.altName]),M}},{key:"includedIn",value:function(E){var M=!1;return this.name&&(M=E.includes(this.name)),!M&&this.altName&&(M=E.includes(this.altName)),M}}]),_})();os.NamespacedValue=p;var m=(function(_){e(E,_);var b=r(E);function E(M,O){var C;if(d(this,E),C=b.call(this,M,O),!C.unstable)throw new Error("Unstable value must be supplied");return C}return v(E,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),E})(p);return os.UnstableValue=m,os}var hE;function hi(){if(hE)return fn;hE=1,Object.defineProperty(fn,"__esModule",{value:!0}),fn.M_TEXT=fn.M_NOTICE=fn.M_MESSAGE=fn.M_HTML=fn.M_EMOTE=void 0;var a=nl(),e=new a.UnstableValue("m.message","org.matrix.msc1767.message");fn.M_MESSAGE=e;var t=new a.UnstableValue("m.text","org.matrix.msc1767.text");fn.M_TEXT=t;var r=new a.UnstableValue("m.html","org.matrix.msc1767.html");fn.M_HTML=r;var n=new a.UnstableValue("m.emote","org.matrix.msc1767.emote");fn.M_EMOTE=n;var s=new a.UnstableValue("m.notice","org.matrix.msc1767.notice");return fn.M_NOTICE=s,fn}var Pd={},vE;function Ns(){if(vE)return Pd;vE=1,Object.defineProperty(Pd,"__esModule",{value:!0}),Pd.isEventTypeSame=a;function a(e,t){if(typeof e=="string")return typeof t=="string"?t===e:t.matches(e);if(typeof t=="string")return e.matches(t);var r=t,n=e;return r.matches(n.name)||r.matches(n.altName)}return Pd}var gE;function Us(){if(gE)return au;gE=1;function a(I){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(D){return typeof D}:function(D){return D&&typeof Symbol=="function"&&D.constructor===Symbol&&D!==Symbol.prototype?"symbol":typeof D},a(I)}Object.defineProperty(au,"__esModule",{value:!0}),au.MessageEvent=void 0;var e=gc(),t=sw(),r=rl(),n=hi(),s=Ns();function l(I,D){var w=Object.keys(I);if(Object.getOwnPropertySymbols){var N=Object.getOwnPropertySymbols(I);D&&(N=N.filter(function(A){return Object.getOwnPropertyDescriptor(I,A).enumerable})),w.push.apply(w,N)}return w}function c(I){for(var D=1;D<arguments.length;D++){var w=arguments[D]!=null?arguments[D]:{};D%2?l(Object(w),!0).forEach(function(N){C(I,N,w[N])}):Object.getOwnPropertyDescriptors?Object.defineProperties(I,Object.getOwnPropertyDescriptors(w)):l(Object(w)).forEach(function(N){Object.defineProperty(I,N,Object.getOwnPropertyDescriptor(w,N))})}return I}function d(I,D){if(!(I instanceof D))throw new TypeError("Cannot call a class as a function")}function h(I,D){for(var w=0;w<D.length;w++){var N=D[w];N.enumerable=N.enumerable||!1,N.configurable=!0,"value"in N&&(N.writable=!0),Object.defineProperty(I,N.key,N)}}function v(I,D,w){return D&&h(I.prototype,D),w&&h(I,w),Object.defineProperty(I,"prototype",{writable:!1}),I}function p(I,D){if(typeof D!="function"&&D!==null)throw new TypeError("Super expression must either be null or a function");I.prototype=Object.create(D&&D.prototype,{constructor:{value:I,writable:!0,configurable:!0}}),Object.defineProperty(I,"prototype",{writable:!1}),D&&m(I,D)}function m(I,D){return m=Object.setPrototypeOf||function(N,A){return N.__proto__=A,N},m(I,D)}function _(I){var D=M();return function(){var N=O(I),A;if(D){var K=O(this).constructor;A=Reflect.construct(N,arguments,K)}else A=N.apply(this,arguments);return b(this,A)}}function b(I,D){if(D&&(a(D)==="object"||typeof D=="function"))return D;if(D!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return E(I)}function E(I){if(I===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return I}function M(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function O(I){return O=Object.setPrototypeOf?Object.getPrototypeOf:function(w){return w.__proto__||Object.getPrototypeOf(w)},O(I)}function C(I,D,w){return D in I?Object.defineProperty(I,D,{value:w,enumerable:!0,configurable:!0,writable:!0}):I[D]=w,I}var U=(function(I){p(w,I);var D=_(w);function w(N){var A;d(this,w),A=D.call(this,N),C(E(A),"text",void 0),C(E(A),"html",void 0),C(E(A),"renderings",void 0);var K=n.M_MESSAGE.findIn(A.wireContent),z=n.M_TEXT.findIn(A.wireContent),de=n.M_HTML.findIn(A.wireContent);if((0,t.isProvided)(K)){if(!Array.isArray(K))throw new r.InvalidEventError("m.message contents must be an array");var _e=K.find(function(Ce){return!(0,t.isProvided)(Ce.mimetype)||Ce.mimetype==="text/plain"}),le=K.find(function(Ce){return Ce.mimetype==="text/html"});if(!_e)throw new r.InvalidEventError("m.message is missing a plain text representation");A.text=_e.body,A.html=le==null?void 0:le.body,A.renderings=K}else if((0,t.isOptionalAString)(z))A.text=z,A.html=de,A.renderings=[{body:z,mimetype:"text/plain"}],A.html&&A.renderings.push({body:A.html,mimetype:"text/html"});else throw new r.InvalidEventError("Missing textual representation for event");return A}return v(w,[{key:"isEmote",get:function(){return n.M_EMOTE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return n.M_NOTICE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(A){return(0,s.isEventTypeSame)(A,n.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var A=C({},n.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var K=this.renderings[0].mimetype;(K===void 0||K==="text/plain")&&(A=C({},n.M_TEXT.name,this.renderings[0].body))}return A}},{key:"serialize",value:function(){var A;return{type:"m.room.message",content:c(c({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(A=this.html)!==null&&A!==void 0?A:void 0})}}}],[{key:"from",value:function(A,K){var z;return new w({type:n.M_MESSAGE.name,content:(z={},C(z,n.M_TEXT.name,A),C(z,n.M_HTML.name,K),z)})}}]),w})(e.ExtensibleEvent);return au.MessageEvent=U,au}var lu={},pE;function tm(){if(pE)return lu;pE=1;function a(C){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(U){return typeof U}:function(U){return U&&typeof Symbol=="function"&&U.constructor===Symbol&&U!==Symbol.prototype?"symbol":typeof U},a(C)}Object.defineProperty(lu,"__esModule",{value:!0}),lu.NoticeEvent=void 0;var e=Us(),t=hi(),r=Ns();function n(C,U,I){return U in C?Object.defineProperty(C,U,{value:I,enumerable:!0,configurable:!0,writable:!0}):C[U]=I,C}function s(C,U){if(!(C instanceof U))throw new TypeError("Cannot call a class as a function")}function l(C,U){for(var I=0;I<U.length;I++){var D=U[I];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(C,D.key,D)}}function c(C,U,I){return U&&l(C.prototype,U),I&&l(C,I),Object.defineProperty(C,"prototype",{writable:!1}),C}function d(){return typeof Reflect<"u"&&Reflect.get?d=Reflect.get:d=function(U,I,D){var w=h(U,I);if(w){var N=Object.getOwnPropertyDescriptor(w,I);return N.get?N.get.call(arguments.length<3?U:D):N.value}},d.apply(this,arguments)}function h(C,U){for(;!Object.prototype.hasOwnProperty.call(C,U)&&(C=M(C),C!==null););return C}function v(C,U){if(typeof U!="function"&&U!==null)throw new TypeError("Super expression must either be null or a function");C.prototype=Object.create(U&&U.prototype,{constructor:{value:C,writable:!0,configurable:!0}}),Object.defineProperty(C,"prototype",{writable:!1}),U&&p(C,U)}function p(C,U){return p=Object.setPrototypeOf||function(D,w){return D.__proto__=w,D},p(C,U)}function m(C){var U=E();return function(){var D=M(C),w;if(U){var N=M(this).constructor;w=Reflect.construct(D,arguments,N)}else w=D.apply(this,arguments);return _(this,w)}}function _(C,U){if(U&&(a(U)==="object"||typeof U=="function"))return U;if(U!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return b(C)}function b(C){if(C===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return C}function E(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function M(C){return M=Object.setPrototypeOf?Object.getPrototypeOf:function(I){return I.__proto__||Object.getPrototypeOf(I)},M(C)}var O=(function(C){v(I,C);var U=m(I);function I(D){return s(this,I),U.call(this,D)}return c(I,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(w){return(0,r.isEventTypeSame)(w,t.M_NOTICE)||d(M(I.prototype),"isEquivalentTo",this).call(this,w)}},{key:"serialize",value:function(){var w=d(M(I.prototype),"serialize",this).call(this);return w.content.msgtype="m.notice",w}}],[{key:"from",value:function(w,N){var A;return new I({type:t.M_NOTICE.name,content:(A={},n(A,t.M_TEXT.name,w),n(A,t.M_HTML.name,N),A)})}}]),I})(e.MessageEvent);return lu.NoticeEvent=O,lu}var uu={},mE;function rm(){if(mE)return uu;mE=1;function a(C){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(U){return typeof U}:function(U){return U&&typeof Symbol=="function"&&U.constructor===Symbol&&U!==Symbol.prototype?"symbol":typeof U},a(C)}Object.defineProperty(uu,"__esModule",{value:!0}),uu.EmoteEvent=void 0;var e=Us(),t=hi(),r=Ns();function n(C,U,I){return U in C?Object.defineProperty(C,U,{value:I,enumerable:!0,configurable:!0,writable:!0}):C[U]=I,C}function s(C,U){if(!(C instanceof U))throw new TypeError("Cannot call a class as a function")}function l(C,U){for(var I=0;I<U.length;I++){var D=U[I];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(C,D.key,D)}}function c(C,U,I){return U&&l(C.prototype,U),I&&l(C,I),Object.defineProperty(C,"prototype",{writable:!1}),C}function d(){return typeof Reflect<"u"&&Reflect.get?d=Reflect.get:d=function(U,I,D){var w=h(U,I);if(w){var N=Object.getOwnPropertyDescriptor(w,I);return N.get?N.get.call(arguments.length<3?U:D):N.value}},d.apply(this,arguments)}function h(C,U){for(;!Object.prototype.hasOwnProperty.call(C,U)&&(C=M(C),C!==null););return C}function v(C,U){if(typeof U!="function"&&U!==null)throw new TypeError("Super expression must either be null or a function");C.prototype=Object.create(U&&U.prototype,{constructor:{value:C,writable:!0,configurable:!0}}),Object.defineProperty(C,"prototype",{writable:!1}),U&&p(C,U)}function p(C,U){return p=Object.setPrototypeOf||function(D,w){return D.__proto__=w,D},p(C,U)}function m(C){var U=E();return function(){var D=M(C),w;if(U){var N=M(this).constructor;w=Reflect.construct(D,arguments,N)}else w=D.apply(this,arguments);return _(this,w)}}function _(C,U){if(U&&(a(U)==="object"||typeof U=="function"))return U;if(U!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return b(C)}function b(C){if(C===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return C}function E(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function M(C){return M=Object.setPrototypeOf?Object.getPrototypeOf:function(I){return I.__proto__||Object.getPrototypeOf(I)},M(C)}var O=(function(C){v(I,C);var U=m(I);function I(D){return s(this,I),U.call(this,D)}return c(I,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(w){return(0,r.isEventTypeSame)(w,t.M_EMOTE)||d(M(I.prototype),"isEquivalentTo",this).call(this,w)}},{key:"serialize",value:function(){var w=d(M(I.prototype),"serialize",this).call(this);return w.content.msgtype="m.emote",w}}],[{key:"from",value:function(w,N){var A;return new I({type:t.M_EMOTE.name,content:(A={},n(A,t.M_TEXT.name,w),n(A,t.M_HTML.name,N),A)})}}]),I})(e.MessageEvent);return uu.EmoteEvent=O,uu}var yE;function ow(){if(yE)return To;yE=1,Object.defineProperty(To,"__esModule",{value:!0}),To.LEGACY_M_ROOM_MESSAGE=void 0,To.parseMRoomMessage=h;var a=Us(),e=tm(),t=rm(),r=nl(),n=hi();function s(v,p){var m=Object.keys(v);if(Object.getOwnPropertySymbols){var _=Object.getOwnPropertySymbols(v);p&&(_=_.filter(function(b){return Object.getOwnPropertyDescriptor(v,b).enumerable})),m.push.apply(m,_)}return m}function l(v){for(var p=1;p<arguments.length;p++){var m=arguments[p]!=null?arguments[p]:{};p%2?s(Object(m),!0).forEach(function(_){c(v,_,m[_])}):Object.getOwnPropertyDescriptors?Object.defineProperties(v,Object.getOwnPropertyDescriptors(m)):s(Object(m)).forEach(function(_){Object.defineProperty(v,_,Object.getOwnPropertyDescriptor(m,_))})}return v}function c(v,p,m){return p in v?Object.defineProperty(v,p,{value:m,enumerable:!0,configurable:!0,writable:!0}):v[p]=m,v}var d=new r.NamespacedValue("m.room.message");To.LEGACY_M_ROOM_MESSAGE=d;function h(v){var p,m,_;if(n.M_MESSAGE.findIn(v.content)||n.M_TEXT.findIn(v.content))return new a.MessageEvent(v);var b=(p=v.content)===null||p===void 0?void 0:p.msgtype,E=(m=v.content)===null||m===void 0?void 0:m.body,M=((_=v.content)===null||_===void 0?void 0:_.format)==="org.matrix.custom.html"?v.content.formatted_body:null;if(b==="m.text"){var O;return new a.MessageEvent(l(l({},v),{},{content:l(l({},v.content),{},(O={},c(O,n.M_TEXT.name,E),c(O,n.M_HTML.name,M),O))}))}else if(b==="m.notice"){var C;return new e.NoticeEvent(l(l({},v),{},{content:l(l({},v.content),{},(C={},c(C,n.M_TEXT.name,E),c(C,n.M_HTML.name,M),C))}))}else if(b==="m.emote"){var U;return new t.EmoteEvent(l(l({},v),{},{content:l(l({},v.content),{},(U={},c(U,n.M_TEXT.name,E),c(U,n.M_HTML.name,M),U))}))}else return null}return To}var Ld={},SE;function lw(){if(SE)return Ld;SE=1,Object.defineProperty(Ld,"__esModule",{value:!0}),Ld.parseMMessage=n;var a=Us(),e=hi(),t=rm(),r=tm();function n(s){return e.M_EMOTE.matches(s.type)?new t.EmoteEvent(s):e.M_NOTICE.matches(s.type)?new r.NoticeEvent(s):new a.MessageEvent(s)}return Ld}var hn={},bE;function il(){if(bE)return hn;bE=1,Object.defineProperty(hn,"__esModule",{value:!0}),hn.M_POLL_START=hn.M_POLL_RESPONSE=hn.M_POLL_KIND_UNDISCLOSED=hn.M_POLL_KIND_DISCLOSED=hn.M_POLL_END=void 0;var a=nl(),e=new a.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");hn.M_POLL_KIND_DISCLOSED=e;var t=new a.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");hn.M_POLL_KIND_UNDISCLOSED=t;var r=new a.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");hn.M_POLL_START=r;var n=new a.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");hn.M_POLL_RESPONSE=n;var s=new a.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");return hn.M_POLL_END=s,hn}var xd={},ls={},_E;function uw(){if(_E)return ls;_E=1;function a(V){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(B){return typeof B}:function(B){return B&&typeof Symbol=="function"&&B.constructor===Symbol&&B!==Symbol.prototype?"symbol":typeof B},a(V)}Object.defineProperty(ls,"__esModule",{value:!0}),ls.PollStartEvent=ls.PollAnswerSubevent=void 0;var e=il(),t=Us(),r=hi(),n=rl(),s=nl(),l=Ns(),c=gc();function d(V){return m(V)||p(V)||v(V)||h()}function h(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function v(V,B){if(V){if(typeof V=="string")return _(V,B);var te=Object.prototype.toString.call(V).slice(8,-1);if(te==="Object"&&V.constructor&&(te=V.constructor.name),te==="Map"||te==="Set")return Array.from(V);if(te==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(te))return _(V,B)}}function p(V){if(typeof Symbol<"u"&&V[Symbol.iterator]!=null||V["@@iterator"]!=null)return Array.from(V)}function m(V){if(Array.isArray(V))return _(V)}function _(V,B){(B==null||B>V.length)&&(B=V.length);for(var te=0,he=new Array(B);te<B;te++)he[te]=V[te];return he}function b(V,B){var te=Object.keys(V);if(Object.getOwnPropertySymbols){var he=Object.getOwnPropertySymbols(V);B&&(he=he.filter(function(be){return Object.getOwnPropertyDescriptor(V,be).enumerable})),te.push.apply(te,he)}return te}function E(V){for(var B=1;B<arguments.length;B++){var te=arguments[B]!=null?arguments[B]:{};B%2?b(Object(te),!0).forEach(function(he){z(V,he,te[he])}):Object.getOwnPropertyDescriptors?Object.defineProperties(V,Object.getOwnPropertyDescriptors(te)):b(Object(te)).forEach(function(he){Object.defineProperty(V,he,Object.getOwnPropertyDescriptor(te,he))})}return V}function M(V,B){if(!(V instanceof B))throw new TypeError("Cannot call a class as a function")}function O(V,B){for(var te=0;te<B.length;te++){var he=B[te];he.enumerable=he.enumerable||!1,he.configurable=!0,"value"in he&&(he.writable=!0),Object.defineProperty(V,he.key,he)}}function C(V,B,te){return B&&O(V.prototype,B),te&&O(V,te),Object.defineProperty(V,"prototype",{writable:!1}),V}function U(V,B){if(typeof B!="function"&&B!==null)throw new TypeError("Super expression must either be null or a function");V.prototype=Object.create(B&&B.prototype,{constructor:{value:V,writable:!0,configurable:!0}}),Object.defineProperty(V,"prototype",{writable:!1}),B&&I(V,B)}function I(V,B){return I=Object.setPrototypeOf||function(he,be){return he.__proto__=be,he},I(V,B)}function D(V){var B=A();return function(){var he=K(V),be;if(B){var De=K(this).constructor;be=Reflect.construct(he,arguments,De)}else be=he.apply(this,arguments);return w(this,be)}}function w(V,B){if(B&&(a(B)==="object"||typeof B=="function"))return B;if(B!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return N(V)}function N(V){if(V===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return V}function A(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function K(V){return K=Object.setPrototypeOf?Object.getPrototypeOf:function(te){return te.__proto__||Object.getPrototypeOf(te)},K(V)}function z(V,B,te){return B in V?Object.defineProperty(V,B,{value:te,enumerable:!0,configurable:!0,writable:!0}):V[B]=te,V}var de=(function(V){U(te,V);var B=D(te);function te(he){var be;M(this,te),be=B.call(this,he),z(N(be),"id",void 0);var De=he.content.id;if(!De||typeof De!="string")throw new n.InvalidEventError("Answer ID must be a non-empty string");return be.id=De,be}return C(te,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:E({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(be,De){return new te({type:"org.matrix.sdk.poll.answer",content:z({id:be},r.M_TEXT.name,De)})}}]),te})(t.MessageEvent);ls.PollAnswerSubevent=de;var _e=(function(V){U(te,V);var B=D(te);function te(he){var be;M(this,te),be=B.call(this,he),z(N(be),"question",void 0),z(N(be),"kind",void 0),z(N(be),"rawKind",void 0),z(N(be),"maxSelections",void 0),z(N(be),"answers",void 0);var De=e.M_POLL_START.findIn(be.wireContent);if(!De.question)throw new n.InvalidEventError("A question is required");if(be.question=new t.MessageEvent({type:"org.matrix.sdk.poll.question",content:De.question}),be.rawKind=De.kind,e.M_POLL_KIND_DISCLOSED.matches(be.rawKind)?be.kind=e.M_POLL_KIND_DISCLOSED:be.kind=e.M_POLL_KIND_UNDISCLOSED,be.maxSelections=Number.isFinite(De.max_selections)&&De.max_selections>0?De.max_selections:1,!Array.isArray(De.answers))throw new n.InvalidEventError("Poll answers must be an array");var W=De.answers.slice(0,20).map(function(ue){return new de({type:"org.matrix.sdk.poll.answer",content:ue})});if(W.length<=0)throw new n.InvalidEventError("No answers available");return be.answers=W,be}return C(te,[{key:"isEquivalentTo",value:function(be){return(0,l.isEventTypeSame)(be,e.M_POLL_START)}},{key:"serialize",value:function(){var be;return{type:e.M_POLL_START.name,content:(be={},z(be,e.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(De){return De.serialize().content})}),z(be,r.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(De,W){return"".concat(W+1,". ").concat(De.text)}).join(`
`))),be)}}}],[{key:"from",value:function(be,De,W){var ue,we=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new te({type:e.M_POLL_START.name,content:(ue={},z(ue,r.M_TEXT.name,be),z(ue,e.M_POLL_START.name,{question:z({},r.M_TEXT.name,be),kind:W instanceof s.NamespacedValue?W.name:W,max_selections:we,answers:De.map(function(Z){return z({id:Ce()},r.M_TEXT.name,Z)})}),ue)})}}]),te})(c.ExtensibleEvent);ls.PollStartEvent=_e;var le="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Ce(){return d(Array(16)).map(function(){return le.charAt(Math.floor(Math.random()*le.length))}).join("")}return ls}var cu={},du={},EE;function nm(){if(EE)return du;EE=1,Object.defineProperty(du,"__esModule",{value:!0}),du.REFERENCE_RELATION=void 0;var a=nl(),e=new a.NamespacedValue("m.reference");return du.REFERENCE_RELATION=e,du}var TE;function cw(){if(TE)return cu;TE=1;function a(C){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(U){return typeof U}:function(U){return U&&typeof Symbol=="function"&&U.constructor===Symbol&&U!==Symbol.prototype?"symbol":typeof U},a(C)}Object.defineProperty(cu,"__esModule",{value:!0}),cu.PollResponseEvent=void 0;var e=gc(),t=il(),r=rl(),n=nm(),s=Ns();function l(C,U){if(!(C instanceof U))throw new TypeError("Cannot call a class as a function")}function c(C,U){for(var I=0;I<U.length;I++){var D=U[I];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(C,D.key,D)}}function d(C,U,I){return U&&c(C.prototype,U),I&&c(C,I),Object.defineProperty(C,"prototype",{writable:!1}),C}function h(C,U){if(typeof U!="function"&&U!==null)throw new TypeError("Super expression must either be null or a function");C.prototype=Object.create(U&&U.prototype,{constructor:{value:C,writable:!0,configurable:!0}}),Object.defineProperty(C,"prototype",{writable:!1}),U&&v(C,U)}function v(C,U){return v=Object.setPrototypeOf||function(D,w){return D.__proto__=w,D},v(C,U)}function p(C){var U=b();return function(){var D=E(C),w;if(U){var N=E(this).constructor;w=Reflect.construct(D,arguments,N)}else w=D.apply(this,arguments);return m(this,w)}}function m(C,U){if(U&&(a(U)==="object"||typeof U=="function"))return U;if(U!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return _(C)}function _(C){if(C===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return C}function b(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function E(C){return E=Object.setPrototypeOf?Object.getPrototypeOf:function(I){return I.__proto__||Object.getPrototypeOf(I)},E(C)}function M(C,U,I){return U in C?Object.defineProperty(C,U,{value:I,enumerable:!0,configurable:!0,writable:!0}):C[U]=I,C}var O=(function(C){h(I,C);var U=p(I);function I(D){var w;l(this,I),w=U.call(this,D),M(_(w),"internalAnswerIds",void 0),M(_(w),"internalSpoiled",void 0),M(_(w),"pollEventId",void 0);var N=w.wireContent["m.relates_to"];if(!n.REFERENCE_RELATION.matches(N==null?void 0:N.rel_type)||typeof(N==null?void 0:N.event_id)!="string")throw new r.InvalidEventError("Relationship must be a reference to an event");return w.pollEventId=N.event_id,w.validateAgainst(null),w}return d(I,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(w){var N=t.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(N==null?void 0:N.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var A=N.answers;if(A.some(function(K){return typeof K!="string"})||A.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(w){if(A.some(function(K){return!w.answers.some(function(z){return z.id===K})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}A=A.slice(0,w.maxSelections)}this.internalAnswerIds=A,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(w){return(0,s.isEventTypeSame)(w,t.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:t.M_POLL_RESPONSE.name,content:M({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:this.pollEventId}},t.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(w,N){return new I({type:t.M_POLL_RESPONSE.name,content:M({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:N}},t.M_POLL_RESPONSE.name,{answers:w})})}}]),I})(e.ExtensibleEvent);return cu.PollResponseEvent=O,cu}var fu={},wE;function dw(){if(wE)return fu;wE=1;function a(w){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(N){return typeof N}:function(N){return N&&typeof Symbol=="function"&&N.constructor===Symbol&&N!==Symbol.prototype?"symbol":typeof N},a(w)}Object.defineProperty(fu,"__esModule",{value:!0}),fu.PollEndEvent=void 0;var e=il(),t=rl(),r=nm(),n=Us(),s=hi(),l=Ns(),c=gc();function d(w,N){var A=Object.keys(w);if(Object.getOwnPropertySymbols){var K=Object.getOwnPropertySymbols(w);N&&(K=K.filter(function(z){return Object.getOwnPropertyDescriptor(w,z).enumerable})),A.push.apply(A,K)}return A}function h(w){for(var N=1;N<arguments.length;N++){var A=arguments[N]!=null?arguments[N]:{};N%2?d(Object(A),!0).forEach(function(K){I(w,K,A[K])}):Object.getOwnPropertyDescriptors?Object.defineProperties(w,Object.getOwnPropertyDescriptors(A)):d(Object(A)).forEach(function(K){Object.defineProperty(w,K,Object.getOwnPropertyDescriptor(A,K))})}return w}function v(w,N){if(!(w instanceof N))throw new TypeError("Cannot call a class as a function")}function p(w,N){for(var A=0;A<N.length;A++){var K=N[A];K.enumerable=K.enumerable||!1,K.configurable=!0,"value"in K&&(K.writable=!0),Object.defineProperty(w,K.key,K)}}function m(w,N,A){return N&&p(w.prototype,N),A&&p(w,A),Object.defineProperty(w,"prototype",{writable:!1}),w}function _(w,N){if(typeof N!="function"&&N!==null)throw new TypeError("Super expression must either be null or a function");w.prototype=Object.create(N&&N.prototype,{constructor:{value:w,writable:!0,configurable:!0}}),Object.defineProperty(w,"prototype",{writable:!1}),N&&b(w,N)}function b(w,N){return b=Object.setPrototypeOf||function(K,z){return K.__proto__=z,K},b(w,N)}function E(w){var N=C();return function(){var K=U(w),z;if(N){var de=U(this).constructor;z=Reflect.construct(K,arguments,de)}else z=K.apply(this,arguments);return M(this,z)}}function M(w,N){if(N&&(a(N)==="object"||typeof N=="function"))return N;if(N!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return O(w)}function O(w){if(w===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return w}function C(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function U(w){return U=Object.setPrototypeOf?Object.getPrototypeOf:function(A){return A.__proto__||Object.getPrototypeOf(A)},U(w)}function I(w,N,A){return N in w?Object.defineProperty(w,N,{value:A,enumerable:!0,configurable:!0,writable:!0}):w[N]=A,w}var D=(function(w){_(A,w);var N=E(A);function A(K){var z;v(this,A),z=N.call(this,K),I(O(z),"pollEventId",void 0),I(O(z),"closingMessage",void 0);var de=z.wireContent["m.relates_to"];if(!r.REFERENCE_RELATION.matches(de==null?void 0:de.rel_type)||typeof(de==null?void 0:de.event_id)!="string")throw new t.InvalidEventError("Relationship must be a reference to an event");return z.pollEventId=de.event_id,z.closingMessage=new n.MessageEvent(z.wireFormat),z}return m(A,[{key:"isEquivalentTo",value:function(z){return(0,l.isEventTypeSame)(z,e.M_POLL_END)}},{key:"serialize",value:function(){return{type:e.M_POLL_END.name,content:h(I({"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:this.pollEventId}},e.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(z,de){var _e;return new A({type:e.M_POLL_END.name,content:(_e={"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:z}},I(_e,e.M_POLL_END.name,{}),I(_e,s.M_TEXT.name,de),_e)})}}]),A})(c.ExtensibleEvent);return fu.PollEndEvent=D,fu}var RE;function fw(){if(RE)return xd;RE=1,Object.defineProperty(xd,"__esModule",{value:!0}),xd.parseMPoll=n;var a=il(),e=uw(),t=cw(),r=dw();function n(s){return a.M_POLL_START.matches(s.type)?new e.PollStartEvent(s):a.M_POLL_RESPONSE.matches(s.type)?new t.PollResponseEvent(s):a.M_POLL_END.matches(s.type)?new r.PollEndEvent(s):null}return xd}var CE;function vk(){if(CE)return ru;CE=1,Object.defineProperty(ru,"__esModule",{value:!0}),ru.ExtensibleEvents=void 0;var a=aw(),e=rl(),t=ow(),r=lw(),n=hi(),s=il(),l=fw();function c(E,M){var O=typeof Symbol<"u"&&E[Symbol.iterator]||E["@@iterator"];if(!O){if(Array.isArray(E)||(O=d(E))||M){O&&(E=O);var C=0,U=function(){};return{s:U,n:function(){return C>=E.length?{done:!0}:{done:!1,value:E[C++]}},e:function(A){throw A},f:U}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var I=!0,D=!1,w;return{s:function(){O=O.call(E)},n:function(){var A=O.next();return I=A.done,A},e:function(A){D=!0,w=A},f:function(){try{!I&&O.return!=null&&O.return()}finally{if(D)throw w}}}}function d(E,M){if(E){if(typeof E=="string")return h(E,M);var O=Object.prototype.toString.call(E).slice(8,-1);if(O==="Object"&&E.constructor&&(O=E.constructor.name),O==="Map"||O==="Set")return Array.from(E);if(O==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(O))return h(E,M)}}function h(E,M){(M==null||M>E.length)&&(M=E.length);for(var O=0,C=new Array(M);O<M;O++)C[O]=E[O];return C}function v(E,M){if(!(E instanceof M))throw new TypeError("Cannot call a class as a function")}function p(E,M){for(var O=0;O<M.length;O++){var C=M[O];C.enumerable=C.enumerable||!1,C.configurable=!0,"value"in C&&(C.writable=!0),Object.defineProperty(E,C.key,C)}}function m(E,M,O){return M&&p(E.prototype,M),O&&p(E,O),Object.defineProperty(E,"prototype",{writable:!1}),E}function _(E,M,O){return M in E?Object.defineProperty(E,M,{value:O,enumerable:!0,configurable:!0,writable:!0}):E[M]=O,E}var b=(function(){function E(){v(this,E),_(this,"interpreters",new a.NamespacedMap([[t.LEGACY_M_ROOM_MESSAGE,t.parseMRoomMessage],[n.M_MESSAGE,r.parseMMessage],[n.M_EMOTE,r.parseMMessage],[n.M_NOTICE,r.parseMMessage],[s.M_POLL_START,l.parseMPoll],[s.M_POLL_RESPONSE,l.parseMPoll],[s.M_POLL_END,l.parseMPoll]])),_(this,"_unknownInterpretOrder",[n.M_MESSAGE])}return m(E,[{key:"unknownInterpretOrder",get:function(){var O;return(O=this._unknownInterpretOrder)!==null&&O!==void 0?O:[]},set:function(O){this._unknownInterpretOrder=O}},{key:"registerInterpreter",value:function(O,C){this.interpreters.set(O,C)}},{key:"parse",value:function(O){try{if(this.interpreters.hasNamespaced(O.type))return this.interpreters.getNamespaced(O.type)(O);var C=c(this.unknownInterpretOrder),U;try{for(C.s();!(U=C.n()).done;){var I=U.value;if(this.interpreters.has(I)){var D=this.interpreters.get(I)(O);if(D)return D}}}catch(w){C.e(w)}finally{C.f()}return null}catch(w){if(w instanceof e.InvalidEventError)return null;throw w}}}],[{key:"defaultInstance",get:function(){return E._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return E.defaultInstance.unknownInterpretOrder},set:function(O){E.defaultInstance.unknownInterpretOrder=O}},{key:"registerInterpreter",value:function(O,C){E.defaultInstance.registerInterpreter(O,C)}},{key:"parse",value:function(O){return E.defaultInstance.parse(O)}}]),E})();return ru.ExtensibleEvents=b,_(b,"_defaultInstance",new b),ru}var Eg={},IE;function gk(){return IE||(IE=1,Object.defineProperty(Eg,"__esModule",{value:!0})),Eg}var us={},OE;function pk(){if(OE)return us;OE=1,Object.defineProperty(us,"__esModule",{value:!0}),us.LegacyMsgType=void 0,us.isEventLike=t;var a=hi(),e;us.LegacyMsgType=e,(function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"})(e||(us.LegacyMsgType=e={}));function t(r,n){var s=r.content;return n===e.Text?a.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&(s==null?void 0:s.msgtype)==="m.text":n===e.Emote?a.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&(s==null?void 0:s.msgtype)==="m.emote":n===e.Notice?a.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&(s==null?void 0:s.msgtype)==="m.notice":!1}return us}var kE;function mk(){return kE||(kE=1,(function(a){Object.defineProperty(a,"__esModule",{value:!0});var e=vk();Object.keys(e).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===e[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return e[w]}})});var t=gk();Object.keys(t).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===t[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return t[w]}})});var r=rl();Object.keys(r).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===r[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return r[w]}})});var n=nl();Object.keys(n).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===n[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return n[w]}})});var s=aw();Object.keys(s).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===s[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return s[w]}})});var l=sw();Object.keys(l).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===l[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return l[w]}})});var c=pk();Object.keys(c).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===c[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return c[w]}})});var d=Ns();Object.keys(d).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===d[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return d[w]}})});var h=ow();Object.keys(h).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===h[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return h[w]}})});var v=lw();Object.keys(v).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===v[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return v[w]}})});var p=fw();Object.keys(p).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===p[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return p[w]}})});var m=nm();Object.keys(m).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===m[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return m[w]}})});var _=gc();Object.keys(_).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===_[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return _[w]}})});var b=hi();Object.keys(b).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===b[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return b[w]}})});var E=Us();Object.keys(E).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===E[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return E[w]}})});var M=rm();Object.keys(M).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===M[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return M[w]}})});var O=tm();Object.keys(O).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===O[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return O[w]}})});var C=il();Object.keys(C).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===C[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return C[w]}})});var U=uw();Object.keys(U).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===U[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return U[w]}})});var I=cw();Object.keys(I).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===I[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return I[w]}})});var D=dw();Object.keys(D).forEach(function(w){w==="default"||w==="__esModule"||w in a&&a[w]===D[w]||Object.defineProperty(a,w,{enumerable:!0,get:function(){return D[w]}})})})(_g)),_g}var tn=mk();function im(a){return a!=null}var yk=new tn.UnstableValue("m.message","org.matrix.msc1767.message"),am=new tn.UnstableValue("m.text","org.matrix.msc1767.text"),Sk=new tn.UnstableValue("m.html","org.matrix.msc1767.html"),hw=new tn.NamespacedValue("m.reference");function bk(a,e){if(typeof a=="string")return typeof e=="string"?e===a:e.matches(a);if(typeof e=="string")return a.matches(e);var t=e,r=a;return t.matches(r.name)||im(r.altName)&&t.matches(r.altName)}var Ho=(function(a){return a.Self="m.self",a.Pin="m.pin",a})({}),pc=new Wt("m.asset","org.matrix.msc3488.asset"),Fa=new Wt("m.ts","org.matrix.msc3488.ts"),mc=new Wt("m.location","org.matrix.msc3488.location"),xr=(function(a){return a.Read="m.read",a.FullyRead="m.fully_read",a.ReadPrivate="m.read.private",a})({}),yc="main";function AE(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function DE(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?AE(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):AE(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var Tg=new Map;function wg(a){return a instanceof String&&(a=a.toString()),Tg.has(a)||Tg.set(a,a),Tg.get(a)}function Jg(a,e){var t=e??new URLSearchParams,r=function(c){s!=null&&(Array.isArray(s)?s.forEach(d=>{t.append(c,String(d))}):t.append(c,String(s)))};for(var[n,s]of Object.entries(a))r(n);return t}function ME(a,e,t){var r=DE(DE({},t),{},{[e]:t[a]});return delete r[a],r}function Ie(a,e){for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];r!=null&&(a=a.replace(t,encodeURIComponent(r)))}return a}function yf(a,e,t){var r;if(t){for(r=a.length-1;r>=0;r--)if(e(a[r],r,a))return a.splice(r,1),!0}else for(r=0;r<a.length;r++)if(e(a[r],r,a))return a.splice(r,1),!0;return!1}function vw(a,e){for(var t of e)if(!a.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function xf(a){return JSON.parse(JSON.stringify(a))}function Ms(a,e){if(a===e)return!0;if(typeof a!=typeof e)return!1;if(typeof a=="number"&&isNaN(a)&&isNaN(e))return!0;if(a===null||e===null)return a===e;if(!(a instanceof Object)||a.constructor!==e.constructor||a.prototype!==e.prototype)return!1;if(a instanceof RegExp||a instanceof Date)return a.toString()===e.toString();if(Array.isArray(a)){if(a.length!==e.length)return!1;for(var t=0;t<a.length;t++)if(!Ms(a[t],e[t]))return!1}else{for(var r in e)if(e.hasOwnProperty(r)!==a.hasOwnProperty(r))return!1;for(var n in a)if(e.hasOwnProperty(n)!==a.hasOwnProperty(n)||!Ms(a[n],e[n]))return!1}return!0}function Qg(a){if(typeof a!="object"||a==null||Array.isArray(a))return a;var e=[];for(var[t,r]of Object.entries(a))e.push([t,Qg(r)]);return e.sort((n,s)=>af(n[0],s[0])),e}function NE(a){return typeof a=="number"&&isFinite(a)}function Os(a){return typeof a=="string"?lk(a.normalize("NFD").replace(Ek,"")):""}function Xg(a){return typeof a=="string"?a.replace(/[\u202d-\u202e]/g,""):""}function _k(a){return Os(a.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var Ek=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function gw(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function pw(a){return gw(a).replace(/\\\*/g,".*").replace(/\?/g,".")}function Rg(a){return a!=null&&a.endsWith("/")?a.slice(0,-1):a}function Ba(a,e){return new Promise(t=>{setTimeout(t,a,e)})}function EP(a,e,t){return $g.apply(this,arguments)}function $g(){return $g=R(function*(a,e,t){var r=Date.now();try{return yield t()}finally{var n=Date.now();a.debug("[Perf]: ".concat(e," took ").concat(n-r,"ms"))}}),$g.apply(this,arguments)}function Tk(){return new Promise(a=>setTimeout(a))}function mw(a){return a==null}function qa(){var a,e,t=new Promise((r,n)=>{a=r,e=n});return{resolve:a,reject:e,promise:t}}function Po(a,e){return Zg.apply(this,arguments)}function Zg(){return Zg=R(function*(a,e){for(var t of a)yield e(yield t)}),Zg.apply(this,arguments)}function bs(a){return Promise.resolve(a())}function wk(a,e){return ep.apply(this,arguments)}function ep(){return ep=R(function*(a,e){for(var t=[],r=0;r<a.length;r+=e)t.push(...yield Promise.all(a.slice(r,r+e).map(n=>n())));return t}),ep.apply(this,arguments)}function Rk(a){return iw(e=>a(e),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var Ka=(()=>{for(var a="",e=32;e<=126;e++)a+=String.fromCharCode(e);return a})();function UE(a,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ka;return a.padEnd(e,t[0])}function tc(a){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ka,t=BigInt(e.length);if(a<=t){var r;return(r=e[Number(a)-1])!==null&&r!==void 0?r:""}var n=a/t,s=Number(a%t)-1;return s<0&&(n-=BigInt(Math.abs(s)),s=Number(t)-1),tc(n,e)+e[s]}function Sf(a){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ka,t=BigInt(e.length),r=BigInt(0),n=a.length-1,s=BigInt(0);n>=0;n--,s++){var l=a.charCodeAt(n)-e.charCodeAt(0);r+=BigInt(1+l)*t**s}return r}function Ck(a,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ka,r=Math.max(a.length,e.length),n=Sf(UE(a,r,t),t),s=Sf(UE(e,r,t),t),l=(n+s)/BigInt(2);return l===n||l==s?tc(l,t)+t[0]:tc(l,t)}function hu(a){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ka;return tc(Sf(a,e)+BigInt(1),e)}function PE(a){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ka;return tc(Sf(a,e)-BigInt(1),e)}function af(a,e){return a<e?-1:a>e?1:0}function yw(a,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[r,n]of Object.entries(e)){if(a[r]instanceof Object&&n){yw(a[r],n);continue}if(n!=null||!t){fi(a,r,n);continue}}return a}function LE(a){var e;return(e=Fa.findIn(a.getContent()))!==null&&e!==void 0?e:-1}function Ik(a,e){return LE(e)-LE(a)}function sm(a){return[xr.Read,xr.ReadPrivate].includes(a)}function xE(a,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(l,c)=>l===c;if(a.size!==e.size)return!1;for(var[r,n]of a){var s=e.get(r);if(s===void 0||!t(n,s))return!1}return!0}function Sw(a){return a instanceof Map?Ua(a):Array.isArray(a)?a.map(e=>Sw(e)):a}function Ua(a){var e=new Map;for(var[t,r]of a)e.set(t,Sw(r));return Object.fromEntries(e.entries())}function Vu(a){return a==="__proto__"||a==="prototype"||a==="constructor"}function fi(a,e,t){if(Vu(e))throw new Error("Trying to modify prototype or constructor");a[e]=t}function zn(a){return!(Vu(a.room_id)||Vu(a.sender)||Vu(a.event_id))}class Xt extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var tp="migrationState",zo=(function(a){return a[a.NOT_STARTED=0]="NOT_STARTED",a[a.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",a[a.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",a[a.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",a[a.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",a[a.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",a})({}),Wo=50;function BE(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Ea(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?BE(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):BE(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}function cs(a,e){return encodeURIComponent(a)+"/"+encodeURIComponent(e)}function Cg(a){var e=a.split("/"),t=decodeURIComponent(e[0]),r=decodeURIComponent(e[1]);return{senderKey:t,sessionId:r}}class Bf{constructor(){y(this,"migrationState",zo.NOT_STARTED),y(this,"outgoingRoomKeyRequests",[]),y(this,"account",null),y(this,"crossSigningKeys",null),y(this,"privateKeys",{}),y(this,"sessions",{}),y(this,"sessionProblems",{}),y(this,"notifiedErrorDevices",{}),y(this,"inboundGroupSessions",{}),y(this,"inboundGroupSessionsWithheld",{}),y(this,"deviceData",null),y(this,"rooms",{}),y(this,"sessionsNeedingBackup",{}),y(this,"sharedHistoryInboundGroupSessions",{}),y(this,"parkedSharedHistory",new Map)}containsData(){var e=this;return R(function*(){return e.account!==null})()}startup(){var e=this;return R(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return R(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return R(function*(){t.migrationState=e})()}getOrAddOutgoingRoomKeyRequest(e){var t=e.requestBody;return bs(()=>{var r=this._getOutgoingRoomKeyRequest(t);return r?(T.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),r):(T.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),this.outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(var t of this.outgoingRoomKeyRequests)if(Ms(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(var t of this.outgoingRoomKeyRequests)for(var r of e)if(t.state===r)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,r){var n=[];for(var s of this.outgoingRoomKeyRequests)for(var l of r)s.state===l&&s.recipients.some(c=>c.userId===e&&c.deviceId===t)&&n.push(s);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,r){for(var n of this.outgoingRoomKeyRequests)if(n.requestId===e)return n.state!==t?(T.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(n.state)),Promise.resolve(null)):(Object.assign(n,r),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(var r=0;r<this.outgoingRoomKeyRequests.length;r++){var n=this.outgoingRoomKeyRequests[r];if(n.requestId===e)return n.state!=t?(T.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")")),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(r,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){var n=this.privateKeys[r];t(n||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){var r=0;for(var n of Object.values(this.sessions))r+=Object.keys(n).length;t(r)}getEndToEndSession(e,t,r,n){var s=this.sessions[e]||{};n(s[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach(r=>{var[n,s]=r;Object.entries(s).forEach(l=>{var[c,d]=l;t(Ea(Ea({},d),{},{deviceKey:n,sessionId:c}))})})}storeEndToEndSession(e,t,r,n){var s=this.sessions[e];s===void 0&&(s={},this.sessions[e]=s),fi(s,t,r)}storeEndToEndSessionProblem(e,t,r){var n=this;return R(function*(){var s=n.sessionProblems[e]=n.sessionProblems[e]||[];s.push({type:t,fixed:r,time:Date.now()}),s.sort((l,c)=>l.time-c.time)})()}getEndToEndSessionProblem(e,t){var r=this;return R(function*(){var n=r.sessionProblems[e]||[];if(!n.length)return null;var s=n[n.length-1];for(var l of n)if(l.time>t)return Object.assign({},l,{fixed:s.fixed});return s.fixed?null:s})()}filterOutNotifiedErrorDevices(e){var t=this;return R(function*(){var r=t.notifiedErrorDevices,n=[];for(var s of e){var{userId:l,deviceInfo:c}=s;l in r?c.deviceId in r[l]||(n.push(s),fi(r[l],c.deviceId,!0)):(n.push(s),fi(r,l,{[c.deviceId]:!0}))}return n})()}getEndToEndSessionsBatch(){var e=this;return R(function*(){var t=[];for(var r of Object.values(e.sessions))for(var n of Object.values(r))if(t.push(n),t.length>=Wo)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){for(var{deviceKey:r,sessionId:n}of e){var s=t.sessions[r]||{};delete s[n],Object.keys(s).length===0&&delete t.sessions[r]}})()}getEndToEndInboundGroupSession(e,t,r,n){var s=cs(e,t);n(this.inboundGroupSessions[s]||null,this.inboundGroupSessionsWithheld[s]||null)}getAllEndToEndInboundGroupSessions(e,t){for(var r of Object.keys(this.inboundGroupSessions))t(Ea(Ea({},Cg(r)),{},{sessionData:this.inboundGroupSessions[r]}));t(null)}addEndToEndInboundGroupSession(e,t,r,n){var s=cs(e,t);this.inboundGroupSessions[s]===void 0&&(this.inboundGroupSessions[s]=r)}storeEndToEndInboundGroupSession(e,t,r,n){var s=cs(e,t);this.inboundGroupSessions[s]=r}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){var s=cs(e,t);this.inboundGroupSessionsWithheld[s]=r}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){var t=[];for(var[r,n]of Object.entries(e.inboundGroupSessions))if(t.push(Ea(Ea({},Cg(r)),{},{sessionData:n,needsBackup:r in e.sessionsNeedingBackup})),t.length>=Wo)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){for(var{senderKey:r,sessionId:n}of e){var s=cs(r,n);delete t.inboundGroupSessions[s]}})()}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,r){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){var t=[];for(var r in this.sessionsNeedingBackup)if(this.inboundGroupSessions[r]&&(t.push(Ea(Ea({},Cg(r)),{},{sessionData:this.inboundGroupSessions[r]})),e&&r.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(var t of e){var r=cs(t.senderKey,t.sessionId);delete this.sessionsNeedingBackup[r]}return Promise.resolve()}markSessionsNeedingBackup(e){for(var t of e){var r=cs(t.senderKey,t.sessionId);this.sessionsNeedingBackup[r]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,r){var n=this.sharedHistoryInboundGroupSessions[e]||[];n.push([t,r]),this.sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var r,n=(r=this.parkedSharedHistory.get(e))!==null&&r!==void 0?r:[];n.push(t),this.parkedSharedHistory.set(e,n)}takeParkedSharedHistory(e){var t,r=(t=this.parkedSharedHistory.get(e))!==null&&t!==void 0?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(r)}doTxn(e,t,r){return Promise.resolve(r(null))}}var Ok=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function kk(a){var e=Ok.exec(a);return(e==null?void 0:e[0])===a}var Ak=/^[\w-]+$/;function Dk(a){var e=Ak.exec(a);return(e==null?void 0:e[0])===a}function Kf(a,e,t,r,n){var s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,l=arguments.length>6?arguments[6]:void 0,c=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return s?e:"";var[d,h,...v]=e.slice(6).split("/");if(v.length>0||!kk(d)||!Dk(h))return"";c&&(l=!0);var p,m=!!t||!!r||!!n,_=m?"thumbnail":"download";c?p="/_matrix/client/v1/media/".concat(_):p="/_matrix/media/v3/".concat(_);var b=new URL("".concat(p,"/").concat(d,"/").concat(h),a);return t&&b.searchParams.set("width",Math.round(t).toString()),r&&b.searchParams.set("height",Math.round(r).toString()),n&&b.searchParams.set("method",n),typeof l=="boolean"&&b.searchParams.set("allow_redirect",JSON.stringify(l)),b.href}var Bd={exports:{}},KE;function jf(){if(KE)return Bd.exports;KE=1;var a=typeof Reflect=="object"?Reflect:null,e=a&&typeof a.apply=="function"?a.apply:function(D,w,N){return Function.prototype.apply.call(D,w,N)},t;a&&typeof a.ownKeys=="function"?t=a.ownKeys:Object.getOwnPropertySymbols?t=function(D){return Object.getOwnPropertyNames(D).concat(Object.getOwnPropertySymbols(D))}:t=function(D){return Object.getOwnPropertyNames(D)};function r(I){console&&console.warn&&console.warn(I)}var n=Number.isNaN||function(D){return D!==D};function s(){s.init.call(this)}Bd.exports=s,Bd.exports.once=O,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var l=10;function c(I){if(typeof I!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof I)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(I){if(typeof I!="number"||I<0||n(I))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+I+".");l=I}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(D){if(typeof D!="number"||D<0||n(D))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+D+".");return this._maxListeners=D,this};function d(I){return I._maxListeners===void 0?s.defaultMaxListeners:I._maxListeners}s.prototype.getMaxListeners=function(){return d(this)},s.prototype.emit=function(D){for(var w=[],N=1;N<arguments.length;N++)w.push(arguments[N]);var A=D==="error",K=this._events;if(K!==void 0)A=A&&K.error===void 0;else if(!A)return!1;if(A){var z;if(w.length>0&&(z=w[0]),z instanceof Error)throw z;var de=new Error("Unhandled error."+(z?" ("+z.message+")":""));throw de.context=z,de}var _e=K[D];if(_e===void 0)return!1;if(typeof _e=="function")e(_e,this,w);else for(var le=_e.length,Ce=b(_e,le),N=0;N<le;++N)e(Ce[N],this,w);return!0};function h(I,D,w,N){var A,K,z;if(c(w),K=I._events,K===void 0?(K=I._events=Object.create(null),I._eventsCount=0):(K.newListener!==void 0&&(I.emit("newListener",D,w.listener?w.listener:w),K=I._events),z=K[D]),z===void 0)z=K[D]=w,++I._eventsCount;else if(typeof z=="function"?z=K[D]=N?[w,z]:[z,w]:N?z.unshift(w):z.push(w),A=d(I),A>0&&z.length>A&&!z.warned){z.warned=!0;var de=new Error("Possible EventEmitter memory leak detected. "+z.length+" "+String(D)+" listeners added. Use emitter.setMaxListeners() to increase limit");de.name="MaxListenersExceededWarning",de.emitter=I,de.type=D,de.count=z.length,r(de)}return I}s.prototype.addListener=function(D,w){return h(this,D,w,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(D,w){return h(this,D,w,!0)};function v(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(I,D,w){var N={fired:!1,wrapFn:void 0,target:I,type:D,listener:w},A=v.bind(N);return A.listener=w,N.wrapFn=A,A}s.prototype.once=function(D,w){return c(w),this.on(D,p(this,D,w)),this},s.prototype.prependOnceListener=function(D,w){return c(w),this.prependListener(D,p(this,D,w)),this},s.prototype.removeListener=function(D,w){var N,A,K,z,de;if(c(w),A=this._events,A===void 0)return this;if(N=A[D],N===void 0)return this;if(N===w||N.listener===w)--this._eventsCount===0?this._events=Object.create(null):(delete A[D],A.removeListener&&this.emit("removeListener",D,N.listener||w));else if(typeof N!="function"){for(K=-1,z=N.length-1;z>=0;z--)if(N[z]===w||N[z].listener===w){de=N[z].listener,K=z;break}if(K<0)return this;K===0?N.shift():E(N,K),N.length===1&&(A[D]=N[0]),A.removeListener!==void 0&&this.emit("removeListener",D,de||w)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(D){var w,N,A;if(N=this._events,N===void 0)return this;if(N.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):N[D]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete N[D]),this;if(arguments.length===0){var K=Object.keys(N),z;for(A=0;A<K.length;++A)z=K[A],z!=="removeListener"&&this.removeAllListeners(z);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(w=N[D],typeof w=="function")this.removeListener(D,w);else if(w!==void 0)for(A=w.length-1;A>=0;A--)this.removeListener(D,w[A]);return this};function m(I,D,w){var N=I._events;if(N===void 0)return[];var A=N[D];return A===void 0?[]:typeof A=="function"?w?[A.listener||A]:[A]:w?M(A):b(A,A.length)}s.prototype.listeners=function(D){return m(this,D,!0)},s.prototype.rawListeners=function(D){return m(this,D,!1)},s.listenerCount=function(I,D){return typeof I.listenerCount=="function"?I.listenerCount(D):_.call(I,D)},s.prototype.listenerCount=_;function _(I){var D=this._events;if(D!==void 0){var w=D[I];if(typeof w=="function")return 1;if(w!==void 0)return w.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(I,D){for(var w=new Array(D),N=0;N<D;++N)w[N]=I[N];return w}function E(I,D){for(;D+1<I.length;D++)I[D]=I[D+1];I.pop()}function M(I){for(var D=new Array(I.length),w=0;w<D.length;++w)D[w]=I[w].listener||I[w];return D}function O(I,D){return new Promise(function(w,N){function A(z){I.removeListener(D,K),N(z)}function K(){typeof I.removeListener=="function"&&I.removeListener("error",A),w([].slice.call(arguments))}U(I,D,K,{once:!0}),D!=="error"&&C(I,A,{once:!0})})}function C(I,D,w){typeof I.on=="function"&&U(I,"error",D,w)}function U(I,D,w,N){if(typeof I.on=="function")N.once?I.once(D,w):I.on(D,w);else if(typeof I.addEventListener=="function")I.addEventListener(D,function A(K){N.once&&I.removeEventListener(D,A),w(K)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof I)}return Bd.exports}var Mk=jf(),bw=(function(a){return a.NewListener="newListener",a.RemoveListener="removeListener",a.Error="error",a})({});class Pt extends Mk.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}emitPromised(e){var t=arguments,r=this;return R(function*(){for(var n=t.length,s=new Array(n>1?n-1:0),l=1;l<n;l++)s[l-1]=t[l];var c=r.listeners(e);return Promise.allSettled(c.map(d=>d(...s))).then(()=>c.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var om=new Wt("m.beacon_info","org.matrix.msc3672.beacon_info"),rp=new Wt("m.beacon","org.matrix.msc3672.beacon"),Nk=new tn.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),Uk=new tn.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),Pk=new tn.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),rc=new tn.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),bf=new tn.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),$=(function(a){return a.RoomCanonicalAlias="m.room.canonical_alias",a.RoomCreate="m.room.create",a.RoomJoinRules="m.room.join_rules",a.RoomMember="m.room.member",a.RoomThirdPartyInvite="m.room.third_party_invite",a.RoomPowerLevels="m.room.power_levels",a.RoomName="m.room.name",a.RoomTopic="m.room.topic",a.RoomAvatar="m.room.avatar",a.RoomPinnedEvents="m.room.pinned_events",a.RoomEncryption="m.room.encryption",a.RoomHistoryVisibility="m.room.history_visibility",a.RoomGuestAccess="m.room.guest_access",a.RoomServerAcl="m.room.server_acl",a.RoomTombstone="m.room.tombstone",a.RoomPredecessor="org.matrix.msc3946.room_predecessor",a.PolicyRuleUser="m.policy.rule.user",a.PolicyRuleRoom="m.policy.rule.room",a.PolicyRuleServer="m.policy.rule.server",a.SpaceChild="m.space.child",a.SpaceParent="m.space.parent",a.RoomRedaction="m.room.redaction",a.RoomMessage="m.room.message",a.RoomMessageEncrypted="m.room.encrypted",a.Sticker="m.sticker",a.CallInvite="m.call.invite",a.CallCandidates="m.call.candidates",a.CallAnswer="m.call.answer",a.CallHangup="m.call.hangup",a.CallReject="m.call.reject",a.CallSelectAnswer="m.call.select_answer",a.CallNegotiate="m.call.negotiate",a.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",a.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",a.CallReplaces="m.call.replaces",a.CallAssertedIdentity="m.call.asserted_identity",a.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",a.CallEncryptionKeysPrefix="io.element.call.encryption_keys",a.KeyVerificationRequest="m.key.verification.request",a.KeyVerificationStart="m.key.verification.start",a.KeyVerificationCancel="m.key.verification.cancel",a.KeyVerificationMac="m.key.verification.mac",a.KeyVerificationDone="m.key.verification.done",a.KeyVerificationKey="m.key.verification.key",a.KeyVerificationAccept="m.key.verification.accept",a.KeyVerificationReady="m.key.verification.ready",a.RoomMessageFeedback="m.room.message.feedback",a.Reaction="m.reaction",a.PollStart="org.matrix.msc3381.poll.start",a.Typing="m.typing",a.Receipt="m.receipt",a.Presence="m.presence",a.FullyRead="m.fully_read",a.Tag="m.tag",a.SpaceOrder="org.matrix.msc3230.space_order",a.PushRules="m.push_rules",a.Direct="m.direct",a.IgnoredUserList="m.ignored_user_list",a.RoomKey="m.room_key",a.RoomKeyRequest="m.room_key_request",a.ForwardedRoomKey="m.forwarded_room_key",a.Dummy="m.dummy",a.GroupCallPrefix="org.matrix.msc3401.call",a.GroupCallMemberPrefix="org.matrix.msc3401.call.member",a.CallNotify="org.matrix.msc4075.call.notify",a})({}),Ht=(function(a){return a.Annotation="m.annotation",a.Replace="m.replace",a.Reference="m.reference",a.Thread="m.thread",a})({}),Xn=(function(a){return a.Text="m.text",a.Emote="m.emote",a.Notice="m.notice",a.Image="m.image",a.File="m.file",a.Audio="m.audio",a.Location="m.location",a.Video="m.video",a.KeyVerificationRequest="m.key.verification.request",a})({}),_f="type",xo=(function(a){return a.Space="m.space",a.UnstableCall="org.matrix.msc3417.call",a.ElementVideo="io.element.video",a})({}),Fr="org.matrix.msgid",np=new Wt("m.room.purpose","org.matrix.msc3088.purpose"),ip=new Wt("m.enabled","org.matrix.msc3088.enabled"),ap=new Wt("m.data_tree","org.matrix.msc3089.data_tree"),_w=new Wt("m.leaf","org.matrix.msc3089.leaf"),qi=new Wt("m.branch","org.matrix.msc3089.branch"),Ew=new Wt("m.room.marker","org.matrix.msc2716.marker"),sp=new Wt("with_rel_types","org.matrix.msc3912.with_relations"),Tw=new Wt("io.element.functional_members","io.element.functional_members"),Is=new Wt("m.visibility","org.matrix.msc3531.visibility"),op=new Wt("enabled","org.matrix.msc3881.enabled"),Lk=new Wt("device_id","org.matrix.msc3881.device_id"),ww=new Wt("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),Ef=new Wt("thread_id","org.matrix.msc4023.thread_id"),Rw=new Pf("membership","io.element.msc4115.membership"),We=(function(a){return a.Ban="ban",a.Invite="invite",a.Join="join",a.Knock="knock",a.Leave="leave",a})({}),jr=(function(a){return a.Membership="RoomMember.membership",a.Name="RoomMember.name",a.PowerLevel="RoomMember.powerLevel",a.Typing="RoomMember.typing",a})({});class Tf extends Pt{constructor(e,t){super(),this.roomId=e,this.userId=t,y(this,"_isOutOfBand",!1),y(this,"modified",-1),y(this,"requestedProfileInfo",!1),y(this,"typing",!1),y(this,"name",void 0),y(this,"rawDisplayName",void 0),y(this,"powerLevel",0),y(this,"powerLevelNorm",0),y(this,"user",void 0),y(this,"membership",void 0),y(this,"disambiguate",!1),y(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n,s=(r=e.getDirectionalContent().displayname)!==null&&r!==void 0?r:"";if(e.getType()===$.RoomMember){this._isOutOfBand=!1,this.events.member=e;var l=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&T.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=Kk(this.userId,s,t);var c=this.name;this.name=jk(this.userId,s,this.disambiguate),this.rawDisplayName=Xg((n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:""),(!this.rawDisplayName||!Os(this.rawDisplayName))&&(this.rawDisplayName=this.userId),l!==this.membership&&(this.updateModifiedTime(),this.emit(jr.Membership,e,this,l)),c!==this.name&&(this.updateModifiedTime(),this.emit(jr.Name,e,this,c))}}setPowerLevelEvent(e){if(!(e.getType()!==$.RoomPowerLevels||e.getStateKey()!=="")){var t=e.getDirectionalContent(),r=t.users_default||0,n=t.users||{};Object.values(n).forEach(c=>{r=Math.max(r,c)});var s=this.powerLevel,l=this.powerLevelNorm;n[this.userId]!==void 0&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:t.users_default!==void 0?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=this.powerLevel*100/r),(s!==this.powerLevel||l!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit(jr.PowerLevel,e,this))}}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(r.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(jr.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===We.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if(t.membership===We.Join&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),t.membership===We.Invite&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,l=arguments.length>5?arguments[5]:void 0,c=this.getMxcAvatarUrl();if(!c&&!s)return null;var d=Kf(e,c,t,r,n,l);return d||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}var xk=/@.+:.+/,Bk=/[\u200E\u200F\u202A-\u202F]/;function Kk(a,e,t){if(!e||e===a||!t)return!1;var r=Os(e);if(!r)return!1;if(xk.test(r)||Bk.test(e))return!0;var n=t.getUserIdsWithDisplayName(e);return!!n.some(s=>s!==a)}function jk(a,e,t){return!e||e===a?a:t?Xg(e)+" ("+a+")":Os(e)?Xg(e):a}const Fk="modulepreload",qk=function(a){return"/habeas_app/"+a},jE={},Vk=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){let l=function(h){return Promise.all(h.map(v=>Promise.resolve(v).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),d=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));n=l(t.map(h=>{if(h=qk(h),h in jE)return;jE[h]=!0;const v=h.endsWith(".css"),p=v?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${p}`))return;const m=document.createElement("link");if(m.rel=v?"stylesheet":Fk,v||(m.as="script"),m.crossOrigin="",m.href=h,d&&m.setAttribute("nonce",d),document.head.appendChild(m),v)return new Promise((_,b)=>{m.addEventListener("load",_),m.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${h}`)))})}))}function s(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return n.then(l=>{for(const c of l||[])c.status==="rejected"&&s(c.reason);return e().catch(s)})};function Gk(a,e){if(a==null)return{};var t={};for(var r in a)if({}.hasOwnProperty.call(a,r)){if(e.indexOf(r)!==-1)continue;t[r]=a[r]}return t}function Hk(a,e){if(a==null)return{};var t,r,n=Gk(a,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(a);for(r=0;r<s.length;r++)t=s[r],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(a,t)&&(n[t]=a[t])}return n}var mn=(function(a){return a.DisplayName="User.displayName",a.AvatarUrl="User.avatarUrl",a.Presence="User.presence",a.CurrentlyActive="User.currentlyActive",a.LastPresenceTs="User.lastPresenceTs",a})({});class Wi extends Pt{constructor(e){super(),this.userId=e,y(this,"modified",-1),y(this,"displayName",void 0),y(this,"rawDisplayName",void 0),y(this,"avatarUrl",void 0),y(this,"presenceStatusMsg",void 0),y(this,"presence","offline"),y(this,"lastActiveAgo",0),y(this,"lastPresenceTs",0),y(this,"currentlyActive",!1),y(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var r=new Wi(e);return t.reEmitter.reEmit(r,[mn.AvatarUrl,mn.DisplayName,mn.Presence,mn.CurrentlyActive,mn.LastPresenceTs]),r}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var r=[];(e.getContent().presence!==this.presence||t)&&r.push(mn.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(mn.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(mn.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&r.push(mn.CurrentlyActive),this.presence=e.getContent().presence,r.push(mn.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var n of r)this.emit(n,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var tt=(function(a){return a.Backward="b",a.Forward="f",a})({});class ke{static setEventMetadata(e,t,r){var n,s;(n=e.sender)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member||(e.sender=t.getSentinelMember(e.getSender())),!((s=e.target)!==null&&s!==void 0&&(s=s.events)!==null&&s!==void 0&&s.member)&&e.getType()===$.RoomMember&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&r&&(e.forwardLooking=!1)}constructor(e){var t,r;this.eventTimelineSet=e,y(this,"roomId",void 0),y(this,"name",void 0),y(this,"events",[]),y(this,"baseIndex",0),y(this,"startState",void 0),y(this,"endState",void 0),y(this,"startToken",null),y(this,"endToken",null),y(this,"prevTimeline",null),y(this,"nextTimeline",null),y(this,"paginationRequests",{[tt.Backward]:null,[tt.Forward]:null}),this.roomId=(t=(r=e.room)===null||r===void 0?void 0:r.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new uc(this.roomId,void 0,!0),this.endState=new uc(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,r,{timelineWasEmpty:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:n}),(r=this.endState)===null||r===void 0||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){var t=this.getState(e),r=new ke(this.eventTimelineSet);return r.startState=t==null?void 0:t.clone(),r.endState=t,this.endState=t==null?void 0:t.clone(),r}fork(e){var t=this.getState(e),r=new ke(this.eventTimelineSet);return r.startState=t==null?void 0:t.clone(),r.endState=t==null?void 0:t.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==ke.BACKWARDS)return this.startState;if(e==ke.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===tt.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===tt.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==ke.BACKWARDS)return this.prevTimeline;if(e==ke.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==ke.BACKWARDS)this.prevTimeline=e;else if(t==ke.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e){var{toStartOfTimeline:t,roomState:r,timelineWasEmpty:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{toStartOfTimeline:!1};r||(r=t?this.startState:this.endState);var s=this.getTimelineSet();if(s.room&&(ke.setEventMetadata(e,r,t),e.isState()&&s.room.getUnfilteredTimelineSet()===s)){var l;(l=r)===null||l===void 0||l.setStateEvents([e],{timelineWasEmpty:n}),(!e.sender||e.getType()===$.RoomMember&&!t)&&ke.setEventMetadata(e,r,t)}var c;t?c=0:c=this.events.length,this.events.splice(c,0,e),t&&this.baseIndex++}insertEvent(e,t,r){var n=this.getTimelineSet();n.room&&(ke.setEventMetadata(e,r,!1),e.isState()&&n.room.getUnfilteredTimelineSet()===n&&(r.setStateEvents([e],{}),(!e.sender||e.getType()===$.RoomMember)&&ke.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}}y(ke,"BACKWARDS",tt.Backward);y(ke,"FORWARDS",tt.Forward);var sf=(function(a){return a.Add="Relations.add",a.Remove="Relations.remove",a.Redaction="Relations.redaction",a})({}),zk=function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...r].includes(e)};class lm extends Pt{constructor(e,t,r,n){var s;super(),s=this,this.relationType=e,this.eventType=t,this.altEventTypes=n,y(this,"relationEventIds",new Set),y(this,"relations",new Set),y(this,"annotationsByKey",{}),y(this,"annotationsBySender",{}),y(this,"sortedAnnotationsByKey",[]),y(this,"targetEvent",null),y(this,"creationEmitted",!1),y(this,"client",void 0),y(this,"onEventStatus",(l,c)=>{if(!l.isSending()){l.removeListener(ct.Status,this.onEventStatus);return}c===Ve.CANCELLED&&(l.removeListener(ct.Status,this.onEventStatus),this.removeEvent(l))}),y(this,"onBeforeRedaction",(function(){var l=R(function*(c){if(s.relations.has(c)){if(s.relations.delete(c),s.relationType===Ht.Annotation)s.removeAnnotationFromAggregation(c);else if(s.relationType===Ht.Replace&&s.targetEvent&&!s.targetEvent.isState()){var d=yield s.getLastReplacement();s.targetEvent.makeReplaced(d)}c.removeListener(ct.BeforeRedaction,s.onBeforeRedaction),s.emit(sf.Redaction,c)}});return function(c){return l.apply(this,arguments)}})()),this.client=r instanceof qf?r.client:r}addEvent(e){var t=this;return R(function*(){if(!t.relationEventIds.has(e.getId())){var r=e.getRelation();if(!r){T.error("Event must have relation info");return}var n=r.rel_type,s=e.getType();if(t.relationType!==n||!zk(s,t.eventType,t.altEventTypes)){T.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(ct.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===Ht.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===Ht.Replace&&t.targetEvent&&!t.targetEvent.isState()){var l=yield t.getLastReplacement();t.targetEvent.makeReplaced(l)}e.on(ct.BeforeRedaction,t.onBeforeRedaction),t.emit(sf.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return R(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===Ht.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===Ht.Replace&&t.targetEvent&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();t.targetEvent.makeReplaced(r)}t.emit(sf.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort((c,d)=>{var h=c[1],v=d[1];return v.size-h.size});var s=e.getSender(),l=this.annotationsBySender[s];l||(l=this.annotationsBySender[s]=new Set),l.add(e)}}removeAnnotationFromAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((c,d)=>{var h=c[1],v=d[1];return v.size-h.size}));var s=e.getSender(),l=this.annotationsBySender[s];l&&l.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==Ht.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==Ht.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return R(function*(){if(e.relationType!==Ht.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(Ht.Replace),r=t==null?void 0:t.origin_server_ts,n=e.getRelations().reduce((s,l)=>l.getSender()!==e.targetEvent.getSender()||r&&r>l.getTs()||s&&s.getTs()>l.getTs()?s:l,null);return n!=null&&n.shouldAttemptDecryption()&&e.client.isCryptoEnabled()?yield n.attemptDecryption(e.client.crypto):n!=null&&n.isBeingDecrypted()&&(yield n.getDecryptionPromise()),n})()}setTargetEvent(e){var t=this;return R(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===Ht.Replace&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();r&&t.targetEvent.makeReplaced(r)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(ct.RelationsCreated,this.relationType,this.eventType))}}class Cw{constructor(e,t){this.client=e,this.room=t,y(this,"relations",new Map)}getChildEventsForEvent(e,t,r){var n;return(n=this.relations.get(e))===null||n===void 0||(n=n.get(t))===null||n===void 0?void 0:n.get(r)}getAllChildEventsForEvent(e){var t,r=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,n=[];for(var s of r.values())for(var l of s.values())n.push(...l.getRelations());return n}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var r of t.values())for(var n of r.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===Ve.CANCELLED)){var r=e.getRelation();if(r){var n=()=>{if(e.isDecryptionFailure()){e.once(ct.Decrypted,n);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(ct.Decrypted,n);return}var{event_id:s,rel_type:l}=r,c=e.getType(),d=this.relations.get(s);d||(d=new Map,this.relations.set(s,d));var h=d.get(l);h||(h=new Map,d.set(l,h));var v=h.get(c);if(!v){var p,m,_;v=new lm(l,c,this.client),h.set(c,v);var b=(p=this.room)!==null&&p!==void 0?p:t==null?void 0:t.room,E=(m=(_=t==null?void 0:t.findEventById(s))!==null&&_!==void 0?_:b==null?void 0:b.findEventById(s))!==null&&m!==void 0?m:b==null?void 0:b.getPendingEvent(s);E&&v.setTargetEvent(E)}v.addEvent(e)}}}}var Do;Do=T.log.bind(T);var Gu=(function(a){return a.Ignore="ignore",a.Replace="replace",a})({});class Lo extends Pt{constructor(e){var t,r,n,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=arguments.length>2?arguments[2]:void 0,c=arguments.length>3?arguments[3]:void 0,d=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=c,this.threadListType=d,y(this,"relations",void 0),y(this,"timelineSupport",void 0),y(this,"displayPendingEvents",void 0),y(this,"liveTimeline",void 0),y(this,"timelines",void 0),y(this,"_eventIdToTimeline",new Map),y(this,"filter",void 0),this.timelineSupport=!!s.timelineSupport,this.liveTimeline=new ke(this),this.displayPendingEvents=s.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=s.filter,this.relations=(t=(r=this.room)===null||r===void 0?void 0:r.relations)!==null&&t!==void 0?t:new Cw((n=e==null?void 0:e.client)!==null&&n!==void 0?n:l)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){var r=!this.timelineSupport||!t,n=this.liveTimeline,s=r?n.forkLive(ke.FORWARDS):n.fork(ke.FORWARDS);r?(this.timelines=[s],this._eventIdToTimeline=new Map):this.timelines.push(s),t&&n.setPaginationToken(t,ke.FORWARDS),s.setPaginationToken(e??null,ke.BACKWARDS),this.liveTimeline=s,this.emit(Ue.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(r){return r.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new ke(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,n){if(!r)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var s=t?ke.BACKWARDS:ke.FORWARDS,l=t?ke.FORWARDS:ke.BACKWARDS,c=!1,d=!1;for(var h of e){var v=h.getId(),p=this._eventIdToTimeline.get(v);if(!p){this.addEventToTimeline(h,r,{toStartOfTimeline:t}),d=!0,c=!0;continue}if(d=!1,p==r){Do("Event "+v+" already in timeline "+r);continue}var m=r.getNeighbouringTimeline(s);if(m){p==m?Do("Event "+v+" in neighbouring timeline - switching to "+p):Do("Event "+v+" already in a different timeline "+p),r=p;continue}T.info("Already have timeline for "+v+" - joining timeline "+r+" to "+p);var _=p===this.liveTimeline,b=r===this.liveTimeline,E=s===ke.BACKWARDS&&_,M=s===ke.FORWARDS&&b;if(E||M){E&&T.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+p+")"),M&&T.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")");continue}r.setNeighbouringTimeline(p,s),p.setNeighbouringTimeline(r,l),r=p,c=!0}if(d||!c){if(s===ke.FORWARDS&&r===this.liveTimeline){T.warn({lastEventWasNew:d,didUpdate:c}),T.warn("Refusing to set forwards pagination token of live timeline "+"".concat(r," to ").concat(n));return}r.setPaginationToken(n??null,s)}}}addLiveEvent(e){var{duplicateStrategy:t,fromCache:r,roomState:n,timelineWasEmpty:s}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filter){var l=this.filter.filterRoomTimeline([e]);if(!l.length)return}var c=this._eventIdToTimeline.get(e.getId());if(c){if(t===Gu.Replace){Do("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var d=c.getEvents(),h=0;h<d.length;h++)if(d[h].getId()===e.getId()){n||(n=c.getState(ke.FORWARDS)),ke.setEventMetadata(e,n,!1),d[h]=e;break}}else Do("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:r,roomState:n,timelineWasEmpty:s})}addEventToTimeline(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0,l=!!r,c;if(typeof r=="object"?{toStartOfTimeline:l,fromCache:n=!1,roomState:s,timelineWasEmpty:c}=r:r!==void 0&&T.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),t.getTimelineSet()!==this){var d;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((d=this.thread)===null||d===void 0?void 0:d.id,")"))}var h=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var v,p="event=".concat(h);e.threadRootId&&(p+="(belongs to thread=".concat(e.threadRootId,")")),T.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(p," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((v=this.thread)===null||v===void 0?void 0:v.id,")"));return}t.addEvent(e,{toStartOfTimeline:l,roomState:s,timelineWasEmpty:c}),this._eventIdToTimeline.set(h,t);var m={timeline:t,liveEvent:!l&&t==this.liveTimeline&&!n};this.emit(Ue.Timeline,e,this.room,!!l,!1,m)}insertEventIntoTimeline(e,t,r){if(t.getTimelineSet()!==this){var n;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((n=this.thread)===null||n===void 0?void 0:n.id,")"))}var s=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var l,c="event=".concat(s);e.threadRootId&&(c+="(belongs to thread=".concat(e.threadRootId,")")),T.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(c," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((l=this.thread)===null||l===void 0?void 0:l.id,")"));return}var d=e.relationEventId;if(!d){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r});return}for(var h=this.findEventById(d),v=t.getEvents(),p=h!==void 0?v.indexOf(h):0,m=p;m<v.length;m++){var _=v[m];if(_.getTs()>e.getTs())break}t.insertEvent(e,m,r),this._eventIdToTimeline.set(s,t);var b={timeline:t,liveEvent:!1};this.emit(Ue.Timeline,e,this.room,!1,!1,b)}handleRemoteEcho(e,t,r){var n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var r=t.removeEvent(e);if(r){this._eventIdToTimeline.delete(e);var n={timeline:t};this.emit(Ue.Timeline,r,this.room,void 0,!0,n)}return r}compareEventOrdering(e,t){if(e==t)return 0;var r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(r===void 0||n===void 0)return null;if(r===n){for(var s=void 0,l=void 0,c=r.getEvents(),d=0;d<c.length&&(s===void 0||l===void 0);d++){var h=c[d].getId();h==e&&(s=d),h==t&&(l=d)}var v=s-l;return v<0?-1:v>0?1:0}for(var p=r;p;){if(p===n)return-1;p=p.getNeighbouringTimeline(ke.FORWARDS)}for(p=r;p;){if(p===n)return 1;p=p.getNeighbouringTimeline(ke.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:r,shouldLiveInThread:n}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!r&&!n){var s;T.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((s=this.room)===null||s===void 0?void 0:s.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return r}}var Ve=(function(a){return a.NOT_SENT="not_sent",a.ENCRYPTING="encrypting",a.SENDING="sending",a.QUEUED="queued",a.SENT="sent",a.CANCELLED="cancelled",a})({});class Iw{constructor(e,t){this.roomId=e}}class Ow{constructor(e){this.target=e,y(this,"reEmitters",new WeakMap)}reEmit(e,t){var r=this,n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));var s=function(d){if(n.has(d))return 1;var h=function(){if(!(d==="error"&&r.target.listenerCount("error")===0)){for(var p=arguments.length,m=new Array(p),_=0;_<p;_++)m[_]=arguments[_];r.target.emit(d,...m,e)}};e.on(d,h),n.set(d,h)};for(var l of t)s(l)}stopReEmitting(e,t){var r=this.reEmitters.get(e);if(r){for(var n of t)e.off(n,r.get(n)),r.delete(n);r.size===0&&this.reEmitters.delete(e)}}}class al extends Ow{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var nc=new Lf("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function Wk(a,e){if(e.endsWith("*")){var t=e.slice(0,-1);return a.slice(0,t.length)===t}else return a===e}class FE{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,r,n=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},s=Object.keys(n),l=[];return this.userId&&n!==null&&n!==void 0&&(r=n[Ot.name])!==null&&r!==void 0&&r.current_user_participated&&l.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,s,l)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[Vo.name]:this.filterJson[Vo.name]||[],[Go.name]:this.filterJson[Go.name]||[]}}checkFields(e,t,r,n,s,l){var c={rooms:function(O){return e===O},senders:function(O){return t===O},types:function(O){return Wk(r,O)}};for(var d in c){var h=c[d],v="not_"+d,p=this.filterJson[v];if(p!=null&&p.some(h))return!1;var m=this.filterJson[d];if(m&&!m.some(h))return!1}var _=this.filterJson.contains_url;if(_!==void 0&&_!==n)return!1;var b=this.filterJson[Go.name];if(b!==void 0&&!this.arrayMatchesFilter(b,s))return!1;var E=this.filterJson[Vo.name];return!(E!==void 0&&!this.arrayMatchesFilter(E,l))}arrayMatchesFilter(e,t){return t.length>0&&e.every(r=>t.includes(r))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function qE(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function wo(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?qE(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):qE(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}function Ig(a,e,t){for(var r=e.split("."),n=a,s=0;s<r.length-1;s++)n[r[s]]||(n[r[s]]={}),n=n[r[s]];n[r[r.length-1]]=t}class $r{static fromJson(e,t,r){var n=new $r(e,t);return n.setDefinition(r),n}constructor(e,t){this.userId=e,this.filterId=t,y(this,"definition",{}),y(this,"roomFilter",void 0),y(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new FE(r,this.userId),this.roomTimelineFilter=new FE((t==null?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){Ig(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=wo(wo({},this.definition),{},{room:wo(wo({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:wo(wo({},(r=this.definition)===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.timeline),{},{[nc.name]:e})})})}setLazyLoadMembers(e){Ig(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){Ig(this.definition,"room.include_leave",e)}}y($r,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});var um=new Wt("m.topic","org.matrix.msc3765.topic");function VE(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Yk(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?VE(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):VE(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}function kw(a,e){return{msgtype:Xn.Text,format:"org.matrix.custom.html",body:a,formatted_body:e}}function Aw(a,e){return{msgtype:Xn.Notice,format:"org.matrix.custom.html",body:a,formatted_body:e}}function Dw(a,e){return{msgtype:Xn.Emote,format:"org.matrix.custom.html",body:a,formatted_body:e}}function Mw(a){return{msgtype:Xn.Text,body:a}}function Nw(a){return{msgtype:Xn.Notice,body:a}}function Uw(a){return{msgtype:Xn.Emote,body:a}}var Pw=(a,e,t,r)=>{var n="at ".concat(new Date(t).toISOString()),s=e===Ho.Self?"User":void 0,l=r?'"'.concat(r,'"'):void 0;return[s,"Location",l,a,n].filter(Boolean).join(" ")},Lw=(a,e,t,r,n)=>{var s=a??Pw(e,n||Ho.Self,t,r),l=t?{[Fa.name]:t}:{};return Yk({msgtype:Xn.Location,body:s,geo_uri:e,[mc.name]:{description:r,uri:e},[pc.name]:{type:n||Ho.Self},[am.name]:s},l)},Jk=a=>{var e,t,r=mc.findIn(a),n=pc.findIn(a),s=Fa.findIn(a),l=am.findIn(a),c=(e=r==null?void 0:r.uri)!==null&&e!==void 0?e:a==null?void 0:a.geo_uri,d=r==null?void 0:r.description,h=(t=n==null?void 0:n.type)!==null&&t!==void 0?t:Ho.Self,v=l??a.body;return Lw(v,c,s??void 0,d,h)},xw=(a,e)=>{var t=[{body:a,mimetype:"text/plain"}];return im(e)&&t.push({body:e,mimetype:"text/html"}),{topic:a,[um.name]:t}},Qk=a=>{var e,t,r,n=um.findIn(a);if(!Array.isArray(n))return{text:a.topic};var s=(e=n==null||(t=n.find(c=>!im(c.mimetype)||c.mimetype==="text/plain"))===null||t===void 0?void 0:t.body)!==null&&e!==void 0?e:a.topic,l=n==null||(r=n.find(c=>c.mimetype==="text/html"))===null||r===void 0?void 0:r.body;return{text:s,html:l}},Xk=(a,e,t,r,n)=>({description:t,timeout:a,live:e,[Fa.name]:n||Date.now(),[pc.name]:{type:r??Ho.Self}}),Bw=a=>{var e,{description:t,timeout:r,live:n}=a,s=(e=Fa.findIn(a))!==null&&e!==void 0?e:void 0,l=pc.findIn(a);return{description:t,timeout:r,live:n,assetType:l==null?void 0:l.type,timestamp:s}},$k=(a,e,t,r)=>({[mc.name]:{description:r,uri:a},[Fa.name]:e,"m.relates_to":{rel_type:hw.name,event_id:t}}),lp=a=>{var e,t=mc.findIn(a),r=(e=Fa.findIn(a))!==null&&e!==void 0?e:void 0;return{description:t==null?void 0:t.description,uri:t==null?void 0:t.uri,timestamp:r}};const Zk=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:Pw,makeBeaconContent:$k,makeBeaconInfoContent:Xk,makeEmoteMessage:Uw,makeHtmlEmote:Dw,makeHtmlMessage:kw,makeHtmlNotice:Aw,makeLocationContent:Lw,makeNotice:Nw,makeTextMessage:Mw,makeTopicContent:xw,parseBeaconContent:lp,parseBeaconInfoContent:Bw,parseLocationEvent:Jk,parseTopicContent:Qk},Symbol.toStringTag,{value:"Module"}));var Bt=(function(a){return a.New="Beacon.new",a.Update="Beacon.update",a.LivenessChange="Beacon.LivenessChange",a.Destroy="Beacon.Destroy",a.LocationUpdate="Beacon.LocationUpdate",a})({}),up=(a,e,t)=>t>=a&&a+e>=t,wf=a=>"".concat(a.getRoomId(),"_").concat(a.getStateKey());class Kw extends Pt{constructor(e){super(),this.rootEvent=e,y(this,"roomId",void 0),y(this,"_beaconInfo",void 0),y(this,"_isLive",void 0),y(this,"livenessWatchTimeout",void 0),y(this,"_latestLocationEvent",void 0),y(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(Bt.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return wf(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&lp(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(wf(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(Bt.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(Bt.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var r=e.filter(s=>{var l=s.getContent(),c=lp(l);if(!c.uri||!c.timestamp)return!1;var{timestamp:d}=c;return this._beaconInfo.timestamp&&up(this._beaconInfo.timestamp,this._beaconInfo.timeout,d)&&(!this.latestLocationState||d>this.latestLocationState.timestamp)}),n=(t=r.sort(Ik))===null||t===void 0?void 0:t[0];n&&(this._latestLocationEvent=n,this.emit(Bt.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=Bw(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&up(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(Bt.LivenessChange,this.isLive,this)}}}function GE(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function eA(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?GE(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):GE(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}function jw(a,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new _r({content:{[e.getId()]:{[t]:{[a]:eA({ts:e.getTs()},!r&&{thread_id:el(e)})}}},type:$.Receipt,room_id:e.getRoomId()})}var Ro=0,Co=1;class Fw extends Pt{constructor(){super(...arguments),y(this,"receipts",new Xt(()=>new Map)),y(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:xr.Read,[l,c]=(t=(r=this.receipts.get(s))===null||r===void 0?void 0:r.get(e))!==null&&t!==void 0?t:[null,null];return n?l:c??l}compareReceipts(e,t){var r;return(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&r!==void 0?r:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t,r=this.findEventById(e.eventId);if(!r)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===yc){var n=lc(r);if(n)return!0}else if(r.threadRootId===e.data.thread_id)return!0;return T.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n,s=this.getReadReceiptForUserId(e,t,xr.Read),l=this.getReadReceiptForUserId(e,t,xr.ReadPrivate),c;return s!=null&&s.eventId&&l!==null&&l!==void 0&&l.eventId&&(c=this.compareReceipts(s,l)),c?(n=c<0?l:s)!==null&&n!==void 0?n:null:(r=l??s)!==null&&r!==void 0?r:null}addReceiptToStructure(e,t,r,n,s){var l,c,d=this.receipts.getOrCreate(t),h=d.get(r);h||(h=[null,null],d.set(r,h));var v=h[Ro];if(s){var p;v=(p=h[Co])!==null&&p!==void 0?p:h[Ro]}var m={eventId:e,data:n};if(v){var _=this.compareReceipts(v,m);if(_>=0)return}var b=s?h[Ro]:m,E=s?m:h[Co],M=null;b&&E&&(M=this.getUnfilteredTimelineSet().compareEventOrdering(b.eventId,E.eventId));var O=M===null||M<0,C=(l=h[Co])!==null&&l!==void 0?l:h[Ro];s&&O?h[Co]=m:s||(h[Ro]=m,O||(h[Co]=null));var U=(c=h[Co])!==null&&c!==void 0?c:h[Ro];if(C!==U){if(C&&this.receiptCacheByEventId.get(C.eventId)){var I=C.eventId;this.receiptCacheByEventId.set(I,this.receiptCacheByEventId.get(I).filter(D=>D.type!==t||D.userId!==r)),this.receiptCacheByEventId.get(I).length<1&&this.receiptCacheByEventId.delete(I)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&(t==null?void 0:t.eventId)===r.getId()&&e===r.getSender()&&(this.setUnread(pt.Total,0),this.setUnread(pt.Highlight,0))}addLocalEchoReceipt(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(jw(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return sm(t.type)}).map(function(t){return t.userId})}}var Da=(function(a){return a.New="Poll.new",a.End="Poll.end",a.Update="Poll.update",a.Responses="Poll.Responses",a.Destroy="Poll.Destroy",a.UndecryptableRelations="Poll.UndecryptableRelations",a})({}),HE=(a,e)=>{var t=a.filter(r=>{if(!r.isDecryptionFailure())return rc.matches(r.getType())&&r.getTs()<=e});return{responseEvents:t}};class qw extends Pt{constructor(e,t,r){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=r,y(this,"roomId",void 0),y(this,"pollEvent",void 0),y(this,"_isFetchingResponses",!1),y(this,"relationsNextBatch",void 0),y(this,"responses",null),y(this,"endEvent",void 0),y(this,"undecryptableRelationEventIds",new Set),y(this,"countUndecryptableEvents",n=>{var s=n.filter(c=>c.isDecryptionFailure()).map(c=>c.getId()),l=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...s]),this.undecryptableRelationsCount!==l&&this.emit(Da.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return R(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(bf.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(Da.End)),!!this.responses){var r=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:n}=HE([e],r);this.countUndecryptableEvents([e]),n.length&&(n.forEach(s=>{this.responses.addEvent(s)}),this.emit(Da.Responses,this.responses))}}fetchResponses(){var e=this;return R(function*(){var t,r;e._isFetchingResponses=!0;var n=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(n.events.map(h=>e.matrixClient.decryptEventIfNeeded(h)));var s=e.responses||new lm("m.reference",rc.name,e.matrixClient,[rc.altName]),l=n.events.find(h=>bf.matches(h.getType()));e.validateEndEvent(l)&&(e.endEvent=l,e.refilterResponsesOnEnd(),e.emit(Da.End));var c=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:d}=HE(n.events,c);d.forEach(h=>{s.addEvent(h)}),e.relationsNextBatch=(r=n.nextBatch)!==null&&r!==void 0?r:void 0,e.responses=s,e.countUndecryptableEvents(n.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(Da.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(r=>{if(r.getTs()>t){var n;(n=this.responses)===null||n===void 0||n.removeEvent(r)}}),this.emit(Da.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}}var Vw=a=>{var e=a.getType();return tn.M_POLL_START.matches(e)||rc.matches(e)||bf.matches(e)};class tA{constructor(e){y(this,"room",void 0),y(this,"threadedReceipts",void 0),y(this,"unthreadedReceipts",void 0),y(this,"danglingReceipts",void 0),y(this,"onTimelineEvent",t=>{var r=t.getId();if(r){var n=this.danglingReceipts.remove(r);n==null||n.forEach(s=>{s.receipt.thread_id?this.threadedReceipts.set(s.receipt.thread_id,s.eventId,s.receiptType,s.userId,s.receipt.ts,s.synthetic):this.unthreadedReceipts.set(r,s.receiptType,s.userId,s.receipt.ts,s.synthetic)})}}),this.room=e,this.threadedReceipts=new aA(e),this.unthreadedReceipts=new Gw(e),this.danglingReceipts=new sA,e.on(Ue.Timeline,this.onTimelineEvent)}add(e,t){for(var[r,n]of Object.entries(e))for(var[s,l]of Object.entries(n))for(var[c,d]of Object.entries(l)){var h=this.room.findEventById(r);h?d.thread_id?this.threadedReceipts.set(d.thread_id,r,s,c,d.ts,t):this.unthreadedReceipts.set(r,s,c,d.ts,t):this.danglingReceipts.add(new nA(r,s,c,d,t))}}hasUserReadEvent(e,t){var r=this.unthreadedReceipts.get(e);if(r&&cp(r.eventId,t,this.room))return!0;var n=this.room.findEventById(t);if(!n)return T.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var s=el(n),l=this.threadedReceipts.get(s,e);return!!(l&&cp(l.eventId,t,this.room)||this.userSentLatestEventInThread(s,e))}userSentLatestEventInThread(e,t){var r,n=e===yc?this.room.getLiveTimeline().getEvents():(r=this.room.getThread(e))===null||r===void 0?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class rA{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class nA{constructor(e,t,r,n,s){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=s}}class iA{constructor(e){y(this,"room",void 0),y(this,"real",void 0),y(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&cp(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}}class Gw{constructor(e){y(this,"room",void 0),y(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,s){var l=cm(this.data,r,()=>new iA(this.room)),c=l.getByType(s);c&&oA(c.eventId,e,this.room)||l.set(s,new rA(e,t,n))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}}class aA{constructor(e){y(this,"room",void 0),y(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,s,l){var c=cm(this.data,e,()=>new Gw(this.room));c.set(t,r,n,s,l)}get(e,t){var r;return(r=this.data.get(e))===null||r===void 0?void 0:r.get(t)}}class sA{constructor(){y(this,"data",new Map)}add(e){var t=cm(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function cm(a,e,t){var r=a.get(e);if(r)return r;var n=t();return a.set(e,n),n}function cp(a,e,t){var r=t.compareEventOrdering(a,e);return r!==null&&r>=0}function oA(a,e,t){var r=t.compareEventOrdering(a,e);return r!==null&&r>0}function lA(a,e,t){var r=a.findEventById(e),n=a.findEventById(t);if(!r||!n)return null;var s=lc(r),l=lc(n);return s&&l?uA(a,e,t,r,n):cA(e,t,r,n)}function uA(a,e,t,r,n){var s=a.getUnfilteredTimelineSet(),l=s.compareEventOrdering(e,t);if(l!==null)return l;var c=s.getTimelineForEvent(e);if(c===s.getLiveTimeline())return 1;var d=s.getTimelineForEvent(t);return d===s.getLiveTimeline()?-1:Hw(r,n)}function cA(a,e,t,r){var n=el(t),s=el(r),l=t.getThread();return l&&n===s?l.timelineSet.compareEventOrdering(a,e):Hw(t,r)}function Hw(a,e){var t=a.getTs(),r=e.getTs();return t<r?-1:t>r?1:0}var se=(function(a){return a.Get="GET",a.Put="PUT",a.Post="POST",a.Delete="DELETE",a.Options="OPTIONS",a.Head="HEAD",a.Patch="PATCH",a})({});function zE(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function dA(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zE(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):zE(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}class Yo extends Error{constructor(e,t,r){super(e),this.httpStatus=t,this.httpHeaders=r}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var r=Number.parseInt(t)*1e3;if(!Number.isFinite(r))throw new Error("Retry-After header integer value is too large");return r}var n=new Date(t);if(n.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return n.getTime()-Date.now()}return null}}class hr extends Yo{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,l=e.error||"Unknown message";t&&(l="[".concat(t,"] ").concat(l)),r&&(l="".concat(l," (").concat(r,")")),super("MatrixError: ".concat(l),t,s),this.url=r,this.event=n,y(this,"errcode",void 0),y(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,r,n,s={};if(this.httpHeaders)for(var[l,c]of this.httpHeaders)s[l]=c;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:s,url:(t=this.url)!==null&&t!==void 0?t:"",response:dA({errcode:(r=this.errcode)!==null&&r!==void 0?r:"M_UNKNOWN",error:(n=this.data.error)!==null&&n!==void 0?n:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new hr(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function dm(a,e){if(!(a instanceof Yo)||!a.isRateLimitError())return e;try{var t;return(t=a.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}class Sc extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}var dp=(function(a){return a.SessionLoggedOut="Session.logged_out",a.NoConsent="no_consent",a})({}),Kd={};/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var WE;function fA(){if(WE)return Kd;WE=1;var a=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,e=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,t=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,r=/\\([\u000b\u0020-\u00ff])/g,n=/([\\"])/g,s=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;Kd.format=l,Kd.parse=c;function l(p){if(!p||typeof p!="object")throw new TypeError("argument obj is required");var m=p.parameters,_=p.type;if(!_||!s.test(_))throw new TypeError("invalid type");var b=_;if(m&&typeof m=="object")for(var E,M=Object.keys(m).sort(),O=0;O<M.length;O++){if(E=M[O],!t.test(E))throw new TypeError("invalid parameter name");b+="; "+E+"="+h(m[E])}return b}function c(p){if(!p)throw new TypeError("argument string is required");var m=typeof p=="object"?d(p):p;if(typeof m!="string")throw new TypeError("argument string is required to be a string");var _=m.indexOf(";"),b=_!==-1?m.slice(0,_).trim():m.trim();if(!s.test(b))throw new TypeError("invalid media type");var E=new v(b.toLowerCase());if(_!==-1){var M,O,C;for(a.lastIndex=_;O=a.exec(m);){if(O.index!==_)throw new TypeError("invalid parameter format");_+=O[0].length,M=O[1].toLowerCase(),C=O[2],C.charCodeAt(0)===34&&(C=C.slice(1,-1),C.indexOf("\\")!==-1&&(C=C.replace(r,"$1"))),E.parameters[M]=C}if(_!==m.length)throw new TypeError("invalid parameter format")}return E}function d(p){var m;if(typeof p.getHeader=="function"?m=p.getHeader("content-type"):typeof p.headers=="object"&&(m=p.headers&&p.headers["content-type"]),typeof m!="string")throw new TypeError("content-type header is missing from object");return m}function h(p){var m=String(p);if(t.test(m))return m;if(m.length>0&&!e.test(m))throw new TypeError("invalid parameter value");return'"'+m.replace(n,"\\$1")+'"'}function v(p){this.parameters=Object.create(null),this.type=p}return Kd}var hA=fA();function Ff(a){var e=new AbortController;return setTimeout(()=>{e.abort()},a),e.signal}function zw(a){var e=new AbortController;function t(){for(var s of a)s.removeEventListener("abort",r)}function r(){e.abort(),t()}for(var n of a){if(n.aborted){r();break}n.addEventListener("abort",r)}return{signal:e.signal,cleanup:t}}function fm(a,e){var t,r,n=YE(a)?new Headers(a.getAllResponseHeaders().trim().split(/[\r\n]+/).map(l=>{var c=l.indexOf(":");return[l.substring(0,c),l.substring(c+1)]})):a.headers,s;try{s=vA(n)}catch(l){return l}return((t=s)===null||t===void 0?void 0:t.type)==="application/json"&&e?new hr(JSON.parse(e),a.status,YE(a)?a.responseURL:a.url,void 0,n):((r=s)===null||r===void 0?void 0:r.type)==="text/plain"?new Yo("Server returned ".concat(a.status," error: ").concat(e),a.status,n):new Yo("Server returned ".concat(a.status," error"),a.status,n)}function YE(a){return"getResponseHeader"in a}function vA(a){var e=a.get("Content-Type");if(e===null)return null;try{return hA.parse(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}function Ww(a,e){return fp.apply(this,arguments)}function fp(){return fp=R(function*(a,e){for(var t=0,r=null;t<a;)try{if(t>0){var n=1e3*Math.pow(2,t);T.log("network operation failed ".concat(t," times, retrying in ").concat(n,"ms...")),yield Ba(n)}return yield e()}catch(s){if(s instanceof Sc)t+=1,r=s;else throw s}throw r}),fp.apply(this,arguments)}function Yw(a,e,t){return e>4||a instanceof Sc&&!t||a.httpStatus&&(a.httpStatus===400||a.httpStatus===403||a.httpStatus===401)||a.name==="AbortError"||a.name==="M_TOO_LARGE"?-1:dm(a,1e3*Math.pow(2,e))}function JE(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Og(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?JE(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):JE(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}class gA{constructor(e,t){var r;this.eventEmitter=e,this.opts=t,y(this,"abortController",new AbortController),vw(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=(r=t.useAuthorizationHeader)!==null&&r!==void 0?r:!0}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,s){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var l=void 0,c=void 0;e===se.Get?l=r:c=r;var d=this.getUrl(t,l,n,this.opts.idBaseUrl),h={json:!0,headers:{}};return s&&(h.headers.Authorization="Bearer ".concat(s)),this.requestOtherUrl(e,d,c,h)}authedRequest(e,t,r,n){var s=arguments,l=this;return R(function*(){var c=s.length>4&&s[4]!==void 0?s[4]:{};r||(r={});var d=Og({},c);l.opts.accessToken&&(l.opts.useAuthorizationHeader?(d.headers||(d.headers={}),d.headers.Authorization||(d.headers.Authorization="Bearer "+l.opts.accessToken),r.access_token&&delete r.access_token):r.access_token||(r.access_token=l.opts.accessToken));try{var h=yield l.request(e,t,r,n,d);return h}catch(m){var v=m;if(v.errcode==="M_UNKNOWN_TOKEN"&&!d.doNotAttemptTokenRefresh){var p=yield l.tryRefreshToken();if(p)return l.authedRequest(e,t,r,n,Og(Og({},c),{},{doNotAttemptTokenRefresh:!0}))}throw v.errcode=="M_UNKNOWN_TOKEN"&&!(d!=null&&d.inhibitLogoutEmit)?l.eventEmitter.emit(dp.SessionLoggedOut,v):v.errcode=="M_CONSENT_NOT_GIVEN"&&l.eventEmitter.emit(dp.NoConsent,v.message,v.data.consent_uri),v}})()}tryRefreshToken(){var e=this;return R(function*(){if(!e.opts.refreshToken||!e.opts.tokenRefreshFunction)return!1;try{var{accessToken:t,refreshToken:r}=yield e.opts.tokenRefreshFunction(e.opts.refreshToken);return e.opts.accessToken=t,e.opts.refreshToken=r,!0}catch(s){var n;return(n=e.opts.logger)===null||n===void 0||n.warn("Failed to refresh token",s),!1}})()}request(e,t,r,n,s){var l=this.getUrl(t,r,s==null?void 0:s.prefix,s==null?void 0:s.baseUrl);return this.requestOtherUrl(e,l,n,s)}requestOtherUrl(e,t,r){var n=arguments,s=this;return R(function*(){var l,c,d,h,v,p=n.length>3&&n[3]!==void 0?n[3]:{},m=s.sanitizeUrlForLogs(t);(l=s.opts.logger)===null||l===void 0||l.debug("FetchHttpApi: --> ".concat(e," ").concat(m));var _=Object.assign({},p.headers||{}),b=(c=p.json)!==null&&c!==void 0?c:!0,E=b&&(r==null||(d=r.constructor)===null||d===void 0?void 0:d.name)===Object.name;b&&(E&&!_["Content-Type"]&&(_["Content-Type"]="application/json"),_.Accept||(_.Accept="application/json"));var M=(h=p.localTimeoutMs)!==null&&h!==void 0?h:s.opts.localTimeoutMs,O=(v=p.keepAlive)!==null&&v!==void 0?v:!1,C=[s.abortController.signal];M!==void 0&&C.push(Ff(M)),p.abortSignal&&C.push(p.abortSignal);var U;E?U=JSON.stringify(r):U=r;var{signal:I,cleanup:D}=zw(C),w,N=Date.now();try{var A;w=yield s.fetch(t,{signal:I,method:e,body:U,headers:_,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:O,priority:p.priority}),(A=s.opts.logger)===null||A===void 0||A.debug("FetchHttpApi: <-- ".concat(e," ").concat(m," [").concat(Date.now()-N,"ms ").concat(w.status,"]"))}catch(z){var K;throw(K=s.opts.logger)===null||K===void 0||K.debug("FetchHttpApi: <-- ".concat(e," ").concat(m," [").concat(Date.now()-N,"ms ").concat(z,"]")),z.name==="AbortError"?z:new Sc("fetch failed",z)}finally{D()}if(!w.ok)throw fm(w,yield w.text());return s.opts.onlyData?b?w.json():w.text():w})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var r=new URLSearchParams;for(var n of t.searchParams.keys())r.append(n,"xxx");var s=r.toString(),l=s?"?".concat(s):"";return t.origin+t.pathname+l}catch{return"??"}}getUrl(e,t,r,n){var s=n??this.opts.baseUrl,l=s.endsWith("/")?s.slice(0,-1):s,c=new URL(l+(r??this.opts.prefix)+e);return t&&Jg(t,c.searchParams),c}}var qt=(function(a){return a.V1="/_matrix/client/v1",a.V3="/_matrix/client/v3",a.Unstable="/_matrix/client/unstable",a})({}),Bi=(function(a){return a.V2="/_matrix/identity/v2",a})({}),Bo=(function(a){return a.V1="/_matrix/media/v1",a.V3="/_matrix/media/v3",a})({}),pA=1e3,mA=0,kg,Gi=[],yA=function(){};function QE(a,e){for(var t=arguments.length,r=new Array(t>2?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];e=e||0,e<0&&(e=0);var s=Date.now()+e,l=mA++,c={runAt:s,func:a,params:r,key:l},d=bA(Gi,function(h){return h.runAt-s});return Gi.splice(d,0,c),hm(),l}function XE(a){if(Gi.length!==0){var e;for(e=0;e<Gi.length;e++){var t=Gi[e];if(t.key==a){Gi.splice(e,1);break}}e===0&&hm()}}function hm(){kg&&globalThis.clearTimeout(kg);var a=Gi[0];if(a){var e=Date.now(),t=Math.min(a.runAt-e,pA);kg=globalThis.setTimeout(SA,t)}}function SA(){for(var a=Date.now(),e=[];;){var t=Gi[0];if(!t||t.runAt>a)break;var r=Gi.shift();yA("runCallbacks: popping",r.key),e.push(r)}hm();for(var n of e)try{n.func.apply(globalThis,n.params)}catch(s){T.error("Uncaught exception in callback function",s)}}function bA(a,e){for(var t=0,r=a.length;t<r;){var n=t+r>>1,s=e(a[n]);s>0?r=n:t=n+1}return t}class Jw extends gA{constructor(){super(...arguments),y(this,"uploads",[])}uploadContent(e){var t,r,n,s,l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},c=(t=l.includeFilename)!==null&&t!==void 0?t:!0,d=(r=l.abortController)!==null&&r!==void 0?r:new AbortController,h=((n=l.type)!==null&&n!==void 0?n:e.type)||"application/octet-stream",v=(s=l.name)!==null&&s!==void 0?s:e.name,p={loaded:0,total:0,abortController:d},m=qa();if(globalThis.XMLHttpRequest){var _=new globalThis.XMLHttpRequest,b=function(){_.abort(),m.reject(new Error("Timeout"))},E=QE(b,3e4);_.onreadystatechange=function(){switch(_.readyState){case globalThis.XMLHttpRequest.DONE:XE(E);try{if(_.status===0)throw new DOMException(_.statusText,"AbortError");if(!_.responseText)throw new Error("No response body.");_.status>=400?m.reject(fm(_,_.responseText)):m.resolve(JSON.parse(_.responseText))}catch(U){if(U.name==="AbortError"){m.reject(U);return}m.reject(new Sc("request failed",U))}break}},_.upload.onprogress=U=>{var I;XE(E),p.loaded=U.loaded,p.total=U.total,E=QE(b,3e4),(I=l.progressHandler)===null||I===void 0||I.call(l,{loaded:U.loaded,total:U.total})};var M=this.getUrl("/upload",void 0,Bo.V3);c&&v&&M.searchParams.set("filename",encodeURIComponent(v)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&M.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),_.open(se.Post,M.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&_.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),_.setRequestHeader("Content-Type",h),_.send(e),d.signal.addEventListener("abort",()=>{_.abort()})}else{var O={};c&&v&&(O.filename=v);var C={"Content-Type":h};this.authedRequest(se.Post,"/upload",O,e,{prefix:Bo.V3,headers:C,abortSignal:d.signal}).then(U=>this.opts.onlyData?U:U.json()).then(m.resolve,m.reject)}return p.promise=m.promise.finally(()=>{yf(this.uploads,U=>U===p)}),d.signal.addEventListener("abort",()=>{yf(this.uploads,U=>U===p),m.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(p),p.promise}cancelUpload(e){var t=this.uploads.find(r=>r.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:Bo.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var _A=360*60*1e3,EA=30*1e3,Qw=(function(a){return a.Stable="stable",a.Unstable="unstable",a})({});class Xw{constructor(e){var t=this;this.http=e,y(this,"capabilities",void 0),y(this,"retryTimeout",void 0),y(this,"refreshTimeout",void 0),y(this,"fetchCapabilities",R(function*(){var r=yield t.http.authedRequest(se.Get,"/capabilities");return t.capabilities=r.capabilities,t.capabilities})),y(this,"poll",R(function*(){try{yield t.fetchCapabilities(),t.clearTimeouts(),t.refreshTimeout=setTimeout(t.poll,_A),T.debug("Fetched new server capabilities")}catch(n){t.clearTimeouts();var r=Math.floor(EA+Math.random()*5e3);t.retryTimeout=setTimeout(t.poll,r),T.warn("Failed to refresh capabilities: retrying in ".concat(r,"ms"),n)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}function $E(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function vu(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$E(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):$E(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var $w="10",TA=["1","2","3","4","5","6","7","8","9","10"],wA=30,pt=(function(a){return a.Highlight="highlight",a.Total="total",a})({}),Ue=(function(a){return a.MyMembership="Room.myMembership",a.Tags="Room.tags",a.AccountData="Room.accountData",a.Receipt="Room.receipt",a.Name="Room.name",a.Redaction="Room.redaction",a.RedactionCancelled="Room.redactionCancelled",a.LocalEchoUpdated="Room.localEchoUpdated",a.Timeline="Room.timeline",a.TimelineReset="Room.timelineReset",a.TimelineRefresh="Room.TimelineRefresh",a.OldStateUpdated="Room.OldStateUpdated",a.CurrentStateUpdated="Room.CurrentStateUpdated",a.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",a.UnreadNotifications="Room.UnreadNotifications",a.Summary="Room.Summary",a})({});class qf extends Fw{constructor(e,t,r){var n,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),n=this,this.roomId=e,this.client=t,this.myUserId=r,this.opts=s,y(this,"reEmitter",void 0),y(this,"txnToEvent",new Map),y(this,"notificationCounts",{}),y(this,"threadNotifications",new Map),y(this,"cachedThreadReadReceipts",new Map),y(this,"oldestThreadedReceiptTs",1/0),y(this,"unthreadedReceipts",new Map),y(this,"timelineSets",void 0),y(this,"polls",new Map),y(this,"threadsTimelineSets",[]),y(this,"filteredTimelineSets",{}),y(this,"timelineNeedsRefresh",!1),y(this,"pendingEventList",void 0),y(this,"blacklistUnverifiedDevices",void 0),y(this,"selfMembership",void 0),y(this,"summaryHeroes",null),y(this,"getTypeWarning",!1),y(this,"getVersionWarning",!1),y(this,"membersPromise",void 0),y(this,"name",void 0),y(this,"normalizedName",void 0),y(this,"tags",{}),y(this,"accountData",new Map),y(this,"summary",null),y(this,"oldState",void 0),y(this,"currentState",void 0),y(this,"relations",void 0),y(this,"threads",new Map),y(this,"visibilityEvents",new Map),y(this,"roomReceipts",new tA(this)),y(this,"threadTimelineSetsPromise",null),y(this,"threadsReady",!1),y(this,"updateThreadRootEvents",(l,c,d)=>{if(l.length){var h;if(this.updateThreadRootEvent((h=this.threadsTimelineSets)===null||h===void 0?void 0:h[0],l,c,d),l.hasCurrentUserParticipated){var v;this.updateThreadRootEvent((v=this.threadsTimelineSets)===null||v===void 0?void 0:v[1],l,c,d)}}}),y(this,"updateThreadRootEvent",(l,c,d,h)=>{l&&c.rootEvent&&(h&&l.removeEvent(c.id),Ut.hasServerSideSupport?l.addLiveEvent(c.rootEvent,{duplicateStrategy:Gu.Replace,fromCache:!1,roomState:this.currentState}):l.addEventToTimeline(c.rootEvent,l.getLiveTimeline(),{toStartOfTimeline:d}))}),y(this,"applyRedaction",l=>{if(l.isRedaction()){var c=l.event.redacts,d=c?this.findEventById(c):void 0;if(d){var h=d.threadRootId;if(d.makeRedacted(l,this),d.isState()){var v=this.currentState.getStateEvents(d.getType(),d.getStateKey());(v==null?void 0:v.getId())===d.getId()&&this.currentState.setStateEvents([d])}this.emit(Ue.Redaction,l,this,h),this.visibilityEvents.delete(c),d.isVisibilityEvent()&&this.redactVisibilityChangeEvent(l)}}}),this.setMaxListeners(100),this.reEmitter=new al(this),s.pendingEventOrdering=s.pendingEventOrdering||Zo.Chronological,this.name=e,this.normalizedName=e,this.relations=new Cw(this.client,this),this.on(Ue.Receipt,this.onReceipt),this.timelineSets=[new Lo(this,s)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[Ue.Timeline,Ue.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===Zo.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(l=>{var c=this.client.getEventMapper({toDevice:!1,decrypt:!1});l.forEach((function(){var d=R(function*(h){var v=c(h);yield t.decryptEventIfNeeded(v),v.setStatus(Ve.NOT_SENT),n.addPendingEvent(v,v.getTxnId())});return function(h){return d.apply(this,arguments)}})())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return R(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Vn.My)]);var r=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=r[0],e.threadsTimelineSets[1]=r[1],r}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return R(function*(){if(e.client.isCryptoEnabled()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),r=e.getLiveTimeline().getEvents(),n=r.findIndex(l=>l.event.event_id===t),s=r.slice(n).reverse().map(l=>e.client.decryptEventIfNeeded(l));yield Promise.allSettled(s)}})()}decryptAllEvents(){var e=this;return R(function*(){if(e.client.isCryptoEnabled()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(r=>e.client.decryptEventIfNeeded(r));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents($.RoomCreate,"");return(e=t==null?void 0:t.getSender())!==null&&e!==void 0?e:null}getVersion(){var e,t=this.currentState.getStateEvents($.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(T.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getRecommendedVersion(){var e=this;return R(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var r=t["m.room_versions"];if(!r){r={default:$w,available:{}};for(var n of TA)r.available[n]=Qw.Stable}var s=e.checkVersionAgainstCapability(r);if(s.urgent&&s.needsUpgrade){T.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(l){T.warn("Failed to refresh room version capabilities",l)}if(r=t["m.room_versions"],r)s=e.checkVersionAgainstCapability(r);else return T.warn("No room version capability - assuming upgrade required."),s}return s})()}checkVersionAgainstCapability(e){var t=this.getVersion();T.log("[".concat(this.roomId,"] Current version: ").concat(t)),T.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return r;var n=Object.keys(e.available).filter(s=>e.available[s]==="stable");return n.includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?T.warn("URGENT upgrade required on ".concat(this.roomId)):T.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent($.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=yf(this.pendingEventList,function(r){return r.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.some(n=>n.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.find(n=>n.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var r=t[t.length-1];return r.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,r=this.getLiveTimeline().getEvents(),n=r[r.length-1],s=this.getLastThread();if(!s)return n;var l=s.events[s.events.length-1];return((e=n==null?void 0:n.getTs())!==null&&e!==void 0?e:0)>((t=l==null?void 0:l.getTs())!==null&&t!==void 0?t:0)?n:l}getLastThread(){return this.getThreads().reduce((e,t)=>{var r,n;if(!e)return t;var s=t.events[t.events.length-1],l=e.events[e.events.length-1];return((r=s==null?void 0:s.getTs())!==null&&r!==void 0?r:0)>=((n=l==null?void 0:l.getTs())!==null&&n!==void 0?n:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:We.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===We.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var r;return(r=this.summaryHeroes)===null||r===void 0?void 0:r[0]}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];var r=this.currentState.getMembers(),n=r.find(s=>s.userId!==this.myUserId);return n?n.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(Tw.name,"");return Array.isArray(e==null?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),r=0;if(this.getMembers().forEach(m=>{m.membership!=="join"&&m.membership!=="invite"||t.includes(m.userId)||r++}),!(r>2)){var n=(e=this.summaryHeroes)===null||e===void 0?void 0:e.filter(m=>!t.includes(m)),s=Array.isArray(n)&&n.length;if(s){var l=n.map(m=>this.getMember(m)).find(m=>!!m);if(l)return l}var c=this.getMembers(),d=c==null?void 0:c.filter(m=>!t.includes(m.userId));if(d.length<=2){var h=d.find(m=>m.userId!==this.myUserId);if(h)return h}if(s){var v=n.map(m=>this.client.getUser(m)).find(m=>!!m);if(v){var p=new Tf(this.roomId,v.userId);return p.user=v,p}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===We.Leave&&this.cleanupAfterLeaving(),this.emit(Ue.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return R(function*(){var t=e.client.store.getSyncToken(),r=yield e.client.members(e.roomId,void 0,We.Leave,t??void 0);return r.chunk})()}loadMembers(){var e=this;return R(function*(){var t=!1,r=yield e.client.store.getOutOfBandMembers(e.roomId);(r===null||e.hasEncryptionStateEvent())&&(t=!0,r=yield e.loadMembersFromServer(),T.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(e.roomId)));var n=r.filter(zn).map(e.client.getEventMapper());return{memberEvents:n,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var r=this.currentState.getMembers().filter(s=>s.isOutOfBand()).map(s=>{var l;return(l=s.events.member)===null||l===void 0?void 0:l.event});T.log("LL: telling store to write ".concat(r.length)+" members for room ".concat(this.roomId));var n=this.client.store;return n.setOutOfBandMembers(this.roomId,r).catch(s=>{T.log("LL: storing OOB room members failed, oh well",s)})}}).catch(t=>{T.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return R(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{T.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),T.log(e)})}refreshLiveTimeline(){var e=this;return R(function*(){var t=e.getLiveTimeline(),r=t.getPaginationToken(ke.FORWARDS),n=t.getPaginationToken(ke.BACKWARDS),s=t.getEvents(),l=s[s.length-1];T.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(l&&l.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));var c=e.getUnfilteredTimelineSet(),d;l?(e.resetLiveTimeline(null,null),e.emit(Ue.TimelineRefresh,e,c),d=yield e.client.getEventTimeline(c,l.getId())):d=yield e.client.getLatestTimeline(c);var h=c.getLiveTimeline();!h||h.getPaginationToken(tt.Forward)===null&&h.getPaginationToken(tt.Backward)===null&&h.getEvents().length===0?(T.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),d.setPaginationToken(r,ke.FORWARDS),c.setLiveTimeline(d),e.fixUpLegacyTimelineFields()):T.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(Ue.TimelineRefresh,e,c)})()}resetLiveTimeline(e,t){for(var r of this.timelineSets)r.resetLiveTimeline(e??void 0,t??void 0);for(var n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(ke.BACKWARDS),this.currentState=this.getLiveTimeline().getState(ke.FORWARDS),e!==this.oldState&&this.emit(Ue.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(Ue.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[$e.Events,$e.Members,$e.NewMember,$e.Update,$e.Marker,Bt.New,Bt.Update,Bt.Destroy,Bt.LivenessChange]),this.reEmitter.reEmit(this.currentState,[$e.Events,$e.Members,$e.NewMember,$e.Update,$e.Marker,Bt.New,Bt.Update,Bt.Destroy,Bt.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],r=!1,n=e.getContent();for(var s of Object.values(n))for(var[l,c]of Object.entries(s))if(sm(l)&&c){for(var[d,h]of Object.entries(c))if(!(!h||typeof h!="object")){var v=h;d===this.client.getUserId()&&(v.thread_id===void 0?r=!0:typeof v.thread_id=="string"&&t.push(v.thread_id))}}r&&(t=this.getThreads().filter(D=>this.getThreadUnreadNotificationCount(D.id,pt.Total)>0||this.getThreadUnreadNotificationCount(D.id,pt.Highlight)>0).map(D=>D.id),t.push("main"));for(var p of t){var m,_=20,b=p==="main"?this.getLiveTimeline():(m=this.getThread(p))===null||m===void 0?void 0:m.liveTimeline;if(!b){T.warn("Couldn't find timeline for thread ID ".concat(p," in room ").concat(this.roomId));continue}for(var E=b.getEvents(),M=0,O=E.length-1;O>=0;O--){var C;if(O===E.length-_)return;var U=E[O];if(this.hasUserReadEvent(this.client.getUserId(),U.getId()))break;var I=this.client.getPushActionsForEvent(U);M+=I!=null&&(C=I.tweaks)!==null&&C!==void 0&&C.highlight?1:0}p==="main"?this.setUnreadNotificationCount(pt.Highlight,M):this.setThreadUnreadNotificationCount(p,pt.Highlight,M)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var r=this.getThreads(),n=0;n<r.length;n++){var s=r[n];if(t=s.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:pt.Total,t=this.getRoomUnreadNotificationCount(e);for(var r of this.threadNotifications.values()){var n;t+=(n=r[e])!==null&&n!==void 0?n:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:pt.Total,r=arguments.length>1?arguments[1]:void 0,n=!!r.threadRootId&&!r.isThreadRoot;return(e=n?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:pt.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:pt.Total;return(t=(r=this.threadNotifications.get(e))===null||r===void 0?void 0:r[n])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,r;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((r=e.total)!==null&&r!==void 0?r:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,s,l=vu({highlight:(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n.highlight,total:(s=this.threadNotifications.get(e))===null||s===void 0?void 0:s.total},{[t]:r});this.threadNotifications.set(e,l),this.emit(Ue.UnreadNotifications,l,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var r,n;if(((r=t.highlight)!==null&&r!==void 0?r:0)>0)return pt.Highlight;((n=t.total)!==null&&n!==void 0?n:0)>0&&!e&&(e=pt.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[r,n]of this.threadNotifications)e.includes(r)||(n.total=0,t||(n.highlight=0));this.emit(Ue.UnreadNotifications)}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(Ue.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t=e["m.heroes"],r=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(r)&&this.currentState.setJoinedMemberCount(r),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter(s=>s!==this.myUserId)),this.emit(Ue.Summary,e)}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,l=this.currentState.getStateEvents($.RoomAvatar,"");if(!l&&!s)return null;var c=l?l.getContent().url:null;return c?Kf(e,c,t,r,n):null}getMxcAvatarUrl(){var e;return((e=this.currentState.getStateEvents($.RoomAvatar,""))===null||e===void 0||(e=e.getContent())===null||e===void 0?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents($.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents($.RoomCanonicalAlias,"");return e?e.getContent().alt_aliases||[]:[]}addEventsToTimeline(e,t,r,n){r.getTimelineSet().addEventsToTimeline(e,t,r,n)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(We.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return R(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(We.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(We.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents($.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var r=this.getMember(e);return r?r.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var s=Object.assign({filter:e,pendingEvents:n},this.opts),l=new Lo(this,s);this.reEmitter.reEmit(l,[Ue.Timeline,Ue.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=l,this.timelineSets.push(l));var c=this.getLiveTimeline();if(t){c.getEvents().forEach(function(v){l.addLiveEvent(v)});for(var d=c;d.getNeighbouringTimeline(ke.BACKWARDS);)d=d.getNeighbouringTimeline(ke.BACKWARDS);l.getLiveTimeline().setPaginationToken(d.getPaginationToken(ke.BACKWARDS),ke.BACKWARDS)}else if(r){var h=c.getPaginationToken(tt.Forward);l.getLiveTimeline().setPaginationToken(h,tt.Backward)}return l}getThreadListFilter(){var e=arguments,t=this;return R(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:Vn.All,n=t.client.getUserId(),s=new $r(n),l={room:{timeline:{[Go.name]:[Ot.name]}}};r===Vn.My&&(l.room.timeline[Vo.name]=[n]),s.setDefinition(l);var c=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(r),s);return s.filterId=c,s})()}createThreadTimelineSet(e){var t=this;return R(function*(){var r;if(Ut.hasServerSideListSupport)r=new Lo(t,vu(vu({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Vn.All),t.reEmitter.reEmit(r,[Ue.Timeline,Ue.TimelineReset]);else if(Ut.hasServerSideSupport){var n=yield t.getThreadListFilter(e);r=t.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else r=new Lo(t,{pendingEvents:!1}),Array.from(t.threads).forEach(s=>{var[,l]=s;if(l.length!==0){var c=l.timeline.some(d=>d.getSender()===t.client.getUserId());(e!==Vn.My||c)&&r.getLiveTimeline().addEvent(l.rootEvent,{toStartOfTimeline:!1})}});return r})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var r of e)ke.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}fetchRoomThreads(){var e=this;return R(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(Ut.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Vn.All),e.fetchRoomThreadList(Vn.My)]);else{var t=yield e.getThreadListFilter(),{chunk:r}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,tt.Backward,t);if(!r.length)return;var n=r.map(e.client.getEventMapper()).sort((m,_)=>{var b=m.getServerAggregatedRelation(Ot.name),E=_.getServerAggregatedRelation(Ot.name);return b.latest_event.origin_server_ts-E.latest_event.origin_server_ts}),s,l=e.getLiveTimeline().getState(ke.FORWARDS);for(var c of n){var d,h={duplicateStrategy:Gu.Ignore,fromCache:!1,roomState:l};(d=e.threadsTimelineSets[0])===null||d===void 0||d.addLiveEvent(c,h);var v=c.getServerAggregatedRelation(Ot.name);if(v!=null&&v.current_user_participated){var p;(p=e.threadsTimelineSets[1])===null||p===void 0||p.addLiveEvent(c,h),s=c}}e.processThreadRoots(n,!0),e.client.decryptEventIfNeeded(n[n.length-1]),s&&e.client.decryptEventIfNeeded(s)}e.on(Br.NewReply,e.onThreadReply),e.on(Br.Update,e.onThreadUpdate),e.on(Br.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return R(function*(){for(var r of e)try{if(!r.isEncrypted()&&!Vw(r))continue;yield t.client.decryptEventIfNeeded(r),t.processPollEvent(r)}catch(n){T.warn("Error processing poll event",r.getId(),n)}})()}processPollEvent(e){var t=this;return R(function*(){if(e.isDecryptionFailure()){e.once(ct.Decrypted,l=>{t.processPollEvent(l)});return}if(tn.M_POLL_START.matches(e.getType())){try{var r=new qw(e,t.client,t);t.polls.set(e.getId(),r),t.emit(Da.New,r),e.once(ct.BeforeRedaction,l=>{t.polls.delete(l.getId())})}catch{}return}var n=e.relationEventId;if(n&&t.polls.has(n)){var s=t.polls.get(n);s==null||s.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return R(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var r=e===Vn.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:n,end:s}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,tt.Backward,r.threadListType,r.getFilter());if(r.getLiveTimeline().setPaginationToken(s??null,tt.Backward),!!n.length){var l=n.map(t.client.getEventMapper());t.processThreadRoots(l,!0);var c=t.getLiveTimeline().getState(ke.FORWARDS);for(var d of l)r.addLiveEvent(d,{duplicateStrategy:Gu.Replace,fromCache:!1,roomState:c})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var r=this.getTimelineForEvent(e.id),n=r==null||(t=r.getEvents())===null||t===void 0?void 0:t.find(l=>l.getId()===e.id);n?e.clearEventMetadata(n):T.debug("onThreadDelete: Could not find root event in room timeline");for(var s of this.threadsTimelineSets)s.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){var n;if(!((n=this.client)!==null&&n!==void 0&&n.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||r!=null&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var s=e.isRelation(Ot.name),l=e.getAssociatedId(),c=e.threadRootId;if(l&&!s&&(c===l||r!=null&&r.has(l)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var d;if(l){var h;d=(h=this.findEventById(l))!==null&&h!==void 0?h:t==null?void 0:t.find(v=>v.getId()===l)}return d&&!s?this.eventShouldLiveIn(d,t,r):c!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:c}:!l||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getThread(e);if(n)n.addEvents(t,r);else{var s,l=(s=this.findEventById(e))!==null&&s!==void 0?s:t.find(c=>c.getId()===e);this.createThread(e,l,t,r)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);var r={};for(var n of e){var s,{threadId:l,shouldLiveInThread:c}=this.eventShouldLiveIn(n);c&&!r[l]&&(r[l]=[]),(s=r[l])===null||s===void 0||s.push(n)}Object.entries(r).map(d=>{var[h,v]=d;return this.addThreadedEvents(h,v,t)})}createThread(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],s=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var l=this.relations.getAllChildEventsForEvent(t.getId());l!=null&&l.length&&(n=n.concat(l.filter(d=>!d.isRelation(Ht.Replace))))}var c=new Ut(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(r=this.cachedThreadReadReceipts.get(e))!==null&&r!==void 0?r:[]});return this.reEmitter.reEmit(c,[Br.Delete,Br.Update,Br.NewReply,Ue.Timeline,Ue.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(c.id,c),c.addEvents(n,!1),this.threadsReady&&c.initialEventsFetched&&this.updateThreadRootEvents(c,s,!1),this.emit(Br.New,c,s),c}processLiveEvent(e){this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[r,n]of this.txnToEvent)if(n.getId()===e.getId()){T.debug("processLiveEvent: found sent event without txn ID: ",r,e.getId());var s=e.getUnsigned();s.transaction_id=r,e.setUnsigned(s);break}}}addLiveEvent(e,t){var{duplicateStrategy:r,timelineWasEmpty:n,fromCache:s}=t;for(var l of this.timelineSets)l.addLiveEvent(e,{duplicateStrategy:r,fromCache:s,timelineWasEmpty:n});e.sender&&e.getType()!==$.RoomRedaction&&this.addReceipt(jw(e.sender.userId,e,xr.Read),!0)}addPendingEvent(e,t){if(e.status!==Ve.SENDING&&e.status!==Ve.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(ke.setEventMetadata(e,this.getLiveTimeline().getState(ke.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(l=>l.status===Ve.NOT_SENT)&&(T.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(Ve.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this.pendingEventList.find(l=>l.getId()===r);!n&&r&&(n=this.findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit(Ue.Redaction,e,this,n.threadRootId))}}else for(var s of this.timelineSets)s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.addEventToTimeline(e,s.getLiveTimeline(),{toStartOfTimeline:!1}):s.addEventToTimeline(e,s.getLiveTimeline(),{toStartOfTimeline:!1});this.emit(Ue.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>vu(vu({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var r=t.type===$.RoomMessageEncrypted,n=this.hasEncryptionStateEvent();return r||!n});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var r=t.getId(),n=e.getId(),s=t.status;T.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(s)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:l,threadId:c}=this.eventShouldLiveIn(e),d=c?this.getThread(c):null;if(d==null||d.setEventMetadata(t),d==null||d.timelineSet.handleRemoteEcho(t,r,n),l)for(var h of this.timelineSets)h.handleRemoteEcho(t,r,n);this.emit(Ue.LocalEchoUpdated,t,this,r,s)}updatePendingEvent(e,t,r){if(T.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==Ve.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==Ve.SENT){var n=this.getTimelineForEvent(r);if(n){var s=this.findEventById(r),l=s==null?void 0:s.getUnsigned().transaction_id;if(!l&&s){var c=s.getUnsigned();c.transaction_id=e.getTxnId(),s.setUnsigned(c),this.removeEvent(s.getId()),this.handleRemoteEcho(s,e)}return}}var d=e.status,h=e.getId();if(!d)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var v=RA[d];if(!(v!=null&&v.includes(t)))throw new Error("Invalid EventStatus transition ".concat(d,"->").concat(t));if(e.setStatus(t),t==Ve.SENT){e.replaceLocalEventId(r);var{shouldLiveInRoom:p,threadId:m}=this.eventShouldLiveIn(e),_=m?this.getThread(m):void 0;if(_==null||_.setEventMetadata(e),_==null||_.timelineSet.replaceEventId(h,r),p)for(var b of this.timelineSets)b.replaceEventId(h,r)}else if(t==Ve.CANCELLED){if(this.pendingEventList){var E=this.getPendingEvent(h);this.removePendingEvent(h),E!=null&&E.isRedaction()&&this.revertRedactionLocalEcho(E)}this.removeEvent(h)}this.savePendingEvents(),this.emit(Ue.LocalEchoUpdated,e,this,h,d)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(Ue.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(ke.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(ke.FORWARDS)+")");if(t.getNeighbouringTimeline(ke.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var r=this;return R(function*(){var{duplicateStrategy:n,fromCache:s,timelineWasEmpty:l=!1}=t??{};if(n&&["replace","ignore"].indexOf(n)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");r.assertTimelineSetsAreLive();var c=r.findThreadRoots(e),d={},h={duplicateStrategy:n,fromCache:s,timelineWasEmpty:l},v=[...e];for(var p of e){var m;if(r.processLiveEvent(p),p.getUnsigned().transaction_id){var _=r.txnToEvent.get(p.getUnsigned().transaction_id);if(_){r.handleRemoteEcho(p,_);continue}}var{shouldLiveInRoom:b,shouldLiveInThread:E,threadId:M=""}=r.eventShouldLiveIn(p,v,c);if(!E&&!b&&p.isRelation())try{var O=new _r(yield r.client.fetchRoomEvent(r.roomId,p.relationEventId));if(v.push(O),O.threadRootId){c.add(O.threadRootId);var C=p.getUnsigned();C[Ef.name]=O.threadRootId,p.setUnsigned(C)}({shouldLiveInRoom:b,shouldLiveInThread:E,threadId:M=""}=r.eventShouldLiveIn(p,v,c))}catch(U){T.error("Failed to load parent event of unhandled relation",U)}E&&!d[M]&&(d[M]=[]),(m=d[M])===null||m===void 0||m.push(p),b?r.addLiveEvent(p,h):!E&&p.isRelation()&&r.relations.aggregateChildEvent(p)}Object.entries(d).forEach(U=>{var[I,D]=U;r.addThreadedEvents(I,D,!1)})})()}partitionThreadedEvents(e){var t=0,r=1,n=2;if(this.client.supportsThreads()){var s=this.findThreadRoots(e);return e.reduce((l,c)=>{var{shouldLiveInRoom:d,shouldLiveInThread:h,threadId:v}=this.eventShouldLiveIn(c,e,s);return d&&l[t].push(c),h&&(c.setThreadId(v??""),l[r].push(c)),!h&&!d&&l[n].push(c),l},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var r of e){var n=r.threadRootId;n!=null&&t.add(n)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach(n=>{Object.keys(r[n]).forEach(s=>{Object.keys(r[n][s]).forEach(l=>{var c,d,h,v=r[n][s][l],p=!v.thread_id||v.thread_id===yc,m=p?this:this.threads.get((c=v.thread_id)!==null&&c!==void 0?c:"");if(m){if(m.addReceiptToStructure(n,s,l,v,t),!t&&this.client.isInitialSyncComplete()&&l===this.client.getUserId()){var _=m.timeline[m.timeline.length-1];_&&n===_.getId()&&l===_.getSender()&&(m.setUnread(pt.Total,0),m.setUnread(pt.Highlight,0))}}else{var b;this.cachedThreadReadReceipts.set(v.thread_id,[...(b=this.cachedThreadReadReceipts.get(v.thread_id))!==null&&b!==void 0?b:[],{eventId:n,receiptType:s,userId:l,receipt:v,synthetic:t}])}var E=this.client.getUserId();l===E&&!p&&v.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=v.ts),!v.thread_id&&v.ts>((d=(h=this.unthreadedReceipts.get(l))===null||h===void 0?void 0:h.ts)!==null&&d!==void 0?d:0)&&this.unthreadedReceipts.set(l,v)})})}),this.emit(Ue.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===$.Typing?this.currentState.setTypingEvent(t):t.getType()===$.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var r of this.timelineSets){var n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents($.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===We.Invite){var r=e.getUnsigned().invite_room_state||[];r.forEach(s=>{var l=this.currentState.getStateEvents(s.type,s.state_key);l||this.currentState.setStateEvents([new _r({type:s.type,state_key:s.state_key,content:s.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var n=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=_k(this.name),this.summary=new Iw(this.roomId,{title:this.name}),n!==this.name&&this.emit(Ue.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(Ue.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var r=t.getType(),n=this.accountData.get(r);this.accountData.set(r,t),this.emit(Ue.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===We.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent($.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent($.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===We.Join,r=this.currentState.getStateEvents($.RoomPowerLevels,""),n=r&&r.getContent(),s=this.getMember(e);return n&&s&&n.invite>s.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents($.RoomCreate,"");if(!e){this.getTypeWarning||(T.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[_f]}isSpaceRoom(){return this.getType()===xo.Space}isCallRoom(){return this.getType()===xo.UnstableCall}isElementVideoRoom(){return this.getType()===xo.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(ke.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case ii.Actual:return e.name;case ii.Generated:switch(e.subtype){case"Inviting":return"Inviting ".concat(ZE(e.names,e.count));default:return ZE(e.names,e.count)}case ii.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var r=this.currentState.getStateEvents($.RoomName,"");if(r!=null&&r.getContent().name)return this.roomNameGenerator({type:ii.Actual,name:r.getContent().name})}var n=this.getCanonicalAlias();if(n)return this.roomNameGenerator({type:ii.Actual,name:n});var s=this.currentState.getJoinedMemberCount(),l=this.currentState.getInvitedMemberCount(),c=s+l-1,d=this.getFunctionalMembers(),h=[];if(this.summaryHeroes)this.summaryHeroes.forEach(O=>{if(d.includes(O)){c--;return}var C=this.getMember(O);h.push(C?C.name:O)});else{var v=this.currentState.getMembers().filter(O=>O.userId!==e&&(O.membership===We.Invite||O.membership===We.Join));v=v.filter(O=>{var{userId:C}=O;return d.includes(C)?(c--,!1):!0});var p=new Intl.Collator;v.sort((O,C)=>p.compare(O.userId,C.userId)),v=v.slice(0,5),h=v.map(O=>O.name)}if(c)return this.roomNameGenerator({type:ii.Generated,names:h,count:c});var m=this.getMyMembership();if(m==We.Join){var _=this.currentState.getStateEvents($.RoomThirdPartyInvite);if(_!=null&&_.length){var b=_.map(O=>O.getContent().display_name);return this.roomNameGenerator({type:ii.Generated,subtype:"Inviting",names:b,count:b.length+1})}}var E=h;E.length||(E=this.currentState.getMembers().filter(O=>O.userId!==e&&O.membership!==We.Invite&&O.membership!==We.Join).map(O=>O.name));var M;return E.length&&(M=this.roomNameGenerator({type:ii.Generated,names:E,count:E.length+1})),this.roomNameGenerator({type:ii.EmptyRoom,oldName:M})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var r=e.getSender();if(r){var n=Is.name&&this.currentState.maySendStateEvent(Is.name,r)||Is.altName&&this.currentState.maySendStateEvent(Is.altName,r);if(n){var s=this.visibilityEvents.get(t.eventId);if(s){for(var l=s.length-1,c=Math.max(0,s.length-wA);l>=c;--l){var d=s[l];if(d.getTs()<e.getTs())break}l===-1?s.unshift(e):s.splice(l+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var h=this.findEventById(t.eventId);h&&h.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),r=t==null?void 0:t.event_id,n=this.visibilityEvents.get(r);if(n){var s=n.findIndex(h=>h.getId()===e.getId());if(s!==-1&&(n.splice(s,1),s===n.length)){var l=this.findEventById(r);if(!l)return;if(s===0)this.visibilityEvents.delete(r),l.applyVisibilityEvent();else{var c=n[n.length-1],d=c.asVisibilityChange();if(!d)throw new Error("at this stage, visibility changes should be well-formed");l.applyVisibilityEvent(d)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,!(r.getTs()<e.getTs())&&e.applyVisibilityEvent(n))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(n=>this.getThreadUnreadNotificationCount(n.id,pt.Total)>0);for(var r of t)r.fixupNotifications(e)}compareEventOrdering(e,t){return lA(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(ke.FORWARDS))===null||e===void 0)&&e.getStateEvents($.RoomEncryption,""))}}var RA={[Ve.ENCRYPTING]:[Ve.SENDING,Ve.NOT_SENT,Ve.CANCELLED],[Ve.SENDING]:[Ve.ENCRYPTING,Ve.QUEUED,Ve.NOT_SENT,Ve.SENT],[Ve.QUEUED]:[Ve.SENDING,Ve.NOT_SENT,Ve.CANCELLED],[Ve.SENT]:[],[Ve.NOT_SENT]:[Ve.SENDING,Ve.QUEUED,Ve.CANCELLED],[Ve.CANCELLED]:[]},ii=(function(a){return a[a.EmptyRoom=0]="EmptyRoom",a[a.Generated=1]="Generated",a[a.Actual=2]="Actual",a})({});function ZE(a,e){var t=e-1;if(a.length){if(a.length===1&&t<=1)return a[0];if(a.length===2&&t<=2)return"".concat(a[0]," and ").concat(a[1]);var r=t>1;return r?"".concat(a[0]," and ").concat(t," others"):"".concat(a[0]," and 1 other")}else return"Empty room"}var cr=(function(a){return a[a.Stable=0]="Stable",a[a.Unstable=1]="Unstable",a[a.Unsupported=2]="Unsupported",a})({}),fr=(function(a){return a.Thread="Thread",a.ThreadUnreadNotifications="ThreadUnreadNotifications",a.LoginTokenRequest="LoginTokenRequest",a.RelationBasedRedactions="RelationBasedRedactions",a.AccountDataDeletion="AccountDataDeletion",a.RelationsRecursion="RelationsRecursion",a.IntentionalMentions="IntentionalMentions",a})({}),CA={[fr.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[fr.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[fr.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[fr.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[fr.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[fr.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"]},[fr.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function IA(a){return hp.apply(this,arguments)}function hp(){return hp=R(function*(a){var e=new Map;for(var[t,r]of Object.entries(CA)){var n,s,l,c,d=(n=(s=a.versions)===null||s===void 0?void 0:s.includes(r.matrixVersion||""))!==null&&n!==void 0?n:!1,h=(l=(c=r.unstablePrefixes)===null||c===void 0?void 0:c.every(v=>{var p;return((p=a.unstable_features)===null||p===void 0?void 0:p[v])===!0}))!==null&&l!==void 0?l:!1;d?e.set(t,cr.Stable):h?e.set(t,cr.Unstable):e.set(t,cr.Unsupported)}return e}),hp.apply(this,arguments)}function e0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Rf(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?e0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):e0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var t0=80*1e3,OA=3,bt=(function(a){return a.Error="ERROR",a.Prepared="PREPARED",a.Stopped="STOPPED",a.Syncing="SYNCING",a.Catchup="CATCHUP",a.Reconnecting="RECONNECTING",a})({}),kA=["org.matrix.msc2716v3"];function r0(a,e){return"FILTER_SYNC_".concat(a)+(e?"_"+e:"")}function Ft(){T.log(...arguments)}var Zw=(function(a){return a.Offline="offline",a.Online="online",a.Unavailable="unavailable",a})({});function eR(a){return Rf({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:Zo.Chronological,threadSupport:!1},a)}function tR(a){return Rf({canResetEntireTimeline:e=>!1},a)}class Bu{constructor(e,t,r){var n=this;this.client=e,y(this,"opts",void 0),y(this,"syncOpts",void 0),y(this,"_peekRoom",null),y(this,"currentSyncRequest",void 0),y(this,"abortController",void 0),y(this,"syncState",null),y(this,"syncStateData",void 0),y(this,"catchingUp",!1),y(this,"running",!1),y(this,"keepAliveTimer",void 0),y(this,"connectionReturnedDefer",void 0),y(this,"notifEvents",[]),y(this,"failedSyncCount",0),y(this,"storeIsInvalid",!1),y(this,"presence",void 0),y(this,"getPushRules",R(function*(){try{Ft("Getting push rules...");var s=yield n.client.getPushRules();Ft("Got push rules"),n.client.pushRules=s}catch(l){return T.error("Getting push rules failed",l),n.shouldAbortSync(l)?void 0:(Ft("Waiting for saved sync before retrying push rules..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,l),n.getPushRules())}})),y(this,"buildDefaultFilter",()=>{var s=new $r(this.client.credentials.userId);return this.client.canSupport.get(fr.ThreadUnreadNotifications)!==cr.Unsupported&&s.setUnreadThreadNotifications(!0),s}),y(this,"prepareLazyLoadingForSync",R(function*(){if(Ft("Prepare lazy loading for sync..."),n.client.isGuest()&&(n.opts.lazyLoadMembers=!1),n.opts.lazyLoadMembers&&(Ft("Enabling lazy load on sync filter..."),n.opts.filter||(n.opts.filter=n.buildDefaultFilter()),n.opts.filter.setLazyLoadMembers(!0)),n.opts.lazyLoadMembers){var s;(s=n.syncOpts.crypto)===null||s===void 0||s.enableLazyLoading()}})),y(this,"storeClientOptions",R(function*(){try{Ft("Storing client options..."),yield n.client.storeClientOptions(),Ft("Stored client options")}catch(s){throw T.error("Storing client options failed",s),s}})),y(this,"getFilter",R(function*(){Ft("Getting filter...");var s;n.opts.filter?s=n.opts.filter:s=n.buildDefaultFilter();var l;try{l=yield n.client.getOrCreateFilter(r0(n.client.credentials.userId),s)}catch(c){return T.error("Getting filter failed",c),n.shouldAbortSync(c)?{}:(Ft("Waiting for saved sync before retrying filter..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,c),n.getFilter())}return{filter:s,filterId:l}})),y(this,"savedSyncPromise",void 0),y(this,"onOnline",()=>{Ft("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=eR(t),this.syncOpts=tR(r),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[Ue.Timeline,Ue.TimelineReset])}createRoom(e){var t=rR(this.client,e,this.opts);return t.on($e.Marker,(r,n)=>{this.onMarkerStateEvent(t,r,n)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:r}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(r){T.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var n=kA.includes(e.getVersion())||t.getSender()===e.getCreator();n?(T.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(Ue.HistoryImportedWithinTimeline,t,e)):T.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return R(function*(){var t,r=e.client,n=new $r(e.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);var s=e.opts.pollTimeout+t0,l=yield r.getOrCreateFilter(r0(r.credentials.userId,"LEFT_ROOMS"),n),c={timeout:0,filter:l},d=yield r.http.authedRequest(se.Get,"/sync",c,void 0,{localTimeoutMs:s}),h=[];(t=d.rooms)!==null&&t!==void 0&&t.leave&&(h=e.mapSyncResponseToRoomArray(d.rooms.leave));var v=yield Promise.all(h.map((function(){var p=R(function*(m){var _=m.room;if(m.isBrandNewRoom){m.timeline=m.timeline||{prev_batch:null,events:[]};var b=e.mapSyncEventsFormat(m.timeline,_),E=e.mapSyncEventsFormat(m.state,_);return _.getLiveTimeline().setPaginationToken(m.timeline.prev_batch,ke.BACKWARDS),yield e.injectRoomEvents(_,E,b),_.recalculate(),r.store.storeRoom(_),r.emit(Pe.Room,_),e.processEventsForNotifs(_,b),_}});return function(m){return p.apply(this,arguments)}})()));return v.filter(Boolean)})()}peek(e){var t,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var n=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,r).then(s=>{var l;if(((l=this._peekRoom)===null||l===void 0?void 0:l.roomId)!==e)throw new Error("Peeking aborted");s.messages=s.messages||{chunk:[]},s.messages.chunk=s.messages.chunk||[],s.state=s.state||[];var c=xf(s.state).map(n.getEventMapper()),d=s.state.map(n.getEventMapper()),h=s.messages.chunk.map(n.getEventMapper());return Array.isArray(s.presence)&&s.presence.map(n.getEventMapper()).forEach(function(v){var p=n.store.getUser(v.getContent().user_id);p?p.setPresenceEvent(v):(p=Wi.createUser(v.getContent().user_id,n),p.setPresenceEvent(v),n.store.storeUser(p)),n.emit(Pe.Event,v)}),s.messages.start&&(this._peekRoom.oldState.paginationToken=s.messages.start),this._peekRoom.oldState.setStateEvents(c),this._peekRoom.currentState.setStateEvents(d),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(h.reverse(),!0,this._peekRoom.getLiveTimeline(),s.messages.start),n.store.storeRoom(this._peekRoom),n.emit(Pe.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var r,n=this;if(this._peekRoom!==e){Ft("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(se.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal}).then((function(){var s=R(function*(l){if(n._peekRoom!==e){Ft("Stopped peeking in room %s",e.roomId);return}l.chunk.filter(function(d){return d.type==="m.presence"}).map(n.client.getEventMapper()).forEach(d=>{var h=n.client.store.getUser(d.getContent().user_id);h?h.setPresenceEvent(d):(h=Wi.createUser(d.getContent().user_id,n.client),h.setPresenceEvent(d),n.client.store.storeUser(h)),n.client.emit(Pe.Event,d)});var c=l.chunk.filter(function(d){return d.room_id===e.roomId&&d.event_id}).map(n.client.getEventMapper());yield e.addLiveEvents(c),n.peekPoll(e,l.end)});return function(l){return s.apply(this,arguments)}})(),s=>{T.error("[%s] Peek poll failed: %s",e.roomId,s),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var r=this;return R(function*(){yield e;var n=r.startKeepAlives();r.updateSyncState(bt.Error,{error:t}),yield n})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(T.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(bt.Error,{error:e}),!0):!1}sync(){var e=this;return R(function*(){var t,r;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(r=t.addEventListener)===null||r===void 0||r.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});Ft("Getting saved sync token...");var n=e.client.store.getSavedSyncToken().then(v=>(Ft("Got saved sync token"),v));e.savedSyncPromise=e.client.store.getSavedSync().then(v=>{if(Ft("Got reply from saved sync, exists? ".concat(!!v)),v)return e.syncFromCache(v)}).catch(v=>{T.error("Getting saved sync failed",v)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:s,filter:l}=yield e.getFilter();if(l){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var c=s,d=yield n;if(d)Ft("Sending first sync request...");else{Ft("Sending initial sync request...");var h=e.buildDefaultFilter();h.setDefinition(l.getDefinition()),h.setTimelineLimit(e.opts.initialSyncLimit),c=JSON.stringify(h.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:c},d)}return Ft("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:s})}})()}stop(){var e,t,r;Ft("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(r=this.abortController)===null||r===void 0||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedDefer?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return R(function*(){Ft("sync(): not doing HTTP hit, instead returning stored /sync data");var r=e.nextBatch;t.client.store.setSyncToken(r);var n={nextSyncToken:r,catchingUp:!1,fromCache:!0},s={next_batch:r,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(n,s)}catch(l){T.error("Error processing cached sync",l)}t.storeIsInvalid||t.updateSyncState(bt.Prepared,n)})()}doSync(e){var t=this;return R(function*(){for(;t.running;){var r=t.client.store.getSyncToken(),n=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,r)),n=yield t.currentSyncRequest}catch(c){var s=yield t.onSyncError(c);if(s)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(n.next_batch),t.failedSyncCount=0;var l={oldSyncToken:r??void 0,nextSyncToken:n.next_batch,catchingUp:t.catchingUp};t.syncOpts.crypto&&(yield t.syncOpts.crypto.onSyncWillProcess(l));try{yield t.processSyncResponse(l,n)}catch(c){T.error("Caught /sync error",c),t.client.emit(Pe.SyncUnexpectedError,c)}yield t.client.store.setSyncData(n),l.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(bt.Prepared,l),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(l)),t.updateSyncState(bt.Syncing,l),t.client.store.wantsSave()&&(t.syncOpts.crypto&&(yield t.syncOpts.crypto.saveDeviceList(0)),yield t.client.store.save())}t.running||(Ft("Sync no longer running: exiting."),t.connectionReturnedDefer&&(t.connectionReturnedDefer.reject(),t.connectionReturnedDefer=void 0),t.updateSyncState(bt.Stopped))})()}doSyncRequest(e,t){var r,n=this.getSyncParams(e,t);return this.client.http.authedRequest(se.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+t0,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal})}getSyncParams(e,t){var r=this.opts.pollTimeout;(this.getSyncState()!==bt.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);var n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());var s={filter:n,timeout:r};return this.opts.disablePresence?s.set_presence=Zw.Offline:this.presence!==void 0&&(s.set_presence=this.presence),t?s.since=t:s._cacheBuster=Date.now(),[bt.Reconnecting,bt.Error].includes(this.getSyncState())&&(s.timeout=0),s}setPresence(e){this.presence=e}onSyncError(e){var t=this;return R(function*(){if(!t.running)return Ft("Sync no longer running: exiting"),t.connectionReturnedDefer&&(t.connectionReturnedDefer.reject(),t.connectionReturnedDefer=void 0),t.updateSyncState(bt.Stopped),!0;if(T.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,T.log("Number of consecutive failed sync requests:",t.failedSyncCount),Ft("Starting keep-alive");var r=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=OA?bt.Error:bt.Reconnecting,{error:e});var n=yield r;return n&&t.getSyncState()===bt.Error&&t.updateSyncState(bt.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var r=this;return R(function*(){var n,s,l,c,d=r.client;if(Array.isArray((n=t.presence)===null||n===void 0?void 0:n.events)&&t.presence.events.filter(zn).map(d.getEventMapper()).forEach(function(O){var C=d.store.getUser(O.getSender());C?C.setPresenceEvent(O):(C=Wi.createUser(O.getSender(),d),C.setPresenceEvent(O),d.store.storeUser(C)),d.emit(Pe.Event,O)}),Array.isArray((s=t.account_data)===null||s===void 0?void 0:s.events)){var h=t.account_data.events.filter(zn).map(d.getEventMapper()),v=h.reduce((O,C)=>(O[C.getType()]=d.store.getAccountData(C.getType()),O),{});d.store.storeAccountDataEvents(h),h.forEach(function(O){if(O.getType()===$.PushRules){var C=O.getContent();d.setPushRules(C)}var U=v[O.getType()];return d.emit(Pe.AccountData,O,U),O})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var p=t.to_device.events.filter(zn);r.syncOpts.cryptoCallbacks&&(p=yield r.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(p));var m=[];p.map(d.getEventMapper({toDevice:!0})).map(O=>{if(O.getType()==="m.key.verification.cancel"){var C=O.getContent().transaction_id;C&&m.push(C)}return O}).forEach(function(O){var C=O.getContent();if(O.getType()=="m.room.message"&&C.msgtype=="m.bad.encrypted"){T.log("Ignoring undecryptable to-device event from "+O.getSender());return}if(O.getType()==="m.key.verification.start"||O.getType()==="m.key.verification.request"){var U=C.transaction_id;m.includes(U)&&O.flagCancelled()}d.emit(Pe.ToDeviceEvent,O)})}else r.catchingUp=!1;var _=[],b=[],E=[],M=[];t.rooms&&(t.rooms.invite&&(_=r.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(b=r.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(E=r.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(M=r.mapSyncResponseToRoomArray(t.rooms.knock))),r.notifEvents=[],yield Po(_,(function(){var O=R(function*(C){var U,I=C.room,D=r.mapSyncEventsFormat(C.invite_state,I);yield r.injectRoomEvents(I,D);var w=(U=I.currentState.getStateEvents($.RoomMember,d.getUserId()))===null||U===void 0?void 0:U.getSender(),N=d.crypto;if(N){var A=yield N.cryptoStore.takeParkedSharedHistory(I.roomId);for(var K of A)K.senderId===w&&(yield N.olmDevice.addInboundGroupSession(I.roomId,K.senderKey,K.forwardingCurve25519KeyChain,K.sessionId,K.sessionKey,K.keysClaimed,!0,{sharedHistory:!0,untrusted:!0}))}C.isBrandNewRoom?(I.recalculate(),d.store.storeRoom(I),d.emit(Pe.Room,I)):I.recalculate(),D.forEach(function(z){d.emit(Pe.Event,z)})});return function(C){return O.apply(this,arguments)}})()),yield Po(b,(function(){var O=R(function*(C){var U,I=C.room,D=r.mapSyncEventsFormat(C.state,I),w=r.mapSyncEventsFormat(C.timeline,I,!1),N=r.mapSyncEventsFormat(C.ephemeral),A=r.mapSyncEventsFormat(C.account_data),K=r.isRoomEncrypted(I,D,w);if(C.unread_notifications){if(!K||C.unread_notifications.notification_count===0){var z;I.setUnreadNotificationCount(pt.Total,(z=C.unread_notifications.notification_count)!==null&&z!==void 0?z:0)}if(!K||I.getUnreadNotificationCount(pt.Highlight)<=0){var de;I.setUnreadNotificationCount(pt.Highlight,(de=C.unread_notifications.highlight_count)!==null&&de!==void 0?de:0)}}var _e=(U=C[nc.name])!==null&&U!==void 0?U:C[nc.altName];if(_e){I.resetThreadUnreadNotificationCountFromSync(Object.keys(_e));for(var[le,Ce]of Object.entries(_e)){if(!K||Ce.notification_count===0){var V;I.setThreadUnreadNotificationCount(le,pt.Total,(V=Ce.notification_count)!==null&&V!==void 0?V:0)}var B=I.getThreadUnreadNotificationCount(le,pt.Highlight)<=0;if(!K||K&&B){var te;I.setThreadUnreadNotificationCount(le,pt.Highlight,(te=Ce.highlight_count)!==null&&te!==void 0?te:0)}}}else I.resetThreadUnreadNotificationCountFromSync();if(C.timeline=C.timeline||{},C.isBrandNewRoom)C.timeline.prev_batch!==null&&I.getLiveTimeline().setPaginationToken(C.timeline.prev_batch,ke.BACKWARDS);else if(C.timeline.limited){for(var he=!0,be=w.length-1;be>=0;be--){var De=w[be].getId();if(I.getTimelineForEvent(De)){Ft("Already have event ".concat(De," in limited sync - not resetting")),he=!1,w.splice(0,be);break}}if(he){var W;I.resetLiveTimeline(C.timeline.prev_batch,r.syncOpts.canResetEntireTimeline(I.roomId)?null:(W=e.oldSyncToken)!==null&&W!==void 0?W:null),d.resetNotifTimelineSet()}}if(r.syncOpts.cryptoCallbacks)for(var ue of D.concat(w))ue.isState()&&ue.getType()===$.RoomEncryption&&ue.getStateKey()===""&&(yield r.syncOpts.cryptoCallbacks.onCryptoEvent(I,ue));try{yield r.injectRoomEvents(I,D,w,e.fromCache)}catch(Z){T.error("Failed to process events on room ".concat(I.roomId,":"),Z)}C.summary&&I.setSummary(C.summary),I.addEphemeralEvents(N),I.addAccountData(A),I.recalculate(),C.isBrandNewRoom&&(d.store.storeRoom(I),d.emit(Pe.Room,I)),r.processEventsForNotifs(I,w);var we=Z=>d.emit(Pe.Event,Z);D.forEach(we),w.forEach(we),N.forEach(we),A.forEach(we),I.decryptCriticalEvents()});return function(C){return O.apply(this,arguments)}})()),yield Po(E,(function(){var O=R(function*(C){var U=C.room,I=r.mapSyncEventsFormat(C.state,U),D=r.mapSyncEventsFormat(C.timeline,U),w=r.mapSyncEventsFormat(C.account_data);yield r.injectRoomEvents(U,I,D),U.addAccountData(w),U.recalculate(),C.isBrandNewRoom&&(d.store.storeRoom(U),d.emit(Pe.Room,U)),r.processEventsForNotifs(U,D),I.forEach(function(N){d.emit(Pe.Event,N)}),D.forEach(function(N){d.emit(Pe.Event,N)}),w.forEach(function(N){d.emit(Pe.Event,N)})});return function(C){return O.apply(this,arguments)}})()),yield Po(M,(function(){var O=R(function*(C){var U=C.room,I=r.mapSyncEventsFormat(C.knock_state,U);yield r.injectRoomEvents(U,I),C.isBrandNewRoom?(U.recalculate(),d.store.storeRoom(U),d.emit(Pe.Room,U)):U.recalculate(),I.forEach(function(D){d.emit(Pe.Event,D)})});return function(C){return O.apply(this,arguments)}})()),e.oldSyncToken&&r.notifEvents.length&&(r.notifEvents.sort(function(O,C){return O.getTs()-C.getTs()}),r.notifEvents.forEach(function(O){var C;(C=d.getNotifTimelineSet())===null||C===void 0||C.addLiveEvent(O)})),t.device_lists&&r.syncOpts.cryptoCallbacks&&(yield r.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(l=r.syncOpts.cryptoCallbacks)===null||l===void 0?void 0:l.processKeyCounts(t.device_one_time_keys_count,(c=t.device_unused_fallback_key_types)!==null&&c!==void 0?c:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=qa()),this.connectionReturnedDefer.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject("SyncApi.stop() was called"),this.connectionReturnedDefer=void 0);return}var r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(t),this.connectionReturnedDefer=void 0)};this.client.http.request(se.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{r()},n=>{n.httpStatus==400||n.httpStatus==404?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(bt.Error,{error:n}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(r=>!Vu(r)).map(r=>{var n=t.store.getRoom(r),s=!1;return n||(n=this.createRoom(r),s=!0),Rf(Rf({},e[r]),{},{room:n,isBrandNewRoom:s})})}mapSyncEventsFormat(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.filter(zn).map(function(s){return t&&(s.room_id=t.roomId),n(s)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(We.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),s;n?s=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):s=t.getProfileInfo(r.userId),s.then(function(l){var c=r.events.member;(c==null?void 0:c.getContent().membership)===We.Invite&&(c.getContent().avatar_url=l.avatar_url,c.getContent().displayname=l.displayname,r.setMembershipEvent(c,e.currentState))},function(l){})}})}}findEncryptionEvent(e){return e==null?void 0:e.find(t=>t.getType()===$.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t,r){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)||!!this.findEncryptionEvent(r)}injectRoomEvents(e,t,r){var n=arguments,s=this;return R(function*(){var l=n.length>3&&n[3]!==void 0?n[3]:!1,c=e.getLiveTimeline(),d=c.getEvents().length==0;if(d){for(var h of t)s.client.getPushActionsForEvent(h);c.initialiseState(t,{timelineWasEmpty:d})}s.resolveInvites(e),e.recalculate(),d||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),yield e.addLiveEvents(r||[],{fromCache:l,timelineWasEmpty:d}),s.client.processBeaconEvents(e,r)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var r of t){var n,s=this.client.getPushActionsForEvent(r);s!=null&&s.notify&&(n=s.tweaks)!==null&&n!==void 0&&n.highlight&&this.notifEvents.push(r)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(Pe.Sync,this.syncState,r,t)}}function rR(a,e,t){var{timelineSupport:r}=a,n=new qf(e,a,a.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:r});return a.reEmitter.reEmit(n,[Ue.Name,Ue.Redaction,Ue.RedactionCancelled,Ue.Receipt,Ue.Tags,Ue.LocalEchoUpdated,Ue.AccountData,Ue.MyMembership,Ue.Timeline,Ue.TimelineReset,$e.Events,$e.Members,$e.NewMember,$e.Update,Bt.New,Bt.Update,Bt.Destroy,Bt.LivenessChange]),n.on($e.NewMember,(s,l,c)=>{var d;c.user=(d=a.getUser(c.userId))!==null&&d!==void 0?d:void 0,a.reEmitter.reEmit(c,[jr.Name,jr.Typing,jr.PowerLevel,jr.Membership])}),n}class AA{constructor(){y(this,"accountData",new Map),y(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return R(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return R(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return R(function*(){return Promise.resolve()})()}destroy(){return R(function*(){})()}}const Or=[];for(let a=0;a<256;++a)Or.push((a+256).toString(16).slice(1));function DA(a,e=0){return(Or[a[e+0]]+Or[a[e+1]]+Or[a[e+2]]+Or[a[e+3]]+"-"+Or[a[e+4]]+Or[a[e+5]]+"-"+Or[a[e+6]]+Or[a[e+7]]+"-"+Or[a[e+8]]+Or[a[e+9]]+"-"+Or[a[e+10]]+Or[a[e+11]]+Or[a[e+12]]+Or[a[e+13]]+Or[a[e+14]]+Or[a[e+15]]).toLowerCase()}let Ag;const MA=new Uint8Array(16);function NA(){if(!Ag){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ag=crypto.getRandomValues.bind(crypto)}return Ag(MA)}const UA=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),n0={randomUUID:UA};function Jn(a,e,t){var n;if(n0.randomUUID&&!a)return n0.randomUUID();a=a||{};const r=a.random??((n=a.rng)==null?void 0:n.call(a))??NA();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,DA(r)}var Kn={},Dg={},Mg={exports:{}},i0;function vm(){if(i0)return Mg.exports;i0=1;var a=Mg.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(a).forEach(function(e){var t=a[e];t.forEach(function(r){r.reg||(r.reg=/(.*)/),r.format||(r.format="%s")})}),Mg.exports}var a0;function PA(){return a0||(a0=1,(function(a){var e=function(c){return String(Number(c))===c?Number(c):c},t=function(c,d,h,v){if(v&&!h)d[v]=e(c[1]);else for(var p=0;p<h.length;p+=1)c[p+1]!=null&&(d[h[p]]=e(c[p+1]))},r=function(c,d,h){var v=c.name&&c.names;c.push&&!d[c.push]?d[c.push]=[]:v&&!d[c.name]&&(d[c.name]={});var p=c.push?{}:v?d[c.name]:d;t(h.match(c.reg),p,c.names,c.name),c.push&&d[c.push].push(p)},n=vm(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);a.parse=function(c){var d={},h=[],v=d;return c.split(/(\r\n|\r|\n)/).filter(s).forEach(function(p){var m=p[0],_=p.slice(2);m==="m"&&(h.push({rtp:[],fmtp:[]}),v=h[h.length-1]);for(var b=0;b<(n[m]||[]).length;b+=1){var E=n[m][b];if(E.reg.test(_))return r(E,v,_)}}),d.media=h,d};var l=function(c,d){var h=d.split(/=(.+)/,2);return h.length===2?c[h[0]]=e(h[1]):h.length===1&&d.length>1&&(c[h[0]]=void 0),c};a.parseParams=function(c){return c.split(/;\s?/).reduce(l,{})},a.parseFmtpConfig=a.parseParams,a.parsePayloads=function(c){return c.toString().split(" ").map(Number)},a.parseRemoteCandidates=function(c){for(var d=[],h=c.split(" ").map(e),v=0;v<h.length;v+=3)d.push({component:h[v],ip:h[v+1],port:h[v+2]});return d},a.parseImageAttributes=function(c){return c.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(l,{})})},a.parseSimulcastStreamList=function(c){return c.split(";").map(function(d){return d.split(",").map(function(h){var v,p=!1;return h[0]!=="~"?v=e(h):(v=e(h.substring(1,h.length)),p=!0),{scid:v,paused:p}})})}})(Dg)),Dg}var Ng,s0;function LA(){if(s0)return Ng;s0=1;var a=vm(),e=/%[sdv%]/g,t=function(l){var c=1,d=arguments,h=d.length;return l.replace(e,function(v){if(c>=h)return v;var p=d[c];switch(c+=1,v){case"%%":return"%";case"%s":return String(p);case"%d":return Number(p);case"%v":return""}})},r=function(l,c,d){var h=c.format instanceof Function?c.format(c.push?d:d[c.name]):c.format,v=[l+"="+h];if(c.names)for(var p=0;p<c.names.length;p+=1){var m=c.names[p];c.name?v.push(d[c.name][m]):v.push(d[c.names[p]])}else v.push(d[c.name]);return t.apply(null,v)},n=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return Ng=function(l,c){c=c||{},l.version==null&&(l.version=0),l.name==null&&(l.name=" "),l.media.forEach(function(p){p.payloads==null&&(p.payloads="")});var d=c.outerOrder||n,h=c.innerOrder||s,v=[];return d.forEach(function(p){a[p].forEach(function(m){m.name in l&&l[m.name]!=null?v.push(r(p,m,l)):m.push in l&&l[m.push]!=null&&l[m.push].forEach(function(_){v.push(r(p,m,_))})})}),l.media.forEach(function(p){v.push(r("m",a.m[0],p)),h.forEach(function(m){a[m].forEach(function(_){_.name in p&&p[_.name]!=null?v.push(r(m,_,p)):_.push in p&&p[_.push]!=null&&p[_.push].forEach(function(b){v.push(r(m,_,b))})})})}),v.join(`\r
`)+`\r
`},Ng}var o0;function xA(){if(o0)return Kn;o0=1;var a=PA(),e=LA(),t=vm();return Kn.grammar=t,Kn.write=e,Kn.parse=a.parse,Kn.parseParams=a.parseParams,Kn.parseFmtpConfig=a.parseFmtpConfig,Kn.parsePayloads=a.parsePayloads,Kn.parseRemoteCandidates=a.parseRemoteCandidates,Kn.parseImageAttributes=a.parseImageAttributes,Kn.parseSimulcastStreamList=a.parseSimulcastStreamList,Kn}var vp=xA();function Kr(a){if(typeof Buffer=="function")return Buffer.from(a).toString("base64");if(typeof btoa=="function"&&a instanceof Uint8Array)return btoa(a.reduce((e,t)=>e+String.fromCharCode(t),""));throw new Error("No base64 impl found!")}function Vf(a){return Kr(a).replace(/={1,2}$/,"")}function Gf(a){return Vf(a).replace(/\+/g,"-").replace(/\//g,"_")}function Ar(a){if(typeof Buffer=="function")return Buffer.from(a,"base64");if(typeof atob=="function"){var e=function*(){for(var r=atob(a.replace(/-/g,"+").replace(/_/g,"/")),n=0;n<r.length;++n)yield r.charCodeAt(n)};return Uint8Array.from(e())}else throw new Error("No base64 impl found!")}var BA="abcdefghijklmnopqrstuvwxyz",KA="ABCDEFGHIJKLMNOPQRSTUVWXYZ",jA="0123456789";function FA(a){var e=new Uint8Array(a);return globalThis.crypto.getRandomValues(e),Gf(e)}function Qn(a){return qA(a,KA+BA+jA)}function qA(a,e){for(var t="",r=0;r<a;++r)t+=e.charAt(Math.floor(Math.random()*e.length));return t}var Ta="org.matrix.msc3077.sdp_stream_metadata",Mt=(function(a){return a.Usermedia="m.usermedia",a.Screenshare="m.screenshare",a})({}),Hu=null,gp=0,VA=()=>(Hu===null&&(Hu=new AudioContext),gp++,Hu),GA=()=>{if(gp--,gp===0){var a;(a=Hu)===null||a===void 0||a.close(),Hu=null}},HA=200,pp=-60,zA=8,ai=(function(a){return a.NewStream="new_stream",a.MuteStateChanged="mute_state_changed",a.LocalVolumeChanged="local_volume_changed",a.VolumeChanged="volume_changed",a.ConnectedChanged="connected_changed",a.Speaking="speaking",a.Disposed="disposed",a})({});class Vi extends Pt{constructor(e){super(),y(this,"stream",void 0),y(this,"sdpMetadataStreamId",void 0),y(this,"userId",void 0),y(this,"deviceId",void 0),y(this,"purpose",void 0),y(this,"speakingVolumeSamples",void 0),y(this,"client",void 0),y(this,"call",void 0),y(this,"roomId",void 0),y(this,"audioMuted",void 0),y(this,"videoMuted",void 0),y(this,"localVolume",1),y(this,"measuringVolumeActivity",!1),y(this,"audioContext",void 0),y(this,"analyser",void 0),y(this,"frequencyBinCount",void 0),y(this,"speakingThreshold",pp),y(this,"speaking",!1),y(this,"volumeLooperTimeout",void 0),y(this,"_disposed",!1),y(this,"_connected",!1),y(this,"onAddTrack",()=>{this.emit(ai.NewStream,this.stream)}),y(this,"onCallState",t=>{t===ze.Connected?this.connected=!0:t===ze.Connecting&&(this.connected=!1)}),y(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var r of this.frequencyBinCount)r>t&&(t=r);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(ai.VolumeChanged,t);var n=!1;for(var s of this.speakingVolumeSamples)if(s>this.speakingThreshold){n=!0;break}this.speaking!==n&&(this.speaking=n,this.emit(ai.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,HA)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(zA).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(et.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(ai.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(ai.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=VA()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t==null?void 0:t.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(ai.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(ai.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return T.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===Mt.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new Vi({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(et.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,GA()),this._disposed=!0,this.emit(ai.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(ai.LocalVolumeChanged,e)}}var Hi=(function(a){return a[a.Blocked=-1]="Blocked",a[a.Unverified=0]="Unverified",a[a.Verified=1]="Verified",a})({});class nR{constructor(e){y(this,"deviceId",void 0),y(this,"userId",void 0),y(this,"algorithms",void 0),y(this,"keys",void 0),y(this,"verified",void 0),y(this,"signatures",void 0),y(this,"displayName",void 0),y(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||Hi.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}class qr{static fromStorage(e,t){var r=new qr(t);for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}constructor(e){this.deviceId=e,y(this,"algorithms",[]),y(this,"keys",{}),y(this,"verified",Hi.Unverified),y(this,"known",!1),y(this,"unsigned",{}),y(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==Hi.Blocked}isVerified(){return this.verified==Hi.Verified}isUnverified(){return this.verified==Hi.Unverified}isKnown(){return this.known===!0}}y(qr,"DeviceVerification",{VERIFIED:Hi.Verified,UNVERIFIED:Hi.Unverified,BLOCKED:Hi.Blocked});var WA=3e3,mp=(function(a){return a.Incoming="Call.incoming",a})({});class YA{constructor(e){y(this,"calls",void 0),y(this,"callEventBuffer",void 0),y(this,"nextSeqByCall",new Map),y(this,"toDeviceEventBuffers",new Map),y(this,"client",void 0),y(this,"candidateEventsByCall",void 0),y(this,"eventBufferPromiseChain",void 0),y(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),y(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),y(this,"onToDeviceEvent",t=>{var r=t.getContent();if(!r.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(r.call_id)||this.nextSeqByCall.set(r.call_id,0),r.seq===void 0){this.callEventBuffer.push(t);return}var n=this.nextSeqByCall.get(r.call_id)||0;if(r.seq!==n){this.toDeviceEventBuffers.has(r.call_id)||this.toDeviceEventBuffers.set(r.call_id,[]);var s=this.toDeviceEventBuffers.get(r.call_id),l=s.findIndex(v=>v.getContent().seq>r.seq);l===-1?s.push(t):s.splice(l,0,t)}else{var c=r.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(c,r.seq+1);for(var d=this.toDeviceEventBuffers.get(c),h=d&&d.shift();h&&h.getContent().seq===this.nextSeqByCall.get(c);)this.callEventBuffer.push(h),this.nextSeqByCall.set(c,h.getContent().seq+1),h=d.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(Pe.Sync,this.onSync),this.client.on(Ue.Timeline,this.onRoomTimeline),this.client.on(Pe.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(Pe.Sync,this.onSync),this.client.removeListener(Ue.Timeline,this.onRoomTimeline),this.client.removeListener(Pe.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return R(function*(){yield Promise.all(e.map(v=>t.client.decryptEventIfNeeded(v)));var r=e.filter(v=>{var p=v.getType();return p.startsWith("m.call.")||p.startsWith("org.matrix.call.")}),n=new Set;for(var s of r){var l=s.getType();(l===$.CallAnswer||l===$.CallHangup)&&n.add(s.getContent().call_id)}for(var c of r){var d=c.getType(),h=c.getContent().call_id;if(!(d===$.CallInvite&&n.has(h)))try{yield t.handleCallEvent(c)}catch(v){T.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",v)}}})()}handleCallEvent(e){var t=this;return R(function*(){var r;t.client.emit(Pe.ReceivedVoipEvent,e);var n=e.getContent(),s=e.getRoomId()||((r=t.client.groupCallEventHandler.getGroupCallById(n.conf_id))===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.roomId),l=n.conf_id,c=e.getType(),d=e.getSender(),h=n.call_id?t.calls.get(n.call_id):void 0,v,p;if(l){if(p=t.client.groupCallEventHandler.getGroupCallById(l),!p){T.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(l,", type=").concat(c,")"));return}if(v=n.device_id,!v){T.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(d,")")),p.emit(Dt.Error,new sR(d));return}if(n.dest_session_id!==t.client.getSessionId()){T.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var m=d===t.client.credentials.userId&&(v===void 0||v===t.client.getDeviceId());if(s){if(c===$.CallInvite){var _,b,E;if(m||e.getLocalAge()>n.lifetime-WA||h&&h.state===ze.Ended||(h&&T.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(n.call_id,")")),n.invitee&&n.invitee!==t.client.getUserId()))return;var M=((_=t.client.getTurnServersExpiry())!==null&&_!==void 0?_:0)-Date.now();if(T.info("CallEventHandler handleCallEvent() current turn creds expire in "+M+" ms"),h=(b=ic(t.client,s,{forceTURN:t.client.forceTURN,opponentDeviceId:v,groupCallId:l,opponentSessionId:n.sender_session_id}))!==null&&b!==void 0?b:void 0,!h){T.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(n.call_id,")"));return}h.callId=n.call_id;var O=(E=p)===null||E===void 0?void 0:E.getGroupCallStats();O&&h.initStats(O);try{yield h.initWithInvite(e)}catch(K){if(K instanceof ji)if(K.code===Wu.UnknownDevice){var C;(C=p)===null||C===void 0||C.emit(Dt.Error,K)}else T.error(K)}if(t.calls.set(h.callId,h),t.candidateEventsByCall.get(h.callId))for(var U of t.candidateEventsByCall.get(h.callId))h.onRemoteIceCandidatesReceived(U);var I;for(var D of t.calls.values()){var w,N=[ze.WaitLocalMedia,ze.CreateOffer,ze.InviteSent].includes(D.state);if(h.roomId===D.roomId&&D.direction===Ca.Outbound&&((w=h.getOpponentMember())===null||w===void 0?void 0:w.userId)===D.invitee&&N){I=D;break}}I?I.callId>h.callId?(T.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(h.callId,", outgoingId=").concat(I.callId,")")),I.replacedBy(h)):(T.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(h.callId,", outgoingId=").concat(I.callId,")")),h.hangup(Xe.Replaced,!0)):t.client.emit(mp.Incoming,h);return}else if(c===$.CallCandidates){if(m)return;h?h.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(n.call_id)||t.candidateEventsByCall.set(n.call_id,[]),t.candidateEventsByCall.get(n.call_id).push(e));return}else if([$.CallHangup,$.CallReject].includes(c)){if(h)h.state!==ze.Ended&&(c===$.CallHangup?h.onHangupReceived(n):h.onRejectReceived(n),h.state===ze.Ended&&t.calls.delete(n.call_id));else{var A;h=(A=ic(t.client,s,{opponentDeviceId:v,opponentSessionId:n.sender_session_id}))!==null&&A!==void 0?A:void 0,h&&(h.callId=n.call_id,h.initWithHangup(e),t.calls.set(n.call_id,h))}return}if(!h||!h.hasPeerConnection){T.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(c,")"));return}if(e.getContent().party_id!==h.ourPartyId)switch(c){case $.CallAnswer:m?h.state===ze.Ringing&&h.onAnsweredElsewhere(n):h.onAnswerReceived(e);break;case $.CallSelectAnswer:h.onSelectAnswerReceived(e);break;case $.CallNegotiate:h.onNegotiateReceived(e);break;case $.CallAssertedIdentity:case $.CallAssertedIdentityPrefix:h.onAssertedIdentityReceived(e);break;case $.CallSDPStreamMetadataChanged:case $.CallSDPStreamMetadataChangedPrefix:h.onSDPStreamMetadataChangedReceived(e);break}}})()}}var yp=(function(a){return a.Incoming="GroupCall.incoming",a.Outgoing="GroupCall.outgoing",a.Ended="GroupCall.ended",a.Participants="GroupCall.participants",a})({});class JA{constructor(e){this.client=e,y(this,"groupCalls",new Map),y(this,"roomDeferreds",new Map),y(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),y(this,"onRoomStateChanged",(t,r)=>{var n=t.getType();if(n===$.GroupCallPrefix){var s=t.getStateKey(),l=t.getContent(),c=this.groupCalls.get(r.roomId);!c&&!l["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):c&&c.groupCallId===s?l["m.terminated"]||t.isRedacted()?c.terminate(!1):l["m.type"]!==c.type&&T.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(r.roomId,")")):c&&c.groupCallId!==s&&T.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(r.roomId,")"))}})}start(){var e=this;return R(function*(){e.client.getSyncState()!==bt.Syncing&&(T.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(n=>{var s=()=>{if(e.client.getSyncState()===bt.Syncing)return e.client.off(Pe.Sync,s),n()};e.client.on(Pe.Sync,s)}));var t=e.client.getRooms();for(var r of t)e.createGroupCallForRoom(r);e.client.on(Pe.Room,e.onRoomsChanged),e.client.on($e.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(Pe.Room,this.onRoomsChanged),this.client.removeListener($e.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var r;t={prom:new Promise(n=>{r=n})},t.resolve=r,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents($.GroupCallPrefix),r=t.sort((l,c)=>c.getTs()-l.getTs());for(var n of r){var s=n.getContent();if(!(s["m.terminated"]||n.isRedacted())){T.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(n.getStateKey(),", ts=").concat(n.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(n);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),r=e.getContent(),n=this.client.getRoom(t);if(!n){T.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var s=e.getStateKey(),l=r["m.type"];if(!Object.values(Hf).includes(l)){T.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(l,", roomId=").concat(t,")"));return}var c=r["m.intent"];if(!Object.values(aR).includes(c)){T.warn("Received invalid group call intent (type=".concat(l,", roomId=").concat(t,")"));return}var d=!!r["io.element.ptt"],h;if(r!=null&&r.dataChannelsEnabled&&r!==null&&r!==void 0&&r.dataChannelOptions){var{ordered:v,maxPacketLifeTime:p,maxRetransmits:m,protocol:_}=r.dataChannelOptions;h={ordered:v,maxPacketLifeTime:p,maxRetransmits:m,protocol:_}}var b=new gm(this.client,n,l,d,c,s,(r==null?void 0:r.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,h,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,r["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,b),this.client.emit(yp.Incoming,b),b}}class QA{constructor(){y(this,"bandwidth",{}),y(this,"bitrate",{}),y(this,"packetLoss",{}),y(this,"transport",[])}}class XA{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}class $A{static buildReport(e,t,r,n){var s=e==null?void 0:e.get(t.localCandidateId),l=e==null?void 0:e.get(t.remoteCandidateId);if(l&&s){var c=l.ip!==void 0?l.ip:l.address,d=l.port,h="".concat(c,":").concat(d),v=s.ip!==void 0?s.ip:s.address,p=s.port,m="".concat(v,":").concat(p),_=l.protocol;r.some(b=>b.ip===h&&b.type===_&&b.localIp===m)||r.push({ip:h,type:_,localIp:m,isFocus:n,localCandidateType:s.candidateType,remoteCandidateType:l.candidateType,networkType:s.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return r}}class ZA{constructor(){y(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var r;return this.ssrcToMid[t].forEach((n,s)=>{if(n.find(l=>l==e)){r=s;return}}),r}parse(e,t){var r=vp.parse(e),n=new Map;r.media.forEach(s=>{if(s.mid&&s.type==="video"||s.type==="audio"){var l,c=[];(l=s.ssrcs)===null||l===void 0||l.forEach(d=>{d.attribute==="cname"&&c.push("".concat(d.id))}),n.set("".concat(s.mid),c)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class eD{constructor(e){this.pc=e}getLocalTracks(e){var t=r=>r!==null&&r.kind===e;return this.pc.getTransceivers().filter(r=>r.currentDirection==="sendonly"||r.currentDirection==="sendrecv").filter(r=>r.sender!==null).map(r=>r.sender).map(r=>r.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if((t==null?void 0:t.sender.track)!==null&&t.sender.track.id===e)return t.sender.track;if((t==null?void 0:t.receiver.track)!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t=this.pc.getTransceivers().find(r=>r.mid===e);if(t!==void 0&&t.sender&&t.sender.track)return t.sender.track.id}getRemoteTrackIdByMid(e){var t=this.pc.getTransceivers().find(r=>r.mid===e);if(t!==void 0&&t.receiver&&t.receiver.track)return t.receiver.track.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class tD{constructor(e,t,r){this.trackId=e,this.type=t,this.kind=r,y(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),y(this,"bitrate",{download:0,upload:0}),y(this,"resolution",{width:-1,height:-1}),y(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),y(this,"framerate",0),y(this,"jitter",0),y(this,"codec",""),y(this,"isAlive",!0),y(this,"isMuted",!1),y(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class rD{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,y(this,"track2stats",new Map)}findTrack2Stats(e,t){var r;if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var n=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!n)return;r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(r){var s=this.track2stats.get(r);if(!s){var l=this.mediaTrackHandler.getTackById(r);if(l!==void 0){var c=l.kind==="audio"?l.kind:"video";s=new tD(r,t,c),this.track2stats.set(r,s)}else return}return s}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class _s{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class pn{static buildFramerateResolution(e,t){var r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){var s=e.getFramerate();if(!s){if(r){var l=t.timestamp-r.timestamp;if(l>0&&t.framesSent){var c=t.framesSent-r.framesSent;s=c/l*1e3}}if(!s)return}s=n?Math.round(s/n):0,e.setFramerate(s)}static buildCodec(e,t,r){var n=e==null?void 0:e.get(r.codecId);if(n){var s=n.mimeType.split("/")[1];s&&t.setCodec(s)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:pn.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){var n=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",s=t[n];(!s||s<0)&&(s=0);var l=_s.getNonNegativeValue(r[n]),c=Math.max(0,s-l),d=_s.getNonNegativeValue(t.packetsLost),h=_s.getNonNegativeValue(r.packetsLost),v=Math.max(0,d-h);e.setLoss({packetsTotal:c+v,packetsLost:v,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,r,n){var s=_s.getNonNegativeValue(e),l=_s.getNonNegativeValue(t),c=Math.max(0,s-l),d=r-n,h=0;return d>0&&(h=Math.round(c*8/d)),h}static setTrackStatsState(e,t){var r;if(t===void 0){e.alive=!1;return}var n=e.getType()==="remote"?t.receiver.track:t==null||(r=t.sender)===null||r===void 0?void 0:r.track;if(n==null){e.alive=!1;return}if(n.readyState==="ended"){e.alive=!1;return}e.muted=n.muted,e.enabled=n.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(l=>l.getType()==="remote"),s=n.filter(l=>l.kind==="audio");return n.forEach(l=>{var c=l.kind==="video"?t:r;if(c.count++,l.alive&&l.muted&&c.muted++,c.maxJitter<l.getJitter()&&(c.maxJitter=l.getJitter()),c.maxPacketLoss<l.getLoss().packetsLost&&(c.maxPacketLoss=l.getLoss().packetsLost),s.length>0){var d,h;c.concealedAudio+=(d=l.getAudioConcealment())===null||d===void 0?void 0:d.concealedAudio,c.totalAudio+=(h=l.getAudioConcealment())===null||h===void 0?void 0:h.totalAudioDuration}}),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var r=t==null?void 0:t.jitter;if(r!==void 0){var n=_s.getNonNegativeValue(r);e.setJitter(Math.round(n*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var r=1e3*(t==null?void 0:t.totalSamplesDuration)/(t==null?void 0:t.totalSamplesReceived),n=r*(t==null?void 0:t.concealedSamples),s=1e3*(t==null?void 0:t.totalSamplesDuration);e.setAudioConcealment(n,s)}}}class zu{static build(e){var t={},r={download:0,upload:0},n={download:0,upload:0},s=0,l=0,c={local:new Map,remote:new Map},d={local:new Map,remote:new Map},h={local:new Map,remote:new Map},v=new Map,p=new Map,m=0,_=0,b=0,E=0,M=0,O=0;for(var[C,U]of e){var I=U.getLoss(),D=I.isDownloadStream?"download":"upload";if(r[D]+=I.packetsTotal,n[D]+=I.packetsLost,s+=U.getBitrate().download,l+=U.getBitrate().upload,U.kind==="audio"){var w=U.getAudioConcealment();M+=w.concealedAudio,O+=w.totalAudioDuration,m+=U.getBitrate().download,_+=U.getBitrate().upload}else b+=U.getBitrate().download,E+=U.getBitrate().upload;c[U.getType()].set(C,U.getResolution()),d[U.getType()].set(C,U.getFramerate()),h[U.getType()].set(C,U.getCodec()),U.getType()==="remote"&&(v.set(C,U.getJitter()),U.kind==="audio"&&p.set(C,U.getAudioConcealment())),U.resetBitrate()}return t.bitrate={upload:l,download:s},t.bitrate.audio={upload:_,download:m},t.bitrate.video={upload:E,download:b},t.packetLoss={total:zu.calculatePacketLoss(n.download+n.upload,r.download+r.upload),download:zu.calculatePacketLoss(n.download,r.download),upload:zu.calculatePacketLoss(n.upload,r.upload)},t.audioConcealment=p,t.totalAudioConcealment={concealedAudio:M,totalAudioDuration:O},t.framerate=d,t.resolution=c,t.codec=h,t.jitter=v,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Pa{static buildCallFeedReport(e,t,r){var n=r.getTransceivers(),s=[],l=[];return n.forEach(c=>{var d,h=(d=c.sender)!==null&&d!==void 0&&d.track?Pa.buildTrackStats(c.sender.track,"sender"):null,v=Pa.buildTrackStats(c.receiver.track,"receiver");s.push({mid:c.mid==null?"null":c.mid,direction:c.direction,currentDirection:c.currentDirection==null?"null":c.currentDirection,sender:h,receiver:v})}),{callId:e,opponentMemberId:t,transceiver:s,callFeeds:l}}static buildTrackStats(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",s=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,l=(r=e.getConstraints())===null||r===void 0?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:s||"unknown",constrainDeviceId:l||"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return e.callFeeds||(e.callFeeds=[]),t.forEach(n=>{var s=n.stream.getAudioTracks(),l=n.stream.getVideoTracks(),c=s.length>0?Pa.buildTrackStats(n.stream.getAudioTracks()[0],n.purpose):null,d=l.length>0?Pa.buildTrackStats(n.stream.getVideoTracks()[0],n.purpose):null,h={stream:n.stream.id,type:n.isLocal()?"local":"remote",audio:c,video:d,purpose:n.purpose,prefix:r,isVideoMuted:n.isVideoMuted(),isAudioMuted:n.isAudioMuted()};e.callFeeds.push(h)}),e}}function l0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function jd(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?l0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):l0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}class nD{constructor(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=s,y(this,"isActive",!0),y(this,"previousStatsReport",void 0),y(this,"currentStatsReport",void 0),y(this,"connectionStats",new QA),y(this,"trackStats",void 0),r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new rD(new ZA,new eD(r))}processStats(e,t){var r=this;return R(function*(){var n={isFirstCollection:r.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(r.isActive){var s=r.pc.getStats();if(typeof(s==null?void 0:s.then)=="function")return s.then(l=>{var c,d;r.currentStatsReport=typeof(l==null?void 0:l.result)=="function"?l.result():l;try{r.processStatsReport(e,t)}catch(v){return r.handleError(v),n}r.previousStatsReport=r.currentStatsReport,n.receivedMedia=r.connectionStats.bitrate.download,n.receivedAudioMedia=((c=r.connectionStats.bitrate.audio)===null||c===void 0?void 0:c.download)||0,n.receivedVideoMedia=((d=r.connectionStats.bitrate.video)===null||d===void 0?void 0:d.download)||0;var h=pn.buildTrackSummary(Array.from(r.trackStats.getTrack2stats().values()));return jd(jd({},n),{},{audioTrackSummary:h.audioTrackSummary,videoTrackSummary:h.videoTrackSummary})}).catch(l=>(r.handleError(l),n));r.isActive=!1}return Promise.resolve(n)})()}processStatsReport(e,t){var r,n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,(r=this.currentStatsReport)===null||r===void 0||r.forEach(s=>{var l=this.previousStatsReport?this.previousStatsReport.get(s.id):null;if(s.type==="candidate-pair"&&s.nominated&&s.state==="succeeded")this.connectionStats.bandwidth=XA.buildBandwidthReport(s),this.connectionStats.transport=$A.buildReport(this.currentStatsReport,s,this.connectionStats.transport,this.isFocus);else if(s.type==="inbound-rtp"||s.type==="outbound-rtp"){var c=this.trackStats.findTrack2Stats(s,s.type==="inbound-rtp"?"remote":"local");if(!c)return;if(l&&pn.buildPacketsLost(c,s,l),s.type==="inbound-rtp"){pn.buildFramerateResolution(c,s),l&&pn.buildBitrateReceived(c,s,l);var d=this.trackStats.findTransceiverByTrackId(c.trackId);pn.setTrackStatsState(c,d),pn.buildJitter(c,s),pn.buildAudioConcealment(c,s)}else l&&(n.set(c.trackId,_s.getNonNegativeValue(s.bytesSent)),pn.buildBitrateSend(c,s,l));pn.buildCodec(this.currentStatsReport,c,s)}else if(s.type==="track"&&s.kind==="video"&&!s.remoteSource){var h=this.trackStats.findLocalVideoTrackStats(s);if(!h)return;pn.buildFramerateResolution(h,s),pn.calculateSimulcastFramerate(h,s,l,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(Pa.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,T.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=zu.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(jd(jd({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var zi=(function(a){return a.CONNECTION_STATS="StatsReport.connection_stats",a.CALL_FEED_REPORT="StatsReport.call_feed_report",a.BYTE_SENT_STATS="StatsReport.byte_sent_stats",a.SUMMARY_STATS="StatsReport.summary_stats",a})({});class iD extends Pt{emitByteSendReport(e){this.emit(zi.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(zi.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(zi.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(zi.SUMMARY_STATS,e)}}class iR{constructor(e){this.emitter=e}build(e){var t=e.filter(v=>!v.isFirstCollection),r=t.length,n=e.length;if(r!==0){var s={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},l=0,c=0;t.forEach(v=>{this.countTrackListReceivedMedia(s,v),this.countConcealedAudio(s,v),l=this.buildMaxJitter(l,v),c=this.buildMaxPacketLoss(c,v)});var d=5,h={percentageReceivedMedia:Number((s.receivedMedia/r).toFixed(d)),percentageReceivedVideoMedia:Number((s.receivedVideo/r).toFixed(d)),percentageReceivedAudioMedia:Number((s.receivedAudio/r).toFixed(d)),maxJitter:l,maxPacketLoss:c,percentageConcealedAudio:Number(s.totalAudio>0?(s.concealedAudio/s.totalAudio).toFixed(d):0),peerConnections:n};this.emitter.emitSummaryStatsReport(h)}}static extendSummaryReport(e,t){var r=[],n=[];for(var s of t){n.push(s);for(var l of s[1])r.push(l)}e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,r.length-1)==0?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){var r=!1,n=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,r=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class aD{constructor(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=r,y(this,"timer",void 0),y(this,"gatherers",new Map),y(this,"reports",new iD),y(this,"summaryStatsReportGatherer",new iR(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new nD(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;(r=this.getStatsReportGatherer(e))===null||r===void 0||r.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{T.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}function u0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Fd(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?u0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):u0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var aR=(function(a){return a.Ring="m.ring",a.Prompt="m.prompt",a.Room="m.room",a})({}),Hf=(function(a){return a.Video="m.video",a.Voice="m.voice",a})({}),sD=(function(a){return a.CallEnded="call_ended",a})({}),Dt=(function(a){return a.GroupCallStateChanged="group_call_state_changed",a.ActiveSpeakerChanged="active_speaker_changed",a.CallsChanged="calls_changed",a.UserMediaFeedsChanged="user_media_feeds_changed",a.ScreenshareFeedsChanged="screenshare_feeds_changed",a.LocalScreenshareStateChanged="local_screenshare_state_changed",a.LocalMuteStateChanged="local_mute_state_changed",a.ParticipantsChanged="participants_changed",a.Error="group_call_error",a})({}),Ku=(function(a){return a.ConnectionStats="GroupCall.connection_stats",a.ByteSentStats="GroupCall.byte_sent_stats",a.SummaryStats="GroupCall.summary_stats",a.CallFeedStats="GroupCall.call_feed_stats",a})({}),Wu=(function(a){return a.NoUserMedia="no_user_media",a.UnknownDevice="unknown_device",a.PlaceCallFailed="place_call_failed",a})({});class Sp extends Error{constructor(e,t,r){r?(super(t+": "+r),y(this,"code",void 0)):(super(t),y(this,"code",void 0)),this.code=e}}class sR extends Sp{constructor(e){super(Wu.UnknownDevice,"No device found for "+e),this.userId=e}}var Gt=(function(a){return a.LocalCallFeedUninitialized="local_call_feed_uninitialized",a.InitializingLocalCallFeed="initializing_local_call_feed",a.LocalCallFeedInitialized="local_call_feed_initialized",a.Entered="entered",a.Ended="ended",a})({}),c0=1e3*60*60;function qd(a){var e;return((e=a.getOpponentMember())===null||e===void 0?void 0:e.userId)||a.invitee||null}class gm extends Pt{constructor(e,t,r,n,s,l,c,d,h){var v,p,m=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,_=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=s,this.dataChannelsEnabled=c,this.dataChannelOptions=d,this.useLivekit=m,y(this,"activeSpeakerInterval",1e3),y(this,"retryCallInterval",5e3),y(this,"participantTimeout",1e3*15),y(this,"pttMaxTransmitTime",1e3*20),y(this,"activeSpeaker",void 0),y(this,"localCallFeed",void 0),y(this,"localScreenshareFeed",void 0),y(this,"localDesktopCapturerSourceId",void 0),y(this,"userMediaFeeds",[]),y(this,"screenshareFeeds",[]),y(this,"groupCallId",void 0),y(this,"allowCallWithoutVideoAndAudio",void 0),y(this,"calls",new Map),y(this,"callHandlers",new Map),y(this,"activeSpeakerLoopInterval",void 0),y(this,"retryCallLoopInterval",void 0),y(this,"retryCallCounts",new Map),y(this,"reEmitter",void 0),y(this,"transmitTimer",null),y(this,"participantsExpirationTimer",null),y(this,"resendMemberStateTimer",null),y(this,"initWithAudioMuted",!1),y(this,"initWithVideoMuted",!1),y(this,"initCallFeedPromise",void 0),y(this,"_livekitServiceURL",void 0),y(this,"stats",void 0),y(this,"statsCollectIntervalTime",0),y(this,"onConnectionStats",b=>{this.emit(Ku.ConnectionStats,{report:b})}),y(this,"onByteSentStats",b=>{this.emit(Ku.ByteSentStats,{report:b})}),y(this,"onSummaryStats",b=>{iR.extendSummaryReport(b,this.participants),this.emit(Ku.SummaryStats,{report:b})}),y(this,"onCallFeedReport",b=>{this.localCallFeed&&(b=Pa.expandCallFeedReport(b,[this.localCallFeed],"from-local-feed"));var E=[];this.forEachCall(M=>{M.callId===b.callId&&M.getFeeds().forEach(O=>E.push(O))}),b=Pa.expandCallFeedReport(b,E,"from-call-feed"),this.emit(Ku.CallFeedStats,{report:b})}),y(this,"_state",Gt.LocalCallFeedUninitialized),y(this,"_participants",new Map),y(this,"_creationTs",null),y(this,"_enteredViaAnotherSession",!1),y(this,"onIncomingCall",b=>{var E,M;if(b.roomId===this.room.roomId){if(b.state!==ze.Ringing){T.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!b.groupCallId||b.groupCallId!==this.groupCallId){T.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),b.reject();return}var O=(E=b.getOpponentMember())===null||E===void 0?void 0:E.userId;if(O===void 0){T.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){T.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var C=(M=this.calls.get(O))!==null&&M!==void 0?M:new Map,U=C.get(b.getOpponentDeviceId());if((U==null?void 0:U.callId)!==b.callId){T.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(O,", callId=").concat(b.callId,")")),U&&U.hangup(Xe.Replaced,!1),C.set(b.getOpponentDeviceId(),b),this.calls.set(O,C),this.initCall(b);var I=this.getLocalFeeds().map(w=>w.clone());if(!this.callExpected(b))for(var D of I)or(D.stream.getAudioTracks(),!1),or(D.stream.getVideoTracks(),!1);b.answerWithCallFeeds(I),this.emit(Dt.CallsChanged,this.calls)}}}),y(this,"onRetryCallLoop",()=>{var b=!1;for(var[{userId:E},M]of this.participants){var O=this.calls.get(E),C=this.retryCallCounts.get(E);for(var[U,I]of M){var D,w,N=O==null?void 0:O.get(U),A=(D=(w=C)===null||w===void 0?void 0:w.get(U))!==null&&D!==void 0?D:0;(N==null?void 0:N.getOpponentSessionId())!==I.sessionId&&this.wantsOutgoingCall(E,U)&&A<3&&(C===void 0&&(C=new Map,this.retryCallCounts.set(E,C)),C.set(U,A+1),b=!0)}}b&&this.placeOutgoingCalls()}),y(this,"onCallFeedsChanged",b=>{var E=qd(b),M=b.getOpponentDeviceId();if(!E)throw new Error("Cannot change call feeds without user id");var O=this.getUserMediaFeed(E,M),C=b.remoteUsermediaFeed,U=C!==O,I=this.calls.get(E),D=I==null?void 0:I.get(M);if((D==null?void 0:D.callId)===b.callId){U&&(!O&&C?this.addUserMediaFeed(C):O&&C?this.replaceUserMediaFeed(O,C):O&&!C&&this.removeUserMediaFeed(O));var w=this.getScreenshareFeed(E,M),N=b.remoteScreensharingFeed,A=N!==w;A&&(!w&&N?this.addScreenshareFeed(N):w&&N?this.replaceScreenshareFeed(w,N):w&&!N&&this.removeScreenshareFeed(w))}}),y(this,"onCallStateChanged",(b,E,M)=>{var O;if(E!==ze.Ended){var C=this.localCallFeed.isAudioMuted();b.localUsermediaStream&&b.isMicrophoneMuted()!==C&&b.setMicrophoneMuted(C);var U=this.localCallFeed.isVideoMuted();b.localUsermediaStream&&b.isLocalVideoMuted()!==U&&b.setLocalVideoMuted(U);var I=(O=b.getOpponentMember())===null||O===void 0?void 0:O.userId;if(E===ze.Connected&&I){var D=this.retryCallCounts.get(I);D==null||D.delete(b.getOpponentDeviceId()),(D==null?void 0:D.size)===0&&this.retryCallCounts.delete(I)}}}),y(this,"onCallHangup",b=>{var E,M;if(b.hangupReason!==Xe.Replaced){var O=(E=(M=b.getOpponentMember())===null||M===void 0?void 0:M.userId)!==null&&E!==void 0?E:this.room.getMember(b.invitee).userId,C=this.calls.get(O);(C==null?void 0:C.get(b.getOpponentDeviceId()))===b&&(this.disposeCall(b,b.hangupReason),C.delete(b.getOpponentDeviceId()),C.size===0&&this.calls.delete(O),this.emit(Dt.CallsChanged,this.calls))}}),y(this,"onCallReplaced",(b,E)=>{var M=b.getOpponentMember().userId,O=this.calls.get(M);O===void 0&&(O=new Map,this.calls.set(M,O)),b.hangup(Xe.Replaced,!1),this.initCall(E),O.set(b.getOpponentDeviceId(),E),this.emit(Dt.CallsChanged,this.calls)}),y(this,"onActiveSpeakerLoop",()=>{var b=void 0,E=void 0;for(var M of this.userMediaFeeds)if(!(M.isLocal()&&this.userMediaFeeds.length>1)){var O=M.speakingVolumeSamples.reduce((U,I)=>U+Math.max(I,pp)),C=O/M.speakingVolumeSamples.length;(!b||C>b)&&(b=C,E=M)}E&&this.activeSpeaker!==E&&b&&b>pp&&(this.activeSpeaker=E,this.emit(Dt.ActiveSpeakerChanged,this.activeSpeaker))}),y(this,"onRoomState",()=>this.updateParticipants()),y(this,"onParticipantsChanged",()=>{this.forEachCall(b=>{var E=this.callExpected(b);for(var M of b.getLocalFeeds())or(M.stream.getAudioTracks(),!M.isAudioMuted()&&E),or(M.stream.getVideoTracks(),!M.isVideoMuted()&&E)}),this.state===Gt.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),y(this,"onStateChanged",(b,E)=>{(b===Gt.Entered||E===Gt.Entered||b===Gt.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(M=>T.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),M)))}),y(this,"onLocalFeedsChanged",()=>{this.state===Gt.Entered&&this.updateMemberState().catch(b=>T.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),b))}),this.reEmitter=new Ow(this),this.groupCallId=l??Es(),this._livekitServiceURL=_,this.creationTs=(v=(p=t.currentState.getStateEvents($.GroupCallPrefix,this.groupCallId))===null||p===void 0?void 0:p.getTs())!==null&&v!==void 0?v:null,this.updateParticipants(),t.on($e.Update,this.onRoomState),this.on(Dt.ParticipantsChanged,this.onParticipantsChanged),this.on(Dt.GroupCallStateChanged,this.onStateChanged),this.on(Dt.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!h}create(){var e=this;return R(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(yp.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return R(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,$.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(Dt.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,r=(s,l)=>s.sessionId===l.sessionId&&s.screensharing===l.screensharing,n=(s,l)=>xE(s,l,r);xE(e,t,n)||(this._participants=e,this.emit(Dt.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var r of t.values())e(r)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,r=qd(e),n=r===null?null:this.room.getMember(r),s=e.getOpponentDeviceId();return n!==null&&s!==void 0&&((t=this.participants.get(n))===null||t===void 0?void 0:t.get(s))!==void 0}initLocalCallFeed(){var e=this;return R(function*(){if(e.useLivekit){T.info("Livekit group call: not starting local call feed.");return}if(e.state!==Gt.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=Gt.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return R(function*(){T.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===Hf.Video)}catch(n){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=Gt.LocalCallFeedUninitialized,n}if(e._state!==Gt.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var r=new Vi({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:Mt.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});or(t.getAudioTracks(),!r.isAudioMuted()),or(t.getVideoTracks(),!r.isVideoMuted()),e.localCallFeed=r,e.addUserMediaFeed(r),e.state=Gt.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return R(function*(){if(t.localCallFeed){var r=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var n=t.localCallFeed.isAudioMuted(),s=t.localCallFeed.isVideoMuted();T.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(r.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(n,", vidShouldBeMuted=").concat(s,")")),or(e.getAudioTracks(),!n),or(e.getVideoTracks(),!s),t.client.getMediaHandler().stopUserMediaStream(r)}})()}enter(){var e=this;return R(function*(){if(e.state===Gt.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==Gt.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));T.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=Gt.Entered,e.client.on(mp.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Gt.Entered&&(this.forEachCall(t=>t.hangup(Xe.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(mp.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=Gt.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return R(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off($e.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(yp.Ended,t),t.state=Gt.Ended,r){var n=t.room.currentState.getStateEvents($.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,$.GroupCallPrefix,Fd(Fd({},n.getContent()),{},{"m.terminated":sD.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return R(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var r=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(l=>{var c;return(c=l.localUsermediaFeed)===null||c===void 0?void 0:c.setAudioVideoMuted(e,null)});var n=(function(){var l=R(function*(){var c=[];t.forEachCall(d=>c.push(d.sendMetadataUpdate())),yield Promise.all(c).catch(d=>T.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),d))});return function(){return l.apply(this,arguments)}})();if(r&&(yield n()),t.localCallFeed){T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var s=yield t.checkAudioPermissionIfNecessary(e);if(!s)return!1;t.localCallFeed.setAudioVideoMuted(e,null),or(t.localCallFeed.stream.getAudioTracks(),!e)}else T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(l=>or(l.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(l))),t.emit(Dt.LocalMuteStateChanged,e,t.isLocalVideoMuted()),r||(yield n()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return R(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if((r==null?void 0:r.getTracks().length)===0)return T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return R(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){T.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(r),t.localCallFeed.setAudioVideoMuted(null,e),or(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return T.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else T.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var n=[];return t.forEachCall(s=>n.push(s.setLocalVideoMuted(e))),yield Promise.all(n),t.forEachCall(s=>or(s.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(s))),t.emit(Dt.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(e===r.isScreensharing())return e;if(e)try{T.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var s=yield r.client.getMediaHandler().getScreensharingStream(n),l=function*(h){var v=()=>{r.setScreensharingEnabled(!1),h.removeEventListener("ended",v)};h.addEventListener("ended",v)};for(var c of s.getTracks())yield*l(c);return T.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),r.localDesktopCapturerSourceId=n.desktopCapturerSourceId,r.localScreenshareFeed=new Vi({client:r.client,roomId:r.room.roomId,userId:r.client.getUserId(),deviceId:r.client.getDeviceId(),stream:s,purpose:Mt.Screenshare,audioMuted:!1,videoMuted:!1}),r.addScreenshareFeed(r.localScreenshareFeed),r.emit(Dt.LocalScreenshareStateChanged,!0,r.localScreenshareFeed,r.localDesktopCapturerSourceId),r.forEachCall(d=>d.pushLocalFeed(r.localScreenshareFeed.clone())),!0}catch(d){if(n.throwOnFail)throw d;return T.error("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() enabling screensharing error"),d),r.emit(Dt.Error,new Sp(Wu.NoUserMedia,"Failed to get screen-sharing stream: ",d)),!1}else return r.forEachCall(d=>{d.localScreensharingFeed&&d.removeLocalFeed(d.localScreensharingFeed)}),r.client.getMediaHandler().stopScreensharingStream(r.localScreenshareFeed.stream),r.removeScreenshareFeed(r.localScreenshareFeed),r.localScreenshareFeed=void 0,r.localDesktopCapturerSourceId=void 0,r.emit(Dt.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){var e=this,t=!1,r=function(c){var d,h=(d=e.calls.get(c))!==null&&d!==void 0?d:new Map,v=function(b){var E=h.get(b);if((E==null?void 0:E.getOpponentSessionId())!==m.sessionId&&e.wantsOutgoingCall(c,b)){t=!0,E!==void 0&&(T.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(c,", deviceId=").concat(b,", callId=").concat(E.callId,")")),E.hangup(Xe.NewSession,!1));var M=ic(e.client,e.room.roomId,{invitee:c,opponentDeviceId:b,opponentSessionId:m.sessionId,groupCallId:e.groupCallId});M===null?(T.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(c,", device=").concat(b,")")),h.delete(b)):(e.initCall(M),h.set(b,M),T.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(c,", deviceId=").concat(b,", sessionId=").concat(m.sessionId,")")),M.placeCallWithCallFeeds(e.getLocalFeeds().map(O=>O.clone()),m.screensharing).then(()=>{e.dataChannelsEnabled&&M.createDataChannel("datachannel",e.dataChannelOptions)}).catch(O=>{T.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(c,")"),O),O instanceof ji&&O.code===Wu.UnknownDevice?e.emit(Dt.Error,O):e.emit(Dt.Error,new Sp(Wu.PlaceCallFailed,"Failed to place call to ".concat(c))),M.hangup(Xe.SignallingFailed,!1),h.get(b)===M&&h.delete(b)}))}};for(var[p,m]of s)v(p);h.size>0?e.calls.set(c,h):e.calls.delete(c)};for(var[{userId:n},s]of this.participants)r(n);t&&this.emit(Dt.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents($.GroupCallMemberPrefix):this.room.currentState.getStateEvents($.GroupCallMemberPrefix,e)}initCall(e){var t=qd(e);if(!t)throw new Error("Cannot init call without user id");var r=()=>this.onCallFeedsChanged(e),n=(d,h)=>this.onCallStateChanged(e,d,h),s=this.onCallHangup,l=d=>this.onCallReplaced(e,d),c=this.callHandlers.get(t);c===void 0&&(c=new Map,this.callHandlers.set(t,c)),c.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:s,onCallReplaced:l}),e.on(et.FeedsChanged,r),e.on(et.State,n),e.on(et.Hangup,s),e.on(et.Replaced,l),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(et)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){var r=qd(e),n=e.getOpponentDeviceId();if(!r)throw new Error("Cannot dispose call without user id");var s=this.callHandlers.get(r),{onCallFeedsChanged:l,onCallStateChanged:c,onCallHangup:d,onCallReplaced:h}=s.get(n);if(e.removeListener(et.FeedsChanged,l),e.removeListener(et.State,c),e.removeListener(et.Hangup,d),e.removeListener(et.Replaced,h),s.delete(r),s.size===0&&this.callHandlers.delete(r),e.hangupReason!==Xe.Replaced){var v=this.getUserMediaFeed(r,n);v&&this.removeUserMediaFeed(v);var p=this.getScreenshareFeed(r,n);p&&this.removeScreenshareFeed(p)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(r=>r.userId===e&&r.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(Dt.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var r=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(Dt.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(Dt.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(Dt.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(r=>r.userId===e&&r.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(Dt.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var r=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(Dt.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(Dt.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getUserId());if(!e){T.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Gt.Ended){this.participants=new Map;return}var t=new Map,r=Date.now(),n=this.state===Gt.Entered||this.enteredViaAnotherSession,s=1/0;for(var l of this.getMemberStateEvents()){var c=this.room.getMember(l.getStateKey()),d=l.getContent(),h=Array.isArray(d["m.calls"])?d["m.calls"]:[],v=h.find(M=>M["m.call_id"]===this.groupCallId),p=Array.isArray(v==null?void 0:v["m.devices"])?v["m.devices"]:[],m=p.filter(M=>typeof M.device_id=="string"&&typeof M.session_id=="string"&&typeof M.expires_ts=="number"&&M.expires_ts>r&&Array.isArray(M.feeds));if(!n&&(c==null?void 0:c.userId)===this.client.getUserId()&&(m=m.filter(M=>M.device_id!==this.client.getDeviceId())),m.length>0&&(c==null?void 0:c.membership)===We.Join){var _=new Map;t.set(c,_);for(var b of m)_.set(b.device_id,{sessionId:b.session_id,screensharing:b.feeds.some(M=>M.purpose===Mt.Screenshare)}),b.expires_ts<s&&(s=b.expires_ts)}}if(n){var E=t.get(e);E===void 0&&(E=new Map,t.set(e,E)),E.has(this.client.getDeviceId())||E.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(M=>M.purpose===Mt.Screenshare)})}this.participants=t,s<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),s-r))}updateDevices(e){var t=arguments,r=this;return R(function*(){var n,s=t.length>1&&t[1]!==void 0?t[1]:!1,l=Date.now(),c=r.client.getUserId(),d=r.getMemberStateEvents(c),h=(n=d==null?void 0:d.getContent())!==null&&n!==void 0?n:{},v=Array.isArray(h["m.calls"])?h["m.calls"]:[],p=null,m=[];for(var _ of v)_["m.call_id"]===r.groupCallId?p=_:m.push(_);p===null&&(p={});var b=Array.isArray(p["m.devices"])?p["m.devices"]:[],E=b.filter(U=>typeof U.device_id=="string"&&typeof U.session_id=="string"&&typeof U.expires_ts=="number"&&U.expires_ts>l&&Array.isArray(U.feeds)),M=e(E);if(M!==null){var O=[...m];M.length>0&&O.push(Fd(Fd({},p),{},{"m.call_id":r.groupCallId,"m.devices":M}));var C={"m.calls":O};yield r.client.sendStateEvent(r.room.roomId,$.GroupCallMemberPrefix,C,c,{keepAlive:s})}})()}addDeviceToMemberState(){var e=this;return R(function*(){yield e.updateDevices(t=>[...t.filter(r=>r.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+c0,feeds:e.getLocalFeeds().map(r=>({purpose:r.purpose}))}])})()}updateMemberState(){var e=this;return R(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===Gt.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(R(function*(){T.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){T.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),c0*3/4)):yield e.updateDevices(t=>t.filter(r=>r.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return R(function*(){var{devices:t}=yield e.client.getDevices(),r=new Map(t.map(n=>[n.device_id,n]));yield e.updateDevices(n=>{var s=n.filter(l=>{var c=r.get(l.device_id);return(c==null?void 0:c.last_seen_ts)!==void 0&&!(l.device_id===e.client.getDeviceId()&&e.state!==Gt.Entered&&!e.enteredViaAnotherSession)});return s.length===n.length?null:s})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new aD(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(zi.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(zi.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(zi.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(zi.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function d0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Vd(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?d0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):d0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var ze=(function(a){return a.Fledgling="fledgling",a.InviteSent="invite_sent",a.WaitLocalMedia="wait_local_media",a.CreateOffer="create_offer",a.CreateAnswer="create_answer",a.Connecting="connecting",a.Connected="connected",a.Ringing="ringing",a.Ended="ended",a})({}),f0=(function(a){return a.Voice="voice",a.Video="video",a})({}),Ca=(function(a){return a.Inbound="inbound",a.Outbound="outbound",a})({}),Qt=(function(a){return a.Local="local",a.Remote="remote",a})({}),et=(function(a){return a.Hangup="hangup",a.State="state",a.Error="error",a.Replaced="replaced",a.LocalHoldUnhold="local_hold_unhold",a.RemoteHoldUnhold="remote_hold_unhold",a.HoldUnhold="hold_unhold",a.FeedsChanged="feeds_changed",a.AssertedIdentityChanged="asserted_identity_changed",a.LengthChanged="length_changed",a.DataChannel="datachannel",a.SendVoipEvent="send_voip_event",a.PeerConnectionCreated="peer_connection_created",a})({}),Xe=(function(a){return a.UserHangup="user_hangup",a.LocalOfferFailed="local_offer_failed",a.NoUserMedia="no_user_media",a.UnknownDevices="unknown_devices",a.SendInvite="send_invite",a.CreateAnswer="create_answer",a.CreateOffer="create_offer",a.SendAnswer="send_answer",a.SetRemoteDescription="set_remote_description",a.SetLocalDescription="set_local_description",a.AnsweredElsewhere="answered_elsewhere",a.IceFailed="ice_failed",a.InviteTimeout="invite_timeout",a.Replaced="replaced",a.SignallingFailed="signalling_timeout",a.UserBusy="user_busy",a.Transferred="transferred",a.NewSession="new_session",a})({}),oD="1",lD="stun:turn.matrix.org",Ug=60*1e3,uD=1e3,cD=30*1e3,dD=2*1e3;class ji extends Error{constructor(e,t,r){super(t+": "+r),y(this,"code",void 0),this.code=e}}function Es(){return Date.now().toString()+Qn(16)}function h0(a){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:a?12e3:void 0}];return e}function jn(a,e){return a+":"+e}class fD extends Pt{constructor(e){var t,r;if(super(),t=this,y(this,"roomId",void 0),y(this,"callId",void 0),y(this,"invitee",void 0),y(this,"hangupParty",void 0),y(this,"hangupReason",void 0),y(this,"direction",void 0),y(this,"ourPartyId",void 0),y(this,"peerConn",void 0),y(this,"toDeviceSeq",0),y(this,"isPtt",!1),y(this,"_state",ze.Fledgling),y(this,"client",void 0),y(this,"forceTURN",void 0),y(this,"turnServers",void 0),y(this,"candidateSendQueue",[]),y(this,"candidateSendTries",0),y(this,"candidatesEnded",!1),y(this,"feeds",[]),y(this,"transceivers",new Map),y(this,"inviteOrAnswerSent",!1),y(this,"waitForLocalAVStream",!1),y(this,"successor",void 0),y(this,"opponentMember",void 0),y(this,"opponentVersion",void 0),y(this,"opponentPartyId",void 0),y(this,"opponentCaps",void 0),y(this,"iceDisconnectedTimeout",void 0),y(this,"iceReconnectionTimeOut",void 0),y(this,"inviteTimeout",void 0),y(this,"removeTrackListeners",new Map),y(this,"remoteOnHold",!1),y(this,"callStatsAtEnd",void 0),y(this,"makingOffer",!1),y(this,"ignoreOffer",!1),y(this,"isSettingRemoteAnswerPending",!1),y(this,"responsePromiseChain",void 0),y(this,"remoteCandidateBuffer",new Map),y(this,"remoteAssertedIdentity",void 0),y(this,"remoteSDPStreamMetadata",void 0),y(this,"callLengthInterval",void 0),y(this,"callStartTime",void 0),y(this,"opponentDeviceId",void 0),y(this,"opponentDeviceInfo",void 0),y(this,"opponentSessionId",void 0),y(this,"groupCallId",void 0),y(this,"stopVideoTrackTimer",void 0),y(this,"isOnlyDataChannelAllowed",void 0),y(this,"stats",void 0),y(this,"gotLocalIceCandidate",s=>{if(s.candidate){if(this.candidatesEnded&&T.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),T.debug("Call ".concat(this.callId," got local ICE ").concat(s.candidate.sdpMid," ").concat(s.candidate.candidate)),this.callHasEnded())return;s.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(s.candidate)}}),y(this,"onIceGatheringStateChange",s=>{var l;T.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((l=this.peerConn)===null||l===void 0?void 0:l.iceGatheringState)==="complete"&&(this.queueCandidate(null),T.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),y(this,"getLocalOfferFailed",s=>{T.error("Call ".concat(this.callId," getLocalOfferFailed() running"),s),this.emit(et.Error,new ji(Xe.LocalOfferFailed,"Failed to get local offer!",s),this),this.terminate(Qt.Local,Xe.LocalOfferFailed,!1)}),y(this,"getUserMediaFailed",s=>{if(this.successor){this.successor.getUserMediaFailed(s);return}T.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),s),this.emit(et.Error,new ji(Xe.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",s),this),this.terminate(Qt.Local,Xe.NoUserMedia,!1)}),y(this,"placeCallFailed",s=>{if(this.successor){this.successor.placeCallFailed(s);return}T.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),s),this.emit(et.Error,new ji(Xe.IceFailed,"Couldn't start call! Invalid ICE server configuration.",s),this),this.terminate(Qt.Local,Xe.IceFailed,!1)}),y(this,"onIceConnectionStateChanged",()=>{var s,l,c,d,h,v;if(!this.callHasEnded()){if(T.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((s=this.peerConn)===null||s===void 0?void 0:s.iceConnectionState,", conn=").concat((l=this.peerConn)===null||l===void 0?void 0:l.connectionState,")")),["connected","completed"].includes((c=(d=this.peerConn)===null||d===void 0?void 0:d.iceConnectionState)!==null&&c!==void 0?c:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=ze.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(et.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},uD));else if(((h=this.peerConn)===null||h===void 0?void 0:h.iceConnectionState)=="failed"){var p;if(this.candidatesEnded=!1,(p=this.peerConn)!==null&&p!==void 0&&p.restartIce){var m;this.candidatesEnded=!1,T.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((m=this.peerConn)===null||m===void 0?void 0:m.iceConnectionState,")")),this.peerConn.restartIce()}else T.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Xe.IceFailed,!1)}else((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var b,E,M;T.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((b=this.peerConn)===null||b===void 0?void 0:b.iceConnectionState,", conn=").concat((E=this.peerConn)===null||E===void 0?void 0:E.connectionState,")")),(M=this.peerConn)!==null&&M!==void 0&&M.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},dD),this.iceDisconnectedTimeout=setTimeout(()=>{T.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Xe.IceFailed,!1)},cD),this.state=ze.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var _ of this.getRemoteFeeds())_.setAudioVideoMuted(!0,!0)}}),y(this,"onSignallingStateChanged",()=>{var s;T.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((s=this.peerConn)===null||s===void 0?void 0:s.signalingState,")"))}),y(this,"onTrack",s=>{if(s.streams.length===0){T.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(s.track.kind,")"));return}var l=s.streams[0];if(this.pushRemoteFeed(l),!this.removeTrackListeners.has(l)){var c=()=>{l.getTracks().length===0&&(T.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(l.id,")")),this.deleteFeedByStream(l),l.removeEventListener("removetrack",c),this.removeTrackListeners.delete(l))};l.addEventListener("removetrack",c),this.removeTrackListeners.set(l,c)}}),y(this,"onDataChannel",s=>{this.emit(et.DataChannel,s.channel,this)}),y(this,"onNegotiationNeeded",R(function*(){if(T.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==ze.CreateOffer&&t.opponentVersion===0){T.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),y(this,"onHangupReceived",s=>{T.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(s)||this.state===ze.Ringing?this.terminate(Qt.Remote,s.reason||Xe.UserHangup,!0):T.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(s.party_id,": our partner is ").concat(this.opponentPartyId))}),y(this,"onRejectReceived",s=>{T.debug("Call ".concat(this.callId," onRejectReceived() running"));var l=[ze.InviteSent,ze.Ringing].includes(this.state)||this.state===ze.Fledgling&&this.direction===Ca.Inbound;l?this.terminate(Qt.Remote,s.reason||Xe.UserHangup,!0):T.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),y(this,"onAnsweredElsewhere",s=>{T.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(Qt.Remote,Xe.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(r=e.forceTURN)!==null&&r!==void 0?r:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[lD]});for(var n of this.turnServers)vw(n,["urls"]);this.callId=Es(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return R(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return R(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var r=this.peerConn.createDataChannel(e,t);return this.emit(et.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(et.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?f0.Video:f0.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Mt.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Mt.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(jn(Mt.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(jn(Mt.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Mt.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Mt.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Mt.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Mt.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return R(function*(){var t,r;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.isCryptoEnabled()){e.opponentDeviceInfo=new qr(e.opponentDeviceId);return}if(!e.client.crypto)throw new Error("Crypto is not initialised.");var n=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);if(!n)throw new Error("Couldn't find opponent user ID to init crypto");var s=yield e.client.crypto.deviceList.downloadKeys([n],!1);if(e.opponentDeviceInfo=(r=s.get(n))===null||r===void 0?void 0:r.get(e.opponentDeviceId),e.opponentDeviceInfo===void 0)throw new sR(n)}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,s=this.remoteSDPStreamMetadata[e.id].video_muted;if(!r){T.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){T.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new Vi({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:s})),this.emit(et.FeedsChanged,this.feeds,this),T.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))}pushRemoteFeedWithoutMetadata(e){var t,r=this.getOpponentMember().userId,n=Mt.Usermedia,s=(t=this.feeds.find(l=>!l.isLocal()))===null||t===void 0?void 0:t.stream;if(s&&e.id!==s.id){T.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){T.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new Vi({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(et.FeedsChanged,this.feeds,this),T.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=this.client.getUserId();if(or(e.getAudioTracks(),!0),or(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){T.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new Vi({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){var t=this,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(l=>e.stream.id===l.stream.id)){T.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),r){var n=function(){T.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(s.id,", kind=").concat(s.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(s.enabled,")"));var c=jn(e.purpose,s.kind);if(t.transceivers.has(c)){var d=t.transceivers.get(c);d.sender.replaceTrack(s),d.direction=d.direction==="inactive"?"sendonly":"sendrecv"}else{var h=t.peerConn.addTrack(s,e.stream),v=t.peerConn.getTransceivers().find(p=>p.sender===h);v?t.transceivers.set(c,v):T.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var s of e.stream.getTracks())n()}T.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(et.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=jn(e.purpose,"audio"),r=jn(e.purpose,"video");for(var n of[t,r])if(this.transceivers.has(n)){var s=this.transceivers.get(n);s.sender&&this.peerConn.removeTrack(s.sender)}e.purpose===Mt.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(et.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){T.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(et.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return R(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return R(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),r=[];return t.forEach(n=>{r.push(n)}),r}})()}initWithInvite(e){var t=this;return R(function*(){var r,n=e.getContent();t.direction=Ca.Inbound;var s=yield t.client.checkTurnServers();s||T.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var l=n[Ta];l?t.updateRemoteSDPStreamMetadata(l):T.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(et.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(n.offer),T.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(n.offer.type)),yield t.addBufferedIceCandidates()}catch(v){T.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),v),t.terminate(Qt.Local,Xe.SetRemoteDescription,!1);return}var c=(r=t.feeds.find(v=>!v.isLocal()))===null||r===void 0?void 0:r.stream;if(!t.isOnlyDataChannelAllowed&&(!c||c.getTracks().length===0)){T.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(Qt.Local,Xe.SetRemoteDescription,!1);return}if(t.state=ze.Ringing,e.getLocalAge()){var d=setTimeout(()=>{if(t.state==ze.Ringing){var v;T.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=Qt.Remote,t.state=ze.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(v=t.stats)===null||v===void 0||v.removeStatsReportGatherer(t.callId),t.emit(et.Hangup,t)}},n.lifetime-e.getLocalAge()),h=v=>{v!==ze.Ringing&&(clearTimeout(d),t.off(et.State,h))};t.on(et.State,h)}})()}initWithHangup(e){this.state=ze.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(T.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):!mw(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(T.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t):e??t}answer(e,t){var r=this;return R(function*(){if(!r.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!r.localUsermediaStream&&!r.waitForLocalAVStream){var n=r.state,s=r.shouldAnswerWithMediaType(e,r.hasRemoteUserMediaAudioTrack,"audio"),l=r.shouldAnswerWithMediaType(t,r.hasRemoteUserMediaVideoTrack,"video");r.state=ze.WaitLocalMedia,r.waitForLocalAVStream=!0;try{var c,d=yield r.client.getMediaHandler().getUserMediaStream(s,l);r.waitForLocalAVStream=!1;var h=new Vi({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(c=r.client.getDeviceId())!==null&&c!==void 0?c:void 0,stream:d,purpose:Mt.Usermedia,audioMuted:!1,videoMuted:!1}),v=[h];r.localScreensharingFeed&&v.push(r.localScreensharingFeed),r.answerWithCallFeeds(v)}catch(p){if(l)T.warn("Call ".concat(r.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),r.state=n,r.waitForLocalAVStream=!1,yield r.answer(s,!1);else{r.getUserMediaFailed(p);return}}}else r.waitForLocalAVStream&&(r.state=ze.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){T.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===ze.WaitLocalMedia?(T.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[ze.CreateOffer,ze.InviteSent].includes(this.state)&&(e.direction===Ca.Outbound?e.queueGotCallFeedsForAnswer([]):(T.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(et.Replaced,e,this),this.hangup(Xe.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(T.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(Qt.Local,e,!t),![ze.Fledgling,ze.WaitLocalMedia].includes(this.state))){var r={};(this.opponentVersion&&this.opponentVersion!==0||e!==Xe.UserHangup)&&(r.reason=e),this.sendVoipEvent($.CallHangup,r)}}reject(){if(this.state!==ze.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){T.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Xe.UserHangup,!0);return}T.debug("Rejecting call: "+this.callId),this.terminate(Qt.Local,Xe.UserHangup,!0),this.sendVoipEvent($.CallReject,{})}upgradeCall(e,t){var r=this;return R(function*(){if(!(!e&&!t)&&r.opponentSupportsSDPStreamMetadata())try{T.debug("Call ".concat(r.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var n=e||r.hasLocalUserMediaAudioTrack,s=t||r.hasLocalUserMediaVideoTrack,l=yield r.client.getMediaHandler().getUserMediaStream(n,s,!1);yield r.updateLocalUsermediaStream(l,e,t)}catch(c){T.error("Call ".concat(r.callId," upgradeCall() failed to upgrade the call"),c),r.emit(et.Error,new ji(Xe.NoUserMedia,"Failed to get camera access: ",c),r)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var r=this;return R(function*(){if(e&&r.isScreensharing())return T.warn("Call ".concat(r.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!r.isScreensharing())return T.warn("Call ".concat(r.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!r.opponentSupportsSDPStreamMetadata())return r.setScreensharingEnabledWithoutMetadataSupport(e,t);if(T.debug("Call ".concat(r.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var n=yield r.client.getMediaHandler().getScreensharingStream(t);return n?(r.pushNewLocalFeed(n,Mt.Screenshare),!0):!1}catch(d){return T.error("Call ".concat(r.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),d),!1}else{var s=r.transceivers.get(jn(Mt.Screenshare,"audio")),l=r.transceivers.get(jn(Mt.Screenshare,"video"));for(var c of[s,l])c&&c.sender&&r.peerConn.removeTrack(c.sender);return r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var r=this;return R(function*(){if(T.debug("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var n,s=yield r.client.getMediaHandler().getScreensharingStream(t);if(!s)return!1;var l=s.getTracks().find(m=>m.kind==="video"),c=(n=r.transceivers.get(jn(Mt.Usermedia,"video")))===null||n===void 0?void 0:n.sender;return c==null||c.replaceTrack(l??null),r.pushNewLocalFeed(s,Mt.Screenshare,!1),!0}catch(m){return T.error("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),m),!1}else{var d,h,v=(d=r.localUsermediaStream)===null||d===void 0?void 0:d.getTracks().find(m=>m.kind==="video"),p=(h=r.transceivers.get(jn(Mt.Usermedia,"video")))===null||h===void 0?void 0:h.sender;return p==null||p.replaceTrack(v??null),r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2&&t[2]!==void 0?t[2]:!1,l=r.localUsermediaFeed,c=n||!l.isAudioMuted()&&!r.remoteOnHold,d=s||!l.isVideoMuted()&&!r.remoteOnHold;T.log("Call ".concat(r.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(c,", video=").concat(d,")")),or(e.getAudioTracks(),c),or(e.getVideoTracks(),d);for(var h of r.localUsermediaStream.getTracks())r.localUsermediaStream.removeTrack(h),h.stop();for(var v of e.getTracks())r.localUsermediaStream.addTrack(v);var p=function*(){var b=jn(Mt.Usermedia,m.kind),E=r.transceivers.get(b),M=E==null?void 0:E.sender,O=!1;if(M)try{T.info("Call ".concat(r.callId," updateLocalUsermediaStream() replacing track (id=").concat(m.id,", kind=").concat(m.kind,", streamId=").concat(e.id,", streamPurpose=").concat(l.purpose,")")),yield M.replaceTrack(m),E.direction=E.direction==="inactive"?"sendonly":"sendrecv",O=!0}catch(I){T.warn("Call ".concat(r.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),I)}if(!O){T.info("Call ".concat(r.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(m.id,", kind=").concat(m.kind,", streamId=").concat(e.id,", streamPurpose=").concat(l.purpose,")"));var C=r.peerConn.addTrack(m,r.localUsermediaStream),U=r.peerConn.getTransceivers().find(I=>I.sender===C);U?r.transceivers.set(b,U):T.warn("Call ".concat(r.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var m of e.getTracks())yield*p()})()}setLocalVideoMuted(e){var t=this;return R(function*(){var r;if(T.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var n;return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var s=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(s)}return(r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var l of t.localUsermediaStream.getVideoTracks())l.stop(),t.localUsermediaStream.removeTrack(l)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return R(function*(){var r;return T.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(et.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==ze.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var r=["inactive","recvonly"].includes(t.currentDirection);r||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var r;if(((r=t.track)===null||r===void 0?void 0:r.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;T.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),or(this.localUsermediaStream.getAudioTracks(),!e),or(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return R(function*(){yield e.sendVoipEvent($.CallSDPStreamMetadataChangedPrefix,{[Ta]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var r of e)this.pushLocalFeed(r);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=ze.CreateOffer,T.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return R(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[Ta]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var r=e.discardDuplicateCandidates();T.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(r," candidates that will be sent in answer"));try{yield e.sendVoipEvent($.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(l){e.state=ze.Ringing,l instanceof hr&&l.event&&e.client.cancelPendingEvent(l.event);var n=Xe.SendAnswer,s="Failed to send answer";throw l.name=="UnknownDeviceError"&&(n=Xe.UnknownDevices,s="Unknown devices present in the room"),e.emit(et.Error,new ji(n,s,l),e),l}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var r=vp.parse(e.sdp);r.media.forEach(n=>{var s=new Map,l=new Map;for(var c of n.rtp)s.set(c.payload,c.codec),l.set(c.codec,c.payload);for(var d of t)if(d.mediaType===n.type){if(!l.has(d.codec)){T.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(d.codec," as it's not present."));continue}var h=[];d.enableDtx!==void 0&&h.push("usedtx=".concat(d.enableDtx?"1":"0")),d.maxAverageBitrate!==void 0&&h.push("maxaveragebitrate=".concat(d.maxAverageBitrate));var v=!1;for(var p of n.fmtp)s.get(p.payload)===d.codec&&(v=!0,p.config+=";"+h.join(";"));v||n.fmtp.push({payload:l.get(d.codec),config:h.join(";")})}}),e.sdp=vp.write(r)}createOffer(){var e=this;return R(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,h0(e.isPtt)),t})()}createAnswer(){var e=this;return R(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,h0(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return R(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var r of e)t.pushLocalFeed(r);t.state=ze.CreateAnswer;var n;try{t.getRidOfRTXCodecs(),n=yield t.createAnswer()}catch(s){T.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),s),t.terminate(Qt.Local,Xe.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(n),t.callHasEnded()||(t.state=ze.Connecting,yield new Promise(s=>{setTimeout(s,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(s){T.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),s),t.terminate(Qt.Local,Xe.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return R(function*(){if(!t.callHasEnded()){var r=e.getContent(),n=r.candidates;if(!n){T.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var s=r.version===0?null:r.party_id||null;if(t.opponentPartyId===void 0){if(s){T.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(n.length," candidates until we pick an opponent"));var l=t.remoteCandidateBuffer.get(s)||[];l.push(...n),t.remoteCandidateBuffer.set(s,l)}return}if(!t.partyIdMatches(r)){T.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(r.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(n)}})()}onAnswerReceived(e){var t=this;return R(function*(){var r=e.getContent();if(T.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(r.party_id,")")),t.callHasEnded()){T.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){T.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(r.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=ze.Connecting;var n=r[Ta];n?t.updateRemoteSDPStreamMetadata(n):T.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(r.answer),t.isSettingRemoteAnswerPending=!1,T.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(r.answer.type))}catch(s){t.isSettingRemoteAnswerPending=!1,T.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),s),t.terminate(Qt.Local,Xe.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent($.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(s){T.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),s)}})()}onSelectAnswerReceived(e){var t=this;return R(function*(){if(t.direction!==Ca.Inbound){T.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var r=e.getContent().selected_party_id;if(r==null){T.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}r!==t.ourPartyId&&(T.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(r,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(Qt.Remote,Xe.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return R(function*(){var r=e.getContent(),n=r.description;if(!n||!n.sdp||!n.type){T.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var s=t.direction===Ca.Inbound,l=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),c=n.type==="offer"&&!l;if(t.ignoreOffer=!s&&c,t.ignoreOffer){T.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var d=t.isLocalOnHold(),h=r[Ta];h?t.updateRemoteSDPStreamMetadata(h):T.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=n.type=="answer",yield t.peerConn.setRemoteDescription(n),t.isSettingRemoteAnswerPending=!1,T.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(n.type)),n.type==="offer"){var v,p;try{t.getRidOfRTXCodecs(),p=yield t.createAnswer()}catch(_){T.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),_),t.terminate(Qt.Local,Xe.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(p),T.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent($.CallNegotiate,{lifetime:Ug,description:(v=t.peerConn.localDescription)===null||v===void 0?void 0:v.toJSON(),[Ta]:t.getLocalSDPStreamMetadata(!0)})}}catch(_){t.isSettingRemoteAnswerPending=!1,T.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),_)}var m=t.isLocalOnHold();d!==m&&(t.emit(et.LocalHoldUnhold,m,t),t.emit(et.HoldUnhold,m))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=yw(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var r,n=t.stream.id,s=this.remoteSDPStreamMetadata[n];t.setAudioVideoMuted(s==null?void 0:s.audio_muted,s==null?void 0:s.video_muted),t.purpose=(r=this.remoteSDPStreamMetadata[n])===null||r===void 0?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),r=t[Ta];this.updateRemoteSDPStreamMetadata(r)}onAssertedIdentityReceived(e){var t=this;return R(function*(){var r=e.getContent();r.asserted_identity&&(t.remoteAssertedIdentity={id:r.asserted_identity.id,displayName:r.asserted_identity.display_name},t.emit(et.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===ze.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return R(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return R(function*(){if(T.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){T.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(v){T.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),v),e.terminate(Qt.Local,Xe.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(v){T.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),v),e.terminate(Qt.Local,Xe.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(v=>{setTimeout(v,200)})),!e.callHasEnded()){var r=e.state===ze.CreateOffer?$.CallInvite:$.CallNegotiate,n={lifetime:Ug};if(r===$.CallInvite&&e.invitee&&(n.invitee=e.invitee),e.state===ze.CreateOffer){var s;n.offer=(s=e.peerConn.localDescription)===null||s===void 0?void 0:s.toJSON()}else{var l;n.description=(l=e.peerConn.localDescription)===null||l===void 0?void 0:l.toJSON()}n.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},n[Ta]=e.getLocalSDPStreamMetadata(!0);var c=e.discardDuplicateCandidates();T.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(c," candidates that will be sent in offer"));try{yield e.sendVoipEvent(r,n)}catch(v){T.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),v),v instanceof hr&&v.event&&e.client.cancelPendingEvent(v.event);var d=Xe.SignallingFailed,h="Signalling failed";e.state===ze.CreateOffer&&(d=Xe.SendInvite,h="Failed to send invite"),v.name=="UnknownDeviceError"&&(d=Xe.UnknownDevices,h="Unknown devices present in the room"),e.emit(et.Error,new ji(d,h,v),e),e.terminate(Qt.Local,d,!1);return}e.sendCandidateQueue(),e.state===ze.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=ze.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===ze.InviteSent&&e.hangup(Xe.InviteTimeout,!1)},Ug))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(jn(Mt.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,r=RTCRtpSender.getCapabilities("video").codecs,n=[];for(var s of[...t,...r])if(s.mimeType!=="video/rtx"){n.push(s);try{e.setCodecPreferences(n)}catch(l){T.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",s,l),n.pop()}}}}}sendVoipEvent(e,t){var r=this;return R(function*(){var n=Vd(Vd({},t),{},{version:oD,call_id:r.callId,party_id:r.ourPartyId,conf_id:r.groupCallId});if(r.opponentDeviceId){var s,l=r.toDeviceSeq++,c=Vd(Vd({},n),{},{device_id:r.client.deviceId,sender_session_id:r.client.getSessionId(),dest_session_id:r.opponentSessionId,seq:l,[Fr]:Jn()});r.emit(et.SendVoipEvent,{type:"toDevice",eventType:e,userId:r.invitee||((s=r.getOpponentMember())===null||s===void 0?void 0:s.userId),opponentDeviceId:r.opponentDeviceId,content:c},r);var d=r.invitee||r.getOpponentMember().userId;if(r.client.getUseE2eForGroupCall()){if(!r.opponentDeviceInfo){T.warn("Call ".concat(r.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}yield r.client.encryptAndSendToDevices([{userId:d,deviceInfo:r.opponentDeviceInfo}],{type:e,content:c})}else yield r.client.sendToDevice(e,new Map([[d,new Map([[r.opponentDeviceId,c]])]]))}else{var h;r.emit(et.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:r.roomId,content:n,userId:r.invitee||((h=r.getOpponentMember())===null||h===void 0?void 0:h.userId)},r),yield r.client.sendEvent(r.roomId,e,n)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===ze.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===Ca.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],r=0;r<this.candidateSendQueue.length;r++){var n=this.candidateSendQueue[r];n.candidate===""?t.push(n):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return R(function*(){var r=yield t.client.getProfileInfo(e),n=Es(),s={replacement_id:Es(),target_user:{id:e,display_name:r.displayname,avatar_url:r.avatar_url},create_call:n};yield t.sendVoipEvent($.CallReplaces,s),yield t.terminate(Qt.Local,Xe.Transferred,!0)})()}transferToCall(e){var t=this;return R(function*(){var r,n,s=(r=e.getOpponentMember())===null||r===void 0?void 0:r.userId,l=s?yield t.client.getProfileInfo(s):void 0,c=(n=t.getOpponentMember())===null||n===void 0?void 0:n.userId,d=c?yield t.client.getProfileInfo(c):void 0,h=Es(),v={replacement_id:Es(),target_user:{id:c,display_name:d==null?void 0:d.displayname,avatar_url:d==null?void 0:d.avatar_url},await_call:h};yield e.sendVoipEvent($.CallReplaces,v);var p={replacement_id:Es(),target_user:{id:s,display_name:l==null?void 0:l.displayname,avatar_url:l==null?void 0:l.avatar_url},create_call:h};yield t.sendVoipEvent($.CallReplaces,p),yield t.terminate(Qt.Local,Xe.Transferred,!0),yield e.terminate(Qt.Local,Xe.Transferred,!0)})()}terminate(e,t,r){var n=this;return R(function*(){var s;if(!n.callHasEnded()){n.hangupParty=e,n.hangupReason=t,n.state=ze.Ended,n.inviteTimeout&&(clearTimeout(n.inviteTimeout),n.inviteTimeout=void 0),n.iceDisconnectedTimeout!==void 0&&(clearTimeout(n.iceDisconnectedTimeout),n.iceDisconnectedTimeout=void 0),n.callLengthInterval&&(clearInterval(n.callLengthInterval),n.callLengthInterval=void 0),n.stopVideoTrackTimer!==void 0&&(clearTimeout(n.stopVideoTrackTimer),n.stopVideoTrackTimer=void 0);for(var[l,c]of n.removeTrackListeners)l.removeEventListener("removetrack",c);n.removeTrackListeners.clear(),n.callStatsAtEnd=yield n.collectCallStats(),n.stopAllMedia(),n.deleteAllFeeds(),n.peerConn&&n.peerConn.signalingState!=="closed"&&n.peerConn.close(),(s=n.stats)===null||s===void 0||s.removeStatsReportGatherer(n.callId),r&&n.emit(et.Hangup,n),n.client.callEventHandler.calls.delete(n.callId)}})()}stopAllMedia(){T.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===Mt.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Mt.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){T.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(bw.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return R(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var r={candidates:t.map(c=>c.toJSON())};e.candidatesEnded&&r.candidates.push({candidate:""}),T.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent($.CallCandidates,r),e.candidateSendTries=0,e.sendCandidateQueue()}catch(c){if(c instanceof hr&&c.event&&e.client.cancelPendingEvent(c.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){T.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),c);var n=Xe.SignallingFailed,s="Signalling failed";e.emit(et.Error,new ji(n,s,c),e),e.hangup(n,!1);return}var l=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,T.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(l,"ms"),c),setTimeout(()=>{e.sendCandidateQueue()},l)}}})()}placeCall(e,t){var r=this;return R(function*(){if(!e)throw new Error("You CANNOT start a call without audio");r.state=ze.WaitLocalMedia;var n;try{var s,l=yield r.client.getMediaHandler().getUserMediaStream(e,t);or(l.getAudioTracks(),!0),or(l.getVideoTracks(),!0),n=new Vi({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(s=r.client.getDeviceId())!==null&&s!==void 0?s:void 0,stream:l,purpose:Mt.Usermedia,audioMuted:!1,videoMuted:!1})}catch(c){r.getUserMediaFailed(c);return}try{yield r.placeCallWithCallFeeds([n])}catch(c){r.placeCallFailed(c);return}})()}placeCallWithCallFeeds(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;r.checkForErrorListener(),r.direction=Ca.Outbound,yield r.initOpponentCrypto(),r.client.callEventHandler.calls.set(r.callId,r);var s=yield r.client.checkTurnServers();s||T.warn("Call ".concat(r.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),r.peerConn=r.createPeerConnection(),r.emit(et.PeerConnectionCreated,r.peerConn,r),r.gotCallFeedsForInvite(e,n)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var r=this.getOpponentMember(),n=r?r.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,r=e.getContent();if(T.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(r.party_id,")")),this.opponentVersion=r.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=r.party_id||null,this.opponentCaps=r.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var n;(n=this.stats)===null||n===void 0||n.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return R(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(T.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return R(function*(){for(var r of e){(r.sdpMid===null||r.sdpMid===void 0)&&(r.sdpMLineIndex===null||r.sdpMLineIndex===void 0)?T.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):T.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(r.sdpMid,", candidate=").concat(r.candidate,")"));try{yield t.peerConn.addIceCandidate(r)}catch(n){t.ignoreOffer?T.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),n):T.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),n)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}}function or(a,e){for(var t of a)t.enabled=e}function bp(){if(typeof window>"u"||typeof document>"u")return!1;try{var a=!!(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices);if(!a)return T.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return T.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function ic(a,e,t){if(!bp())return null;var r=t?t.forceTURN:!1,n={client:a,roomId:e,invitee:t==null?void 0:t.invitee,turnServers:a.getTurnServers(),forceTURN:a.forceTURN||r,opponentDeviceId:t==null?void 0:t.opponentDeviceId,opponentSessionId:t==null?void 0:t.opponentSessionId,groupCallId:t==null?void 0:t.groupCallId},s=new fD(n);return a.reEmitter.reEmit(s,Object.values(et)),s}var La=(function(a){return a.DontNotify="dont_notify",a.Notify="notify",a.Coalesce="coalesce",a})({}),pm=(function(a){return a.Highlight="highlight",a.Sound="sound",a})({}),hD=(function(a){return a.ExactEquals="==",a.LessThan="<",a.GreaterThan=">",a.GreaterThanOrEqual=">=",a.LessThanOrEqual="<=",a})({}),vD="2";function gD(a){return a==="==2"||a==="2"}var lr=(function(a){return a.EventMatch="event_match",a.EventPropertyIs="event_property_is",a.EventPropertyContains="event_property_contains",a.ContainsDisplayName="contains_display_name",a.RoomMemberCount="room_member_count",a.SenderNotificationPermission="sender_notification_permission",a.CallStarted="call_started",a.CallStartedPrefix="org.matrix.msc3914.call_started",a})({}),Sr=(function(a){return a.Override="override",a.ContentSpecific="content",a.RoomSpecific="room",a.SenderSpecific="sender",a.Underride="underride",a})({}),yr=(function(a){return a.Master=".m.rule.master",a.IsUserMention=".m.rule.is_user_mention",a.IsRoomMention=".m.rule.is_room_mention",a.ContainsDisplayName=".m.rule.contains_display_name",a.ContainsUserName=".m.rule.contains_user_name",a.AtRoomNotification=".m.rule.roomnotif",a.DM=".m.rule.room_one_to_one",a.EncryptedDM=".m.rule.encrypted_room_one_to_one",a.Message=".m.rule.message",a.EncryptedMessage=".m.rule.encrypted",a.InviteToSelf=".m.rule.invite_for_me",a.MemberEvent=".m.rule.member_event",a.IncomingCall=".m.rule.call",a.SuppressNotices=".m.rule.suppress_notices",a.Tombstone=".m.rule.tombstone",a.PollStart=".m.rule.poll_start",a.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",a.PollEnd=".m.rule.poll_end",a.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",a.PollStartOneToOne=".m.rule.poll_start_one_to_one",a.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",a.PollEndOneToOne=".m.rule.poll_end_one_to_one",a.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",a})({});function v0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function g0(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?v0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):v0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var p0=[Sr.Override,Sr.ContentSpecific,Sr.RoomSpecific,Sr.SenderSpecific,Sr.Underride],pD={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:lr.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:lr.SenderNotificationPermission,key:"room"}],actions:[La.Notify,{set_tweak:pm.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:lr.EventMatch,key:"type",pattern:"m.reaction"}],actions:[La.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:lr.EventMatch,key:"type",pattern:$.RoomServerAcl},{kind:lr.EventMatch,key:"state_key",pattern:""}],actions:[]}},mm=Symbol("UserDefinedRules"),mD=[yr.Master,mm,yr.SuppressNotices,yr.InviteToSelf,yr.MemberEvent,yr.IsUserMention,yr.ContainsDisplayName,yr.IsRoomMention,yr.AtRoomNotification,yr.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],yD={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:lr.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:lr.CallStarted}],actions:[La.Notify,{set_tweak:pm.Sound,value:"default"}]}},SD=[mm,yr.IncomingCall,".org.matrix.msc3914.rule.room.call",yr.EncryptedDM,yr.DM,yr.Message,yr.EncryptedMessage];function m0(a,e,t,r){var n=e.filter(_=>_.default),s=e.filter(_=>!_.default);function l(_){_===mm?d.push(...s):_ in t?(T.warn("Adding default global ".concat(a," push rule ").concat(_)),d.push(t[_])):T.warn("Missing default global ".concat(a," push rule ").concat(_))}var c=0,d=[];for(var h of n){var v=r.indexOf(h.rule_id);if(v===-1){d.push(h);continue}for(;v>c;){var p=r[c];l(p),c+=1}d.push(h),c+=1}for(var m of r.slice(c))l(m);return d}class Gn{constructor(e){this.client=e,y(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var r of e)r===La.Notify?t.notify=!0:typeof r=="object"&&(r.value===void 0&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e){var t=JSON.parse(JSON.stringify(e));return t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.underride||(t.global.underride=[]),t.global.override=m0(Sr.Override,t.global.override,pD,mD),t.global.underride=m0(Sr.Underride,t.global.underride,yD,SD),t}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var n of r)if(n.conditions)for(var s of n.conditions)s.kind===lr.EventMatch&&(t.delete(s.key),this.parsedKeys.set(s.key,Gn.partsForDottedKey(s.key)));t.forEach(l=>this.parsedKeys.delete(l))}matchingRuleFromKindSet(e,t){for(var r of p0){var n=t[r];if(n){for(var s of n)if(s.enabled){var l=this.templateRuleToRaw(r,s);if(l&&this.ruleMatchesEvent(l,e))return g0(g0({},s),{},{kind:r})}}}return null}templateRuleToRaw(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case Sr.Underride:case Sr.Override:r.conditions=t.conditions;break;case Sr.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:lr.EventMatch,key:"room_id",value:t.rule_id});break;case Sr.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:lr.EventMatch,key:"user_id",value:t.rule_id});break;case Sr.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:lr.EventMatch,key:"content.body",pattern:t.pattern});break}return r}eventFulfillsCondition(e,t){switch(e.kind){case lr.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case lr.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case lr.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case lr.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case lr.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case lr.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case lr.CallStarted:case lr.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var r=e.key;if(!r)return!1;var n=this.client.getRoom(t.getRoomId());return n!=null&&n.currentState?n.currentState.mayTriggerNotifOfType(r,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var n=r.currentState.getJoinedMemberCount(),s=e.is.match(/^([=<>]*)(\d*)$/);if(!s)return!1;var l=s[1],c=parseInt(s[2]);if(isNaN(c))return!1;switch(l){case"":case"==":return n==c;case"<":return n<c;case">":return n>c;case"<=":return n<=c;case">=":return n>=c;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r,n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||typeof n.body!="string")return!1;var s=this.client.getRoom(t.getRoomId()),l=s==null||(r=s.currentState)===null||r===void 0?void 0:r.getMember(this.client.credentials.userId);if(!l)return!1;var c=l.name,d=new RegExp("(^|\\W)"+gw(c)+"(\\W|$)","i");return n.body.search(d)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var r=this.valueForDottedKey(e.key,t);if(typeof r!="string")return!1;if(e.value)return e.value===r;if(typeof e.pattern!="string")return!1;var n=e.key==="content.body"?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var r=this.valueForDottedKey(e.key,t);return Array.isArray(r)?r.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||Ms(t.getPrevContent(),{}))}createCachedRegex(e,t,r){return Gn.cachedGlobToRegex[t]||(Gn.cachedGlobToRegex[t]=new RegExp(e+pw(t)+r,"i")),Gn.cachedGlobToRegex[t]}static partsForDottedKey(e){var t=[],r="",n=!1;for(var s of e){if(n){s==="\\"||s==="."?r+=s:r+="\\"+s,n=!1;continue}s=="."?(t.push(r),r=""):s=="\\"?n=!0:r+=s}return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){var r=this.parsedKeys.get(e);r===void 0&&(r=Gn.partsForDottedKey(e),this.parsedKeys.set(e,r));var n,s=r[0],l=0;for(s==="content"?(n=t.getContent(),++l):s==="type"?(n=t.getType(),++l):n=t.event;l<r.length;++l){if(mw(n))return;var c=r[l];n=n[c]}return n}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};var n=Gn.actionListToActionsObject(r.actions);return n.tweaks.highlight===void 0&&(n.tweaks.highlight=r.kind==Sr.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===yr.ContainsUserName||e.rule_id===yr.ContainsDisplayName||e.rule_id===yr.AtRoomNotification)?!1:!((r=e.conditions)!==null&&r!==void 0&&r.some(n=>!this.eventFulfillsCondition(n,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,r=this.getPushRuleAndKindById(e);return(t=r==null?void 0:r.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var r;if(((r=this.client.pushRules)===null||r===void 0?void 0:r[t])!==void 0){for(var n of p0)if(this.client.pushRules[t][n]!==void 0){for(var s of this.client.pushRules[t][n])if(s.rule_id===e)return{rule:s,kind:n}}}}return null}}y(Gn,"cachedGlobToRegex",{});var Cf=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"];Cf[0];Cf[Cf.length-1];var Sn=(function(a){return a.SUCCESS="SUCCESS",a.IGNORE="IGNORE",a.PROMPT="PROMPT",a.FAIL_PROMPT="FAIL_PROMPT",a.FAIL_ERROR="FAIL_ERROR",a})({}),Nn=(function(a){return a.Invalid="Invalid homeserver discovery response",a.GenericFailure="Failed to get autodiscovery configuration from server",a.InvalidHsBaseUrl="Invalid base_url for m.homeserver",a.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",a.InvalidIsBaseUrl="Invalid base_url for m.identity_server",a.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",a.InvalidIs="Invalid identity server discovery response",a.MissingWellknown="No .well-known JSON file found",a.InvalidJson="Invalid JSON",a.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",a})({});class Ye{static fromDiscoveryConfig(e){var t=this;return R(function*(){var r,n={"m.homeserver":{state:Ye.FAIL_ERROR,error:Ye.ERROR_INVALID,base_url:null},"m.identity_server":{state:Ye.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return T.error("No m.homeserver key in config"),n["m.homeserver"].state=Ye.FAIL_PROMPT,n["m.homeserver"].error=Ye.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"].base_url)return T.error("No m.homeserver base_url in config"),n["m.homeserver"].state=Ye.FAIL_PROMPT,n["m.homeserver"].error=Ye.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var s=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!s)return T.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=Ye.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var l=yield t.fetchWellKnownObject("".concat(s,"/_matrix/client/versions"));if(!l||!Array.isArray((r=l.raw)===null||r===void 0?void 0:r.versions))return T.error("Invalid /versions response"),n["m.homeserver"].error=Ye.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=s,Promise.resolve(n);var c=new Set(l.raw.versions),d=!1;for(var h of Cf)if(c.has(h)){d=!0;break}if(!d)return T.error("Homeserver does not meet version requirements"),n["m.homeserver"].error=Ye.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,n["m.homeserver"].base_url=s,Promise.resolve(n);n["m.homeserver"]={state:Ye.SUCCESS,error:null,base_url:s};var v="";if(e["m.identity_server"]){var p={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:Ye.FAIL_PROMPT,error:Ye.ERROR_INVALID_IS,base_url:null}};if(v=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!v)return T.error("Invalid base_url for m.identity_server"),p["m.identity_server"].error=Ye.ERROR_INVALID_IS_BASE_URL,Promise.resolve(p);var m=yield t.fetchWellKnownObject("".concat(v,"/_matrix/identity/v2"));if(!(m!=null&&m.raw)||m.action!==Sn.SUCCESS)return T.error("Invalid /v2 response"),p["m.identity_server"].error=Ye.ERROR_INVALID_IDENTITY_SERVER,p["m.identity_server"].base_url=v,Promise.resolve(p)}return v&&v.toString().length>0&&(n["m.identity_server"]={state:Ye.SUCCESS,error:null,base_url:v}),Object.keys(e).forEach(_=>{if(_==="m.homeserver"||_==="m.identity_server"){var b=["error","state","base_url"];for(var E of Object.keys(e[_]))b.includes(E)||(n[_][E]=e[_][E])}else n[_]=e[_]}),Promise.resolve(n)})()}static findClientConfig(e){var t=this;return R(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var r={"m.homeserver":{state:Ye.FAIL_ERROR,error:Ye.ERROR_INVALID,base_url:null},"m.identity_server":{state:Ye.PROMPT,error:null,base_url:null}},n=e.includes("://")?e:"https://".concat(e),s=yield t.fetchWellKnownObject("".concat(n,"/.well-known/matrix/client"));return!s||s.action!==Sn.SUCCESS?(T.error("No response or error when parsing .well-known"),s.reason&&T.error(s.reason),s.action===Sn.IGNORE?r["m.homeserver"]={state:Ye.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=Ye.FAIL_PROMPT,r["m.homeserver"].error=Ye.ERROR_INVALID),Promise.resolve(r)):Ye.fromDiscoveryConfig(s.raw)})()}static getRawClientConfig(e){var t=this;return R(function*(){var r;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return n?(r=n.raw)!==null&&r!==void 0?r:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,r;try{r=new URL(e)}catch(c){T.error("Could not parse url",c)}if(!((t=r)!==null&&t!==void 0&&t.hostname)||r.protocol!=="http:"&&r.protocol!=="https:")return!1;var n=r.port?":".concat(r.port):"",s=r.pathname?r.pathname:"",l="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(s);return l.endsWith("/")&&(l=l.substring(0,l.length-1)),l}catch(c){return T.error(c),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){Ye.fetchFn=e}static fetchWellKnownObject(e){return R(function*(){var t;try{if(t=yield Ye.fetch(e,{method:se.Get,signal:Ff(5e3)}),t.status===404)return{raw:{},action:Sn.IGNORE,reason:Ye.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:Sn.FAIL_PROMPT,reason:"General failure"}}catch(l){var r=l,n="";return typeof r=="object"&&(n=r==null?void 0:r.message),{error:r,raw:{},action:Sn.FAIL_PROMPT,reason:n||"General failure"}}try{return{raw:yield t.json(),action:Sn.SUCCESS}}catch(l){var s=l;return{error:s,raw:{},action:Sn.FAIL_PROMPT,reason:(s==null?void 0:s.name)==="SyntaxError"?Ye.ERROR_INVALID_JSON:Ye.ERROR_INVALID}}})()}}y(Ye,"ERROR_INVALID",Nn.Invalid);y(Ye,"ERROR_GENERIC_FAILURE",Nn.GenericFailure);y(Ye,"ERROR_INVALID_HS_BASE_URL",Nn.InvalidHsBaseUrl);y(Ye,"ERROR_INVALID_HOMESERVER",Nn.InvalidHomeserver);y(Ye,"ERROR_INVALID_IS_BASE_URL",Nn.InvalidIsBaseUrl);y(Ye,"ERROR_INVALID_IDENTITY_SERVER",Nn.InvalidIdentityServer);y(Ye,"ERROR_INVALID_IS",Nn.InvalidIs);y(Ye,"ERROR_MISSING_WELLKNOWN",Nn.MissingWellknown);y(Ye,"ERROR_INVALID_JSON",Nn.InvalidJson);y(Ye,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",Nn.UnsupportedHomeserverSpecVersion);y(Ye,"ALL_ERRORS",Object.keys(Nn));y(Ye,"FAIL_ERROR",Sn.FAIL_ERROR);y(Ye,"FAIL_PROMPT",Sn.FAIL_PROMPT);y(Ye,"PROMPT",Sn.PROMPT);y(Ye,"SUCCESS",Sn.SUCCESS);y(Ye,"fetchFn",void 0);var Pg,y0;function bD(){if(y0)return Pg;y0=1;for(var a=/[\\\"\x00-\x1F]/g,e={},t=0;t<32;++t)e[String.fromCharCode(t)]="\\U"+("0000"+t.toString(16)).slice(-4).toUpperCase();e["\b"]="\\b",e["	"]="\\t",e[`
`]="\\n",e["\f"]="\\f",e["\r"]="\\r",e['"']='\\"',e["\\"]="\\\\";function r(c){return a.lastIndex=0,c.replace(a,function(d){return e[d]})}function n(c){switch(typeof c){case"string":return'"'+r(c)+'"';case"number":return isFinite(c)?c:"null";case"boolean":return c;case"object":return c===null?"null":Array.isArray(c)?s(c):l(c);default:throw new Error("Cannot stringify: "+typeof c)}}function s(c){for(var d="[",h="",v=0;v<c.length;++v)h+=d,d=",",h+=n(c[v]);return d!=","?"[]":h+"]"}function l(c){var d="{",h="",v=Object.keys(c);v.sort();for(var p=0;p<v.length;++p){var m=v[p];h+=d+'"'+r(m)+'":',d=",",h+=n(c[m])}return d!=","?"{}":h+"}"}return Pg={stringify:n},Pg}var _D=bD();const Yi=vc(_D);function S0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function ED(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?S0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):S0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var zf=(function(a){return a.Olm="m.olm.v1.curve25519-aes-sha2",a.Megolm="m.megolm.v1.aes-sha2",a.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2",a})(zf||{}),br=zf.Olm,Zr=zf.Megolm,TD=zf.MegolmBackup;function ja(a,e,t,r,n,s,l){return _p.apply(this,arguments)}function _p(){return _p=R(function*(a,e,t,r,n,s,l){var c=s.getIdentityKey(),d=yield r.getSessionIdForDevice(c);if(d===null){T.log("[olmlib.encryptMessageForDevice] Unable to find Olm session for device "+"".concat(n,":").concat(s.deviceId));return}T.log("[olmlib.encryptMessageForDevice] Using Olm session ".concat(d," for device ")+"".concat(n,":").concat(s.deviceId));var h=ED({sender:e,sender_device:t,keys:{ed25519:r.deviceEd25519Key},recipient:n,recipient_keys:{ed25519:s.getFingerprint()}},l);a[c]=yield r.encryptMessage(c,d,JSON.stringify(h))}),_p.apply(this,arguments)}function oR(a,e,t){return Ep.apply(this,arguments)}function Ep(){return Ep=R(function*(a,e,t){var r=new Xt(()=>[]),n=new Xt(()=>new Map),s=[],l=function*(v){var p=function*(b){var E=b.deviceId,M=b.getIdentityKey();s.push(R(function*(){var O=yield a.getSessionIdForDevice(M,!0);O===null?r.getOrCreate(v).push(b):n.getOrCreate(v).set(E,{device:b,sessionId:O})})())};for(var m of d)yield*p(m)};for(var[c,d]of Object.entries(t))yield*l(c);return yield Promise.all(s),[r,n]}),Ep.apply(this,arguments)}function Ji(a,e,t){return Tp.apply(this,arguments)}function Tp(){return Tp=R(function*(a,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,n=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0,l=arguments.length>6&&arguments[6]!==void 0?arguments[6]:T,c=[],d=new Map,h=new Map;for(var v of t.values()){var p=function*(){var B=m.getIdentityKey();if(B===a.deviceCurve25519Key)return 1;a.sessionsInProgress[B]||(a.sessionsInProgress[B]=new Promise(te=>{h.set(B,he=>{delete a.sessionsInProgress[B],te(he)})}))};for(var m of v)yield*p()}for(var[_,b]of t){var E=new Map;d.set(_,E);for(var M of b){var O=M.deviceId,C=M.getIdentityKey();if(C===a.deviceCurve25519Key){l.info("Attempted to start session with ourself! Ignoring"),E.set(O,{device:M,sessionId:null});continue}var U="for ".concat(C," (").concat(_,":").concat(O,")"),I=yield a.getSessionIdForDevice(C,!!h.get(C),l),D=h.get(C);I!==null&&D&&D(),(I===null||r)&&(r?l.info("Forcing new Olm session ".concat(U)):l.info("Making new Olm session ".concat(U)),c.push([_,O])),E.set(O,{device:M,sessionId:I})}}if(c.length===0)return d;var w="signed_curve25519",N,A="one-time keys for ".concat(c.length," devices");try{l.debug("Claiming ".concat(A)),N=yield e.claimOneTimeKeys(c,w,n),l.debug("Claimed ".concat(A))}catch(V){for(var K of h.values())K();throw l.debug("Failed to claim ".concat(A),V,c),V}s&&"failures"in N&&s.push(...Object.keys(N.failures));var z=N.one_time_keys||{},de=[],_e=function*(B){var te=z[B]||{},he=function*(){var ue,we=De.deviceId,Z=De.getIdentityKey();if(Z===a.deviceCurve25519Key||(ue=d.get(B))!==null&&ue!==void 0&&(ue=ue.get(we))!==null&&ue!==void 0&&ue.sessionId&&!r)return 0;var pe=te[we]||{},G=null;for(var q in pe)q.indexOf(w+":")===0&&(G=pe[q]);if(!G){var x;return l.warn("No one-time keys (alg=".concat(w,") ")+"for device ".concat(B,":").concat(we)),(x=h.get(Z))===null||x===void 0||x(),0}de.push(wD(a,G,B,De).then(j=>{var P,J;(P=h.get(Z))===null||P===void 0||P(j??void 0);var Y=(J=d.get(B))===null||J===void 0?void 0:J.get(we);Y&&(Y.sessionId=j)},j=>{var P;throw(P=h.get(Z))===null||P===void 0||P(),j}))},be;for(var De of Ce)be=yield*he()};for(var[le,Ce]of t)yield*_e(le);return A="Olm sessions for ".concat(de.length," devices"),l.debug("Starting ".concat(A)),yield Promise.all(de),l.debug("Started ".concat(A)),d}),Tp.apply(this,arguments)}function wD(a,e,t,r){return wp.apply(this,arguments)}function wp(){return wp=R(function*(a,e,t,r){var n=r.deviceId;try{yield Jo(a,e,t,n,r.getFingerprint())}catch(l){return T.error("Unable to verify signature on one-time key for device "+t+":"+n+":",l),null}var s;try{s=yield a.createOutboundSession(r.getIdentityKey(),e.key)}catch(l){return T.error("Error starting olm session with device "+t+":"+n+": "+l),null}return T.log("Started new olm sessionid "+s+" for device "+t+":"+n),s}),wp.apply(this,arguments)}function Jo(a,e,t,r,n){return Rp.apply(this,arguments)}function Rp(){return Rp=R(function*(a,e,t,r,n){var s="ed25519:"+r,l=e.signatures||{},c=l[t]||{},d=c[s];if(!d)throw Error("No signature");var h=Object.assign({},e);"unsigned"in h&&delete h.unsigned,delete h.signatures;var v=Yi.stringify(h);a.verifySignature(n,v,d)}),Rp.apply(this,arguments)}function of(a,e,t,r){var n=!1;if(e instanceof Uint8Array){var s=new globalThis.Olm.PkSigning;r=s.init_with_seed(e),e=s,n=!0}var l=a.signatures||{};delete a.signatures;var c=a.unsigned;a.unsigned&&delete a.unsigned;try{var d=l[t]||{};return l[t]=d,d["ed25519:"+r]=e.sign(Yi.stringify(a))}finally{a.signatures=l,c&&(a.unsigned=c),n&&e.free()}}function Mo(a,e,t){var r="ed25519:"+e;if(!(a.signatures&&a.signatures[t]&&a.signatures[t][r]))throw new Error("No signature");var n=a.signatures[t][r],s=new globalThis.Olm.Utility,l=a.signatures;delete a.signatures;var c=a.unsigned;a.unsigned&&delete a.unsigned;try{s.ed25519_verify(e,Yi.stringify(a),n)}finally{a.signatures=l,c&&(a.unsigned=c),s.free()}}function ym(a){return a.getSenderKey()?a.getWireType()!==$.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(a.getWireContent().algorithm)?(T.error("Event was not encrypted using an appropriate algorithm"),!1):!0:(T.error("Event has no sender key (not encrypted?)"),!1)}const RD=Object.freeze(Object.defineProperty({__proto__:null,MEGOLM_ALGORITHM:Zr,MEGOLM_BACKUP_ALGORITHM:TD,OLM_ALGORITHM:br,encryptMessageForDevice:ja,ensureOlmSessionsForDevices:Ji,getExistingOlmSessions:oR,isOlmEncrypted:ym,pkSign:of,pkVerify:Mo,verifySignature:Jo},Symbol.toStringTag,{value:"Module"}));var Cp=(function(a){return a.IS="SERVICE_TYPE_IS",a.IM="SERVICE_TYPE_IM",a})({}),en="crypto.",b0=en+"migration",Lg=en+"account",_0=en+"cross_signing_keys",E0=en+"notified_error_devices",T0=en+"device_data",Ia=en+"inboundgroupsessions/",CD=en+"inboundgroupsessions.withheld/",ID=en+"rooms/",ds=en+"sessionsneedingbackup";function fs(a){return en+"sessions/"+a}function w0(a){return en+"session.problems/"+a}function Gd(a,e){return Ia+a+"/"+e}function R0(a,e){return CD+a+"/"+e}function C0(a){return ID+a}class Wf extends Bf{static exists(e){for(var t=e.length,r=0;r<t;r++){var n;if((n=e.key(r))!==null&&n!==void 0&&n.startsWith(en))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return R(function*(){return Wf.exists(e.store)})()}getMigrationState(){var e=this;return R(function*(){var t;return(t=er(e.store,b0))!==null&&t!==void 0?t:zo.NOT_STARTED})()}setMigrationState(e){var t=this;return R(function*(){Xr(t.store,b0,e)})()}countEndToEndSessions(e,t){for(var r=0,n=0;n<this.store.length;++n){var s=this.store.key(n);if(s!=null&&s.startsWith(fs(""))){var l=er(this.store,s);r+=Object.keys(l??{}).length}}t(r)}_getEndToEndSessions(e){var t=er(this.store,fs(e)),r={};for(var[n,s]of Object.entries(t||{}))typeof s=="string"?r[n]={session:s}:r[n]=s;return r}getEndToEndSession(e,t,r,n){var s=this._getEndToEndSessions(e);n(s[t]||{})}getEndToEndSessions(e,t,r){r(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(var r=0;r<this.store.length;++r){var n;if((n=this.store.key(r))!==null&&n!==void 0&&n.startsWith(fs(""))){var s=this.store.key(r).split("/")[1];for(var l of Object.values(this._getEndToEndSessions(s)))t(l)}}}storeEndToEndSession(e,t,r,n){var s=this._getEndToEndSessions(e)||{};s[t]=r,Xr(this.store,fs(e),s)}storeEndToEndSessionProblem(e,t,r){var n=this;return R(function*(){var s=w0(e),l=er(n.store,s)||[];l.push({type:t,fixed:r,time:Date.now()}),l.sort((c,d)=>c.time-d.time),Xr(n.store,s,l)})()}getEndToEndSessionProblem(e,t){var r=this;return R(function*(){var n=w0(e),s=er(r.store,n)||[];if(!s.length)return null;var l=s[s.length-1];for(var c of s)if(c.time>t)return Object.assign({},c,{fixed:l.fixed});return l.fixed?null:l})()}filterOutNotifiedErrorDevices(e){var t=this;return R(function*(){var r=er(t.store,E0)||{},n=[];for(var s of e){var{userId:l,deviceInfo:c}=s;l in r?c.deviceId in r[l]||(n.push(s),fi(r[l],c.deviceId,!0)):(n.push(s),fi(r,l,{[c.deviceId]:!0}))}return Xr(t.store,E0,r),n})()}getEndToEndSessionsBatch(){var e=this;return R(function*(){for(var t=[],r=0;r<e.store.length;++r){var n;if((n=e.store.key(r))!==null&&n!==void 0&&n.startsWith(fs(""))){var s=e.store.key(r).split("/")[1];for(var l of Object.values(e._getEndToEndSessions(s)))if(t.push(l),t.length>=Wo)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){for(var{deviceKey:r,sessionId:n}of e){var s=t._getEndToEndSessions(r)||{};delete s[n],Object.keys(s).length===0?t.store.removeItem(fs(r)):Xr(t.store,fs(r),s)}})()}getEndToEndInboundGroupSession(e,t,r,n){n(er(this.store,Gd(e,t)),er(this.store,R0(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(var r=0;r<this.store.length;++r){var n=this.store.key(r);n!=null&&n.startsWith(Ia)&&t({senderKey:n.slice(Ia.length,Ia.length+43),sessionId:n.slice(Ia.length+44),sessionData:er(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,r,n){var s=er(this.store,Gd(e,t));s||this.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){Xr(this.store,Gd(e,t),r)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){Xr(this.store,R0(e,t),r)}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){for(var t=0,r=0;r<e.store.length;++r){var n=e.store.key(r);n!=null&&n.startsWith(Ia)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){for(var t=er(e.store,ds)||{},r=[],n=0;n<e.store.length;++n){var s=e.store.key(n);if(s!=null&&s.startsWith(Ia)){var l=s.slice(Ia.length);if(r.push({senderKey:l.slice(0,43),sessionId:l.slice(44),sessionData:er(e.store,s),needsBackup:l in t}),r.length>=Wo)return r}}return r.length===0?null:r})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){for(var{senderKey:r,sessionId:n}of e){var s=Gd(r,n);t.store.removeItem(s)}})()}getEndToEndDeviceData(e,t){t(er(this.store,T0))}storeEndToEndDeviceData(e,t){Xr(this.store,T0,e)}storeEndToEndRoom(e,t,r){Xr(this.store,C0(e),t)}getEndToEndRooms(e,t){for(var r={},n=C0(""),s=0;s<this.store.length;++s){var l=this.store.key(s);if(l!=null&&l.startsWith(n)){var c=l.slice(n.length);r[c]=er(this.store,l)}}t(r)}getSessionsNeedingBackup(e){var t=this,r=er(this.store,ds)||{},n=[],s=function(){if(Object.prototype.hasOwnProperty.call(r,l)){var d=l.slice(0,43),h=l.slice(44);if(t.getEndToEndInboundGroupSession(d,h,null,v=>{n.push({senderKey:d,sessionId:h,sessionData:v})}),e&&n.length>=e)return 1}};for(var l in r)if(s())break;return Promise.resolve(n)}countSessionsNeedingBackup(){var e=er(this.store,ds)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){var t=er(this.store,ds)||{};for(var r of e)delete t[r.senderKey+"/"+r.sessionId];return Xr(this.store,ds,t),Promise.resolve()}markSessionsNeedingBackup(e){var t=er(this.store,ds)||{};for(var r of e)t[r.senderKey+"/"+r.sessionId]=!0;return Xr(this.store,ds,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(Lg),Promise.resolve()}getAccount(e,t){var r=er(this.store,Lg);t(r)}storeAccount(e,t){Xr(this.store,Lg,t)}getCrossSigningKeys(e,t){var r=er(this.store,_0);t(r)}getSecretStorePrivateKey(e,t,r){var n=er(this.store,en+"ssss_cache.".concat(r));t(n)}storeCrossSigningKeys(e,t){Xr(this.store,_0,t)}storeSecretStorePrivateKey(e,t,r){Xr(this.store,en+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function er(a,e){try{return JSON.parse(a.getItem(e))}catch(t){T.log("Error: Failed to get key %s: %s",e,t.message),T.log(t.stack)}return null}function Xr(a,e,t){a.setItem(e,JSON.stringify(t))}class OD{constructor(e){this.db=e,y(this,"nextTxnId",0),e.onversionchange=()=>{T.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return R(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return R(function*(){return e})()}deleteAllData(){return R(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return R(function*(){var t=zo.NOT_STARTED;return yield e.doTxn("readonly",[Oe.STORE_ACCOUNT],r=>{var n=r.objectStore(Oe.STORE_ACCOUNT),s=n.get(tp);s.onsuccess=()=>{var l;t=(l=s.result)!==null&&l!==void 0?l:zo.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Oe.STORE_ACCOUNT],r=>{var n=r.objectStore(Oe.STORE_ACCOUNT);n.put(e,tp)})})()}getOrAddOutgoingRoomKeyRequest(e){var t=e.requestBody;return new Promise((r,n)=>{var s=this.db.transaction("outgoingRoomKeyRequests","readwrite");s.onerror=n,this._getOutgoingRoomKeyRequest(s,t,l=>{if(l){T.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),r(l);return}T.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),s.oncomplete=()=>{r(e)};var c=s.objectStore("outgoingRoomKeyRequests");c.add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,r)=>{var n=this.db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=r,this._getOutgoingRoomKeyRequest(n,e,s=>{t(s)})})}_getOutgoingRoomKeyRequest(e,t,r){var n=e.objectStore("outgoingRoomKeyRequests"),s=n.index("session"),l=s.openCursor([t.room_id,t.session_id]);l.onsuccess=()=>{var c=l.result;if(!c){r(null);return}var d=c.value;if(Ms(d.requestBody,t)){r(d);return}c.continue()}}getOutgoingRoomKeyRequestByState(e){if(e.length===0)return Promise.resolve(null);var t=0,r;function n(){var h=this.result;if(h){r=h.value;return}if(t++,!(t>=e.length)){var v=e[t],p=this.source.openCursor(v);p.onsuccess=n}}var s=this.db.transaction("outgoingRoomKeyRequests","readonly"),l=s.objectStore("outgoingRoomKeyRequests"),c=e[t],d=l.index("state").openCursor(c);return d.onsuccess=n,hs(s).then(()=>r)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,r)=>{var n=this.db.transaction("outgoingRoomKeyRequests","readonly"),s=n.objectStore("outgoingRoomKeyRequests"),l=s.index("state"),c=l.getAll(e);c.onsuccess=()=>t(c.result),c.onerror=()=>r(c.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,r){var n=0,s=[];function l(){var p=this.result;if(p){var m=p.value;m.recipients.some(E=>E.userId===e&&E.deviceId===t)&&s.push(m),p.continue()}else{if(n++,n>=r.length)return;var _=r[n],b=this.source.openCursor(_);b.onsuccess=l}}var c=this.db.transaction("outgoingRoomKeyRequests","readonly"),d=c.objectStore("outgoingRoomKeyRequests"),h=r[n],v=d.index("state").openCursor(h);return v.onsuccess=l,hs(c).then(()=>s)}updateOutgoingRoomKeyRequest(e,t,r){var n=null;function s(){var d=this.result;if(d){var h=d.value;if(h.state!=t){T.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(h.state));return}Object.assign(h,r),d.update(h),n=h}}var l=this.db.transaction("outgoingRoomKeyRequests","readwrite"),c=l.objectStore("outgoingRoomKeyRequests").openCursor(e);return c.onsuccess=s,hs(l).then(()=>n)}deleteOutgoingRoomKeyRequest(e,t){var r=this.db.transaction("outgoingRoomKeyRequests","readwrite"),n=r.objectStore("outgoingRoomKeyRequests").openCursor(e);return n.onsuccess=()=>{var s=n.result;if(s){var l=s.value;if(l.state!=t){T.warn("Cannot delete room key request in state ".concat(l.state," ")+"(expected ".concat(t,")"));return}s.delete()}},hs(r)}getAccount(e,t){var r=e.objectStore("account"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(s){pr(e,s)}}}storeAccount(e,t){var r=e.objectStore("account");r.put(t,"-")}getCrossSigningKeys(e,t){var r=e.objectStore("account"),n=r.get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(s){pr(e,s)}}}getSecretStorePrivateKey(e,t,r){var n=e.objectStore("account"),s=n.get("ssss_cache:".concat(r));s.onsuccess=function(){try{t(s.result||null)}catch(l){pr(e,l)}}}storeCrossSigningKeys(e,t){var r=e.objectStore("account");r.put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,r){var n=e.objectStore("account");n.put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.count();n.onsuccess=function(){try{t(n.result)}catch(s){pr(e,s)}}}getEndToEndSessions(e,t,r){var n=t.objectStore("sessions"),s=n.index("deviceKey"),l=s.openCursor(e),c={};l.onsuccess=function(){var d=l.result;if(d)c[d.value.sessionId]={session:d.value.session,lastReceivedMessageTs:d.value.lastReceivedMessageTs},d.continue();else try{r(c)}catch(h){pr(t,h)}}}getEndToEndSession(e,t,r,n){var s=r.objectStore("sessions"),l=s.get([e,t]);l.onsuccess=function(){try{l.result?n({session:l.result.session,lastReceivedMessageTs:l.result.lastReceivedMessageTs}):n(null)}catch(c){pr(r,c)}}}getAllEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.openCursor();n.onsuccess=function(){try{var s=n.result;s?(t(s.value),s.continue()):t(null)}catch(l){pr(e,l)}}}storeEndToEndSession(e,t,r,n){var s=n.objectStore("sessions");s.put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}storeEndToEndSessionProblem(e,t,r){var n=this;return R(function*(){var s=n.db.transaction("session_problems","readwrite"),l=s.objectStore("session_problems");l.put({deviceKey:e,type:t,fixed:r,time:Date.now()}),yield hs(s)})()}getEndToEndSessionProblem(e,t){var r=this;return R(function*(){var n=null,s=r.db.transaction("session_problems","readwrite"),l=s.objectStore("session_problems"),c=l.index("deviceKey"),d=c.getAll(e);return d.onsuccess=()=>{var h=d.result;if(!h.length){n=null;return}h.sort((m,_)=>m.time-_.time);var v=h[h.length-1];for(var p of h)if(p.time>t){n=Object.assign({},p,{fixed:v.fixed});return}v.fixed?n=null:n=v},yield hs(s),n})()}filterOutNotifiedErrorDevices(e){var t=this;return R(function*(){var r=t.db.transaction("notified_error_devices","readwrite"),n=r.objectStore("notified_error_devices"),s=[];return yield Promise.all(e.map(l=>new Promise(c=>{var{userId:d,deviceInfo:h}=l,v=n.get([d,h.deviceId]);v.onsuccess=function(){v.result||(n.put({userId:d,deviceId:h.deviceId}),s.push(l)),c()}}))),s})()}getEndToEndSessionsBatch(){var e=this;return R(function*(){var t=[];return yield e.doTxn("readonly",[Oe.STORE_SESSIONS],r=>{var n=r.objectStore(Oe.STORE_SESSIONS),s=n.openCursor();s.onsuccess=function(){try{var l=s.result;l&&(t.push(l.value),t.length<Wo&&l.continue())}catch(c){pr(r,c)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Oe.STORE_SESSIONS],(function(){var r=R(function*(n){try{var s=n.objectStore(Oe.STORE_SESSIONS),l=function*(){var v=s.delete([c,d]);yield new Promise(p=>{v.onsuccess=p})};for(var{deviceKey:c,sessionId:d}of e)yield*l()}catch(h){pr(n,h)}});return function(n){return r.apply(this,arguments)}})())})()}getEndToEndInboundGroupSession(e,t,r,n){var s=!1,l=!1,c=r.objectStore("inbound_group_sessions"),d=c.get([e,t]);d.onsuccess=function(){try{d.result?s=d.result.session:s=null,l!==!1&&n(s,l)}catch(p){pr(r,p)}};var h=r.objectStore("inbound_group_sessions_withheld"),v=h.get([e,t]);v.onsuccess=function(){try{v.result?l=v.result.session:l=null,s!==!1&&n(s,l)}catch(p){pr(r,p)}}}getAllEndToEndInboundGroupSessions(e,t){var r=e.objectStore("inbound_group_sessions"),n=r.openCursor();n.onsuccess=function(){var s=n.result;if(s){try{t({senderKey:s.value.senderCurve25519Key,sessionId:s.value.sessionId,sessionData:s.value.session})}catch(l){pr(e,l)}s.continue()}else try{t(null)}catch(l){pr(e,l)}}}addEndToEndInboundGroupSession(e,t,r,n){var s=n.objectStore("inbound_group_sessions"),l=s.add({senderCurve25519Key:e,sessionId:t,session:r});l.onerror=c=>{var d;((d=l.error)===null||d===void 0?void 0:d.name)==="ConstraintError"?(c.stopPropagation(),c.preventDefault(),T.log("Ignoring duplicate inbound group session: "+e+" / "+t)):pr(n,new Error("Failed to add inbound group session: "+l.error))}}storeEndToEndInboundGroupSession(e,t,r,n){var s=n.objectStore("inbound_group_sessions");s.put({senderCurve25519Key:e,sessionId:t,session:r})}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){var s=n.objectStore("inbound_group_sessions_withheld");s.put({senderCurve25519Key:e,sessionId:t,session:r})}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){var t=0;return yield e.doTxn("readonly",[Oe.STORE_INBOUND_GROUP_SESSIONS],r=>{var n=r.objectStore(Oe.STORE_INBOUND_GROUP_SESSIONS),s=n.count();s.onsuccess=()=>{t=s.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){var t=[];return yield e.doTxn("readonly",[Oe.STORE_INBOUND_GROUP_SESSIONS,Oe.STORE_BACKUP],r=>{var n=r.objectStore(Oe.STORE_INBOUND_GROUP_SESSIONS),s=r.objectStore(Oe.STORE_BACKUP),l=n.openCursor();l.onsuccess=function(){try{var c=l.result;if(c){var d=s.get(c.key);d.onsuccess=()=>{t.push({senderKey:c.value.senderCurve25519Key,sessionId:c.value.sessionId,sessionData:c.value.session,needsBackup:d.result!==void 0}),t.length<Wo&&c.continue()}}}catch(h){pr(r,h)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Oe.STORE_INBOUND_GROUP_SESSIONS],(function(){var r=R(function*(n){try{var s=n.objectStore(Oe.STORE_INBOUND_GROUP_SESSIONS),l=function*(){var v=s.delete([c,d]);yield new Promise(p=>{v.onsuccess=p})};for(var{senderKey:c,sessionId:d}of e)yield*l()}catch(h){pr(n,h)}});return function(n){return r.apply(this,arguments)}})())})()}getEndToEndDeviceData(e,t){var r=e.objectStore("device_data"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(s){pr(e,s)}}}storeEndToEndDeviceData(e,t){var r=t.objectStore("device_data");r.put(e,"-")}storeEndToEndRoom(e,t,r){var n=r.objectStore("rooms");n.put(t,e)}getEndToEndRooms(e,t){var r={},n=e.objectStore("rooms"),s=n.openCursor();s.onsuccess=function(){var l=s.result;if(l)r[l.key]=l.value,l.continue();else try{t(r)}catch(c){pr(e,c)}}}getSessionsNeedingBackup(e){return new Promise((t,r)=>{var n=[],s=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");s.onerror=r,s.oncomplete=function(){t(n)};var l=s.objectStore("sessions_needing_backup"),c=s.objectStore("inbound_group_sessions"),d=l.openCursor();d.onsuccess=function(){var h=d.result;if(h){var v=c.get(h.key);v.onsuccess=function(){n.push({senderKey:v.result.senderCurve25519Key,sessionId:v.result.sessionId,sessionData:v.result.session})},(!e||n.length<e)&&h.continue()}}})}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));var t=e.objectStore("sessions_needing_backup");return new Promise((r,n)=>{var s=t.count();s.onerror=n,s.onsuccess=()=>r(s.result)})}unmarkSessionsNeedingBackup(e,t){var r=this;return R(function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(s=>new Promise((l,c)=>{var d=n.delete([s.senderKey,s.sessionId]);d.onsuccess=l,d.onerror=c})))})()}markSessionsNeedingBackup(e,t){var r=this;return R(function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(s=>new Promise((l,c)=>{var d=n.put({senderCurve25519Key:s.senderKey,sessionId:s.sessionId});d.onsuccess=l,d.onerror=c})))})()}addSharedHistoryInboundGroupSession(e,t,r,n){n||(n=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));var s=n.objectStore("shared_history_inbound_group_sessions"),l=s.get([e]);l.onsuccess=()=>{var{sessions:c}=l.result||{sessions:[]};c.push([t,r]),s.put({roomId:e,sessions:c})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));var r=t.objectStore("shared_history_inbound_group_sessions"),n=r.get([e]);return new Promise((s,l)=>{n.onsuccess=()=>{var{sessions:c}=n.result||{sessions:[]};s(c)},n.onerror=l})}addParkedSharedHistory(e,t,r){r||(r=this.db.transaction("parked_shared_history","readwrite"));var n=r.objectStore("parked_shared_history"),s=n.get([e]);s.onsuccess=()=>{var{parked:l}=s.result||{parked:[]};l.push(t),n.put({roomId:e,parked:l})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));var r=t.objectStore("parked_shared_history").openCursor(e);return new Promise((n,s)=>{r.onsuccess=()=>{var l=r.result;if(!l){n([]);return}var c=l.value;l.delete(),n(c)},r.onerror=s})}doTxn(e,t,r){var n=this.db.transaction(t,e),s=hs(n),l=r(n);return s.then(()=>l)}}var lR=[a=>{AD(a)},a=>{a.createObjectStore("account")},a=>{var e=a.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},a=>{a.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},a=>{a.createObjectStore("device_data")},a=>{a.createObjectStore("rooms")},a=>{a.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},a=>{a.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},a=>{var e=a.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),a.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},a=>{a.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},a=>{a.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],uR=lR.length;function kD(a,e){T.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(uR)),lR.forEach((t,r)=>{e<=r&&t(a)})}function AD(a){var e=a.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function pr(a,e){a._mx_abortexception=e;try{a.abort()}catch{}}function hs(a){return new Promise((e,t)=>{a.oncomplete=()=>{a._mx_abortexception!==void 0&&t(a._mx_abortexception),e(null)},a.onerror=r=>{a._mx_abortexception!==void 0?t(a._mx_abortexception):(T.log("Error performing indexeddb txn",r),t(a.error))},a.onabort=r=>{a._mx_abortexception!==void 0?t(a._mx_abortexception):(T.log("Error performing indexeddb txn",r),t(a.error))}})}var Sm=(function(a){return a.TooNew="TOO_NEW",a})({});class bm extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}y(bm,"TOO_NEW",Sm.TooNew);class ju extends Error{constructor(e,t){super(e),this.value=t}}class DD extends Error{constructor(){super("MatrixClient has been stopped")}}function cR(a,e){return new Promise((t,r)=>{var n=!0,s=a.open(e);s.onupgradeneeded=()=>{n=!1},s.onblocked=()=>r(s.error),s.onsuccess=()=>{var l=s.result;l.close(),n||a.deleteDatabase(e),t(n)},s.onerror=()=>r(s.error)})}class Oe{static exists(e,t){return cR(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((r,n)=>{var s=!0,l=e.open(t);l.onupgradeneeded=()=>{s=!1},l.onblocked=()=>n(l.error),l.onsuccess=()=>{var c=l.result;if(!s)c.close(),e.deleteDatabase(t),r(!1);else{var d=c.transaction([Oe.STORE_ACCOUNT],"readonly"),h=d.objectStore(Oe.STORE_ACCOUNT),v=h.get(tp);v.onsuccess=()=>{var p,m=(p=v.result)!==null&&p!==void 0?p:zo.NOT_STARTED;r(m===zo.NOT_STARTED)},v.onerror=()=>{n(v.error)},c.close()}},l.onerror=()=>n(l.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,y(this,"backendPromise",void 0),y(this,"backend",void 0)}containsData(){var e=this;return R(function*(){return Oe.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}T.log("connecting to indexeddb ".concat(this.dbName));var r=this.indexedDB.open(this.dbName,uR);r.onupgradeneeded=n=>{var s=r.result,l=n.oldVersion;kD(s,l)},r.onblocked=()=>{T.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{T.log("Error connecting to indexeddb",n),t(r.error)},r.onsuccess=()=>{var n=r.result;T.log("connected to indexeddb ".concat(this.dbName)),e(new OD(n))}}).then(e=>e.doTxn("readonly",[Oe.STORE_INBOUND_GROUP_SESSIONS,Oe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw T.warn("Crypto DB is too new for us to use!",e),new bm(Sm.TooNew);T.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{return new Wf(globalThis.localStorage)}catch(t){return T.warn("unable to open localStorage: falling back to in-memory store: ".concat(t)),new Bf}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}T.log("Removing indexeddb instance: ".concat(this.dbName));var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{T.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{T.log("Error deleting data from indexeddb",n),t(r.error)},r.onsuccess=()=>{T.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{T.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,r){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,r)}updateOutgoingRoomKeyRequest(e,t,r){return this.backend.updateOutgoingRoomKeyRequest(e,t,r)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}storeEndToEndSessionProblem(e,t,r){return this.backend.storeEndToEndSessionProblem(e,t,r)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,r,n){this.backend.addEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,r){this.backend.storeEndToEndRoom(e,t,r)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,r,n){this.backend.addSharedHistoryInboundGroupSession(e,t,r,n)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,r){this.backend.addParkedSharedHistory(e,t,r)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}}y(Oe,"STORE_ACCOUNT","account");y(Oe,"STORE_SESSIONS","sessions");y(Oe,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");y(Oe,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");y(Oe,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");y(Oe,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");y(Oe,"STORE_DEVICE_DATA","device_data");y(Oe,"STORE_ROOMS","rooms");y(Oe,"STORE_BACKUP","sessions_needing_backup");var Ts=(function(a){return a.Change="change",a})({}),Va=(function(a){return a[a.Unsent=1]="Unsent",a[a.Requested=2]="Requested",a[a.Ready=3]="Ready",a[a.Started=4]="Started",a[a.Cancelled=5]="Cancelled",a[a.Done=6]="Done",a})({}),Yf=(function(a){return a.Cancel="cancel",a.ShowSas="show_sas",a.ShowReciprocateQr="show_reciprocate_qr",a})({});function dR(a){return a.phase<Va.Ready&&!a.accepting&&!a.declining}function MD(a){if(a.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let h=0;h<e.length;h++)e[h]=255;for(let h=0;h<a.length;h++){const v=a.charAt(h),p=v.charCodeAt(0);if(e[p]!==255)throw new TypeError(v+" is ambiguous");e[p]=h}const t=a.length,r=a.charAt(0),n=Math.log(t)/Math.log(256),s=Math.log(256)/Math.log(t);function l(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";let v=0,p=0,m=0;const _=h.length;for(;m!==_&&h[m]===0;)m++,v++;const b=(_-m)*s+1>>>0,E=new Uint8Array(b);for(;m!==_;){let C=h[m],U=0;for(let I=b-1;(C!==0||U<p)&&I!==-1;I--,U++)C+=256*E[I]>>>0,E[I]=C%t>>>0,C=C/t>>>0;if(C!==0)throw new Error("Non-zero carry");p=U,m++}let M=b-p;for(;M!==b&&E[M]===0;)M++;let O=r.repeat(v);for(;M<b;++M)O+=a.charAt(E[M]);return O}function c(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;let v=0,p=0,m=0;for(;h[v]===r;)p++,v++;const _=(h.length-v)*n+1>>>0,b=new Uint8Array(_);for(;v<h.length;){const C=h.charCodeAt(v);if(C>255)return;let U=e[C];if(U===255)return;let I=0;for(let D=_-1;(U!==0||I<m)&&D!==-1;D--,I++)U+=t*b[D]>>>0,b[D]=U%256>>>0,U=U/256>>>0;if(U!==0)throw new Error("Non-zero carry");m=I,v++}let E=_-m;for(;E!==_&&b[E]===0;)E++;const M=new Uint8Array(p+(_-E));let O=p;for(;E!==_;)M[O++]=b[E++];return M}function d(h){const v=c(h);if(v)return v;throw new Error("Non-base"+t+" character")}return{encode:l,decodeUnsafe:c,decode:d}}var ND="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const fR=MD(ND);var Na=[139,1],I0=32;function If(a){var e,t=Buffer.alloc(Na.length+a.length+1);t.set(Na,0),t.set(a,Na.length);for(var r=0,n=0;n<t.length-1;++n)r^=t[n];t[t.length-1]=r;var s=fR.encode(t);return(e=s.match(/.{1,4}/g))===null||e===void 0?void 0:e.join(" ")}function Yu(a){var e=fR.decode(a.replace(/ /g,"")),t=0;for(var r of e)t^=r;if(t!==0)throw new Error("Incorrect parity");for(var n=0;n<Na.length;++n)if(e[n]!==Na[n])throw new Error("Incorrect prefix");if(e.length!==Na.length+I0+1)throw new Error("Incorrect length");return Uint8Array.from(e.slice(Na.length,Na.length+I0))}var UD=256;function _m(a,e,t){return Ip.apply(this,arguments)}function Ip(){return Ip=R(function*(a,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:UD;if(!globalThis.crypto.subtle||!TextEncoder)throw new Error("Password-based backup is not available on this platform");var n=yield globalThis.crypto.subtle.importKey("raw",new TextEncoder().encode(a),{name:"PBKDF2"},!1,["deriveBits"]),s=yield globalThis.crypto.subtle.deriveBits({name:"PBKDF2",salt:new TextEncoder().encode(e),iterations:t,hash:"SHA-512"},n,r);return new Uint8Array(s)}),Ip.apply(this,arguments)}var tr=(function(a){return a.UserTrustStatusChanged="userTrustStatusChanged",a.KeyBackupStatus="crypto.keyBackupStatus",a.KeyBackupFailed="crypto.keyBackupFailed",a.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",a.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",a.VerificationRequestReceived="crypto.verificationRequestReceived",a.WillUpdateDevices="crypto.willUpdateDevices",a.DevicesUpdated="crypto.devicesUpdated",a.KeysChanged="crossSigning.keysChanged",a.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",a})({}),zt=(function(a){return a.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",a.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",a.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",a.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",a.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",a.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",a.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",a.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",a.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",a.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",a.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",a.UNKNOWN_ERROR="UNKNOWN_ERROR",a.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",a.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",a.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",a.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",a.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",a.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",a.OLM_BAD_ROOM="OLM_BAD_ROOM",a.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",a.OLM_BAD_SENDER="OLM_BAD_SENDER",a.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",a.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",a.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",a.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",a})({}),Em=(function(a){return a[a.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",a[a.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",a})({});class PD{constructor(e){this.errorOnVerifiedUserProblems=e,y(this,"kind",Em.AllDevicesIsolationMode)}}class LD{constructor(){y(this,"kind",Em.OnlySignedDevicesIsolationMode)}}class Ju{constructor(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r,y(this,"needsUserApproval",void 0),this.needsUserApproval=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class hR{constructor(e){var t,r,n,s,l;y(this,"signedByOwner",void 0),y(this,"crossSigningVerified",void 0),y(this,"tofu",void 0),y(this,"localVerified",void 0),y(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(r=e.crossSigningVerified)!==null&&r!==void 0?r:!1,this.tofu=(n=e.tofu)!==null&&n!==void 0?n:!1,this.localVerified=(s=e.localVerified)!==null&&s!==void 0?s:!1,this.trustCrossSignedDevices=(l=e.trustCrossSignedDevices)!==null&&l!==void 0?l:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var Tm=(function(a){return a.Master="master",a.SelfSigning="self_signing",a.UserSigning="user_signing",a})({}),Oa=(function(a){return a[a.NONE=0]="NONE",a[a.GREY=1]="GREY",a[a.RED=2]="RED",a})({}),No=(function(a){return a[a.UNKNOWN=0]="UNKNOWN",a[a.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",a[a.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",a[a.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",a[a.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",a[a.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",a})({});const xD=Object.freeze(Object.defineProperty({__proto__:null,AllDevicesIsolationMode:PD,CrossSigningKey:Tm,CryptoEvent:tr,DecryptionFailureCode:zt,DeviceIsolationModeKind:Em,DeviceVerificationStatus:hR,EventShieldColour:Oa,EventShieldReason:No,OnlySignedDevicesIsolationMode:LD,UserVerificationStatus:Ju,VerificationPhase:Va,VerificationRequestEvent:Ts,VerifierEvent:Yf,canAcceptVerificationRequest:dR,decodeRecoveryKey:Yu,deriveRecoveryKeyFromPassphrase:_m,encodeRecoveryKey:If},Symbol.toStringTag,{value:"Module"}));class dr extends Error{constructor(e,t,r){super(t),this.code=e,y(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=BD(this,r)}}function BD(a,e){var t=a.name+"[msg: "+a.message;return e&&(t+=", "+Object.keys(e).map(r=>r+": "+e[r]).join(", ")),t+="]",t}var O0=65536*3/4;class KD extends Error{constructor(){super(...arguments),y(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function k0(a){if(a===void 0)throw new Error("payloadString undefined");if(a.length>O0)throw new KD("Message too long (".concat(a.length," bytes). ")+"The maximum for an encrypted message is ".concat(O0," bytes."))}class A0{constructor(e){this.cryptoStore=e,y(this,"pickleKey","DEFAULT_KEY"),y(this,"deviceCurve25519Key",null),y(this,"deviceEd25519Key",null),y(this,"maxOneTimeKeys",null),y(this,"outboundGroupSessionStore",{}),y(this,"inboundGroupSessionMessageIndexes",{}),y(this,"sessionsInProgress",{}),y(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return globalThis.Olm.get_library_version()}init(){var e=arguments,t=this;return R(function*(){var{pickleKey:r,fromExportedDevice:n}=e.length>0&&e[0]!==void 0?e[0]:{},s,l=new globalThis.Olm.Account;try{n?(r&&T.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),t.pickleKey=n.pickleKey,yield t.initialiseFromExportedDevice(n,l)):(r&&(t.pickleKey=r),yield t.initialiseAccount(l)),s=JSON.parse(l.identity_keys()),t.maxOneTimeKeys=l.max_number_of_one_time_keys()}finally{l.free()}t.deviceCurve25519Key=s.curve25519,t.deviceEd25519Key=s.ed25519})()}initialiseFromExportedDevice(e,t){var r=this;return R(function*(){yield r.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT,Oe.STORE_SESSIONS],n=>{r.cryptoStore.storeAccount(n,e.pickledAccount),e.sessions.forEach(s=>{var{deviceKey:l,sessionId:c}=s,d={session:s.session,lastReceivedMessageTs:s.lastReceivedMessageTs};r.cryptoStore.storeEndToEndSession(l,c,d,n)})}),t.unpickle(r.pickleKey,e.pickledAccount)})()}initialiseAccount(e){var t=this;return R(function*(){yield t.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],r=>{t.cryptoStore.getAccount(r,n=>{n!==null?e.unpickle(t.pickleKey,n):(e.create(),n=e.pickle(t.pickleKey),t.cryptoStore.storeAccount(r,n))})})})()}getAccount(e,t){this.cryptoStore.getAccount(e,r=>{var n=new globalThis.Olm.Account;try{n.unpickle(this.pickleKey,r),t(n)}finally{n.free()}})}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}export(){var e=this;return R(function*(){var t={pickleKey:e.pickleKey};return yield e.cryptoStore.doTxn("readonly",[Oe.STORE_ACCOUNT,Oe.STORE_SESSIONS],r=>{e.cryptoStore.getAccount(r,n=>{t.pickledAccount=n}),t.sessions=[],e.cryptoStore.getAllEndToEndSessions(r,n=>{t.sessions.push(n)})}),t})()}getSession(e,t,r,n){this.cryptoStore.getEndToEndSession(e,t,r,s=>{this.unpickleSession(s,n)})}unpickleSession(e,t){var r=new globalThis.Olm.Session;try{r.unpickle(this.pickleKey,e.session);var n=Object.assign({},e,{session:r});t(n)}finally{r.free()}}saveSession(e,t,r){var n=t.session.session_id();T.debug("Saving Olm session ".concat(n," with device ").concat(e,": ").concat(t.session.describe()));var s=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,n,s,r)}getUtility(e){var t=new globalThis.Olm.Utility;try{return e(t)}finally{t.free()}}sign(e){var t=this;return R(function*(){var r;return yield t.cryptoStore.doTxn("readonly",[Oe.STORE_ACCOUNT],n=>{t.getAccount(n,s=>{r=s.sign(e)})}),r})()}getOneTimeKeys(){var e=this;return R(function*(){var t;return yield e.cryptoStore.doTxn("readonly",[Oe.STORE_ACCOUNT],r=>{e.getAccount(r,n=>{t=JSON.parse(n.one_time_keys())})}),t})()}maxNumberOfOneTimeKeys(){var e;return(e=this.maxOneTimeKeys)!==null&&e!==void 0?e:-1}markKeysAsPublished(){var e=this;return R(function*(){yield e.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],t=>{e.getAccount(t,r=>{r.mark_keys_as_published(),e.storeAccount(t,r)})})})()}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],t=>{this.getAccount(t,r=>{r.generate_one_time_keys(e),this.storeAccount(t,r)})})}generateFallbackKey(){var e=this;return R(function*(){yield e.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],t=>{e.getAccount(t,r=>{r.generate_fallback_key(),e.storeAccount(t,r)})})})()}getFallbackKey(){var e=this;return R(function*(){var t;return yield e.cryptoStore.doTxn("readonly",[Oe.STORE_ACCOUNT],r=>{e.getAccount(r,n=>{t=JSON.parse(n.unpublished_fallback_key())})}),t})()}forgetOldFallbackKey(){var e=this;return R(function*(){yield e.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],t=>{e.getAccount(t,r=>{r.forget_old_fallback_key(),e.storeAccount(t,r)})})})()}createOutboundSession(e,t){var r=this;return R(function*(){var n;return yield r.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT,Oe.STORE_SESSIONS],s=>{r.getAccount(s,l=>{var c=new globalThis.Olm.Session;try{c.create_outbound(l,e,t),n=c.session_id(),r.storeAccount(s,l);var d={session:c,lastReceivedMessageTs:Date.now()};r.saveSession(e,d,s)}finally{c.free()}})},T.getChild("[createOutboundSession]")),n})()}createInboundSession(e,t,r){var n=this;return R(function*(){if(t!==0)throw new Error("Need messageType == 0 to create inbound session");var s;return yield n.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT,Oe.STORE_SESSIONS],l=>{n.getAccount(l,c=>{var d=new globalThis.Olm.Session;try{d.create_inbound_from(c,e,r),c.remove_one_time_keys(d),n.storeAccount(l,c);var h=d.decrypt(t,r),v={session:d,lastReceivedMessageTs:Date.now()};n.saveSession(e,v,l),s={payload:h,session_id:d.session_id()}}finally{d.free()}})},T.getChild("[createInboundSession]")),s})()}getSessionIdsForDevice(e){var t=this;return R(function*(){var r=T.getChild("[getSessionIdsForDevice]");if(e in t.sessionsInProgress){r.debug("Waiting for Olm session for ".concat(e," to be created"));try{yield t.sessionsInProgress[e]}catch{}}var n;return yield t.cryptoStore.doTxn("readonly",[Oe.STORE_SESSIONS],s=>{t.cryptoStore.getEndToEndSessions(e,s,l=>{n=Object.keys(l)})},r),n})()}getSessionIdForDevice(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2?t[2]:void 0,l=yield r.getSessionInfoForDevice(e,n,s);if(l.length===0)return null;for(var c=0,d=1;d<l.length;d++){var h=l[d],v=h.lastReceivedMessageTs===void 0?0:h.lastReceivedMessageTs,p=l[c],m=p.lastReceivedMessageTs===void 0?0:p.lastReceivedMessageTs;(v>m||v===m&&h.sessionId<p.sessionId)&&(c=d)}return l[c].sessionId})()}getSessionInfoForDevice(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2&&t[2]!==void 0?t[2]:T;if(s=s.getChild("[getSessionInfoForDevice]"),e in r.sessionsInProgress&&!n){s.debug("Waiting for Olm session for ".concat(e," to be created"));try{yield r.sessionsInProgress[e]}catch{}}var l=[];return yield r.cryptoStore.doTxn("readonly",[Oe.STORE_SESSIONS],c=>{r.cryptoStore.getEndToEndSessions(e,c,d=>{var h=Object.keys(d).sort(),v=function(_){r.unpickleSession(d[_],b=>{l.push({lastReceivedMessageTs:b.lastReceivedMessageTs,hasReceivedMessage:b.session.has_received_message(),sessionId:_})})};for(var p of h)v(p)})},s),l})()}encryptMessage(e,t,r){var n=this;return R(function*(){k0(r);var s;return yield n.cryptoStore.doTxn("readwrite",[Oe.STORE_SESSIONS],l=>{n.getSession(e,t,l,c=>{var d=c.session.describe();T.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+d),s=c.session.encrypt(r),n.saveSession(e,c,l)})},T.getChild("[encryptMessage]")),s})()}decryptMessage(e,t,r,n){var s=this;return R(function*(){var l;return yield s.cryptoStore.doTxn("readwrite",[Oe.STORE_SESSIONS],c=>{s.getSession(e,t,c,d=>{var h=d.session.describe();T.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+h),l=d.session.decrypt(r,n),d.lastReceivedMessageTs=Date.now(),s.saveSession(e,d,c)})},T.getChild("[decryptMessage]")),l})()}matchesSession(e,t,r,n){var s=this;return R(function*(){if(r!==0)return!1;var l;return yield s.cryptoStore.doTxn("readonly",[Oe.STORE_SESSIONS],c=>{s.getSession(e,t,c,d=>{l=d.session.matches_inbound(n)})},T.getChild("[matchesSession]")),l})()}recordSessionProblem(e,t,r){var n=this;return R(function*(){T.info("Recording problem on olm session with ".concat(e," of type ").concat(t,". Recreating: ").concat(r)),yield n.cryptoStore.storeEndToEndSessionProblem(e,t,r)})()}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){var r=this.outboundGroupSessionStore[e];if(r===void 0)throw new Error("Unknown outbound group session "+e);var n=new globalThis.Olm.OutboundGroupSession;try{return n.unpickle(this.pickleKey,r),t(n)}finally{n.free()}}createOutboundGroupSession(){var e=new globalThis.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return T.log("encrypting msg with megolm session ".concat(e)),k0(t),this.getOutboundGroupSession(e,r=>{var n=r.encrypt(t);return this.saveOutboundGroupSession(r),n})}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,function(t){return{chain_index:t.message_index(),key:t.session_key()}})}unpickleInboundGroupSession(e,t){var r=new globalThis.Olm.InboundGroupSession;try{return r.unpickle(this.pickleKey,e.session),t(r)}finally{r.free()}}getInboundGroupSession(e,t,r,n,s){this.cryptoStore.getEndToEndInboundGroupSession(t,r,n,(l,c)=>{if(l===null){s(null,null,c);return}if(e!==null&&e!==l.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+l.room_id+", was "+e+")");this.unpickleInboundGroupSession(l,d=>{s(d,l,c)})})}addInboundGroupSession(e,t,r,n,s,l,c){var d=arguments,h=this;return R(function*(){var v=d.length>7&&d[7]!==void 0?d[7]:{};yield h.cryptoStore.doTxn("readwrite",[Oe.STORE_INBOUND_GROUP_SESSIONS,Oe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,Oe.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],p=>{h.getInboundGroupSession(e,t,n,p,(m,_)=>{var b=new globalThis.Olm.InboundGroupSession;try{if(c?b.import_session(s):b.create(s),n!=b.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(m&&(T.log("Update for megolm session ".concat(t,"|").concat(n)),m.first_known_index()<=b.first_known_index())){if(!_.untrusted||v.untrusted){T.log("Keeping existing megolm session ".concat(t,"|").concat(n));return}if(m.first_known_index()<b.first_known_index()){m.export_session(b.first_known_index())===b.export_session(b.first_known_index())?(T.info("Upgrading trust of existing megolm session "+"".concat(t,"|").concat(n," based on newly-received trusted session")),_.untrusted=!1,h.cryptoStore.storeEndToEndInboundGroupSession(t,n,_,p)):T.warn("Newly-received megolm session ".concat(t,"|$sessionId}")+" does not match existing session! Keeping existing session");return}}T.debug("Storing megolm session ".concat(t,"|").concat(n," with first index ")+b.first_known_index());var E=Object.assign({},v,{room_id:e,session:b.pickle(h.pickleKey),keysClaimed:l,forwardingCurve25519KeyChain:r});h.cryptoStore.storeEndToEndInboundGroupSession(t,n,E,p),!m&&v.sharedHistory&&h.cryptoStore.addSharedHistoryInboundGroupSession(e,t,n,p)}finally{b.free()}})},T.getChild("[addInboundGroupSession]"))})()}addInboundGroupSessionWithheld(e,t,r,n,s){var l=this;return R(function*(){yield l.cryptoStore.doTxn("readwrite",[Oe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],c=>{l.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,r,{room_id:e,code:n,reason:s},c)})})()}decryptGroupMessage(e,t,r,n,s,l){var c=this;return R(function*(){var d=null,h;if(yield c.cryptoStore.doTxn("readwrite",[Oe.STORE_INBOUND_GROUP_SESSIONS,Oe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],v=>{c.getInboundGroupSession(e,t,r,v,(p,m,_)=>{if(p===null||m===null){if(_){var b=_.code==="m.unverified"?zt.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:zt.MEGOLM_KEY_WITHHELD;h=new dr(b,D0(_),{session:t+"|"+r})}d=null;return}var E;try{E=p.decrypt(n)}catch(I){if((I==null?void 0:I.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&_){var M=_.code==="m.unverified"?zt.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:zt.MEGOLM_KEY_WITHHELD;h=new dr(M,D0(_),{session:t+"|"+r})}else h=I;return}var O=E.plaintext;if(O===void 0)O=E;else{var C=t+"|"+r+"|"+E.message_index;if(C in c.inboundGroupSessionMessageIndexes){var U=c.inboundGroupSessionMessageIndexes[C];if(U.id!==s||U.timestamp!==l){h=new Error("Duplicate message index, possible replay attack: "+C);return}}c.inboundGroupSessionMessageIndexes[C]={id:s,timestamp:l}}m.session=p.pickle(c.pickleKey),c.cryptoStore.storeEndToEndInboundGroupSession(t,r,m,v),d={result:O,keysClaimed:m.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:m.forwardingCurve25519KeyChain||[],untrusted:!!m.untrusted}})},T.getChild("[decryptGroupMessage]")),h)throw h;return d})()}hasInboundSessionKeys(e,t,r){var n=this;return R(function*(){var s;return yield n.cryptoStore.doTxn("readonly",[Oe.STORE_INBOUND_GROUP_SESSIONS,Oe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],l=>{n.cryptoStore.getEndToEndInboundGroupSession(t,r,l,c=>{if(c===null){s=!1;return}e!==c.room_id?(T.warn("requested keys for inbound group session ".concat(t,"|")+"".concat(r,", with incorrect room_id ")+"(expected ".concat(c.room_id,", ")+"was ".concat(e,")")),s=!1):s=!0})},T.getChild("[hasInboundSessionKeys]")),s})()}getInboundGroupSessionKey(e,t,r,n){var s=this;return R(function*(){var l=null;return yield s.cryptoStore.doTxn("readonly",[Oe.STORE_INBOUND_GROUP_SESSIONS,Oe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],c=>{s.getInboundGroupSession(e,t,r,c,(d,h)=>{if(d===null||h===null){l=null;return}n===void 0&&(n=d.first_known_index());var v=d.export_session(n),p=h.keysClaimed||{},m=p.ed25519||null,_=h.forwardingCurve25519KeyChain||[],b="untrusted"in h?h.untrusted:_.length>0;l={chain_index:n,key:v,forwarding_curve25519_key_chain:_,sender_claimed_ed25519_key:m,shared_history:h.sharedHistory||!1,untrusted:b}})},T.getChild("[getInboundGroupSessionKey]")),l})()}exportInboundGroupSession(e,t,r){return this.unpickleInboundGroupSession(r,n=>{var s=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(s),forwarding_curve25519_key_chain:r.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":r.sharedHistory||!1}})}getSharedHistoryInboundGroupSessions(e){var t=this;return R(function*(){var r;return yield t.cryptoStore.doTxn("readonly",[Oe.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],n=>{r=t.cryptoStore.getSharedHistoryInboundGroupSessions(e,n)},T.getChild("[getSharedHistoryInboundGroupSessionsForRoom]")),r})()}verifySignature(e,t,r){this.getUtility(function(n){n.ed25519_verify(e,t,r)})}}var Of={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function D0(a){return a.code&&a.code in Of?Of[a.code]:a.reason?a.reason:"decryption key withheld"}var jD=new Uint8Array(8);function vR(a,e){return Op.apply(this,arguments)}function Op(){return Op=R(function*(a,e){var t=yield globalThis.crypto.subtle.importKey("raw",a,{name:"HKDF"},!1,["deriveBits"]),r=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:jD,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),n=r.slice(0,32),s=r.slice(32),l=globalThis.crypto.subtle.importKey("raw",n,{name:"AES-CTR"},!1,["encrypt","decrypt"]),c=globalThis.crypto.subtle.importKey("raw",s,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([l,c])}),Op.apply(this,arguments)}function sl(a,e,t,r){return kp.apply(this,arguments)}function kp(){return kp=R(function*(a,e,t,r){var n;r?n=Ar(r):(n=new Uint8Array(16),globalThis.crypto.getRandomValues(n),n[8]&=127);var[s,l]=yield vR(e,t),c=new TextEncoder().encode(a),d=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:n,length:64},s,c),h=yield globalThis.crypto.subtle.sign({name:"HMAC"},l,d);return{iv:Kr(n),ciphertext:Kr(d),mac:Kr(h)}}),kp.apply(this,arguments)}function bc(a,e,t){return Ap.apply(this,arguments)}function Ap(){return Ap=R(function*(a,e,t){var[r,n]=yield vR(e,t),s=Ar(a.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},n,Ar(a.mac),s)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var l=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:Ar(a.iv),length:64},r,s);return new TextDecoder().decode(new Uint8Array(l))}),Ap.apply(this,arguments)}var FD=1e3*60;function Hd(a){return Object.values(a.keys)[0]}class Wn{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.userId=e,this.callbacks=t,this.cacheCallbacks=r,y(this,"keys",{}),y(this,"firstUse",!0),y(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){var r=new Wn(t);for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}getCrossSigningKey(e,t){var r=this;return R(function*(){var n=["master","self_signing","user_signing"].indexOf(e)>=0;if(!r.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");t===void 0&&(t=r.getId(e));function s(h){if(h){var v=new globalThis.Olm.PkSigning,p=v.init_with_seed(h);if(p===t)return[p,v];v.free()}}var l=null;r.cacheCallbacks.getCrossSigningKeyCache&&n&&(l=yield r.cacheCallbacks.getCrossSigningKeyCache(e,t));var c=s(l);if(c)return c;l=yield r.callbacks.getCrossSigningKey(e,t);var d=s(l);if(d)return r.cacheCallbacks.storeCrossSigningKeyCache&&n&&(yield r.cacheCallbacks.storeCrossSigningKeyCache(e,l)),d;throw l?new Error("Key type "+e+" from getCrossSigningKey callback did not match"):new Error("getCrossSigningKey callback for "+e+" returned falsey")})()}isStoredInSecretStorage(e){return R(function*(){var t=(yield e.isStored("m.cross_signing.master"))||{};function r(s){for(var l of Object.keys(t))s[l]||delete t[l]}for(var n of["self_signing","user_signing"])r((yield e.isStored("m.cross_signing.".concat(n)))||{});return Object.keys(t).length?t:null})()}static storeInSecretStorage(e,t){return R(function*(){for(var[r,n]of e){var s=Kr(n);yield t.store("m.cross_signing.".concat(r),s)}})()}static getFromSecretStorage(e,t){return R(function*(){var r=yield t.get("m.cross_signing.".concat(e));return r?Ar(r):null})()}isStoredInKeyCache(e){var t=this;return R(function*(){var r=t.cacheCallbacks;if(!r)return!1;var n=e?[e]:["master","self_signing","user_signing"];for(var s of n){var l;if(!(yield(l=r.getCrossSigningKeyCache)===null||l===void 0?void 0:l.call(r,s)))return!1}return!0})()}getCrossSigningKeysFromCache(){var e=this;return R(function*(){var t=new Map,r=e.cacheCallbacks;if(!r)return t;for(var n of["master","self_signing","user_signing"]){var s,l=yield(s=r.getCrossSigningKeyCache)===null||s===void 0?void 0:s.call(r,n);l&&t.set(n,l)}return t})()}getId(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"master";if(!this.keys[e])return null;var t=this.keys[e];return Hd(t)}resetKeys(e){var t=this;return R(function*(){if(!t.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(e===void 0||e&vs.MASTER||!t.keys.master)e=vs.MASTER|vs.USER_SIGNING|vs.SELF_SIGNING;else if(e===0)return;var r={},n={},s,l;try{if(e&vs.MASTER?(s=new globalThis.Olm.PkSigning,r.master=s.generate_seed(),l=s.init_with_seed(r.master),n.master={user_id:t.userId,usage:["master"],keys:{["ed25519:"+l]:l}}):[l,s]=yield t.getCrossSigningKey("master"),e&vs.SELF_SIGNING){var c=new globalThis.Olm.PkSigning;try{r.self_signing=c.generate_seed();var d=c.init_with_seed(r.self_signing);n.self_signing={user_id:t.userId,usage:["self_signing"],keys:{["ed25519:"+d]:d}},of(n.self_signing,s,t.userId,l)}finally{c.free()}}if(e&vs.USER_SIGNING){var h=new globalThis.Olm.PkSigning;try{r.user_signing=h.generate_seed();var v=h.init_with_seed(r.user_signing);n.user_signing={user_id:t.userId,usage:["user_signing"],keys:{["ed25519:"+v]:v}},of(n.user_signing,s,t.userId,l)}finally{h.free()}}Object.assign(t.keys,n),t.callbacks.saveCrossSigningKeys(r)}finally{s&&s.free()}})()}clearKeys(){this.keys={}}setKeys(e){var t={};if(e.master){if(e.master.user_id!==this.userId){var r="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw T.error(r),new Error(r)}this.keys.master?Hd(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else if(this.keys.master)t.master=this.keys.master;else throw new Error("Tried to set cross-signing keys without a master key");var n=Hd(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){var s="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw T.error(s),new Error(s)}try{Mo(e.user_signing,n,this.userId)}catch(c){throw T.error("invalid signature on user-signing key"),c}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){var l="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw T.error(l),new Error(l)}try{Mo(e.self_signing,n,this.userId)}catch(c){throw T.error("invalid signature on self-signing key"),c}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}signObject(e,t){var r=this;return R(function*(){if(!r.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");var[n,s]=yield r.getCrossSigningKey(t);try{return of(e,s,r.userId,n),e}finally{s.free()}})()}signUser(e){var t=this;return R(function*(){if(!t.keys.user_signing){T.info("No user signing key: not signing user");return}return t.signObject(e.keys.master,"user_signing")})()}signDevice(e,t){var r=this;return R(function*(){if(e!==r.userId)throw new Error("Trying to sign ".concat(e,"'s device; can only sign our own device"));if(!r.keys.self_signing){T.info("No self signing key: not signing device");return}return r.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing")})()}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new Ju(!0,!0,this.firstUse);if(!this.keys.user_signing)return new Ju(!1,!1,e.firstUse);var t,r=e.keys.master,n=this.getId("user_signing");try{Mo(r,n,this.userId),t=!0}catch{t=!1}return new Ju(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,r,n){var s=this.checkUserTrust(e),l=e.keys.self_signing;if(!l)return new Ko(!1,!1,r,n);var c=qD(t,e.userId);try{return Mo(l,e.getId(),e.userId),Mo(c,Hd(l),e.userId),Ko.fromUserTrustLevel(s,r,n)}catch{return new Ko(!1,!1,r,n)}}getCacheCallbacks(){return this.cacheCallbacks}}function qD(a,e){return{algorithms:a.algorithms,keys:a.keys,device_id:a.deviceId,user_id:e,signatures:a.signatures}}var vs=(function(a){return a[a.MASTER=4]="MASTER",a[a.USER_SIGNING=2]="USER_SIGNING",a[a.SELF_SIGNING=1]="SELF_SIGNING",a})({});class Ko extends hR{constructor(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;super({crossSigningVerified:e,tofu:t,localVerified:r,trustCrossSignedDevices:n,signedByOwner:s})}static fromUserTrustLevel(e,t,r){return new Ko(e.isCrossSigningVerified(),e.isTofu(),t,r,!0)}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function gR(a,e){return{getCrossSigningKeyCache:(function(){var t=R(function*(n,s){var l=yield new Promise(h=>{a.doTxn("readonly",[Oe.STORE_ACCOUNT],v=>{a.getSecretStorePrivateKey(v,h,n)})});if(l&&l.ciphertext){var c=Buffer.from(e.pickleKey),d=yield bc(l,c,n);return Ar(d)}else return l});function r(n,s){return t.apply(this,arguments)}return r})(),storeCrossSigningKeyCache:(function(){var t=R(function*(n,s){if(!(s instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got ".concat(s));var l=Buffer.from(e.pickleKey),c=yield sl(Kr(s),l,n);return a.doTxn("readwrite",[Oe.STORE_ACCOUNT],d=>{a.storeSecretStorePrivateKey(d,n,c)})});function r(n,s){return t.apply(this,arguments)}return r})()}}function VD(a,e,t){return Dp.apply(this,arguments)}function Dp(){return Dp=R(function*(a,e,t){if(a.getUserId()===e)return T.log("Cross-signing: Self-verification done; requesting keys"),new Promise((r,n)=>{var s=a,l=s.crypto.crossSigningInfo,c=new Wn(l.userId,{getCrossSigningKey:(function(){var v=R(function*(m){T.debug("Cross-signing: requesting secret",m,t);var{promise:_}=s.requestSecret("m.cross_signing.".concat(m),[t]),b=yield _,E=Ar(b);return Uint8Array.from(E)});function p(m){return v.apply(this,arguments)}return p})()},l.getCacheCallbacks());c.keys=l.keys;var d=new Promise(v=>{setTimeout(v,FD,new Error("Timeout"))}),h=R(function*(){var v=yield s.crypto.getSessionBackupPrivateKey();if(!v){T.info("No cached backup key found. Requesting...");var p=s.requestSecret("m.megolm_backup.v1",[t]),m=yield p.promise;T.info("Got key backup key, decoding...");var _=Ar(m);T.info("Decoded backup key, storing..."),yield s.crypto.storeSessionBackupPrivateKey(Uint8Array.from(_)),T.info("Backup key stored. Starting backup restore...");var b=yield s.getKeyBackupVersion();s.restoreKeyBackupWithCache(void 0,void 0,b).then(()=>{T.info("Backup restored.")})}})();Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),h]),d]).then(r,n)}).catch(r=>{T.warn("Cross-signing: failure while requesting keys:",r)})}),Dp.apply(this,arguments)}var vn=(function(a){return a[a.NotTracked=0]="NotTracked",a[a.PendingDownload=1]="PendingDownload",a[a.DownloadInProgress=2]="DownloadInProgress",a[a.UpToDate=3]="UpToDate",a})({});class GD extends Pt{constructor(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:250;super(),this.cryptoStore=t,this.keyDownloadChunkSize=n,y(this,"devices",{}),y(this,"crossSigningInfo",{}),y(this,"userByIdentityKey",{}),y(this,"deviceTrackingStatus",{}),y(this,"syncToken",null),y(this,"keyDownloadsInProgressByUser",new Map),y(this,"dirty",!1),y(this,"savePromise",null),y(this,"resolveSavePromise",null),y(this,"savePromiseTime",null),y(this,"saveTimer",null),y(this,"hasFetched",null),y(this,"serialiser",void 0),this.serialiser=new HD(e,r,this)}load(){var e=this;return R(function*(){yield e.cryptoStore.doTxn("readonly",[Oe.STORE_DEVICE_DATA],r=>{e.cryptoStore.getEndToEndDeviceData(r,n=>{var s;e.hasFetched=!!(n!=null&&n.devices),e.devices=n?n.devices:{},e.crossSigningInfo=n?n.crossSigningInfo||{}:{},e.deviceTrackingStatus=n?n.trackingStatus:{},e.syncToken=(s=n==null?void 0:n.syncToken)!==null&&s!==void 0?s:null,e.userByIdentityKey={};for(var l of Object.keys(e.devices)){var c=e.devices[l];for(var d of Object.keys(c)){var h=c[d].keys["curve25519:"+d];h!==void 0&&(e.userByIdentityKey[h]=l)}}})});for(var t of Object.keys(e.deviceTrackingStatus))e.deviceTrackingStatus[t]==vn.DownloadInProgress&&(e.deviceTrackingStatus[t]=vn.PendingDownload)})()}stop(){this.saveTimer!==null&&clearTimeout(this.saveTimer)}saveIfDirty(){var e=arguments,t=this;return R(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:500;if(!t.dirty)return Promise.resolve(!1);var n=Date.now()+r;t.savePromiseTime&&n<t.savePromiseTime&&(clearTimeout(t.saveTimer),t.saveTimer=null,t.savePromiseTime=null);var s=t.savePromise;if(s===null&&(s=new Promise(c=>{t.resolveSavePromise=c}),t.savePromise=s),t.saveTimer===null){var l=t.resolveSavePromise;t.savePromiseTime=n,t.saveTimer=setTimeout(()=>{T.log("Saving device tracking data",t.syncToken),t.savePromiseTime=null,t.saveTimer=null,t.savePromise=null,t.resolveSavePromise=null,t.cryptoStore.doTxn("readwrite",[Oe.STORE_DEVICE_DATA],c=>{var d;t.cryptoStore.storeEndToEndDeviceData({devices:t.devices,crossSigningInfo:t.crossSigningInfo,trackingStatus:t.deviceTrackingStatus,syncToken:(d=t.syncToken)!==null&&d!==void 0?d:void 0},c)}).then(()=>{t.dirty=!1,l==null||l(!0)},c=>{T.error("Failed to save device tracking data",t.syncToken),T.error(c)})},r)}return s})()}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){var r=[],n=[];if(e.forEach(l=>{var c=this.deviceTrackingStatus[l];this.keyDownloadsInProgressByUser.has(l)?(T.log("downloadKeys: already have a download in progress for "+"".concat(l,": awaiting its result")),n.push(this.keyDownloadsInProgressByUser.get(l))):(t||c!=vn.UpToDate)&&r.push(l)}),r.length!=0){T.log("downloadKeys: downloading for",r);var s=this.doKeyDownload(r);n.push(s)}return n.length===0&&T.log("downloadKeys: already have all necessary keys"),Promise.all(n).then(()=>this.getDevicesFromStore(e))}getDevicesFromStore(e){var t=new Map;return e.forEach(r=>{var n,s=new Map;(n=this.getStoredDevicesForUser(r))===null||n===void 0||n.forEach(function(l){s.set(l.deviceId,l)}),t.set(r,s)}),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){var t=this.devices[e];if(!t)return null;var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(qr.fromStorage(t[n],n));return r}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?Wn.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){var r=this.devices[e];if(r!=null&&r[t])return qr.fromStorage(r[t],t)}getUserByIdentityKey(e,t){return e!==br&&e!==Zr?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){var r=this.getUserByIdentityKey(e,t);if(!r)return null;var n=this.devices[r];if(!n)return null;for(var s in n)if(n.hasOwnProperty(s)){var l=n[s];for(var c in l.keys)if(l.keys.hasOwnProperty(c)&&c.indexOf("curve25519:")===0){var d=l.keys[c];if(d==t)return qr.fromStorage(l,s)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if(typeof e!="string")throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(T.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=vn.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(T.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=vn.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(var e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=vn.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(T.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=vn.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();var e=[];for(var t of Object.keys(this.deviceTrackingStatus)){var r=this.deviceTrackingStatus[t];r==vn.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(this.devices[e]!==void 0)for(var[r,n]of Object.entries(this.devices[e])){var s=n.keys["curve25519:"+r];delete this.userByIdentityKey[s]}this.devices[e]=t;for(var[l,c]of Object.entries(t)){var d=c.keys["curve25519:"+l];this.userByIdentityKey[d]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(e.length===0)return Promise.resolve();var t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then(()=>{r(!0)},n=>{throw T.error("Error downloading keys for "+e+":",n),r(!1),n});e.forEach(n=>{this.keyDownloadsInProgressByUser.set(n,t);var s=this.deviceTrackingStatus[n];s==vn.PendingDownload&&(this.deviceTrackingStatus[n]=vn.DownloadInProgress)});var r=n=>{this.emit(at.WillUpdateDevices,e,!this.hasFetched),e.forEach(s=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(s)!==t){T.log("Another update in the queue for",s,"- not marking up-to-date");return}this.keyDownloadsInProgressByUser.delete(s);var l=this.deviceTrackingStatus[s];l==vn.DownloadInProgress&&(n?(this.deviceTrackingStatus[s]=vn.UpToDate,T.log("Device list for",s,"now up to date")):this.deviceTrackingStatus[s]=vn.PendingDownload)}),this.saveIfDirty(),this.emit(at.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class HD{constructor(e,t,r){this.baseApis=e,this.olmDevice=t,this.deviceList=r,y(this,"downloadInProgress",!1),y(this,"keyDownloadsQueuedByUser",{}),y(this,"queuedQueryDeferred",void 0),y(this,"syncToken",void 0)}updateDevicesForUsers(e,t){return e.forEach(r=>{this.keyDownloadsQueuedByUser[r]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=qa()),this.syncToken=t,this.downloadInProgress?(T.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){var e=this;if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");var t=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};var r=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,T.log("Starting key download for",t),this.downloadInProgress=!0;var n={};this.syncToken&&(n.token=this.syncToken);for(var s=[],l=function(){var h=t.slice(c,c+e.deviceList.keyDownloadChunkSize);s.push(()=>e.baseApis.downloadKeysForUsers(h,n))},c=0;c<t.length;c+=this.deviceList.keyDownloadChunkSize)l();return wk(s,3).then((function(){var d=R(function*(h){var v=Object.assign({},...h.map(E=>E.device_keys||{})),p=Object.assign({},...h.map(E=>E.master_keys||{})),m=Object.assign({},...h.map(E=>E.self_signing_keys||{})),_=Object.assign({},...h.map(E=>E.user_signing_keys||{}));for(var b of t){yield Ba(5);try{yield e.processQueryResponseForUser(b,v[b],{master:p==null?void 0:p[b],self_signing:m==null?void 0:m[b],user_signing:_==null?void 0:_[b]})}catch(E){T.error("Error processing keys for ".concat(b,":"),E)}}});return function(h){return d.apply(this,arguments)}})()).then(()=>{T.log("Completed key download for "+t),this.downloadInProgress=!1,r==null||r.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},d=>{T.warn("Error downloading keys for "+t+":",d),this.downloadInProgress=!1,r==null||r.reject(d)}),r.promise}processQueryResponseForUser(e,t,r){var n=this;return R(function*(){T.log("got device keys for "+e+":",t),T.log("got cross-signing keys for "+e+":",r);{var s={},l=n.deviceList.getRawStoredDevicesForUser(e);l&&Object.keys(l).forEach(h=>{var v=qr.fromStorage(l[h],h);s[h]=v}),yield zD(n.olmDevice,e,s,t||{},n.baseApis.getUserId(),n.baseApis.deviceId);var c={};Object.keys(s).forEach(h=>{c[h]=s[h].toStorage()}),n.deviceList.setRawStoredDevicesForUser(e,c)}if(r&&(r.master||r.self_signing||r.user_signing)){var d=n.deviceList.getStoredCrossSigningForUser(e)||new Wn(e);d.setKeys(r),n.deviceList.setRawStoredCrossSigningForUser(e,d.toStorage()),n.deviceList.emit(at.UserCrossSigningUpdated,e)}})()}}function zD(a,e,t,r,n,s){return Mp.apply(this,arguments)}function Mp(){return Mp=R(function*(a,e,t,r,n,s){var l=!1;for(var c in t)if(t.hasOwnProperty(c)&&!(c in r)){if(e===n&&c===s){T.warn("Local device ".concat(c," missing from sync, skipping removal"));continue}T.log("Device "+e+":"+c+" has been removed"),delete t[c],l=!0}for(var d in r)if(r.hasOwnProperty(d)){var h=r[d];if(h.user_id!==e){T.warn("Mismatched user_id "+h.user_id+" in keys from "+e+":"+d);continue}if(h.device_id!==d){T.warn("Mismatched device_id "+h.device_id+" in keys from "+e+":"+d);continue}(yield WD(a,t,h))&&(l=!0)}return l}),Mp.apply(this,arguments)}function WD(a,e,t){return Np.apply(this,arguments)}function Np(){return Np=R(function*(a,e,t){if(!t.keys)return!1;var r=t.device_id,n=t.user_id,s="ed25519:"+r,l=t.keys[s];if(!l)return T.warn("Device "+n+":"+r+" has no ed25519 key"),!1;var c=t.unsigned||{},d=t.signatures||{};try{yield Jo(a,t,n,r,l)}catch(v){return T.warn("Unable to verify signature on device "+n+":"+r+":"+v),!1}var h;if(r in e){if(h=e[r],h.getFingerprint()!=l)return T.warn("Ed25519 key for device "+n+":"+r+" has changed"),!1}else e[r]=h=new qr(r);return h.keys=t.keys||{},h.algorithms=t.algorithms||[],h.unsigned=c,h.signatures=d,!0}),Np.apply(this,arguments)}var pR=new Map,Up=new Map;class mR{constructor(e){y(this,"userId",void 0),y(this,"deviceId",void 0),y(this,"crypto",void 0),y(this,"olmDevice",void 0),y(this,"baseApis",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis}prepareToEncrypt(e){}onRoomMembership(e,t,r){}}class yR{constructor(e){y(this,"userId",void 0),y(this,"crypto",void 0),y(this,"olmDevice",void 0),y(this,"baseApis",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis}onRoomKeyEvent(e){return R(function*(){})()}importRoomKey(e,t){return R(function*(){})()}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}retryDecryptionFromSender(e){return R(function*(){return!1})()}}class YD extends Error{constructor(e,t,r){super(e),this.devices=t,this.event=r,this.name="UnknownDeviceError",this.devices=t}}function SR(a,e,t){pR.set(a,e),Up.set(a,t)}var JD=qr.DeviceVerification;class QD extends mR{constructor(){super(...arguments),y(this,"sessionPrepared",!1),y(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then(()=>this.crypto.ensureOlmSessionsForUsers(e)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}encryptMessage(e,t,r){var n=this;return R(function*(){var s=yield e.getEncryptionTargetMembers(),l=s.map(function(b){return b.userId});yield n.ensureSession(l);var c={room_id:e.roomId,type:t,content:r},d={algorithm:br,sender_key:n.olmDevice.deviceCurve25519Key,ciphertext:{}},h=[];for(var v of l){var p=n.crypto.getStoredDevicesForUser(v)||[];for(var m of p){var _=m.getIdentityKey();_!=n.olmDevice.deviceCurve25519Key&&m.verified!=JD.BLOCKED&&h.push(ja(d.ciphertext,n.userId,n.deviceId,n.olmDevice,v,m,c))}}return Promise.all(h).then(()=>d)})()}}class XD extends yR{decryptEvent(e){var t=this;return R(function*(){var r=e.getWireContent(),n=r.sender_key,s=r.ciphertext;if(!s)throw new dr(zt.OLM_MISSING_CIPHERTEXT,"Missing ciphertext");if(!(t.olmDevice.deviceCurve25519Key in s))throw new dr(zt.OLM_NOT_INCLUDED_IN_RECIPIENTS,"Not included in recipients");var l=s[t.olmDevice.deviceCurve25519Key],c;try{c=yield t.decryptMessage(n,l)}catch(p){throw new dr(zt.OLM_BAD_ENCRYPTED_MESSAGE,"Bad Encrypted Message",{sender:n,err:p})}var d=JSON.parse(c);if(d.recipient!=t.userId)throw new dr(zt.OLM_BAD_RECIPIENT,"Message was intended for "+d.recipient);if(d.recipient_keys.ed25519!=t.olmDevice.deviceEd25519Key)throw new dr(zt.OLM_BAD_RECIPIENT_KEY,"Message not intended for this device",{intended:d.recipient_keys.ed25519,our_key:t.olmDevice.deviceEd25519Key});var h=t.crypto.deviceList.getUserByIdentityKey(br,n);if(h==null){try{yield t.crypto.deviceList.downloadKeys([e.getSender()],!1)}catch(p){throw new dr(zt.OLM_BAD_SENDER_CHECK_FAILED,"Could not verify sender identity",{sender:n,err:p})}h=t.crypto.deviceList.getUserByIdentityKey(br,n)}if(h!==e.getSender()&&h!==void 0&&h!==null)throw new dr(zt.OLM_BAD_SENDER,"Message claimed to be from "+e.getSender(),{real_sender:h});if(d.sender!=e.getSender())throw new dr(zt.OLM_FORWARDED_MESSAGE,"Message forwarded from "+d.sender,{reported_sender:e.getSender()});if(d.room_id!==e.getRoomId())throw new dr(zt.OLM_BAD_ROOM,"Message intended for room "+d.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});var v=d.keys||{};return{clearEvent:d,senderCurve25519Key:n,claimedEd25519Key:v.ed25519||null}})()}decryptMessage(e,t){if(t.type!==0)return this.reallyDecryptMessage(e,t);var r=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(e,t));return this.olmDevice.olmPrekeyPromise=r.catch(()=>{}),r}reallyDecryptMessage(e,t){var r=this;return R(function*(){var n=yield r.olmDevice.getSessionIdsForDevice(e),s={};for(var l of n)try{var c=yield r.olmDevice.decryptMessage(e,l,t.type,t.body);return T.log("Decrypted Olm message from "+e+" with session "+l),c}catch(v){var d=yield r.olmDevice.matchesSession(e,l,t.type,t.body);if(d)throw new Error("Error decrypting prekey message with existing session id "+l+": "+v.message);s[l]=v.message}if(t.type!==0)throw n.length===0?new Error("No existing sessions"):new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(s));var h;try{h=yield r.olmDevice.createInboundSession(e,t.type,t.body)}catch(v){throw s["(new)"]=v.message,new Error("Error decrypting prekey message: "+JSON.stringify(s))}return T.log("created new inbound Olm session ID "+h.session_id+" with "+e),h.payload})()}}SR(br,QD,XD);function M0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function N0(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?M0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):M0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var $D=500,St=(function(a){return a[a.Unsent=0]="Unsent",a[a.Sent=1]="Sent",a[a.CancellationPending=2]="CancellationPending",a[a.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend",a})({});class ZD{constructor(e,t,r){this.baseApis=e,this.deviceId=t,this.cryptoStore=r,y(this,"sendOutgoingRoomKeyRequestsTimer",void 0),y(this,"sendOutgoingRoomKeyRequestsRunning",!1),y(this,"clientRunning",!0)}stop(){T.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}queueRoomKeyRequest(e,t){var r=arguments,n=this;return R(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!1,l=yield n.cryptoStore.getOutgoingRoomKeyRequest(e);if(!l)yield n.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:n.baseApis.makeTxnId(),state:St.Unsent});else switch(l.state){case St.CancellationPendingAndWillResend:case St.Unsent:return;case St.CancellationPending:{var c=s?St.CancellationPendingAndWillResend:St.Sent;yield n.cryptoStore.updateOutgoingRoomKeyRequest(l.requestId,St.CancellationPending,{state:c,cancellationTxnId:n.baseApis.makeTxnId()});break}case St.Sent:{if(s){var d=St.CancellationPendingAndWillResend,h=yield n.cryptoStore.updateOutgoingRoomKeyRequest(l.requestId,St.Sent,{state:d,cancellationTxnId:n.baseApis.makeTxnId(),requestTxnId:n.baseApis.makeTxnId()});if(!h)return n.queueRoomKeyRequest(e,t,s);try{yield n.sendOutgoingRoomKeyRequestCancellation(h,!0)}catch(v){T.error("Error sending room key request cancellation; will retry later.",v)}}break}default:throw new Error("unhandled state: "+l.state)}})()}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case St.CancellationPending:case St.CancellationPendingAndWillResend:return;case St.Unsent:return T.log("deleting unnecessary room key request for "+zd(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,St.Unsent);case St.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,St.Sent,{state:St.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then(r=>{if(!r){T.log("Tried to cancel room key request for "+zd(e)+" but it was already cancelled in another tab");return}this.sendOutgoingRoomKeyRequestCancellation(r).catch(n=>{T.error("Error sending room key request cancellation; will retry later.",n),this.startTimer()})});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[St.Sent])}cancelAndResendAllOutgoingRequests(){var e=this;return R(function*(){var t=yield e.cryptoStore.getAllOutgoingRoomKeyRequestsByState(St.Sent);return Promise.all(t.map(r=>{var{requestBody:n,recipients:s}=r;return e.queueRoomKeyRequest(n,s,!0)}))})()}startTimer(){if(!this.sendOutgoingRoomKeyRequestsTimer){var e=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(t=>{T.warn("error in OutgoingRoomKeyRequestManager: ".concat(t))})};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(e,$D)}}sendOutgoingRoomKeyRequests(){var e=this;return R(function*(){if(!e.clientRunning){e.sendOutgoingRoomKeyRequestsTimer=void 0;return}var t=yield e.cryptoStore.getOutgoingRoomKeyRequestByState([St.CancellationPending,St.CancellationPendingAndWillResend,St.Unsent]);if(!t){e.sendOutgoingRoomKeyRequestsTimer=void 0;return}try{switch(t.state){case St.Unsent:yield e.sendOutgoingRoomKeyRequest(t);break;case St.CancellationPending:yield e.sendOutgoingRoomKeyRequestCancellation(t);break;case St.CancellationPendingAndWillResend:yield e.sendOutgoingRoomKeyRequestCancellation(t,!0);break}return e.sendOutgoingRoomKeyRequests()}catch(r){T.error("Error sending room key request; will retry later.",r),e.sendOutgoingRoomKeyRequestsTimer=void 0}})()}sendOutgoingRoomKeyRequest(e){T.log("Requesting keys for ".concat(zd(e.requestBody))+" from ".concat(U0(e.recipients))+"(id ".concat(e.requestId,")"));var t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,St.Unsent,{state:St.Sent}))}sendOutgoingRoomKeyRequestCancellation(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;T.log("Sending cancellation for key request for "+"".concat(zd(e.requestBody)," to ")+"".concat(U0(e.recipients)," ")+"(cancellation id ".concat(e.cancellationTxnId,")"));var r={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(r,e.recipients,e.cancellationTxnId).then(()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,St.CancellationPendingAndWillResend,{state:St.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,St.CancellationPending))}sendMessageToDevices(e,t,r){var n=new Xt(()=>new Map);for(var s of t){var l=n.getOrCreate(s.userId);l.set(s.deviceId,N0(N0({},e),{},{[Fr]:Jn()}))}return this.baseApis.sendToDevice($.RoomKeyRequest,n,r)}}function zd(a){return a.room_id+" / "+a.session_id}function U0(a){return"[".concat(a.map(e=>"".concat(e.userId,":").concat(e.deviceId)).join(","),"]")}function P0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function L0(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?P0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):P0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}function eM(a){var e,t,r=a==null||(e=a.currentState)===null||e===void 0?void 0:e.getStateEvents("m.room.history_visibility",""),n=r==null||(t=r.getContent())===null||t===void 0?void 0:t.history_visibility;return["world_readable","shared"].includes(n)}var tM=a=>typeof a.ciphertext=="string"?!!a.ciphertext.length:!!Object.keys(a.ciphertext).length;class rM{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.sessionId=e,this.sharedHistory=t,y(this,"useCount",0),y(this,"creationTime",void 0),y(this,"sharedWithDevices",new Xt(()=>new Map)),y(this,"blockedDevicesNotified",new Xt(()=>new Map)),this.creationTime=new Date().getTime()}needsRotation(e,t){var r=new Date().getTime()-this.creationTime;return this.useCount>=e||r>=t?(T.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0):!1}markSharedWithDevice(e,t,r,n){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:r,messageIndex:n})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){for(var[t,r]of this.sharedWithDevices){if(!e.has(t))return T.log("Starting new megolm session because we shared with "+t),!0;for(var[n]of r){var s;if(!((s=e.get(t))!==null&&s!==void 0&&s.get(n)))return T.log("Starting new megolm session because we shared with "+t+":"+n),!0}}return!1}}class nM extends mR{constructor(e){var t,r,n,s;super(e),y(this,"setupPromise",Promise.resolve(null)),y(this,"outboundSessions",{}),y(this,"sessionRotationPeriodMsgs",void 0),y(this,"sessionRotationPeriodMs",void 0),y(this,"encryptionPreparation",void 0),y(this,"roomId",void 0),y(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=T.getChild("[".concat(this.roomId," encryption]")),this.sessionRotationPeriodMsgs=(t=(r=e.config)===null||r===void 0?void 0:r.rotation_period_msgs)!==null&&t!==void 0?t:100,this.sessionRotationPeriodMs=(n=(s=e.config)===null||s===void 0?void 0:s.rotation_period_ms)!==null&&n!==void 0?n:168*3600*1e3}ensureOutboundSession(e,t,r){var n=arguments,s=this;return R(function*(){var l=n.length>3&&n[3]!==void 0?n[3]:!1,c=(function(){var h=R(function*(v){var p=eM(e),m=yield s.prepareSession(t,p,v);return yield s.shareSession(t,p,l,r,m),m});return function(p){return h.apply(this,arguments)}})(),d=s.setupPromise.then(c);return s.setupPromise=d.catch(h=>(s.prefixedLogger.error("Failed to setup outbound session",h),null)),d})()}prepareSession(e,t,r){var n=this;return R(function*(){var s,l;return r&&t!==r.sharedHistory&&(r=null),(s=r)!==null&&s!==void 0&&s.needsRotation(n.sessionRotationPeriodMsgs,n.sessionRotationPeriodMs)&&(n.prefixedLogger.debug("Starting new megolm session because we need to rotate."),r=null),(l=r)!==null&&l!==void 0&&l.sharedWithTooManyDevices(e)&&(r=null),r||(n.prefixedLogger.debug("Starting new megolm session"),r=yield n.prepareNewSession(t),n.prefixedLogger.debug("Started new megolm session ".concat(r.sessionId)),n.outboundSessions[r.sessionId]=r),r})()}shareSession(e,t,r,n,s){var l=this;return R(function*(){var c={};for(var[d,h]of e)for(var[v,p]of h){var m,_=p.getIdentityKey();_!=l.olmDevice.deviceCurve25519Key&&((m=s.sharedWithDevices.get(d))!==null&&m!==void 0&&m.get(v)||(c[d]=c[d]||[],c[d].push(p)))}var b=l.olmDevice.getOutboundGroupSessionKey(s.sessionId),E={type:"m.room_key",content:{algorithm:Zr,room_id:l.roomId,session_id:s.sessionId,session_key:b.key,chain_index:b.chain_index,"org.matrix.msc3061.shared_history":t}},[M,O]=yield oR(l.olmDevice,l.baseApis,c);yield Promise.all([R(function*(){var C=Array.from(O.entries()).map(U=>{var[I,D]=U;return Array.from(D.entries()).map(w=>{var[N,A]=w;return"".concat(I,"/").concat(N,": ").concat(A.sessionId)})}).flat(1);l.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",C),yield l.shareKeyWithOlmSessions(s,b,E,O),l.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),R(function*(){var C=Array.from(M.entries()).map(w=>{var[N,A]=w;return A.map(K=>"".concat(N,"/").concat(K.deviceId))}).flat(1);l.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",C);var U=[],I=Date.now(),D=[];yield l.shareKeyWithDevices(s,b,E,M,U,r?1e4:2e3,D),l.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!r&&Date.now()-I<1e4?R(function*(){var w=new Xt(()=>[]),N=new Set;for(var A of D)N.add(A);var K=[];for(var{userId:z,deviceInfo:de}of U){var _e=z.slice(z.indexOf(":")+1);N.has(_e)?w.getOrCreate(z).push(de):K.push({userId:z,deviceInfo:de})}var le=Array.from(w.entries()).map(Ce=>{var[V,B]=Ce;return B.map(te=>"".concat(V,"/").concat(te.deviceId))}).flat(1);le.length>0&&(l.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",le),yield l.shareKeyWithDevices(s,b,E,w,K,3e4),l.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),yield l.notifyFailedOlmDevices(s,b,K)})():yield l.notifyFailedOlmDevices(s,b,U)})(),R(function*(){l.prefixedLogger.debug("There are ".concat(n.size," blocked devices:"),Array.from(n.entries()).map(K=>{var[z,de]=K;return Array.from(de.entries()).map(_e=>{var[le,Ce]=_e;return"".concat(z,"/").concat(le)})}).flat(1));var C=new Xt(()=>new Map),U=0;for(var[I,D]of n)for(var[w,N]of D){var A;((A=s.blockedDevicesNotified.get(I))===null||A===void 0?void 0:A.get(w))===void 0&&(C.getOrCreate(I).set(w,{device:N}),U++)}U&&(l.prefixedLogger.debug("Notifying ".concat(U," newly blocked devices:"),Array.from(C.entries()).map(K=>{var[z,de]=K;return Object.entries(de).map(_e=>{var[le,Ce]=_e;return"".concat(z,"/").concat(le)})}).flat(1)),yield l.notifyBlockedDevices(s,C),l.prefixedLogger.debug("Notified ".concat(U," newly blocked devices")))})()])})()}prepareNewSession(e){var t=this;return R(function*(){var r=t.olmDevice.createOutboundGroupSession(),n=t.olmDevice.getOutboundGroupSessionKey(r);return yield t.olmDevice.addInboundGroupSession(t.roomId,t.olmDevice.deviceCurve25519Key,[],r,n.key,{ed25519:t.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),t.crypto.backupManager.backupGroupSession(t.olmDevice.deviceCurve25519Key,r),new rM(r,e)})()}getDevicesWithoutSessions(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];for(var[n,s]of t){var l=e.get(n);for(var c of s){var d=c.deviceId,h=l==null?void 0:l.get(d);if(!(h!=null&&h.sessionId)){r.push({userId:n,deviceInfo:c}),l==null||l.delete(d);continue}}}return r}splitDevices(e){var t=20,r=[],n=[r];for(var[s,l]of e){for(var c of l.values())r.push({userId:s,deviceInfo:c.device});r.length>t&&(r=[],n.push(r))}return r.length===0&&n.pop(),n}encryptAndSendKeysToDevices(e,t,r,n){return this.crypto.encryptAndSendToDevices(r,n).then(()=>{for(var s of r)e.markSharedWithDevice(s.userId,s.deviceInfo.deviceId,s.deviceInfo.getIdentityKey(),t)}).catch(s=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",s),s})}sendBlockedNotificationsToDevices(e,t,r){var n=this;return R(function*(){var s=new Xt(()=>new Map);for(var l of t){var c=l.userId,d=l.deviceInfo,h=d.deviceInfo,v=h.deviceId,p=L0(L0({},r),{},{code:d.code,reason:d.reason,[Fr]:Jn()});p.code==="m.no_olm"&&(delete p.room_id,delete p.session_id),s.getOrCreate(c).set(v,p)}yield n.baseApis.sendToDevice("m.room_key.withheld",s);for(var[m,_]of s)for(var b of _.keys())e.markNotifiedBlockedDevice(m,b)})()}reshareKeyWithDevice(e,t,r,n){var s=this;return R(function*(){var l,c=s.outboundSessions[t];if(!c){s.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," not found: not re-sharing keys"));return}if(!c.sharedWithDevices.has(r)){s.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with user ").concat(r));return}var d=(l=c.sharedWithDevices.get(r))===null||l===void 0?void 0:l.get(n.deviceId);if(d===void 0){s.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with device ").concat(r,":").concat(n.deviceId));return}if(d.deviceKey!==n.getIdentityKey()){s.prefixedLogger.warn("Megolm session ".concat(e,"|").concat(t," has been shared with device ").concat(n.deviceId," but ")+"with identity key ".concat(d.deviceKey,". Key is now ").concat(n.getIdentityKey(),"!"));return}var h=yield s.olmDevice.getInboundGroupSessionKey(s.roomId,e,t,d.messageIndex);if(!h){s.prefixedLogger.warn("No inbound session key found for megolm session ".concat(e,"|").concat(t,": not re-sharing keys"));return}yield Ji(s.olmDevice,s.baseApis,new Map([[r,[n]]]));var v={type:"m.forwarded_room_key",content:{algorithm:Zr,room_id:s.roomId,session_id:t,session_key:h.key,chain_index:h.chain_index,sender_key:e,sender_claimed_ed25519_key:h.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:h.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":h.shared_history||!1}},p={algorithm:br,sender_key:s.olmDevice.deviceCurve25519Key,ciphertext:{},[Fr]:Jn()};yield ja(p.ciphertext,s.userId,s.deviceId,s.olmDevice,r,n,v),yield s.baseApis.sendToDevice("m.room.encrypted",new Map([[r,new Map([[n.deviceId,p]])]])),s.prefixedLogger.debug("Re-shared key for megolm session ".concat(e,"|").concat(t," with ").concat(r,":").concat(n.deviceId))})()}shareKeyWithDevices(e,t,r,n,s,l,c){var d=this;return R(function*(){var h=yield Ji(d.olmDevice,d.baseApis,n,!1,l,c,d.prefixedLogger);d.getDevicesWithoutSessions(h,n,s),yield d.shareKeyWithOlmSessions(e,t,r,h)})()}shareKeyWithOlmSessions(e,t,r,n){var s=this;return R(function*(){for(var l=s.splitDevices(n),c=0;c<l.length;c++){var d="megolm keys for ".concat(e.sessionId," (slice ").concat(c+1,"/").concat(l.length,")");try{s.prefixedLogger.debug("Sharing ".concat(d),l[c].map(h=>"".concat(h.userId,"/").concat(h.deviceInfo.deviceId))),yield s.encryptAndSendKeysToDevices(e,t.chain_index,l[c],r),s.prefixedLogger.debug("Shared ".concat(d))}catch(h){throw s.prefixedLogger.error("Failed to share ".concat(d)),h}}})()}notifyFailedOlmDevices(e,t,r){var n=this;return R(function*(){n.prefixedLogger.debug("Notifying ".concat(r.length," devices we failed to create Olm sessions"));for(var{userId:s,deviceInfo:l}of r){var c=l.deviceId;e.markSharedWithDevice(s,c,l.getIdentityKey(),t.chain_index)}var d=yield n.olmDevice.filterOutNotifiedErrorDevices(r);n.prefixedLogger.debug("Need to notify ".concat(d.length," failed devices which haven't been notified before"));var h=new Xt(()=>new Map);for(var{userId:v,deviceInfo:p}of d)h.getOrCreate(v).set(p.deviceId,{device:{code:"m.no_olm",reason:Of["m.no_olm"],deviceInfo:p}});yield n.notifyBlockedDevices(e,h),n.prefixedLogger.debug("Notified ".concat(d.length," devices we failed to create Olm sessions"))})()}notifyBlockedDevices(e,t){var r=this;return R(function*(){for(var n={room_id:r.roomId,session_id:e.sessionId,algorithm:Zr,sender_key:r.olmDevice.deviceCurve25519Key},s=r.splitDevices(t),l=0;l<s.length;l++)try{yield r.sendBlockedNotificationsToDevices(e,s[l],n),r.prefixedLogger.debug("Completed blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(l+1,"/").concat(s.length,")"))}catch(c){throw r.prefixedLogger.debug("blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(l+1,"/").concat(s.length,") failed")),c}})()}prepareToEncrypt(e){var t=this;if(e.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(this.encryptionPreparation!=null){var r=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug("Already started preparing to encrypt for this room ".concat(r,"ms ago, skipping")),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");var n=!1,s=()=>n;return this.encryptionPreparation={startTime:Date.now(),promise:R(function*(){try{var l=yield t.getDevicesInRoom(e,!1,s);if(l===null)return;var[c,d]=l;t.crypto.globalErrorOnUnknownDevices&&t.removeUnknownDevices(c),t.prefixedLogger.debug("Ensuring outbound megolm session"),yield t.ensureOutboundSession(e,c,d,!0),t.prefixedLogger.debug("Ready to encrypt events")}catch(h){t.prefixedLogger.error("Failed to prepare to encrypt events",h)}finally{delete t.encryptionPreparation}})(),cancel:()=>{n=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}encryptMessage(e,t,r){var n=this;return R(function*(){if(n.prefixedLogger.debug("Starting to encrypt event"),n.encryptionPreparation!=null)try{yield n.encryptionPreparation.promise}catch{}var s=n.isVerificationEvent(t,r),[l,c]=yield n.getDevicesInRoom(e,s);n.crypto.globalErrorOnUnknownDevices&&n.checkForUnknownDevices(l);var d=yield n.ensureOutboundSession(e,l,c),h={room_id:n.roomId,type:t,content:r},v=n.olmDevice.encryptGroupMessage(d.sessionId,JSON.stringify(h)),p={algorithm:Zr,sender_key:n.olmDevice.deviceCurve25519Key,ciphertext:v,session_id:d.sessionId,device_id:n.deviceId};return d.useCount++,p})()}isVerificationEvent(e,t){switch(e){case $.KeyVerificationCancel:case $.KeyVerificationDone:case $.KeyVerificationMac:case $.KeyVerificationStart:case $.KeyVerificationKey:case $.KeyVerificationReady:case $.KeyVerificationAccept:return!0;case $.RoomMessage:return t.msgtype===Xn.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(e){var t=new Xt(()=>new Map);for(var[r,n]of e)for(var[s,l]of n)l.isUnverified()&&!l.isKnown()&&t.getOrCreate(r).set(s,l);if(t.size)throw new YD("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(var[t,r]of e){for(var[n,s]of r)s.isUnverified()&&!s.isKnown()&&r.delete(n);r.size===0&&e.delete(t)}}getDevicesInRoom(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2?t[2]:void 0,l=yield e.getEncryptionTargetMembers();r.prefixedLogger.debug("Encrypting for users (shouldEncryptForInvitedMembers: ".concat(e.shouldEncryptForInvitedMembers(),"):"),l.map(U=>"".concat(U.userId," (").concat(U.membership,")")));var c=l.map(function(U){return U.userId}),d=r.crypto.globalBlacklistUnverifiedDevices,h=e.getBlacklistUnverifiedDevices();typeof h=="boolean"&&(d=h);var v=yield r.crypto.downloadKeys(c,!1);if((s==null?void 0:s())===!0)return null;var p=new Xt(()=>new Map);for(var[m,_]of v)for(var[b,E]of _){if(s!==void 0&&(yield Tk()),(s==null?void 0:s())===!0)return null;var M=r.crypto.checkDeviceTrust(m,b);if(E.isBlocked()||!M.isVerified()&&d&&!n){var O=p.getOrCreate(m),C=E.isBlocked();O.set(b,{code:C?"m.blacklisted":"m.unverified",reason:Of[C?"m.blacklisted":"m.unverified"],deviceInfo:E}),_.delete(b)}}return[v,p]})()}}class iM extends yR{constructor(e){super(e),y(this,"pendingEvents",new Map),y(this,"olmlib",RD),y(this,"roomId",void 0),y(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=T.getChild("[".concat(this.roomId," decryption]"))}decryptEvent(e){var t=this;return R(function*(){var r=e.getWireContent();if(!r.sender_key||!r.session_id||!r.ciphertext)throw new dr(zt.MEGOLM_MISSING_FIELDS,"Missing fields in input");t.addEventToPendingList(e);var n;try{n=yield t.olmDevice.decryptGroupMessage(e.getRoomId(),r.sender_key,r.session_id,r.ciphertext,e.getId(),e.getTs())}catch(h){if(h.name==="DecryptionError")throw h;var s=zt.OLM_DECRYPT_GROUP_MESSAGE_ERROR;throw(h==null?void 0:h.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&(t.requestKeysForEvent(e),s=zt.OLM_UNKNOWN_MESSAGE_INDEX),new dr(s,h instanceof Error?h.message:"Unknown Error: Error is undefined",{session:r.sender_key+"|"+r.session_id})}if(n===null){t.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),r.session_id).catch(()=>{}),t.requestKeysForEvent(e);var l=yield t.olmDevice.sessionMayHaveProblems(r.sender_key,e.getTs()-12e4);if(l){t.prefixedLogger.info("When handling UISI from ".concat(e.getSender()," (sender key ").concat(r.sender_key,"): ")+"recent session problem with that sender:",l);var c=x0[l.type]||x0.unknown;throw l.fixed&&(c+=" Trying to create a new secure channel and re-requesting the keys."),new dr(zt.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,c,{session:r.sender_key+"|"+r.session_id})}throw new dr(zt.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",{session:r.sender_key+"|"+r.session_id})}n.untrusted||t.removeEventFromPendingList(e);var d=JSON.parse(n.result);if(d.room_id!==e.getRoomId())throw new dr(zt.MEGOLM_BAD_ROOM,"Message intended for room "+d.room_id);return{clearEvent:d,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted}})()}requestKeysForEvent(e){var t=e.getWireContent(),r=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)}addEventToPendingList(e){var t,r=e.getWireContent(),n=r.sender_key,s=r.session_id;this.pendingEvents.has(n)||this.pendingEvents.set(n,new Map);var l=this.pendingEvents.get(n);l.has(s)||l.set(s,new Set),(t=l.get(s))===null||t===void 0||t.add(e)}removeEventFromPendingList(e){var t=e.getWireContent(),r=t.sender_key,n=t.session_id,s=this.pendingEvents.get(r),l=s==null?void 0:s.get(n);l&&(l.delete(e),l.size===0&&s.delete(n),s.size===0&&this.pendingEvents.delete(r))}roomKeyFromEvent(e){var t=e.getSenderKey(),r=e.getContent(),n={};if(!r.room_id||!r.session_key||!r.session_id||!r.algorithm){this.prefixedLogger.error("key event is missing fields");return}if(!ym(e)){this.prefixedLogger.error("key event not properly encrypted");return}r["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0);var s={senderKey:t,sessionId:r.session_id,sessionKey:r.session_key,extraSessionData:n,exportFormat:!1,roomId:r.room_id,algorithm:r.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()};return s}forwardedRoomKeyFromEvent(e){var t=this.roomKeyFromEvent(e);if(t){var r=e.getSenderKey(),n=e.getContent(),s=this.baseApis.crypto.deviceList.getUserByIdentityKey(br,r),l=n.sender_key,c=n.sender_claimed_ed25519_key,d=Array.isArray(n.forwarding_curve25519_key_chain)?n.forwarding_curve25519_key_chain:[];if(d=d.slice(),d.push(r),s!==e.getSender()){this.prefixedLogger.error("sending device does not belong to the user it claims to be from");return}if(!l){this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");return}if(!c){this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");return}var h={ed25519:c};return t.senderKey=l,t.keysClaimed=h,t.exportFormat=!0,t.forwardingKeyChain=d,t.extraSessionData.untrusted=!0,t}}shouldAcceptForwardedKey(e,t){var r=this;return R(function*(){var n,s=e.getSenderKey(),l=(n=r.crypto.deviceList.getDeviceByIdentityKey(br,s))!==null&&n!==void 0?n:void 0,c=r.crypto.checkDeviceInfoTrust(e.getSender(),l),d=e.getSender()===r.baseApis.getUserId(),h=c.isVerified()&&d,v=yield r.wasRoomKeyRequested(e,t),p=r.wasRoomKeyForwardedByInviter(e,t),m=r.wasRoomKeyForwardedAsHistory(t);return v&&h||p&&m})()}wasRoomKeyRequested(e,t){var r=this;return R(function*(){var n=yield r.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[St.Sent]);return n.some(s=>s.requestBody.room_id===t.roomId&&s.requestBody.session_id===t.sessionId)})()}wasRoomKeyForwardedByInviter(e,t){var r,n,s,l=this.baseApis.getRoom(t.roomId),c=e.getSenderKey();if(!c)return!1;var d=this.crypto.deviceList.getUserByIdentityKey(br,c);if(!d)return!1;var h=l==null||(r=l.getMember(this.userId))===null||r===void 0?void 0:r.events.member,v=(h==null?void 0:h.getSender())===d||(h==null||(n=h.getUnsigned())===null||n===void 0?void 0:n.prev_sender)===d&&(h==null||(s=h.getPrevContent())===null||s===void 0?void 0:s.membership)===We.Invite;return!!(l&&v)}wasRoomKeyForwardedAsHistory(e){var t=this.baseApis.getRoom(e.roomId);return!!(t&&e.extraSessionData.sharedHistory)}shouldParkForwardedKey(e){var t=this.baseApis.getRoom(e.roomId);return!!(!t&&e.extraSessionData.sharedHistory)}parkForwardedKey(e,t){var r=this;return R(function*(){var n={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};yield r.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],s=>r.crypto.cryptoStore.addParkedSharedHistory(t.roomId,n,s),T.getChild("[addParkedSharedHistory]"))})()}addRoomKey(e){var t=this;return R(function*(){try{yield t.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),(yield t.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted))&&t.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),yield t.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(r){t.prefixedLogger.error("Error handling m.room_key_event: ".concat(r))}})()}onForwardedRoomKey(e){var t=this;return R(function*(){var r=t.forwardedRoomKeyFromEvent(e);r&&((yield t.shouldAcceptForwardedKey(e,r))?yield t.addRoomKey(r):t.shouldParkForwardedKey(r)&&(yield t.parkForwardedKey(e,r)))})()}onRoomKeyEvent(e){var t=this;return R(function*(){if(e.getType()=="m.forwarded_room_key")yield t.onForwardedRoomKey(e);else{var r=t.roomKeyFromEvent(e);if(!r)return;yield t.addRoomKey(r)}})()}onRoomKeyWithheldEvent(e){var t=this;return R(function*(){var r=e.getContent(),n=r.sender_key;r.code==="m.no_olm"?yield t.onNoOlmWithheldEvent(e):r.code==="m.unavailable"||(yield t.olmDevice.addInboundGroupSessionWithheld(r.room_id,n,r.session_id,r.code,r.reason)),r.session_id?yield t.retryDecryption(n,r.session_id):yield t.retryDecryptionFromSender(n)})()}onNoOlmWithheldEvent(e){var t=this;return R(function*(){var r=e.getContent(),n=r.sender_key,s=e.getSender();if(t.prefixedLogger.warn("".concat(s,":").concat(n," was unable to establish an olm session with us")),yield t.olmDevice.getSessionIdForDevice(n)){t.prefixedLogger.debug("New session already created.  Not creating a new one."),yield t.olmDevice.recordSessionProblem(n,"no_olm",!0);return}var l=t.crypto.deviceList.getDeviceByIdentityKey(r.algorithm,n);if(!l&&(yield t.crypto.downloadKeys([s],!1),l=t.crypto.deviceList.getDeviceByIdentityKey(r.algorithm,n),!l)){t.prefixedLogger.info("Couldn't find device for identity key "+n+": not establishing session"),yield t.olmDevice.recordSessionProblem(n,"no_olm",!1);return}yield Ji(t.olmDevice,t.baseApis,new Map([[s,[l]]]),!1);var c={algorithm:br,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[Fr]:Jn()};yield ja(c.ciphertext,t.userId,void 0,t.olmDevice,s,l,{type:"m.dummy"}),yield t.olmDevice.recordSessionProblem(n,"no_olm",!0),yield t.baseApis.sendToDevice("m.room.encrypted",new Map([[s,new Map([[l.deviceId,c]])]]))})()}hasKeysForKeyRequest(e){var t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){var t=e.userId,r=e.deviceId,n=this.crypto.getStoredDevice(t,r),s=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[n]]])).then(l=>{var c,d=(c=l.get(t))===null||c===void 0?void 0:c.get(r);return d!=null&&d.sessionId?(this.prefixedLogger.debug("sharing keys for session "+s.sender_key+"|"+s.session_id+" with device "+t+":"+r),this.buildKeyForwardingMessage(s.room_id,s.sender_key,s.session_id)):null}).then(l=>{var c={algorithm:br,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[Fr]:Jn()};return this.olmlib.encryptMessageForDevice(c.ciphertext,this.userId,void 0,this.olmDevice,t,n,l).then(()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[r,c]])]])))})}buildKeyForwardingMessage(e,t,r){var n=this;return R(function*(){var s=yield n.olmDevice.getInboundGroupSessionKey(e,t,r);return{type:"m.forwarded_room_key",content:{algorithm:Zr,room_id:e,sender_key:t,sender_claimed_ed25519_key:s.sender_claimed_ed25519_key,session_id:r,session_key:s.key,chain_index:s.chain_index,forwarding_curve25519_key_chain:s.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":s.shared_history||!1}}})()}importRoomKey(e){var{untrusted:t,source:r}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={};return(t||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then(()=>{r!=="backup"&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch(s=>{this.prefixedLogger.debug("Failed to back up megolm session",s)}),this.retryDecryption(e.sender_key,e.session_id,!n.untrusted)})}retryDecryption(e,t,r){var n=this;return R(function*(){var s,l=n.pendingEvents.get(e);if(!l)return!0;var c=l.get(t);if(!c)return!0;var d=[...c];return n.prefixedLogger.debug("Retrying decryption on events:",d.map(h=>"".concat(h.getId()))),yield Promise.all(d.map((function(){var h=R(function*(v){try{yield v.attemptDecryption(n.crypto,{isRetry:!0,forceRedecryptIfUntrusted:r})}catch{}});return function(v){return h.apply(this,arguments)}})())),!((s=n.pendingEvents.get(e))!==null&&s!==void 0&&s.has(t))})()}retryDecryptionFromSender(e){var t=this;return R(function*(){var r=t.pendingEvents.get(e);return r?(t.pendingEvents.delete(e),yield Promise.all([...r].map((function(){var n=R(function*(s){var[l,c]=s;yield Promise.all([...c].map((function(){var d=R(function*(h){try{yield h.attemptDecryption(t.crypto)}catch{}});return function(h){return d.apply(this,arguments)}})()))});return function(s){return n.apply(this,arguments)}})())),!t.pendingEvents.has(e)):!0})()}sendSharedHistoryInboundSessions(e){var t=this;return R(function*(){yield Ji(t.olmDevice,t.baseApis,e);var r=yield t.olmDevice.getSharedHistoryInboundGroupSessions(t.roomId);t.prefixedLogger.debug("Sharing history in with users ".concat(Array.from(e.keys())),r.map(C=>{var[U,I]=C;return"".concat(U,"|").concat(I)}));for(var[n,s]of r){var l=yield t.buildKeyForwardingMessage(t.roomId,n,s),c=[],d=new Map;for(var[h,v]of e){var p=new Map;d.set(h,p);for(var m of v){var _={algorithm:br,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[Fr]:Jn()};p.set(m.deviceId,_),c.push(ja(_.ciphertext,t.userId,void 0,t.olmDevice,h,m,l))}}yield Promise.all(c);for(var[b,E]of d){for(var[M,O]of E)tM(O)||(t.prefixedLogger.debug("No ciphertext for device "+b+":"+M+": pruning"),E.delete(M));E.size===0&&(t.prefixedLogger.debug("Pruned all devices for user "+b),d.delete(b))}if(d.size===0){t.prefixedLogger.debug("No users left to send to: aborting");return}yield t.baseApis.sendToDevice("m.room.encrypted",d)}})()}}var x0={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};SR(Zr,nM,iM);class B0{constructor(e,t){y(this,"accountDataClientAdapter",void 0),y(this,"crossSigningCallbacks",void 0),y(this,"ssssCryptoCallbacks",void 0),y(this,"crossSigningKeys",void 0),y(this,"keySignatures",void 0),y(this,"keyBackupInfo",void 0),y(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new sM(e),this.crossSigningCallbacks=new oM,this.ssssCryptoCallbacks=new lM(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,r){this.keySignatures||(this.keySignatures={});var n=this.keySignatures[e]||{};this.keySignatures[e]=n,n[t]=r}setAccountData(e,t){var r=this;return R(function*(){yield r.accountDataClientAdapter.setAccountData(e,t)})()}buildOperation(){var e=this.accountDataClientAdapter.values;return new aM(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}persist(e){var t=this;return R(function*(){if(t.crossSigningKeys){var r=gR(e.cryptoStore,e.olmDevice);for(var n of["master","self_signing","user_signing"]){var s;T.log("Cache ".concat(n," cross-signing private key locally"));var l=t.crossSigningCallbacks.privateKeys.get(n);yield(s=r.storeCrossSigningKeyCache)===null||s===void 0?void 0:s.call(r,n,l)}yield e.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],c=>{e.cryptoStore.storeCrossSigningKeys(c,t.crossSigningKeys.keys)})}t.sessionBackupPrivateKey&&(yield e.storeSessionBackupPrivateKey(t.sessionBackupPrivateKey))})()}}class aM{constructor(e,t,r,n){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=r,this.keySignatures=n}apply(e){var t=this;return R(function*(){var r=e.baseApis;if(t.crossSigningKeys){var n,s,l={};for(var[c,d]of Object.entries(t.crossSigningKeys.keys))l[c+"_key"]=d;yield(n=(s=t.crossSigningKeys).authUpload)===null||n===void 0?void 0:n.call(s,p=>r.uploadDeviceSigningKeys(p??void 0,l)),e.crossSigningInfo.setKeys(t.crossSigningKeys.keys)}if(t.accountData)for(var[h,v]of t.accountData)yield r.setAccountData(h,v);t.keySignatures&&(yield r.uploadKeySignatures(t.keySignatures)),t.keyBackupInfo&&(t.keyBackupInfo.version?yield r.http.authedRequest(se.Put,"/room_keys/version/"+t.keyBackupInfo.version,void 0,{algorithm:t.keyBackupInfo.algorithm,auth_data:t.keyBackupInfo.auth_data},{prefix:qt.V3}):yield r.http.authedRequest(se.Post,"/room_keys/version",void 0,t.keyBackupInfo,{prefix:qt.V3}),yield e.backupManager.checkKeyBackup())})()}}class sM extends Pt{constructor(e){super(),this.existingValues=e,y(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){var t=this.values.get(e);if(t)return t;var r=this.existingValues.get(e);return r?r.getContent():null}setAccountData(e,t){var r=this.values.get(e);return this.values.set(e,t),Promise.resolve().then(()=>{var n=new _r({type:e,content:t});return this.emit(Pe.AccountData,n,r),{}})}}class oM{constructor(){y(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){var r;return Promise.resolve((r=this.privateKeys.get(e))!==null&&r!==void 0?r:null)}saveCrossSigningKeys(e){for(var[t,r]of Object.entries(e))this.privateKeys.set(t,r)}}class lM{constructor(e){this.delegateCryptoCallbacks=e,y(this,"privateKeys",new Map)}getSecretStorageKey(e,t){var r=this;return R(function*(){var n,{keys:s}=e;for(var l of Object.keys(s)){var c=r.privateKeys.get(l);if(c)return[l,c]}if(r!=null&&(n=r.delegateCryptoCallbacks)!==null&&n!==void 0&&n.getSecretStorageKey){var d=yield r.delegateCryptoCallbacks.getSecretStorageKey({keys:s},t);if(d){var[h,v]=d;r.privateKeys.set(h,v)}return d}return null})()}addPrivateKey(e,t,r){var n,s;this.privateKeys.set(e,r),(n=this.delegateCryptoCallbacks)===null||n===void 0||(s=n.cacheSecretStorageKey)===null||s===void 0||s.call(n,e,t,r)}}var ci="m.secret_storage.v1.aes-hmac-sha2";class ac{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return R(function*(){var t=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return t?t.key:null})()}setDefaultKeyId(e){return new Promise((t,r)=>{var n=s=>{s.getType()==="m.secret_storage.default_key"&&s.getContent().key===e&&(this.accountDataAdapter.removeListener(Pe.AccountData,n),t())};this.accountDataAdapter.on(Pe.AccountData,n),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch(s=>{this.accountDataAdapter.removeListener(Pe.AccountData,n),r(s)})})}addKey(e,t,r){var n=this;return R(function*(){if(e!==ci)throw new Error("Unknown key algorithm ".concat(e));var s={algorithm:e};t.name&&(s.name=t.name),t.passphrase&&(s.passphrase=t.passphrase);var{iv:l,mac:c}=yield ks(t.key);if(s.iv=l,s.mac=c,!r)do r=Qn(32);while(yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(r)));return yield n.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(r),s),{keyId:r,keyInfo:s}})()}getKey(e){var t=this;return R(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var r=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return r?[e,r]:null})()}hasKey(e){var t=this;return R(function*(){var r=yield t.getKey(e);return!!r})()}checkKey(e,t){return R(function*(){if(t.algorithm===ci)if(t.mac){var{mac:r}=yield ks(e,t.iv);return Pp(t.mac)===Pp(r)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,r){var n=this;return R(function*(){var s={};if(!r){var l=yield n.getDefaultKeyId();if(!l)throw new Error("No keys specified and no default key present");r=[l]}if(r.length===0)throw new Error("Zero keys given to encrypt with!");for(var c of r){var d=yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+c);if(!d)throw new Error("Unknown key: "+c);if(d.algorithm===ci){var h={[c]:d},[,v]=yield n.getSecretStorageKey(h,e);s[c]=yield v.encrypt(t)}else T.warn("unknown algorithm for secret storage key "+c+": "+d.algorithm)}yield n.accountDataAdapter.setAccountData(e,{encrypted:s})})()}get(e){var t=this;return R(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(r){if(!r.encrypted)throw new Error("Content is not encrypted!");var n={};for(var s of Object.keys(r.encrypted)){var l=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s),c=r.encrypted[s];(l==null?void 0:l.algorithm)===ci&&c.iv&&c.ciphertext&&c.mac&&(n[s]=l)}if(Object.keys(n).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[d,h]=yield t.getSecretStorageKey(n,e),v=r.encrypted[d];return h.decrypt(v)}})()}isStored(e){var t=this;return R(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(r!=null&&r.encrypted))return null;var n={};for(var s of Object.keys(r.encrypted)){var l=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s);if(l){var c=r.encrypted[s];l.algorithm===ci&&c.iv&&c.ciphertext&&c.mac&&(n[s]=l)}}return Object.keys(n).length?n:null})()}getSecretStorageKey(e,t){var r=this;return R(function*(){if(!r.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var n=yield r.callbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[s,l]=n;if(!e[s])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[s].algorithm===ci){var c={encrypt:function(h){return sl(h,l,t)},decrypt:function(h){return bc(h,l,t)}};return[s,c]}else throw new Error("Unknown key type: "+e[s].algorithm)})()}}function Pp(a){for(var e=a.length;e>=1&&a.charCodeAt(e-1)==61;)e--;return e<a.length?a.substring(0,e):a}var uM="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function ks(a,e){return sl(uM,a,"",e)}const cM=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:ci,ServerSideSecretStorageImpl:ac,calculateKeyCheck:ks,trimTrailingEquals:Pp},Symbol.toStringTag,{value:"Module"}));class dM{constructor(e,t){this.baseApis=e,this.cryptoCallbacks=t,y(this,"requests",new Map)}request(e,t){var r=this.baseApis.makeTxnId(),n=qa();this.requests.set(r,{name:e,devices:t,deferred:n});var s=h=>{var v={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:r},p=new Map;for(var m of t)p.set(m,v);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),p]])),n.reject(new Error(h||"Cancelled"))},l={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:r,[Fr]:Jn()},c=new Map;for(var d of t)c.set(d,l);return T.info("Request secret ".concat(e," from ").concat(t,", id ").concat(r)),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),c]])),{requestId:r,promise:n.promise,cancel:s}}onRequestReceived(e){var t=this;return R(function*(){var r=e.getSender(),n=e.getContent();if(!(r!==t.baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))){var s=n.requesting_device_id;if(n.action!=="request_cancellation"){if(n.action==="request"){if(s===t.baseApis.deviceId||(T.info("received request for secret ("+r+", "+s+", "+n.request_id+")"),!t.cryptoCallbacks.onSecretRequested))return;var l=yield t.cryptoCallbacks.onSecretRequested(r,s,n.request_id,n.name,t.baseApis.checkDeviceTrust(r,s));if(l){T.info("Preparing ".concat(n.name," secret for ").concat(s));var c={type:"m.secret.send",content:{request_id:n.request_id,secret:l}},d={algorithm:br,sender_key:t.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[Fr]:Jn()};yield Ji(t.baseApis.crypto.olmDevice,t.baseApis,new Map([[r,[t.baseApis.getStoredDevice(r,s)]]])),yield ja(d.ciphertext,t.baseApis.getUserId(),t.baseApis.deviceId,t.baseApis.crypto.olmDevice,r,t.baseApis.getStoredDevice(r,s),c);var h=new Map([[r,new Map([[s,d]])]]);T.info("Sending ".concat(n.name," secret for ").concat(s)),t.baseApis.sendToDevice("m.room.encrypted",h)}else T.info("Request denied for ".concat(n.name," secret for ").concat(s))}}}})()}onSecretReceived(e){if(e.getSender()===this.baseApis.getUserId()){if(!ym(e)){T.error("secret event not properly encrypted");return}var t=e.getContent(),r=this.baseApis.crypto.deviceList.getUserByIdentityKey(br,e.getSenderKey()||"");if(r!==e.getSender()){T.error("sending device does not belong to the user it claims to be from");return}T.log("got secret share for request",t.request_id);var n=this.requests.get(t.request_id);if(n){var s=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(br,e.getSenderKey());if(!s){T.log("secret share from unknown device with key",e.getSenderKey());return}if(!n.devices.includes(s.deviceId)){T.log("unsolicited secret share from device",s.deviceId);return}var l=this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),s);if(!l.isVerified()){T.log("secret share from unverified device");return}T.log("Successfully received secret ".concat(n.name," ")+"from ".concat(s.deviceId)),n.deferred.resolve(t.secret)}}}}class fM{constructor(e,t,r){y(this,"storageImpl",void 0),y(this,"sharingImpl",void 0),this.storageImpl=new ac(e,t),this.sharingImpl=new dM(r,t)}getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(e){return this.storageImpl.setDefaultKeyId(e)}addKey(e,t,r){return this.storageImpl.addKey(e,t,r)}getKey(e){return this.storageImpl.getKey(e)}hasKey(e){return this.storageImpl.hasKey(e)}checkKey(e,t){return this.storageImpl.checkKey(e,t)}store(e,t,r){return this.storageImpl.store(e,t,r)}get(e){return this.storageImpl.get(e)}isStored(e){var t=this;return R(function*(){return t.storageImpl.isStored(e)})()}request(e,t){return this.sharingImpl.request(e,t)}onRequestReceived(e){return this.sharingImpl.onRequestReceived(e)}onSecretReceived(e){this.sharingImpl.onSecretReceived(e)}}function hM(a,e,t){var r=Object.assign({},{code:a,reason:e},t);return new _r({type:$.KeyVerificationCancel,content:r})}function Qi(a,e){return function(t){return hM(a,e,t)}}var bR=Qi("m.user","Cancelled by user"),vM=Qi("m.timeout","Timed out"),Qu=Qi("m.unknown_method","Unknown method"),_R=Qi("m.unexpected_message","Unexpected message"),Rs=Qi("m.key_mismatch","Key mismatch"),gM=Qi("m.invalid_message","Invalid message");function Lp(a){var e=a.getContent();if(e){var{code:t,reason:r}=e;return{code:t,reason:r}}else return{code:"Unknown error",reason:"m.unknown"}}var K0=new Error("Verification timed out");class xp extends Error{constructor(e){super(),this.startEvent=e}}var pM=Yf;class wm extends Pt{constructor(e,t,r,n,s,l){super(),this.channel=e,this.baseApis=t,this.userId=r,this.deviceId=n,this.startEvent=s,this.request=l,y(this,"cancelled",!1),y(this,"_done",!1),y(this,"promise",null),y(this,"transactionTimeoutTimer",null),y(this,"expectedEvent",void 0),y(this,"resolve",void 0),y(this,"reject",void 0),y(this,"resolveEvent",void 0),y(this,"rejectEvent",void 0),y(this,"started",void 0),y(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;var e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){T.info("Refreshing/starting the verification transaction timeout timer"),this.transactionTimeoutTimer!==null&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{!this._done&&!this.cancelled&&(T.info("Triggering verification timeout"),this.cancel(K0))},600*1e3)}endTimer(){this.transactionTimeoutTimer!==null&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));var t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise((r,n)=>{this.resolveEvent=r,this.rejectEvent=n}))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(T.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){var t=this.rejectEvent;this.rejectEvent=void 0,t(new xp(e))}else this.startEvent=e}handleEvent(e){if(!this._done){if(e.getType()===this.expectedEvent){if(this.expectedEvent!==$.KeyVerificationDone){var t;this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),(t=this.resolveEvent)===null||t===void 0||t.call(this,e)}}else if(e.getType()===$.KeyVerificationCancel){var r=this.reject;if(this.reject=void 0,r){var n=e.getContent(),{reason:s,code:l}=n;r(new Error("Other side cancelled verification "+"because ".concat(s," (").concat(l,")")))}}else if(this.expectedEvent){var c=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){var d=this.rejectEvent;this.rejectEvent=void 0,d(c)}this.cancel(c)}}}done(){var e=this;return R(function*(){if(e.endTimer(),!e._done){var t;return e.request.onVerifierFinished(),(t=e.resolve)===null||t===void 0||t.call(e),VD(e.baseApis,e.userId,e.deviceId)}})()}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===K0){var t=vM();this.send(t.getType(),t.getContent())}else if(e instanceof _r){var r=e.getSender();if(r!==this.userId){var n=e.getContent();e.getType()===$.KeyVerificationCancel?(n.code=n.code||"m.unknown",n.reason=n.reason||n.body||"Unknown reason",this.send($.KeyVerificationCancel,n)):this.send($.KeyVerificationCancel,{code:"m.unknown",reason:n.body||"Unknown reason"})}}else this.send($.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()});this.promise!==null?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(pM.Cancel,e)}}verify(){var e=this;return this.promise?this.promise:(this.promise=new Promise((t,r)=>{this.resolve=function(){e._done=!0,e.endTimer(),t(...arguments)},this.reject=n=>{this._done=!0,this.endTimer(),r(n)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise((t,r)=>{var n,s=(n=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))===null||n===void 0?void 0:n.getId();s===this.deviceId&&r(new Error("Device ID is the same as the cross-signing ID")),t()}).then(()=>this.doVerification()).then(this.done.bind(this),this.cancel.bind(this))),this.promise)}verifyKeys(e,t,r){var n=this;return R(function*(){var s=[];for(var[l,c]of Object.entries(t)){var d=l.split(":",2)[1],h=n.baseApis.getStoredDevice(e,d);if(h)r(l,h,c),s.push([d,l,h.keys[l]]);else{var v=n.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);v&&v.getId()===d?(r(l,qr.fromStorage({keys:{[l]:d}},d),c),s.push([d,l,d])):T.warn("verification: Could not find device ".concat(d," to verify"))}}if(!s.length)throw new Error("No devices could be verified");T.info("Verification completed! Marking devices verified: ",s);for(var[p,m,_]of s)yield n.baseApis.crypto.setDeviceVerification(e,p,!0,null,null,{[m]:_});e==n.baseApis.credentials.userId&&(yield n.baseApis.checkKeyBackup())})()}get events(){}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}var Rm=(function(a){return a.Sas="m.sas.v1",a.ShowQrCode="m.qr_code.show.v1",a.ScanQrCode="m.qr_code.scan.v1",a.Reciprocate="m.reciprocate.v1",a})({}),mM=Rm.ShowQrCode,ER=Rm.ScanQrCode,yM=Yf;class sc extends wm{constructor(){var e;super(...arguments),e=this,y(this,"reciprocateQREvent",void 0),y(this,"doVerification",R(function*(){if(!e.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");var{qrCodeData:t}=e.request;if(e.startEvent.getContent().secret!==(t==null?void 0:t.encodedSharedSecret))throw Rs();yield new Promise((c,d)=>{e.reciprocateQREvent={confirm:c,cancel:()=>d(bR())},e.emit(yM.ShowReciprocateQr,e.reciprocateQREvent)});var r={};switch(t==null?void 0:t.mode){case yn.VerifyOtherUser:{var n=t.otherUserMasterKey;r["ed25519:".concat(n)]=n;break}case yn.VerifySelfTrusted:{var s=e.request.targetDevice.deviceId;r["ed25519:".concat(s)]=t.otherDeviceKey;break}case yn.VerifySelfUntrusted:{var l=t.myMasterKey;r["ed25519:".concat(l)]=l;break}}yield e.verifyKeys(e.userId,r,(c,d,h)=>{var v=r[c];if(!v)throw Rs();if(h!==v)throw T.error("key ID from key info does not match"),Rs();for(var p in d.keys)if(p.startsWith("ed25519")){var m=r[p];if(!m)throw Rs();if(d.keys[p]!==m)throw T.error("master key does not match"),Rs()}})}))}static factory(e,t,r,n,s,l){return new sc(e,t,r,n,s,l)}static get NAME(){return"m.reciprocate.v1"}getReciprocateQrCodeCallbacks(){var e;return(e=this.reciprocateQREvent)!==null&&e!==void 0?e:null}}var SM=2,bM="MATRIX",yn=(function(a){return a[a.VerifyOtherUser=0]="VerifyOtherUser",a[a.VerifySelfTrusted=1]="VerifySelfTrusted",a[a.VerifySelfUntrusted=2]="VerifySelfUntrusted",a})(yn||{});class Ma{constructor(e,t,r,n,s,l){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=r,this.otherDeviceKey=n,this.myMasterKey=s,this.buffer=l}static create(e,t){return R(function*(){var r=Ma.generateSharedSecret(),n=Ma.determineMode(e,t),s=null,l=null,c=null;if(n===yn.VerifyOtherUser){var d=t.getStoredCrossSigningForUser(e.otherUserId);s=d.getId("master")}else if(n===yn.VerifySelfTrusted)l=yield Ma.getOtherDeviceKey(e,t);else if(n===yn.VerifySelfUntrusted){var h=t.getUserId(),v=t.getStoredCrossSigningForUser(h);c=v.getId("master")}var p=Ma.generateQrData(e,t,n,r,s,l,c),m=Ma.generateBuffer(p);return new Ma(n,r,s,l,c,m)})()}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){var e=new Uint8Array(11);return globalThis.crypto.getRandomValues(e),Vf(e)}static getOtherDeviceKey(e,t){return R(function*(){var r=t.getUserId(),n=e.targetDevice,s=n.deviceId?t.getStoredDevice(r,n.deviceId):void 0;if(!s)throw new Error("could not find device "+(n==null?void 0:n.deviceId));return s.getFingerprint()})()}static determineMode(e,t){var r=t.getUserId(),n=e.otherUserId,s=yn.VerifyOtherUser;if(r===n){var l=t.checkUserTrust(r);l.isCrossSigningVerified()?s=yn.VerifySelfTrusted:s=yn.VerifySelfUntrusted}return s}static generateQrData(e,t,r,n,s,l,c){var d=t.getUserId(),h=e.channel.transactionId,v={prefix:bM,version:SM,mode:r,transactionId:h,firstKeyB64:"",secondKeyB64:"",secretB64:n},p=t.getStoredCrossSigningForUser(d);return r===yn.VerifyOtherUser?(v.firstKeyB64=p.getId("master"),v.secondKeyB64=s):r===yn.VerifySelfTrusted?(v.firstKeyB64=p.getId("master"),v.secondKeyB64=l):r===yn.VerifySelfUntrusted&&(v.firstKeyB64=t.getDeviceEd25519Key(),v.secondKeyB64=c),v}static generateBuffer(e){var t=Buffer.alloc(0),r=c=>{var d=Buffer.from([c]);t=Buffer.concat([t,d])},n=c=>{var d=Buffer.alloc(2);d.writeInt16BE(c,0),t=Buffer.concat([t,d])},s=function(d,h){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,p=Buffer.from(d,h);v&&n(p.byteLength),t=Buffer.concat([t,p])},l=c=>{var d=Ar(c),h=Buffer.from(d);t=Buffer.concat([t,h])};return s(e.prefix,"ascii",!1),r(e.version),r(e.mode),s(e.transactionId,"utf-8"),l(e.firstKeyB64),l(e.secondKeyB64),l(e.secretB64),t}}function _M(a){return[(a[0]<<5|a[1]>>3)+1e3,((a[1]&7)<<10|a[2]<<2|a[3]>>6)+1e3,((a[3]&63)<<7|a[4]>>1)+1e3]}var xg=$.KeyVerificationStart,EM=[$.KeyVerificationAccept,$.KeyVerificationKey,$.KeyVerificationMac],Wd,TM=Qi("m.mismatched_sas","Mismatched short authentication string"),wM=Qi("m.mismatched_commitment","Mismatched commitment"),RM=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];function CM(a){var e=[a[0]>>2,(a[0]&3)<<4|a[1]>>4,(a[1]&15)<<2|a[2]>>6,a[2]&63,a[3]>>2,(a[3]&3)<<4|a[4]>>4,(a[4]&15)<<2|a[5]>>6];return e.map(t=>RM[t])}var Bp={decimal:_M,emoji:CM};function IM(a,e){var t={};for(var r of e)r in Bp&&(t[r]=Bp[r](Array.from(a)));return t}var OM={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function gu(a,e){return function(t,r){var n=a[OM[e]](t,r);return T.log("SAS calculateMAC:",e,[t,r],n),n}}var kM={"curve25519-hkdf-sha256":function(e,t,r){var n="".concat(e.baseApis.getUserId(),"|").concat(e.baseApis.deviceId,"|")+"".concat(e.ourSASPubKey,"|"),s="".concat(e.userId,"|").concat(e.deviceId,"|").concat(e.theirSASPubKey,"|"),l="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+s:s+n)+e.channel.transactionId;return t.generate_bytes(l,r)},curve25519:function(e,t,r){var n="".concat(e.baseApis.getUserId()).concat(e.baseApis.deviceId),s="".concat(e.userId).concat(e.deviceId),l="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+s:s+n)+e.channel.transactionId;return t.generate_bytes(l,r)}},Kp=["curve25519-hkdf-sha256","curve25519"],jp=["sha256"],Fp=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],TR=Object.keys(Bp),AM=new Set(Kp),DM=new Set(jp),MM=new Set(Fp),j0=new Set(TR);function pu(a,e){return Array.isArray(a)?a.filter(t=>e.has(t)):[]}var NM=Yf;class Qo extends wm{constructor(){var e;super(...arguments),e=this,y(this,"waitingForAccept",void 0),y(this,"ourSASPubKey",void 0),y(this,"theirSASPubKey",void 0),y(this,"sasEvent",void 0),y(this,"doVerification",R(function*(){yield globalThis.Olm.init(),Wd=Wd||new globalThis.Olm.Utility,yield e.baseApis.downloadKeys([e.userId]);var t=!1;do try{return e.initiatedByMe?yield e.doSendVerification():yield e.doRespondVerification()}catch(r){if(r instanceof xp)e.startEvent=r.startEvent,t=!0;else throw r}while(t)}))}static get NAME(){return Rm.Sas}get events(){return EM}canSwitchStartEvent(e){if(e.getType()!==xg)return!1;var t=e.getContent();return(t==null?void 0:t.method)===Qo.NAME&&!!this.waitingForAccept}sendStart(){var e=this;return R(function*(){var t=e.channel.completeContent(xg,{method:Qo.NAME,from_device:e.baseApis.deviceId,key_agreement_protocols:Kp,hashes:jp,message_authentication_codes:Fp,short_authentication_string:TR});return yield e.channel.sendCompleted(xg,t),t})()}verifyAndCheckMAC(e,t,r,n){var s=this;return R(function*(){var l=kM[e](s,r,6),c=new Promise((v,p)=>{s.sasEvent={sas:IM(l,t),confirm:(function(){var m=R(function*(){try{yield s.sendMAC(r,n),v()}catch(b){p(b)}});function _(){return m.apply(this,arguments)}return _})(),cancel:()=>p(bR()),mismatch:()=>p(TM())},s.emit(NM.ShowSas,s.sasEvent)}),[d]=yield Promise.all([s.waitForEvent($.KeyVerificationMac).then(v=>(s.expectedEvent=$.KeyVerificationDone,v)),c]),h=d.getContent();yield s.checkMAC(r,h,n)})()}doSendVerification(){var e=this;return R(function*(){e.waitingForAccept=!0;var t;if(e.startEvent?t=e.channel.completedContentFromEvent(e.startEvent):t=yield e.sendStart(),!e.initiatedByMe)throw new xp(e.startEvent);var r;try{r=yield e.waitForEvent($.KeyVerificationAccept)}finally{e.waitingForAccept=!1}var n=r.getContent(),s=pu(n.short_authentication_string,j0);if(!(AM.has(n.key_agreement_protocol)&&DM.has(n.hash)&&MM.has(n.message_authentication_code)&&s.length))throw Qu();if(typeof n.commitment!="string")throw gM();var l=n.key_agreement_protocol,c=n.message_authentication_code,d=n.commitment,h=new globalThis.Olm.SAS;try{e.ourSASPubKey=h.get_pubkey(),yield e.send($.KeyVerificationKey,{key:e.ourSASPubKey}),r=yield e.waitForEvent($.KeyVerificationKey),n=r.getContent();var v=n.key+Yi.stringify(t);if(Wd.sha256(v)!==d)throw wM();e.theirSASPubKey=n.key,h.set_their_key(n.key),yield e.verifyAndCheckMAC(l,s,h,c)}finally{h.free()}})()}doRespondVerification(){var e=this;return R(function*(){var t=e.channel.completedContentFromEvent(e.startEvent),r=pu(Kp,new Set(t.key_agreement_protocols))[0],n=pu(jp,new Set(t.hashes))[0],s=pu(Fp,new Set(t.message_authentication_codes))[0],l=pu(t.short_authentication_string,j0);if(!(r!==void 0&&n!==void 0&&s!==void 0&&l.length))throw Qu();var c=new globalThis.Olm.SAS;try{var d=c.get_pubkey()+Yi.stringify(t);yield e.send($.KeyVerificationAccept,{key_agreement_protocol:r,hash:n,message_authentication_code:s,short_authentication_string:l,commitment:Wd.sha256(d)});var h=yield e.waitForEvent($.KeyVerificationKey);t=h.getContent(),e.theirSASPubKey=t.key,c.set_their_key(t.key),e.ourSASPubKey=c.get_pubkey(),yield e.send($.KeyVerificationKey,{key:e.ourSASPubKey}),yield e.verifyAndCheckMAC(r,l,c,s)}finally{c.free()}})()}sendMAC(e,t){var r={},n=[],s="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,l="ed25519:".concat(this.baseApis.deviceId);r[l]=gu(e,t)(this.baseApis.getDeviceEd25519Key(),s+l),n.push(l);var c=this.baseApis.getCrossSigningId();if(c){var d="ed25519:".concat(c);r[d]=gu(e,t)(c,s+d),n.push(d)}var h=gu(e,t)(n.sort().join(","),s+"KEY_IDS");return this.send($.KeyVerificationMac,{mac:r,keys:h})}checkMAC(e,t,r){var n=this;return R(function*(){var s="MATRIX_KEY_VERIFICATION_MAC"+n.userId+n.deviceId+n.baseApis.getUserId()+n.baseApis.deviceId+n.channel.transactionId;if(t.keys!==gu(e,r)(Object.keys(t.mac).sort().join(","),s+"KEY_IDS"))throw Rs();yield n.verifyKeys(n.userId,t.mac,(l,c,d)=>{if(d!==gu(e,r)(c.keys[l],s+l))throw Rs()})})()}getShowSasCallbacks(){var e;return(e=this.sasEvent)!==null&&e!==void 0?e:null}}function F0(a,e){if(!a.private_key_salt||!a.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return _m(e,a.private_key_salt,a.private_key_iterations,a.private_key_bits)}var q0=5e5;function Cm(a){return qp.apply(this,arguments)}function qp(){return qp=R(function*(a){var e=Qn(32),t=yield _m(a,e,q0);return{key:t,salt:e,iterations:q0}}),qp.apply(this,arguments)}var UM=600*1e3,PM=120*1e3,LM=3*1e3,ol="m.key.verification.",mt=ol+"request",mr=ol+"start",Yn=ol+"cancel",xM=ol+"done",Hn=ol+"ready",Ui=Va.Unsent,Fn=Va.Requested,oi=Va.Ready,Fi=Va.Started,mu=Va.Cancelled,yu=Va.Done;class Cs extends Pt{constructor(e,t,r){var n;super(),n=this,this.channel=e,this.verificationMethods=t,this.client=r,y(this,"eventsByUs",new Map),y(this,"eventsByThem",new Map),y(this,"_observeOnly",!1),y(this,"timeoutTimer",null),y(this,"_accepting",!1),y(this,"_declining",!1),y(this,"verifierHasFinished",!1),y(this,"_cancelled",!1),y(this,"_chosenMethod",null),y(this,"_qrCodeData",null),y(this,"requestReceivedAt",null),y(this,"commonMethods",[]),y(this,"_phase",void 0),y(this,"_cancellingUserId",void 0),y(this,"_verifier",void 0),y(this,"cancelOnTimeout",R(function*(){try{n.initiatedByMe?yield n.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):yield n.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(s){T.error("Error while cancelling verification request",s)}})),this.channel.request=this,this.setPhase(Ui,!1)}static validateEvent(e,t,r){var n=t.getContent();return!e||!e.startsWith(ol)?!1:n?(e===mt||e===Hn)&&!Array.isArray(n.methods)?(T.log("VerificationRequest: validateEvent: fail because methods"),!1):(e===mt||e===Hn||e===mr)&&(typeof n.from_device!="string"||n.from_device.length===0)?(T.log("VerificationRequest: validateEvent: fail because from_device"),!1):!0:(T.log("VerificationRequest: validateEvent: no content"),!1)}get transactionId(){return this.channel.transactionId}get roomId(){return this.channel.roomId}get invalid(){return this.phase===Ui}get requested(){return this.phase===Fn}get cancelled(){return this.phase===mu}get ready(){return this.phase===oi}get started(){return this.phase===Fi}get done(){return this.phase===yu}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){var t=this.channel.getTimestamp(e)+UM;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=Fn){var r=this.requestReceivedAt+PM;t=Math.min(t,r)}return Math.max(0,t-Date.now())}get timeout(){var e=this.getEventByEither(mt);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(mt)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return dR(this)}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==yu&&this._phase!==mu}get qrCodeData(){return this._qrCodeData}getQRCodeBytes(){var e;return(e=this._qrCodeData)===null||e===void 0?void 0:e.getBuffer()}generateQRCode(){var e=this;return R(function*(){return e.getQRCodeBytes()})()}otherPartySupportsMethod(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t&&!this.ready&&!this.started)return!1;var r=this.eventsByThem.get(mt)||this.eventsByThem.get(Hn);if(!r){if(this.started&&this.initiatedByMe){var n=this.eventsByUs.get(mr),s=n&&n.getContent(),l=s&&s.method;return e==l}return!1}var c=r.getContent();if(!c)return!1;var{methods:d}=c;return Array.isArray(d)?d.includes(e):!1}get initiatedByMe(){var e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===Ui&&e)return!0;var t=this.eventsByUs.has(mt),r=this.eventsByThem.has(mt);if(t&&!r)return!0;if(!t&&r)return!1;var n=this.eventsByUs.has(mr),s=this.eventsByThem.has(mr);return!!(n&&!s)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get otherDeviceId(){return this.channel.deviceId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){var e=this.eventsByUs.get(Yn),t=this.eventsByThem.get(Yn);if(e&&(!t||e.getId()<t.getId()))return e.getSender();if(t)return t.getSender()}get cancellationCode(){var e=this.getEventByEither(Yn);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){var e=this.eventsByThem.get(mt)||this.eventsByThem.get(Hn)||this.eventsByThem.get(mr),t=e==null?void 0:e.getContent(),r=t==null?void 0:t.from_device;return{userId:this.otherUserId,deviceId:r}}beginKeyVerification(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(!this.observeOnly&&!this._verifier){var r=this.phase===Fn||this.phase===oi||this.phase===Ui&&this.channel.canCreateRequest(mr);if(r){if(this.commonMethods.length&&!this.commonMethods.includes(e)||(this._verifier=this.createVerifier(e,null,t),!this._verifier))throw Qu();this._chosenMethod=e}}return this._verifier}startVerification(e){var t=this;return R(function*(){var r=t.beginKeyVerification(e);return r.verify(),r})()}scanQRCode(e){throw new Error("QR code scanning not supported by legacy crypto")}sendRequest(){var e=this;return R(function*(){if(!e.observeOnly&&e._phase===Ui){var t=[...e.verificationMethods.keys()];yield e.channel.send(mt,{methods:t})}})()}cancel(){var e=arguments,t=this;return R(function*(){var{reason:r="User declined",code:n="m.user"}=e.length>0&&e[0]!==void 0?e[0]:{};if(!t.observeOnly&&t._phase!==mu){if(t._declining=!0,t.emit(Ts.Change),t._verifier)return t._verifier.cancel(Qi(n,r)());t._cancellingUserId=t.client.getUserId(),yield t.channel.send(Yn,{code:n,reason:r})}})()}accept(){var e=this;return R(function*(){if(!e.observeOnly&&e.phase===Fn&&!e.initiatedByMe){var t=[...e.verificationMethods.keys()];e._accepting=!0,e.emit(Ts.Change),yield e.channel.send(Hn,{methods:t})}})()}waitFor(e){return new Promise((t,r)=>{var n=()=>{var s=!1;return e(this)?(t(this),s=!0):this.cancelled&&(r(new Error("cancelled")),s=!0),s&&this.off(Ts.Change,n),s};n()||this.on(Ts.Change,n)})}setPhase(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;this._phase=e,t&&this.emit(Ts.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){var e=[{phase:Ui}],t=()=>e[e.length-1].phase,r=this.eventsByThem.has(mt),n=this.getEventBy(mt,r);n&&e.push({phase:Fn,event:n});var s=n&&this.getEventBy(Hn,!r);s&&t()===Fn&&e.push({phase:oi,event:s});var l;if(s||!n){var c=this.eventsByThem.get(mr),d=this.eventsByUs.get(mr);c&&d?l=c.getSender()<d.getSender()?c:d:l=c||d}else l=this.getEventBy(mr,!r);if(l){var h=t()===Fn&&(n==null?void 0:n.getSender())!==l.getSender(),v=t()===Ui&&this.channel.canCreateRequest(mr);(h||t()===oi||v)&&e.push({phase:Fi,event:l})}var p=this.eventsByUs.get(xM);(this.verifierHasFinished||p&&t()===Fi)&&e.push({phase:yu});var m=this.getEventByEither(Yn);return(this._cancelled||m)&&t()!==yu&&e.push({phase:mu,event:m}),e}transitionToPhase(e){var{phase:t,event:r}=e;if((t===Fn||t===oi)&&!this.wasSentByOwnDevice(r)){var n=r.getContent();this.commonMethods=n.methods.filter(l=>this.verificationMethods.has(l))}if(this.observeOnly||(t===Fn||t===Fi||t===oi)&&this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(r)&&!this.wasSentByOwnDevice(r)&&(this._observeOnly=!0),t===Fi){var{method:s}=r.getContent();!this._verifier&&!this.observeOnly&&(this._verifier=this.createVerifier(s,r),this._verifier?this._chosenMethod=s:this.cancel({code:"m.unknown_method",reason:"Unknown method: ".concat(s)}))}}applyPhaseTransitions(){var e=this.calculatePhaseTransitions(),t=e.findIndex(s=>s.phase===this.phase),r=e.slice(t+1);for(var n of r)this.transitionToPhase(n);return r}isWinningStartRace(e){if(e.getType()!==mr)return!1;var t=this._verifier.startEvent,r;if(this.isSelfVerification)if(t){var n=t.getContent();r=n&&n.from_device}else r=this.client.getDeviceId();else t?r=t.getSender():r=this.client.getUserId();var s;if(this.isSelfVerification){var l=e.getContent();s=l&&l.from_device}else s=e.getSender();return s<r}hasEventId(e){for(var t of this.eventsByUs.values())if(t.getId()===e)return!0;for(var r of this.eventsByThem.values())if(r.getId()===e)return!0;return!1}handleEvent(e,t,r,n,s){var l=this;return R(function*(){if(!(l.done||l.cancelled)){var c=l._observeOnly;if(l.adjustObserveOnly(t,r),!(!l.observeOnly&&!n&&(yield l.cancelOnError(e,t)))){var d=s?l.eventsByUs.has(e):l.eventsByThem.has(e);if(!d){var h=l.phase;l.addEvent(e,t,s);var v=l.applyPhaseTransitions();try{if(l._verifier&&!l.observeOnly){var p=l.isWinningStartRace(t);if(l._verifier.canSwitchStartEvent(t)&&p)l._verifier.switchStartEvent(t);else if(!n){var m;(e===Yn||(m=l._verifier.events)!==null&&m!==void 0&&m.includes(e))&&l._verifier.handleEvent(t)}}if(v.length){if(r&&v.some(M=>M.phase===oi)){var _=l.otherPartySupportsMethod(ER,!0);_&&(l._qrCodeData=yield Ma.create(l,l.client))}var b=v[v.length-1],{phase:E}=b;l.setupTimeout(E),l.setPhase(E)}else l._observeOnly!==c&&l.emit(Ts.Change)}finally{T.log("Verification request ".concat(l.channel.transactionId,": ")+"".concat(e," event with id:").concat(t.getId(),", ")+"content:".concat(JSON.stringify(t.getContent())," ")+"deviceId:".concat(l.channel.deviceId,", ")+"sender:".concat(t.getSender(),", isSentByUs:").concat(s,", ")+"isLiveEvent:".concat(r,", isRemoteEcho:").concat(n,", ")+"phase:".concat(h,"=>").concat(l.phase,", ")+"observeOnly:".concat(c,"=>").concat(l._observeOnly))}}}}})()}setupTimeout(e){var t=!this.timeoutTimer&&!this.observeOnly&&e===Fn;if(t&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){var r=e===Fi||e===oi||e===yu||e===mu;r&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}cancelOnError(e,t){var r=this;return R(function*(){if(e===mr){var n=t.getContent().method;if(!r.verificationMethods.has(n))return yield r.cancel(Lp(Qu())),!0}var s=e===mt&&r.phase!==Ui,l=e===Hn&&r.phase!==Fn&&r.phase!==Fi;if(r.phase!==Ui&&(s||l)){T.warn("Cancelling, unexpected ".concat(e," verification ")+"event from ".concat(t.getSender()));var c="Unexpected ".concat(e," event in phase ").concat(r.phase);return yield r.cancel(Lp(_R({reason:c}))),!0}return!1})()}adjustObserveOnly(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t||(this._observeOnly=!0),this.calculateEventTimeout(e)<LM&&(this._observeOnly=!0)}addEvent(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(r?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===mt){for(var[n,s]of this.eventsByThem.entries())s.getSender()!==this.otherUserId&&this.eventsByThem.delete(n);this.requestReceivedAt=Date.now()}}createVerifier(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;r||(r=this.targetDevice);var{userId:n,deviceId:s}=r,l=this.verificationMethods.get(e);if(!l){T.warn("could not find verifier constructor for method",e);return}return new l(this.channel,this.client,n,s,t,this)}wasSentByOwnUser(e){return(e==null?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;var t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;var e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send($.KeyVerificationDone,{}),this.verifierHasFinished=!0;var e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}var V0=$.RoomMessage,G0="m.reference",H0="m.relates_to";class Nr{constructor(e,t,r){this.client=e,this.roomId=t,this.userId=r,y(this,"requestEventId",void 0)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){var r=Nr.getEventType(e);if(r===mt){var n=t.getUserId(),s=e.getSender(),l=e.getContent(),c=l.to;if(s===n)return c;if(c===n)return s}}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===mt}canCreateRequest(e){return Nr.canCreateRequest(e)}static getTransactionId(e){if(Nr.getEventType(e)===mt)return e.getId();var t=e.getRelation();if((t==null?void 0:t.rel_type)===G0)return t.event_id}static validateEvent(e,t){var r=Nr.getTransactionId(e);if(typeof r!="string"||r.length===0)return!1;var n=Nr.getEventType(e),s=e.getContent();if(n===mt){if(!s||typeof s.to!="string"||!s.to.length)return T.log("InRoomChannel: validateEvent: no valid to "+s.to),!1;if(!Nr.getOtherPartyUserId(e,t))return T.log("InRoomChannel: validateEvent: "+"not directed to or sent by me: ".concat(e.getSender())+", ".concat(s.to)),!1}return Cs.validateEvent(n,e,t)}static getEventType(e){var t=e.getType();if(t===V0){var r=e.getContent();if(r){var{msgtype:n}=r;if(n===mt)return mt}}return t&&t!==mt?t:""}handleEvent(e,t){var r=arguments,n=this;return R(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!1;if(!t.hasEventId(e.getId())){var l=Nr.getEventType(e);if(e.getRoomId()===n.roomId){if(!n.userId){var c=Nr.getOtherPartyUserId(e,n.client);c&&(n.userId=c)}var d=n.client.getUserId(),h=e.getSender();if(n.userId&&h!==d&&h!==n.userId){T.log("InRoomChannel: ignoring verification event from non-participating sender ".concat(h));return}n.requestEventId||(n.requestEventId=Nr.getTransactionId(e));var v=!!e.getTxnId(),p=!!e.getUnsigned().transaction_id,m=e.getSender()===n.client.getUserId();return t.handleEvent(l,e,s,v||p,m)}}})()}completedContentFromEvent(e){var t=Object.assign({},e.getContent());return t[H0]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),(e===mt||e===Hn||e===mr)&&(t.from_device=this.client.getDeviceId()),e===mt?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:mt,to:this.userId,from_device:t.from_device,methods:t.methods}:t[H0]={rel_type:G0,event_id:this.transactionId},t}send(e,t){var r=this.completeContent(e,t);return this.sendCompleted(e,r)}sendCompleted(e,t){var r=this;return R(function*(){var n=e;e===mt&&(n=V0);var s=yield r.client.sendEvent(r.roomId,n,t);e===mt&&(r.requestEventId=s.event_id)})()}}class BM{constructor(){y(this,"requestsByRoomId",new Map)}getRequest(e){var t=e.getRoomId(),r=Nr.getTransactionId(e);return this.getRequestByTxnId(t,r)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){var r=this.requestsByRoomId.get(e);if(r)return r.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),Nr.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,r){var n=this.requestsByRoomId.get(e);n||(n=new Map,this.requestsByRoomId.set(e,n)),n.set(t,r)}removeRequest(e){var t=e.getRoomId(),r=this.requestsByRoomId.get(t);r&&(r.delete(Nr.getTransactionId(e)),r.size===0&&this.requestsByRoomId.delete(t))}findRequestInProgress(e,t){var r=this.requestsByRoomId.get(e);if(r){for(var n of r.values())if(n.pending&&(t===void 0||n.requestingUserId===t))return n}}}class Mr{constructor(e,t,r,n,s){this.client=e,this.userId=t,this.devices=r,this.transactionId=n,this.deviceId=s,y(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(var t of e)if(!this.devices.includes(t))return!1;return!0}else return!1}static getEventType(e){return e.getType()}static getTransactionId(e){var t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===mt||e===mr}canCreateRequest(e){return Mr.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return T.warn("Ignoring flagged verification request from "+e.getSender()),!1;var r=e.getContent();if(!r)return T.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!r.transaction_id)return T.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;var n=e.getType();if(n===mt){if(!Number.isFinite(r.timestamp))return T.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&r.from_device==t.getDeviceId())return T.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return Cs.validateEvent(n,e,t)}getTimestamp(e){var t=e.getContent();return t&&t.timestamp}handleEvent(e,t){var r=arguments,n=this;return R(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!1,l=e.getType(),c=e.getContent();if(l===mt||l===Hn||l===mr){n.transactionId||(n.transactionId=c.transaction_id);var d=c.from_device;if(!n.deviceId&&n.devices.includes(d)&&(n.deviceId=d),!n.deviceId||n.deviceId!==d){var h=n.completeContent(Yn,Lp(_R()));return n.sendToDevices(Yn,h,[d])}}var v=t.phase===Fi||t.phase===oi;yield t.handleEvent(e.getType(),e,s,!1,!1);var p=t.phase===Fi||t.phase===oi,m=l===mr||l===Hn;if(m&&!v&&p&&n.deviceId){var _=n.devices.filter(E=>E!==n.deviceId&&E!==n.client.getDeviceId());if(_.length){var b=n.completeContent(Yn,{code:"m.accepted",reason:"Verification request accepted by another device"});yield n.sendToDevices(Yn,b,_)}}})()}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),(e===mt||e===Hn||e===mr)&&(t.from_device=this.client.getDeviceId()),e===mt&&(t.timestamp=Date.now()),t}send(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};(e===mt||e===mr)&&!this.transactionId&&(this.transactionId=Mr.makeTransactionId());var r=this.completeContent(e,t);return this.sendCompleted(e,r)}sendCompleted(e,t){var r=this;return R(function*(){var n;e===mt||e===Yn&&!r.deviceId?n=yield r.sendToDevices(e,t,r.devices):n=yield r.sendToDevices(e,t,[r.deviceId]);var s=new _r({sender:r.client.getUserId(),content:t,type:e});return yield r.request.handleEvent(e,s,!0,!0,!0),n})()}sendToDevices(e,t,r){var n=this;return R(function*(){if(r.length){var s=new Map;for(var l of r)s.set(l,t);yield n.client.sendToDevice(e,new Map([[n.userId,s]]))}})()}static makeTransactionId(){return Qn(32)}}class KM{constructor(){y(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),Mr.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){var r=this.requestsByUserId.get(e);if(r)return r.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),Mr.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,r){var n=this.requestsByUserId.get(e);n||(n=new Map,this.requestsByUserId.set(e,n)),n.set(t,r)}removeRequest(e){var t=e.getSender(),r=this.requestsByUserId.get(t);r&&(r.delete(Mr.getTransactionId(e)),r.size===0&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){var r=this.requestsByUserId.get(e);if(r){for(var n of r.values())if(n.pending&&n.channel.isToDevices(t))return n}}getRequestsInProgress(e){var t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter(r=>r.pending):[]}}class kf extends wm{constructor(){super(...arguments),y(this,"doVerification",R(function*(){throw new Error("Verification is not possible with this method")}))}static factory(e,t,r,n,s,l){return new kf(e,t,r,n,s,l)}static get NAME(){return"org.matrix.illegal_method"}}var lf="org.matrix.msc2697.v1.olm.libolm_pickle",z0=10080*60*1e3;class jM{constructor(e){this.crypto=e,y(this,"inProgress",!1),y(this,"timeoutId",void 0),y(this,"key",void 0),y(this,"keyInfo",void 0),y(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){var e=this;return this.crypto.cryptoStore.doTxn("readonly",[Oe.STORE_ACCOUNT],t=>{this.crypto.cryptoStore.getSecretStorePrivateKey(t,(function(){var r=R(function*(n){if(n){var{key:s,keyInfo:l,deviceDisplayName:c,time:d}=n,h=Buffer.from(e.crypto.olmDevice.pickleKey),v=yield bc(s,h,lf);e.key=Ar(v),e.keyInfo=l,e.deviceDisplayName=c;var p=Date.now(),m=Math.max(1,d+z0-p);e.timeoutId=globalThis.setTimeout(e.dehydrateDevice.bind(e),m)}});return function(n){return r.apply(this,arguments)}})(),"dehydration")})}setKeyAndQueueDehydration(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{},s=t.length>2?t[2]:void 0,l=yield r.setKey(e,n,s);l||r.dehydrateDevice()})()}setKey(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{},s=t.length>2?t[2]:void 0;if(!e){r.timeoutId&&(globalThis.clearTimeout(r.timeoutId),r.timeoutId=void 0),yield r.crypto.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],d=>{r.crypto.cryptoStore.storeSecretStorePrivateKey(d,"dehydration",null)}),r.key=void 0,r.keyInfo=void 0;return}for(var l=!!r.key&&e.length==r.key.length,c=0;l&&c<e.length;c++)e[c]!=r.key[c]&&(l=!1);return l||(r.key=e,r.keyInfo=n,r.deviceDisplayName=s),l})()}dehydrateDevice(){var e=this;return R(function*(){if(e.inProgress){T.log("Dehydration already in progress -- not starting new dehydration");return}e.inProgress=!0,e.timeoutId&&(globalThis.clearTimeout(e.timeoutId),e.timeoutId=void 0);try{var t=Buffer.from(e.crypto.olmDevice.pickleKey),r=yield sl(Kr(e.key),t,lf);yield e.crypto.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],K=>{e.crypto.cryptoStore.storeSecretStorePrivateKey(K,"dehydration",{keyInfo:e.keyInfo,key:r,deviceDisplayName:e.deviceDisplayName,time:Date.now()})}),T.log("Attempting to dehydrate device"),T.log("Creating account");var n=new globalThis.Olm.Account;n.create();var s=JSON.parse(n.identity_keys()),l=n.max_number_of_one_time_keys();n.generate_one_time_keys(l/2),n.generate_fallback_key();var c=JSON.parse(n.one_time_keys()),d=JSON.parse(n.fallback_key());n.mark_keys_as_published();var h=n.pickle(new Uint8Array(e.key)),v={algorithm:lf,account:h};e.keyInfo.passphrase&&(v.passphrase=e.keyInfo.passphrase),T.log("Uploading account to server");var p=yield e.crypto.baseApis.http.authedRequest(se.Put,"/dehydrated_device",void 0,{device_data:v,initial_device_display_name:e.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"}),m=p.device_id;T.log("Preparing device keys",m);var _={algorithms:e.crypto.supportedAlgorithms,device_id:m,user_id:e.crypto.userId,keys:{["ed25519:".concat(m)]:s.ed25519,["curve25519:".concat(m)]:s.curve25519}},b=n.sign(Yi.stringify(_));_.signatures={[e.crypto.userId]:{["ed25519:".concat(m)]:b}},e.crypto.crossSigningInfo.getId("self_signing")&&(yield e.crypto.crossSigningInfo.signObject(_,"self_signing")),T.log("Preparing one-time keys");var E={};for(var[M,O]of Object.entries(c.curve25519)){var C={key:O},U=n.sign(Yi.stringify(C));C.signatures={[e.crypto.userId]:{["ed25519:".concat(m)]:U}},E["signed_curve25519:".concat(M)]=C}T.log("Preparing fallback keys");var I={};for(var[D,w]of Object.entries(d.curve25519)){var N={key:w,fallback:!0},A=n.sign(Yi.stringify(N));N.signatures={[e.crypto.userId]:{["ed25519:".concat(m)]:A}},I["signed_curve25519:".concat(D)]=N}return T.log("Uploading keys to server"),yield e.crypto.baseApis.http.authedRequest(se.Post,"/keys/upload/"+encodeURI(m),void 0,{device_keys:_,one_time_keys:E,"org.matrix.msc2732.fallback_keys":I}),T.log("Done dehydrating"),e.timeoutId=globalThis.setTimeout(e.dehydrateDevice.bind(e),z0),m}finally{e.inProgress=!1}})()}stop(){this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}var FM=200,qM=5e3;class As{constructor(e,t){this.baseApis=e,this.getKey=t,y(this,"algorithm",void 0),y(this,"backupInfo",void 0),y(this,"checkedForBackup",void 0),y(this,"sendingBackups",void 0),y(this,"sessionLastCheckAttemptedTime",{}),y(this,"clientRunning",!0),this.checkedForBackup=!1,this.sendingBackups=!1}stop(){this.clientRunning=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){var t=Bg[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if(typeof e.auth_data!="object")throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){var r=Bg[e.algorithm];if(!r)throw new Error("Unknown backup algorithm");return r.init(e.auth_data,t)}enableKeyBackup(e){var t=this;return R(function*(){t.backupInfo=e,t.algorithm&&t.algorithm.free(),t.algorithm=yield As.makeAlgorithm(e,t.getKey),t.baseApis.emit(at.KeyBackupStatus,!0),t.scheduleKeyBackupSend()})()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(at.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?!!this.algorithm:null}prepareKeyBackupVersion(e,t){return R(function*(){var r=t?Bg[t]:HM;if(!r)throw new Error("Unknown backup algorithm");var[n,s]=yield r.prepare(e),l=If(n);return{algorithm:r.algorithmName,auth_data:s,recovery_key:l,privateKey:n}})()}createKeyBackupVersion(e){var t=this;return R(function*(){t.algorithm=yield As.makeAlgorithm(e,t.getKey)})()}deleteAllKeyBackupVersions(){var e=this;return R(function*(){for(var t,r,n=(t=(r=yield e.baseApis.getKeyBackupVersion())===null||r===void 0?void 0:r.version)!==null&&t!==void 0?t:null;n!=null;){var s,l;yield e.deleteKeyBackupVersion(n),e.disableKeyBackup(),n=(s=(l=yield e.baseApis.getKeyBackupVersion())===null||l===void 0?void 0:l.version)!==null&&s!==void 0?s:null}})()}deleteKeyBackupVersion(e){var t=this;return R(function*(){var r=Ie("/room_keys/version/$version",{$version:e});yield t.baseApis.http.authedRequest(se.Delete,r,void 0,void 0,{prefix:qt.V3})})()}checkAndStart(){var e=this;return R(function*(){if(T.log("Checking key backup status..."),e.baseApis.isGuest())return T.log("Skipping key backup check since user is guest"),e.checkedForBackup=!0,null;var t;try{var r;t=(r=yield e.baseApis.getKeyBackupVersion())!==null&&r!==void 0?r:void 0}catch(s){return T.log("Error checking for active key backup",s),s.httpStatus===404&&(e.checkedForBackup=!0),null}e.checkedForBackup=!0;var n=yield e.isKeyBackupTrusted(t);return n.usable&&!e.backupInfo?(T.log("Found usable key backup v".concat(t.version,": enabling key backups")),yield e.enableKeyBackup(t)):!n.usable&&e.backupInfo?(T.log("No usable key backup: disabling key backup"),e.disableKeyBackup()):!n.usable&&!e.backupInfo?T.log("No usable key backup: not enabling key backup"):n.usable&&e.backupInfo&&(t.version!==e.backupInfo.version?(T.log("On backup version ".concat(e.backupInfo.version," but ")+"found version ".concat(t.version,": switching.")),e.disableKeyBackup(),yield e.enableKeyBackup(t),yield e.scheduleAllGroupSessionsForBackup()):T.log("Backup version ".concat(t.version," still current"))),{backupInfo:t,trustInfo:n}})()}checkKeyBackup(){var e=this;return R(function*(){return e.checkedForBackup=!1,e.checkAndStart()})()}queryKeyBackupRateLimited(e,t){var r=this;return R(function*(){if(r.backupInfo){var n=new Date().getTime();(!r.sessionLastCheckAttemptedTime[t]||n-r.sessionLastCheckAttemptedTime[t]>qM)&&(r.sessionLastCheckAttemptedTime[t]=n,yield r.baseApis.restoreKeyBackupWithCache(e,t,r.backupInfo,{}))}})()}isKeyBackupTrusted(e){var t=this;return R(function*(){var r={usable:!1,trusted_locally:!1,sigs:[]};if(!e||!e.algorithm||!e.auth_data||!e.auth_data.signatures)return T.info("Key backup is absent or missing required data: ".concat(JSON.stringify(e))),r;var n=t.baseApis.getUserId(),s=yield t.baseApis.crypto.getSessionBackupPrivateKey();if(s){var l=null;try{l=yield As.makeAlgorithm(e,R(function*(){return s})),(yield l.keyMatches(s))&&(T.info("Backup is trusted locally"),r.trusted_locally=!0)}catch{}finally{var c;(c=l)===null||c===void 0||c.free()}}var d=e.auth_data.signatures[n]||{};for(var h of Object.keys(d)){var v=h.split(":");if(v[0]!=="ed25519"){T.log("Ignoring unknown signature type: "+v[0]);continue}var p={deviceId:v[1]},m=t.baseApis.crypto.crossSigningInfo.getId();if(m===p.deviceId){p.crossSigningId=!0;try{yield Jo(t.baseApis.crypto.olmDevice,e.auth_data,n,p.deviceId,m),p.valid=!0}catch(b){T.warn("Bad signature from cross signing key "+m,b),p.valid=!1}r.sigs.push(p);continue}var _=t.baseApis.crypto.deviceList.getStoredDevice(n,p.deviceId);if(_){p.device=_,p.deviceTrust=t.baseApis.checkDeviceTrust(n,p.deviceId);try{yield Jo(t.baseApis.crypto.olmDevice,e.auth_data,n,_.deviceId,_.getFingerprint()),p.valid=!0}catch(b){T.info("Bad signature from key ID "+h+" userID "+t.baseApis.getUserId()+" device ID "+_.deviceId+" fingerprint: "+_.getFingerprint(),e.auth_data,b),p.valid=!1}}else p.valid=null,T.info("Ignoring signature from unknown key "+h);r.sigs.push(p)}return r.usable=r.sigs.some(b=>{var E;return b.valid&&(b.device&&((E=b.deviceTrust)===null||E===void 0?void 0:E.isVerified())||b.crossSigningId)}),r})()}scheduleKeyBackupSend(){var e=arguments,t=this;return R(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:1e4;if(T.debug("Key backup: scheduleKeyBackupSend currentSending:".concat(t.sendingBackups," delay:").concat(r)),!t.sendingBackups){t.sendingBackups=!0;try{var n=Math.random()*r;if(yield Ba(n),!t.clientRunning){t.sendingBackups=!1;return}for(var s=0;;){if(!t.algorithm)return;try{var l=yield t.backupPendingKeys(FM);if(l===0){t.sendingBackups=!1;return}s=0}catch(d){if(s++,T.log("Key backup request failed",d),d instanceof hr){var c=d.data.errcode;if(c=="M_NOT_FOUND"||c=="M_WRONG_ROOM_KEYS_VERSION"){t.sendingBackups=!1,t.baseApis.crypto.emit(at.KeyBackupFailed,c),yield t.checkKeyBackup();return}}}if(s&&(yield Ba(1e3*Math.pow(2,Math.min(s-1,4)))),!t.clientRunning){T.debug("Key backup send loop aborted, client stopped"),t.sendingBackups=!1;return}}}catch(d){T.log("Backup loop failed ".concat(d)),t.sendingBackups=!1}}})()}backupPendingKeys(e){var t=this;return R(function*(){var r=yield t.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!r.length)return 0;var n=yield t.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();t.baseApis.crypto.emit(at.KeyBackupSessionsRemaining,n);var s={};for(var l of r){var c,d=l.sessionData.room_id;fi(s,d,s[d]||{sessions:{}});var h=t.baseApis.crypto.olmDevice.exportInboundGroupSession(l.senderKey,l.sessionId,l.sessionData);h.algorithm=Zr;var v=(h.forwarding_curve25519_key_chain||[]).length,p=t.baseApis.crypto.deviceList.getUserByIdentityKey(Zr,l.senderKey),m=(c=t.baseApis.crypto.deviceList.getDeviceByIdentityKey(Zr,l.senderKey))!==null&&c!==void 0?c:void 0,_=t.baseApis.crypto.checkDeviceInfoTrust(p,m).isVerified();fi(s[d].sessions,l.sessionId,{first_message_index:h.first_known_index,forwarded_count:v,is_verified:_,session_data:yield t.algorithm.encryptSession(h)})}return yield t.baseApis.sendKeyBackup(void 0,void 0,t.backupInfo.version,{rooms:s}),yield t.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(r),n=yield t.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),t.baseApis.crypto.emit(at.KeyBackupSessionsRemaining,n),r.length})()}backupGroupSession(e,t){var r=this;return R(function*(){yield r.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),r.backupInfo&&r.scheduleKeyBackupSend()})()}scheduleAllGroupSessionsForBackup(){var e=this;return R(function*(){yield e.flagAllGroupSessionsForBackup(),e.scheduleKeyBackupSend(0)})()}flagAllGroupSessionsForBackup(){var e=this;return R(function*(){yield e.baseApis.crypto.cryptoStore.doTxn("readwrite",[Oe.STORE_INBOUND_GROUP_SESSIONS,Oe.STORE_BACKUP],r=>{e.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(r,n=>{n!==null&&e.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([n],r)})});var t=yield e.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return e.baseApis.emit(at.KeyBackupSessionsRemaining,t),t})()}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class Xo{constructor(e,t,r){this.authData=e,this.publicKey=t,this.getKey=r}static init(e,t){return R(function*(){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");var r=new globalThis.Olm.PkEncryption;return r.set_recipient_key(e.public_key),new Xo(e,r,t)})()}static prepare(e){return R(function*(){var t=new globalThis.Olm.PkDecryption;try{var r={};if(!e)r.public_key=t.generate_key();else if(e instanceof Uint8Array)r.public_key=t.init_with_private_key(e);else{var n=yield Cm(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,r.public_key=t.init_with_private_key(n.key)}var s=new globalThis.Olm.PkEncryption;return s.set_recipient_key(r.public_key),[t.get_private_key(),r]}finally{t.free()}})()}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}encryptSession(e){var t=this;return R(function*(){var r=Object.assign({},e);return delete r.session_id,delete r.room_id,delete r.first_known_index,t.publicKey.encrypt(JSON.stringify(r))})()}decryptSessions(e){var t=this;return R(function*(){var r=yield t.getKey(),n=new globalThis.Olm.PkDecryption;try{var s=n.init_with_private_key(r);if(s!==t.authData.public_key)throw new hr({errcode:ll.RESTORE_BACKUP_ERROR_BAD_KEY});var l=[];for(var[c,d]of Object.entries(e))try{var h=JSON.parse(n.decrypt(d.session_data.ephemeral,d.session_data.mac,d.session_data.ciphertext));h.session_id=c,l.push(h)}catch(v){T.log("Failed to decrypt megolm session from backup",v,d)}return l}finally{n.free()}})()}keyMatches(e){var t=this;return R(function*(){var r=new globalThis.Olm.PkDecryption,n;try{n=r.init_with_private_key(e)}finally{r.free()}return n===t.authData.public_key})()}free(){this.publicKey.free()}}y(Xo,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");function VM(a){var e=new Uint8Array(a);return globalThis.crypto.getRandomValues(e),e}var GM=new Wt("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class oc{constructor(e,t){this.authData=e,this.key=t}static init(e,t){return R(function*(){if(!e)throw new Error("auth_data missing");var r=yield t();if(e.mac){var{mac:n}=yield ks(r,e.iv);if(e.mac.replace(/=+$/g,"")!==n.replace(/=+/g,""))throw new Error("Key does not match")}return new oc(e,r)})()}static prepare(e){return R(function*(){var t,r={};if(!e)t=VM(32);else if(e instanceof Uint8Array)t=new Uint8Array(e);else{var n=yield Cm(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,t=n.key}var{iv:s,mac:l}=yield ks(t);return r.iv=s,r.mac=l,[t,r]})()}static checkBackupVersion(e){if(!("iv"in e.auth_data&&"mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){var t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,sl(JSON.stringify(t),this.key,e.session_id)}decryptSessions(e){var t=this;return R(function*(){var r=[];for(var[n,s]of Object.entries(e))try{var l=JSON.parse(yield bc(s.session_data,t.key,n));l.session_id=n,r.push(l)}catch(c){T.log("Failed to decrypt megolm session from backup",c,s)}return r})()}keyMatches(e){var t=this;return R(function*(){if(t.authData.mac){var{mac:r}=yield ks(e,t.authData.iv);return t.authData.mac.replace(/=+$/g,"")===r.replace(/=+/g,"")}else return!0})()}free(){this.key.fill(0)}}y(oc,"algorithmName",GM.name);var Bg={[Xo.algorithmName]:Xo,[oc.algorithmName]:oc},HM=Xo;function W0(a){var e;return{trusted:a.usable,matchesDecryptionKey:(e=a.trusted_locally)!==null&&e!==void 0?e:!1}}class zM{constructor(e){y(this,"algorithm",void 0),y(this,"sourceTrusted",void 0),this.algorithm=e,this.sourceTrusted=!e.untrusted}free(){this.algorithm.free()}decryptSessions(e){var t=this;return R(function*(){return yield t.algorithm.decryptSessions(e)})()}}class WM{constructor(e){this.cryptoStore=e,y(this,"roomEncryption",{})}init(){var e=this;return R(function*(){yield e.cryptoStore.doTxn("readwrite",[Oe.STORE_ROOMS],t=>{e.cryptoStore.getEndToEndRooms(t,r=>{e.roomEncryption=r})})})()}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return!!this.getRoomEncryption(e)}setRoomEncryption(e,t){var r=this;return R(function*(){r.roomEncryption[e]=t,yield r.cryptoStore.doTxn("readwrite",[Oe.STORE_ROOMS],n=>{r.cryptoStore.storeEndToEndRoom(e,t,n)})})()}}function Y0(a,e){var t=new Map(Object.entries(a.keys)),r=a.getDisplayName()||void 0,n=new Map;if(a.signatures)for(var s in a.signatures)n.set(s,new Map(Object.entries(a.signatures[s])));return new nR({deviceId:a.deviceId,userId:e,keys:t,algorithms:a.algorithms,verified:a.verified,signatures:n,displayName:r})}function J0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function YM(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?J0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):J0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var Pi=qr.DeviceVerification,Kg={[sc.NAME]:sc,[Qo.NAME]:Qo,[mM]:kf,[ER]:kf};sc.NAME,Qo.NAME;function wR(){return!!globalThis.Olm}var JM=3600*1e3,QM=300*1e3,at=(function(a){return a.DeviceVerificationChanged="deviceVerificationChanged",a[a.UserTrustStatusChanged=tr.UserTrustStatusChanged]="UserTrustStatusChanged",a.UserCrossSigningUpdated="userCrossSigningUpdated",a.RoomKeyRequest="crypto.roomKeyRequest",a.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",a[a.KeyBackupStatus=tr.KeyBackupStatus]="KeyBackupStatus",a[a.KeyBackupFailed=tr.KeyBackupFailed]="KeyBackupFailed",a[a.KeyBackupSessionsRemaining=tr.KeyBackupSessionsRemaining]="KeyBackupSessionsRemaining",a[a.KeyBackupDecryptionKeyCached=tr.KeyBackupDecryptionKeyCached]="KeyBackupDecryptionKeyCached",a.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",a.VerificationRequest="crypto.verification.request",a[a.VerificationRequestReceived=tr.VerificationRequestReceived]="VerificationRequestReceived",a.Warning="crypto.warning",a[a.WillUpdateDevices=tr.WillUpdateDevices]="WillUpdateDevices",a[a.DevicesUpdated=tr.DevicesUpdated]="DevicesUpdated",a[a.KeysChanged=tr.KeysChanged]="KeysChanged",a[a.LegacyCryptoStoreMigrationProgress=tr.LegacyCryptoStoreMigrationProgress]="LegacyCryptoStoreMigrationProgress",a})({});class Af extends Pt{static getOlmVersion(){return A0.getOlmVersion()}constructor(e,t,r,n,s,l){var c;if(super(),c=this,this.baseApis=e,this.userId=t,this.deviceId=r,this.clientStore=n,this.cryptoStore=s,y(this,"backupManager",void 0),y(this,"crossSigningInfo",void 0),y(this,"olmDevice",void 0),y(this,"deviceList",void 0),y(this,"dehydrationManager",void 0),y(this,"secretStorage",void 0),y(this,"roomList",void 0),y(this,"reEmitter",void 0),y(this,"verificationMethods",void 0),y(this,"supportedAlgorithms",void 0),y(this,"outgoingRoomKeyRequestManager",void 0),y(this,"toDeviceVerificationRequests",void 0),y(this,"inRoomVerificationRequests",void 0),y(this,"trustCrossSignedDevices",!0),y(this,"lastOneTimeKeyCheck",null),y(this,"oneTimeKeyCheckInProgress",!1),y(this,"roomEncryptors",new Map),y(this,"roomDecryptors",new Map),y(this,"deviceKeys",{}),y(this,"globalBlacklistUnverifiedDevices",!1),y(this,"globalErrorOnUnknownDevices",!0),y(this,"receivedRoomKeyRequests",[]),y(this,"receivedRoomKeyRequestCancellations",[]),y(this,"processingRoomKeyRequests",!1),y(this,"lazyLoadMembers",!1),y(this,"roomDeviceTrackingState",{}),y(this,"forceNewSessionRetryTime",new Xt(()=>new Xt(()=>0))),y(this,"sendKeyRequestsImmediately",!1),y(this,"oneTimeKeyCount",void 0),y(this,"needsNewFallback",void 0),y(this,"fallbackCleanup",void 0),y(this,"onDeviceListUserCrossSigningUpdated",(function(){var p=R(function*(m){if(m===c.userId){var _=c.deviceList.getStoredCrossSigningForUser(m),b=_?_.getId():null,E=c.crossSigningInfo.getId(),M=E!==b;E&&b&&!M?yield c.checkOwnCrossSigningTrust():(c.storeTrustedSelfKeys(null),c.emit(at.KeysChanged,{}),c.emit(at.UserTrustStatusChanged,c.userId,c.checkUserTrust(m)))}else{yield c.checkDeviceVerifications(m);var O=c.deviceList.getStoredCrossSigningForUser(m);O&&(O.updateCrossSigningVerifiedBefore(c.checkUserTrust(m).isCrossSigningVerified()),c.deviceList.setRawStoredCrossSigningForUser(m,O.toStorage())),c.emit(at.UserTrustStatusChanged,m,c.checkUserTrust(m))}});return function(m){return p.apply(this,arguments)}})()),y(this,"onMembership",(p,m,_)=>{try{this.onRoomMembership(p,m,_)}catch(b){T.error("Error handling membership change:",b)}}),y(this,"onToDeviceEvent",p=>{try{T.log("received to-device ".concat(p.getType()," from: ")+"".concat(p.getSender()," id: ").concat(p.getContent()[Fr])),p.getType()=="m.room_key"||p.getType()=="m.forwarded_room_key"?this.onRoomKeyEvent(p):p.getType()=="m.room_key_request"?this.onRoomKeyRequestEvent(p):p.getType()==="m.secret.request"?this.secretStorage.onRequestReceived(p):p.getType()==="m.secret.send"?this.secretStorage.onSecretReceived(p):p.getType()==="m.room_key.withheld"?this.onRoomKeyWithheldEvent(p):p.getContent().transaction_id?this.onKeyVerificationMessage(p):p.getContent().msgtype==="m.bad.encrypted"?this.onToDeviceBadEncrypted(p):(p.isBeingDecrypted()||p.shouldAttemptDecryption())&&(p.isBeingDecrypted()||p.attemptDecryption(this),p.once(ct.Decrypted,m=>{this.onToDeviceEvent(m)}))}catch(m){T.error("Error handling toDeviceEvent:",m)}}),y(this,"onTimelineEvent",function(p,m,_,b){var{liveEvent:E=!0}=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};if(Nr.validateEvent(p,c.baseApis)){var M=O=>{var C=new Nr(c.baseApis,O.getRoomId());return new Cs(C,c.verificationMethods,c.baseApis)};c.handleVerificationEvent(p,c.inRoomVerificationRequests,M,E)}}),T.debug("Crypto: initialising roomlist..."),this.roomList=new WM(s),this.reEmitter=new al(this),l){this.verificationMethods=new Map;for(var d of l)typeof d=="string"?Kg[d]&&this.verificationMethods.set(d,Kg[d]):d.NAME?this.verificationMethods.set(d.NAME,d):T.warn("Excluding unknown verification method ".concat(d))}else this.verificationMethods=new Map(Object.entries(Kg));this.backupManager=new As(e,R(function*(){var p=yield c.getSessionBackupPrivateKey();if(p)return p;var m=yield c.secretStorage.get("m.megolm_backup.v1");if(m){var _=uf(m);if(_){var b=yield c.secretStorage.getKey();yield c.secretStorage.store("m.megolm_backup.v1",_,[b[0]])}return Ar(_||m)}if(c.baseApis.cryptoCallbacks&&c.baseApis.cryptoCallbacks.getBackupKey)return c.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new A0(s),this.deviceList=new GD(e,s,this.olmDevice),this.deviceList.on(at.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[at.DevicesUpdated,at.WillUpdateDevices]),this.supportedAlgorithms=Array.from(Up.keys()),this.outgoingRoomKeyRequestManager=new ZD(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new KM,this.inRoomVerificationRequests=new BM;var h=this.baseApis.cryptoCallbacks||{},v=gR(s,this.olmDevice);this.crossSigningInfo=new Wn(t,h,v),this.secretStorage=new fM(e,h,e),this.dehydrationManager=new jM(this),!h.getCrossSigningKey&&h.getSecretStorageKey&&(h.getCrossSigningKey=(function(){var p=R(function*(m){return Wn.getFromSecretStorage(m,c.secretStorage)});return function(m){return p.apply(this,arguments)}})())}init(){var e=arguments,t=this;return R(function*(){var{exportedOlmDevice:r,pickleKey:n}=e.length>0&&e[0]!==void 0?e[0]:{};T.log("Crypto: initialising Olm..."),yield globalThis.Olm.init(),T.log(r?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),yield t.olmDevice.init({fromExportedDevice:r,pickleKey:n}),T.log("Crypto: loading device list..."),yield t.deviceList.load(),t.deviceKeys["ed25519:"+t.deviceId]=t.olmDevice.deviceEd25519Key,t.deviceKeys["curve25519:"+t.deviceId]=t.olmDevice.deviceCurve25519Key,T.log("Crypto: fetching own devices...");var s=t.deviceList.getRawStoredDevicesForUser(t.userId);if(s||(s={}),!s[t.deviceId]){T.log("Crypto: adding this device to the store...");var l={keys:t.deviceKeys,algorithms:t.supportedAlgorithms,verified:Pi.VERIFIED,known:!0};s[t.deviceId]=l,t.deviceList.storeDevicesForUser(t.userId,s),t.deviceList.saveIfDirty()}yield t.cryptoStore.doTxn("readonly",[Oe.STORE_ACCOUNT],c=>{t.cryptoStore.getCrossSigningKeys(c,d=>{d&&Object.keys(d).length!==0&&(T.log("Loaded cross-signing public keys from crypto store"),t.crossSigningInfo.setKeys(d))})}),t.deviceList.startTrackingDeviceList(t.userId),T.debug("Crypto: initialising roomlist..."),yield t.roomList.init(),T.log("Crypto: checking for key backup..."),t.backupManager.checkAndStart()})()}setDeviceIsolationMode(e){throw new Error("Not supported")}getVersion(){var e=Af.getOlmVersion();return"Olm ".concat(e[0],".").concat(e[1],".").concat(e[2])}getTrustCrossSignedDevices(){return this.trustCrossSignedDevices}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(var t of this.deviceList.getKnownUserIds()){var r=this.deviceList.getRawStoredDevicesForUser(t);for(var n of Object.keys(r)){var s=this.checkDeviceTrust(t,n);if(!s.isLocallyVerified()&&s.isCrossSigningVerified()){var l=this.deviceList.getStoredDevice(t,n);this.emit(at.DeviceVerificationChanged,t,n,l)}}}}setCryptoTrustCrossSignedDevices(e){this.setTrustCrossSignedDevices(e)}createRecoveryKeyFromPassphrase(e){return R(function*(){var t=new globalThis.Olm.PkDecryption;try{if(e){var r=yield Cm(e);t.init_with_private_key(r.key);var n=t.get_private_key();return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:r.iterations,salt:r.salt}},privateKey:n,encodedPrivateKey:If(n)}}else{t.generate_key();var s=t.get_private_key();return{privateKey:s,encodedPrivateKey:If(s)}}}finally{t==null||t.free()}})()}userHasCrossSigningKeys(){var e=arguments,t=this;return R(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:t.userId;return yield t.downloadKeys([r]),t.deviceList.getStoredCrossSigningForUser(r)!==null})()}isCrossSigningReady(){var e=this;return R(function*(){var t=e.crossSigningInfo.getId(),r=(yield e.crossSigningInfo.isStoredInKeyCache())||(yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage));return!!(t&&r)})()}isSecretStorageReady(){var e=this;return R(function*(){var t=yield e.secretStorage.hasKey(),r=yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage),n=!e.backupManager.getKeyBackupEnabled()||(yield e.baseApis.isKeyBackupKeyStored());return!!(t&&r&&n)})()}getCrossSigningStatus(){var e=this;return R(function*(){var t,r,n,s=!!e.crossSigningInfo.getId(),l=!!(yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage)),c=e.crossSigningInfo.getCacheCallbacks(),d=!!(yield(t=c.getCrossSigningKeyCache)===null||t===void 0?void 0:t.call(c,"master")),h=!!(yield(r=c.getCrossSigningKeyCache)===null||r===void 0?void 0:r.call(c,"self_signing")),v=!!(yield(n=c.getCrossSigningKeyCache)===null||n===void 0?void 0:n.call(c,"user_signing"));return{publicKeysOnDevice:s,privateKeysInSecretStorage:l,privateKeysCachedLocally:{masterKey:d,selfSigningKey:h,userSigningKey:v}}})()}bootstrapCrossSigning(){var e=arguments,t=this;return R(function*(){var{authUploadDeviceSigningKeys:r,setupNewCrossSigning:n}=e.length>0&&e[0]!==void 0?e[0]:{};T.log("Bootstrapping cross-signing");var s=t.baseApis.cryptoCallbacks,l=new B0(t.baseApis.store.accountData,s),c=new Wn(t.userId,l.crossSigningCallbacks,l.crossSigningCallbacks),d=(function(){var M=R(function*(){c.resetKeys(),yield t.signObject(c.keys.master),l.addCrossSigningKeys(r,c.keys);var O=t.deviceList.getStoredDevice(t.userId,t.deviceId),C=yield c.signDevice(t.userId,O);l.addKeySignature(t.userId,t.deviceId,C),t.backupManager.backupInfo&&(yield c.signObject(t.backupManager.backupInfo.auth_data,"master"),l.addSessionBackup(t.backupManager.backupInfo))});return function(){return M.apply(this,arguments)}})(),h=t.crossSigningInfo.getId(),v=yield t.crossSigningInfo.isStoredInKeyCache(),p=yield t.crossSigningInfo.isStoredInSecretStorage(t.secretStorage),m=v||p;T.log({setupNewCrossSigning:n,publicKeysOnDevice:h,privateKeysInCache:v,privateKeysInStorage:p,privateKeysExistSomewhere:m}),!m||n?(T.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),yield d()):h&&v?T.log("Cross-signing public keys trusted and private keys found locally"):p&&(T.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),yield t.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));var _=l.crossSigningCallbacks.privateKeys;if(_.size&&!t.baseApis.cryptoCallbacks.saveCrossSigningKeys){var b=new ac(l.accountDataClientAdapter,l.ssssCryptoCallbacks);(yield b.hasKey())&&(T.log("Storing new cross-signing private keys in secret storage"),yield Wn.storeInSecretStorage(_,b))}var E=l.buildOperation();yield E.apply(t),yield l.persist(t),T.log("Cross-signing ready")})()}bootstrapSecretStorage(){var e=arguments,t=this;return R(function*(){var{createSecretStorageKey:r=R(function*(){return{}}),keyBackupInfo:n,setupNewKeyBackup:s,setupNewSecretStorage:l,getKeyBackupPassphrase:c}=e.length>0&&e[0]!==void 0?e[0]:{};T.log("Bootstrapping Secure Secret Storage");var d=t.baseApis.cryptoCallbacks,h=new B0(t.baseApis.store.accountData,d),v=new ac(h.accountDataClientAdapter,h.ssssCryptoCallbacks),p=null,m=(function(){var te=R(function*(he){var{keyId:be,keyInfo:De}=yield v.addKey(ci,he);return h.ssssCryptoCallbacks.addPrivateKey(be,De,he.key),yield v.setDefaultKeyId(be),be});return function(be){return te.apply(this,arguments)}})(),_=(function(){var te=R(function*(he,be){if(!be.mac){var De,W,ue=yield(De=(W=t.baseApis.cryptoCallbacks).getSecretStorageKey)===null||De===void 0?void 0:De.call(W,{keys:{[he]:be}},"");if(ue){var we=ue[1];h.ssssCryptoCallbacks.addPrivateKey(he,be,we);var{iv:Z,mac:pe}=yield ks(we);be.iv=Z,be.mac=pe,yield h.setAccountData("m.secret_storage.key.".concat(he),be)}}});return function(be,De){return te.apply(this,arguments)}})(),b=(function(){var te=R(function*(he){if(t.crossSigningInfo.getId()&&(yield t.crossSigningInfo.isStoredInKeyCache("master")))try{T.log("Adding cross-signing signature to key backup"),yield t.crossSigningInfo.signObject(he,"master")}catch(be){T.error("Signing key backup with cross-signing keys failed",be)}else T.warn("Cross-signing keys not available, skipping signature on key backup")});return function(be){return te.apply(this,arguments)}})(),E=yield t.secretStorage.getKey(),[M,O]=E||[null,null],C=!l&&O&&O.algorithm===ci;if(T.log({keyBackupInfo:n,setupNewKeyBackup:s,setupNewSecretStorage:l,storageExists:C,oldKeyInfo:O}),!C&&!n){T.log("Secret storage does not exist, creating new storage key");var{keyInfo:U,privateKey:I}=yield r();p=yield m({passphrase:U==null?void 0:U.passphrase,key:I,name:U==null?void 0:U.name})}else if(!C&&n){T.log("Secret storage does not exist, using key backup key");var D=(yield t.getSessionBackupPrivateKey())||(yield c==null?void 0:c()),w={key:D};n.auth_data.private_key_salt&&n.auth_data.private_key_iterations&&(w.passphrase={algorithm:"m.pbkdf2",iterations:n.auth_data.private_key_iterations,salt:n.auth_data.private_key_salt,bits:256}),p=yield m(w),yield v.store("m.megolm_backup.v1",Kr(D),[p]),yield b(n.auth_data),h.addSessionBackup(n)}else T.log("Secret storage exists"),O&&O.algorithm===ci&&(yield _(M,O));if(!t.baseApis.cryptoCallbacks.saveCrossSigningKeys&&(yield t.isCrossSigningReady())&&(p||!(yield t.crossSigningInfo.isStoredInSecretStorage(v)))){T.log("Copying cross-signing private keys from cache to secret storage");var N=yield t.crossSigningInfo.getCrossSigningKeysFromCache();yield Wn.storeInSecretStorage(N,v)}if(s&&!n){T.log("Creating new message key backup version");var A=yield t.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),K=Yu(A.recovery_key);yield v.store("m.megolm_backup.v1",Kr(K));var z={algorithm:A.algorithm,auth_data:A.auth_data};yield b(z.auth_data),yield t.signObject(z.auth_data),h.addSessionBackup(z)}var de=yield v.get("m.megolm_backup.v1");if(de){T.info("Got session backup key from secret storage: caching");var _e=uf(de);if(_e){var le=p||M;yield v.store("m.megolm_backup.v1",_e,le?[le]:null)}var Ce=new Uint8Array(Ar(_e||de));h.addSessionBackupPrivateKeyToCache(Ce)}else if(t.backupManager.getKeyBackupEnabled()){var V=(yield t.getSessionBackupPrivateKey())||(yield c==null?void 0:c());if(!V){T.error("Key backup is enabled but couldn't get key backup key!");return}T.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),yield v.store("m.megolm_backup.v1",Kr(V))}var B=h.buildOperation();yield B.apply(t),yield h.persist(t),T.log("Secure Secret Storage ready")})()}resetKeyBackup(){var e=this;return R(function*(){yield e.backupManager.deleteAllKeyBackupVersions();var t=yield e.backupManager.prepareKeyBackupVersion();yield e.signObject(t.auth_data);var{version:r}=yield e.baseApis.http.authedRequest(se.Post,"/room_keys/version",void 0,t,{prefix:qt.V3});T.log("Created backup version ".concat(r));var n=t.privateKey;yield e.secretStorage.store("m.megolm_backup.v1",Kr(n)),yield e.storeSessionBackupPrivateKey(n),yield e.backupManager.checkAndStart(),yield e.backupManager.scheduleAllGroupSessionsForBackup()})()}deleteKeyBackupVersion(e){var t=this;return R(function*(){yield t.backupManager.deleteKeyBackupVersion(e)})()}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){var r=null;try{r=new globalThis.Olm.PkDecryption;var n=r.init_with_private_key(e);return n===t}finally{var s;(s=r)===null||s===void 0||s.free()}}getSessionBackupPrivateKey(){var e=this;return R(function*(){var t=yield new Promise(l=>{e.cryptoStore.doTxn("readonly",[Oe.STORE_ACCOUNT],c=>{e.cryptoStore.getSecretStorePrivateKey(c,l,"m.megolm_backup.v1")})}),r=null;if(typeof t=="string"&&(r=new Uint8Array(Ar(uf(t)||t)),yield e.storeSessionBackupPrivateKey(r)),t&&typeof t=="object"&&"ciphertext"in t){var n=Buffer.from(e.olmDevice.pickleKey),s=yield bc(t,n,"m.megolm_backup.v1");r=Ar(s)}return r})()}storeSessionBackupPrivateKey(e,t){var r=this;return R(function*(){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got ".concat(e));var n=Buffer.from(r.olmDevice.pickleKey),s=yield sl(Kr(e),n,"m.megolm_backup.v1");return r.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],l=>{r.cryptoStore.storeSecretStorePrivateKey(l,"m.megolm_backup.v1",s)})})()}loadSessionBackupPrivateKeyFromSecretStorage(){throw new Error("Not implmeented")}getActiveSessionBackupVersion(){var e=this;return R(function*(){if(e.backupManager.getKeyBackupEnabled()){var t;return(t=e.backupManager.version)!==null&&t!==void 0?t:null}return null})()}getKeyBackupInfo(){return R(function*(){throw new Error("Not implemented")})()}isKeyBackupTrusted(e){var t=this;return R(function*(){var r=yield t.backupManager.isKeyBackupTrusted(e);return W0(r)})()}checkKeyBackupAndEnable(){var e=this;return R(function*(){var t=yield e.backupManager.checkKeyBackup();return!t||!t.backupInfo?null:{backupInfo:t.backupInfo,trustInfo:W0(t.trustInfo)}})()}checkCrossSigningPrivateKey(e,t){var r=null;try{r=new globalThis.Olm.PkSigning;var n=r.init_with_seed(e);return n===t}finally{var s;(s=r)===null||s===void 0||s.free()}}afterCrossSigningLocalKeyChange(){var e=this;return R(function*(){T.info("Starting cross-signing key change post-processing");var t=e.deviceList.getStoredDevice(e.userId,e.deviceId),r=yield e.crossSigningInfo.signDevice(e.userId,t);T.info("Starting background key sig upload for ".concat(e.deviceId));var n=m=>{var{shouldEmit:_=!1}=m;return e.baseApis.uploadKeySignatures({[e.userId]:{[e.deviceId]:r}}).then(b=>{var{failures:E}=b||{};if(Object.keys(E||[]).length>0)throw _&&e.baseApis.emit(at.KeySignatureUploadFailure,E,"afterCrossSigningLocalKeyChange",n),new ju("Key upload failed",{failures:E});T.info("Finished background key sig upload for ".concat(e.deviceId))}).catch(b=>{T.error("Error during background key sig upload for ".concat(e.deviceId),b)})};n({shouldEmit:!0});var s=e.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(s){T.info("Starting device verification upgrade");var l={};for(var[c,d]of Object.entries(e.deviceList.crossSigningInfo)){var h=yield e.checkForDeviceVerificationUpgrade(c,Wn.fromStorage(d,c));h&&(l[c]=h)}if(Object.keys(l).length>0){T.info("Found ".concat(Object.keys(l).length," verif users to upgrade"));try{var v=yield s({users:l});if(v)for(var p of v)p in l&&(yield e.baseApis.setDeviceVerified(p,l[p].crossSigningInfo.getId()))}catch(m){T.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",m)}}T.info("Finished device verification upgrade")}T.info("Finished cross-signing key change post-processing")})()}checkForDeviceVerificationUpgrade(e,t){var r=this;return R(function*(){var n=r.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.isVerified()){var s=r.deviceList.getRawStoredDevicesForUser(e),l=yield r.checkForValidDeviceSignature(e,t.keys.master,s);if(l.length)return{devices:l.map(c=>qr.fromStorage(s[c],c)),crossSigningInfo:t}}})()}checkForValidDeviceSignature(e,t,r){var n=this;return R(function*(){var s=[];if(r&&t.signatures&&t.signatures[e])for(var l of Object.keys(t.signatures[e])){var[,c]=l.split(":",2);if(c in r&&r[c].verified===Pi.VERIFIED)try{yield Jo(n.olmDevice,t,e,c,r[c].keys[l]),s.push(c)}catch{}}return s})()}getCrossSigningKeyId(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Tm.Master;return Promise.resolve(this.getCrossSigningId(e))}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){var t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new Ju(!1,!1,!1)}getUserVerificationStatus(e){var t=this;return R(function*(){return t.checkUserTrust(e)})()}pinCurrentUserIdentity(e){return R(function*(){throw new Error("not implemented")})()}getDeviceVerificationStatus(e,t){var r=this;return R(function*(){var n=r.deviceList.getStoredDevice(e,t);return n?r.checkDeviceInfoTrust(e,n):null})()}checkDeviceTrust(e,t){var r=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,r)}checkDeviceInfoTrust(e,t){var r=!!(t!=null&&t.isVerified()),n=this.deviceList.getStoredCrossSigningForUser(e);if(t&&n){var s=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(n,t,r,s)}else return new Ko(!1,!1,r,!1)}checkIfOwnDeviceCrossSigned(e){var t,r=this.deviceList.getStoredDevice(this.userId,e);if(!r)return!1;var n=this.deviceList.getStoredCrossSigningForUser(this.userId);return(t=n==null?void 0:n.checkDeviceTrust(n,r,!1,!0).isCrossSigningVerified())!==null&&t!==void 0?t:!1}checkOwnCrossSigningTrust(){var e=arguments,t=this;return R(function*(){var{allowPrivateKeyRequests:r=!1}=e.length>0&&e[0]!==void 0?e[0]:{},n=t.userId;yield t.downloadKeys([t.userId]);var s=yield t.crossSigningInfo.getCrossSigningKeysFromCache(),l=t.deviceList.getStoredCrossSigningForUser(n);if(!l){T.error("Got cross-signing update event for user "+n+" but no new cross-signing information found!");return}var c=l.getId(),d=t.crossSigningInfo.getId()!==c,h=l.getId()&&!s.has("master");if(d&&T.info("Got new master public key",c),r&&(d||h)){T.info("Attempting to retrieve cross-signing master private key");var v=null;try{var p=yield t.crossSigningInfo.getCrossSigningKey("master",c);v=p[1],T.info("Got cross-signing master private key")}finally{var m;(m=v)===null||m===void 0||m.free()}}var _=t.crossSigningInfo.getId("self_signing"),b=t.crossSigningInfo.getId("user_signing");t.storeTrustedSelfKeys(l.keys);var E=_!==l.getId("self_signing"),M=b!==l.getId("user_signing"),O=l.getId("self_signing")&&!s.has("self_signing"),C=l.getId("user_signing")&&!s.has("user_signing"),U={};if(E&&T.info("Got new self-signing key",l.getId("self_signing")),r&&(E||O)){T.info("Attempting to retrieve cross-signing self-signing private key");var I=null;try{var D=yield t.crossSigningInfo.getCrossSigningKey("self_signing",l.getId("self_signing"));I=D[1],T.info("Got cross-signing self-signing private key")}finally{var w;(w=I)===null||w===void 0||w.free()}var N=t.deviceList.getStoredDevice(t.userId,t.deviceId),A=yield t.crossSigningInfo.signDevice(t.userId,N);U[t.deviceId]=A}if(M&&T.info("Got new user-signing key",l.getId("user_signing")),r&&(M||C)){T.info("Attempting to retrieve cross-signing user-signing private key");var K=null;try{var z=yield t.crossSigningInfo.getCrossSigningKey("user_signing",l.getId("user_signing"));K=z[1],T.info("Got cross-signing user-signing private key")}finally{var de;(de=K)===null||de===void 0||de.free()}}if(d){var _e=t.crossSigningInfo.keys.master;yield t.signObject(_e);var le=_e.signatures[t.userId]["ed25519:"+t.deviceId];U[t.crossSigningInfo.getId()]=Object.assign({},_e,{signatures:{[t.userId]:{["ed25519:"+t.deviceId]:le}}})}var Ce=Object.keys(U);if(Ce.length){var V=B=>{var{shouldEmit:te=!1}=B;return T.info("Starting background key sig upload for ".concat(Ce)),t.baseApis.uploadKeySignatures({[t.userId]:U}).then(he=>{var{failures:be}=he||{};if(T.info("Finished background key sig upload for ".concat(Ce)),Object.keys(be||[]).length>0)throw te&&t.baseApis.emit(at.KeySignatureUploadFailure,be,"checkOwnCrossSigningTrust",V),new ju("Key upload failed",{failures:be})}).catch(he=>{T.error("Error during background key sig upload for ".concat(Ce),he)})};V({shouldEmit:!0})}t.emit(at.UserTrustStatusChanged,n,t.checkUserTrust(n)),d&&(t.emit(at.KeysChanged,{}),yield t.afterCrossSigningLocalKeyChange()),yield t.backupManager.checkKeyBackup()})()}getBackupDecryptor(e,t){return R(function*(){if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor expects Uint8Array");var r=yield As.makeAlgorithm(e,R(function*(){return t}));return(yield r.keyMatches(t))?new zM(r):Promise.reject(new hr({errcode:ll.RESTORE_BACKUP_ERROR_BAD_KEY}))})()}importBackedUpRoomKeys(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return r.source="backup",this.importRoomKeys(e,r)}storeTrustedSelfKeys(e){var t=this;return R(function*(){e?t.crossSigningInfo.setKeys(e):t.crossSigningInfo.clearKeys(),yield t.cryptoStore.doTxn("readwrite",[Oe.STORE_ACCOUNT],r=>{t.cryptoStore.storeCrossSigningKeys(r,t.crossSigningInfo.keys)})})()}checkDeviceVerifications(e){var t=this;return R(function*(){var r=t.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(r){if(T.info("Starting device verification upgrade for ".concat(e)),t.crossSigningInfo.keys.user_signing){var n=t.deviceList.getStoredCrossSigningForUser(e);if(n){var s=yield t.checkForDeviceVerificationUpgrade(e,n);if(s){var l=yield r({users:{[e]:s}});l.includes(e)&&(yield t.baseApis.setDeviceVerified(e,n.getId()))}}}T.info("Finished device verification upgrade for ".concat(e))}})()}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(jr.Membership,this.onMembership),e.on(Pe.ToDeviceEvent,this.onToDeviceEvent),e.on(Ue.Timeline,this.onTimelineEvent),e.on(ct.Decrypted,this.onTimelineEvent)}start(){T.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop(),this.backupManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}getOwnDeviceKeys(){var e=this;return R(function*(){if(!e.olmDevice.deviceCurve25519Key)throw new Error("Curve25519 key not yet created");if(!e.olmDevice.deviceEd25519Key)throw new Error("Ed25519 key not yet created");return{ed25519:e.olmDevice.deviceEd25519Key,curve25519:e.olmDevice.deviceCurve25519Key}})()}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){var e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then(()=>this.baseApis.uploadKeysRequest({device_keys:e}))}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){var e=this,t=1e3*60,r=5;if(!this.oneTimeKeyCheckInProgress){var n=Date.now();if(!(this.lastOneTimeKeyCheck!==null&&n-this.lastOneTimeKeyCheck<t)){this.lastOneTimeKeyCheck=n;var s=this.olmDevice.maxNumberOfOneTimeKeys(),l=Math.floor(s/2),c=(function(){var d=R(function*(h){for(;l>h||e.getNeedsNewFallback();){if(l>h){T.info("generating oneTimeKeys");var v=Math.min(l-h,r);yield e.olmDevice.generateOneTimeKeys(v)}if(e.getNeedsNewFallback()){var p=yield e.olmDevice.getFallbackKey();(!p.curve25519||Object.keys(p.curve25519).length==0)&&(T.info("generating fallback key"),e.fallbackCleanup&&(clearTimeout(e.fallbackCleanup),delete e.fallbackCleanup),yield e.olmDevice.generateFallbackKey())}T.info("calling uploadOneTimeKeys");var m=yield e.uploadOneTimeKeys();if(m.one_time_key_counts&&m.one_time_key_counts.signed_curve25519)h=m.one_time_key_counts.signed_curve25519;else throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")}});return function(v){return d.apply(this,arguments)}})();this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>this.oneTimeKeyCount!==void 0?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(d=>d.one_time_key_counts.signed_curve25519||0)).then(d=>c(d)).catch(d=>{T.error("Error uploading one-time keys",d.stack||d)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}}}uploadOneTimeKeys(){var e=this;return R(function*(){var t=[],r;if(e.getNeedsNewFallback()){r={};var n=yield e.olmDevice.getFallbackKey();for(var[s,l]of Object.entries(n.curve25519)){var c={key:l,fallback:!0};r["signed_curve25519:"+s]=c,t.push(e.signObject(c))}e.needsNewFallback=!1}var d=yield e.olmDevice.getOneTimeKeys(),h={};for(var v in d.curve25519)if(d.curve25519.hasOwnProperty(v)){var p={key:d.curve25519[v]};h["signed_curve25519:"+v]=p,t.push(e.signObject(p))}yield Promise.all(t);var m={one_time_keys:h};r&&(m["org.matrix.msc2732.fallback_keys"]=r,m.fallback_keys=r);var _=yield e.baseApis.uploadKeysRequest(m);return r&&(e.fallbackCleanup=setTimeout(()=>{delete e.fallbackCleanup,e.olmDevice.forgetOldFallbackKey()},3600*1e3)),yield e.olmDevice.markKeysAsPublished(),_})()}downloadKeys(e,t){return this.deviceList.downloadKeys(e,!!t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getUserDeviceInfo(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=new Map,l=[],c=function*(p){var m=yield r.getStoredDevicesForUser(p);if(m){var _=new Map(m.map(b=>[b.deviceId,Y0(b,p)]));s.set(p,_)}else l.push(p)};for(var d of e)yield*c(d);if(n&&l.length>0){var h=yield r.downloadKeys(l);h.forEach((v,p)=>{var m=new Map;v.forEach((_,b)=>m.set(b,Y0(_,p))),s.set(p,m)})}return s})()}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}setDeviceVerified(e,t){var r=arguments,n=this;return R(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!0;yield n.setDeviceVerification(e,t,s)})()}crossSignDevice(e){var t=this;return R(function*(){yield t.setDeviceVerified(t.userId,e,!0)})()}setDeviceVerification(e,t){var r=arguments,n=this;return R(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:null,l=r.length>3&&r[3]!==void 0?r[3]:null,c=r.length>4&&r[4]!==void 0?r[4]:null,d=r.length>5?r[5]:void 0,h=n.deviceList.getStoredCrossSigningForUser(e);if((h==null?void 0:h.getId())===t){if(l!==null||c!==null)throw new Error("Cannot set blocked or known for a cross-signing key");if(!s)throw new Error("Cannot set a cross-signing key as unverified");var v=d?Object.values(d)[0]:null;if(d&&(Object.values(d).length!==1||v!==h.getId()))throw new Error("Key did not match expected value: expected ".concat(h.getId(),", got ").concat(v));if(!n.crossSigningInfo.getId()&&e===n.crossSigningInfo.userId&&(n.storeTrustedSelfKeys(h.keys),n.emit(at.UserTrustStatusChanged,n.userId,n.checkUserTrust(e))),e!==n.userId){T.info("Master key "+h.getId()+" for "+e+" marked verified. Signing...");var p=yield n.crossSigningInfo.signUser(h);if(p){var m=(function(){var N=R(function*(A){var{shouldEmit:K=!1}=A;T.info("Uploading signature for "+e+"...");var z=yield n.baseApis.uploadKeySignatures({[e]:{[t]:p}}),{failures:de}=z||{};if(Object.keys(de||[]).length>0)throw K&&n.baseApis.emit(at.KeySignatureUploadFailure,de,"setDeviceVerification",m),new ju("Key upload failed",{failures:de})});return function(K){return N.apply(this,arguments)}})();yield m({shouldEmit:!0})}return p}else return h}var _=n.deviceList.getRawStoredDevicesForUser(e);if(!_||!_[t])throw new Error("Unknown device "+e+":"+t);var b=_[t],E=b.verified;if(s){if(d){for(var[M,O]of Object.entries(d))if(b.keys[M]!==O)throw new Error("Key did not match expected value: expected ".concat(O,", got ").concat(b.keys[M]))}E=Pi.VERIFIED}else s!==null&&E==Pi.VERIFIED&&(E=Pi.UNVERIFIED);l?E=Pi.BLOCKED:l!==null&&E==Pi.BLOCKED&&(E=Pi.UNVERIFIED);var C=b.known;if(c!==null&&(C=c),(b.verified!==E||b.known!==C)&&(b.verified=E,b.known=C,n.deviceList.storeDevicesForUser(e,_),n.deviceList.saveIfDirty()),s&&e===n.userId){T.info("Own device "+t+" marked verified: signing");var U,I=n.checkDeviceTrust(e,t);if(I.isCrossSigningVerified()?T.log("Own device ".concat(t," already cross-signing verified")):U=yield n.crossSigningInfo.signDevice(e,qr.fromStorage(b,t)),U){var D=(function(){var N=R(function*(A){var{shouldEmit:K=!1}=A;T.info("Uploading signature for "+t);var z=yield n.baseApis.uploadKeySignatures({[e]:{[t]:U}}),{failures:de}=z||{};if(Object.keys(de||[]).length>0)throw K&&n.baseApis.emit(at.KeySignatureUploadFailure,de,"setDeviceVerification",D),new ju("Key upload failed",{failures:de})});return function(K){return N.apply(this,arguments)}})();yield D({shouldEmit:!0})}}var w=qr.fromStorage(b,t);return n.emit(at.DeviceVerificationChanged,e,t,w),w})()}findVerificationRequestDMInProgress(e,t){return this.inRoomVerificationRequests.findRequestInProgress(e,t)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){var r=this.inRoomVerificationRequests.findRequestInProgress(t);if(r)return Promise.resolve(r);var n=new Nr(this.baseApis,t,e);return this.requestVerificationWithChannel(e,n,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));var r=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(r)return Promise.resolve(r);var n=new Mr(this.baseApis,e,t,Mr.makeTransactionId());return this.requestVerificationWithChannel(e,n,this.toDeviceVerificationRequests)}requestOwnUserVerification(){return this.requestVerification(this.userId)}requestDeviceVerification(e,t){return this.requestVerification(e,[t])}requestVerificationWithChannel(e,t,r){var n=this;return R(function*(){var s=new Cs(t,n.verificationMethods,n.baseApis);t.transactionId&&r.setRequestByChannel(t,s),yield s.sendRequest();var l=r.getRequestByChannel(t);return l?s=l:(T.log("Crypto: adding new request to "+"requestsByTxnId with id ".concat(t.transactionId," ").concat(t.roomId)),r.setRequestByChannel(t,s)),s})()}beginKeyVerification(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null,s;if(n){if(s=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!s)throw new Error("No request found for user ".concat(t," with ")+"transactionId ".concat(n))}else{n=Mr.makeTransactionId();var l=new Mr(this.baseApis,t,[r],n,r);s=new Cs(l,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,s)}return s.beginKeyVerification(e,{userId:t,deviceId:r})}legacyDeviceVerification(e,t,r){var n=this;return R(function*(){var s=Mr.makeTransactionId(),l=new Mr(n.baseApis,e,[t],s,t),c=new Cs(l,n.verificationMethods,n.baseApis);n.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,s,c);var d=c.beginKeyVerification(r,{userId:e,deviceId:t});return yield Promise.race([d.verify(),c.waitFor(h=>h.started)]),c})()}getOlmSessionsForUser(e){var t=this;return R(function*(){var r=t.getStoredDevicesForUser(e)||[],n={};for(var s of r){var l=s.getIdentityKey(),c=yield t.olmDevice.getSessionInfoForDevice(l);n[s.deviceId]={deviceIdKey:l,sessions:c}}return n})()}getEventSenderDeviceInfo(e){var t=e.getSenderKey(),r=e.getWireContent().algorithm;if(!t||!r||e.isKeySourceUntrusted())return null;var n=this.deviceList.getDeviceByIdentityKey(r,t);if(n===null)return null;var s=e.getClaimedEd25519Key();return s?s!==n.getFingerprint()?(T.warn("Event "+e.getId()+" claims ed25519 key "+s+" but sender device has key "+n.getFingerprint()),null):n:(T.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){var t,r,n={};if(n.senderKey=(t=e.getSenderKey())!==null&&t!==void 0?t:void 0,n.algorithm=e.getWireContent().algorithm,!n.senderKey||!n.algorithm)return n.encrypted=!1,n;n.encrypted=!0,e.isKeySourceUntrusted()?n.authenticated=!1:n.authenticated=!0,n.sender=(r=this.deviceList.getDeviceByIdentityKey(n.algorithm,n.senderKey))!==null&&r!==void 0?r:void 0;var s=e.getClaimedEd25519Key();return s||(T.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),n.mismatchedSender=!0),n.sender&&s!==n.sender.getFingerprint()&&(T.warn("Event "+e.getId()+" claims ed25519 key "+s+"but sender device has key "+n.sender.getFingerprint()),n.mismatchedSender=!0),n}getEncryptionInfoForEvent(e){var t=this;return R(function*(){var r=t.getEventEncryptionInfo(e);if(!r.encrypted)return null;var n=e.getSender();if(!n||r.mismatchedSender)return{shieldColour:Oa.RED,shieldReason:No.MISMATCHED_SENDER_KEY};var s=t.checkUserTrust(n);if(!s.isCrossSigningVerified())return r.authenticated?{shieldColour:Oa.NONE,shieldReason:null}:{shieldColour:Oa.GREY,shieldReason:No.AUTHENTICITY_NOT_GUARANTEED};var l=n&&r.sender&&(yield t.getDeviceVerificationStatus(n,r.sender.deviceId));return l?l.isVerified()?r.authenticated?{shieldColour:Oa.NONE,shieldReason:null}:{shieldColour:Oa.GREY,shieldReason:No.AUTHENTICITY_NOT_GUARANTEED}:{shieldColour:Oa.RED,shieldReason:No.UNSIGNED_DEVICE}:{shieldColour:Oa.GREY,shieldReason:No.UNKNOWN_DEVICE}})()}forceDiscardSession(e){var t=this.roomEncryptors.get(e);if(t===void 0)throw new Error("Room not encrypted");if(t.forceDiscardSession===void 0)throw new Error("Room encryption algorithm doesn't support session discarding");return t.forceDiscardSession(),Promise.resolve()}setRoomEncryption(e,t,r){var n=this;return R(function*(){var s=n.clientStore.getRoom(e);if(!s)throw new Error("Unable to enable encryption tracking devices in unknown room ".concat(e));yield n.setRoomEncryptionImpl(s,t),!n.lazyLoadMembers&&!r&&n.deviceList.refreshOutdatedDeviceLists()})()}setRoomEncryptionImpl(e,t){var r=this;return R(function*(){var n=e.roomId;if(!t.algorithm){T.log("Ignoring setRoomEncryption with no algorithm");return}var s=r.roomList.getRoomEncryption(n);if(s&&JSON.stringify(s)!=JSON.stringify(t)){T.error("Ignoring m.room.encryption event which requests a change of config in "+n);return}var l=r.roomEncryptors.get(n);if(!l){var c=null;s||(c=r.roomList.setRoomEncryption(n,t));var d=pR.get(t.algorithm);if(!d)throw new Error("Unable to encrypt with "+t.algorithm);var h=new d({userId:r.userId,deviceId:r.deviceId,crypto:r,olmDevice:r.olmDevice,baseApis:r.baseApis,roomId:n,config:t});if(r.roomEncryptors.set(n,h),c&&(yield c),T.log("Enabling encryption in ".concat(n)),e.membersLoaded())yield r.trackRoomDevicesImpl(e);else{var v=p=>{e.off($e.Update,v),e.membersLoaded()&&r.trackRoomDevicesImpl(e).catch(m=>{T.error("Error enabling device tracking in ".concat(n),m)})};e.on($e.Update,v)}}})()}trackRoomDevices(e){var t=this.clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room ".concat(e));return this.trackRoomDevicesImpl(t)}trackRoomDevicesImpl(e){var t=this,r=e.roomId,n=(function(){var l=R(function*(){if(t.roomEncryptors.has(r)){T.log("Starting to track devices for room ".concat(r," ..."));var c=yield e.getEncryptionTargetMembers();c.forEach(d=>{t.deviceList.startTrackingDeviceList(d.userId)})}});return function(){return l.apply(this,arguments)}})(),s=this.roomDeviceTrackingState[r];return s||(s=n(),this.roomDeviceTrackingState[r]=s.catch(l=>{throw delete this.roomDeviceTrackingState[r],l})),s}ensureOlmSessionsForUsers(e,t){var r=new Map;for(var n of e){var s=[];r.set(n,s);var l=this.getStoredDevicesForUser(n)||[];for(var c of l){var d=c.getIdentityKey();d!=this.olmDevice.deviceCurve25519Key&&c.verified!=Pi.BLOCKED&&s.push(c)}}return Ji(this.olmDevice,this.baseApis,r,t)}exportRoomKeys(){var e=this;return R(function*(){var t=[];return yield e.cryptoStore.doTxn("readonly",[Oe.STORE_INBOUND_GROUP_SESSIONS],r=>{e.cryptoStore.getAllEndToEndInboundGroupSessions(r,n=>{if(n!==null){var s=e.olmDevice.exportInboundGroupSession(n.senderKey,n.sessionId,n.sessionData);delete s.first_known_index,s.algorithm=Zr,t.push(s)}})}),t})()}exportRoomKeysAsJson(){var e=this;return R(function*(){return JSON.stringify(yield e.exportRoomKeys())})()}importRoomKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=0,n=0,s=e.length;function l(){var c;(c=t.progressCallback)===null||c===void 0||c.call(t,{stage:"load_keys",successes:r,failures:n,total:s})}return Promise.all(e.map(c=>{if(!c.room_id||!c.algorithm)return T.warn("ignoring room key entry with missing fields",c),n++,t.progressCallback&&l(),null;var d=this.getRoomDecryptor(c.room_id,c.algorithm);return d.importRoomKey(c,t).finally(()=>{r++,t.progressCallback&&l()})})).then()}importRoomKeysAsJson(e,t){var r=this;return R(function*(){return yield r.importRoomKeys(JSON.parse(e))})()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){var t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}encryptEvent(e,t){var r=this;return R(function*(){var n=e.getRoomId(),s=r.roomEncryptors.get(n);if(!s)throw new Error("Room "+n+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");yield r.trackRoomDevicesImpl(t);var l=e.getContent(),c=l["m.relates_to"];c&&(l=Object.assign({},l),delete l["m.relates_to"]);var d=l["io.element.performance_metrics"];d&&(l=Object.assign({},l),delete l["io.element.performance_metrics"]);var h=yield s.encryptMessage(t,e.getType(),l);c&&(h["m.relates_to"]=c),d&&(h["io.element.performance_metrics"]=d),e.makeEncrypted("m.room.encrypted",h,r.olmDevice.deviceCurve25519Key,r.olmDevice.deviceEd25519Key)})()}decryptEvent(e){var t=this;return R(function*(){if(e.isRedacted()){var r=new _r(YM({room_id:e.getRoomId()},e.getUnsigned().redacted_because)),n=e.getUnsigned().redacted_because;if(r.isEncrypted())try{var s=yield t.decryptEvent(r);n=s.clearEvent}catch(d){T.warn("Decryption of redaction failed. Falling back to unencrypted event.",d)}return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n}}}}else{var l=e.getWireContent(),c=t.getRoomDecryptor(e.getRoomId(),l.algorithm);return c.decryptEvent(e)}})()}processDeviceLists(e){var t=this;return R(function*(){yield t.evalDeviceListChanges(e)})()}requestRoomKey(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,r).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(n=>{T.error("Error requesting key for event",n)})}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(t=>{T.warn("Error clearing pending room key requests",t)})}cancelAndResendAllOutgoingKeyRequests(){var e=this;return R(function*(){yield e.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()})()}onCryptoEvent(e,t){var r=this;return R(function*(){var n=t.getContent();yield r.setRoomEncryptionImpl(e,n)})()}onSyncWillProcess(e){var t=this;return R(function*(){e.oldSyncToken||(T.log("Initial sync performed - resetting device tracking state"),t.deviceList.stopTrackingAllDeviceLists(),t.deviceList.startTrackingDeviceList(t.userId),t.roomDeviceTrackingState={}),t.sendKeyRequestsImmediately=!1})()}onSyncCompleted(e){var t=this;return R(function*(){var r;t.deviceList.setSyncToken((r=e.nextSyncToken)!==null&&r!==void 0?r:null),t.deviceList.saveIfDirty(),t.deviceList.startTrackingDeviceList(t.userId),t.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(t.maybeUploadOneTimeKeys(),t.processReceivedRoomKeyRequests(),t.outgoingRoomKeyRequestManager.sendQueuedRequests(),t.sendKeyRequestsImmediately=!0)})()}evalDeviceListChanges(e){var t=this;return R(function*(){if(Array.isArray(e==null?void 0:e.changed)&&e.changed.forEach(n=>{t.deviceList.invalidateUserDeviceList(n)}),Array.isArray(e==null?void 0:e.left)&&e.left.length){var r=new Set(yield t.getTrackedE2eUsers());e.left.forEach(n=>{r.has(n)||t.deviceList.stopTrackingDeviceList(n)})}})()}getTrackedE2eUsers(){var e=this;return R(function*(){var t=[];for(var r of e.getTrackedE2eRooms()){var n=yield r.getEncryptionTargetMembers();for(var s of n)t.push(s.userId)}return t})()}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(e=>{var t=this.roomEncryptors.get(e.roomId);if(!t||!this.roomDeviceTrackingState[e.roomId])return!1;var r=e.getMyMembership();return r===We.Join||r===We.Invite})}encryptAndSendToDevices(e,t){var r=this;return R(function*(){try{var n=yield r.prepareToDeviceBatch(e,t);try{yield r.baseApis.queueToDevice(n)}catch(s){throw T.error("sendToDevice failed",s),s}}catch(s){throw T.error("encryptAndSendToDevices promises failed",s),s}})()}prepareToDeviceBatch(e,t){var r=this;return R(function*(){var n={eventType:$.RoomMessageEncrypted,batch:[]};return yield Promise.all(e.map((function(){var s=R(function*(l){var{userId:c,deviceInfo:d}=l,h=d.deviceId,v={algorithm:br,sender_key:r.olmDevice.deviceCurve25519Key,ciphertext:{},[Fr]:Jn()};n.batch.push({userId:c,deviceId:h,payload:v}),yield Ji(r.olmDevice,r.baseApis,new Map([[c,[d]]])),yield ja(v.ciphertext,r.userId,r.deviceId,r.olmDevice,c,d,t)});return function(l){return s.apply(this,arguments)}})())),n.batch=n.batch.filter(s=>Object.keys(s.payload.ciphertext).length>0?!0:(T.log("No ciphertext for device ".concat(s.userId,":").concat(s.deviceId,": pruning")),!1)),n})()}encryptToDeviceMessages(e,t,r){var n=this;return R(function*(){var s=new Set(t.map(d=>{var{userId:h}=d;return h})),l=yield n.downloadKeys(Array.from(s),!1),c=[];return t.forEach(d=>{var{userId:h,deviceId:v}=d,p=l.get(h);if(!p){T.warn("No devices found for user ".concat(h));return}p.has(v)?c.push({userId:h,deviceInfo:p.get(v)}):T.warn("No device found for user ".concat(h," with id ").concat(v))}),n.prepareToDeviceBatch(c,r)})()}preprocessToDeviceMessages(e){return R(function*(){return e.filter(t=>{var r;return t.type===$.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes((r=t.content)===null||r===void 0?void 0:r.algorithm)?(T.log("Ignoring invalid encrypted to-device event from "+t.sender),!1):!0})})()}updateOneTimeKeyCount(e){if(isFinite(e))this.oneTimeKeyCount=e;else throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number")}processKeyCounts(e,t){return e!==void 0&&this.updateOneTimeKeyCount(e.signed_curve25519||0),t!==void 0&&(this.needsNewFallback=!t.includes("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(e){var t=e.getContent();if(!t.room_id||!t.algorithm){T.error("key event is missing fields");return}this.backupManager.checkedForBackup||this.backupManager.checkAndStart();var r=this.getRoomDecryptor(t.room_id,t.algorithm);r.onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){var t=e.getContent();if(t.code!=="m.no_olm"&&(!t.room_id||!t.session_id)||!t.algorithm||!t.sender_key){T.error("key withheld event is missing fields");return}T.info("Got room key withheld event from ".concat(e.getSender()," ")+"for ".concat(t.algorithm," session ").concat(t.sender_key,"|").concat(t.session_id," ")+"in room ".concat(t.room_id," with code ").concat(t.code," (").concat(t.reason,")"));var r=this.getRoomDecryptor(t.room_id,t.algorithm);if(r.onRoomKeyWithheldEvent&&r.onRoomKeyWithheldEvent(e),!t.room_id){var n=this.getRoomDecryptors(t.algorithm);for(var s of n)s.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(Mr.validateEvent(e,this.baseApis)){var t=r=>{if(Mr.canCreateRequest(Mr.getEventType(r))){var n=r.getContent(),s=n&&n.from_device;if(s){var l=r.getSender(),c=new Mr(this.baseApis,l,[s]);return new Cs(c,this.verificationMethods,this.baseApis)}}};this.handleVerificationEvent(e,this.toDeviceVerificationRequests,t)}}handleVerificationEvent(e,t,r){var n=arguments,s=this;return R(function*(){var l=n.length>3&&n[3]!==void 0?n[3]:!0;if(e.isSending()&&e.status!=Ve.SENT){var c,d;try{yield new Promise((m,_)=>{c=m,d=()=>{e.status==Ve.CANCELLED&&_(new Error("Event status set to CANCELLED."))},e.once(ct.LocalEventIdReplaced,c),e.on(ct.Status,d)})}catch(m){T.error("error while waiting for the verification event to be sent: ",m);return}finally{e.removeListener(ct.LocalEventIdReplaced,c),e.removeListener(ct.Status,d)}}var h=t.getRequest(e),v=!1;if(!h){if(h=r(e),!h){T.log("Crypto: could not find VerificationRequest for "+"".concat(e.getType(),", and could not create one, so ignoring."));return}v=!0,t.setRequest(e,h)}e.setVerificationRequest(h);try{yield h.channel.handleEvent(e,h,l)}catch(m){T.error("error while handling verification event",m)}var p=v&&!h.initiatedByMe&&!h.invalid&&!h.observeOnly;p&&(s.baseApis.emit(at.VerificationRequest,h),s.baseApis.emit(at.VerificationRequestReceived,h))})()}onToDeviceBadEncrypted(e){var t=this;return R(function*(){var r=e.getWireContent(),n=e.getSender(),s=r.algorithm,l=r.sender_key;t.baseApis.emit(Pe.UndecryptableToDeviceEvent,e);var c=()=>{var E=t.getRoomDecryptors(Zr);for(var M of E)M.retryDecryptionFromSender(l)};if(!(n===void 0||l===void 0||l===void 0)){var d=t.forceNewSessionRetryTime.getOrCreate(n),h=d.getOrCreate(l);if(h>Date.now()){T.debug("New session already forced with device ".concat(n,":").concat(l,": ")+"not forcing another until at least ".concat(new Date(h).toUTCString())),yield t.olmDevice.recordSessionProblem(l,"wedged",!0),c();return}d.set(l,Date.now()+QM);var v=t.deviceList.getDeviceByIdentityKey(s,l);if(!v&&(yield t.downloadKeys([n],!1),v=t.deviceList.getDeviceByIdentityKey(s,l),!v)){T.info("Couldn't find device for identity key "+l+": not re-establishing session"),yield t.olmDevice.recordSessionProblem(l,"wedged",!1),c();return}var p=new Map([[n,[v]]]);yield Ji(t.olmDevice,t.baseApis,p,!0),d.set(l,Date.now()+JM);var m={algorithm:br,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[Fr]:Jn()};yield ja(m.ciphertext,t.userId,t.deviceId,t.olmDevice,n,v,{type:"m.dummy"}),yield t.olmDevice.recordSessionProblem(l,"wedged",!0),c(),yield t.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[v.deviceId,m]])]]));var _=yield t.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,v.deviceId);for(var b of _)t.requestRoomKey(b.requestBody,b.recipients,!0)}})()}onRoomMembership(e,t,r){var n=t.roomId,s=this.roomEncryptors.get(n);if(s){if(n in this.roomDeviceTrackingState){var l;t.membership==We.Join?(T.log("Join event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId)):t.membership==We.Invite&&(l=this.clientStore.getRoom(n))!==null&&l!==void 0&&l.shouldEncryptForInvitedMembers()&&(T.log("Invite event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId))}s.onRoomMembership(e,t,r)}}onRoomKeyRequestEvent(e){var t=e.getContent();if(t.action==="request"){var r=new XM(e);this.receivedRoomKeyRequests.push(r)}else if(t.action==="request_cancellation"){var n=new $M(e);this.receivedRoomKeyRequestCancellations.push(n)}}processReceivedRoomKeyRequests(){var e=this;return R(function*(){if(!e.processingRoomKeyRequests){e.processingRoomKeyRequests=!0;try{var t=e.receivedRoomKeyRequests;e.receivedRoomKeyRequests=[];var r=e.receivedRoomKeyRequestCancellations;e.receivedRoomKeyRequestCancellations=[],yield Promise.all(t.map(n=>e.processReceivedRoomKeyRequest(n))),yield Promise.all(r.map(n=>e.processReceivedRoomKeyRequestCancellation(n)))}catch(n){T.error("Error processing room key requsts: ".concat(n))}finally{e.processingRoomKeyRequests=!1}}})()}processReceivedRoomKeyRequest(e){var t=this;return R(function*(){var r=e.userId,n=e.deviceId,s=e.requestBody,l=s.room_id,c=s.algorithm;if(T.log("m.room_key_request from ".concat(r,":").concat(n)+" for ".concat(l," / ").concat(s.session_id," (id ").concat(e.requestId,")")),r!==t.userId){if(!t.roomEncryptors.get(l)){T.debug("room key request for unencrypted room ".concat(l));return}var d=t.roomEncryptors.get(l),h=t.deviceList.getStoredDevice(r,n);if(!h){T.debug("Ignoring keyshare for unknown device ".concat(r,":").concat(n));return}try{yield d.reshareKeyWithDevice(s.sender_key,s.session_id,r,h)}catch(p){T.warn("Failed to re-share keys for session "+s.session_id+" with device "+r+":"+h.deviceId,p)}return}if(n===t.deviceId){T.log("Ignoring room key request from ourselves");return}if(!t.roomDecryptors.has(l)){T.log("room key request for unencrypted room ".concat(l));return}var v=t.roomDecryptors.get(l).get(c);if(!v){T.log("room key request for unknown alg ".concat(c," in room ").concat(l));return}if(!(yield v.hasKeysForKeyRequest(e))){T.log("room key request for unknown session ".concat(l," / ")+s.session_id);return}if(e.share=()=>{v.shareKeysWithDevice(e)},t.checkDeviceTrust(r,n).isVerified()){T.log("device is already verified: sharing keys"),e.share();return}t.emit(at.RoomKeyRequest,e)})()}processReceivedRoomKeyRequestCancellation(e){var t=this;return R(function*(){T.log("m.room_key_request cancellation for ".concat(e.userId,":")+"".concat(e.deviceId," (id ").concat(e.requestId,")")),t.emit(at.RoomKeyRequestCancellation,e)})()}getRoomDecryptor(e,t){var r,n;if(e&&(r=this.roomDecryptors.get(e),r||(r=new Map,this.roomDecryptors.set(e,r)),n=r.get(t),n))return n;var s=Up.get(t);if(!s)throw new dr(zt.UNKNOWN_ENCRYPTION_ALGORITHM,'Unknown encryption algorithm "'+t+'".');return n=new s({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e??void 0}),r&&r.set(t,n),n}getRoomDecryptors(e){var t=[];for(var r of this.roomDecryptors.values())r.has(e)&&t.push(r.get(e));return t}signObject(e){var t=this;return R(function*(){var r=new Map(Object.entries(e.signatures||{})),n=e.unsigned;delete e.signatures,delete e.unsigned;var s=r.get(t.userId)||{};r.set(t.userId,s),s["ed25519:"+t.deviceId]=yield t.olmDevice.sign(Yi.stringify(e)),e.signatures=Ua(r),n!==void 0&&(e.unsigned=n)})()}isRoomEncrypted(e){return this.roomList.isRoomEncrypted(e)}isEncryptionEnabledInRoom(e){var t=this;return R(function*(){return t.isRoomEncrypted(e)})()}getRoomEncryption(e){return this.roomList.getRoomEncryption(e)}isDehydrationSupported(){return R(function*(){return!1})()}startDehydration(e){return R(function*(){throw new Error("Not implemented")})()}restoreKeyBackup(e){throw new Error("Not implemented")}restoreKeyBackupWithPassphrase(e,t){throw new Error("Not implemented")}}function uf(a){if(typeof a!="string"||a.indexOf(",")<0)return null;var e=Uint8Array.from(a.split(","),t=>parseInt(t));return Kr(e)}class XM{constructor(e){y(this,"userId",void 0),y(this,"deviceId",void 0),y(this,"requestId",void 0),y(this,"requestBody",void 0),y(this,"share",void 0);var t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class $M{constructor(e){y(this,"userId",void 0),y(this,"deviceId",void 0),y(this,"requestId",void 0);var t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}class ZM{constructor(e){this.ourEvent=e,y(this,"timeline",void 0),y(this,"ourEventIndex",0),y(this,"paginateTokens",{[tt.Backward]:null,[tt.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?tt.Backward:tt.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?tt.Backward:tt.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class Jf{static fromJson(e,t){var r=e.context||{},n=(r.events_before||[]).map(t),s=(r.events_after||[]).map(t),l=new ZM(t(e.result)),c=l.ourEvent.threadRootId;return n=n.filter(d=>d.threadRootId===c),s=s.filter(d=>d.threadRootId===c),l.setPaginateToken(r.start,!0),l.addEvents(n,!0),l.addEvents(s,!1),l.setPaginateToken(r.end,!1),new Jf(e.rank,l)}constructor(e,t){this.rank=e,this.context=t}}var eN=(function(a){return a.Public="public",a.Private="private",a})({}),Im=(function(a){return a.PrivateChat="private_chat",a.TrustedPrivateChat="trusted_private_chat",a.PublicChat="public_chat",a})({}),RR=(function(a){return a.Public="public",a.Invite="invite",a.Private="private",a.Knock="knock",a.Restricted="restricted",a})({}),tN=(function(a){return a.RoomMembership="m.room_membership",a})({}),Df=(function(a){return a.CanJoin="can_join",a.Forbidden="forbidden",a})({}),Om=(function(a){return a.Invited="invited",a.Joined="joined",a.Shared="shared",a.WorldReadable="world_readable",a})({});function Q0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function X0(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Q0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):Q0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}function rN(a,e){var t=!!e.preventReEmit,r=e.decrypt!==!1;function n(s){e.toDevice&&delete s.room_id;var l=a.getRoom(s.room_id),c;l&&s.state_key===void 0&&(c=l.findEventById(s.event_id)),!c||c.status?c=new _r(s):(c.setUnsigned(X0(X0({},c.getUnsigned()),s.unsigned)),t=!0);var d=c.getServerAggregatedRelation(Ht.Replace);if(d!=null&&d.content){var h=n(d);c.makeReplaced(h)}var v=l==null?void 0:l.findThreadForEvent(c);return v&&c.setThread(v),c.isEncrypted()&&(t||a.reEmitter.reEmit(c,[ct.Decrypted]),r&&a.decryptEventIfNeeded(c)),t||(a.reEmitter.reEmit(c,[ct.Replaced,ct.VisibilityChange]),l==null||l.reEmitter.reEmit(c,[ct.BeforeRedaction])),c}return n}function $0(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function wa(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$0(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):$0(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}class Z0{constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return R(function*(){yield e.client.sendStateEvent(e.roomId,qi.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,qi.name,wa(wa({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,qi.name,wa(wa({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return R(function*(){var t=yield e.getFileEvent(),r=t.getOriginalContent().file,n=e.client.mxcUrlToHttp(r.url);if(!n)throw new Error("No HTTP URL available for ".concat(r.url));return{info:r,httpUrl:n}})()}getFileEvent(){var e=this;return R(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var r=t.getUnfilteredTimelineSet().findEventById(e.id);!r&&t.getLiveTimeline().getState(ke.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),r=t.getUnfilteredTimelineSet().findEventById(e.id);if(!r)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(r),r})()}createNewVersion(e,t,r,n){var s=this;return R(function*(){var l=yield s.directory.createFile(e,t,r,wa(wa({},n??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:Ht.Replace,event_id:s.id}}));return yield s.client.sendStateEvent(s.roomId,qi.name,{active:!0,name:e,version:s.version+1},l.event_id),yield s.client.sendStateEvent(s.roomId,qi.name,wa(wa({},s.indexEvent.getContent()),{},{active:!1}),s.id),l})()}getVersionHistory(){var e=this;return R(function*(){var t=[];t.push(e);var r=e.client.getRoom(e.roomId);if(!r)throw new Error("Invalid or unknown room");var n=[...r.getLiveTimeline().getEvents()].reverse(),s,l=yield e.getFileEvent();do if(s=n.find(d=>d.replacingEventId()===l.getId()),s){var c=e.directory.getFile(s.getId());if(c)t.push(c),l=s;else break}while(s);return t})()}}function eT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function gs(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?eT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):eT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var nN={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[$.RoomPowerLevels]:100,[$.RoomHistoryVisibility]:100,[$.RoomTombstone]:100,[$.RoomEncryption]:100,[$.RoomName]:50,[$.RoomMessage]:50,[$.RoomMessageEncrypted]:50,[$.Sticker]:50},users:{}},Io=(function(a){return a.Viewer="viewer",a.Editor="editor",a.Owner="owner",a})({});class tT{constructor(e,t){if(this.client=e,this.roomId=t,y(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents($.SpaceParent);return e!=null&&e.length?e.every(t=>{var r;return!((r=t.getContent())!==null&&r!==void 0&&r.via)}):!0}setName(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,$.RoomName,{name:e},"")})()}invite(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!0,s=[r.retryInvite(e)];n&&s.push(...r.getDirectories().map(l=>l.invite(e,n))),yield Promise.all(s)})()}retryInvite(e){var t=this;return Rk(R(function*(){yield t.client.invite(t.roomId,e).catch(r=>{throw(r==null?void 0:r.errcode)==="M_FORBIDDEN"?new iw.AbortError(r):r})}))}setPermissions(e,t){var r=this;return R(function*(){var n,s=r.room.currentState.getStateEvents($.RoomPowerLevels,"");if(Array.isArray(s))throw new Error("Unexpected return type for power levels");var l=(s==null?void 0:s.getContent())||{},c=l.users_default||0,d=l.events_default||50,h=((n=l.events)===null||n===void 0?void 0:n[$.RoomPowerLevels])||100,v=l.users||{};switch(t){case Io.Viewer:v[e]=c;break;case Io.Editor:v[e]=d;break;case Io.Owner:v[e]=h;break;default:throw new Error("Invalid role: "+t)}l.users=v,yield r.client.sendStateEvent(r.roomId,$.RoomPowerLevels,l,"")})()}getPermissions(e){var t,r,n=this.room.currentState.getStateEvents($.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");var s=(n==null?void 0:n.getContent())||{},l=s.users_default||0,c=s.events_default||50,d=((t=s.events)===null||t===void 0?void 0:t[$.RoomPowerLevels])||100,h=((r=s.users)===null||r===void 0?void 0:r[e])||l;return h>=d?Io.Owner:h>=c?Io.Editor:Io.Viewer}createDirectory(e){var t=this;return R(function*(){var r=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,$.SpaceChild,{via:[t.client.getDomain()]},r.roomId),yield t.client.sendStateEvent(r.roomId,$.SpaceParent,{via:[t.client.getDomain()]},t.roomId),r})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents($.SpaceChild);for(var r of t)try{var n=r.getStateKey();if(n){var s=this.client.unstableGetFileTreeSpace(n);s&&e.push(s)}}catch(l){T.warn("Unable to create tree space instance for listing. Are we joined?",l)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return R(function*(){var t=e.getDirectories();for(var r of t)yield r.delete();var n=[We.Invite,We.Knock,We.Join],s=e.room.currentState.getStateEvents($.RoomMember);for(var l of s){var c=l.getStateKey()!==e.client.getUserId();if(c&&n.includes(l.getContent().membership)){var d=l.getStateKey();if(!d)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,d,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(r=>({roomId:r.getStateKey(),order:r.getContent().order})).filter(r=>r.roomId);return t.sort((r,n)=>{if(r.order&&!n.order)return-1;if(!r.order&&n.order)return 1;if(!r.order&&!n.order){var s,l,c,d,h=this.client.getRoom(r.roomId),v=this.client.getRoom(n.roomId);if(!h||!v)return af(r.roomId,n.roomId);var p=(s=(l=h.currentState.getStateEvents($.RoomCreate,""))===null||l===void 0?void 0:l.getTs())!==null&&s!==void 0?s:0,m=(c=(d=v.currentState.getStateEvents($.RoomCreate,""))===null||d===void 0?void 0:d.getTs())!==null&&c!==void 0?c:0;return p===m?af(r.roomId,n.roomId):p-m}else return af(r.order,n.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents($.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var r=t.getStateKey();if(!r)throw new Error("No state key found for parent");var n=this.client.getRoom(r);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents($.SpaceChild),r=this.getOrderedChildren(t);return r.findIndex(n=>n.roomId===this.roomId)}setOrder(e){var t=this;return R(function*(){var r;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var n=t.getParentRoom(),s=n.currentState.getStateEvents($.SpaceChild),l=t.getOrderedChildren(s);e=Math.max(Math.min(e,l.length-1),0);var c=t.getOrder(),d=c<e;d&&e===l.length-1?e--:!d&&e===0&&e++;var h=l[d?e:e-1],v=l[d?e+1:e],p=Ka[0],m=!1;if(!h)v!=null&&v.order&&(p=PE(v.order));else if(e===l.length-1)v!=null&&v.order&&(p=hu(v.order));else{var _=h==null?void 0:h.order,b=v==null?void 0:v.order;_&&b?_===b?p=hu(_):p=Ck(_,b):_?p=hu(_):b?p=PE(b):m=!0}if(m){for(var E,M=0;M<=e;M++){var O=l[M];if(M===0&&(E=O.order),O.order)E=O.order;else{var C;E=E?hu(E):Ka[0];var U=n.currentState.getStateEvents($.SpaceChild,O.roomId),I=(C=U==null?void 0:U.getContent())!==null&&C!==void 0?C:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,$.SpaceChild,gs(gs({},I),{},{order:E}),O.roomId)}}E&&(p=hu(E))}var D=n.currentState.getStateEvents($.SpaceChild,t.roomId),w=(r=D==null?void 0:D.getContent())!==null&&r!==void 0?r:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,$.SpaceChild,gs(gs({},w),{},{order:p}),t.roomId)})()}createFile(e,t,r,n){var s=this;return R(function*(){var l,{content_uri:c}=yield s.client.uploadContent(t,{includeFilename:!1});r.url=c;var d={msgtype:Xn.File,body:e,url:c,file:r};n=(l=n)!==null&&l!==void 0?l:{},n["m.new_content"]&&(n["m.new_content"]=d);var h=yield s.client.sendMessage(s.roomId,gs(gs(gs({},n),d),{},{[_w.name]:{}}));return yield s.client.sendStateEvent(s.roomId,qi.name,{active:!0,name:e},h.event_id),h})()}getFile(e){var t=this.room.currentState.getStateEvents(qi.name,e);return t?new Z0(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(qi.name))!==null&&e!==void 0?e:[];return t.map(r=>new Z0(this.client,r,this))}}var CR=(function(a){return a.Recent="recent",a.Rank="rank",a})({}),ws=(function(a){return a.LocalStreamsChanged="local_streams_changed",a})({});class iN extends Pt{constructor(e){super(),this.client=e,y(this,"audioInput",void 0),y(this,"audioSettings",void 0),y(this,"videoInput",void 0),y(this,"localUserMediaStream",void 0),y(this,"userMediaStreams",[]),y(this,"screensharingStreams",[]),y(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return R(function*(){T.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return R(function*(){T.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return R(function*(){T.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var r=this;return R(function*(){T.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),r.audioInput=e,r.videoInput=t,yield r.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return R(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var r of e.client.callEventHandler.calls.values())t.set(r.callId,{audio:r.hasLocalUserMediaAudioTrack,video:r.hasLocalUserMediaVideoTrack});for(var n of e.userMediaStreams){T.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(n.id,")"));for(var s of n.getTracks())s.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var l of e.client.callEventHandler.calls.values())if(!(l.callHasEnded()||!t.has(l.callId))){var{audio:c,video:d}=t.get(l.callId);T.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(l.callId,")"));var h=yield e.getUserMediaStream(c,d);l.callHasEnded()||(yield l.updateLocalUsermediaStream(h))}for(var v of e.client.groupCallEventHandler.groupCalls.values())if(v.localCallFeed){T.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(v.groupCallId,")"));var p=yield e.getUserMediaStream(!0,v.type===Hf.Video);v.state!==Gt.Ended&&(yield v.updateLocalUsermediaStream(p))}e.emit(ws.LocalStreamsChanged)}})()}hasAudioDevice(){return R(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return T.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return R(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return T.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var r=arguments,n=this;return R(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!0;return n.getMediaStreamPromise?n.getMediaStreamPromise=n.getMediaStreamPromise.then(()=>n.getUserMediaStreamInternal(e,t,s)):n.getMediaStreamPromise=n.getUserMediaStreamInternal(e,t,s),n.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,r){var n=this;return R(function*(){var s=e&&(yield n.hasAudioDevice()),l=t&&(yield n.hasVideoDevice()),c,d=!0;if(n.localUserMediaStream){var h,v;s!==n.localUserMediaStream.getAudioTracks().length>0&&(d=!1),l!==n.localUserMediaStream.getVideoTracks().length>0&&(d=!1),s&&((h=n.localUserMediaStream.getAudioTracks()[0])===null||h===void 0||(h=h.getSettings())===null||h===void 0?void 0:h.deviceId)!==n.audioInput&&(d=!1),l&&((v=n.localUserMediaStream.getVideoTracks()[0])===null||v===void 0||(v=v.getSettings())===null||v===void 0?void 0:v.deviceId)!==n.videoInput&&(d=!1)}else d=!1;if(d){var b;if(c=n.localUserMediaStream.clone(),T.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((b=n.localUserMediaStream)===null||b===void 0?void 0:b.id," newStreamId=").concat(c.id," shouldRequestAudio=").concat(s," shouldRequestVideo=").concat(l,")")),!s)for(var E of c.getAudioTracks())c.removeTrack(E);if(!l)for(var M of c.getVideoTracks())c.removeTrack(M)}else{var p=n.getUserMediaContraints(s,l);c=yield navigator.mediaDevices.getUserMedia(p),T.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(c.id,", shouldRequestAudio=").concat(s,", shouldRequestVideo=").concat(l,", constraints=").concat(JSON.stringify(p),")"));for(var m of c.getTracks()){var _=m.getSettings();m.kind==="audio"?n.audioInput=_.deviceId:m.kind==="video"&&(n.videoInput=_.deviceId)}r&&(n.localUserMediaStream=c)}return r&&n.userMediaStreams.push(c),n.emit(ws.LocalStreamsChanged),c})()}stopUserMediaStream(e){T.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.userMediaStreams.indexOf(e);if(r!==-1&&(T.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(r,1)),this.emit(ws.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var n of e.getTracks()){var s;if((s=this.localUserMediaStream)!==null&&s!==void 0&&s.getTrackById(n.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return R(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:{},n=e.length>1&&e[1]!==void 0?e[1]:!0,s;if(t.screensharingStreams.length===0){var l=t.getScreenshareContraints(r);r.desktopCapturerSourceId?(T.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(r),")")),s=yield navigator.mediaDevices.getUserMedia(l)):(T.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(r),")")),s=yield navigator.mediaDevices.getDisplayMedia(l))}else{var c=t.screensharingStreams[t.screensharingStreams.length-1];T.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(c.id,")")),s=c.clone()}return n&&t.screensharingStreams.push(s),t.emit(ws.LocalStreamsChanged),s})()}stopScreensharingStream(e){T.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.screensharingStreams.indexOf(e);r!==-1&&(T.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(r,1)),this.emit(ws.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){T.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var r of this.screensharingStreams)for(var n of r.getTracks())n.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(ws.LocalStreamsChanged)}getUserMediaContraints(e,t){var r=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:t?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:r??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:r??!1,video:!0}}}var rT=(function(a){return a.RequestFinished="FINISHED",a.Complete="COMPLETE",a})({}),_c=(function(a){return a.PreProcess="ExtState.PreProcess",a.PostProcess="ExtState.PostProcess",a})({}),Vp=(function(a){return a.RoomData="SlidingSync.RoomData",a.Lifecycle="SlidingSync.Lifecycle",a.List="SlidingSync.List",a})({}),aN=3;class sN{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return _c.PreProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return R(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class oN{constructor(e,t){this.client=e,this.cryptoCallbacks=t,y(this,"nextBatch",null)}name(){return"to_device"}when(){return _c.PreProcess}onRequest(e){var t={since:this.nextBatch!==null?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}onResponse(e){var t=this;return R(function*(){var r=[],n=e.events||[];n.length>0&&t.cryptoCallbacks&&(n=yield t.cryptoCallbacks.preprocessToDeviceMessages(n)),n.map(t.client.getEventMapper()).map(s=>{if(s.getType()==="m.key.verification.cancel"){var l=s.getContent().transaction_id;l&&r.push(l)}return s}).forEach(s=>{var l=s.getContent();if(s.getType()=="m.room.message"&&l.msgtype=="m.bad.encrypted"){T.log("Ignoring undecryptable to-device event from "+s.getSender());return}if(s.getType()==="m.key.verification.start"||s.getType()==="m.key.verification.request"){var c=l.transaction_id;r.includes(c)&&s.flagCancelled()}t.client.emit(Pe.ToDeviceEvent,s)}),t.nextBatch=e.next_batch})()}}class lN{constructor(e){this.client=e}name(){return"account_data"}when(){return _c.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return R(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var r in e.rooms){var n=jo(t.client,r,e.rooms[r]),s=t.client.getRoom(r);if(!s){T.warn("got account data for room but room doesn't exist on client:",r);continue}s.addAccountData(n),n.forEach(l=>{t.client.emit(Pe.Event,l)})}})()}processGlobalAccountData(e){var t=jo(this.client,void 0,e),r=t.reduce((n,s)=>(n[s.getType()]=this.client.store.getAccountData(s.getType()),n),{});this.client.store.storeAccountDataEvents(t),t.forEach(n=>{if(n.getType()===$.PushRules){var s=n.getContent();this.client.setPushRules(s)}var l=r[n.getType()];return this.client.emit(Pe.AccountData,n,l),n})}}class uN{constructor(e){this.client=e}name(){return"typing"}when(){return _c.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return R(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)OR(t.client,r,[e.rooms[r]])})()}}class cN{constructor(e){this.client=e}name(){return"receipts"}when(){return _c.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return R(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)OR(t.client,r,[e.rooms[r]])})()}}class IR{constructor(e,t,r,n){this.slidingSync=e,this.client=t,y(this,"opts",void 0),y(this,"syncOpts",void 0),y(this,"syncState",null),y(this,"syncStateData",void 0),y(this,"lastPos",null),y(this,"failCount",0),y(this,"notifEvents",[]),this.opts=eR(r),this.syncOpts=tR(n),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[Ue.Timeline,Ue.TimelineReset]),this.slidingSync.on(Vp.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(Vp.RoomData,this.onRoomData.bind(this));var s=[new oN(this.client,this.syncOpts.cryptoCallbacks),new lN(this.client),new uN(this.client),new cN(this.client)];this.syncOpts.crypto&&s.push(new sN(this.syncOpts.crypto)),s.forEach(l=>{this.slidingSync.registerExtension(l)})}onRoomData(e,t){var r=this;return R(function*(){var n=r.client.store.getRoom(e);if(!n){if(!t.initial){T.debug("initial flag not set but no stored room exists for room ",e,t);return}n=rR(r.client,e,r.opts)}yield r.processRoomData(r.client,n,t)})()}onLifecycle(e,t,r){switch(r&&T.debug("onLifecycle",e,r),e){case rT.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(bt.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(bt.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case rT.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>aN?bt.Error:bt.Reconnecting,{error:new hr(r)}),this.shouldAbortSync(new hr(r)))return}else this.failCount=0;break}}syncLeftRooms(){return R(function*(){return[]})()}peek(e){return R(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,r=new qf(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[Ue.Name,Ue.Redaction,Ue.RedactionCancelled,Ue.Receipt,Ue.Tags,Ue.LocalEchoUpdated,Ue.AccountData,Ue.MyMembership,Ue.Timeline,Ue.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[$e.Events,$e.Members,$e.NewMember,$e.Update]),e.currentState.on($e.NewMember,(t,r,n)=>{var s;n.user=(s=this.client.getUser(n.userId))!==null&&s!==void 0?s:void 0,this.client.reEmitter.reEmit(n,[jr.Name,jr.Typing,jr.PowerLevel,jr.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(T.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(bt.Error,{error:e}),!0):!1}processRoomData(e,t,r){var n=this;return R(function*(){r=dN(e,t.roomId,r);var s=jo(n.client,t.roomId,r.required_state),l=jo(n.client,t.roomId,r.timeline,!1),c=[];if(r.initial){var d=new Set;t.getLiveTimeline().getEvents().forEach(C=>{d.add(C.getId())});for(var h=[],v=[],p=!1,m=l.length-1;m>=0;m--){var _=l[m];if(d.has(_.getId())){p=!0;continue}p?h.push(_):v.unshift(_)}l=v,h.length>0&&t.addEventsToTimeline(h,!0,t.getLiveTimeline(),r.prev_batch)}var b=t.hasEncryptionStateEvent();if(r.notification_count!=null&&t.setUnreadNotificationCount(pt.Total,r.notification_count),r.highlight_count!=null&&(!b||b&&t.getUnreadNotificationCount(pt.Highlight)<=0)&&t.setUnreadNotificationCount(pt.Highlight,r.highlight_count),Number.isInteger(r.invited_count)&&t.currentState.setInvitedMemberCount(r.invited_count),Number.isInteger(r.joined_count)&&t.currentState.setJoinedMemberCount(r.joined_count),r.invite_state){var E=jo(n.client,t.roomId,r.invite_state);yield n.injectRoomEvents(t,E),r.initial&&(t.recalculate(),n.client.store.storeRoom(t),n.client.emit(Pe.Room,t)),E.forEach(C=>{n.client.emit(Pe.Event,C)}),t.updateMyMembership(We.Invite);return}if(r.initial){var M;t.getLiveTimeline().setPaginationToken((M=r.prev_batch)!==null&&M!==void 0?M:null,ke.BACKWARDS)}yield n.injectRoomEvents(t,s,l,r.num_live),t.addEphemeralEvents(c),t.updateMyMembership(We.Join),t.recalculate(),r.initial&&(e.store.storeRoom(t),e.emit(Pe.Room,t)),n.addNotifications(l);var O=(function(){var C=R(function*(U){e.emit(Pe.Event,U),U.isState()&&U.getType()==$.RoomEncryption&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(t,U))});return function(I){return C.apply(this,arguments)}})();yield Po(s,O),yield Po(l,O),c.forEach(function(C){e.emit(Pe.Event,C)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t,r,n){var s=this;return R(function*(){r=r||[],t=t||[],n=n||0;var l=e.getLiveTimeline(),c=l.getEvents().length==0;if(c){for(var d of t)s.client.getPushActionsForEvent(d);l.initialiseState(t)}c||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var h=[];n>0&&(h=r.slice(-1*n),r=r.slice(0,-1*h.length)),yield e.addLiveEvents(r,{fromCache:!0}),h.length>0&&(yield e.addLiveEvents(h,{fromCache:!1})),e.recalculate(),s.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(We.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),s;n?s=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):s=t.getProfileInfo(r.userId),s.then(function(l){var c=r.events.member;c.getContent().membership===We.Invite&&(c.getContent().avatar_url=l.avatar_url,c.getContent().displayname=l.displayname,r.setMembershipEvent(c,e.currentState))},function(l){})}})}}retryImmediately(){return!0}sync(){var e=this;return R(function*(){for(T.debug("Sliding sync init loop");!e.client.isGuest();)try{T.debug("Getting push rules...");var t=yield e.client.getPushRules();T.debug("Got push rules"),e.client.pushRules=t;break}catch(r){if(T.error("Getting push rules failed",r),e.shouldAbortSync(r))return}yield e.slidingSync.start()})()}stop(){T.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(Pe.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var r=this.client.getPushActionsForEvent(t);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e)}),this.notifEvents=[]}}function dN(a,e,t){if(!t.name)return t;for(var r of t.required_state)if(r.type===$.RoomName&&r.state_key==="")return r.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:$.RoomName,content:{name:t.name},sender:a.getUserId(),origin_server_ts:new Date().getTime()}),t}function jo(a,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,n=a.getEventMapper({decrypt:r});return t.map(function(s){return s.room_id=e,n(s)})}function OR(a,e,t){var r=jo(a,e,t),n=a.getRoom(e);if(!n){T.warn("got ephemeral events for room but room doesn't exist on client:",e);return}n.addEphemeralEvents(r),r.forEach(s=>{a.emit(Pe.Event,s)})}class $o{static RETRY_BACKOFF_RATELIMIT(e,t,r){return Yw(r,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===$.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:$o.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:$o.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,y(this,"queues",{}),y(this,"activeQueues",[]),y(this,"procFn",null),y(this,"processQueue",r=>{var n=this.peekNextEvent(r);if(!n){this.disableQueue(r);return}this.queues[r].length,Promise.resolve().then(()=>this.procFn(n.event)).then(s=>{this.removeNextEvent(r),n.event.getId(),n.defer.resolve(s),this.processQueue(r)},s=>{n.attempts+=1;var l=this.retryAlgorithm(n.event,n.attempts,s);n.attempts,n.event.getId(),l===-1?(T.info("Queue '%s' giving up on event %s",r,n.event.getId()),this.clearQueue(r,s)):setTimeout(this.processQueue,l,r)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(r){return r.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var r=!1;return yf(this.queues[t],n=>n.event.getId()===e.getId()?(r=!0,!0):!1),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var r=qa();return this.queues[t].push({event:e,defer:r,attempts:0}),e.getId(),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),T.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){T.info("clearing queue '%s'",e);for(var r;r=this.removeNextEvent(e);)r.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}var nT=20;class fN{constructor(e){var t=this;this.client=e,y(this,"sending",!1),y(this,"running",!0),y(this,"retryTimeout",null),y(this,"retryAttempts",0),y(this,"sendQueue",R(function*(){if(t.retryTimeout!==null&&clearTimeout(t.retryTimeout),t.retryTimeout=null,!(t.sending||!t.running)){T.debug("Attempting to send queued to-device messages"),t.sending=!0;var r;try{for(;t.running&&(r=yield t.client.store.getOldestToDeviceBatch(),r!==null);)yield t.sendBatch(r),yield t.client.store.removeToDeviceBatch(r.id),t.retryAttempts=0;if(!t.running)return;T.debug("All queued to-device messages sent")}catch(s){++t.retryAttempts;var n=$o.RETRY_BACKOFF_RATELIMIT(null,t.retryAttempts,s);if(n===-1){Math.floor(s.httpStatus/100)===4?(T.error("Fatal error when sending to-device message - dropping to-device batch!",s),yield t.client.store.removeToDeviceBatch(r.id)):T.info("Automatic retry limit reached for to-device messages.");return}T.info("Failed to send batch of to-device messages. Will retry in ".concat(n,"ms"),s),t.retryTimeout=setTimeout(t.sendQueue,n)}finally{t.sending=!1}}})),y(this,"onResumedSync",(r,n)=>{r===bt.Syncing&&n!==bt.Syncing&&(T.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(Pe.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(Pe.Sync,this.onResumedSync)}queueBatch(e){var t=this;return R(function*(){for(var r=[],n=0;n<e.batch.length;n+=nT){var s={eventType:e.eventType,batch:e.batch.slice(n,n+nT),txnId:t.client.makeTxnId()};r.push(s);var l=s.batch.map(c=>"".concat(c.userId,"/").concat(c.deviceId," (msgid ").concat(c.payload[Fr],")"));T.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(s.txnId),l)}yield t.client.store.saveToDeviceBatches(r),t.sendQueue()})()}sendBatch(e){var t=this;return R(function*(){var r=new Xt(()=>new Map);for(var n of e.batch)r.getOrCreate(n.userId).set(n.deviceId,n.payload);T.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,r,e.txnId)})()}}var jg=new tn.UnstableValue("m.policies","org.matrix.msc3847.policies"),Yd=new tn.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),iT=(function(a){return a.Ban="m.ban",a})({}),Fo=(function(a){return a.User="m.policy.user",a.Room="m.policy.room",a.Server="m.policy.server",a})({}),aT={[Fo.User]:$.PolicyRuleUser,[Fo.Room]:$.PolicyRuleRoom,[Fo.Server]:$.PolicyRuleServer};class hN{constructor(e){this.client=e}addRule(e,t,r){var n=this;return R(function*(){var s=yield n.getOrCreateTargetRoom(),l=yield n.client.sendStateEvent(s.roomId,aT[e],{entity:t,reason:r,recommendation:iT.Ban});return l.event_id})()}removeRule(e){var t=this;return R(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return R(function*(){yield t.client.joinRoom(e);var r=(yield t.getOrCreateSourceRooms()).map(n=>n.roomId);return r.includes(e)?!1:(r.push(e),yield t.withIgnoreInvitesPolicies(n=>{n.sources=r}),!0)})()}getRuleForInvite(e){var t=this;return R(function*(){var{sender:r,roomId:n}=e,s=yield t.getOrCreateSourceRooms(),l=r.split(":")[1],c=n.split(":")[1];for(var d of s){var h=d.getUnfilteredTimelineSet().getLiveTimeline().getState(ke.FORWARDS);for(var{scope:v,entities:p}of[{scope:Fo.Room,entities:[n]},{scope:Fo.User,entities:[r]},{scope:Fo.Server,entities:[l,c]}]){var m=h.getStateEvents(aT[v]);for(var _ of m){var b=_.getContent();if((b==null?void 0:b.recommendation)==iT.Ban){var E=b==null?void 0:b.entity;if(E){var M=void 0;try{M=new RegExp(pw(E))}catch{continue}for(var O of p)if(O&&M.test(O))return _}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return R(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.target;if(typeof r!="string"&&(r=null),r){var n=e.client.getRoom(r);if(n)return n;r=null}return r=(yield e.client.createRoom({name:"Individual Policy Room",preset:Im.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(s=>{s.target=r}),e.client.getRoom(r)})()}getOrCreateSourceRooms(){var e=this;return R(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.sources,n=!1;Array.isArray(r)||(n=!0,r=[]);var s=r.filter(c=>typeof c=="string").map(c=>e.client.getRoom(c)).filter(c=>!!c);if(s.length!=r.length&&(n=!0),s.length==0){var l=yield e.getOrCreateTargetRoom();n=!0,s=[l]}return n&&(yield e.withIgnoreInvitesPolicies(c=>{c.sources=r})),s})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return R(function*(){var{policies:r,ignoreInvitesPolicies:n}=t.getPoliciesAndIgnoreInvitesPolicies();e(n),r[Yd.name]=n,yield t.client.setAccountData(jg.name,r)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[jg.name,jg.altName]){var r;if(t){var n=(r=this.client.getAccountData(t))===null||r===void 0?void 0:r.getContent();if(n){e=n;break}}}var s={},l=!1;for(var c of[Yd.name,Yd.altName])if(c){var d=e[c];if(d&&typeof d=="object"){s=d,l=!0;break}}return l||(e[Yd.name]=s),{policies:e,ignoreInvitesPolicies:s}}}var Fg="matrix-js-sdk",cf=(function(a){return a.Cancel="cancel",a.Restart="restart",a.Send="send",a})({}),kR=a=>a.type==="livekit"&&"focus_selection"in a,vN=(a,e)=>{var t,r="Malformed session membership event: ";return typeof a.device_id!="string"&&e.push(r+"device_id must be string"),typeof a.call_id!="string"&&e.push(r+"call_id must be string"),typeof a.application!="string"&&e.push(r+"application must be a string"),typeof((t=a.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(r+"focus_active.type must be a string"),Array.isArray(a.foci_preferred)||e.push(r+"foci_preferred must be an array"),a.created_ts&&typeof a.created_ts!="number"&&e.push(r+"created_ts must be number"),a.scope&&typeof a.scope!="string"&&e.push(r+"scope must be string"),e.length===0},ka=a=>"membershipID"in a,gN=(a,e)=>{var t="Malformed legacy rtc membership event: ";return"expires"in a||"expires_ts"in a||e.push(t+"expires_ts or expires must be present"),"expires"in a&&typeof a.expires!="number"&&e.push(t+"expires must be numeric"),"expires_ts"in a&&typeof a.expires_ts!="number"&&e.push(t+"expires_ts must be numeric"),typeof a.device_id!="string"&&e.push(t+"device_id must be string"),typeof a.call_id!="string"&&e.push(t+"call_id must be string"),typeof a.application!="string"&&e.push(t+"application must be a string"),typeof a.membershipID!="string"&&e.push(t+"membershipID must be a string"),a.created_ts&&typeof a.created_ts!="number"&&e.push(t+"created_ts must be number"),a.scope&&typeof a.scope!="string"&&e.push(t+"scope must be string"),e.length===0};class Su{static equal(e,t){return Ms(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,y(this,"membershipData",void 0);var r=[],n=[];if(!vN(t,r)&&!gN(t,n))throw Error("unknown CallMembership data. Does not match legacy call.member (".concat(n.join(" & "),") events nor MSC4143 (").concat(r.join(" & "),")"));this.membershipData=t}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return ka(this.membershipData)?this.membershipData.membershipID:this.createdTs().toString()}createdTs(){var e;return(e=this.membershipData.created_ts)!==null&&e!==void 0?e:this.parentEvent.getTs()}getAbsoluteExpiry(){if(ka(this.membershipData))return"expires"in this.membershipData?this.createdTs()+this.membershipData.expires:this.membershipData.expires_ts}getLocalExpiry(){if(ka(this.membershipData))if("expires"in this.membershipData){var e=this.parentEvent.getTs()-this.createdTs(),t=this.parentEvent.localTimestamp-e;return t+this.membershipData.expires}else return this.membershipData.expires_ts}getMsUntilExpiry(){if(ka(this.membershipData))return this.getAbsoluteExpiry()-Date.now()}isExpired(){return ka(this.membershipData)?this.getMsUntilExpiry()<=0:!1}getPreferredFoci(){var e;return ka(this.membershipData)?(e=this.membershipData.foci_active)!==null&&e!==void 0?e:[]:this.membershipData.foci_preferred}getFocusSelection(){if(ka(this.membershipData))return"oldest_membership";var e=this.membershipData.focus_active;if(kR(e))return e.focus_selection}}function sT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function pN(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?sT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):sT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var Qe=T.getChild("MatrixRTCSession"),df=(a,e)=>"".concat(a,":").concat(e),qg=a=>df(a.sender,a.deviceId);function mN(a,e){return a===e?!0:!!a&&!!e&&a.length===e.length&&a.every((t,r)=>t===e[r])}var Oo=(function(a){return a.MembershipsChanged="memberships_changed",a.JoinStateChanged="join_state_changed",a.EncryptionKeyChanged="encryption_key_changed",a})({});class qo extends Pt{get membershipExpiryTimeout(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipExpiryTimeout)!==null&&e!==void 0?e:3600*1e3}get memberEventCheckPeriod(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.memberEventCheckPeriod)!==null&&e!==void 0?e:120*1e3}get callMemberEventRetryDelayMinimum(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.callMemberEventRetryDelayMinimum)!==null&&e!==void 0?e:3e3}get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}get membershipServerSideExpiryTimeout(){var e,t,r;return(e=(t=this.membershipServerSideExpiryTimeoutOverride)!==null&&t!==void 0?t:(r=this.joinConfig)===null||r===void 0?void 0:r.membershipServerSideExpiryTimeout)!==null&&e!==void 0?e:8e3}get membershipKeepAlivePeriod(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipKeepAlivePeriod)!==null&&e!==void 0?e:5e3}get callMemberEventRetryJitter(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.callMemberEventRetryJitter)!==null&&e!==void 0?e:2e3}get callId(){return this._callId}static callMembershipsForRoom(e){var t=e.getLiveTimeline().getState(ke.FORWARDS);if(!t)throw Qe.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var r=t.getStateEvents($.GroupCallMemberPrefix),n=[];for(var s of r){var l=s.getContent(),c=Object.keys(l).length;if(c!==0){var d=[];if(c>1&&"focus_active"in l)d.push(l);else if(c===1&&"memberships"in l){if(!Array.isArray(l.memberships)){Qe.warn("Malformed member event from ".concat(s.getSender(),": memberships is not an array"));continue}d=l.memberships}if(d.length!==0)for(var h of d)try{var v,p=new Su(s,h);if(p.callId!==""||p.scope!=="m.room"){Qe.info("Ignoring user-scoped call");continue}if(p.isExpired()){Qe.info("Ignoring expired device membership ".concat(p.sender,"/").concat(p.deviceId));continue}if(!e.hasMembershipState((v=p.sender)!==null&&v!==void 0?v:"",We.Join)){Qe.info("Ignoring membership of user ".concat(p.sender," who is not in the room."));continue}n.push(p)}catch(m){Qe.warn("Couldn't construct call membership: ",m)}}}return n.sort((m,_)=>m.createdTs()-_.createdTs()),n.length>1&&Qe.debug("Call memberships in room ".concat(e.roomId,", in order: "),n.map(m=>[m.createdTs(),m.sender])),n}static roomSessionForRoom(e,t){var r=qo.callMembershipsForRoom(t);return new qo(e,t,r)}constructor(e,t,r){var n,s;super(),n=this,this.client=e,this.room=t,this.memberships=r,y(this,"_callId",void 0),y(this,"relativeExpiry",void 0),y(this,"joinConfig",void 0),y(this,"membershipServerSideExpiryTimeoutOverride",void 0),y(this,"membershipId",void 0),y(this,"memberEventTimeout",void 0),y(this,"expiryTimeout",void 0),y(this,"keysEventUpdateTimeout",void 0),y(this,"makeNewKeyTimeout",void 0),y(this,"setNewKeyTimeouts",new Set),y(this,"ownFocusActive",void 0),y(this,"ownFociPreferred",void 0),y(this,"updateCallMembershipRunning",!1),y(this,"needCallMembershipUpdate",!1),y(this,"manageMediaKeys",!1),y(this,"useLegacyMemberEvents",!0),y(this,"encryptionKeys",new Map),y(this,"lastEncryptionKeyUpdateRequest",void 0),y(this,"disconnectDelayId",void 0),y(this,"lastMembershipFingerprints",void 0),y(this,"currentEncryptionKeyIndex",-1),y(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),y(this,"sendEncryptionKeysEvent",(function(){var c=R(function*(d){if(n.keysEventUpdateTimeout!==void 0&&(clearTimeout(n.keysEventUpdateTimeout),n.keysEventUpdateTimeout=void 0),n.lastEncryptionKeyUpdateRequest=Date.now(),!!n.isJoined()){Qe.info("Sending encryption keys event. indexToSend=".concat(d));var h=n.client.getUserId(),v=n.client.getDeviceId();if(!h)throw new Error("No userId");if(!v)throw new Error("No deviceId");var p=n.getKeysForParticipant(h,v);if(!p){Qe.warn("Tried to send encryption keys event but no keys found!");return}if(typeof d!="number"&&n.currentEncryptionKeyIndex===-1){Qe.warn("Tried to send encryption keys event but no current key index found!");return}var m=d??n.currentEncryptionKeyIndex,_=p[m];try{var b={keys:[{index:m,key:Vf(_)}],device_id:v,call_id:"",sent_ts:Date.now()};n.statistics.counters.roomEventEncryptionKeysSent+=1,yield n.client.sendEvent(n.room.roomId,$.CallEncryptionKeysPrefix,b),Qe.debug("Embedded-E2EE-LOG updateEncryptionKeyEvent participantId=".concat(h,":").concat(v," numKeys=").concat(p.length," currentKeyIndex=").concat(n.currentEncryptionKeyIndex," keyIndexToSend=").concat(m),n.encryptionKeys)}catch(O){var E=O;if(E.event&&n.client.cancelPendingEvent(E.event),n.keysEventUpdateTimeout===void 0){var M=dm(E,5e3);Qe.warn("Failed to send m.call.encryption_key, retrying in ".concat(M),O),n.keysEventUpdateTimeout=setTimeout(n.sendEncryptionKeysEvent,M)}else Qe.info("Not scheduling key resend as another re-send is already pending")}}});return function(d){return c.apply(this,arguments)}})()),y(this,"onCallEncryption",c=>{var d=c.getSender(),h=c.getContent(),v=h.device_id,p=h.call_id;if(!d){Qe.warn("Received m.call.encryption_keys with no userId: callId=".concat(p));return}if(p!==""){Qe.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(d,", deviceId=").concat(v,", callId=").concat(p));return}if(!Array.isArray(h.keys)){Qe.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(p));return}if(d===this.client.getUserId()&&v===this.client.getDeviceId()){Qe.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var m=Date.now()-(typeof h.sent_ts=="number"?h.sent_ts:c.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=m;for(var _ of h.keys){if(!_){Qe.info("Ignoring false-y key in keys event");continue}var b=_.key,E=_.index;!b||E===void 0||E===null||p===void 0||p===null||typeof v!="string"||typeof p!="string"||typeof b!="string"||typeof E!="number"?Qe.warn("Malformed call encryption_key: userId=".concat(d,", deviceId=").concat(v,", encryptionKeyIndex=").concat(E," callId=").concat(p)):(Qe.debug("Embedded-E2EE-LOG onCallEncryption userId=".concat(d,":").concat(v," encryptionKeyIndex=").concat(E," age=").concat(m,"ms"),this.encryptionKeys),this.setEncryptionKey(d,v,E,b,c.getTs()))}}),y(this,"isMyMembership",c=>c.sender===this.client.getUserId()&&c.deviceId===this.client.getDeviceId()),y(this,"onMembershipUpdate",()=>{var c,d,h=this.memberships;this.memberships=qo.callMembershipsForRoom(this.room),this._callId=(c=this._callId)!==null&&c!==void 0?c:(d=this.memberships[0])===null||d===void 0?void 0:d.callId;var v=h.length!=this.memberships.length||h.some((C,U)=>!Su.equal(C,this.memberships[U]));if(v&&(Qe.info("Memberships for call in room ".concat(this.room.roomId," have changed: emitting")),this.emit(Oo.MembershipsChanged,h,this.memberships),this.isJoined()&&!this.memberships.some(this.isMyMembership)&&(Qe.warn("Missing own membership: force re-join"),this.triggerCallMembershipEventUpdate())),this.manageMediaKeys&&this.isJoined()&&this.makeNewKeyTimeout===void 0){var p=new Set(h.filter(C=>!this.isMyMembership(C)).map(qg)),m=new Set(this.memberships.filter(C=>!this.isMyMembership(C)).map(qg)),_=Array.from(p).some(C=>!m.has(C)),b=Array.from(m).some(C=>!p.has(C)),E=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),_)Qe.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay);else if(b)Qe.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(E){var M=this.lastMembershipFingerprints,O=Array.from(E).some(C=>!M.has(C))||Array.from(M).some(C=>!E.has(C));O&&(Qe.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}this.setExpiryTimer()}),y(this,"triggerCallMembershipEventUpdate",R(function*(){if(n.updateCallMembershipRunning){n.needCallMembershipUpdate=!0;return}n.updateCallMembershipRunning=!0;try{do n.needCallMembershipUpdate=!1,yield n.updateCallMembershipEvent();while(n.needCallMembershipUpdate)}finally{n.updateCallMembershipRunning=!1}})),y(this,"delayDisconnection",R(function*(){try{var c=n.disconnectDelayId;yield ko(()=>n.client._unstable_updateDelayedEvent(c,cf.Restart)),n.scheduleDelayDisconnection()}catch(d){Qe.error("Failed to delay our disconnection event:",d)}})),y(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,Qe.info("Making new sender key for key rotation");var c=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(c)}}),this._callId=(s=r[0])===null||s===void 0?void 0:s.callId;var l=this.room.getLiveTimeline().getState(ke.FORWARDS);l==null||l.on($e.Members,this.onMembershipUpdate),this.setExpiryTimer()}isJoined(){return this.relativeExpiry!==void 0}stop(){var e=this;return R(function*(){yield e.leaveRoomSession(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0),e.memberEventTimeout&&(clearTimeout(e.memberEventTimeout),e.memberEventTimeout=void 0);var t=e.room.getLiveTimeline().getState(ke.FORWARDS);t==null||t.off($e.Members,e.onMembershipUpdate)})()}joinRoomSession(e,t,r){var n,s;if(this.isJoined()){Qe.info("Already joined to session in room ".concat(this.room.roomId,": ignoring join call"));return}this.ownFocusActive=t,this.ownFociPreferred=e,this.joinConfig=r,this.relativeExpiry=this.membershipExpiryTimeout,this.manageMediaKeys=(n=r==null?void 0:r.manageMediaKeys)!==null&&n!==void 0?n:this.manageMediaKeys,this.useLegacyMemberEvents=(s=r==null?void 0:r.useLegacyMemberEvents)!==null&&s!==void 0?s:this.useLegacyMemberEvents,this.membershipId=Qn(5),Qe.info("Joining call session in room ".concat(this.room.roomId," with manageMediaKeys=").concat(this.manageMediaKeys)),r!=null&&r.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey()),this.triggerCallMembershipEventUpdate(),this.emit(Oo.JoinStateChanged,!0)}leaveRoomSession(){var e=arguments,t=this;return R(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return Qe.info("Not joined to session in room ".concat(t.room.roomId,": ignoring leave call")),!1;var n=t.client.getUserId(),s=t.client.getDeviceId();if(!n)throw new Error("No userId");if(!s)throw new Error("No deviceId");t.encryptionKeys.set(df(n,s),[]),t.makeNewKeyTimeout!==void 0&&(clearTimeout(t.makeNewKeyTimeout),t.makeNewKeyTimeout=void 0);for(var l of t.setNewKeyTimeouts)clearTimeout(l);if(t.setNewKeyTimeouts.clear(),Qe.info("Leaving call session in room ".concat(t.room.roomId)),t.joinConfig=void 0,t.relativeExpiry=void 0,t.ownFocusActive=void 0,t.manageMediaKeys=!1,t.membershipId=void 0,t.emit(Oo.JoinStateChanged,!1),r){var c=yield Promise.race([t.triggerCallMembershipEventUpdate(),Ba(r,"timeout")]);return c!=="timeout"}else return yield t.triggerCallMembershipEventUpdate(),!0})()}getActiveFocus(){if(this.ownFocusActive&&kR(this.ownFocusActive)&&this.ownFocusActive.focus_selection==="oldest_membership"){var e=this.getOldestMembership();return e==null?void 0:e.getPreferredFoci()[0]}if(!this.ownFocusActive){var t=this.getOldestMembership();return t==null?void 0:t.getPreferredFoci()[0]}}reemitEncryptionKeys(){this.encryptionKeys.forEach((e,t)=>{e.forEach((r,n)=>{this.emit(Oo.EncryptionKeyChanged,r.key,n,t)})})}getKeysForParticipant(e,t){return this.getKeysForParticipantInternal(e,t)}getKeysForParticipantInternal(e,t){var r;return(r=this.encryptionKeys.get(df(e,t)))===null||r===void 0?void 0:r.map(n=>n.key)}getEncryptionKeys(){return Array.from(this.encryptionKeys.entries()).map(e=>{var[t,r]=e;return[t,r.map(n=>n.key)]}).values()}getNewEncryptionKeyIndex(){return this.currentEncryptionKeyIndex===-1?0:(this.currentEncryptionKeyIndex+1)%256}setEncryptionKey(e,t,r,n,s){var l=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,c=Ar(n),d=df(e,t);this.encryptionKeys.has(d)||this.encryptionKeys.set(d,[]);var h=this.encryptionKeys.get(d),v=h[r];if(v){if(v.timestamp>s){Qe.info("Ignoring new key at index ".concat(r," for ").concat(d," as it is older than existing known key"));return}if(mN(v.key,c)){v.timestamp=s;return}}if(h[r]={key:c,timestamp:s},l){var p=setTimeout(()=>{this.setNewKeyTimeouts.delete(p),Qe.info("Delayed-emitting key changed event for ".concat(d," idx ").concat(r)),e===this.client.getUserId()&&t===this.client.getDeviceId()&&(this.currentEncryptionKeyIndex=r),this.emit(Oo.EncryptionKeyChanged,c,r,d)},this.useKeyDelay);this.setNewKeyTimeouts.add(p)}else e===this.client.getUserId()&&t===this.client.getDeviceId()&&(this.currentEncryptionKeyIndex=r),this.emit(Oo.EncryptionKeyChanged,c,r,d)}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.client.getUserId(),r=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!r)throw new Error("No deviceId");var n=FA(16),s=this.getNewEncryptionKeyIndex();return Qe.info("Generated new key at index "+s),this.setEncryptionKey(t,r,s,n,Date.now(),e),s}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){Qe.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var r=t.getMsUntilExpiry();r!==void 0&&(e===void 0||r<e)&&(e=r)}e!=null&&(this.expiryTimeout=setTimeout(this.onMembershipUpdate,e))}getOldestMembership(){return this.memberships[0]}getFocusInUse(){var e=this.getOldestMembership();if((e==null?void 0:e.getFocusSelection())==="oldest_membership")return e.getPreferredFoci()[0]}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.memberships.filter(e=>!this.isMyMembership(e)).map(e=>"".concat(qg(e),":").concat(e.membershipID,":").concat(e.createdTs())))}makeMyMembershipLegacy(e,t){if(this.relativeExpiry===void 0)throw new Error("Tried to create our own membership event when we're not joined!");if(this.membershipId===void 0)throw new Error("Tried to create our own membership event when we have no membership ID!");var r=t==null?void 0:t.createdTs();return pN({call_id:"",scope:"m.room",application:"m.call",device_id:e,expires:this.relativeExpiry,expires_ts:this.relativeExpiry+(r??Date.now()),foci_active:this.ownFociPreferred,membershipID:this.membershipId},r?{created_ts:r}:{})}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.ownFociPreferred)!==null&&t!==void 0?t:[]}}membershipEventNeedsUpdate(e,t){if(t&&t.getMsUntilExpiry()===void 0)return!1;if(!this.isJoined())return!!e;if(!t)return!0;var r=t.getMsUntilExpiry();return r!==void 0&&r<this.membershipExpiryTimeout/2?(this.relativeExpiry+=this.membershipExpiryTimeout,!0):!1}makeNewMembership(e){return this.isJoined()?this.makeMyMembership(e):{}}makeNewLegacyMemberships(e,t,r,n){var s=d=>{var h;try{h=new Su(r,d)}catch{return!1}return!h.isExpired()},l=d=>(d.created_ts===void 0&&(d.created_ts=r.getTs()),d),c=e.filter(s).filter(d=>d.device_id!==t);return c=c.map(l),this.isJoined()&&c.push(this.makeMyMembershipLegacy(t,n)),{memberships:c}}updateCallMembershipEvent(){var e=this;return R(function*(){e.memberEventTimeout&&(clearTimeout(e.memberEventTimeout),e.memberEventTimeout=void 0);var t=e.room.getLiveTimeline().getState(ke.FORWARDS);if(!t)throw new Error("Couldn't get room state for room "+e.room.roomId);var r=e.client.getUserId(),n=e.client.getDeviceId();if(!r||!n)throw new Error("User ID or device ID was null!");var s=t.events.get($.GroupCallMemberPrefix),l=e.stateEventsContainOngoingLegacySession(s),c={};if(l){var d,h=s==null?void 0:s.get(r),v=(d=h==null?void 0:h.getContent())!==null&&d!==void 0?d:{},p,m=Array.isArray(v.memberships)?v.memberships:[],_=m.find(I=>I.device_id===n);try{h&&_&&ka(_)&&_.membershipID===e.membershipId&&(p=new Su(h,_))}catch(I){Qe.warn("Our previous call membership was invalid - this shouldn't happen.",I)}if(p&&Qe.debug("".concat(p.getMsUntilExpiry()," until our membership expires")),!e.membershipEventNeedsUpdate(_,p)){e.memberEventTimeout=setTimeout(e.triggerCallMembershipEventUpdate,e.memberEventCheckPeriod);return}c=e.makeNewLegacyMemberships(m,n,h,p)}else c=e.makeNewMembership(n);try{if(l)yield e.client.sendStateEvent(e.room.roomId,$.GroupCallMemberPrefix,c,r),e.isJoined()&&(e.memberEventTimeout=setTimeout(e.triggerCallMembershipEventUpdate,e.memberEventCheckPeriod));else if(e.isJoined()){var b=e.makeMembershipStateKey(r,n),E=(function(){var I=R(function*(){try{var D=yield ko(()=>e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.membershipServerSideExpiryTimeout},$.GroupCallMemberPrefix,{},b));e.disconnectDelayId=D.delay_id}catch(N){if(N instanceof hr&&N.errcode==="M_UNKNOWN"&&N.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var w=N.data["org.matrix.msc4140.max_delay"];if(typeof w=="number"&&e.membershipServerSideExpiryTimeout>w)return e.membershipServerSideExpiryTimeoutOverride=w,E()}Qe.error("Failed to prepare delayed disconnection event:",N)}});return function(){return I.apply(this,arguments)}})();if(yield E(),yield ko(()=>e.client.sendStateEvent(e.room.roomId,$.GroupCallMemberPrefix,c,b)),e.disconnectDelayId!==void 0)try{var M=e.disconnectDelayId;yield ko(()=>e.client._unstable_updateDelayedEvent(M,cf.Restart))}catch(I){Qe.warn("Failed to update delayed disconnection event, prepare it again:",I),e.disconnectDelayId=void 0,yield E()}e.disconnectDelayId!==void 0&&e.scheduleDelayDisconnection()}else{var O=!1;if(e.disconnectDelayId!==void 0){try{var C=e.disconnectDelayId;yield ko(()=>e.client._unstable_updateDelayedEvent(C,cf.Send)),O=!0}catch(I){Qe.error("Failed to send our delayed disconnection event:",I)}e.disconnectDelayId=void 0}O||(yield ko(()=>e.client.sendStateEvent(e.room.roomId,$.GroupCallMemberPrefix,{},e.makeMembershipStateKey(r,n))))}Qe.info("Sent updated call member event.")}catch(I){var U=e.callMemberEventRetryDelayMinimum+Math.random()*e.callMemberEventRetryJitter;Qe.warn("Failed to send call member event (retrying in ".concat(U,"): ").concat(I)),yield Ba(U),yield e.triggerCallMembershipEventUpdate()}})()}scheduleDelayDisconnection(){this.memberEventTimeout=setTimeout(this.delayDisconnection,this.membershipKeepAlivePeriod)}stateEventsContainOngoingLegacySession(e){if(!(e!=null&&e.size))return this.useLegacyMemberEvents;var t=!1,r=!1;for(var n of e.values()){var s=n.getContent();if(Array.isArray(s.memberships)){for(var l of s.memberships)if(!new Su(n,l).isExpired())return!0}else Object.keys(s).length>0&&(t||(t=!0),r||(r=!("focus_active"in s)))}return t&&!r?!1:this.useLegacyMemberEvents}makeMembershipStateKey(e,t){var r="".concat(e,"_").concat(t);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?r:"_".concat(r)}}function ko(a){return Gp.apply(this,arguments)}function Gp(){return Gp=R(function*(a){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;;)try{return yield a()}catch(s){if(e>0&&s instanceof Yo&&s.isRateLimitError()){e--;var t=void 0,r=5e3;try{var n;t=(n=s.getRetryAfterMs())!==null&&n!==void 0?n:r,Qe.info("Rate limited by server, retrying in ".concat(t,"ms"))}catch(l){Qe.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(r),l),t=r}yield Ba(t)}else throw s}}),Gp.apply(this,arguments)}var bu=T.getChild("MatrixRTCSessionManager"),oT=(function(a){return a.SessionStarted="session_started",a.SessionEnded="session_ended",a})({});class yN extends Pt{constructor(e){super(),this.client=e,y(this,"roomSessions",new Map),y(this,"onTimeline",t=>{this.consumeCallEncryptionEvent(t)}),y(this,"onRoom",t=>{this.refreshRoom(t)}),y(this,"onRoomState",(t,r)=>{var n=this.client.getRoom(t.getRoomId());if(!n){bu.error("Got room state event for unknown room ".concat(t.getRoomId(),"!"));return}t.getType()==$.GroupCallMemberPrefix&&this.refreshRoom(n)})}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,r=qo.roomSessionForRoom(this.client,e);r.memberships.length>0&&this.roomSessions.set(e.roomId,r)}this.client.on(Pe.Room,this.onRoom),this.client.on(Ue.Timeline,this.onTimeline),this.client.on($e.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(Pe.Room,this.onRoom),this.client.off(Ue.Timeline,this.onTimeline),this.client.off($e.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,qo.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}consumeCallEncryptionEvent(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield r.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){n?bu.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(bu.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>r.consumeCallEncryptionEvent(e,!0),1e3));return}else n&&bu.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==$.CallEncryptionKeysPrefix)return Promise.resolve();var s=r.client.getRoom(e.getRoomId());if(!s)return bu.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();r.getRoomSession(s).onCallEncryption(e)})()}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),r=this.getRoomSession(e),n=r.memberships.length>0&&!t;r.onMembershipUpdate();var s=r.memberships.length>0;n&&!s?this.emit(oT.SessionEnded,e.roomId,this.roomSessions.get(e.roomId)):!n&&s&&this.emit(oT.SessionStarted,e.roomId,this.roomSessions.get(e.roomId))}}function Vg(a){return e=>{var t,r;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==a||((r=e.content)===null||r===void 0||(r=r["m.relates_to"])===null||r===void 0?void 0:r.rel_type)===Ot.name}}function AR(a){return Hp.apply(this,arguments)}function Hp(){return Hp=R(function*(a){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(a),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return t}),Hp.apply(this,arguments)}var SN=["server","limit","since"];function lT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Ir(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?lT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):lT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var bN=3e3,_N=wR(),uT=600*1e3,EN=new Wt("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),Zo=(function(a){return a.Chronological="chronological",a.Detached="detached",a})({}),TN=new Pf("m.get_login_token","org.matrix.msc3882.get_login_token"),DR="uk.half-shot.msc2666",MR="uk.half-shot.msc2666.mutual_rooms",NR="uk.half-shot.msc2666.query_mutual_rooms",di="org.matrix.msc4140",UR="uk.tcpip.msc4133",ni="$",Pe=(function(a){return a.Sync="sync",a.Event="event",a.ToDeviceEvent="toDeviceEvent",a.AccountData="accountData",a.Room="Room",a.DeleteRoom="deleteRoom",a.SyncUnexpectedError="sync.unexpectedError",a.ClientWellKnown="WellKnown.client",a.ReceivedVoipEvent="received_voip_event",a.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",a.TurnServers="turnServers",a.TurnServersError="turnServers.error",a})({}),wN=new Wt("action","org.matrix.msc3824.action");class ll extends Pt{constructor(e){var t,r,n,s;super(),n=this,y(this,"logger",void 0),y(this,"reEmitter",new al(this)),y(this,"olmVersion",null),y(this,"usingExternalCrypto",!1),y(this,"_store",void 0),y(this,"deviceId",void 0),y(this,"credentials",void 0),y(this,"pickleKey",void 0),y(this,"scheduler",void 0),y(this,"clientRunning",!1),y(this,"timelineSupport",!1),y(this,"urlPreviewCache",{}),y(this,"identityServer",void 0),y(this,"http",void 0),y(this,"crypto",void 0),y(this,"cryptoBackend",void 0),y(this,"cryptoCallbacks",void 0),y(this,"callEventHandler",void 0),y(this,"groupCallEventHandler",void 0),y(this,"supportsCallTransfer",!1),y(this,"forceTURN",!1),y(this,"iceCandidatePoolSize",0),y(this,"idBaseUrl",void 0),y(this,"baseUrl",void 0),y(this,"isVoipWithNoMediaAllowed",void 0),y(this,"useLivekitForGroupCalls",void 0),y(this,"canSupportVoip",!1),y(this,"peekSync",null),y(this,"isGuestAccount",!1),y(this,"ongoingScrollbacks",{}),y(this,"notifTimelineSet",null),y(this,"cryptoStore",void 0),y(this,"verificationMethods",void 0),y(this,"fallbackICEServerAllowed",!1),y(this,"syncApi",void 0),y(this,"roomNameGenerator",void 0),y(this,"pushRules",void 0),y(this,"syncLeftRoomsPromise",void 0),y(this,"syncedLeftRooms",!1),y(this,"clientOpts",void 0),y(this,"clientWellKnownIntervalID",void 0),y(this,"canResetTimelineCallback",void 0),y(this,"canSupport",new Map),y(this,"pushProcessor",new Gn(this)),y(this,"serverVersionsPromise",void 0),y(this,"clientWellKnown",void 0),y(this,"clientWellKnownPromise",void 0),y(this,"turnServers",[]),y(this,"turnServersExpiry",0),y(this,"checkTurnServersIntervalID",void 0),y(this,"exportedOlmDeviceToImport",void 0),y(this,"txnCtr",0),y(this,"mediaHandler",new iN(this)),y(this,"sessionId",void 0),y(this,"eventsBeingEncrypted",new Set),y(this,"useE2eForGroupCall",!0),y(this,"toDeviceMessageQueue",void 0),y(this,"livekitServiceURL",void 0),y(this,"_secretStorage",void 0),y(this,"ignoredInvites",void 0),y(this,"matrixRTC",void 0),y(this,"serverCapabilitiesService",void 0),y(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(bp()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(Pe.Sync,this.startCallEventHandler))}),y(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(Pe.Sync,this.startMatrixRTC))}),y(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var c,d=((c=this.getRooms())!==null&&c!==void 0?c:[]).filter(p=>p.getUnreadNotificationCount(pt.Total)>0);for(var h of d){var v=this.getSafeUserId();h.fixupNotifications(v)}this.off(Pe.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:T,e.baseUrl=Rg(e.baseUrl),e.idBaseUrl=Rg(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(r=e.usingExternalCrypto)!==null&&r!==void 0?r:!1,this.store=e.store||new AA,this.deviceId=e.deviceId||null,this.sessionId=Qn(10);var l=e.userId||null;this.credentials={userId:l},this.http=new Jw(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:qt.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.deviceToImport?this.deviceId?this.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?this.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):this.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((function(){var c=R(function*(d){var h=n.getRoom(d.getRoomId());d.status!==Ve.SENDING&&n.updatePendingEventStatus(h,d,Ve.SENDING);var v=yield n.sendEventHttpRequest(d);return h&&h.updatePendingEvent(d,Ve.SENT,v.event_id),v});return function(d){return c.apply(this,arguments)}})()),bp()&&(this.callEventHandler=new YA(this),this.groupCallEventHandler=new JA(this),this.canSupportVoip=!0,this.on(Pe.Sync,this.startCallEventHandler)),this.matrixRTC=new yN(this),this.serverCapabilitiesService=new Xw(this.http),this.on(Pe.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new fN(this),this.on(ct.Decrypted,c=>{PR(this,c)}),this.ignoredInvites=new hN(this),this._secretStorage=new ac(this,(s=e.cryptoCallbacks)!==null&&s!==void 0?s:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>Wi.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return R(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(Pe.Sync,t.startMatrixRTC);var r=t.getUserId();r&&t.store.storeUser(new Wi(r)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},uT),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:n,list:s,fwdPagination:l}=yield t.doesServerSupportThread();Ut.setServerSideSupport(n),Ut.setServerSideListSupport(s),Ut.setServerSideFwdPaginationSupport(l)}catch(c){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",c)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new IR(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new Bu(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(c=>t.logger.info("Sync startup aborted with an error:",c)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1}}stopClient(){var e,t,r,n,s;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(Pe.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(r=this.peekSync)===null||r===void 0||r.stopPeeking(),(n=this.callEventHandler)===null||n===void 0||n.stop(),(s=this.groupCallEventHandler)===null||s===void 0||s.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}rehydrateDevice(){var e=this;return R(function*(){if(e.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(e.cryptoCallbacks.getDehydrationKey){var t=yield e.getDehydratedDevice();if(t){if(!t.device_data||!t.device_id){e.logger.info("no dehydrated device found");return}var r=new globalThis.Olm.Account;try{var n=t.device_data;if(n.algorithm!==lf){e.logger.warn("Wrong algorithm for dehydrated device");return}e.logger.debug("unpickling dehydrated device");var s=yield e.cryptoCallbacks.getDehydrationKey(n,d=>{r.unpickle(new Uint8Array(d),n.account)});r.unpickle(s,n.account),e.logger.debug("unpickled device");var l=yield e.http.authedRequest(se.Post,"/dehydrated_device/claim",void 0,{device_id:t.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"});if(l.success){e.deviceId=t.device_id,e.logger.info("using dehydrated device");var c=e.pickleKey||"DEFAULT_KEY";return e.exportedOlmDeviceToImport={pickledAccount:r.pickle(c),sessions:[],pickleKey:c},r.free(),e.deviceId}else{r.free(),e.logger.info("not using dehydrated device");return}}catch(d){r.free(),e.logger.warn("could not unpickle",d)}}}})()}getDehydratedDevice(){var e=this;return R(function*(){try{return yield e.http.authedRequest(se.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(t){e.logger.info("could not get dehydrated device",t);return}})()}setDehydrationKey(e,t,r){var n=this;return R(function*(){if(!n.crypto){n.logger.warn("not dehydrating device if crypto is not enabled");return}return n.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,r)})()}createDehydratedDevice(e,t,r){var n=this;return R(function*(){if(!n.crypto){n.logger.warn("not dehydrating device if crypto is not enabled");return}return yield n.crypto.dehydrationManager.setKey(e,t,r),n.crypto.dehydrationManager.dehydrateDevice()})()}exportDevice(){var e=this;return R(function*(){if(!e.crypto){e.logger.warn("not exporting device if crypto is not enabled");return}return{userId:e.credentials.userId,deviceId:e.deviceId,olmDevice:yield e.crypto.olmDevice.export()}})()}clearStores(){var e=this;if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var t=[];t.push(this.store.deleteAllData()),this.cryptoStore&&t.push(this.cryptoStore.deleteAllData());var r=(function(){var n=R(function*(){var s;try{if(s=globalThis.indexedDB,!s)return}catch{return}var l=function*(h){var v=new Promise((p,m)=>{e.logger.info("Removing IndexedDB instance ".concat(h));var _=s.deleteDatabase(h);_.onsuccess=b=>{e.logger.info("Removed IndexedDB instance ".concat(h)),p(0)},_.onerror=b=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(h,":"),b),p(0)},_.onblocked=b=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(h))}});yield v};for(var c of["".concat(Fg,"::matrix-sdk-crypto"),"".concat(Fg,"::matrix-sdk-crypto-meta")])yield*l(c)});return function(){return n.apply(this,arguments)}})();return t.push(r()),Promise.all(t).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return ic(this,e)}createGroupCall(e,t,r,n,s,l){var c=this;return R(function*(){if(c.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var d=c.getRoom(e);if(!d)throw new Error("Cannot find room ".concat(e));return new gm(c,d,t,r,n,void 0,s||c.isVoipWithNoMediaAllowed,l,c.isVoipWithNoMediaAllowed,c.useLivekitForGroupCalls,c.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===bt.Prepared||e===bt.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return R(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initCrypto(){var e=this;return R(function*(){if(!wR())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(e.cryptoBackend){e.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}if(!e.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");e.logger.debug("Crypto: Starting up crypto store..."),yield e.cryptoStore.startup();var t=e.getUserId();if(t===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(e.deviceId===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");var r=new Af(e,t,e.deviceId,e.store,e.cryptoStore,e.verificationMethods);e.reEmitter.reEmit(r,[at.KeyBackupFailed,at.KeyBackupSessionsRemaining,at.RoomKeyRequest,at.RoomKeyRequestCancellation,at.Warning,at.DevicesUpdated,at.WillUpdateDevices,at.DeviceVerificationChanged,at.UserTrustStatusChanged,at.KeysChanged]),e.logger.debug("Crypto: initialising crypto object..."),yield r.init({exportedOlmDevice:e.exportedOlmDeviceToImport,pickleKey:e.pickleKey}),delete e.exportedOlmDeviceToImport,e.olmVersion=Af.getOlmVersion(),r.registerEventHandlers(e),e.cryptoBackend=e.crypto=r,e.crypto.uploadDeviceKeys().catch(n=>{e.logger.error("Error uploading device keys",n)})})()}initRustCrypto(){var e=arguments,t=this;return R(function*(){var r,n=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var s=t.getUserId();if(s===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var l=t.getDeviceId();if(l===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var c=yield Vk(()=>import("./index-dP4JXSAJ.js"),[]),d=yield c.initRustCrypto({logger:t.logger,http:t.http,userId:s,deviceId:l,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:n.useIndexedDB===!1?null:Fg,storeKey:n.storageKey,storePassphrase:n.storagePassword,legacyCryptoStore:t.cryptoStore,legacyPickleKey:(r=t.pickleKey)!==null&&r!==void 0?r:"DEFAULT_KEY",legacyMigrationProgressListener:(h,v)=>{t.emit(tr.LegacyCryptoStoreMigrationProgress,h,v)}});d.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=d,t.on(jr.Membership,d.onRoomMembership.bind(d)),t.on(Pe.Event,h=>{d.onLiveEventFromSync(h)}),t.reEmitter.reEmit(d,[tr.VerificationRequestReceived,tr.UserTrustStatusChanged,tr.KeyBackupStatus,tr.KeyBackupSessionsRemaining,tr.KeyBackupFailed,tr.KeyBackupDecryptionKeyCached,tr.KeysChanged,tr.DevicesUpdated,tr.WillUpdateDevices])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return(e=(t=this.crypto)===null||t===void 0?void 0:t.getDeviceEd25519Key())!==null&&e!==void 0?e:null}getDeviceCurve25519Key(){var e,t;return(e=(t=this.crypto)===null||t===void 0?void 0:t.getDeviceCurve25519Key())!==null&&e!==void 0?e:null}uploadKeys(){var e=this;return R(function*(){e.logger.warn("MatrixClient.uploadKeys is deprecated")})()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=this.setDeviceVerification(e,t,r,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return this.setDeviceVerification(e,t,null,r,null)}setDeviceKnown(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return this.setDeviceVerification(e,t,null,null,r)}setDeviceVerification(e,t,r,n,s){var l=this;return R(function*(){if(!l.crypto)throw new Error("End-to-end encryption disabled");yield l.crypto.setDeviceVerification(e,t,r,n,s)})()}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(this.cryptoBackend){if(!this.crypto)return}else throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,r)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Tm.Master;if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,r)}prepareToEncrypt(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.setTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}getEventSenderDeviceInfo(e){var t=this;return R(function*(){return t.crypto?t.crypto.getEventSenderDeviceInfo(e):null})()}isEventSenderVerified(e){var t=this;return R(function*(){var r=yield t.getEventSenderDeviceInfo(e);return r?r.isVerified():!1})()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");var t=e.getWireContent(),r={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return!r.session_id||!r.sender_key||!r.algorithm||!r.room_id?Promise.resolve(null):this.crypto.cryptoStore.getOutgoingRoomKeyRequest(r)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){var t,r,n=this.getRoom(e);return n?n.hasEncryptionStateEvent()?!0:(t=(r=this.crypto)===null||r===void 0?void 0:r.isRoomEncrypted(e))!==null&&t!==void 0?t:!1:!1}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw new Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}getKeyBackupVersion(){var e=this;return R(function*(){var t;try{t=yield e.http.authedRequest(se.Get,"/room_keys/version",void 0,void 0,{prefix:qt.V3})}catch(r){if(r.errcode==="M_NOT_FOUND")return null;throw r}return As.checkBackupVersion(t),t})()}isKeyBackupTrusted(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}prepareKeyBackupVersion(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{secureSecretStorage:!1};if(!r.crypto)throw new Error("End-to-end encryption disabled");var{algorithm:s,auth_data:l,recovery_key:c,privateKey:d}=yield r.crypto.backupManager.prepareKeyBackupVersion(e);return n.secureSecretStorage&&(yield r.secretStorage.store("m.megolm_backup.v1",Kr(d)),r.logger.info("Key backup private key stored in secret storage")),{algorithm:s,auth_data:l,recovery_key:c}})()}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}createKeyBackupVersion(e){var t=this;return R(function*(){if(!t.crypto)throw new Error("End-to-end encryption disabled");yield t.crypto.backupManager.createKeyBackupVersion(e);var r={algorithm:e.algorithm,auth_data:e.auth_data};yield t.crypto.signObject(r.auth_data),t.cryptoCallbacks.getCrossSigningKey&&t.crypto.crossSigningInfo.getId()&&(yield t.crypto.crossSigningInfo.signObject(r.auth_data,"master"));var n=yield t.http.authedRequest(se.Post,"/room_keys/version",void 0,r);return yield t.checkKeyBackup(),t.getKeyBackupEnabled()||t.logger.error("Key backup not usable even though we just created it"),n})()}deleteKeyBackupVersion(e){var t=this;return R(function*(){if(!t.cryptoBackend)throw new Error("End-to-end encryption disabled");yield t.cryptoBackend.deleteKeyBackupVersion(e)})()}makeKeyBackupPath(e,t,r){var n;t!==void 0?n=Ie("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?n=Ie("/room_keys/keys/$roomId",{$roomId:e}):n="/room_keys/keys";var s=r===void 0?void 0:{version:r};return{path:n,queryData:s}}sendKeyBackup(e,t,r,n){var s=this;return R(function*(){if(!s.crypto)throw new Error("End-to-end encryption disabled");var l=s.makeKeyBackupPath(e,t,r);yield s.http.authedRequest(se.Put,l.path,l.queryData,n,{prefix:qt.V3})})()}scheduleAllGroupSessionsForBackup(){var e=this;return R(function*(){if(!e.crypto)throw new Error("End-to-end encryption disabled");yield e.crypto.backupManager.scheduleAllGroupSessionsForBackup()})()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return Yu(e),!0}catch{return!1}}keyBackupKeyFromPassword(e,t){return F0(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return Yu(e)}restoreKeyBackupWithPassword(e,t,r,n,s){var l=this;return R(function*(){var c=yield F0(n.auth_data,e);return l.restoreKeyBackup(c,t,r,n,s)})()}restoreKeyBackupWithSecretStorage(e,t,r,n){var s=this;return R(function*(){if(!s.cryptoBackend)throw new Error("End-to-end encryption disabled");var l=yield s.secretStorage.get("m.megolm_backup.v1"),c=uf(l);if(c){var d=yield s.secretStorage.getKey();yield s.secretStorage.store("m.megolm_backup.v1",c,[d[0]])}var h=Ar(c||l);return s.restoreKeyBackup(h,t,r,e,n)})()}restoreKeyBackupWithRecoveryKey(e,t,r,n,s){var l=Yu(e);return this.restoreKeyBackup(l,t,r,n,s)}restoreKeyBackupWithCache(e,t,r,n){var s=this;return R(function*(){if(!s.cryptoBackend)throw new Error("End-to-end encryption disabled");var l=yield s.cryptoBackend.getSessionBackupPrivateKey();if(!l)throw new Error("Couldn't get key");return s.restoreKeyBackup(l,e,t,r,n)})()}restoreKeyBackup(e,t,r,n,s){var l=this;return R(function*(){var c=s==null?void 0:s.cacheCompleteCallback,d=s==null?void 0:s.progressCallback;if(!l.cryptoBackend)throw new Error("End-to-end encryption disabled");if(!n.version)throw new Error("Backup version must be defined");var h=n.version,v=0,p=0,m=0,_=l.makeKeyBackupPath(t,r,h),b=yield l.cryptoBackend.getBackupDecryptor(n,e),E=!b.sourceTrusted;try{if(!(e instanceof Uint8Array))throw new Error("restoreKeyBackup expects Uint8Array, got ".concat(e));l.cryptoBackend.storeSessionBackupPrivateKey(e,h).catch(D=>{l.logger.warn("Error caching session backup key:",D)}).then(c),d&&d({stage:"fetch"});var M=yield l.http.authedRequest(se.Get,_.path,_.queryData,void 0,{prefix:qt.V3});if(d&&d({stage:"load_keys"}),M.rooms)v=l.getTotalKeyCount(M),yield l.handleDecryptionOfAFullBackup(M,b,200,(function(){var D=R(function*(w){try{var N=n.version;yield l.cryptoBackend.importBackedUpRoomKeys(w,N,{untrusted:E}),m+=w.length}catch(A){p+=w.length,T.error("Error importing keys from backup",A)}d&&d({total:v,successes:m,stage:"load_keys",failures:p})});return function(w){return D.apply(this,arguments)}})());else if(M.sessions){var O=M.sessions;v=Object.keys(O).length;var C=yield b.decryptSessions(O);for(var U of C)U.room_id=t;yield l.cryptoBackend.importBackedUpRoomKeys(C,h,{progressCallback:d,untrusted:E}),m=C.length}else{v=1;try{var[I]=yield b.decryptSessions({[r]:M});I.room_id=t,I.session_id=r,yield l.cryptoBackend.importBackedUpRoomKeys([I],h,{progressCallback:d,untrusted:E}),m=1}catch(D){l.logger.debug("Failed to decrypt megolm session from backup",D)}}}finally{b.free()}return yield l.cryptoBackend.checkKeyBackupAndEnable(),{total:v,imported:m}})()}getTotalKeyCount(e){var t=e.rooms,r=0;for(var n of Object.values(t))n.sessions&&(r+=Object.keys(n.sessions).length);return r}handleDecryptionOfAFullBackup(e,t,r,n){return R(function*(){var s=e.rooms,l=0,c=new Map,d=(function(){var b=R(function*(E){var M=[];for(var O of E.keys()){var C=yield t.decryptSessions(E.get(O));for(var U in C){var I=C[U];I.room_id=O,M.push(I)}}yield n(M)});return function(M){return b.apply(this,arguments)}})();for(var[h,v]of Object.entries(s))if(v.sessions){c.set(h,{});for(var[p,m]of Object.entries(v.sessions)){var _=c.get(h);_[p]=m,l+=1,l>=r&&(yield d(c),c=new Map,c.set(h,{}),l=0)}}l>0&&(yield d(c))})()}deleteKeysFromBackup(e,t,r){var n=this;return R(function*(){var s=n.makeKeyBackupPath(e,t,r);yield n.http.authedRequest(se.Delete,s.path,s.queryData,void 0,{prefix:qt.V3})})()}getMediaConfig(){return this.http.authedRequest(se.Get,"/config",void 0,void 0,{prefix:Bo.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),r=new Set;for(var n of t){var s,l=(s=n.findPredecessor(e))===null||s===void 0?void 0:s.roomId;l&&r.add(l)}return t.filter(c=>{var d=c.currentState.getStateEvents($.RoomTombstone,"");return!(d&&r.has(c.roomId))})}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var r=Ie("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return Ww(5,()=>this.http.authedRequest(se.Put,r,void 0,t))}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return R(function*(){if(t.isInitialSyncComplete()){var r=t.store.getAccountData(e);return r?r.getContent():null}var n=Ie("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(se.Get,n)}catch(l){var s;if(((s=l.data)===null||s===void 0?void 0:s.errcode)==="M_NOT_FOUND")return null;throw l}})()}deleteAccountData(e){var t=this;return R(function*(){var r=t.canSupport.get(fr.AccountDataDeletion);if(r===cr.Unsupported){yield t.setAccountData(e,{});return}var n=Ie("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),s=r===cr.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(se.Delete,n,void 0,void 0,s)})()}getIgnoredUsers(){var e=this.getAccountData("m.ignored_user_list");return!e||!e.getContent()||!e.getContent().ignored_users?[]:Object.keys(e.getContent().ignored_users)}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(r=>{t.ignored_users[r]={}}),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};n.syncRoom===void 0&&(n.syncRoom=!0);var s=r.getRoom(e);if(s!=null&&s.hasMembershipState(r.credentials.userId,We.Join))return s;var l=Promise.resolve();if(n.inviteSignUrl){var c=new URL(n.inviteSignUrl);c.searchParams.set("mxid",r.credentials.userId),l=r.http.requestOtherUrl(se.Post,c)}var d={};n.viaServers&&(d.server_name=n.viaServers,d.via=n.viaServers);var h={},v=yield l;v&&(h.third_party_signed=v);var p=Ie("/join/$roomid",{$roomid:e}),m=yield r.http.authedRequest(se.Post,p,d,h),_=m.room_id,b=r.getRoom(_);if(b!=null&&b.hasMembershipState(r.credentials.userId,We.Join))return b;var E=new Bu(r,r.clientOpts,r.buildSyncApiOptions()),M=E.createRoom(_);return n.syncRoom,M})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this.getRoom(e);if(r!=null&&r.hasMembershipState(this.credentials.userId,We.Knock))return Promise.resolve({room_id:r.roomId});var n=Ie("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),s={};t.viaServers&&(s.server_name=t.viaServers,s.via=t.viaServers);var l={};return t.reason&&(l.reason=t.reason),this.http.authedRequest(se.Post,n,s,l)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,Ve.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![Ve.QUEUED,Ve.NOT_SENT,Ve.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===Ve.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===Ve.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,Ve.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,$.RoomName,{name:t})}setRoomTopic(e,t,r){var n=xw(t,r);return this.sendStateEvent(e,$.RoomTopic,n)}getRoomTags(e){var t=Ie("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(se.Get,t)}setRoomTag(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=Ie("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(se.Put,n,void 0,r)}deleteRoomTag(e,t){var r=Ie("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(se.Delete,r)}setRoomAccountData(e,t,r){var n=Ie("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(se.Put,n,void 0,r)}setPowerLevel(e,t,r){var n=this;return R(function*(){var s,l;if(n.clientRunning&&n.isInitialSyncComplete()){var c;l=(c=n.getRoom(e))===null||c===void 0||(c=c.currentState)===null||c===void 0||(c=c.getStateEvents($.RoomPowerLevels,""))===null||c===void 0?void 0:c.getContent()}if(!l)try{l=yield n.getStateEvent(e,$.RoomPowerLevels,"")}catch(v){if(v instanceof hr&&v.errcode==="M_NOT_FOUND")l={};else throw v}l=xf(l),(s=l)!==null&&s!==void 0&&s.users||(l.users={});var d=Array.isArray(t)?t:[t];for(var h of d)r==null?delete l.users[h]:l.users[h]=r;return n.sendStateEvent(e,$.RoomPowerLevels,l,"")})()}unstable_createLiveBeacon(e,t){var r=this;return R(function*(){return r.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var r=this;return R(function*(){return r.sendStateEvent(e,om.name,t,r.getUserId())})()}sendEvent(e,t,r,n,s){var l,c,d,h;return!(t!=null&&t.startsWith(ni))&&t!==null?(h=n,d=r,c=t,l=null):(h=s,d=n,c=r,l=t),this.addThreadRelationIfNeeded(d,l,e),this.sendCompleteEvent(e,l,{type:c,content:d},h)}addThreadRelationIfNeeded(e,t,r){var n;if(t&&!((n=e["m.relates_to"])!==null&&n!==void 0&&n.rel_type)){var s,l,c=!!((s=e["m.relates_to"])!==null&&s!==void 0&&s["m.in_reply_to"]);e["m.relates_to"]=Ir(Ir({},e["m.relates_to"]),{},{rel_type:Ot.name,event_id:t,is_falling_back:!c});var d=(l=this.getRoom(r))===null||l===void 0?void 0:l.getThread(t);if(d&&!c){var h,v;e["m.relates_to"]["m.in_reply_to"]={event_id:(h=(v=d.lastReply(p=>p.isRelation(Ot.name)&&!p.status))===null||v===void 0?void 0:v.getId())!==null&&h!==void 0?h:t}}}}sendCompleteEvent(e,t,r,n,s){var l,c;typeof n=="string"?c=n:(l=n,c=s),c||(c=this.makeTxnId());var d=new _r(Object.assign(r,{event_id:"~"+e+":"+c,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),h=this.getRoom(e),v=t?h==null?void 0:h.getThread(t):void 0;v&&d.setThread(v),l||(this.reEmitter.reEmit(d,[ct.Replaced,ct.VisibilityChange]),h==null||h.reEmitter.reEmit(d,[ct.BeforeRedaction]));var p=d.getAssociatedId();if(p!=null&&p.startsWith("~")){var m=h==null?void 0:h.getPendingEvents().find(b=>b.getId()===p);m==null||m.once(ct.LocalEventIdReplaced,()=>{d.updateAssociatedId(m.getId())})}var _=d.getType();return this.logger.debug("sendEvent of type ".concat(_," in ").concat(e," with txnId ").concat(c).concat(l?" (delayed event)":"")),d.setTxnId(c),d.setStatus(Ve.SENDING),l?this.encryptAndSendEvent(h,d,l):(h==null||h.addPendingEvent(d,c),d.status===Ve.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(h,d))}encryptAndSendEvent(e,t,r){var n=this;return R(function*(){if(r)return n.sendEventHttpRequest(t,r);try{var s;n.eventsBeingEncrypted.add(t.getId());try{yield n.encryptEventIfNeeded(t,e??void 0)}finally{s=!n.eventsBeingEncrypted.delete(t.getId())}if(s)return{};t.status===Ve.ENCRYPTING&&n.updatePendingEventStatus(e,t,Ve.SENDING);var l=null;return n.scheduler&&(l=n.scheduler.queueEvent(t),l&&n.scheduler.getQueueForEvent(t).length>1&&n.updatePendingEventStatus(e,t,Ve.QUEUED)),l||(l=n.sendEventHttpRequest(t),e&&(l=l.then(c=>(e.updatePendingEvent(t,Ve.SENT,c.event_id),c)))),yield l}catch(c){n.logger.error("Error sending event",c);try{t.error=c,n.updatePendingEventStatus(e,t,Ve.NOT_SENT)}catch(d){n.logger.error("Exception in error handler!",d)}throw c instanceof hr&&(c.event=t),c}})()}encryptEventIfNeeded(e,t){var r=this;return R(function*(){if(t&&(yield r.shouldEncryptEventForRoom(e,t))&&!(!r.cryptoBackend&&r.usingExternalCrypto)){if(!r.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");r.updatePendingEventStatus(t,e,Ve.ENCRYPTING),yield r.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var r=this;return R(function*(){var n;return e.isEncrypted()||e.getType()===$.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(n=r.cryptoBackend)===null||n===void 0?void 0:n.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var r;return t===$.Reaction?t:(r=this.getRoom(e))!==null&&r!==void 0&&r.hasEncryptionStateEvent()?$.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e,t){var r=e.getTxnId();r||(r=this.makeTxnId(),e.setTxnId(r));var n={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:r},s;if(e.isState()){var l="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(l="/rooms/$roomId/state/$eventType/$stateKey"),s=Ie(l,n)}else if(e.isRedaction()&&e.event.redacts){var c="/rooms/$roomId/redact/$redactsEventId/$txnId";s=Ie(c,Ir({$redactsEventId:e.event.redacts},n))}else s=Ie("/rooms/$roomId/send/$eventType/$txnId",n);var d=e.getWireContent();return t?this.http.authedRequest(se.Put,s,cT(t),d):this.http.authedRequest(se.Put,s,void 0,d).then(h=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(h.event_id)),h))}redactEvent(e,t,r,n,s){var l,c,d;(l=r)!==null&&l!==void 0&&l.startsWith(ni)||(s=n,n=r,r=t,t=null);var h=(c=s)===null||c===void 0?void 0:c.reason,v={reason:h};if(((d=s)===null||d===void 0?void 0:d.with_rel_types)!==void 0){if(this.canSupport.get(fr.RelationBasedRedactions)===cr.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(n," threadId ").concat(t));var p=this.canSupport.get(fr.RelationBasedRedactions)===cr.Stable?sp.stable:sp.unstable;v[p]=s.with_rel_types}return this.sendCompleteEvent(e,t,{type:$.RoomRedaction,content:v,redacts:r},n)}sendMessage(e,t,r,n){typeof t!="string"&&t!==null&&(n=r,r=t,t=null);var s=$.RoomMessage,l=r;return this.sendEvent(e,t,s,l,n)}sendTextMessage(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(n=r,r=t,t=null);var l=Mw(r);return this.sendMessage(e,t,l,n)}sendNotice(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(n=r,r=t,t=null);var l=Nw(r);return this.sendMessage(e,t,l,n)}sendEmoteMessage(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(n=r,r=t,t=null);var l=Uw(r);return this.sendMessage(e,t,l,n)}sendImageMessage(e,t,r,n){var s,l=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(l=n||"Image",n=r,r=t,t=null);var c={msgtype:Xn.Image,url:r,info:n,body:l};return this.sendMessage(e,t,c)}sendStickerMessage(e,t,r,n){var s,l=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(l=n||"Sticker",n=r,r=t,t=null);var c={url:r,info:n,body:l};return this.sendEvent(e,t,$.Sticker,c)}sendHtmlMessage(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(n=r,r=t,t=null);var l=kw(r,n);return this.sendMessage(e,t,l)}sendHtmlNotice(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(n=r,r=t,t=null);var l=Aw(r,n);return this.sendMessage(e,t,l)}sendHtmlEmote(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(ni))&&t!==null&&(n=r,r=t,t=null);var l=Dw(r,n);return this.sendMessage(e,t,l)}_unstable_sendDelayedEvent(e,t,r,n,s,l){var c=this;return R(function*(){if(!(yield c.doesServerSupportUnstableFeature(di)))throw Error("Server does not support the delayed events API");return c.addThreadRelationIfNeeded(s,r,e),c.sendCompleteEvent(e,r,{type:n,content:s},t,l)})()}_unstable_sendDelayedStateEvent(e,t,r,n){var s=arguments,l=this;return R(function*(){var c=s.length>4&&s[4]!==void 0?s[4]:"",d=s.length>5&&s[5]!==void 0?s[5]:{};if(!(yield l.doesServerSupportUnstableFeature(di)))throw Error("Server does not support the delayed events API");var h={$roomId:e,$eventType:r,$stateKey:c},v=Ie("/rooms/$roomId/state/$eventType",h);return c!==void 0&&(v=Ie(v+"/$stateKey",h)),l.http.authedRequest(se.Put,v,cT(t),n,d)})()}_unstable_getDelayedEvents(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportUnstableFeature(di)))throw Error("Server does not support the delayed events API");var r=e?{from:e}:void 0;return yield t.http.authedRequest(se.Get,"/delayed_events",r,void 0,{prefix:"".concat(qt.Unstable,"/").concat(di)})})()}_unstable_updateDelayedEvent(e,t){var r=this;return R(function*(){if(!(yield r.doesServerSupportUnstableFeature(di)))throw Error("Server does not support the delayed events API");var n=Ie("/delayed_events/$delayId",{$delayId:e}),s={action:t};return yield r.http.authedRequest(se.Post,n,void 0,s,{prefix:"".concat(qt.Unstable,"/").concat(di)})})()}sendReceipt(e,t,r){var n=arguments,s=this;return R(function*(){var l=n.length>3&&n[3]!==void 0?n[3]:!1;if(s.isGuest())return Promise.resolve({});var c=Ie("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),d=!l&&s.supportsThreads(),h=d?Ir(Ir({},r),{},{thread_id:el(e)}):r,v=s.http.authedRequest(se.Post,c,void 0,h||{}),p=s.getRoom(e.getRoomId());return p&&s.credentials.userId&&p.addLocalEchoReceipt(s.credentials.userId,e,t,l),v})()}sendReadReceipt(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:xr.Read,s=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var l=e.getId(),c=r.getRoom(e.getRoomId());if(c!=null&&c.hasPendingEvent(l))throw new Error("Cannot set read receipt to a pending event (".concat(l,")"));return r.sendReceipt(e,n,{},s)}})()}setRoomReadMarkers(e,t,r,n){var s=this;return R(function*(){var l=s.getRoom(e);if(l!=null&&l.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var c;if(r){if(c=r.getId(),l!=null&&l.hasPendingEvent(c))throw new Error("Cannot set read receipt to a pending event (".concat(c,")"));l==null||l.addLocalEchoReceipt(s.credentials.userId,r,xr.Read)}var d;if(n){if(d=n.getId(),l!=null&&l.hasPendingEvent(d))throw new Error("Cannot set read receipt to a pending event (".concat(d,")"));l==null||l.addLocalEchoReceipt(s.credentials.userId,n,xr.ReadPrivate)}return yield s.setRoomReadMarkersHttpRequest(e,t,c,d)})()}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var r=new URL(e);r.hash="",e=r.toString();var n=t+"_"+e;if(n in this.urlPreviewCache)return this.urlPreviewCache[n];var s=this.http.authedRequest(se.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:Bo.V3,priority:"low"});return this.urlPreviewCache[n]=s,s}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});var n=Ie("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),s={typing:t};return t&&(s.timeout=r||2e4),this.http.authedRequest(se.Put,n,void 0,s)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getRoom(e);if(!n)return[];var s=this.findPredecessorRooms(n,t,r),l=this.findSuccessorRooms(n,t,r);return[...s,n,...l]}findPredecessorRooms(e,t,r){for(var n,s=[],l=new Set([e.roomId]),c=(n=e.findPredecessor(r))===null||n===void 0?void 0:n.roomId;c!==null;){var d;if(c){if(l.has(c))break;l.add(c)}var h=this.getRoom(c);if(h===null)break;if(t){var v=h.currentState.getStateEvents($.RoomTombstone,"");if(!v||v.getContent().replacement_room!==e.roomId)break}s.splice(0,0,h),e=h,c=(d=e.findPredecessor(r))===null||d===void 0?void 0:d.roomId}return s}findSuccessorRooms(e,t,r){for(var n=[],s=e.currentState.getStateEvents($.RoomTombstone,"");s;){var l=this.getRoom(s.getContent().replacement_room);if(!l||l.roomId===e.roomId)break;if(t){var c,d=(c=l.findPredecessor(r))===null||c===void 0?void 0:c.roomId;if(!d||d!==e.roomId)break}n.push(l);var h=new Set(n.map(v=>v.roomId));if(h.size<n.length)return n.slice(0,n.length-1);e=l,s=e.currentState.getStateEvents($.RoomTombstone,"")}return n}invite(e,t,r){return this.membershipChange(e,t,We.Invite,r)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,r){var n=this;return R(function*(){var s,l=Ie("/rooms/$roomId/invite",{$roomId:e}),c=n.getIdentityServerUrl(!0);if(!c)return Promise.reject(new hr({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var d={id_server:c,medium:t,address:r};if((s=n.identityServer)!==null&&s!==void 0&&s.getAccessToken){var h=yield n.identityServer.getAccessToken();h&&(d.id_access_token=h)}return n.http.authedRequest(se.Post,l,void 0,d)})()}leave(e){return this.membershipChange(e,void 0,We.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=this.getRoomUpgradeHistory(e),n=r;if(!t){n=[];for(var s of r)if(n.push(s),s.roomId===e)break}var l={},c=[],d=v=>this.leave(v).then(()=>{delete l[v]}).catch(p=>{l[v]=p});for(var h of n)c.push(d(h.roomId));return Promise.all(c).then(()=>l)}ban(e,t,r){return this.membershipChange(e,t,We.Ban,r)}forget(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!0,s=Ie("/rooms/$room_id/forget",{$room_id:e}),l=yield r.http.authedRequest(se.Post,s);return n&&(r.store.removeRoom(e),r.emit(Pe.DeleteRoom,e)),l})()}unban(e,t){var r=Ie("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(se.Post,r,void 0,n)}kick(e,t,r){var n=Ie("/rooms/$roomId/kick",{$roomId:e}),s={user_id:t,reason:r};return this.http.authedRequest(se.Post,n,void 0,s)}membershipChange(e,t,r,n){var s=Ie("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(se.Post,s,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushDetails()}setProfileInfo(e,t){var r=Ie("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(se.Put,r,void 0,t)}setDisplayName(e){var t=this;return R(function*(){var r=yield t.setProfileInfo("displayname",{displayname:e}),n=t.getUser(t.getUserId());return n&&(n.displayName=e,n.emit(mn.DisplayName,n.events.presence,n)),r})()}setAvatarUrl(e){var t=this;return R(function*(){var r=yield t.setProfileInfo("avatar_url",{avatar_url:e}),n=t.getUser(t.getUserId());return n&&(n.avatarUrl=e,n.emit(mn.AvatarUrl,n.events.presence,n)),r})()}mxcUrlToHttp(e,t,r,n,s,l,c){return Kf(this.baseUrl,e,t,r,n,s,l,c)}setSyncPresence(e){var t=this;return R(function*(){var r;(r=t.syncApi)===null||r===void 0||r.setPresence(e)})()}setPresence(e){var t=this;return R(function*(){var r=Ie("/presence/$userId/status",{$userId:t.credentials.userId}),n=["offline","online","unavailable"];if(n.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(se.Put,r,void 0,e)})()}getPresence(e){var t=Ie("/presence/$userId/status",{$userId:e});return this.http.authedRequest(se.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,r=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){var s=Date.now()-n.errorTs;r=Math.max(bN-s,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var l=this.store.scrollback(e,t).length;if(l===t)return Promise.resolve(e);t=t-l;var c=new Promise((d,h)=>{Ba(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,tt.Backward)).then(v=>{var p,m,_=v.chunk.map(this.getEventMapper());if(v.state){var b=v.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(b)}var[E,M,O]=e.partitionThreadedEvents(_);this.processAggregatedTimelineEvents(e,E),e.addEventsToTimeline(E,!0,e.getLiveTimeline()),this.processThreadEvents(e,M,!0),O.forEach(C=>e.relations.aggregateChildEvent(C)),e.oldState.paginationToken=(p=v.end)!==null&&p!==void 0?p:null,v.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,_,(m=v.end)!==null&&m!==void 0?m:null,!0),delete this.ongoingScrollbacks[e.roomId],d(e)}).catch(v=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},h(v)})});return n={promise:c},this.ongoingScrollbacks[e.roomId]=n,c}getEventMapper(e){return rN(this,e||{})}getEventTimeline(e,t){var r=this;return R(function*(){var n,s,l,c;if(!r.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&r.supportsThreads())return r.getThreadTimeline(e,t);var d=Ie("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),h=void 0;(n=r.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(h={filter:JSON.stringify($r.LAZY_LOADING_MESSAGES_FILTER)});var v=yield r.http.authedRequest(se.Get,d,h);if(!v.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var p=r.getEventMapper(),m=p(v.event);if(m.isRelation(Ot.name)){r.logger.warn("Tried loading a regular timeline at the position of a thread event");return}var _=[...v.events_after.reverse().map(p),m,...v.events_before.map(p)],b=e.getTimelineForEvent(_[0].getId());b?b.getState(ke.BACKWARDS).setUnknownStateEvents(v.state.map(p)):(b=e.addTimeline(),b.initialiseState(v.state.map(p)),b.getState(ke.FORWARDS).paginationToken=v.end);var[E,M,O]=e.room.partitionThreadedEvents(_);return e.addEventsToTimeline(E,!0,b,v.start),r.processThreadEvents(e.room,M,!0),r.processAggregatedTimelineEvents(e.room,E),O.forEach(C=>e.relations.aggregateChildEvent(C)),(s=(l=e.getTimelineForEvent(t))!==null&&l!==void 0?l:(c=e.room.findThreadForEvent(m))===null||c===void 0?void 0:c.liveTimeline)!==null&&s!==void 0?s:b})()}getThreadTimeline(e,t){var r=this;return R(function*(){var n;if(!r.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var s=Ie("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),l={limit:"0"};(n=r.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(l.filter=JSON.stringify($r.LAZY_LOADING_MESSAGES_FILTER));var c=yield r.http.authedRequest(se.Get,s,l),d=r.getEventMapper(),h=d(c.event);if(e.canContain(h)){var v=r.canSupport.get(fr.RelationsRecursion)!==cr.Unsupported;if(Ut.hasServerSideSupport)if(Ut.hasServerSideFwdPaginationSupport){var p,m,_;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var b=e.thread,E=yield r.fetchRelations(e.room.roomId,b.id,null,null,{dir:tt.Backward,from:c.start,recurse:v||void 0}),M=yield r.fetchRelations(e.room.roomId,b.id,null,null,{dir:tt.Forward,from:c.end,recurse:v||void 0}),O=[...M.chunk.reverse().filter(Vg(b.id)).map(d),h,...E.chunk.filter(Vg(b.id)).map(d)];for(var C of O){var U;yield(U=e.thread)===null||U===void 0?void 0:U.processEvent(C)}var I=e.getTimelineForEvent(h.getId());if(I?I.getState(ke.BACKWARDS).setUnknownStateEvents(c.state.map(d)):(I=e.addTimeline(),I.initialiseState(c.state.map(d))),e.addEventsToTimeline(O,!0,I,M.next_batch),!E.next_batch){var D=yield r.fetchRoomEvent(e.room.roomId,b.id);e.addEventsToTimeline([d(D)],!0,I,null)}return I.setPaginationToken((p=E.next_batch)!==null&&p!==void 0?p:null,tt.Backward),I.setPaginationToken((m=M.next_batch)!==null&&m!==void 0?m:null,tt.Forward),r.processAggregatedTimelineEvents(e.room,O),(_=e.getTimelineForEvent(t))!==null&&_!==void 0?_:I}else{for(var w,N=e.thread,A=yield r.fetchRelations(e.room.roomId,N.id,Ot.name,null,{dir:tt.Backward,from:c.start,recurse:v||void 0}),K=[],z=c.end;z;){var de,_e=yield r.fetchRelations(e.room.roomId,N.id,Ot.name,null,{dir:tt.Forward,from:z,recurse:v||void 0});z=(de=_e.next_batch)!==null&&de!==void 0?de:null,K.push(..._e.chunk)}var le=[...K.reverse().map(d),h,...A.chunk.map(d)];for(var Ce of le){var V;yield(V=e.thread)===null||V===void 0?void 0:V.processEvent(Ce)}var B=e.getLiveTimeline();if(B.getState(ke.BACKWARDS).setUnknownStateEvents(c.state.map(d)),e.addEventsToTimeline(le,!0,B,null),!A.next_batch){var te=yield r.fetchRoomEvent(e.room.roomId,N.id);e.addEventsToTimeline([d(te)],!0,B,null)}return B.setPaginationToken((w=A.next_batch)!==null&&w!==void 0?w:null,tt.Backward),B.setPaginationToken(null,tt.Forward),r.processAggregatedTimelineEvents(e.room,le),B}}})()}getLatestTimeline(e){var t=this;return R(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var r;if(e.threadListType!==null){var n,s=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,tt.Backward,e.threadListType,e.getFilter());r=(n=s.chunk)===null||n===void 0?void 0:n[0]}else if(e.thread&&Ut.hasServerSideSupport){var l,c=t.canSupport.get(fr.RelationsRecursion)!==cr.Unsupported,d=yield t.fetchRelations(e.room.roomId,e.thread.id,Ot.name,null,{dir:tt.Backward,limit:1,recurse:c||void 0});r=(l=d.chunk)===null||l===void 0?void 0:l[0]}else{var h,v,p=Ie("/rooms/$roomId/messages",{$roomId:e.room.roomId}),m={dir:"b"};(h=t.clientOpts)!==null&&h!==void 0&&h.lazyLoadMembers&&(m.filter=JSON.stringify($r.LAZY_LOADING_MESSAGES_FILTER));var _=yield t.http.authedRequest(se.Get,p,m);r=(v=_.chunk)===null||v===void 0?void 0:v[0]}if(!r)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,r.event_id)})()}createMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,s=arguments.length>3?arguments[3]:void 0,l=arguments.length>4?arguments[4]:void 0,c=Ie("/rooms/$roomId/messages",{$roomId:e}),d={limit:n.toString(),dir:s};t&&(d.from=t);var h=null;if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(h=Object.assign({},$r.LAZY_LOADING_MESSAGES_FILTER)),l){var v;h=h||{},Object.assign(h,(v=l.getRoomTimelineFilterComponent())===null||v===void 0?void 0:v.toJSON())}return h&&(d.filter=JSON.stringify(h)),this.http.authedRequest(se.Get,c,d)}createThreadListMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:tt.Backward,l=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Vn.All,c=arguments.length>5?arguments[5]:void 0,d=Ie("/rooms/$roomId/threads",{$roomId:e}),h={limit:n.toString(),dir:s,include:LR(l)};t&&(h.from=t);var v={};if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(v=Ir({},$r.LAZY_LOADING_MESSAGES_FILTER)),c){var p;v=Ir(Ir({},v),(p=c.getRoomTimelineFilterComponent())===null||p===void 0?void 0:p.toJSON())}Object.keys(v).length&&(h.filter=JSON.stringify(v));var m={prefix:Ut.hasServerSideListSupport===Ur.Stable?qt.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(se.Get,d,h,void 0,m).then(_=>{var b;return Ir(Ir({},_),{},{chunk:(b=_.chunk)===null||b===void 0?void 0:b.reverse(),start:_.prev_batch,end:_.next_batch})})}paginateEventTimeline(e,t){var r=this,n=e.getTimelineSet()===this.notifTimelineSet,s=this.getRoom(e.getRoomId()),l=e.getTimelineSet().threadListType,c=e.getTimelineSet().thread;t=t||{};var d=t.backwards||!1;if(n&&!d)throw new Error("paginateNotifTimeline can only paginate backwards");var h=d?ke.BACKWARDS:ke.FORWARDS,v=e.getPaginationToken(h),p=e.paginationRequests[h];if(p)return p;var m,_,b;if(n){var E;m="/notifications",_={limit:((E=t.limit)!==null&&E!==void 0?E:30).toString(),only:"highlight"},v&&v!=="end"&&(_.from=v),b=this.http.authedRequest(se.Get,m,_).then((function(){var I=R(function*(D){var w=D.next_token,N=[];D.notifications=D.notifications.filter(zn);for(var A=0;A<D.notifications.length;A++){var K=D.notifications[A],z=r.getEventMapper()(K.event);r.getPushDetailsForEvent(z,!0),z.event.room_id=K.room_id,N[A]=z}var de=e.getTimelineSet();return de.addEventsToTimeline(N,d,e,w),r.processAggregatedTimelineEvents(de.room,N),d&&!D.next_token&&e.setPaginationToken(null,h),!!D.next_token});return function(D){return I.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=b}else if(l!==null){if(!s)throw new Error("Unknown room "+e.getRoomId());if(!Ut.hasServerSideFwdPaginationSupport&&h===tt.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");b=this.createThreadListMessagesRequest(e.getRoomId(),v,t.limit,h,l,e.getFilter()).then(I=>{if(I.state){var D=e.getState(h),w=I.state.filter(zn).map(this.getEventMapper());D.setUnknownStateEvents(w)}var N=I.end,A=I.chunk.filter(zn).map(this.getEventMapper()),K=e.getTimelineSet();return K.addEventsToTimeline(A,d,e,N),this.processAggregatedTimelineEvents(s,A),this.processThreadRoots(s,A,d),d&&I.end==I.start&&e.setPaginationToken(null,h),I.end!==I.start}).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=b}else if(c){var M,O,C=this.getRoom((M=e.getRoomId())!==null&&M!==void 0?M:void 0);if(!C)throw new Error("Unknown room "+e.getRoomId());var U=this.canSupport.get(fr.RelationsRecursion)!==cr.Unsupported;b=this.fetchRelations((O=e.getRoomId())!==null&&O!==void 0?O:"",c.id,null,null,{dir:h,limit:t.limit,from:v??void 0,recurse:U||void 0}).then((function(){var I=R(function*(D){var w=r.getEventMapper(),N=D.chunk.filter(zn).filter(Vg(c.id)).map(w);for(var A of N.slice().reverse()){yield c==null?void 0:c.processEvent(A);var K=A.getSender();(!d||(c==null?void 0:c.getEventReadUpTo(K))===null)&&C.addLocalEchoReceipt(K,A,xr.Read)}var z=D.next_batch,de=e.getTimelineSet();if(de.addEventsToTimeline(N,d,e,z??null),!z&&d){var _e,le,Ce=(_e=c.rootEvent)!==null&&_e!==void 0?_e:w(yield r.fetchRoomEvent((le=e.getRoomId())!==null&&le!==void 0?le:"",c.id));de.addEventsToTimeline([Ce],!0,e,null)}return r.processAggregatedTimelineEvents(de.room,N),d&&!z&&e.setPaginationToken(null,h),!!z});return function(D){return I.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=b}else{if(!s)throw new Error("Unknown room "+e.getRoomId());b=this.createMessagesRequest(e.getRoomId(),v,t.limit,h,e.getFilter()).then(I=>{if(I.state){var D=e.getState(h),w=I.state.filter(zn).map(this.getEventMapper());D.setUnknownStateEvents(w)}var N=I.end,A=I.chunk.filter(zn).map(this.getEventMapper()),K=e.getTimelineSet(),[z,,de]=s.partitionThreadedEvents(A);K.addEventsToTimeline(z,d,e,N),this.processAggregatedTimelineEvents(s,z),this.processThreadRoots(s,z.filter(le=>le.getServerAggregatedRelation(Ot.name)),!1),de.forEach(le=>s.relations.aggregateChildEvent(le));var _e=I.end===void 0||I.end===I.start;return d&&_e&&e.setPaginationToken(null,h),!_e}).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=b}return b}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new Bu(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,r)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var r=this.sendStateEvent(e,$.RoomGuestAccess,{guest_access:t.allowJoin?Df.CanJoin:Df.Forbidden},""),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,$.RoomHistoryVisibility,{history_visibility:Om.WorldReadable},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,s){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:s})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,s){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:s})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,s){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:s})}requestTokenFromEndpoint(e,t){var r=this;return R(function*(){var n=Object.assign({},t);return r.http.request(se.Post,e,void 0,n)})()}getRoomPushRule(e,t){if(this.pushRules){var r;return(r=this.pushRules[e])===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.find(n=>n.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){var n,s=!1,l=this.getRoomPushRule(e,t);if(l!=null&&l.actions.includes(La.DontNotify)&&(s=!0),!r)s&&(n=this.deletePushRule(e,Sr.RoomSpecific,l.rule_id));else if(!l)n=this.addPushRule(e,Sr.RoomSpecific,t,{actions:[La.DontNotify]});else if(!s){var c=qa();this.deletePushRule(e,Sr.RoomSpecific,l.rule_id).then(()=>{this.addPushRule(e,Sr.RoomSpecific,t,{actions:[La.DontNotify]}).then(()=>{c.resolve()}).catch(d=>{c.reject(d)})}).catch(d=>{c.reject(d)}),n=c.promise}if(n)return new Promise((d,h)=>{n.then(()=>{this.getPushRules().then(v=>{this.pushRules=v,d()}).catch(v=>{h(v)})}).catch(v=>{this.getPushRules().then(p=>{this.pushRules=p,h(v)}).catch(p=>{h(v)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:CR.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(n=>this.processRoomEventsSearch(r,n))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(n=>this.processRoomEventsSearch(e,n)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,n,s=t.search_categories.room_events;e.count=s.count,e.next_batch=s.next_batch;var l=new Set(s.highlights);e.highlights.forEach(b=>{l.add(b)}),e.highlights=Array.from(l);for(var c=this.getEventMapper(),d=(r=(n=s.results)===null||n===void 0?void 0:n.length)!==null&&r!==void 0?r:0,h=0;h<d;h++){var v=Jf.fromJson(s.results[h],c),p=this.getRoom(v.context.getEvent().getRoomId());if(p)for(var m of v.context.getTimeline()){var _=p.getMember(m.getSender());!m.sender&&_&&(m.sender=_)}e.results.push(v)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new Bu(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=Ie("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(se.Post,t,void 0,e).then(r=>{var n=$r.fromJson(this.credentials.userId,r.filter_id,e);return this.store.storeFilter(n),n})}getFilter(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var s=Ie("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(se.Get,s).then(l=>{var c=$r.fromJson(e,t,l);return this.store.storeFilter(c),c})}getOrCreateFilter(e,t){var r=this;return R(function*(){var n=r.store.getFilterIdByName(e),s;if(n){try{var l=yield r.getFilter(r.credentials.userId,n,!0);if(l){var c=l.getDefinition(),d=t.getDefinition();Ms(c,d)&&(s=n)}}catch(v){if(v.errcode!=="M_UNKNOWN"&&v.errcode!=="M_NOT_FOUND")throw v}s||r.store.setFilterIdByName(e,void 0)}if(s)return s;var h=yield r.createFilter(t.getDefinition());return r.store.setFilterIdByName(e,h.filterId),h.filterId})()}getOpenIdToken(){var e=Ie("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(se.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(se.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return R(function*(){if(e.canSupportVoip){var t=!1,r=e.turnServersExpiry-Date.now();if(r>uT)e.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var n=yield e.turnServer();if(n.uris){e.logger.debug("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs");var s={urls:n.uris,username:n.username,credential:n.password};e.turnServers=[s],e.turnServersExpiry=Date.now()+n.ttl*1e3,t=!0,e.emit(Pe.TurnServers,e.turnServers)}}catch(l){e.logger.error("Failed to get TURN URIs",l),l.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(Pe.TurnServersError,l,!0)):e.emit(Pe.TurnServersError,l,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=Ie("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(se.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=Ie("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(se.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=Ie("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(se.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return R(function*(){var t;e.clientWellKnownPromise=Ye.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(Pe.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(r=>{var[n,s]=r;return e.includes(typeof s)}).reduce((r,n)=>{var[s,l]=n;return r[s]=l,r},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return R(function*(){var r=yield t.doesServerSupportUnstableFeature(DR),n=yield t.doesServerSupportUnstableFeature(MR),s=yield t.doesServerSupportUnstableFeature(NR);if(!r&&!n&&!s)throw Error("Server does not support the Mutual Rooms API");var l,c;s?(l="/uk.half-shot.msc2666/user/mutual_rooms",c={user_id:e}):(l=Ie("/uk.half-shot.msc2666/user/".concat(n?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),c={});var d=[],h=null;do{var v={};h!=null&&s&&(v.batch_token=h);var p=yield t.http.authedRequest(se.Get,l,Ir(Ir({},c),v),void 0,{prefix:qt.Unstable});d.push(...p.joined),p.next_batch_token!==void 0?h=p.next_batch_token:h=null}while(h!=null);return d})()}getVersions(){var e=this;return R(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(se.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(r=>{throw e.serverVersionsPromise=void 0,r});var t=yield e.serverVersionsPromise;return e.canSupport=yield IA(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return R(function*(){var{versions:r}=yield t.getVersions();return r&&r.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return R(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features;return n&&!!n[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return R(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features,s=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced.".concat(s)]})()}doesServerSupportThread(){var e=this;return R(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:Ur.Stable,list:Ur.Stable,fwdPagination:Ur.Stable};try{var[t,r,n,s,l,c]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:ff(r,t),list:ff(s,n),fwdPagination:ff(c,l)}}catch{return{threads:Ur.None,list:Ur.None,fwdPagination:Ur.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,r,n){var s=arguments,l=this;return R(function*(){var c,d,h=s.length>4&&s[4]!==void 0?s[4]:{dir:tt.Backward},v=n?l.getEncryptedIfNeededEventType(e,n):null,[p,m]=yield Promise.all([l.fetchRoomEvent(e,t),l.fetchRelations(e,t,r,v,h)]),_=l.getEventMapper(),b=p?_(p):void 0,E=m.chunk.map(_);if(v===$.RoomMessageEncrypted){var M=b?E.concat(b):E;yield Promise.all(M.map(O=>l.decryptEventIfNeeded(O))),n!==null&&(E=E.filter(O=>O.getType()===n))}return b&&r===Ht.Replace&&(E=E.filter(O=>O.getSender()===b.getSender())),{originalEvent:b??null,events:E,nextBatch:(c=m.next_batch)!==null&&c!==void 0?c:null,prevBatch:(d=m.prev_batch)!==null&&d!==void 0?d:null}})()}getCrossSigningCacheCallbacks(){var e;return(e=this.crypto)===null||e===void 0?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return Qn(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case Cp.IS:return this.http.getUrl("/terms",void 0,Bi.V2,t);case Cp.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return r&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=Rg(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(se.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,r,n,s,l,c){r&&(n.session=r);var d={auth:n,refresh_token:!0};return e!=null&&(d.username=e),t!=null&&(d.password=t),l!=null&&(d.guest_access_token=l),c!=null&&(d.inhibit_login=c),this.registerRequest(d)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var r={};return t&&(r.kind=t),this.http.request(se.Post,"/register",r,e)}refreshToken(e){var t=r=>this.http.authedRequest(se.Post,"/refresh",void 0,{refresh_token:e},{prefix:r,inhibitLogoutEmit:!0});return t(qt.V3).catch(r=>{if(r.errcode==="M_UNRECOGNIZED")return t(qt.V1);throw r})}loginFlows(){return this.http.request(se.Get,"/login")}login(e,t){return this.http.authedRequest(se.Post,"/login",void 0,Ir(Ir({},t),{},{type:e})).then(r=>(r.access_token&&r.user_id&&(this.http.opts.accessToken=r.access_token,this.credentials={userId:r.user_id}),r))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,s="/login/"+t+"/redirect";r&&(s+="/"+r);var l={redirectUrl:e,[wN.unstable]:n};return this.http.getUrl(s,l).href}loginWithToken(e){return this.login("m.login.token",{token:e})}logout(){var e=arguments,t=this;return R(function*(){var r,n=e.length>0&&e[0]!==void 0?e[0]:!1;if((r=t.crypto)!==null&&r!==void 0&&(r=r.backupManager)!==null&&r!==void 0&&r.getKeyBackupEnabled())try{for(;(yield t.crypto.backupManager.backupPendingKeys(200))>0;);}catch(s){t.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",s)}return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest(se.Post,"/logout")})()}deactivateAccount(e,t){var r={};return e&&(r.auth=e),t!==void 0&&(r.erase=t),this.http.authedRequest(se.Post,"/account/deactivate",void 0,r)}requestLoginToken(e){var t=this;return R(function*(){var r={auth:e};return t.http.authedRequest(se.Post,"/login/get_token",void 0,r,{prefix:qt.V1})})()}getFallbackAuthUrl(e,t){var r=Ie("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}createRoom(e){var t=this;return R(function*(){var r,n=(e.invite_3pid||[]).filter(c=>!c.id_access_token);if(n.length>0&&(r=t.identityServer)!==null&&r!==void 0&&r.getAccessToken){var s=yield t.identityServer.getAccessToken();if(s)for(var l of n)l.id_access_token=s}return t.http.authedRequest(se.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:tt.Backward},l=s;Ut.hasServerSideFwdPaginationSupport===Ur.Experimental&&(l=ME("dir","org.matrix.msc3715.dir",l)),this.canSupport.get(fr.RelationsRecursion)===cr.Unstable&&(l=ME("recurse","org.matrix.msc3981.recurse",l));var c=Jg(l),d="/rooms/$roomId/relations/$eventId";r!==null?(d+="/$relationType",n!==null&&(d+="/$eventType")):n!==null&&(this.logger.warn("eventType: ".concat(n,` ignored when fetching
            relations as relationType is null`)),n=null);var h=Ie(d+"?"+c,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return this.http.authedRequest(se.Get,h,void 0,void 0,{prefix:qt.V1})}roomState(e){var t=Ie("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(se.Get,t)}fetchRoomEvent(e,t){var r=Ie("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(se.Get,r)}members(e,t,r,n){var s={};t&&(s.membership=t),r&&(s.not_membership=r),n&&(s.at=n);var l=Jg(s),c=Ie("/rooms/$roomId/members?"+l,{$roomId:e});return this.http.authedRequest(se.Get,c)}upgradeRoom(e,t){var r=Ie("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(se.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){var n={$roomId:e,$eventType:t,$stateKey:r},s=Ie("/rooms/$roomId/state/$eventType",n);return r!==void 0&&(s=Ie(s+"/$stateKey",n)),this.http.authedRequest(se.Get,s)}sendStateEvent(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{},l={$roomId:e,$eventType:t,$stateKey:n},c=Ie("/rooms/$roomId/state/$eventType",l);return n!==void 0&&(c=Ie(c+"/$stateKey",l)),this.http.authedRequest(se.Put,c,void 0,r,s)}roomInitialSync(e,t){var r,n=Ie("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(se.Get,n,{limit:(r=t==null?void 0:t.toString())!==null&&r!==void 0?r:"30"})}setRoomReadMarkersHttpRequest(e,t,r,n){var s=this;return R(function*(){var l=Ie("/rooms/$roomId/read_markers",{$roomId:e}),c={[xr.FullyRead]:t,[xr.Read]:r};return((yield s.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield s.isVersionSupported("v1.4")))&&(c[xr.ReadPrivate]=n),s.http.authedRequest(se.Post,l,void 0,c)})()}getJoinedRooms(){var e=Ie("/joined_rooms",{});return this.http.authedRequest(se.Get,e)}getJoinedRoomMembers(e){var t=Ie("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(se.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:r,since:n}=e,s=Hk(e,SN);if(Object.keys(s).length===0){var l={server:t,limit:r,since:n};return this.http.authedRequest(se.Get,"/publicRooms",l)}else{var c={server:t},d=Ir({limit:r,since:n},s);return this.http.authedRequest(se.Post,"/publicRooms",c,d)}}createAlias(e,t){var r=Ie("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(se.Put,r,void 0,n)}deleteAlias(e){var t=Ie("/directory/room/$alias",{$alias:e});return this.http.authedRequest(se.Delete,t)}getLocalAliases(e){var t=Ie("/rooms/$roomId/aliases",{$roomId:e}),r=qt.V3;return this.http.authedRequest(se.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){var t=Ie("/directory/room/$alias",{$alias:e});return this.http.authedRequest(se.Get,t)}getRoomDirectoryVisibility(e){var t=Ie("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(se.Get,t)}setRoomDirectoryVisibility(e,t){var r=Ie("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(se.Put,r,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:r}=e,n={search_term:t};return r!==void 0&&(n.limit=r),this.http.authedRequest(se.Post,"/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var r=t?Ie("/profile/$userId/$info",{$userId:e,$info:t}):Ie("/profile/$userId",{$userId:e});return this.http.authedRequest(se.Get,r)}doesServerSupportExtendedProfiles(){var e=this;return R(function*(){return e.doesServerSupportUnstableFeature(UR)})()}getExtendedProfileRequestPrefix(){var e=this;return R(function*(){return(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?qt.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(se.Get,Ie("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var r=this;return R(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=yield r.http.authedRequest(se.Get,Ie("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield r.getExtendedProfileRequestPrefix()});return n[t]})()}setExtendedProfileProperty(e,t){var r=this;return R(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=r.getUserId();yield r.http.authedRequest(se.Put,Ie("/profile/$userId/$key",{$userId:n,$key:e}),void 0,{[e]:t},{prefix:yield r.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(se.Delete,Ie("/profile/$userId/$key",{$userId:r,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();return t.http.authedRequest(se.Patch,Ie("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(se.Put,Ie("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(se.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return R(function*(){var r="/account/3pid/add";return t.http.authedRequest(se.Post,r,void 0,e)})()}bindThreePid(e){var t=this;return R(function*(){var r="/account/3pid/bind";return t.http.authedRequest(se.Post,r,void 0,e)})()}unbindThreePid(e,t){var r=this;return R(function*(){var n="/account/3pid/unbind",s={medium:e,address:t,id_server:r.getIdentityServerUrl(!0)};return r.http.authedRequest(se.Post,n,void 0,s)})()}deleteThreePid(e,t){var r="/account/3pid/delete";return this.http.authedRequest(se.Post,r,void 0,{medium:e,address:t})}setPassword(e,t,r){var n="/account/password",s={auth:e,new_password:t,logout_devices:r};return this.http.authedRequest(se.Post,n,void 0,s)}getDevices(){return this.http.authedRequest(se.Get,"/devices")}getDevice(e){var t=Ie("/devices/$device_id",{$device_id:e});return this.http.authedRequest(se.Get,t)}setDeviceDetails(e,t){var r=Ie("/devices/$device_id",{$device_id:e});return this.http.authedRequest(se.Put,r,void 0,t)}deleteDevice(e,t){var r=Ie("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(se.Delete,r,void 0,n)}deleteMultipleDevices(e,t){var r={devices:e};t&&(r.auth=t);var n="/delete_devices";return this.http.authedRequest(se.Post,n,void 0,r)}getPushers(){var e=this;return R(function*(){var t=yield e.http.authedRequest(se.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(r=>(r.hasOwnProperty(op.name)||(r[op.name]=!0),r))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(se.Post,t,void 0,e)}removePusher(e,t){var r="/pushers/set",n={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(se.Post,r,void 0,n)}setLocalNotificationSettings(e,t){var r="".concat(ww.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(se.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Gn.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,n){var s=Ie("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(se.Put,s,void 0,n)}deletePushRule(e,t,r){var n=Ie("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(se.Delete,n)}setPushRuleEnabled(e,t,r,n){var s=Ie("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(se.Put,s,void 0,{enabled:n})}setPushRuleActions(e,t,r,n){var s=Ie("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(se.Put,s,void 0,{actions:n})}search(e,t){var{body:r,next_batch:n}=e,s={};return n&&(s.next_batch=n),this.http.authedRequest(se.Post,"/search",s,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(se.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(se.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r={device_keys:{}};return t!==void 0&&(r.token=t),e.forEach(n=>{r.device_keys[n]=[]}),this.http.authedRequest(se.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,n={};t===void 0&&(t="signed_curve25519");for(var[s,l]of e){var c=n[s]||{};fi(n,s,c),fi(c,l,t)}var d={one_time_keys:n};r&&(d.timeout=r);var h="/keys/claim";return this.http.authedRequest(se.Post,h,void 0,d)}getKeyChanges(e,t){var r={from:e,to:t};return this.http.authedRequest(se.Get,"/keys/changes",r)}uploadDeviceSigningKeys(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(se.Post,"/keys/device_signing/upload",void 0,r,{prefix:qt.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,Bi.V2,this.idBaseUrl);return this.http.requestOtherUrl(se.Post,t,e)}requestEmailToken(e,t,r,n,s){var l={client_secret:t,email:e,send_attempt:r==null?void 0:r.toString()};return n&&(l.next_link=n),this.http.idServerRequest(se.Post,"/validate/email/requestToken",l,Bi.V2,s)}requestMsisdnToken(e,t,r,n,s,l){var c={client_secret:r,country:e,phone_number:t,send_attempt:n==null?void 0:n.toString()};return s&&(c.next_link=s),this.http.idServerRequest(se.Post,"/validate/msisdn/requestToken",c,Bi.V2,l)}submitMsisdnToken(e,t,r,n){var s={sid:e,client_secret:t,token:r};return this.http.idServerRequest(se.Post,"/validate/msisdn/submitToken",s,Bi.V2,n??void 0)}submitMsisdnTokenOtherUrl(e,t,r,n){var s={sid:t,client_secret:r,token:n};return this.http.requestOtherUrl(se.Post,e,s)}getIdentityHashDetails(e){return this.http.idServerRequest(se.Get,"/hash_details",void 0,Bi.V2,e)}identityHashedLookup(e,t){var r=this;return R(function*(){var n={},s=yield r.getIdentityHashDetails(t);if(!s||!s.lookup_pepper||!s.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=s.lookup_pepper;var l={};if(s.algorithms.includes("sha256"))n.addresses=yield Promise.all(e.map((function(){var m=R(function*(_){var b=_[0].toLowerCase(),E=_[1].toLowerCase(),M=yield AR("".concat(b," ").concat(E," ").concat(n.pepper)),O=Gf(M);return l[O]=_[0],O});return function(_){return m.apply(this,arguments)}})())),n.algorithm="sha256";else if(s.algorithms.includes("none"))n.addresses=e.map(m=>{var _=m[0].toLowerCase(),b=m[1].toLowerCase(),E="".concat(_," ").concat(b);return l[E]=m[0],E}),n.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var c=yield r.http.idServerRequest(se.Post,"/lookup",n,Bi.V2,t);if(!(c!=null&&c.mappings))return[];var d=[];for(var h of Object.keys(c.mappings)){var v=c.mappings[h],p=l[h];if(!p)throw new Error("Identity server returned more results than expected");d.push({address:p,mxid:v})}return d})()}lookupThreePid(e,t,r){var n=this;return R(function*(){var s=yield n.identityHashedLookup([[t,e]],r),l=s.find(d=>d.address===t);if(!l)return{};var c={address:t,medium:e,mxid:l.mxid};return c})()}bulkLookupThreePids(e,t){var r=this;return R(function*(){var n=yield r.identityHashedLookup(e.map(d=>[d[1],d[0]]),t),s=[],l=function*(h){var v=e.find(p=>p[1]===h.address);if(!v)throw new Error("Identity sever returned unexpected results");s.push([v[0],h.address,h.mxid])};for(var c of n)yield*l(c);return{threepids:s}})()}getIdentityAccount(e){return this.http.idServerRequest(se.Get,"/account",void 0,Bi.V2,e)}sendToDevice(e,t,r){var n=Ie("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),s={messages:Ua(t)},l=new Map;for(var[c,d]of t)l.set(c,Array.from(d.keys()));return this.logger.debug("PUT ".concat(n),l),this.http.authedRequest(se.Put,n,void 0,s)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(se.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var r=Ie("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(se.Get,r,t)}getThirdpartyUser(e,t){var r=Ie("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(se.Get,r,t)}getTerms(e,t){var r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(se.Get,r)}agreeToTerms(e,t,r,n){var s=this.termsUrlForService(e,t),l={Authorization:"Bearer "+r};return this.http.requestOtherUrl(se.Post,s,{user_accepts:n},{headers:l})}reportEvent(e,t,r,n){var s=Ie("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(se.Post,s,void 0,{score:r,reason:n})}getRoomHierarchy(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0,l=Ie("/rooms/$roomId/hierarchy",{$roomId:e}),c={suggested_only:String(n),max_depth:r==null?void 0:r.toString(),from:s,limit:t==null?void 0:t.toString()};return this.http.authedRequest(se.Get,l,c,void 0,{prefix:qt.V1}).catch(d=>{if(d.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(se.Get,l,c,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw d})}unstableCreateFileTree(e){var t=this;return R(function*(){var{room_id:r}=yield t.createRoom({name:e,preset:Im.PrivateChat,power_level_content_override:Ir(Ir({},nN),{},{users:{[t.getUserId()]:100}}),creation_content:{[_f]:xo.Space},initial_state:[{type:np.name,state_key:ap.name,content:{[ip.name]:!0}},{type:$.RoomEncryption,state_key:"",content:{algorithm:Zr}}]});return new tT(t,r)})()}unstableGetFileTreeSpace(e){var t,r,n=this.getRoom(e);if((n==null?void 0:n.getMyMembership())!==We.Join)return null;var s=n.currentState.getStateEvents($.RoomCreate,""),l=n.currentState.getStateEvents(np.name,ap.name);if(!s)throw new Error("Expected single room create event");return!(l!=null&&(t=l.getContent())!==null&&t!==void 0&&t[ip.name])||((r=s.getContent())===null||r===void 0?void 0:r[_f])!==xo.Space?null:new tT(this,e)}slidingSync(e,t,r){var n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);var s=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(se.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:s,abortSignal:r})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(fr.IntentionalMentions)!==cr.Unsupported}getRoomSummary(e,t){var r=this;return R(function*(){var n={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var s=Ie("/summary/$roomid",{$roomid:e});return yield r.http.authedRequest(se.Get,s,{via:t},void 0,n)}catch(c){if(c instanceof hr&&c.errcode==="M_UNRECOGNIZED"){var l=Ie("/rooms/$roomid/summary",{$roomid:e});return yield r.http.authedRequest(se.Get,l,{via:t},void 0,n)}else throw c}})()}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return R(function*(){return e.http.authedRequest(se.Get,"/account/whoami")})()}timestampToEvent(e,t,r){var n=this;return R(function*(){var s=Ie("/rooms/$roomId/timestamp_to_event",{$roomId:e}),l={ts:t.toString(),dir:r};try{return yield n.http.authedRequest(se.Get,s,l,void 0,{prefix:qt.V1})}catch(c){if(c.errcode==="M_UNRECOGNIZED"&&(c.httpStatus===400||c.httpStatus===404||c.httpStatus===405))return yield n.http.authedRequest(se.Get,s,l,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw c}})()}getAuthIssuer(){var e=this;return R(function*(){return e.http.request(se.Get,"/auth_issuer",void 0,void 0,{prefix:qt.Unstable+"/org.matrix.msc2965"})})()}}y(ll,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function cT(a){return Object.fromEntries(Object.entries(a).map(e=>{var[t,r]=e;return["".concat(di,".").concat(t),r]}))}function PR(a,e){var t,r=a.getUserId(),n=e.getId(),s=a.getRoom(e.getRoomId());if(!(!s||!r||!n)){if(!s.findEventById(n)){T.info("Decrypted event ".concat(e.getId()," is not in room ").concat(s.roomId,": ignoring"));return}var l=!!e.threadRootId&&!e.isThreadRoot,c;if(l){var d=s.getThread(e.threadRootId);c=d?d.hasUserReadEvent(r,n):!0}else c=s.hasUserReadEvent(r,n);if(!c){var h=a.getPushActionsForEvent(e,!0),v=!!(h!=null&&(t=h.tweaks)!==null&&t!==void 0&&t.highlight);if(v){var p=s.getUnreadCountForEventContext(pt.Highlight,e)+1;l?s.setThreadUnreadNotificationCount(e.threadRootId,pt.Highlight,p):s.setUnreadNotificationCount(pt.Highlight,p)}var m=!!(h!=null&&h.notify);if(m){var _=s.getUnreadCountForEventContext(pt.Total,e)+1;l?s.setThreadUnreadNotificationCount(e.threadRootId,pt.Total,_):s.setUnreadNotificationCount(pt.Total,_)}}}}function el(a){return lc(a)?yc:a.threadRootId}function lc(a){if(!a.threadRootId||a.isThreadRoot)return!0;if(!a.isRelation())return T.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(a.getId())),!0;if(a.isRelation(Ot.name))return!1;var e=a.relationEventId===a.threadRootId;return e}function dT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function fT(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?dT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):dT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var Br=(function(a){return a.New="Thread.new",a.Update="Thread.update",a.NewReply="Thread.newReply",a.ViewThread="Thread.viewThread",a.Delete="Thread.delete",a})({}),Ur=(function(a){return a[a.None=0]="None",a[a.Experimental=1]="Experimental",a[a.Stable=2]="Stable",a})({});function ff(a,e){return a?Ur.Stable:e?Ur.Experimental:Ur.None}class Ut extends Fw{constructor(e,t,r){var n,s;if(super(),n=this,this.id=e,this.rootEvent=t,y(this,"timelineSet",void 0),y(this,"_currentUserParticipated",!1),y(this,"reEmitter",void 0),y(this,"lastEvent",void 0),y(this,"replyCount",0),y(this,"lastPendingEvent",void 0),y(this,"pendingReplyCount",0),y(this,"room",void 0),y(this,"client",void 0),y(this,"pendingEventOrdering",void 0),y(this,"processRootEventPromise",void 0),y(this,"initialEventsFetched",!Ut.hasServerSideSupport),y(this,"initalEventFetchProm",void 0),y(this,"replayEvents",[]),y(this,"onTimelineReset",R(function*(){yield n.processRootEventPromise,n.processRootEventPromise=void 0})),y(this,"onBeforeRedaction",(l,c)=>{l!=null&&l.isRelation(Ot.name)&&this.room.eventShouldLiveIn(l).threadId===this.id&&l.getId()!==this.id&&!c.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(Br.Update,this))}),y(this,"onRedaction",(function(){var l=R(function*(c,d,h){if(h===n.id)if(n.replyCount<=0){for(var v of n.timeline)n.clearEventMetadata(v);n.lastEvent=n.rootEvent,n._currentUserParticipated=!1,n.emit(Br.Delete,n)}else{var p;((p=n.lastEvent)===null||p===void 0?void 0:p.getId())===c.getAssociatedId()&&(yield n.processRootEventPromise,n.processRootEventPromise=void 0),yield n.updateThreadMetadata()}});return function(c,d,h){return l.apply(this,arguments)}})()),y(this,"onTimelineEvent",(l,c,d)=>{if(!d){var h=l.getSender();h&&c&&this.shouldSendLocalEchoReceipt(h,l)&&c.addLocalEchoReceipt(h,l,xr.Read),l.getId()!==this.id&&l.isRelation(Ot.name)&&this.replyCount++}this.onEcho(l,d??!1)}),y(this,"onLocalEcho",l=>{this.onEcho(l,!1)}),y(this,"onEcho",(function(){var l=R(function*(c,d){c.threadRootId===n.id&&n.lastEvent!==c&&(yield n.updateThreadMetadata(),c.isRelation(Ot.name)&&(d||(n.lastEvent=void 0,n.emit(Br.NewReply,n,c))))});return function(c,d){return l.apply(this,arguments)}})()),this.setMaxListeners(1e3),!(r!=null&&r.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=r.room,this.client=r.client,this.pendingEventOrdering=(s=r.pendingEventOrdering)!==null&&s!==void 0?s:Zo.Chronological,this.timelineSet=new Lo(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new al(this),this.reEmitter.reEmit(this.timelineSet,[Ue.Timeline,Ue.TimelineReset]),this.room.on(ct.BeforeRedaction,this.onBeforeRedaction),this.room.on(Ue.Redaction,this.onRedaction),this.room.on(Ue.LocalEchoUpdated,this.onLocalEcho),this.room.on(Ue.TimelineReset,this.onTimelineReset),this.timelineSet.on(Ue.Timeline,this.onTimelineEvent),this.processReceipts(r.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return R(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),r=e.client.getEventMapper();e.rootEvent=r(t)}catch(n){T.error("Failed to fetch thread root to construct thread with",n)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){Ut.hasServerSideSupport=e,e!==Ur.Stable&&(Vo.setPreferUnstable(!0),Go.setPreferUnstable(!0),Ot.setPreferUnstable(!0))}static setServerSideListSupport(e){Ut.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){Ut.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var r,n=(r=this.client.canSupport.get(fr.RelationsRecursion))!==null&&r!==void 0?r:cr.Unsupported;if(n===cr.Unsupported){var s,l=(s=this.getReadReceiptForUserId(e))===null||s===void 0?void 0:s.eventId;if(l){var c=this.findEventById(l);if(c&&c.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(ke.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState))}addEvents(e,t){e.forEach(r=>this.addEvent(r,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var n=this.lastReply(),s=!n||e.localTimestamp>=n.localTimestamp;if(!Ut.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(Ht.Annotation)||e.isRelation(Ht.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&s?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(Ot.name)&&!t&&s&&(this.lastEvent=void 0),r&&(this.emit(Br.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var r,n;if(this.initialEventsFetched){var l,c=(l=this.client.canSupport.get(fr.RelationsRecursion))!==null&&l!==void 0?l:cr.Unsupported;c===cr.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var s;(s=this.replayEvents)===null||s===void 0||s.push(e)}(r=this.timelineSet.relations)===null||r===void 0||r.aggregateParentEvent(e),(n=this.timelineSet.relations)===null||n===void 0||n.aggregateChildEvent(e,this.timelineSet)}processEvent(e){var t=this;return R(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:r,userId:n,receipt:s,synthetic:l}of e)this.addReceiptToStructure(t,r,n,s,l)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e==null?void 0:e.getServerAggregatedRelation(Ot.name)}processRootEvent(){var e=this;return R(function*(){var t=e.getRootEventBundledRelationship();if(Ut.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var r=e.client.getEventMapper();e.lastEvent=r(fT(fT({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===Zo.Detached?this.room.getPendingEvents():this.events,t=e.filter(r=>{var n;return r.threadRootId===this.id&&r.isRelation(Ot.name)&&r.status!==null&&r.getId()!==((n=this.lastEvent)===null||n===void 0?void 0:n.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var r=this;return R(function*(){var n=r.liveTimeline;r.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var s=r.liveTimeline,l,c;if(e){var d=yield r.client.createMessagesRequest(r.roomId,e,1,tt.Forward);l=d.end}if(t){var h=yield r.client.createMessagesRequest(r.roomId,t,1,tt.Backward);c=h.start}if(t&&n.getPaginationToken(tt.Forward)===t){var v;n.setPaginationToken((v=c)!==null&&v!==void 0?v:null,tt.Forward)}if(e&&s.getPaginationToken(tt.Backward)===e){var p;s.setPaginationToken((p=l)!==null&&p!==void 0?p:null,tt.Backward)}})()}updateThreadFromRootEvent(){var e=this;return R(function*(){Ut.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return R(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,tt.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(Ue.TimelineReset,e.room,e.timelineSet,!0)}catch(r){T.error("Failed to load start of newly created thread: ",r),e.initialEventsFetched=!1}e.emit(Br.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return R(function*(){var r,n=(r=t.client.canSupport.get(fr.RelationsRecursion))!==null&&r!==void 0?r:cr.Unsupported;if(n===cr.Unsupported){for(var s=e.length,l=new Array(s),c=0;c<s;c++)l[c]=e[c];return Promise.all(l.filter(RN).map((function(){var d=R(function*(h){try{var v=yield t.client.relations(t.roomId,h.getId(),Ht.Replace,h.getType(),{limit:1});if(v.events.length){var p=v.events[0];h.makeReplaced(p),t.insertEventIntoTimeline(p)}}catch(m){T.error("Failed to load edits for encrypted thread event",m)}});return function(h){return d.apply(this,arguments)}})()))}})()}setEventMetadata(e){e&&(ke.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[Ot.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:n=>n.isRelation(Ot.name),t=this.timeline.length-1;t>=0;t--){var r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof _r}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){var s=n.getTs()<this.room.getOldestThreadedReceiptTs(),l=n.getId();if(s&&l)return l}var c=super.getEventReadUpTo(e,t);if(n){var d=this.room.getLastUnthreadedReceiptFor(e);if(!d)return c;for(var h=((v=this.timeline)===null||v===void 0?void 0:v.length)-1;h>=0;--h){var v,p,m=this.timeline[h];if(m.getId()===c)return c;if(m.getTs()<d.ts)return(p=m.getId())!==null&&p!==void 0?p:c}}return c}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,s,l,c,d,h=((r=(n=this.lastReply())===null||n===void 0?void 0:n.getTs())!==null&&r!==void 0?r:0)<this.room.getOldestThreadedReceiptTs(),v=(s=(l=this.room.getLastUnthreadedReceiptFor(e))===null||l===void 0?void 0:l.ts)!==null&&s!==void 0?s:0,p=((c=this===null||this===void 0||(d=this.lastReply())===null||d===void 0?void 0:d.getTs())!==null&&c!==void 0?c:0)<v;if(h||p)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}y(Ut,"hasServerSideSupport",Ur.None);y(Ut,"hasServerSideListSupport",Ur.None);y(Ut,"hasServerSideFwdPaginationSupport",Ur.None);function RN(a){return a.isEncrypted()&&(a.isRelation(Ot.name)||a.isThreadRoot)}var Vo=new Lf("related_by_senders","io.element.relation_senders"),Go=new Lf("related_by_rel_types","io.element.relation_types"),Ot=new Lf("m.thread","io.element.thread"),Vn=(function(a){return a[a.My=0]="My",a[a.All=1]="All",a})({});function LR(a){switch(a){case Vn.My:return"participated";default:return"all"}}var hT=Object.freeze({visible:!0}),ct=(function(a){return a.Decrypted="Event.decrypted",a.BeforeRedaction="Event.beforeRedaction",a.VisibilityChange="Event.visibilityChange",a.LocalEventIdReplaced="Event.localEventIdReplaced",a.Status="Event.status",a.Replaced="Event.replaced",a.RelationsCreated="Event.relationsCreated",a})({});class _r extends Pt{constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,y(this,"pushDetails",{}),y(this,"_replacingEvent",null),y(this,"_localRedactionEvent",null),y(this,"_isCancelled",!1),y(this,"clearEvent",void 0),y(this,"visibility",hT),y(this,"_hasCachedExtEv",!1),y(this,"_cachedExtEv",void 0),y(this,"_decryptionFailureReason",null),y(this,"senderCurve25519Key",null),y(this,"claimedEd25519Key",null),y(this,"forwardingCurve25519KeyChain",[]),y(this,"untrusted",null),y(this,"decryptionPromise",null),y(this,"retryDecryption",!1),y(this,"txnId",void 0),y(this,"thread",void 0),y(this,"threadId",void 0),y(this,"localTimestamp",void 0),y(this,"sender",null),y(this,"target",null),y(this,"status",null),y(this,"error",null),y(this,"forwardLooking",!0),y(this,"verificationRequest",void 0),y(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(n=>{typeof t[n]=="string"&&(t[n]=wg(t[n]))}),["membership","avatar_url","displayname"].forEach(n=>{var s;typeof((s=t.content)===null||s===void 0?void 0:s[n])=="string"&&(t.content[n]=wg(t.content[n]))}),["rel_type"].forEach(n=>{var s;typeof((s=t.content)===null||s===void 0||(s=s["m.relates_to"])===null||s===void 0?void 0:s[n])=="string"&&(t.content["m.relates_to"][n]=wg(t.content["m.relates_to"][n]))}),this.txnId=t.txn_id;var r=this.getAge();this.localTimestamp=r!==void 0?Date.now()-r:(e=this.getTs())!==null&&e!==void 0?e:Date.now(),this.reEmitter=new al(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=tn.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===$.RoomMessageEncrypted)for(var[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var r=this.getContent()[Fr];return"msgid=".concat(r," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if((t==null?void 0:t.rel_type)===Ot.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var r=this.getUnsigned();if(typeof r[Ef.name]=="string")return r[Ef.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(Ot.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return Rw.findIn(e)}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.decryptionFailureReason===zt.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(!r.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var s=r.clearEvent&&!r.isDecryptionFailure(),l=n.forceRedecryptIfUntrusted&&r.isKeySourceUntrusted();if(s&&!l)throw new Error("Attempt to decrypt event which has already been decrypted");return r.decryptionPromise?(T.log("Event ".concat(r.getId()," already being decrypted; queueing a retry")),r.retryDecryption=!0,r.decryptionPromise):(r.decryptionPromise=r.decryptionLoop(e,n),r.decryptionPromise)})()}cancelAndResendKeyRequest(e,t){var r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){r.retryDecryption=!1;var s=void 0;try{var l=yield e.decryptEvent(r);n.isRetry===!0&&T.info("Decrypted event on retry (".concat(r.getDetails(),")")),r.setClearData(l),r._decryptionFailureReason=null}catch(d){var c=d instanceof dr?d.detailedString:String(d);if(s=d,r.retryDecryption){T.log("Error decrypting event (".concat(r.getDetails(),"), but retrying: ").concat(c));continue}T.warn("Error decrypting event (".concat(r.getDetails(),"): ").concat(c)),r.setClearDataForDecryptionFailure(String(d)),r._decryptionFailureReason=d instanceof dr?d.code:zt.UNKNOWN_ERROR}r.decryptionPromise=null,r.retryDecryption=!1,r.setPushDetails(),n.emit!==!1&&r.emit(ct.Decrypted,r,s);return}})()}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(r=e.claimedEd25519Key)!==null&&r!==void 0?r:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:$.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===$.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(ct.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r,n=(t=e==null?void 0:e.visible)!==null&&t!==void 0?t:!0,s=(r=e==null?void 0:e.reason)!==null&&r!==void 0?r:null,l=!1;(this.visibility.visible!==n||!this.visibility.visible&&this.visibility.reason!==s)&&(l=!0),l&&(n?this.visibility=hT:this.visibility=Object.freeze({visible:!1,reason:s}),this.emit(ct.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(ct.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var r in this.event)this.event.hasOwnProperty(r)&&!CN.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=void 0);var n=this.getType()in vT?vT[this.getType()]:{},s=this.getContent();for(var l in s)s.hasOwnProperty(l)&&!n[l]&&delete s[l];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var r of t.events){var n;((n=r.getRelation())===null||n===void 0?void 0:n.event_id)===this.getId()&&r.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(ke.FORWARDS))}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===$.RoomRedaction}asVisibilityChange(){if(!Is.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var r=this.getWireContent(),n=!!r.visible,s=r.reason;return s&&typeof s!="string"?null:{visible:n,reason:s,eventId:t}}isVisibilityEvent(){return Is.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var r,n;return(r=(n=this.clearEvent)===null||n===void 0?void 0:n.unsigned.redacted_because)!==null&&r!==void 0?r:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t=this.getUnsigned(),r=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit(ct.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(ct.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(ct.LocalEventIdReplaced,this)}isRelation(e){var t,r=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(r!=null&&r.rel_type)&&[Ht.Replace,Ht.Thread].includes(r.rel_type)?!1:!!(r!=null&&r.rel_type&&r.event_id&&(!e||r.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(ct.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(Ht.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(Ht.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var r;return(r=this._replacingEvent.getDate())!==null&&r!==void 0?r:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new _r(JSON.parse(JSON.stringify(this.event)));for(var[t,r]of Object.entries(this))t!=="event"&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=Qg(this.event),r=Qg(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[Br.Update]),this.thread=e,this.setThreadId(e==null?void 0:e.id),e&&this.reEmitter.reEmit(e,[Br.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}var CN=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),vT={[$.RoomMember]:{membership:1},[$.RoomJoinRules]:{join_rule:1},[$.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},gn=(function(a){return a[a.NotStarted=0]="NotStarted",a[a.InProgress=1]="InProgress",a[a.Finished=2]="Finished",a})(gn||{}),$e=(function(a){return a.Events="RoomState.events",a.Members="RoomState.members",a.NewMember="RoomState.newMember",a.Update="RoomState.update",a.BeaconLiveness="RoomState.BeaconLiveness",a.Marker="RoomState.Marker",a})({});class uc extends Pt{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:gn.NotStarted},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;super(),this.roomId=e,this.oobMemberFlags=t,this.isStartTimelineState=r,y(this,"reEmitter",new al(this)),y(this,"sentinels",{}),y(this,"displayNameToUserIds",new Map),y(this,"userIdsToDisplayNames",{}),y(this,"tokenToInvite",{}),y(this,"joinedMemberCount",null),y(this,"summaryJoinedMemberCount",null),y(this,"invitedMemberCount",null),y(this,"summaryInvitedMemberCount",null),y(this,"modified",-1),y(this,"members",{}),y(this,"events",new Map),y(this,"paginationToken",null),y(this,"beacons",new Map),y(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===We.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===We.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new Tf(this.roomId,e);var r=this.members[e];r!=null&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var r=this.events.get(e).get(t);return r||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new uc(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=gn.NotStarted,Array.from(this.events.values()).forEach(r=>{e.setStateEvents(Array.from(r.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==gn.Finished&&this.getMembers().forEach(r=>{if(r.isOutOfBand()){var n;(n=e.getMember(r.userId))===null||n===void 0||n.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(r=>!this.events.has(r.getType())||!this.events.get(r.getType()).has(r.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(r=>{var n,s;if(!(r.getRoomId()!==this.roomId||!r.isState())){om.matches(r.getType())&&this.setBeacon(r);var l=this.getStateEventMatching(r),c=l==null||(n=l.event.unsigned)===null||n===void 0?void 0:n.replaces_state,d=l==null?void 0:l.event.event_id,h=(s=r.event.unsigned)===null||s===void 0?void 0:s.replaces_state,v=r.event.event_id;if(this.isStartTimelineState){if(h&&d&&h===d)return}else if(c&&v&&c===v)return;if(this.setStateEvent(r),r.getType()===$.RoomMember){var p;this.updateDisplayNameCache(r.getStateKey(),(p=r.getContent().displayname)!==null&&p!==void 0?p:""),this.updateThirdPartyTokenCache(r)}this.emit($e.Events,r,this,l)}}),this.onBeaconLivenessChange(),e.forEach(r=>{if(!(r.getRoomId()!==this.roomId||!r.isState()))if(r.getType()===$.RoomMember){var n=r.getStateKey();(r.getContent().membership===We.Leave||r.getContent().membership===We.Ban)&&(r.getContent().avatar_url=r.getContent().avatar_url||r.getPrevContent().avatar_url,r.getContent().displayname=r.getContent().displayname||r.getPrevContent().displayname);var s=this.getOrCreateMember(n,r);s.setMembershipEvent(r,this),this.updateMember(s),this.emit($e.Members,r,this,s)}else if(r.getType()===$.RoomPowerLevels){if(r.getStateKey()!=="")return;var l=Object.values(this.members);l.forEach(c=>{var d=c.getLastModifiedTime();c.setPowerLevelEvent(r),d!==c.getLastModifiedTime()&&this.emit($e.Members,r,this,c)}),this.sentinels={}}else Ew.matches(r.getType())&&this.emit($e.Marker,r,t)}),this.emit($e.Update,this)}processBeaconEvents(e,t){var r=this;return R(function*(){if(!(!e.length||!r.beacons.size)){var n=[...r.beacons.values()].reduce((h,v)=>(h[v.beaconInfoId]=v,h),{}),s=(h,v)=>{if(rp.matches(v.getType())){var p=n[h];p&&p.addLocations([v])}},l=function*(v){var p,m=(p=v.getRelation())===null||p===void 0?void 0:p.event_id;if(!m||!n[m])return{v:void 0};if(!rp.matches(v.getType())&&!v.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(v),s(m,v)}catch{v.isDecryptionFailure()&&v.once(ct.Decrypted,R(function*(){s(m,v)}))}},c;for(var d of e)if(c=yield*l(d),c)return c.v}})()}getOrCreateMember(e,t){var r=this.members[e];return r||(r=new Tf(this.roomId,e),this.members[e]=r,this.emit($e.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=wf(e);if(this.beacons.has(t)){var r=this.beacons.get(t);if(e.isRedacted()){var n;r.beaconInfoId===((n=e.getRedactionEvent())===null||n===void 0?void 0:n.redacts)&&(r.destroy(),this.beacons.delete(t));return}return r.update(e)}if(!e.isRedacted()){var s=new Kw(e);this.reEmitter.reEmit(s,[Bt.New,Bt.Update,Bt.Destroy,Bt.LivenessChange]),this.emit(Bt.New,e,s),s.on(Bt.LivenessChange,this.onBeaconLivenessChange.bind(this)),s.on(Bt.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(s.identifier,s)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit($e.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return(t=(r=this.events.get(e.getType()))===null||r===void 0?void 0:r.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents($.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===gn.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===gn.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===gn.NotStarted&&(this.oobMemberFlags.status=gn.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===gn.InProgress&&(this.oobMemberFlags.status=gn.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var r=this.members[t];r.isOutOfBand()&&(++e,delete this.members[t])}),T.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=gn.NotStarted}setOutOfBandMembers(e){T.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===gn.InProgress&&(T.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=gn.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit($e.Update,this))}setOutOfBandMember(e){if(e.getType()===$.RoomMember){var t=e.getStateKey(),r=this.getMember(t);if(!(r&&!r.isOutOfBand())){var n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit($e.Members,e,this,n)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(Os(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var r=this.getMember(t);if(!r||r.membership===We.Leave||e.status||e.isRedacted())return!1;var n=this.maySendEvent($.RoomRedaction,t);return n?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",r.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var r=this.getStateEvents($.RoomPowerLevels,""),n={};r&&(n=r.getContent());var s=50;return NE(n[e])&&(s=n[e]),t>=s}maySendMessage(e){return this.maySendEventOfType($.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){var n=this.getStateEvents($.RoomPowerLevels,""),s,l={},c=0,d=0,h=0;if(n){s=n.getContent(),l=s.events||{},Number.isSafeInteger(s.state_default)?c=s.state_default:c=50;var v=s.users&&s.users[t];Number.isSafeInteger(v)?h=v:Number.isSafeInteger(s.users_default)&&(h=s.users_default),Number.isSafeInteger(s.events_default)&&(d=s.events_default)}var p=r?c:d;return Number.isSafeInteger(l[e])&&(p=l[e]),h>=p}mayTriggerNotifOfType(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents($.RoomPowerLevels,""),s=50;return n&&n.getContent()&&n.getContent().notifications&&NE(n.getContent().notifications[e])&&(s=n.getContent().notifications[e]),r.powerLevel>=s}getJoinRule(){var e,t=this.getStateEvents($.RoomJoinRules,""),r=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return r.join_rule||RR.Invite}getHistoryVisibility(){var e,t=this.getStateEvents($.RoomHistoryVisibility,""),r=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return r.history_visibility||Om.Shared}getGuestAccess(){var e,t=this.getStateEvents($.RoomGuestAccess,""),r=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return r.guest_access||Df.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents($.RoomPredecessor,"");if(t){var r=t.getContent(),n=r.predecessor_room_id,s=r.last_known_event_id;typeof s!="string"&&(s=void 0);var l=r.via_servers;if(Array.isArray(l)||(l=void 0),typeof n=="string")return{roomId:n,eventId:s,viaServers:l}}}var c=this.getStateEvents($.RoomCreate,"");if(c){var d=c.getContent().predecessor;if(d){var h=d.room_id;if(typeof h=="string"){var v=d.event_id;return(typeof v!="string"||v==="")&&(v=void 0),{roomId:h,eventId:v}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var r=this.getStateEvents($.RoomThirdPartyInvite,t);r&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){var n=Os(r),s=this.displayNameToUserIds.get(n);if(s){var l=s.filter(v=>v!==e);this.displayNameToUserIds.set(n,l)}}this.userIdsToDisplayNames[e]=t;var c=t&&Os(t);if(c){var d,h=(d=this.displayNameToUserIds.get(c))!==null&&d!==void 0?d:[];h.push(e),this.displayNameToUserIds.set(c,h)}}}function gT(a){var e=typeof a=="string"&&!!a&&a!=="undefined"&&a!=="null";return e||typeof a=="number"}class km{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};y(this,"rooms",{}),y(this,"users",{}),y(this,"syncToken",null),y(this,"filters",new Xt(()=>new Map)),y(this,"accountData",new Map),y(this,"localStorage",void 0),y(this,"oobMembers",new Map),y(this,"pendingEvents",{}),y(this,"clientOptions",void 0),y(this,"pendingToDeviceBatches",[]),y(this,"nextToDeviceBatchId",0),y(this,"createUser",void 0),y(this,"onRoomMember",(t,r,n)=>{var s;if(n.membership!==We.Invite){var l=this.users[n.userId]||((s=this.createUser)===null||s===void 0?void 0:s.call(this,n.userId));n.name&&(l.setDisplayName(n.name),n.events.member&&l.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&l.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[l.userId]=l}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on($e.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener($e.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return((r=this.filters.get(e))===null||r===void 0?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var r=this.localStorage.getItem(t);if(gT(r))return r}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{gT(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var r=!Object.keys(t.getContent()).length;r?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new Xt(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return R(function*(){var r;return(r=t.pendingEvents[e])!==null&&r!==void 0?r:[]})()}setPendingEvents(e,t){var r=this;return R(function*(){r.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return R(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return R(function*(){})()}}var Gg={},ps={},Ao={},pT;function Am(){if(pT)return Ao;pT=1,Object.defineProperty(Ao,"__esModule",{value:!0}),Ao.WidgetApiDirection=void 0,Ao.invertedDirection=e;var a=(function(t){return t.ToWidget="toWidget",t.FromWidget="fromWidget",t})({});Ao.WidgetApiDirection=a;function e(t){if(t===a.ToWidget)return a.FromWidget;if(t===a.FromWidget)return a.ToWidget;throw new Error("Invalid direction")}return Ao}var Li={},mT;function Dm(){if(mT)return Li;mT=1,Object.defineProperty(Li,"__esModule",{value:!0}),Li.UnstableApiVersion=Li.MatrixApiVersion=Li.CurrentApiVersions=void 0;var a=(function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r})({});Li.MatrixApiVersion=a;var e=(function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",r.MSC2871="org.matrix.msc2871",r.MSC2873="org.matrix.msc2873",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r})({});Li.UnstableApiVersion=e;var t=[a.Prerelease1,a.Prerelease2,e.MSC2762,e.MSC2762_UPDATE_STATE,e.MSC2871,e.MSC2873,e.MSC2931,e.MSC2974,e.MSC2876,e.MSC3819,e.MSC3846,e.MSC3869,e.MSC3973,e.MSC4039];return Li.CurrentApiVersions=t,Li}var _u={},yT;function Mm(){if(yT)return _u;yT=1,Object.defineProperty(_u,"__esModule",{value:!0}),_u.PostmessageTransport=void 0;var a=jf(),e=Qf(),t=["message"];function r(w){"@babel/helpers - typeof";return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(N){return typeof N}:function(N){return N&&typeof Symbol=="function"&&N.constructor===Symbol&&N!==Symbol.prototype?"symbol":typeof N},r(w)}function n(w,N){if(w==null)return{};var A=s(w,N),K,z;if(Object.getOwnPropertySymbols){var de=Object.getOwnPropertySymbols(w);for(z=0;z<de.length;z++)K=de[z],!(N.indexOf(K)>=0)&&Object.prototype.propertyIsEnumerable.call(w,K)&&(A[K]=w[K])}return A}function s(w,N){if(w==null)return{};var A={},K=Object.keys(w),z,de;for(de=0;de<K.length;de++)z=K[de],!(N.indexOf(z)>=0)&&(A[z]=w[z]);return A}function l(w,N){var A=Object.keys(w);if(Object.getOwnPropertySymbols){var K=Object.getOwnPropertySymbols(w);N&&(K=K.filter(function(z){return Object.getOwnPropertyDescriptor(w,z).enumerable})),A.push.apply(A,K)}return A}function c(w){for(var N=1;N<arguments.length;N++){var A=arguments[N]!=null?arguments[N]:{};N%2?l(Object(A),!0).forEach(function(K){C(w,K,A[K])}):Object.getOwnPropertyDescriptors?Object.defineProperties(w,Object.getOwnPropertyDescriptors(A)):l(Object(A)).forEach(function(K){Object.defineProperty(w,K,Object.getOwnPropertyDescriptor(A,K))})}return w}function d(w,N){if(!(w instanceof N))throw new TypeError("Cannot call a class as a function")}function h(w,N){for(var A=0;A<N.length;A++){var K=N[A];K.enumerable=K.enumerable||!1,K.configurable=!0,"value"in K&&(K.writable=!0),Object.defineProperty(w,U(K.key),K)}}function v(w,N,A){return N&&h(w.prototype,N),Object.defineProperty(w,"prototype",{writable:!1}),w}function p(w,N){if(typeof N!="function"&&N!==null)throw new TypeError("Super expression must either be null or a function");w.prototype=Object.create(N&&N.prototype,{constructor:{value:w,writable:!0,configurable:!0}}),Object.defineProperty(w,"prototype",{writable:!1}),N&&m(w,N)}function m(w,N){return m=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(K,z){return K.__proto__=z,K},m(w,N)}function _(w){var N=M();return function(){var K=O(w),z;if(N){var de=O(this).constructor;z=Reflect.construct(K,arguments,de)}else z=K.apply(this,arguments);return b(this,z)}}function b(w,N){if(N&&(r(N)==="object"||typeof N=="function"))return N;if(N!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return E(w)}function E(w){if(w===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return w}function M(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function O(w){return O=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(A){return A.__proto__||Object.getPrototypeOf(A)},O(w)}function C(w,N,A){return N=U(N),N in w?Object.defineProperty(w,N,{value:A,enumerable:!0,configurable:!0,writable:!0}):w[N]=A,w}function U(w){var N=I(w,"string");return r(N)==="symbol"?N:String(N)}function I(w,N){if(r(w)!=="object"||w===null)return w;var A=w[Symbol.toPrimitive];if(A!==void 0){var K=A.call(w,N);if(r(K)!=="object")return K;throw new TypeError("@@toPrimitive must return a primitive value.")}return(N==="string"?String:Number)(w)}var D=(function(w){p(A,w);var N=_(A);function A(K,z,de,_e){var le;return d(this,A),le=N.call(this),le.sendDirection=K,le.transportWindow=de,le.inboundWindow=_e,C(E(le),"strictOriginCheck",!1),C(E(le),"targetOrigin","*"),C(E(le),"timeoutSeconds",10),C(E(le),"_ready",!1),C(E(le),"_widgetId",void 0),C(E(le),"outboundRequests",new Map),C(E(le),"stopController",new AbortController),C(E(le),"handleMessage",function(Ce){if(!le.stopController.signal.aborted&&Ce.data&&!(le.strictOriginCheck&&Ce.origin!==globalThis.origin)){var V=Ce.data;if(!(!V.action||!V.requestId||!V.widgetId))if(V.response){if(V.api!==le.sendDirection)return;le.handleResponse(V)}else{var B=V;if(B.api!==(0,e.invertedDirection)(le.sendDirection))return;le.handleRequest(B)}}}),le._widgetId=z,le}return v(A,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var z="widgetapi-".concat(Date.now()),de=0,_e=z;this.outboundRequests.has(_e);)_e="".concat(z,"-").concat(de++);return this.outboundRequests.set(_e,null),_e}},{key:"sendInternal",value:function(z){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),z),this.transportWindow.postMessage(z,this.targetOrigin)}},{key:"reply",value:function(z,de){return this.sendInternal(c(c({},z),{},{response:de}))}},{key:"send",value:function(z,de){return this.sendComplete(z,de).then(function(_e){return _e.response})}},{key:"sendComplete",value:function(z,de){var _e=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var le={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:z,data:de};return z===e.WidgetApiToWidgetAction.UpdateVisibility&&(le.visible=de.visible),new Promise(function(Ce,V){var B=function(ue){De(),Ce(ue)},te=function(ue){De(),V(ue)},he=setTimeout(function(){return te(new Error("Request timed out"))},(_e.timeoutSeconds||1)*1e3),be=function(){return te(new Error("Transport stopped"))};_e.stopController.signal.addEventListener("abort",be);var De=function(){_e.outboundRequests.delete(le.requestId),clearTimeout(he),_e.stopController.signal.removeEventListener("abort",be)};_e.outboundRequests.set(le.requestId,{request:le,resolve:B,reject:te}),_e.sendInternal(le)})}},{key:"start",value:function(){this.inboundWindow.addEventListener("message",this.handleMessage),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort(),this.inboundWindow.removeEventListener("message",this.handleMessage)}},{key:"handleRequest",value:function(z){if(this.widgetId){if(this.widgetId!==z.widgetId)return}else this._widgetId=z.widgetId;this.emit("message",new CustomEvent("message",{detail:z}))}},{key:"handleResponse",value:function(z){if(z.widgetId===this.widgetId){var de=this.outboundRequests.get(z.requestId);if(de)if((0,e.isErrorResponse)(z.response)){var _e=z.response.error,le=_e.message,Ce=n(_e,t);de.reject(new e.WidgetApiResponseError(le,Ce))}else de.resolve(z)}}}]),A})(a.EventEmitter);return _u.PostmessageTransport=D,_u}var ms={},ST;function Nm(){if(ST)return ms;ST=1,Object.defineProperty(ms,"__esModule",{value:!0}),ms.WidgetApiToWidgetAction=ms.WidgetApiFromWidgetAction=void 0;var a=(function(t){return t.SupportedApiVersions="supported_api_versions",t.Capabilities="capabilities",t.NotifyCapabilities="notify_capabilities",t.ThemeChange="theme_change",t.LanguageChange="language_change",t.TakeScreenshot="screenshot",t.UpdateVisibility="visibility",t.OpenIDCredentials="openid_credentials",t.WidgetConfig="widget_config",t.CloseModalWidget="close_modal",t.ButtonClicked="button_clicked",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.UpdateState="update_state",t.UpdateTurnServers="update_turn_servers",t})({});ms.WidgetApiToWidgetAction=a;var e=(function(t){return t.SupportedApiVersions="supported_api_versions",t.ContentLoaded="content_loaded",t.SendSticker="m.sticker",t.UpdateAlwaysOnScreen="set_always_on_screen",t.GetOpenIDCredentials="get_openid",t.CloseModalWidget="close_modal",t.OpenModalWidget="open_modal",t.SetModalButtonEnabled="set_button_enabled",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.WatchTurnServers="watch_turn_servers",t.UnwatchTurnServers="unwatch_turn_servers",t.BeeperReadRoomAccountData="com.beeper.read_room_account_data",t.MSC2876ReadEvents="org.matrix.msc2876.read_events",t.MSC2931Navigate="org.matrix.msc2931.navigate",t.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",t.MSC3869ReadRelations="org.matrix.msc3869.read_relations",t.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",t.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",t.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",t.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",t.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",t})({});return ms.WidgetApiFromWidgetAction=e,ms}var Eu={},bT;function Um(){if(bT)return Eu;bT=1,Object.defineProperty(Eu,"__esModule",{value:!0}),Eu.OpenIDRequestState=void 0;var a=(function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e})({});return Eu.OpenIDRequestState=a,Eu}var Tu={},_T;function xR(){if(_T)return Tu;_T=1,Object.defineProperty(Tu,"__esModule",{value:!0}),Tu.MatrixWidgetType=void 0;var a=(function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e})({});return Tu.MatrixWidgetType=a,Tu}var wu={},ET;function BR(){if(ET)return wu;ET=1,Object.defineProperty(wu,"__esModule",{value:!0}),wu.BuiltInModalButtonID=void 0;var a=(function(e){return e.Close="m.close",e})({});return wu.BuiltInModalButtonID=a,wu}var xi={},TT;function Pm(){if(TT)return xi;TT=1,Object.defineProperty(xi,"__esModule",{value:!0}),xi.WidgetEventCapability=xi.EventKind=xi.EventDirection=void 0;function a(m){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},a(m)}function e(m,_){var b=typeof Symbol<"u"&&m[Symbol.iterator]||m["@@iterator"];if(!b){if(Array.isArray(m)||(b=t(m))||_){b&&(m=b);var E=0,M=function(){};return{s:M,n:function(){return E>=m.length?{done:!0}:{done:!1,value:m[E++]}},e:function(D){throw D},f:M}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var O=!0,C=!1,U;return{s:function(){b=b.call(m)},n:function(){var D=b.next();return O=D.done,D},e:function(D){C=!0,U=D},f:function(){try{!O&&b.return!=null&&b.return()}finally{if(C)throw U}}}}function t(m,_){if(m){if(typeof m=="string")return r(m,_);var b=Object.prototype.toString.call(m).slice(8,-1);if(b==="Object"&&m.constructor&&(b=m.constructor.name),b==="Map"||b==="Set")return Array.from(m);if(b==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b))return r(m,_)}}function r(m,_){(_==null||_>m.length)&&(_=m.length);for(var b=0,E=new Array(_);b<_;b++)E[b]=m[b];return E}function n(m,_){if(!(m instanceof _))throw new TypeError("Cannot call a class as a function")}function s(m,_){for(var b=0;b<_.length;b++){var E=_[b];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(m,c(E.key),E)}}function l(m,_,b){return _&&s(m.prototype,_),b&&s(m,b),Object.defineProperty(m,"prototype",{writable:!1}),m}function c(m){var _=d(m,"string");return a(_)==="symbol"?_:String(_)}function d(m,_){if(a(m)!=="object"||m===null)return m;var b=m[Symbol.toPrimitive];if(b!==void 0){var E=b.call(m,_);if(a(E)!=="object")return E;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(m)}var h=(function(m){return m.Event="event",m.State="state_event",m.ToDevice="to_device",m.RoomAccount="room_account",m})({});xi.EventKind=h;var v=(function(m){return m.Send="send",m.Receive="receive",m})({});xi.EventDirection=v;var p=(function(){function m(_,b,E,M,O){n(this,m),this.direction=_,this.eventType=b,this.kind=E,this.keyStr=M,this.raw=O}return l(m,[{key:"matchesAsStateEvent",value:function(b,E,M){return this.kind!==h.State||this.direction!==b||this.eventType!==E?!1:this.keyStr===null||this.keyStr===M}},{key:"matchesAsToDeviceEvent",value:function(b,E){return!(this.kind!==h.ToDevice||this.direction!==b||this.eventType!==E)}},{key:"matchesAsRoomEvent",value:function(b,E){var M=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==h.Event||this.direction!==b||this.eventType!==E)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===M)return!0}else return!0;return!1}},{key:"matchesAsRoomAccountData",value:function(b,E){return!(this.kind!==h.RoomAccount||this.direction!==b||this.eventType!==E)}}],[{key:"forStateEvent",value:function(b,E,M){E=E.replace(/#/g,"\\#"),M=M!=null?"#".concat(M):"";var O="org.matrix.msc2762.".concat(b,".state_event:").concat(E).concat(M);return m.findEventCapabilities([O])[0]}},{key:"forToDeviceEvent",value:function(b,E){var M="org.matrix.msc3819.".concat(b,".to_device:").concat(E);return m.findEventCapabilities([M])[0]}},{key:"forRoomEvent",value:function(b,E){var M="org.matrix.msc2762.".concat(b,".event:").concat(E);return m.findEventCapabilities([M])[0]}},{key:"forRoomMessageEvent",value:function(b,E){E=E??"";var M="org.matrix.msc2762.".concat(b,".event:m.room.message#").concat(E);return m.findEventCapabilities([M])[0]}},{key:"forRoomAccountData",value:function(b,E){var M="com.beeper.capabilities.".concat(b,".room_account_data:").concat(E);return m.findEventCapabilities([M])[0]}},{key:"findEventCapabilities",value:function(b){var E=[],M=e(b),O;try{for(M.s();!(O=M.n()).done;){var C=O.value,U=null,I=void 0,D=null;if(C.startsWith("org.matrix.msc2762.send.event:")?(U=v.Send,D=h.Event,I=C.substring(30)):C.startsWith("org.matrix.msc2762.send.state_event:")?(U=v.Send,D=h.State,I=C.substring(36)):C.startsWith("org.matrix.msc3819.send.to_device:")?(U=v.Send,D=h.ToDevice,I=C.substring(34)):C.startsWith("org.matrix.msc2762.receive.event:")?(U=v.Receive,D=h.Event,I=C.substring(33)):C.startsWith("org.matrix.msc2762.receive.state_event:")?(U=v.Receive,D=h.State,I=C.substring(39)):C.startsWith("org.matrix.msc3819.receive.to_device:")?(U=v.Receive,D=h.ToDevice,I=C.substring(37)):C.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(U=v.Receive,D=h.RoomAccount,I=C.substring(50)),!(U===null||D===null||I===void 0)){var w=I.startsWith("m.room.message#")||D===h.State,N=null;if(I.includes("#")&&w){var A=I.split("#"),K=A.findIndex(function(z){return!z.endsWith("\\")});I=A.slice(0,K+1).map(function(z){return z.endsWith("\\")?z.substring(0,z.length-1):z}).join("#"),N=A.slice(K+1).join("#")}E.push(new m(U,I,D,N,C))}}}catch(z){M.e(z)}finally{M.f()}return E}}]),m})();return xi.WidgetEventCapability=p,xi}var Ru={},wT;function Lm(){if(wT)return Ru;wT=1,Object.defineProperty(Ru,"__esModule",{value:!0}),Ru.Symbols=void 0;var a=(function(e){return e.AnyRoom="*",e})({});return Ru.Symbols=a,Ru}var Cu={},RT;function xm(){if(RT)return Cu;RT=1,Object.defineProperty(Cu,"__esModule",{value:!0}),Cu.UpdateDelayedEventAction=void 0;var a=(function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e})({});return Cu.UpdateDelayedEventAction=a,Cu}var CT;function IN(){if(CT)return ps;CT=1;function a(G){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(q){return typeof q}:function(q){return q&&typeof Symbol=="function"&&q.constructor===Symbol&&q!==Symbol.prototype?"symbol":typeof q},a(G)}Object.defineProperty(ps,"__esModule",{value:!0}),ps.WidgetApiResponseError=ps.WidgetApi=void 0;var e=jf(),t=Am(),r=Dm(),n=Mm(),s=Nm(),l=Um(),c=xR(),d=BR(),h=Pm(),v=Lm(),p=xm();function m(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */m=function(){return G};var G={},q=Object.prototype,x=q.hasOwnProperty,j=Object.defineProperty||function(ne,ce,ge){ne[ce]=ge.value},P=typeof Symbol=="function"?Symbol:{},J=P.iterator||"@@iterator",Y=P.asyncIterator||"@@asyncIterator",X=P.toStringTag||"@@toStringTag";function re(ne,ce,ge){return Object.defineProperty(ne,ce,{value:ge,enumerable:!0,configurable:!0,writable:!0}),ne[ce]}try{re({},"")}catch{re=function(ge,Re,xe){return ge[Re]=xe}}function fe(ne,ce,ge,Re){var xe=ce&&ce.prototype instanceof Le?ce:Le,Ke=Object.create(xe.prototype),rt=new Xi(Re||[]);return j(Ke,"_invoke",{value:Kt(ne,ge,rt)}),Ke}function Ee(ne,ce,ge){try{return{type:"normal",arg:ne.call(ce,ge)}}catch(Re){return{type:"throw",arg:Re}}}G.wrap=fe;var je={};function Le(){}function Ne(){}function it(){}var dt={};re(dt,J,function(){return this});var Nt=Object.getPrototypeOf,Ae=Nt&&Nt(Nt(Me([])));Ae&&Ae!==q&&x.call(Ae,J)&&(dt=Ae);var Ge=it.prototype=Le.prototype=Object.create(dt);function Pn(ne){["next","throw","return"].forEach(function(ce){re(ne,ce,function(ge){return this._invoke(ce,ge)})})}function _n(ne,ce){function ge(xe,Ke,rt,Tt){var wt=Ee(ne[xe],ne,Ke);if(wt.type!=="throw"){var Vt=wt.arg,rn=Vt.value;return rn&&a(rn)=="object"&&x.call(rn,"__await")?ce.resolve(rn.__await).then(function(nn){ge("next",nn,rt,Tt)},function(nn){ge("throw",nn,rt,Tt)}):ce.resolve(rn).then(function(nn){Vt.value=nn,rt(Vt)},function(nn){return ge("throw",nn,rt,Tt)})}Tt(wt.arg)}var Re;j(this,"_invoke",{value:function(Ke,rt){function Tt(){return new ce(function(wt,Vt){ge(Ke,rt,wt,Vt)})}return Re=Re?Re.then(Tt,Tt):Tt()}})}function Kt(ne,ce,ge){var Re="suspendedStart";return function(xe,Ke){if(Re==="executing")throw new Error("Generator is already running");if(Re==="completed"){if(xe==="throw")throw Ke;return Te()}for(ge.method=xe,ge.arg=Ke;;){var rt=ge.delegate;if(rt){var Tt=Vr(rt,ge);if(Tt){if(Tt===je)continue;return Tt}}if(ge.method==="next")ge.sent=ge._sent=ge.arg;else if(ge.method==="throw"){if(Re==="suspendedStart")throw Re="completed",ge.arg;ge.dispatchException(ge.arg)}else ge.method==="return"&&ge.abrupt("return",ge.arg);Re="executing";var wt=Ee(ne,ce,ge);if(wt.type==="normal"){if(Re=ge.done?"completed":"suspendedYield",wt.arg===je)continue;return{value:wt.arg,done:ge.done}}wt.type==="throw"&&(Re="completed",ge.method="throw",ge.arg=wt.arg)}}}function Vr(ne,ce){var ge=ce.method,Re=ne.iterator[ge];if(Re===void 0)return ce.delegate=null,ge==="throw"&&ne.iterator.return&&(ce.method="return",ce.arg=void 0,Vr(ne,ce),ce.method==="throw")||ge!=="return"&&(ce.method="throw",ce.arg=new TypeError("The iterator does not provide a '"+ge+"' method")),je;var xe=Ee(Re,ne.iterator,ce.arg);if(xe.type==="throw")return ce.method="throw",ce.arg=xe.arg,ce.delegate=null,je;var Ke=xe.arg;return Ke?Ke.done?(ce[ne.resultName]=Ke.value,ce.next=ne.nextLoc,ce.method!=="return"&&(ce.method="next",ce.arg=void 0),ce.delegate=null,je):Ke:(ce.method="throw",ce.arg=new TypeError("iterator result is not an object"),ce.delegate=null,je)}function gi(ne){var ce={tryLoc:ne[0]};1 in ne&&(ce.catchLoc=ne[1]),2 in ne&&(ce.finallyLoc=ne[2],ce.afterLoc=ne[3]),this.tryEntries.push(ce)}function $n(ne){var ce=ne.completion||{};ce.type="normal",delete ce.arg,ne.completion=ce}function Xi(ne){this.tryEntries=[{tryLoc:"root"}],ne.forEach(gi,this),this.reset(!0)}function Me(ne){if(ne){var ce=ne[J];if(ce)return ce.call(ne);if(typeof ne.next=="function")return ne;if(!isNaN(ne.length)){var ge=-1,Re=function xe(){for(;++ge<ne.length;)if(x.call(ne,ge))return xe.value=ne[ge],xe.done=!1,xe;return xe.value=void 0,xe.done=!0,xe};return Re.next=Re}}return{next:Te}}function Te(){return{value:void 0,done:!0}}return Ne.prototype=it,j(Ge,"constructor",{value:it,configurable:!0}),j(it,"constructor",{value:Ne,configurable:!0}),Ne.displayName=re(it,X,"GeneratorFunction"),G.isGeneratorFunction=function(ne){var ce=typeof ne=="function"&&ne.constructor;return!!ce&&(ce===Ne||(ce.displayName||ce.name)==="GeneratorFunction")},G.mark=function(ne){return Object.setPrototypeOf?Object.setPrototypeOf(ne,it):(ne.__proto__=it,re(ne,X,"GeneratorFunction")),ne.prototype=Object.create(Ge),ne},G.awrap=function(ne){return{__await:ne}},Pn(_n.prototype),re(_n.prototype,Y,function(){return this}),G.AsyncIterator=_n,G.async=function(ne,ce,ge,Re,xe){xe===void 0&&(xe=Promise);var Ke=new _n(fe(ne,ce,ge,Re),xe);return G.isGeneratorFunction(ce)?Ke:Ke.next().then(function(rt){return rt.done?rt.value:Ke.next()})},Pn(Ge),re(Ge,X,"Generator"),re(Ge,J,function(){return this}),re(Ge,"toString",function(){return"[object Generator]"}),G.keys=function(ne){var ce=Object(ne),ge=[];for(var Re in ce)ge.push(Re);return ge.reverse(),function xe(){for(;ge.length;){var Ke=ge.pop();if(Ke in ce)return xe.value=Ke,xe.done=!1,xe}return xe.done=!0,xe}},G.values=Me,Xi.prototype={constructor:Xi,reset:function(ce){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach($n),!ce)for(var ge in this)ge.charAt(0)==="t"&&x.call(this,ge)&&!isNaN(+ge.slice(1))&&(this[ge]=void 0)},stop:function(){this.done=!0;var ce=this.tryEntries[0].completion;if(ce.type==="throw")throw ce.arg;return this.rval},dispatchException:function(ce){if(this.done)throw ce;var ge=this;function Re(Vt,rn){return rt.type="throw",rt.arg=ce,ge.next=Vt,rn&&(ge.method="next",ge.arg=void 0),!!rn}for(var xe=this.tryEntries.length-1;xe>=0;--xe){var Ke=this.tryEntries[xe],rt=Ke.completion;if(Ke.tryLoc==="root")return Re("end");if(Ke.tryLoc<=this.prev){var Tt=x.call(Ke,"catchLoc"),wt=x.call(Ke,"finallyLoc");if(Tt&&wt){if(this.prev<Ke.catchLoc)return Re(Ke.catchLoc,!0);if(this.prev<Ke.finallyLoc)return Re(Ke.finallyLoc)}else if(Tt){if(this.prev<Ke.catchLoc)return Re(Ke.catchLoc,!0)}else{if(!wt)throw new Error("try statement without catch or finally");if(this.prev<Ke.finallyLoc)return Re(Ke.finallyLoc)}}}},abrupt:function(ce,ge){for(var Re=this.tryEntries.length-1;Re>=0;--Re){var xe=this.tryEntries[Re];if(xe.tryLoc<=this.prev&&x.call(xe,"finallyLoc")&&this.prev<xe.finallyLoc){var Ke=xe;break}}Ke&&(ce==="break"||ce==="continue")&&Ke.tryLoc<=ge&&ge<=Ke.finallyLoc&&(Ke=null);var rt=Ke?Ke.completion:{};return rt.type=ce,rt.arg=ge,Ke?(this.method="next",this.next=Ke.finallyLoc,je):this.complete(rt)},complete:function(ce,ge){if(ce.type==="throw")throw ce.arg;return ce.type==="break"||ce.type==="continue"?this.next=ce.arg:ce.type==="return"?(this.rval=this.arg=ce.arg,this.method="return",this.next="end"):ce.type==="normal"&&ge&&(this.next=ge),je},finish:function(ce){for(var ge=this.tryEntries.length-1;ge>=0;--ge){var Re=this.tryEntries[ge];if(Re.finallyLoc===ce)return this.complete(Re.completion,Re.afterLoc),$n(Re),je}},catch:function(ce){for(var ge=this.tryEntries.length-1;ge>=0;--ge){var Re=this.tryEntries[ge];if(Re.tryLoc===ce){var xe=Re.completion;if(xe.type==="throw"){var Ke=xe.arg;$n(Re)}return Ke}}throw new Error("illegal catch attempt")},delegateYield:function(ce,ge,Re){return this.delegate={iterator:Me(ce),resultName:ge,nextLoc:Re},this.method==="next"&&(this.arg=void 0),je}},G}function _(G,q,x,j,P,J,Y){try{var X=G[J](Y),re=X.value}catch(fe){x(fe);return}X.done?q(re):Promise.resolve(re).then(j,P)}function b(G){return function(){var q=this,x=arguments;return new Promise(function(j,P){var J=G.apply(q,x);function Y(re){_(J,j,P,Y,X,"next",re)}function X(re){_(J,j,P,Y,X,"throw",re)}Y(void 0)})}}function E(G,q){var x=Object.keys(G);if(Object.getOwnPropertySymbols){var j=Object.getOwnPropertySymbols(G);q&&(j=j.filter(function(P){return Object.getOwnPropertyDescriptor(G,P).enumerable})),x.push.apply(x,j)}return x}function M(G){for(var q=1;q<arguments.length;q++){var x=arguments[q]!=null?arguments[q]:{};q%2?E(Object(x),!0).forEach(function(j){I(G,j,x[j])}):Object.getOwnPropertyDescriptors?Object.defineProperties(G,Object.getOwnPropertyDescriptors(x)):E(Object(x)).forEach(function(j){Object.defineProperty(G,j,Object.getOwnPropertyDescriptor(x,j))})}return G}function O(G,q){var x=typeof Symbol<"u"&&G[Symbol.iterator]||G["@@iterator"];if(!x){if(Array.isArray(G)||(x=C(G))||q){x&&(G=x);var j=0,P=function(){};return{s:P,n:function(){return j>=G.length?{done:!0}:{done:!1,value:G[j++]}},e:function(fe){throw fe},f:P}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var J=!0,Y=!1,X;return{s:function(){x=x.call(G)},n:function(){var fe=x.next();return J=fe.done,fe},e:function(fe){Y=!0,X=fe},f:function(){try{!J&&x.return!=null&&x.return()}finally{if(Y)throw X}}}}function C(G,q){if(G){if(typeof G=="string")return U(G,q);var x=Object.prototype.toString.call(G).slice(8,-1);if(x==="Object"&&G.constructor&&(x=G.constructor.name),x==="Map"||x==="Set")return Array.from(G);if(x==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(x))return U(G,q)}}function U(G,q){(q==null||q>G.length)&&(q=G.length);for(var x=0,j=new Array(q);x<q;x++)j[x]=G[x];return j}function I(G,q,x){return q=N(q),q in G?Object.defineProperty(G,q,{value:x,enumerable:!0,configurable:!0,writable:!0}):G[q]=x,G}function D(G,q){for(var x=0;x<q.length;x++){var j=q[x];j.enumerable=j.enumerable||!1,j.configurable=!0,"value"in j&&(j.writable=!0),Object.defineProperty(G,N(j.key),j)}}function w(G,q,x){return q&&D(G.prototype,q),Object.defineProperty(G,"prototype",{writable:!1}),G}function N(G){var q=A(G,"string");return a(q)==="symbol"?q:String(q)}function A(G,q){if(a(G)!=="object"||G===null)return G;var x=G[Symbol.toPrimitive];if(x!==void 0){var j=x.call(G,q);if(a(j)!=="object")return j;throw new TypeError("@@toPrimitive must return a primitive value.")}return(q==="string"?String:Number)(G)}function K(G,q){if(!(G instanceof q))throw new TypeError("Cannot call a class as a function")}function z(G,q){if(typeof q!="function"&&q!==null)throw new TypeError("Super expression must either be null or a function");G.prototype=Object.create(q&&q.prototype,{constructor:{value:G,writable:!0,configurable:!0}}),Object.defineProperty(G,"prototype",{writable:!1}),q&&he(G,q)}function de(G){var q=B();return function(){var j=be(G),P;if(q){var J=be(this).constructor;P=Reflect.construct(j,arguments,J)}else P=j.apply(this,arguments);return _e(this,P)}}function _e(G,q){if(q&&(a(q)==="object"||typeof q=="function"))return q;if(q!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return le(G)}function le(G){if(G===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return G}function Ce(G){var q=typeof Map=="function"?new Map:void 0;return Ce=function(j){if(j===null||!te(j))return j;if(typeof j!="function")throw new TypeError("Super expression must either be null or a function");if(typeof q<"u"){if(q.has(j))return q.get(j);q.set(j,P)}function P(){return V(j,arguments,be(this).constructor)}return P.prototype=Object.create(j.prototype,{constructor:{value:P,enumerable:!1,writable:!0,configurable:!0}}),he(P,j)},Ce(G)}function V(G,q,x){return B()?V=Reflect.construct.bind():V=function(P,J,Y){var X=[null];X.push.apply(X,J);var re=Function.bind.apply(P,X),fe=new re;return Y&&he(fe,Y.prototype),fe},V.apply(null,arguments)}function B(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function te(G){return Function.toString.call(G).indexOf("[native code]")!==-1}function he(G,q){return he=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(j,P){return j.__proto__=P,j},he(G,q)}function be(G){return be=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(x){return x.__proto__||Object.getPrototypeOf(x)},be(G)}function De(G){return new we(G,0)}function W(G){return function(){return new ue(G.apply(this,arguments))}}function ue(G){var q,x;function j(J,Y){try{var X=G[J](Y),re=X.value,fe=re instanceof we;Promise.resolve(fe?re.v:re).then(function(Ee){if(fe){var je=J==="return"?"return":"next";if(!re.k||Ee.done)return j(je,Ee);Ee=G[je](Ee).value}P(X.done?"return":"normal",Ee)},function(Ee){j("throw",Ee)})}catch(Ee){P("throw",Ee)}}function P(J,Y){switch(J){case"return":q.resolve({value:Y,done:!0});break;case"throw":q.reject(Y);break;default:q.resolve({value:Y,done:!1})}(q=q.next)?j(q.key,q.arg):x=null}this._invoke=function(J,Y){return new Promise(function(X,re){var fe={key:J,arg:Y,resolve:X,reject:re,next:null};x?x=x.next=fe:(q=x=fe,j(J,Y))})},typeof G.return!="function"&&(this.return=void 0)}ue.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},ue.prototype.next=function(G){return this._invoke("next",G)},ue.prototype.throw=function(G){return this._invoke("throw",G)},ue.prototype.return=function(G){return this._invoke("return",G)};function we(G,q){this.v=G,this.k=q}var Z=(function(G){z(x,G);var q=de(x);function x(j,P){var J;return K(this,x),J=q.call(this,j),J.data=P,J}return w(x)})(Ce(Error));ps.WidgetApiResponseError=Z,Z.prototype.name=Z.name;var pe=(function(G){z(x,G);var q=de(x);function x(){var j,P=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,J=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(K(this,x),j=q.call(this),I(le(j),"transport",void 0),I(le(j),"capabilitiesFinished",!1),I(le(j),"supportsMSC2974Renegotiate",!1),I(le(j),"requestedCapabilities",[]),I(le(j),"approvedCapabilities",void 0),I(le(j),"cachedClientVersions",void 0),I(le(j),"turnServerWatchers",0),!globalThis.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return j.transport=new n.PostmessageTransport(t.WidgetApiDirection.FromWidget,P,globalThis.parent,globalThis),j.transport.targetOrigin=J,j.transport.on("message",j.handleMessage.bind(le(j))),j}return w(x,[{key:"hasCapability",value:function(P){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(P):this.requestedCapabilities.includes(P)}},{key:"requestCapability",value:function(P){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(P)}},{key:"requestCapabilities",value:function(P){var J=O(P),Y;try{for(J.s();!(Y=J.n()).done;){var X=Y.value;this.requestCapability(X)}}catch(re){J.e(re)}finally{J.f()}}},{key:"requestCapabilityForRoomTimeline",value:function(P){this.requestCapability("org.matrix.msc2762.timeline:".concat(P))}},{key:"requestCapabilityToSendState",value:function(P,J){this.requestCapability(h.WidgetEventCapability.forStateEvent(h.EventDirection.Send,P,J).raw)}},{key:"requestCapabilityToReceiveState",value:function(P,J){this.requestCapability(h.WidgetEventCapability.forStateEvent(h.EventDirection.Receive,P,J).raw)}},{key:"requestCapabilityToSendToDevice",value:function(P){this.requestCapability(h.WidgetEventCapability.forToDeviceEvent(h.EventDirection.Send,P).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(P){this.requestCapability(h.WidgetEventCapability.forToDeviceEvent(h.EventDirection.Receive,P).raw)}},{key:"requestCapabilityToSendEvent",value:function(P){this.requestCapability(h.WidgetEventCapability.forRoomEvent(h.EventDirection.Send,P).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(P){this.requestCapability(h.WidgetEventCapability.forRoomEvent(h.EventDirection.Receive,P).raw)}},{key:"requestCapabilityToSendMessage",value:function(P){this.requestCapability(h.WidgetEventCapability.forRoomMessageEvent(h.EventDirection.Send,P).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(P){this.requestCapability(h.WidgetEventCapability.forRoomMessageEvent(h.EventDirection.Receive,P).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(P){this.requestCapability(h.WidgetEventCapability.forRoomAccountData(h.EventDirection.Receive,P).raw)}},{key:"requestOpenIDConnectToken",value:function(){var P=this;return new Promise(function(J,Y){P.transport.sendComplete(s.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(X){var re=X.response;if(re.state===l.OpenIDRequestState.Allowed)J(re);else if(re.state===l.OpenIDRequestState.Blocked)Y(new Error("User declined to verify their identity"));else if(re.state===l.OpenIDRequestState.PendingUserConfirmation){var fe=function Ee(je){je.preventDefault();var Le=je.detail;Le.data.original_request_id===X.requestId&&(Le.data.state===l.OpenIDRequestState.Allowed?(J(Le.data),P.transport.reply(Le,{})):Le.data.state===l.OpenIDRequestState.Blocked?(Y(new Error("User declined to verify their identity")),P.transport.reply(Le,{})):(Y(new Error("Invalid state on reply: "+re.state)),P.transport.reply(Le,{error:{message:"Invalid state"}})),P.off("action:".concat(s.WidgetApiToWidgetAction.OpenIDCredentials),Ee))};P.on("action:".concat(s.WidgetApiToWidgetAction.OpenIDCredentials),fe)}else Y(new Error("Invalid state: "+re.state))}).catch(Y)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(s.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(s.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(P){return this.transport.send(s.WidgetApiFromWidgetAction.SendSticker,P).then()}},{key:"setAlwaysOnScreen",value:function(P){return this.transport.send(s.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:P}).then(function(J){return J.success})}},{key:"openModalWidget",value:function(P,J){var Y=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],X=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},re=arguments.length>4&&arguments[4]!==void 0?arguments[4]:c.MatrixWidgetType.Custom;return this.transport.send(s.WidgetApiFromWidgetAction.OpenModalWidget,{type:re,url:P,name:J,buttons:Y,data:X}).then()}},{key:"closeModalWidget",value:function(){var P=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(s.WidgetApiFromWidgetAction.CloseModalWidget,P).then()}},{key:"sendRoomEvent",value:function(P,J,Y,X,re,fe){return this.sendEvent(P,void 0,J,Y,X,re,fe)}},{key:"sendStateEvent",value:function(P,J,Y,X,re,fe){return this.sendEvent(P,J,Y,X,re,fe)}},{key:"sendEvent",value:function(P,J,Y,X,re,fe,Ee){return this.transport.send(s.WidgetApiFromWidgetAction.SendEvent,M(M(M(M(M({type:P,content:Y},J!==void 0&&{state_key:J}),X!==void 0&&{room_id:X}),re!==void 0&&{delay:re}),fe!==void 0&&{parent_delay_id:fe}),Ee!==void 0&&{sticky_duration_ms:Ee}))}},{key:"cancelScheduledDelayedEvent",value:function(P){return this.transport.send(s.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:P,action:p.UpdateDelayedEventAction.Cancel})}},{key:"restartScheduledDelayedEvent",value:function(P){return this.transport.send(s.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:P,action:p.UpdateDelayedEventAction.Restart})}},{key:"sendScheduledDelayedEvent",value:function(P){return this.transport.send(s.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:P,action:p.UpdateDelayedEventAction.Send})}},{key:"sendToDevice",value:function(P,J,Y){return this.transport.send(s.WidgetApiFromWidgetAction.SendToDevice,{type:P,encrypted:J,messages:Y})}},{key:"readRoomAccountData",value:function(P,J){var Y={type:P};return J&&(J.includes(v.Symbols.AnyRoom)?Y.room_ids=v.Symbols.AnyRoom:Y.room_ids=J),this.transport.send(s.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,Y).then(function(X){return X.events})}},{key:"readRoomEvents",value:function(P,J,Y,X,re){var fe={type:P,msgtype:Y};return J!==void 0&&(fe.limit=J),X&&(X.includes(v.Symbols.AnyRoom)?fe.room_ids=v.Symbols.AnyRoom:fe.room_ids=X),re&&(fe.since=re),this.transport.send(s.WidgetApiFromWidgetAction.MSC2876ReadEvents,fe).then(function(Ee){return Ee.events})}},{key:"readEventRelations",value:(function(){var j=b(m().mark(function J(Y,X,re,fe,Ee,je,Le,Ne){var it,dt;return m().wrap(function(Ae){for(;;)switch(Ae.prev=Ae.next){case 0:return Ae.next=2,this.getClientVersions();case 2:if(it=Ae.sent,it.includes(r.UnstableApiVersion.MSC3869)){Ae.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return dt={event_id:Y,rel_type:re,event_type:fe,room_id:X,to:Le,from:je,limit:Ee,direction:Ne},Ae.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC3869ReadRelations,dt));case 7:case"end":return Ae.stop()}},J,this)}));function P(J,Y,X,re,fe,Ee,je,Le){return j.apply(this,arguments)}return P})()},{key:"readStateEvents",value:function(P,J,Y,X){var re={type:P,state_key:Y===void 0?!0:Y};return J!==void 0&&(re.limit=J),X&&(X.includes(v.Symbols.AnyRoom)?re.room_ids=v.Symbols.AnyRoom:re.room_ids=X),this.transport.send(s.WidgetApiFromWidgetAction.MSC2876ReadEvents,re).then(function(fe){return fe.events})}},{key:"setModalButtonEnabled",value:function(P,J){if(P===d.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(s.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:P,enabled:J}).then()}},{key:"navigateTo",value:function(P){if(!P||!P.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(s.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:P}).then()}},{key:"getTurnServers",value:function(){var P=this;return W(m().mark(function J(){var Y,X;return m().wrap(function(fe){for(;;)switch(fe.prev=fe.next){case 0:if(X=(function(){var Ee=b(m().mark(function je(Le){return m().wrap(function(it){for(;;)switch(it.prev=it.next){case 0:Le.preventDefault(),Y(Le.detail.data),P.transport.reply(Le.detail,{});case 3:case"end":return it.stop()}},je)}));return function(Le){return Ee.apply(this,arguments)}})(),P.on("action:".concat(s.WidgetApiToWidgetAction.UpdateTurnServers),X),P.turnServerWatchers!==0){fe.next=12;break}return fe.prev=3,fe.next=6,De(P.transport.send(s.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:fe.next=12;break;case 8:throw fe.prev=8,fe.t0=fe.catch(3),P.off("action:".concat(s.WidgetApiToWidgetAction.UpdateTurnServers),X),fe.t0;case 12:P.turnServerWatchers++,fe.prev=13;case 14:return fe.next=17,De(new Promise(function(Ee){return Y=Ee}));case 17:return fe.next=19,fe.sent;case 19:fe.next=14;break;case 21:if(fe.prev=21,P.off("action:".concat(s.WidgetApiToWidgetAction.UpdateTurnServers),X),P.turnServerWatchers--,P.turnServerWatchers!==0){fe.next=27;break}return fe.next=27,De(P.transport.send(s.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return fe.finish(21);case 28:case"end":return fe.stop()}},J,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:(function(){var j=b(m().mark(function J(Y,X){var re,fe;return m().wrap(function(je){for(;;)switch(je.prev=je.next){case 0:return je.next=2,this.getClientVersions();case 2:if(re=je.sent,re.includes(r.UnstableApiVersion.MSC3973)){je.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return fe={search_term:Y,limit:X},je.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,fe));case 7:case"end":return je.stop()}},J,this)}));function P(J,Y){return j.apply(this,arguments)}return P})()},{key:"getMediaConfig",value:(function(){var j=b(m().mark(function J(){var Y,X;return m().wrap(function(fe){for(;;)switch(fe.prev=fe.next){case 0:return fe.next=2,this.getClientVersions();case 2:if(Y=fe.sent,Y.includes(r.UnstableApiVersion.MSC4039)){fe.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return X={},fe.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,X));case 7:case"end":return fe.stop()}},J,this)}));function P(){return j.apply(this,arguments)}return P})()},{key:"uploadFile",value:(function(){var j=b(m().mark(function J(Y){var X,re;return m().wrap(function(Ee){for(;;)switch(Ee.prev=Ee.next){case 0:return Ee.next=2,this.getClientVersions();case 2:if(X=Ee.sent,X.includes(r.UnstableApiVersion.MSC4039)){Ee.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return re={file:Y},Ee.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC4039UploadFileAction,re));case 7:case"end":return Ee.stop()}},J,this)}));function P(J){return j.apply(this,arguments)}return P})()},{key:"downloadFile",value:(function(){var j=b(m().mark(function J(Y){var X,re;return m().wrap(function(Ee){for(;;)switch(Ee.prev=Ee.next){case 0:return Ee.next=2,this.getClientVersions();case 2:if(X=Ee.sent,X.includes(r.UnstableApiVersion.MSC4039)){Ee.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return re={content_uri:Y},Ee.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,re));case 7:case"end":return Ee.stop()}},J,this)}));function P(J){return j.apply(this,arguments)}return P})()},{key:"start",value:function(){var P=this;this.transport.start(),this.getClientVersions().then(function(J){J.includes(r.UnstableApiVersion.MSC2974)&&(P.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(P){var J=new CustomEvent("action:".concat(P.detail.action),{detail:P.detail,cancelable:!0});if(this.emit("action:".concat(P.detail.action),J),!J.defaultPrevented)switch(P.detail.action){case s.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(P.detail);case s.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(P.detail);case s.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(P.detail,{});case s.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(P.detail,{});default:return this.transport.reply(P.detail,{error:{message:"Unknown or unsupported to-widget action: "+P.detail.action}})}}},{key:"replyVersions",value:function(P){this.transport.reply(P,{supported_versions:r.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var P=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(s.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(J){return P.cachedClientVersions=J.supported_versions,J.supported_versions}).catch(function(J){return console.warn("non-fatal error getting supported client versions: ",J),[]})}},{key:"handleCapabilities",value:function(P){var J=this;return this.capabilitiesFinished?this.transport.reply(P,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(Y){return Y.includes(r.UnstableApiVersion.MSC2871)?J.once("action:".concat(s.WidgetApiToWidgetAction.NotifyCapabilities),function(X){J.approvedCapabilities=X.detail.data.approved,J.emit("ready")}):J.emit("ready"),J.capabilitiesFinished=!0,J.transport.reply(P,{capabilities:J.requestedCapabilities})})}}]),x})(e.EventEmitter);return ps.WidgetApi=pe,ps}var Iu={},Mn={},IT;function KR(){if(IT)return Mn;IT=1,Object.defineProperty(Mn,"__esModule",{value:!0}),Mn.VideoConferenceCapabilities=Mn.StickerpickerCapabilities=Mn.MatrixCapabilities=void 0,Mn.getTimelineRoomIDFromCapability=s,Mn.isTimelineCapability=r,Mn.isTimelineCapabilityFor=n;var a=(function(l){return l.Screenshots="m.capability.screenshot",l.StickerSending="m.sticker",l.AlwaysOnScreen="m.always_on_screen",l.RequiresClient="io.element.requires_client",l.MSC2931Navigate="org.matrix.msc2931.navigate",l.MSC3846TurnServers="town.robin.msc3846.turn_servers",l.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",l.MSC4039UploadFile="org.matrix.msc4039.upload_file",l.MSC4039DownloadFile="org.matrix.msc4039.download_file",l.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",l.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",l.MSC4407SendStickyEvent="org.matrix.msc4407.send.sticky_event",l.MSC4407ReceiveStickyEvent="org.matrix.msc4407.receive.sticky_event",l})({});Mn.MatrixCapabilities=a;var e=[a.StickerSending];Mn.StickerpickerCapabilities=e;var t=[a.AlwaysOnScreen];Mn.VideoConferenceCapabilities=t;function r(l){return l==null?void 0:l.startsWith("org.matrix.msc2762.timeline:")}function n(l,c){return l==="org.matrix.msc2762.timeline:".concat(c)}function s(l){return l.substring(l.indexOf(":")+1)}return Mn}var Ou={},OT;function jR(){if(OT)return Ou;OT=1,Object.defineProperty(Ou,"__esModule",{value:!0}),Ou.SimpleObservable=void 0;function a(p){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},a(p)}function e(p,m){var _=typeof Symbol<"u"&&p[Symbol.iterator]||p["@@iterator"];if(!_){if(Array.isArray(p)||(_=t(p))||m){_&&(p=_);var b=0,E=function(){};return{s:E,n:function(){return b>=p.length?{done:!0}:{done:!1,value:p[b++]}},e:function(I){throw I},f:E}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var M=!0,O=!1,C;return{s:function(){_=_.call(p)},n:function(){var I=_.next();return M=I.done,I},e:function(I){O=!0,C=I},f:function(){try{!M&&_.return!=null&&_.return()}finally{if(O)throw C}}}}function t(p,m){if(p){if(typeof p=="string")return r(p,m);var _=Object.prototype.toString.call(p).slice(8,-1);if(_==="Object"&&p.constructor&&(_=p.constructor.name),_==="Map"||_==="Set")return Array.from(p);if(_==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(_))return r(p,m)}}function r(p,m){(m==null||m>p.length)&&(m=p.length);for(var _=0,b=new Array(m);_<m;_++)b[_]=p[_];return b}function n(p,m){if(!(p instanceof m))throw new TypeError("Cannot call a class as a function")}function s(p,m){for(var _=0;_<m.length;_++){var b=m[_];b.enumerable=b.enumerable||!1,b.configurable=!0,"value"in b&&(b.writable=!0),Object.defineProperty(p,d(b.key),b)}}function l(p,m,_){return m&&s(p.prototype,m),Object.defineProperty(p,"prototype",{writable:!1}),p}function c(p,m,_){return m=d(m),m in p?Object.defineProperty(p,m,{value:_,enumerable:!0,configurable:!0,writable:!0}):p[m]=_,p}function d(p){var m=h(p,"string");return a(m)==="symbol"?m:String(m)}function h(p,m){if(a(p)!=="object"||p===null)return p;var _=p[Symbol.toPrimitive];if(_!==void 0){var b=_.call(p,m);if(a(b)!=="object")return b;throw new TypeError("@@toPrimitive must return a primitive value.")}return(m==="string"?String:Number)(p)}var v=(function(){function p(m){n(this,p),c(this,"listeners",[]),m&&this.listeners.push(m)}return l(p,[{key:"onUpdate",value:function(_){this.listeners.push(_)}},{key:"update",value:function(_){var b=e(this.listeners),E;try{for(b.s();!(E=b.n()).done;){var M=E.value;M(_)}}catch(O){b.e(O)}finally{b.f()}}},{key:"close",value:function(){this.listeners=[]}}]),p})();return Ou.SimpleObservable=v,Ou}var kT;function ON(){if(kT)return Iu;kT=1,Object.defineProperty(Iu,"__esModule",{value:!0}),Iu.ClientWidgetApi=void 0;var a=jf(),e=Mm(),t=Am(),r=Nm(),n=KR(),s=Dm(),l=Pm(),c=Um(),d=jR(),h=Lm(),v=xm();function p(Z){"@babel/helpers - typeof";return p=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(pe){return typeof pe}:function(pe){return pe&&typeof Symbol=="function"&&pe.constructor===Symbol&&pe!==Symbol.prototype?"symbol":typeof pe},p(Z)}function m(Z,pe){var G=Object.keys(Z);if(Object.getOwnPropertySymbols){var q=Object.getOwnPropertySymbols(Z);pe&&(q=q.filter(function(x){return Object.getOwnPropertyDescriptor(Z,x).enumerable})),G.push.apply(G,q)}return G}function _(Z){for(var pe=1;pe<arguments.length;pe++){var G=arguments[pe]!=null?arguments[pe]:{};pe%2?m(Object(G),!0).forEach(function(q){he(Z,q,G[q])}):Object.getOwnPropertyDescriptors?Object.defineProperties(Z,Object.getOwnPropertyDescriptors(G)):m(Object(G)).forEach(function(q){Object.defineProperty(Z,q,Object.getOwnPropertyDescriptor(G,q))})}return Z}function b(Z,pe){var G=typeof Symbol<"u"&&Z[Symbol.iterator]||Z["@@iterator"];if(!G){if(Array.isArray(Z)||(G=O(Z))||pe){G&&(Z=G);var q=0,x=function(){};return{s:x,n:function(){return q>=Z.length?{done:!0}:{done:!1,value:Z[q++]}},e:function(X){throw X},f:x}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var j=!0,P=!1,J;return{s:function(){G=G.call(Z)},n:function(){var X=G.next();return j=X.done,X},e:function(X){P=!0,J=X},f:function(){try{!j&&G.return!=null&&G.return()}finally{if(P)throw J}}}}function E(Z){return U(Z)||C(Z)||O(Z)||M()}function M(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function O(Z,pe){if(Z){if(typeof Z=="string")return I(Z,pe);var G=Object.prototype.toString.call(Z).slice(8,-1);if(G==="Object"&&Z.constructor&&(G=Z.constructor.name),G==="Map"||G==="Set")return Array.from(Z);if(G==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(G))return I(Z,pe)}}function C(Z){if(typeof Symbol<"u"&&Z[Symbol.iterator]!=null||Z["@@iterator"]!=null)return Array.from(Z)}function U(Z){if(Array.isArray(Z))return I(Z)}function I(Z,pe){(pe==null||pe>Z.length)&&(pe=Z.length);for(var G=0,q=new Array(pe);G<pe;G++)q[G]=Z[G];return q}function D(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */D=function(){return Z};var Z={},pe=Object.prototype,G=pe.hasOwnProperty,q=Object.defineProperty||function(Me,Te,ne){Me[Te]=ne.value},x=typeof Symbol=="function"?Symbol:{},j=x.iterator||"@@iterator",P=x.asyncIterator||"@@asyncIterator",J=x.toStringTag||"@@toStringTag";function Y(Me,Te,ne){return Object.defineProperty(Me,Te,{value:ne,enumerable:!0,configurable:!0,writable:!0}),Me[Te]}try{Y({},"")}catch{Y=function(ne,ce,ge){return ne[ce]=ge}}function X(Me,Te,ne,ce){var ge=Te&&Te.prototype instanceof Ee?Te:Ee,Re=Object.create(ge.prototype),xe=new gi(ce||[]);return q(Re,"_invoke",{value:Pn(Me,ne,xe)}),Re}function re(Me,Te,ne){try{return{type:"normal",arg:Me.call(Te,ne)}}catch(ce){return{type:"throw",arg:ce}}}Z.wrap=X;var fe={};function Ee(){}function je(){}function Le(){}var Ne={};Y(Ne,j,function(){return this});var it=Object.getPrototypeOf,dt=it&&it(it($n([])));dt&&dt!==pe&&G.call(dt,j)&&(Ne=dt);var Nt=Le.prototype=Ee.prototype=Object.create(Ne);function Ae(Me){["next","throw","return"].forEach(function(Te){Y(Me,Te,function(ne){return this._invoke(Te,ne)})})}function Ge(Me,Te){function ne(ge,Re,xe,Ke){var rt=re(Me[ge],Me,Re);if(rt.type!=="throw"){var Tt=rt.arg,wt=Tt.value;return wt&&p(wt)=="object"&&G.call(wt,"__await")?Te.resolve(wt.__await).then(function(Vt){ne("next",Vt,xe,Ke)},function(Vt){ne("throw",Vt,xe,Ke)}):Te.resolve(wt).then(function(Vt){Tt.value=Vt,xe(Tt)},function(Vt){return ne("throw",Vt,xe,Ke)})}Ke(rt.arg)}var ce;q(this,"_invoke",{value:function(Re,xe){function Ke(){return new Te(function(rt,Tt){ne(Re,xe,rt,Tt)})}return ce=ce?ce.then(Ke,Ke):Ke()}})}function Pn(Me,Te,ne){var ce="suspendedStart";return function(ge,Re){if(ce==="executing")throw new Error("Generator is already running");if(ce==="completed"){if(ge==="throw")throw Re;return Xi()}for(ne.method=ge,ne.arg=Re;;){var xe=ne.delegate;if(xe){var Ke=_n(xe,ne);if(Ke){if(Ke===fe)continue;return Ke}}if(ne.method==="next")ne.sent=ne._sent=ne.arg;else if(ne.method==="throw"){if(ce==="suspendedStart")throw ce="completed",ne.arg;ne.dispatchException(ne.arg)}else ne.method==="return"&&ne.abrupt("return",ne.arg);ce="executing";var rt=re(Me,Te,ne);if(rt.type==="normal"){if(ce=ne.done?"completed":"suspendedYield",rt.arg===fe)continue;return{value:rt.arg,done:ne.done}}rt.type==="throw"&&(ce="completed",ne.method="throw",ne.arg=rt.arg)}}}function _n(Me,Te){var ne=Te.method,ce=Me.iterator[ne];if(ce===void 0)return Te.delegate=null,ne==="throw"&&Me.iterator.return&&(Te.method="return",Te.arg=void 0,_n(Me,Te),Te.method==="throw")||ne!=="return"&&(Te.method="throw",Te.arg=new TypeError("The iterator does not provide a '"+ne+"' method")),fe;var ge=re(ce,Me.iterator,Te.arg);if(ge.type==="throw")return Te.method="throw",Te.arg=ge.arg,Te.delegate=null,fe;var Re=ge.arg;return Re?Re.done?(Te[Me.resultName]=Re.value,Te.next=Me.nextLoc,Te.method!=="return"&&(Te.method="next",Te.arg=void 0),Te.delegate=null,fe):Re:(Te.method="throw",Te.arg=new TypeError("iterator result is not an object"),Te.delegate=null,fe)}function Kt(Me){var Te={tryLoc:Me[0]};1 in Me&&(Te.catchLoc=Me[1]),2 in Me&&(Te.finallyLoc=Me[2],Te.afterLoc=Me[3]),this.tryEntries.push(Te)}function Vr(Me){var Te=Me.completion||{};Te.type="normal",delete Te.arg,Me.completion=Te}function gi(Me){this.tryEntries=[{tryLoc:"root"}],Me.forEach(Kt,this),this.reset(!0)}function $n(Me){if(Me){var Te=Me[j];if(Te)return Te.call(Me);if(typeof Me.next=="function")return Me;if(!isNaN(Me.length)){var ne=-1,ce=function ge(){for(;++ne<Me.length;)if(G.call(Me,ne))return ge.value=Me[ne],ge.done=!1,ge;return ge.value=void 0,ge.done=!0,ge};return ce.next=ce}}return{next:Xi}}function Xi(){return{value:void 0,done:!0}}return je.prototype=Le,q(Nt,"constructor",{value:Le,configurable:!0}),q(Le,"constructor",{value:je,configurable:!0}),je.displayName=Y(Le,J,"GeneratorFunction"),Z.isGeneratorFunction=function(Me){var Te=typeof Me=="function"&&Me.constructor;return!!Te&&(Te===je||(Te.displayName||Te.name)==="GeneratorFunction")},Z.mark=function(Me){return Object.setPrototypeOf?Object.setPrototypeOf(Me,Le):(Me.__proto__=Le,Y(Me,J,"GeneratorFunction")),Me.prototype=Object.create(Nt),Me},Z.awrap=function(Me){return{__await:Me}},Ae(Ge.prototype),Y(Ge.prototype,P,function(){return this}),Z.AsyncIterator=Ge,Z.async=function(Me,Te,ne,ce,ge){ge===void 0&&(ge=Promise);var Re=new Ge(X(Me,Te,ne,ce),ge);return Z.isGeneratorFunction(Te)?Re:Re.next().then(function(xe){return xe.done?xe.value:Re.next()})},Ae(Nt),Y(Nt,J,"Generator"),Y(Nt,j,function(){return this}),Y(Nt,"toString",function(){return"[object Generator]"}),Z.keys=function(Me){var Te=Object(Me),ne=[];for(var ce in Te)ne.push(ce);return ne.reverse(),function ge(){for(;ne.length;){var Re=ne.pop();if(Re in Te)return ge.value=Re,ge.done=!1,ge}return ge.done=!0,ge}},Z.values=$n,gi.prototype={constructor:gi,reset:function(Te){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Vr),!Te)for(var ne in this)ne.charAt(0)==="t"&&G.call(this,ne)&&!isNaN(+ne.slice(1))&&(this[ne]=void 0)},stop:function(){this.done=!0;var Te=this.tryEntries[0].completion;if(Te.type==="throw")throw Te.arg;return this.rval},dispatchException:function(Te){if(this.done)throw Te;var ne=this;function ce(Tt,wt){return xe.type="throw",xe.arg=Te,ne.next=Tt,wt&&(ne.method="next",ne.arg=void 0),!!wt}for(var ge=this.tryEntries.length-1;ge>=0;--ge){var Re=this.tryEntries[ge],xe=Re.completion;if(Re.tryLoc==="root")return ce("end");if(Re.tryLoc<=this.prev){var Ke=G.call(Re,"catchLoc"),rt=G.call(Re,"finallyLoc");if(Ke&&rt){if(this.prev<Re.catchLoc)return ce(Re.catchLoc,!0);if(this.prev<Re.finallyLoc)return ce(Re.finallyLoc)}else if(Ke){if(this.prev<Re.catchLoc)return ce(Re.catchLoc,!0)}else{if(!rt)throw new Error("try statement without catch or finally");if(this.prev<Re.finallyLoc)return ce(Re.finallyLoc)}}}},abrupt:function(Te,ne){for(var ce=this.tryEntries.length-1;ce>=0;--ce){var ge=this.tryEntries[ce];if(ge.tryLoc<=this.prev&&G.call(ge,"finallyLoc")&&this.prev<ge.finallyLoc){var Re=ge;break}}Re&&(Te==="break"||Te==="continue")&&Re.tryLoc<=ne&&ne<=Re.finallyLoc&&(Re=null);var xe=Re?Re.completion:{};return xe.type=Te,xe.arg=ne,Re?(this.method="next",this.next=Re.finallyLoc,fe):this.complete(xe)},complete:function(Te,ne){if(Te.type==="throw")throw Te.arg;return Te.type==="break"||Te.type==="continue"?this.next=Te.arg:Te.type==="return"?(this.rval=this.arg=Te.arg,this.method="return",this.next="end"):Te.type==="normal"&&ne&&(this.next=ne),fe},finish:function(Te){for(var ne=this.tryEntries.length-1;ne>=0;--ne){var ce=this.tryEntries[ne];if(ce.finallyLoc===Te)return this.complete(ce.completion,ce.afterLoc),Vr(ce),fe}},catch:function(Te){for(var ne=this.tryEntries.length-1;ne>=0;--ne){var ce=this.tryEntries[ne];if(ce.tryLoc===Te){var ge=ce.completion;if(ge.type==="throw"){var Re=ge.arg;Vr(ce)}return Re}}throw new Error("illegal catch attempt")},delegateYield:function(Te,ne,ce){return this.delegate={iterator:$n(Te),resultName:ne,nextLoc:ce},this.method==="next"&&(this.arg=void 0),fe}},Z}function w(Z,pe,G,q,x,j,P){try{var J=Z[j](P),Y=J.value}catch(X){G(X);return}J.done?pe(Y):Promise.resolve(Y).then(q,x)}function N(Z){return function(){var pe=this,G=arguments;return new Promise(function(q,x){var j=Z.apply(pe,G);function P(Y){w(j,q,x,P,J,"next",Y)}function J(Y){w(j,q,x,P,J,"throw",Y)}P(void 0)})}}function A(Z,pe){if(!(Z instanceof pe))throw new TypeError("Cannot call a class as a function")}function K(Z,pe){for(var G=0;G<pe.length;G++){var q=pe[G];q.enumerable=q.enumerable||!1,q.configurable=!0,"value"in q&&(q.writable=!0),Object.defineProperty(Z,be(q.key),q)}}function z(Z,pe,G){return pe&&K(Z.prototype,pe),Object.defineProperty(Z,"prototype",{writable:!1}),Z}function de(Z,pe){if(typeof pe!="function"&&pe!==null)throw new TypeError("Super expression must either be null or a function");Z.prototype=Object.create(pe&&pe.prototype,{constructor:{value:Z,writable:!0,configurable:!0}}),Object.defineProperty(Z,"prototype",{writable:!1}),pe&&_e(Z,pe)}function _e(Z,pe){return _e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(q,x){return q.__proto__=x,q},_e(Z,pe)}function le(Z){var pe=B();return function(){var q=te(Z),x;if(pe){var j=te(this).constructor;x=Reflect.construct(q,arguments,j)}else x=q.apply(this,arguments);return Ce(this,x)}}function Ce(Z,pe){if(pe&&(p(pe)==="object"||typeof pe=="function"))return pe;if(pe!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return V(Z)}function V(Z){if(Z===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return Z}function B(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function te(Z){return te=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(G){return G.__proto__||Object.getPrototypeOf(G)},te(Z)}function he(Z,pe,G){return pe=be(pe),pe in Z?Object.defineProperty(Z,pe,{value:G,enumerable:!0,configurable:!0,writable:!0}):Z[pe]=G,Z}function be(Z){var pe=De(Z,"string");return p(pe)==="symbol"?pe:String(pe)}function De(Z,pe){if(p(Z)!=="object"||Z===null)return Z;var G=Z[Symbol.toPrimitive];if(G!==void 0){var q=G.call(Z,pe);if(p(q)!=="object")return q;throw new TypeError("@@toPrimitive must return a primitive value.")}return(pe==="string"?String:Number)(Z)}function W(Z){var pe,G,q,x=2;for(typeof Symbol<"u"&&(G=Symbol.asyncIterator,q=Symbol.iterator);x--;){if(G&&(pe=Z[G])!=null)return pe.call(Z);if(q&&(pe=Z[q])!=null)return new ue(pe.call(Z));G="@@asyncIterator",q="@@iterator"}throw new TypeError("Object is not async iterable")}function ue(Z){function pe(G){if(Object(G)!==G)return Promise.reject(new TypeError(G+" is not an object."));var q=G.done;return Promise.resolve(G.value).then(function(x){return{value:x,done:q}})}return ue=function(q){this.s=q,this.n=q.next},ue.prototype={s:null,n:null,next:function(){return pe(this.n.apply(this.s,arguments))},return:function(q){var x=this.s.return;return x===void 0?Promise.resolve({value:q,done:!0}):pe(x.apply(this.s,arguments))},throw:function(q){var x=this.s.return;return x===void 0?Promise.reject(q):pe(x.apply(this.s,arguments))}},new ue(Z)}var we=(function(Z){de(G,Z);var pe=le(G);function G(q,x,j){var P;if(A(this,G),P=pe.call(this),P.widget=q,P.driver=j,he(V(P),"transport",void 0),he(V(P),"cachedWidgetVersions",null),he(V(P),"contentLoadedActionSent",!1),he(V(P),"allowedCapabilities",new Set),he(V(P),"allowedEvents",[]),he(V(P),"isStopped",!1),he(V(P),"turnServers",null),he(V(P),"contentLoadedWaitTimer",void 0),he(V(P),"pushRoomStateTasks",new Set),he(V(P),"pushRoomStateResult",new Map),he(V(P),"flushRoomStateTask",null),he(V(P),"viewedRoomId",null),!(x!=null&&x.contentWindow))throw new Error("No iframe supplied");if(!q)throw new Error("Invalid widget");if(!j)throw new Error("Invalid driver");return P.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,q.id,x.contentWindow,globalThis),P.transport.targetOrigin=q.origin,P.transport.on("message",P.handleMessage.bind(V(P))),x.addEventListener("load",P.onIframeLoad.bind(V(P))),P.transport.start(),P}return z(G,[{key:"hasCapability",value:function(x){return this.allowedCapabilities.has(x)}},{key:"canUseRoomTimeline",value:function(x){return this.hasCapability("org.matrix.msc2762.timeline:".concat(h.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(x))}},{key:"canSendRoomEvent",value:function(x){var j=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(P){return P.matchesAsRoomEvent(l.EventDirection.Send,x,j)})}},{key:"canSendStateEvent",value:function(x,j){return this.allowedEvents.some(function(P){return P.matchesAsStateEvent(l.EventDirection.Send,x,j)})}},{key:"canSendToDeviceEvent",value:function(x){return this.allowedEvents.some(function(j){return j.matchesAsToDeviceEvent(l.EventDirection.Send,x)})}},{key:"canReceiveRoomEvent",value:function(x){var j=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(P){return P.matchesAsRoomEvent(l.EventDirection.Receive,x,j)})}},{key:"canReceiveStateEvent",value:function(x,j){return this.allowedEvents.some(function(P){return P.matchesAsStateEvent(l.EventDirection.Receive,x,j)})}},{key:"canReceiveToDeviceEvent",value:function(x){return this.allowedEvents.some(function(j){return j.matchesAsToDeviceEvent(l.EventDirection.Receive,x)})}},{key:"canReceiveRoomAccountData",value:function(x){return this.allowedEvents.some(function(j){return j.matchesAsRoomAccountData(l.EventDirection.Receive,x)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:(function(){var q=N(D().mark(function j(){var P;return D().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){Y.next=2;break}return Y.abrupt("return",this.cachedWidgetVersions);case 2:return Y.prev=2,Y.next=5,this.transport.send(r.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return P=Y.sent,this.cachedWidgetVersions=P.supported_versions,Y.abrupt("return",P.supported_versions);case 10:return Y.prev=10,Y.t0=Y.catch(2),console.warn("non-fatal error getting supported widget versions: ",Y.t0),Y.abrupt("return",[]);case 14:case"end":return Y.stop()}},j,this,[[2,10]])}));function x(){return q.apply(this,arguments)}return x})()},{key:"beginCapabilities",value:function(){var x=this;this.emit("preparing");var j;this.transport.send(r.WidgetApiToWidgetAction.Capabilities,{}).then(function(P){return j=P.capabilities,x.driver.validateCapabilities(new Set(P.capabilities))}).then(function(P){x.allowCapabilities(E(P),j),x.emit("ready")}).catch(function(P){x.emit("error:preparing",P)})}},{key:"allowCapabilities",value:function(x,j){var P,J=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),x);var Y=b(x),X;try{for(Y.s();!(X=Y.n()).done;){var re=X.value;this.allowedCapabilities.add(re)}}catch(Kt){Y.e(Kt)}finally{Y.f()}var fe=l.WidgetEventCapability.findEventCapabilities(x);(P=this.allowedEvents).push.apply(P,E(fe)),this.transport.send(r.WidgetApiToWidgetAction.NotifyCapabilities,{requested:j,approved:Array.from(this.allowedCapabilities)}).catch(function(Kt){console.warn("non-fatal error notifying widget of approved capabilities:",Kt)}).then(function(){J.emit("capabilitiesNotified")});var Ee=b(x),je;try{for(Ee.s();!(je=Ee.n()).done;){var Le=je.value;if((0,n.isTimelineCapability)(Le)){var Ne=(0,n.getTimelineRoomIDFromCapability)(Le);if(Ne===h.Symbols.AnyRoom){var it=b(this.driver.getKnownRooms()),dt;try{for(it.s();!(dt=it.n()).done;){var Nt=dt.value;this.pushRoomState(Nt)}}catch(Kt){it.e(Kt)}finally{it.f()}}else this.pushRoomState(Ne)}}}catch(Kt){Ee.e(Kt)}finally{Ee.f()}if(x.includes(n.MatrixCapabilities.MSC4407ReceiveStickyEvent)){console.debug("Widget ".concat(this.widget.id," is allowed to receive sticky events, check current sticky state."));var Ae=x.filter(function(Kt){return(0,n.isTimelineCapability)(Kt)}).map(function(Kt){return(0,n.getTimelineRoomIDFromCapability)(Kt)}).flatMap(function(Kt){return Kt===h.Symbols.AnyRoom?J.driver.getKnownRooms():Kt});console.debug("Widget ".concat(this.widget.id," is allowed to receive sticky events in rooms:"),Ae);var Ge=b(Ae),Pn;try{var _n=function(){var Vr=Pn.value;J.pushStickyState(Vr).catch(function(gi){console.error("Failed to push sticky events to widget ".concat(J.widget.id," for room ").concat(Vr,":"),gi)})};for(Ge.s();!(Pn=Ge.n()).done;)_n()}catch(Kt){Ge.e(Kt)}finally{Ge.f()}}fe.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(x){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(x){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(x,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(x,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(x){this.transport.reply(x,{supported_versions:s.CurrentApiVersions})}},{key:"supportsUpdateState",value:(function(){var q=N(D().mark(function j(){return D().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:return J.next=2,this.getWidgetVersions();case 2:return J.abrupt("return",J.sent.includes(s.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return J.stop()}},j,this)}));function x(){return q.apply(this,arguments)}return x})()},{key:"handleCapabilitiesRenegotiate",value:function(x){var j,P=this;this.transport.reply(x,{});var J=((j=x.data)===null||j===void 0?void 0:j.capabilities)||[],Y=new Set(J.filter(function(X){return!P.hasCapability(X)}));Y.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(Y).then(function(X){return P.allowCapabilities(E(X),E(Y))})}},{key:"handleNavigate",value:function(x){var j,P=this;if(!this.hasCapability(n.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(x,{error:{message:"Missing capability"}});if(!((j=x.data)!==null&&j!==void 0&&j.uri.startsWith("https://matrix.to/#")))return this.transport.reply(x,{error:{message:"Invalid matrix.to URI"}});var J=function(X){console.error("[ClientWidgetApi] Failed to handle navigation: ",X),P.handleDriverError(X,x,"Error handling navigation")};try{this.driver.navigate(x.data.uri.toString()).catch(function(Y){return J(Y)}).then(function(){return P.transport.reply(x,{})})}catch(Y){return J(Y)}}},{key:"handleOIDC",value:function(x){var j=this,P=1,J=function(fe,Ee){return Ee=Ee||{},P>1?j.transport.send(r.WidgetApiToWidgetAction.OpenIDCredentials,_({state:fe,original_request_id:x.requestId},Ee)):j.transport.reply(x,_({state:fe},Ee))},Y=function(fe){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",fe),P>1?J(c.OpenIDRequestState.Blocked):j.transport.reply(x,{error:{message:fe}})},X=new d.SimpleObservable(function(re){if(re.state===c.OpenIDRequestState.PendingUserConfirmation&&P>1)return X.close(),Y("client provided out-of-phase response to OIDC flow");if(re.state===c.OpenIDRequestState.PendingUserConfirmation){J(re.state),P++;return}return re.state===c.OpenIDRequestState.Allowed&&!re.token?Y("client provided invalid OIDC token for an allowed request"):(re.state===c.OpenIDRequestState.Blocked&&(re.token=void 0),X.close(),J(re.state,re.token))});this.driver.askOpenID(X)}},{key:"handleReadRoomAccountData",value:function(x){var j=this,P=this.driver.readRoomAccountData(x.data.type);return this.canReceiveRoomAccountData(x.data.type)?P.then(function(J){j.transport.reply(x,{events:J})}):this.transport.reply(x,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:(function(){var q=N(D().mark(function j(P){var J=this,Y,X,re,fe,Ee,je,Le,Ne,it,dt;return D().wrap(function(Ae){for(;;)switch(Ae.prev=Ae.next){case 0:if(P.data.type){Ae.next=2;break}return Ae.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(P.data.limit!==void 0&&(!P.data.limit||P.data.limit<0))){Ae.next=4;break}return Ae.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 4:if(P.data.room_ids!==void 0){Ae.next=8;break}Y=this.viewedRoomId===null?[]:[this.viewedRoomId],Ae.next=30;break;case 8:if(P.data.room_ids!==h.Symbols.AnyRoom){Ae.next=12;break}Y=this.driver.getKnownRooms().filter(function(Ge){return J.canUseRoomTimeline(Ge)}),Ae.next=30;break;case 12:Y=P.data.room_ids,X=b(Y),Ae.prev=14,X.s();case 16:if((re=X.n()).done){Ae.next=22;break}if(fe=re.value,this.canUseRoomTimeline(fe)){Ae.next=20;break}return Ae.abrupt("return",this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(fe)}}));case 20:Ae.next=16;break;case 22:Ae.next=27;break;case 24:Ae.prev=24,Ae.t0=Ae.catch(14),X.e(Ae.t0);case 27:return Ae.prev=27,X.f(),Ae.finish(27);case 30:if(Ee=P.data.limit||0,je=P.data.since,Le=void 0,Ne=void 0,P.data.state_key===void 0){Ae.next=40;break}if(Le=P.data.state_key===!0?void 0:P.data.state_key.toString(),this.canReceiveStateEvent(P.data.type,(it=Le)!==null&&it!==void 0?it:null)){Ae.next=38;break}return Ae.abrupt("return",this.transport.reply(P,{error:{message:"Cannot read state events of this type"}}));case 38:Ae.next=43;break;case 40:if(Ne=P.data.msgtype,this.canReceiveRoomEvent(P.data.type,Ne)){Ae.next=43;break}return Ae.abrupt("return",this.transport.reply(P,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(P.data.room_ids===void 0&&Y.length===0)){Ae.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),Ae.next=47,P.data.state_key===void 0?this.driver.readRoomEvents(P.data.type,Ne,Ee,null,je):this.driver.readStateEvents(P.data.type,Le,Ee,null);case 47:dt=Ae.sent,Ae.next=68;break;case 50:return Ae.next=52,this.supportsUpdateState();case 52:if(!Ae.sent){Ae.next=58;break}return Ae.next=55,Promise.all(Y.map(function(Ge){return J.driver.readRoomTimeline(Ge,P.data.type,Ne,Le,Ee,je)}));case 55:dt=Ae.sent.flat(1),Ae.next=68;break;case 58:if(P.data.state_key!==void 0){Ae.next=64;break}return Ae.next=61,Promise.all(Y.map(function(Ge){return J.driver.readRoomTimeline(Ge,P.data.type,Ne,Le,Ee,je)}));case 61:Ae.t1=Ae.sent,Ae.next=67;break;case 64:return Ae.next=66,Promise.all(Y.map(function(Ge){return J.driver.readRoomState(Ge,P.data.type,Le)}));case 66:Ae.t1=Ae.sent;case 67:dt=Ae.t1.flat(1);case 68:this.transport.reply(P,{events:dt});case 69:case"end":return Ae.stop()}},j,this,[[14,24,27,30]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleSendEvent",value:function(x){var j=this;if(!x.data.type)return this.transport.reply(x,{error:{message:"Invalid request - missing event type"}});if(x.data.room_id&&!this.canUseRoomTimeline(x.data.room_id))return this.transport.reply(x,{error:{message:"Unable to access room timeline: ".concat(x.data.room_id)}});var P=x.data.delay!==void 0||x.data.parent_delay_id!==void 0;if(P&&!this.hasCapability(n.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(x,{error:{message:"Missing capability for ".concat(n.MatrixCapabilities.MSC4157SendDelayedEvent)}});var J=x.data.sticky_duration_ms!==void 0;if(J&&!this.hasCapability(n.MatrixCapabilities.MSC4407SendStickyEvent))return this.transport.reply(x,{error:{message:"Missing capability for ".concat(n.MatrixCapabilities.MSC4407SendStickyEvent)}});var Y;if(x.data.state_key!==void 0){if(!this.canSendStateEvent(x.data.type,x.data.state_key))return this.transport.reply(x,{error:{message:"Cannot send state events of this type"}});if(J)return this.transport.reply(x,{error:{message:"Cannot send a state event with a sticky duration"}});if(P){var X,re;Y=this.driver.sendDelayedEvent((X=x.data.delay)!==null&&X!==void 0?X:null,(re=x.data.parent_delay_id)!==null&&re!==void 0?re:null,x.data.type,x.data.content||{},x.data.state_key,x.data.room_id)}else Y=this.driver.sendEvent(x.data.type,x.data.content||{},x.data.state_key,x.data.room_id)}else{var fe=x.data.content||{},Ee=fe.msgtype;if(!this.canSendRoomEvent(x.data.type,Ee))return this.transport.reply(x,{error:{message:"Cannot send room events of this type"}});var je=[x.data.type,fe,null,x.data.room_id];if(P&&x.data.sticky_duration_ms){var Le,Ne;Y=this.driver.sendDelayedStickyEvent((Le=x.data.delay)!==null&&Le!==void 0?Le:null,(Ne=x.data.parent_delay_id)!==null&&Ne!==void 0?Ne:null,x.data.sticky_duration_ms,x.data.type,fe,x.data.room_id)}else if(P){var it,dt,Nt;Y=(it=this.driver).sendDelayedEvent.apply(it,[(dt=x.data.delay)!==null&&dt!==void 0?dt:null,(Nt=x.data.parent_delay_id)!==null&&Nt!==void 0?Nt:null].concat(je))}else if(x.data.sticky_duration_ms)Y=this.driver.sendStickyEvent(x.data.sticky_duration_ms,x.data.type,fe,x.data.room_id);else{var Ae;Y=(Ae=this.driver).sendEvent.apply(Ae,je)}}Y.then(function(Ge){return j.transport.reply(x,_({room_id:Ge.roomId},"eventId"in Ge?{event_id:Ge.eventId}:{delay_id:Ge.delayId}))}).catch(function(Ge){console.error("error sending event: ",Ge),j.handleDriverError(Ge,x,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(x){var j=this;if(!x.data.delay_id)return this.transport.reply(x,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(n.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(x,{error:{message:"Missing capability"}});var P;switch(x.data.action){case v.UpdateDelayedEventAction.Cancel:P=this.driver.cancelScheduledDelayedEvent;break;case v.UpdateDelayedEventAction.Restart:P=this.driver.restartScheduledDelayedEvent;break;case v.UpdateDelayedEventAction.Send:P=this.driver.sendScheduledDelayedEvent;break;default:return this.transport.reply(x,{error:{message:"Invalid request - unsupported action"}})}P.call(this.driver,x.data.delay_id).then(function(){return j.transport.reply(x,{})}).catch(function(J){console.error("error updating delayed event: ",J),j.handleDriverError(J,x,"Error updating delayed event")})}},{key:"handleSendToDevice",value:(function(){var q=N(D().mark(function j(P){return D().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(P.data.type){Y.next=4;break}this.transport.reply(P,{error:{message:"Invalid request - missing event type"}}),Y.next=26;break;case 4:if(P.data.messages){Y.next=8;break}this.transport.reply(P,{error:{message:"Invalid request - missing event contents"}}),Y.next=26;break;case 8:if(typeof P.data.encrypted=="boolean"){Y.next=12;break}this.transport.reply(P,{error:{message:"Invalid request - missing encryption flag"}}),Y.next=26;break;case 12:if(this.canSendToDeviceEvent(P.data.type)){Y.next=16;break}this.transport.reply(P,{error:{message:"Cannot send to-device events of this type"}}),Y.next=26;break;case 16:return Y.prev=16,Y.next=19,this.driver.sendToDevice(P.data.type,P.data.encrypted,P.data.messages);case 19:this.transport.reply(P,{}),Y.next=26;break;case 22:Y.prev=22,Y.t0=Y.catch(16),console.error("error sending to-device event",Y.t0),this.handleDriverError(Y.t0,P,"Error sending event");case 26:case"end":return Y.stop()}},j,this,[[16,22]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"pollTurnServers",value:(function(){var q=N(D().mark(function j(P,J){var Y,X,re,fe,Ee,je;return D().wrap(function(Ne){for(;;)switch(Ne.prev=Ne.next){case 0:return Ne.prev=0,Ne.next=3,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,J);case 3:Y=!1,X=!1,Ne.prev=5,fe=W(P);case 7:return Ne.next=9,fe.next();case 9:if(!(Y=!(Ee=Ne.sent).done)){Ne.next=16;break}return je=Ee.value,Ne.next=13,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,je);case 13:Y=!1,Ne.next=7;break;case 16:Ne.next=22;break;case 18:Ne.prev=18,Ne.t0=Ne.catch(5),X=!0,re=Ne.t0;case 22:if(Ne.prev=22,Ne.prev=23,!(Y&&fe.return!=null)){Ne.next=27;break}return Ne.next=27,fe.return();case 27:if(Ne.prev=27,!X){Ne.next=30;break}throw re;case 30:return Ne.finish(27);case 31:return Ne.finish(22);case 32:Ne.next=37;break;case 34:Ne.prev=34,Ne.t1=Ne.catch(0),console.error("error polling for TURN servers",Ne.t1);case 37:case"end":return Ne.stop()}},j,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function x(j,P){return q.apply(this,arguments)}return x})()},{key:"handleWatchTurnServers",value:(function(){var q=N(D().mark(function j(P){var J,Y,X,re;return D().wrap(function(Ee){for(;;)switch(Ee.prev=Ee.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){Ee.next=4;break}this.transport.reply(P,{error:{message:"Missing capability"}}),Ee.next=26;break;case 4:if(!this.turnServers){Ee.next=8;break}this.transport.reply(P,{}),Ee.next=26;break;case 8:return Ee.prev=8,J=this.driver.getTurnServers(),Ee.next=12,J.next();case 12:if(Y=Ee.sent,X=Y.done,re=Y.value,!X){Ee.next=17;break}throw new Error("Client refuses to provide any TURN servers");case 17:this.transport.reply(P,{}),this.pollTurnServers(J,re),this.turnServers=J,Ee.next=26;break;case 22:Ee.prev=22,Ee.t0=Ee.catch(8),console.error("error getting first TURN server results",Ee.t0),this.transport.reply(P,{error:{message:"TURN servers not available"}});case 26:case"end":return Ee.stop()}},j,this,[[8,22]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleUnwatchTurnServers",value:(function(){var q=N(D().mark(function j(P){return D().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){Y.next=4;break}this.transport.reply(P,{error:{message:"Missing capability"}}),Y.next=12;break;case 4:if(this.turnServers){Y.next=8;break}this.transport.reply(P,{}),Y.next=12;break;case 8:return Y.next=10,this.turnServers.return(void 0);case 10:this.turnServers=null,this.transport.reply(P,{});case 12:case"end":return Y.stop()}},j,this)}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleReadRelations",value:(function(){var q=N(D().mark(function j(P){var J=this,Y,X;return D().wrap(function(fe){for(;;)switch(fe.prev=fe.next){case 0:if(P.data.event_id){fe.next=2;break}return fe.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(P.data.limit!==void 0&&P.data.limit<0)){fe.next=4;break}return fe.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(P.data.room_id!==void 0&&!this.canUseRoomTimeline(P.data.room_id))){fe.next=6;break}return fe.abrupt("return",this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(P.data.room_id)}}));case 6:return fe.prev=6,fe.next=9,this.driver.readEventRelations(P.data.event_id,P.data.room_id,P.data.rel_type,P.data.event_type,P.data.from,P.data.to,P.data.limit,P.data.direction);case 9:return Y=fe.sent,X=Y.chunk.filter(function(Ee){return Ee.state_key!==void 0?J.canReceiveStateEvent(Ee.type,Ee.state_key):J.canReceiveRoomEvent(Ee.type,Ee.content.msgtype)}),fe.abrupt("return",this.transport.reply(P,{chunk:X,prev_batch:Y.prevBatch,next_batch:Y.nextBatch}));case 14:fe.prev=14,fe.t0=fe.catch(6),console.error("error getting the relations",fe.t0),this.handleDriverError(fe.t0,P,"Unexpected error while reading relations");case 18:case"end":return fe.stop()}},j,this,[[6,14]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleUserDirectorySearch",value:(function(){var q=N(D().mark(function j(P){var J;return D().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3973UserDirectorySearch)){X.next=2;break}return X.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:if(typeof P.data.search_term=="string"){X.next=4;break}return X.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(P.data.limit!==void 0&&P.data.limit<0)){X.next=6;break}return X.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 6:return X.prev=6,X.next=9,this.driver.searchUserDirectory(P.data.search_term,P.data.limit);case 9:return J=X.sent,X.abrupt("return",this.transport.reply(P,{limited:J.limited,results:J.results.map(function(re){return{user_id:re.userId,display_name:re.displayName,avatar_url:re.avatarUrl}})}));case 13:X.prev=13,X.t0=X.catch(6),console.error("error searching in the user directory",X.t0),this.handleDriverError(X.t0,P,"Unexpected error while searching in the user directory");case 17:case"end":return X.stop()}},j,this,[[6,13]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleGetMediaConfig",value:(function(){var q=N(D().mark(function j(P){var J;return D().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){X.next=2;break}return X.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return X.prev=2,X.next=5,this.driver.getMediaConfig();case 5:return J=X.sent,X.abrupt("return",this.transport.reply(P,J));case 9:X.prev=9,X.t0=X.catch(2),console.error("error while getting the media configuration",X.t0),this.handleDriverError(X.t0,P,"Unexpected error while getting the media configuration");case 13:case"end":return X.stop()}},j,this,[[2,9]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleUploadFile",value:(function(){var q=N(D().mark(function j(P){var J;return D().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){X.next=2;break}return X.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return X.prev=2,X.next=5,this.driver.uploadFile(P.data.file);case 5:return J=X.sent,X.abrupt("return",this.transport.reply(P,{content_uri:J.contentUri}));case 9:X.prev=9,X.t0=X.catch(2),console.error("error while uploading a file",X.t0),this.handleDriverError(X.t0,P,"Unexpected error while uploading a file");case 13:case"end":return X.stop()}},j,this,[[2,9]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleDownloadFile",value:(function(){var q=N(D().mark(function j(P){var J;return D().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039DownloadFile)){X.next=2;break}return X.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return X.prev=2,X.next=5,this.driver.downloadFile(P.data.content_uri);case 5:return J=X.sent,X.abrupt("return",this.transport.reply(P,{file:J.file}));case 9:X.prev=9,X.t0=X.catch(2),console.error("error while downloading a file",X.t0),this.handleDriverError(X.t0,P,"Unexpected error while downloading a file");case 13:case"end":return X.stop()}},j,this,[[2,9]])}));function x(j){return q.apply(this,arguments)}return x})()},{key:"handleDriverError",value:function(x,j,P){var J=this.driver.processError(x);this.transport.reply(j,{error:_({message:P},J)})}},{key:"handleMessage",value:function(x){if(!this.isStopped){var j=new CustomEvent("action:".concat(x.detail.action),{detail:x.detail,cancelable:!0});if(this.emit("action:".concat(x.detail.action),j),!j.defaultPrevented)switch(x.detail.action){case r.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(x.detail);case r.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(x.detail);case r.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(x.detail);case r.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(x.detail);case r.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(x.detail);case r.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(x.detail);case r.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(x.detail);case r.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(x.detail);case r.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(x.detail);case r.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(x.detail);case r.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(x.detail);case r.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(x.detail);case r.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(x.detail);case r.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(x.detail);case r.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(x.detail);case r.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(x.detail);case r.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(x.detail);default:return this.transport.reply(x.detail,{error:{message:"Unknown or unsupported from-widget action: "+x.detail.action}})}}}},{key:"updateTheme",value:function(x){return this.transport.send(r.WidgetApiToWidgetAction.ThemeChange,x)}},{key:"updateLanguage",value:function(x){return this.transport.send(r.WidgetApiToWidgetAction.LanguageChange,{lang:x})}},{key:"takeScreenshot",value:function(){return this.transport.send(r.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(x){return this.transport.send(r.WidgetApiToWidgetAction.UpdateVisibility,{visible:x})}},{key:"sendWidgetConfig",value:function(x){return this.transport.send(r.WidgetApiToWidgetAction.WidgetConfig,x).then()}},{key:"notifyModalWidgetButtonClicked",value:function(x){return this.transport.send(r.WidgetApiToWidgetAction.ButtonClicked,{id:x}).then()}},{key:"notifyModalWidgetClose",value:function(x){return this.transport.send(r.WidgetApiToWidgetAction.CloseModalWidget,x).then()}},{key:"feedEvent",value:(function(){var q=N(D().mark(function j(P,J){var Y;return D().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:if(J!==void 0&&this.setViewedRoomId(J),!(P.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(P.room_id))){re.next=3;break}return re.abrupt("return");case 3:if(!(P.state_key!==void 0&&P.state_key!==null)){re.next=8;break}if(this.canReceiveStateEvent(P.type,P.state_key)){re.next=6;break}return re.abrupt("return");case 6:re.next=10;break;case 8:if(this.canReceiveRoomEvent(P.type,(Y=P.content)===null||Y===void 0?void 0:Y.msgtype)){re.next=10;break}return re.abrupt("return");case 10:return re.next=12,this.transport.send(r.WidgetApiToWidgetAction.SendEvent,P);case 12:case"end":return re.stop()}},j,this)}));function x(j,P){return q.apply(this,arguments)}return x})()},{key:"feedToDevice",value:(function(){var q=N(D().mark(function j(P,J){return D().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:if(!this.canReceiveToDeviceEvent(P.type)){X.next=3;break}return X.next=3,this.transport.send(r.WidgetApiToWidgetAction.SendToDevice,_(_({},P),{},{encrypted:J}));case 3:case"end":return X.stop()}},j,this)}));function x(j,P){return q.apply(this,arguments)}return x})()},{key:"setViewedRoomId",value:(function(x){this.viewedRoomId=x,x!==null&&!this.canUseRoomTimeline(x)&&this.pushRoomState(x)})},{key:"flushRoomState",value:(function(){var q=N(D().mark(function j(){var P,J,Y,X,re,fe,Ee;return D().wrap(function(Le){for(;;)switch(Le.prev=Le.next){case 0:Le.prev=0;case 1:return Le.next=3,Promise.all(this.pushRoomStateTasks);case 3:if(this.pushRoomStateTasks.size>0){Le.next=1;break}case 4:P=[],J=b(this.pushRoomStateResult.values());try{for(J.s();!(Y=J.n()).done;){X=Y.value,re=b(X.values());try{for(re.s();!(fe=re.n()).done;)Ee=fe.value,P.push.apply(P,E(Ee.values()))}catch(Ne){re.e(Ne)}finally{re.f()}}}catch(Ne){J.e(Ne)}finally{J.f()}return Le.next=9,this.getWidgetVersions();case 9:if(!Le.sent.includes(s.UnstableApiVersion.MSC2762_UPDATE_STATE)){Le.next=12;break}return Le.next=12,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:P});case 12:return Le.prev=12,this.flushRoomStateTask=null,Le.finish(12);case 15:case"end":return Le.stop()}},j,this,[[0,,12,15]])}));function x(){return q.apply(this,arguments)}return x})()},{key:"pushStickyState",value:(function(){var q=N(D().mark(function j(P){var J=this;return D().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:return console.debug("Pushing sticky state to widget for room",P),X.abrupt("return",this.driver.readStickyEvents(P).then(function(re){var fe=re.filter(function(Ee){var je;return J.canReceiveRoomEvent(Ee.type,typeof((je=Ee.content)===null||je===void 0?void 0:je.msgtype)=="string"?Ee.content.msgtype:null)});return{roomId:P,stickyEvents:fe}}).then((function(){var re=N(D().mark(function fe(Ee){var je,Le,Ne;return D().wrap(function(dt){for(;;)switch(dt.prev=dt.next){case 0:return je=Ee.roomId,Le=Ee.stickyEvents,console.debug("Pushing",Le.length,"sticky events to widget for room",je),Ne=Le.map(function(Nt){return J.transport.send(r.WidgetApiToWidgetAction.SendEvent,Nt)}),dt.next=5,Promise.all(Ne);case 5:case"end":return dt.stop()}},fe)}));return function(fe){return re.apply(this,arguments)}})()));case 2:case"end":return X.stop()}},j,this)}));function x(j){return q.apply(this,arguments)}return x})()},{key:"pushRoomState",value:function(x){var j=this,P=b(this.allowedEvents),J;try{var Y=function(){var re=J.value;if(re.kind===l.EventKind.State&&re.direction===l.EventDirection.Receive){var fe,Ee,je=j.driver.readRoomState(x,re.eventType,(fe=re.keyStr)!==null&&fe!==void 0?fe:void 0),Le=je.then(function(Ne){var it=b(Ne),dt;try{for(it.s();!(dt=it.n()).done;){var Nt=dt.value,Ae=j.pushRoomStateResult.get(x);Ae===void 0&&(Ae=new Map,j.pushRoomStateResult.set(x,Ae));var Ge=Ae.get(re.eventType);Ge===void 0&&(Ge=new Map,Ae.set(re.eventType,Ge)),Ge.has(Nt.state_key)||Ge.set(Nt.state_key,Nt)}}catch(Pn){it.e(Pn)}finally{it.f()}},function(Ne){return console.error("Failed to read room state for ".concat(x," (").concat(re.eventType,", ").concat(re.keyStr,")"),Ne)}).then(function(){j.pushRoomStateTasks.delete(Le)});j.pushRoomStateTasks.add(Le),(Ee=j.flushRoomStateTask)!==null&&Ee!==void 0||(j.flushRoomStateTask=j.flushRoomState()),j.flushRoomStateTask.catch(function(Ne){return console.error("Failed to push room state",Ne)})}};for(P.s();!(J=P.n()).done;)Y()}catch(X){P.e(X)}finally{P.f()}}},{key:"feedStateUpdate",value:(function(){var q=N(D().mark(function j(P){var J,Y;return D().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:if(P.state_key!==void 0){re.next=2;break}throw new Error("Not a state event");case 2:if(!((P.room_id===this.viewedRoomId||this.canUseRoomTimeline(P.room_id))&&this.canReceiveStateEvent(P.type,P.state_key))){re.next=21;break}if(this.pushRoomStateTasks.size!==0){re.next=11;break}return re.next=6,this.getWidgetVersions();case 6:if(!re.sent.includes(s.UnstableApiVersion.MSC2762_UPDATE_STATE)){re.next=9;break}return re.next=9,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:[P]});case 9:re.next=21;break;case 11:J=this.pushRoomStateResult.get(P.room_id),J===void 0&&(J=new Map,this.pushRoomStateResult.set(P.room_id,J)),Y=J.get(P.type),Y===void 0&&(Y=new Map,J.set(P.type,Y)),Y.has(P.type)||Y.set(P.state_key,P);case 16:return re.next=18,Promise.all(this.pushRoomStateTasks);case 18:if(this.pushRoomStateTasks.size>0){re.next=16;break}case 19:return re.next=21,this.flushRoomStateTask;case 21:case"end":return re.stop()}},j,this)}));function x(j){return q.apply(this,arguments)}return x})()}]),G})(a.EventEmitter);return Iu.ClientWidgetApi=we,Iu}var Jd={},AT;function kN(){if(AT)return Jd;AT=1,Object.defineProperty(Jd,"__esModule",{value:!0}),Jd.isErrorResponse=e;function a(t){"@babel/helpers - typeof";return a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},a(t)}function e(t){var r=t.error;return a(r)==="object"&&r!==null&&"message"in r&&typeof r.message=="string"}return Jd}var ku={},DT;function AN(){if(DT)return ku;DT=1,Object.defineProperty(ku,"__esModule",{value:!0}),ku.WidgetKind=void 0;var a=(function(e){return e.Room="room",e.Account="account",e.Modal="modal",e})({});return ku.WidgetKind=a,ku}var Au={},MT;function DN(){if(MT)return Au;MT=1,Object.defineProperty(Au,"__esModule",{value:!0}),Au.ModalButtonKind=void 0;var a=(function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e})({});return Au.ModalButtonKind=a,Au}var Qd={},NT;function FR(){if(NT)return Qd;NT=1,Object.defineProperty(Qd,"__esModule",{value:!0}),Qd.isValidUrl=a;function a(e){if(!e)return!1;try{var t=new URL(e);return!(t.protocol!=="http"&&t.protocol!=="https")}catch(r){if(r instanceof TypeError)return!1;throw r}}return Qd}var Xd={},UT;function qR(){if(UT)return Xd;UT=1,Object.defineProperty(Xd,"__esModule",{value:!0}),Xd.assertPresent=a;function a(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}return Xd}var Du={},PT;function VR(){if(PT)return Du;PT=1,Object.defineProperty(Du,"__esModule",{value:!0}),Du.Widget=void 0;var a=Qf(),e=qR();function t(h){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},t(h)}function r(h,v){if(!(h instanceof v))throw new TypeError("Cannot call a class as a function")}function n(h,v){for(var p=0;p<v.length;p++){var m=v[p];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(h,l(m.key),m)}}function s(h,v,p){return v&&n(h.prototype,v),Object.defineProperty(h,"prototype",{writable:!1}),h}function l(h){var v=c(h,"string");return t(v)==="symbol"?v:String(v)}function c(h,v){if(t(h)!=="object"||h===null)return h;var p=h[Symbol.toPrimitive];if(p!==void 0){var m=p.call(h,v);if(t(m)!=="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(h)}var d=(function(){function h(v){if(r(this,h),this.definition=v,!this.definition)throw new Error("Definition is required");(0,e.assertPresent)(v,"id"),(0,e.assertPresent)(v,"creatorUserId"),(0,e.assertPresent)(v,"type"),(0,e.assertPresent)(v,"url")}return s(h,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(p){return(0,a.runTemplate)(this.templateUrl,this.definition,p)}}]),h})();return Du.Widget=d,Du}var Mu={},LT;function MN(){if(LT)return Mu;LT=1,Object.defineProperty(Mu,"__esModule",{value:!0}),Mu.WidgetParser=void 0;var a=VR(),e=FR();function t(m){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},t(m)}function r(m,_){var b=typeof Symbol<"u"&&m[Symbol.iterator]||m["@@iterator"];if(!b){if(Array.isArray(m)||(b=n(m))||_){b&&(m=b);var E=0,M=function(){};return{s:M,n:function(){return E>=m.length?{done:!0}:{done:!1,value:m[E++]}},e:function(D){throw D},f:M}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var O=!0,C=!1,U;return{s:function(){b=b.call(m)},n:function(){var D=b.next();return O=D.done,D},e:function(D){C=!0,U=D},f:function(){try{!O&&b.return!=null&&b.return()}finally{if(C)throw U}}}}function n(m,_){if(m){if(typeof m=="string")return s(m,_);var b=Object.prototype.toString.call(m).slice(8,-1);if(b==="Object"&&m.constructor&&(b=m.constructor.name),b==="Map"||b==="Set")return Array.from(m);if(b==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b))return s(m,_)}}function s(m,_){(_==null||_>m.length)&&(_=m.length);for(var b=0,E=new Array(_);b<_;b++)E[b]=m[b];return E}function l(m,_){if(!(m instanceof _))throw new TypeError("Cannot call a class as a function")}function c(m,_){for(var b=0;b<_.length;b++){var E=_[b];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(m,h(E.key),E)}}function d(m,_,b){return b&&c(m,b),Object.defineProperty(m,"prototype",{writable:!1}),m}function h(m){var _=v(m,"string");return t(_)==="symbol"?_:String(_)}function v(m,_){if(t(m)!=="object"||m===null)return m;var b=m[Symbol.toPrimitive];if(b!==void 0){var E=b.call(m,_);if(t(E)!=="object")return E;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(m)}var p=(function(){function m(){l(this,m)}return d(m,null,[{key:"parseAccountData",value:function(b){if(!b)return[];for(var E=[],M=0,O=Object.keys(b);M<O.length;M++){var C=O[M],U=b[C];if(U&&!(U.type!=="m.widget"&&U.type!=="im.vector.modular.widgets")&&U.sender){var I=U.state_key||U.id;if(I===C){var D={content:U.content,sender:U.sender,type:"m.widget",state_key:C,event_id:"$example",room_id:"!example",origin_server_ts:1},w=m.parseRoomWidget(D);w&&E.push(w)}}}return E}},{key:"parseWidgetsFromRoomState",value:function(b){if(!b)return[];var E=[],M=r(b),O;try{for(M.s();!(O=M.n()).done;){var C=O.value,U=m.parseRoomWidget(C);U&&E.push(U)}}catch(I){M.e(I)}finally{M.f()}return E}},{key:"parseRoomWidget",value:function(b){if(!b||b.type!=="m.widget"&&b.type!=="im.vector.modular.widgets")return null;var E=b.content||{},M={id:b.state_key,creatorUserId:E.creatorUserId||b.sender,name:E.name,type:E.type,url:E.url,waitForIframeLoad:E.waitForIframeLoad,data:E.data};return m.processEstimatedWidget(M)}},{key:"processEstimatedWidget",value:function(b){return!b.id||!b.creatorUserId||!b.type||!(0,e.isValidUrl)(b.url)?null:new a.Widget(b)}}]),m})();return Mu.WidgetParser=p,Mu}var Nu={},xT;function NN(){if(xT)return Nu;xT=1,Object.defineProperty(Nu,"__esModule",{value:!0}),Nu.runTemplate=a,Nu.toString=e;function a(t,r,n){for(var s=Object.assign({},r.data,{matrix_room_id:n.widgetRoomId||"",matrix_user_id:n.currentUserId,matrix_display_name:n.userDisplayName||n.currentUserId,matrix_avatar_url:n.userHttpAvatarUrl||"",matrix_widget_id:r.id,"org.matrix.msc2873.client_id":n.clientId||"","org.matrix.msc2873.client_theme":n.clientTheme||"","org.matrix.msc2873.client_language":n.clientLanguage||"","org.matrix.msc3819.matrix_device_id":n.deviceId||"","org.matrix.msc4039.matrix_base_url":n.baseUrl||""}),l=t,c=0,d=Object.keys(s);c<d.length;c++){var h=d[c],v="$".concat(h).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),p=new RegExp(v,"g");l=l.replace(p,encodeURIComponent(e(s[h])))}return l}function e(t){return t==null?"".concat(t):String(t)}return Nu}var Uu={},BT;function UN(){if(BT)return Uu;BT=1,Object.defineProperty(Uu,"__esModule",{value:!0}),Uu.WidgetDriver=void 0;var a=Qf();function e(d){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},e(d)}function t(d,h){if(!(d instanceof h))throw new TypeError("Cannot call a class as a function")}function r(d,h){for(var v=0;v<h.length;v++){var p=h[v];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(d,s(p.key),p)}}function n(d,h,v){return h&&r(d.prototype,h),Object.defineProperty(d,"prototype",{writable:!1}),d}function s(d){var h=l(d,"string");return e(h)==="symbol"?h:String(h)}function l(d,h){if(e(d)!=="object"||d===null)return d;var v=d[Symbol.toPrimitive];if(v!==void 0){var p=v.call(d,h);if(e(p)!=="object")return p;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(d)}var c=(function(){function d(){t(this,d)}return n(d,[{key:"validateCapabilities",value:function(v){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(v,p){return Promise.reject(new Error("Failed to override function"))}},{key:"sendStickyEvent",value:function(v,p,m){throw new Error("Method not implemented.")}},{key:"sendDelayedEvent",value:function(v,p,m,_){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedStickyEvent",value:function(v,p,m,_,b){throw new Error("Method not implemented.")}},{key:"cancelScheduledDelayedEvent",value:function(v){return Promise.reject(new Error("Failed to override function"))}},{key:"restartScheduledDelayedEvent",value:function(v){return Promise.reject(new Error("Failed to override function"))}},{key:"sendScheduledDelayedEvent",value:function(v){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(v,p,m){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(v){return Promise.resolve([])}},{key:"readRoomEvents",value:function(v,p,m){return Promise.resolve([])}},{key:"readStateEvents",value:function(v,p,m){return Promise.resolve([])}},{key:"readStickyEvents",value:function(v){throw new Error("readStickyEvents is not implemented")}},{key:"readRoomTimeline",value:function(v,p,m,_,b,E){return _===void 0?this.readRoomEvents(p,m,b,[v],E):this.readStateEvents(p,_,b,[v])}},{key:"readRoomState",value:function(v,p,m){return this.readStateEvents(p,m,Number.MAX_SAFE_INTEGER,[v])}},{key:"readEventRelations",value:function(v,p,m,_,b,E,M,O){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(v){v.update({state:a.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(v){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(v,p){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(v){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(v){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(v){}}]),d})();return Uu.WidgetDriver=c,Uu}var KT;function Qf(){return KT||(KT=1,(function(a){Object.defineProperty(a,"__esModule",{value:!0});var e=IN();Object.keys(e).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===e[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return e[A]}})});var t=ON();Object.keys(t).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===t[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return t[A]}})});var r=Lm();Object.keys(r).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===r[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return r[A]}})});var n=Mm();Object.keys(n).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===n[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return n[A]}})});var s=xR();Object.keys(s).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===s[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return s[A]}})});var l=kN();Object.keys(l).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===l[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return l[A]}})});var c=Nm();Object.keys(c).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===c[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return c[A]}})});var d=Am();Object.keys(d).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===d[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return d[A]}})});var h=Dm();Object.keys(h).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===h[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return h[A]}})});var v=KR();Object.keys(v).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===v[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return v[A]}})});var p=Um();Object.keys(p).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===p[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return p[A]}})});var m=AN();Object.keys(m).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===m[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return m[A]}})});var _=DN();Object.keys(_).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===_[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return _[A]}})});var b=BR();Object.keys(b).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===b[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return b[A]}})});var E=xm();Object.keys(E).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===E[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return E[A]}})});var M=Pm();Object.keys(M).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===M[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return M[A]}})});var O=FR();Object.keys(O).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===O[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return O[A]}})});var C=qR();Object.keys(C).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===C[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return C[A]}})});var U=VR();Object.keys(U).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===U[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return U[A]}})});var I=MN();Object.keys(I).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===I[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return I[A]}})});var D=NN();Object.keys(D).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===D[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return D[A]}})});var w=jR();Object.keys(w).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===w[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return w[A]}})});var N=UN();Object.keys(N).forEach(function(A){A==="default"||A==="__esModule"||A in a&&a[A]===N[A]||Object.defineProperty(a,A,{enumerable:!0,get:function(){return N[A]}})})})(Gg)),Gg}var Aa=Qf();function jT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function $d(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):jT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}function PN(a){var e,t,r,n=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,r=Symbol.iterator);n--;){if(t&&(e=a[t])!=null)return e.call(a);if(r&&(e=a[r])!=null)return new hf(e.call(a));t="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function hf(a){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var r=t.done;return Promise.resolve(t.value).then(function(n){return{value:n,done:r}})}return hf=function(r){this.s=r,this.n=r.next},hf.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(r){var n=this.s.return;return n===void 0?Promise.resolve({value:r,done:!0}):e(n.apply(this.s,arguments))},throw:function(r){var n=this.s.return;return n===void 0?Promise.reject(r):e(n.apply(this.s,arguments))}},new hf(a)}var vf=(function(a){return a.PendingEventsChanged="PendingEvent.pendingEventsChanged",a})({});class GR extends ll{constructor(e,t,r,n,s){var l,c,d,h,v,p,m,_,b,E,M,O,C;super(n),l=this,this.widgetApi=e,this.capabilities=t,this.roomId=r,y(this,"room",void 0),y(this,"widgetApiReady",void 0),y(this,"lifecycle",void 0),y(this,"syncState",null),y(this,"pendingSendingEventsTxId",[]),y(this,"eventEmitter",new Pt),y(this,"updateTxId",(function(){var D=R(function*(w){if(w.getSender()===l.getUserId()&&l.pendingSendingEventsTxId.some(z=>w.getType()===z.type)){for(var N,A=(N=l.pendingSendingEventsTxId.find(z=>z.id===w.getId()))===null||N===void 0?void 0:N.txId;!A&&l.pendingSendingEventsTxId.length>0;){var K;yield new Promise(z=>l.eventEmitter.once(vf.PendingEventsChanged,()=>z())),A=(K=l.pendingSendingEventsTxId.find(z=>z.id===w.getId()))===null||K===void 0?void 0:K.txId}A&&(w.setTxnId(A),w.setUnsigned($d($d({},w.getUnsigned()),{},{transaction_id:A}))),l.pendingSendingEventsTxId=l.pendingSendingEventsTxId.filter(z=>z.id!==w.getId()),l.pendingSendingEventsTxId.length===0&&l.eventEmitter.emit(vf.PendingEventsChanged)}});return function(w){return D.apply(this,arguments)}})()),y(this,"onEvent",(function(){var D=R(function*(w){if(w.preventDefault(),w.detail.data.room_id===l.roomId){var N=new _r(w.detail.data);yield l.updateTxId(N),yield l.syncApi.injectRoomEvents(l.room,[],[N]),l.emit(Pe.Event,N),l.setSyncState(bt.Syncing),T.info("Received event ".concat(N.getId()," ").concat(N.getType()," ").concat(N.getStateKey()))}else{var{event_id:A,room_id:K}=w.detail.data;T.info("Received event ".concat(A," for a different room ").concat(K,"; discarding"))}yield l.ack(w)});return function(w){return D.apply(this,arguments)}})()),y(this,"onToDevice",(function(){var D=R(function*(w){w.preventDefault();var N=new _r({type:w.detail.data.type,sender:w.detail.data.sender,content:w.detail.data.content});w.detail.data.encrypted&&N.makeEncrypted($.RoomMessageEncrypted,{},"",""),l.emit(Pe.ToDeviceEvent,N),l.setSyncState(bt.Syncing),yield l.ack(w)});return function(w){return D.apply(this,arguments)}})());var U=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=(function(){var D=R(function*(w,N){try{return yield U(w,N)}catch(A){FT(A)}});return function(w,N){return D.apply(this,arguments)}})();var I=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=(function(){var D=R(function*(w,N){try{return yield I(w,N)}catch(A){FT(A)}});return function(w,N){return D.apply(this,arguments)}})(),this.widgetApiReady=new Promise(D=>this.widgetApi.once("ready",D)),((c=t.sendEvent)!==null&&c!==void 0&&c.length||(d=t.receiveEvent)!==null&&d!==void 0&&d.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(h=t.sendState)!==null&&h!==void 0&&h.length||(v=t.receiveState)!==null&&v!==void 0&&v.length)&&e.requestCapabilityForRoomTimeline(r),(p=t.sendEvent)===null||p===void 0||p.forEach(D=>e.requestCapabilityToSendEvent(D)),(m=t.receiveEvent)===null||m===void 0||m.forEach(D=>e.requestCapabilityToReceiveEvent(D)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(D=>e.requestCapabilityToSendMessage(D)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(D=>e.requestCapabilityToReceiveMessage(D)),(_=t.sendState)===null||_===void 0||_.forEach(D=>{var{eventType:w,stateKey:N}=D;return e.requestCapabilityToSendState(w,N)}),(b=t.receiveState)===null||b===void 0||b.forEach(D=>{var{eventType:w,stateKey:N}=D;return e.requestCapabilityToReceiveState(w,N)}),(E=t.sendToDevice)===null||E===void 0||E.forEach(D=>e.requestCapabilityToSendToDevice(D)),(M=t.receiveToDevice)===null||M===void 0||M.forEach(D=>e.requestCapabilityToReceiveToDevice(D)),t.sendDelayedEvents&&((O=t.sendEvent)!==null&&O!==void 0&&O.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||(C=t.sendState)!==null&&C!==void 0&&C.length)&&e.requestCapability(Aa.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(Aa.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(Aa.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(Aa.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(Aa.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.start(),s&&e.sendContentLoaded()}startClient(){var e=arguments,t=this;return R(function*(){var r,n,s=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var l=t.getUserId();l&&t.store.storeUser(new Wi(l)),s.slidingSync?t.syncApi=new IR(s.slidingSync,t,s,t.buildSyncApiOptions()):t.syncApi=new Bu(t,s,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield Promise.all((r=(n=t.capabilities.receiveState)===null||n===void 0?void 0:n.map((function(){var c=R(function*(d){var{eventType:h,stateKey:v}=d,p=yield t.widgetApi.readStateEvents(h,void 0,v,[t.roomId]),m=p.map(_=>new _r(_));yield t.syncApi.injectRoomEvents(t.room,[],m),m.forEach(_=>{t.emit(Pe.Event,_),T.info("Backfilled event ".concat(_.getId()," ").concat(_.getType()," ").concat(_.getStateKey()))})});return function(d){return c.apply(this,arguments)}})()))!==null&&r!==void 0?r:[]),s.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*s.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(bt.Syncing),T.info("Finished backfilling events"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(Aa.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(Aa.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return R(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,r){var n=this;return R(function*(){var s=t.event.redacts?$d($d({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(r){var l=yield n.widgetApi.sendRoomEvent(t.getType(),s,e.roomId,"delay"in r?r.delay:void 0,"parent_delay_id"in r?r.parent_delay_id:void 0);return n.validateSendDelayedEventResponse(l)}var c=t.getTxnId();c&&n.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:c});var d;try{d=yield n.widgetApi.sendRoomEvent(t.getType(),s,e.roomId)}catch(h){throw n.updatePendingEventStatus(e,t,Ve.NOT_SENT),h}return e.updatePendingEvent(t,Ve.SENT,d.event_id),n.pendingSendingEventsTxId.forEach(h=>{h.txId===c&&(h.id=d.event_id)}),n.eventEmitter.emit(vf.PendingEventsChanged),{event_id:d.event_id}})()}sendStateEvent(e,t,r){var n=arguments,s=this;return R(function*(){var l=n.length>3&&n[3]!==void 0?n[3]:"",c=yield s.widgetApi.sendStateEvent(t,l,r,e);if(c.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:c.event_id}})()}_unstable_sendDelayedStateEvent(e,t,r,n){var s=arguments,l=this;return R(function*(){var c=s.length>4&&s[4]!==void 0?s[4]:"";if(!(yield l.doesServerSupportUnstableFeature(di)))throw Error("Server does not support the delayed events API");var d=yield l.widgetApi.sendStateEvent(r,c,n,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0);return l.validateSendDelayedEventResponse(d)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var r=this;return R(function*(){if(!(yield r.doesServerSupportUnstableFeature(di)))throw Error("Server does not support the delayed events API");return yield r.widgetApi.updateDelayedEvent(e,t)})()}sendToDevice(e,t){var r=this;return R(function*(){return yield r.widgetApi.sendToDevice(e,!1,Ua(t)),{}})()}getOpenIdToken(){var e=this;return R(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken();return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return R(function*(){var{eventType:r,batch:n}=e,s=new Xt(()=>new Map);for(var{userId:l,deviceId:c,payload:d}of n)s.getOrCreate(l).set(c,d);yield t.widgetApi.sendToDevice(r,!1,Ua(s))})()}encryptAndSendToDevices(e,t){var r=this;return R(function*(){var n=new Xt(()=>new Map);for(var{userId:s,deviceInfo:{deviceId:l}}of e)n.getOrCreate(s).set(l,t);yield r.widgetApi.sendToDevice(t.type,!0,Ua(n))})()}sendToDeviceViaWidgetApi(e,t,r){var n=this;return R(function*(){yield n.widgetApi.sendToDevice(e,t,Ua(r))})()}checkTurnServers(){var e=this;return R(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(Pe.Sync,e,t)}ack(e){var t=this;return R(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return R(function*(){var t=e.widgetApi.getTurnServers(),r=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",r);try{var n=!1,s=!1,l;try{for(var c=PN(t),d;n=!(d=yield c.next()).done;n=!1){var h=d.value;e.turnServers=[{urls:h.uris,username:h.username,credential:h.password}],e.emit(Pe.TurnServers,e.turnServers),T.log("Received TURN server: ".concat(h.uris))}}catch(v){s=!0,l=v}finally{try{n&&c.return!=null&&(yield c.return())}finally{if(s)throw l}}}catch(v){T.warn("Error watching TURN servers",v)}finally{e.lifecycle.signal.removeEventListener("abort",r)}})()}}function FT(a){throw a instanceof Aa.WidgetApiResponseError&&a.data.matrix_api_error?hr.fromWidgetApiErrorData(a.data.matrix_api_error):a}class LN{constructor(){y(this,"unthreadedReadReceipts",new Map),y(this,"threadedReadReceipts",new Xt(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e==null||e.forEach(t=>{t.type!==$.Receipt||!t.content||Object.keys(t.content).forEach(r=>{Object.entries(t.content[r]).forEach(n=>{var[s,l]=n;if(sm(s))for(var c of Object.keys(l)){var d=t.content[r][s][c],h={data:t.content[r][s][c],type:s,eventId:r};d.thread_id?this.setThreaded(d.thread_id,c,h):this.setUnthreaded(c,h)}})})})}buildAccumulatedReceiptEvent(e){var t={type:$.Receipt,room_id:e,content:{}},r=new Xt(()=>new Xt(()=>new Map));for(var[n,s]of this.allUnthreaded())r.getOrCreate(s.eventId).getOrCreate(s.type).set(n,s.data);for(var[l,c]of this.allThreaded())r.getOrCreate(c.eventId).getOrCreate(c.type).set(l,c.data);return t.content=Ua(r),r.size>0?t:null}}var Ki=(function(a){return a.Invite="invite",a.Leave="leave",a.Join="join",a.Knock="knock",a})({});function xN(a){return"_localTs"in a&&a._localTs!==void 0}class HR{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,y(this,"accountData",{}),y(this,"inviteRooms",{}),y(this,"knockRooms",{}),y(this,"joinRooms",{}),y(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(r=>{this.accumulateRoom(r,Ki.Invite,e.rooms.invite[r],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(r=>{this.accumulateRoom(r,Ki.Join,e.rooms.join[r],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(r=>{this.accumulateRoom(r,Ki.Leave,e.rooms.leave[r],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(r=>{this.accumulateRoom(r,Ki.Knock,e.rooms.knock[r],t)}))}accumulateRoom(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case Ki.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case Ki.Knock:this.accumulateKnockState(e,r);break;case Ki.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case Ki.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:T.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var r=this.inviteRooms[e];t.invite_state.events.forEach(n=>{for(var s=!1,l=0;l<r.invite_state.events.length;l++){var c=r.invite_state.events[l];c.type===n.type&&c.state_key==n.state_key&&(r.invite_state.events[l]=n,s=!0)}s||r.invite_state.events.push(n)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var r=this.knockRooms[e];t.knock_state.events.forEach(n=>{for(var s=!1,l=0;l<r.knock_state.events.length;l++){var c=r.knock_state.events[l];c.type===n.type&&c.state_key==n.state_key&&(r.knock_state.events[l]=n,s=!0)}s||r.knock_state.events.push(n)})}}accumulateJoinState(e,t){var r,n,s,l,c,d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new LN});var h=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(I=>{h._accountData[I.type]=I}),t.unread_notifications&&(h._unreadNotifications=t.unread_notifications),h._unreadThreadNotifications=(r=(n=t[nc.stable])!==null&&n!==void 0?n:t[nc.unstable])!==null&&r!==void 0?r:void 0,t.summary){var v,p,m,_="m.heroes",b="m.invited_member_count",E="m.joined_member_count",M=h._summary,O=t.summary;M[_]=(v=O[_])!==null&&v!==void 0?v:M[_],M[E]=(p=O[E])!==null&&p!==void 0?p:M[E],M[b]=(m=O[b])!==null&&m!==void 0?m:M[b]}if(h._receipts.consumeEphemeralEvents((s=t.ephemeral)===null||s===void 0?void 0:s.events),t.timeline&&t.timeline.limited&&(h._timeline=[]),(l=t.state)===null||l===void 0||(l=l.events)===null||l===void 0||l.forEach(I=>{Hg(h._currentState,I)}),(c=t.timeline)===null||c===void 0||(c=c.events)===null||c===void 0||c.forEach((I,D)=>{var w;Hg(h._currentState,I);var N;if(d)N=I;else{var A;N=Object.assign({},I),N.unsigned!==void 0&&(N.unsigned=Object.assign({},N.unsigned));var K=(A=I.unsigned)===null||A===void 0?void 0:A.age;K!==void 0&&(N._localTs=Date.now()-K)}h._timeline.push({event:N,token:D===0&&(w=t.timeline.prev_batch)!==null&&w!==void 0?w:null})}),h._timeline.length>this.opts.maxTimelineEntries){for(var C=h._timeline.length-this.opts.maxTimelineEntries,U=C;U<h._timeline.length;U++)if(h._timeline[U].token){h._timeline=h._timeline.slice(U,h._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(n=>{t.invite[n]=this.inviteRooms[n]}),Object.keys(this.knockRooms).forEach(n=>{t.knock[n]=this.knockRooms[n]}),Object.keys(this.joinRooms).forEach(n=>{var s=this.joinRooms[n],l={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:s._unreadNotifications,unread_thread_notifications:s._unreadThreadNotifications,summary:s._summary};Object.keys(s._accountData).forEach(m=>{l.account_data.events.push(s._accountData[m])});var c=s._receipts.buildAccumulatedReceiptEvent(n);c&&l.ephemeral.events.push(c),s._timeline.forEach(m=>{if(!l.timeline.prev_batch){if(!m.token)return;l.timeline.prev_batch=m.token}var _;!e&&xN(m.event)?(_=Object.assign({},m.event),_.unsigned!==void 0&&(_.unsigned=Object.assign({},_.unsigned)),delete _._localTs,_.unsigned=_.unsigned||{},_.unsigned.age=Date.now()-m.event._localTs):_=m.event,l.timeline.events.push(_)});for(var d=Object.create(null),h=l.timeline.events.length-1;h>=0;h--){var v=l.timeline.events[h];if(!(v.state_key===null||v.state_key===void 0)){var p=xf(v);p.unsigned&&(p.unsigned.prev_content&&(p.content=p.unsigned.prev_content),p.unsigned.prev_sender&&(p.sender=p.unsigned.prev_sender)),Hg(d,p)}}Object.keys(s._currentState).forEach(m=>{Object.keys(s._currentState[m]).forEach(_=>{var b=s._currentState[m][_];d[m]&&d[m][_]&&(b=d[m][_]),l.state.events.push(b)})}),t.join[n]=l});var r=[];return Object.keys(this.accountData).forEach(n=>{r.push(this.accountData[n])}),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function Hg(a,e){e.state_key===null||e.state_key===void 0||!e.type||(a[e.type]||(a[e.type]=Object.create(null)),a[e.type][e.state_key]=e)}class Fu extends Error{}Fu.prototype.name="InvalidTokenError";function BN(a){return decodeURIComponent(atob(a).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function KN(a){let e=a.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return BN(e)}catch{return atob(e)}}function zR(a,e){if(typeof a!="string")throw new Fu("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,r=a.split(".")[t];if(typeof r!="string")throw new Fu(`Invalid token specified: missing part #${t+1}`);let n;try{n=KN(r)}catch(s){throw new Fu(`Invalid token specified: invalid base64 for part #${t+1} (${s.message})`)}try{return JSON.parse(n)}catch(s){throw new Fu(`Invalid token specified: invalid json for part #${t+1} (${s.message})`)}}var jN={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},li,ui,cc=(a=>(a[a.NONE=0]="NONE",a[a.ERROR=1]="ERROR",a[a.WARN=2]="WARN",a[a.INFO=3]="INFO",a[a.DEBUG=4]="DEBUG",a))(cc||{});(a=>{function e(){li=3,ui=jN}a.reset=e;function t(n){if(!(0<=n&&n<=4))throw new Error("Invalid log level");li=n}a.setLevel=t;function r(n){ui=n}a.setLogger=r})(cc||(cc={}));var rr=class si{constructor(e){this._name=e}debug(...e){li>=4&&ui.debug(si._format(this._name,this._method),...e)}info(...e){li>=3&&ui.info(si._format(this._name,this._method),...e)}warn(...e){li>=2&&ui.warn(si._format(this._name,this._method),...e)}error(...e){li>=1&&ui.error(si._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const r=new si(`${e}.${t}`);return r.debug("begin"),r}static _format(e,t){const r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(e,...t){li>=4&&ui.debug(si._format(e),...t)}static info(e,...t){li>=3&&ui.info(si._format(e),...t)}static warn(e,...t){li>=2&&ui.warn(si._format(e),...t)}static error(e,...t){li>=1&&ui.error(si._format(e),...t)}};cc.reset();var dc=class{static decode(a){try{return zR(a)}catch(e){throw rr.error("JwtUtils.decode",e),e}}static async generateSignedJwt(a,e,t){const r=kr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(a))),n=kr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),s=`${r}.${n}`,l=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new TextEncoder().encode(s)),c=kr.encodeBase64Url(new Uint8Array(l));return`${s}.${c}`}static async generateSignedJwtWithHmac(a,e,t){const r=kr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(a))),n=kr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),s=`${r}.${n}`,l=await window.crypto.subtle.sign("HMAC",t,new TextEncoder().encode(s)),c=kr.encodeBase64Url(new Uint8Array(l));return`${s}.${c}`}},FN="10000000-1000-4000-8000-100000000000",zp=a=>btoa([...new Uint8Array(a)].map(e=>String.fromCharCode(e)).join("")),WR=class qn{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return FN.replace(/[018]/g,t=>(+t^qn._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return qn.generateUUIDv4()+qn.generateUUIDv4()+qn.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const r=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",r);return zp(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw rr.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const n=new TextEncoder().encode([e,t].join(":"));return zp(n)}static async hash(e,t){const r=new TextEncoder().encode(t),n=await crypto.subtle.digest(e,r);return new Uint8Array(n)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const r=await qn.hash("SHA-256",JSON.stringify(t));return qn.encodeBase64Url(r)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:r,keyPair:n,nonce:s}){let l,c;const d={jti:window.crypto.randomUUID(),htm:r??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(l=await qn.hash("SHA-256",t),c=qn.encodeBase64Url(l),d.ath=c),s&&(d.nonce=s);try{const h=await crypto.subtle.exportKey("jwk",n.publicKey),v={alg:"ES256",typ:"dpop+jwt",jwk:{crv:h.crv,kty:h.kty,x:h.x,y:h.y}};return await dc.generateSignedJwt(v,d,n.privateKey)}catch(h){throw h instanceof TypeError?new Error(`Error exporting dpop public key: ${h.message}`):h}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await qn.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}static async generateClientAssertionJwt(e,t,r,n="HS256"){const s=Math.floor(Date.now()/1e3),l={alg:n,typ:"JWT"},c={iss:e,sub:e,aud:r,jti:qn.generateUUIDv4(),exp:s+300,iat:s},h={HS256:"SHA-256",HS384:"SHA-384",HS512:"SHA-512"}[n];if(!h)throw new Error(`Unsupported algorithm: ${n}. Supported algorithms are: HS256, HS384, HS512`);const v=new TextEncoder,p=await crypto.subtle.importKey("raw",v.encode(t),{name:"HMAC",hash:h},!1,["sign"]);return await dc.generateSignedJwtWithHmac(l,c,p)}};WR.encodeBase64Url=a=>zp(a).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var kr=WR,qN=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new rr(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},Mf=class gf extends qN{constructor(){super(...arguments),this._logger=new rr(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-gf.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=gf.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const r=gf.getEpochTime()+e;if(this.expiration===r&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=r;const n=Math.min(e,5);this._timerHandle=setInterval(this._callback,n*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},qT=class{static readParams(a,e="query"){if(!a)throw new TypeError("Invalid URL");const r=new URL(a,"http://127.0.0.1")[e==="fragment"?"hash":"search"];return new URLSearchParams(r.slice(1))}},tl=";",fc=class extends Error{constructor(a,e){var t,r,n;if(super(a.error_description||a.error||""),this.form=e,this.name="ErrorResponse",!a.error)throw rr.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=a.error,this.error_description=(t=a.error_description)!=null?t:null,this.error_uri=(r=a.error_uri)!=null?r:null,this.state=a.userState,this.session_state=(n=a.session_state)!=null?n:null,this.url_state=a.url_state}},VN=class extends Error{constructor(a){super(a),this.name="ErrorTimeout"}},GN=class{constructor(){this._logger=new rr("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(a){return this._logger.create(`getItem('${a}')`),this._data[a]}setItem(a,e){this._logger.create(`setItem('${a}')`),this._data[a]=e}removeItem(a){this._logger.create(`removeItem('${a}')`),delete this._data[a]}get length(){return Object.getOwnPropertyNames(this._data).length}key(a){return Object.getOwnPropertyNames(this._data)[a]}},Wp=class extends Error{constructor(a,e){super(e),this.name="ErrorDPoPNonce",this.nonce=a}},Bm=class{constructor(a=[],e=null,t={}){this._jwtHandler=e,this._extraHeaders=t,this._logger=new rr("JsonService"),this._contentTypes=[],this._contentTypes.push(...a,"application/json"),e&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(a,e={}){const{timeoutInSeconds:t,...r}=e;if(!t)return await fetch(a,r);const n=new AbortController,s=setTimeout(()=>n.abort(),t*1e3);try{return await fetch(a,{...e,signal:n.signal})}catch(l){throw l instanceof DOMException&&l.name==="AbortError"?new VN("Network timed out"):l}finally{clearTimeout(s)}}async getJson(a,{token:e,credentials:t,timeoutInSeconds:r}={}){const n=this._logger.create("getJson"),s={Accept:this._contentTypes.join(", ")};e&&(n.debug("token passed, setting Authorization header"),s.Authorization="Bearer "+e),this._appendExtraHeaders(s);let l;try{n.debug("url:",a),l=await this.fetchWithTimeout(a,{method:"GET",headers:s,timeoutInSeconds:r,credentials:t})}catch(h){throw n.error("Network Error"),h}n.debug("HTTP response received, status",l.status);const c=l.headers.get("Content-Type");if(c&&!this._contentTypes.find(h=>c.startsWith(h))&&n.throw(new Error(`Invalid response Content-Type: ${c??"undefined"}, from URL: ${a}`)),l.ok&&this._jwtHandler&&(c!=null&&c.startsWith("application/jwt")))return await this._jwtHandler(await l.text());let d;try{d=await l.json()}catch(h){throw n.error("Error parsing JSON response",h),l.ok?h:new Error(`${l.statusText} (${l.status})`)}if(!l.ok)throw n.error("Error from server:",d),d.error?new fc(d):new Error(`${l.statusText} (${l.status}): ${JSON.stringify(d)}`);return d}async postForm(a,{body:e,basicAuth:t,timeoutInSeconds:r,initCredentials:n,extraHeaders:s}){const l=this._logger.create("postForm"),c={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...s};t!==void 0&&(c.Authorization="Basic "+t),this._appendExtraHeaders(c);let d;try{l.debug("url:",a),d=await this.fetchWithTimeout(a,{method:"POST",headers:c,body:e,timeoutInSeconds:r,credentials:n})}catch(m){throw l.error("Network error"),m}l.debug("HTTP response received, status",d.status);const h=d.headers.get("Content-Type");if(h&&!this._contentTypes.find(m=>h.startsWith(m)))throw new Error(`Invalid response Content-Type: ${h??"undefined"}, from URL: ${a}`);const v=await d.text();let p={};if(v)try{p=JSON.parse(v)}catch(m){throw l.error("Error parsing JSON response",m),d.ok?m:new Error(`${d.statusText} (${d.status})`)}if(!d.ok){if(l.error("Error from server:",p),d.headers.has("dpop-nonce")){const m=d.headers.get("dpop-nonce");throw new Wp(m,`${JSON.stringify(p)}`)}throw p.error?new fc(p,e):new Error(`${d.statusText} (${d.status}): ${JSON.stringify(p)}`)}return p}_appendExtraHeaders(a){const e=this._logger.create("appendExtraHeaders"),t=Object.keys(this._extraHeaders),r=["accept","content-type"],n=["authorization"];t.length!==0&&t.forEach(s=>{if(r.includes(s.toLocaleLowerCase())){e.warn("Protected header could not be set",s,r);return}if(n.includes(s.toLocaleLowerCase())&&Object.keys(a).includes(s)){e.warn("Header could not be overridden",s,n);return}const l=typeof this._extraHeaders[s]=="function"?this._extraHeaders[s]():this._extraHeaders[s];l&&l!==""&&(a[s]=l)})}},YR=class{constructor(a){this._settings=a,this._logger=new rr("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new Bm(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const a=this._logger.create("getMetadata");if(this._metadata)return a.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw a.throw(new Error("No authority or metadataUrl configured on settings")),null;a.debug("getting metadata from",this._metadataUrl);const e=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return a.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},e,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(a=!0){return this._getMetadataProperty("token_endpoint",a)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(a=!0){return this._getMetadataProperty("revocation_endpoint",a)}getKeysEndpoint(a=!0){return this._getMetadataProperty("jwks_uri",a)}async _getMetadataProperty(a,e=!1){const t=this._logger.create(`_getMetadataProperty('${a}')`),r=await this.getMetadata();if(t.debug("resolved"),r[a]===void 0){if(e===!0){t.warn("Metadata does not contain optional property");return}t.throw(new Error("Metadata does not contain property "+a))}return r[a]}async getSigningKeys(){const a=this._logger.create("getSigningKeys");if(this._signingKeys)return a.debug("returning signingKeys from cache"),this._signingKeys;const e=await this.getKeysEndpoint(!1);a.debug("got jwks_uri",e);const t=await this._jsonService.getJson(e,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(a.debug("got key set",t),!Array.isArray(t.keys))throw a.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=t.keys,this._signingKeys}},Xf=class{constructor({prefix:a="oidc.",store:e=localStorage}={}){this._logger=new rr("WebStorageStateStore"),this._store=e,this._prefix=a}async set(a,e){this._logger.create(`set('${a}')`),a=this._prefix+a,await this._store.setItem(a,e)}async get(a){return this._logger.create(`get('${a}')`),a=this._prefix+a,await this._store.getItem(a)}async remove(a){this._logger.create(`remove('${a}')`),a=this._prefix+a;const e=await this._store.getItem(a);return await this._store.removeItem(a),e}async getAllKeys(){this._logger.create("getAllKeys");const a=await this._store.length,e=[];for(let t=0;t<a;t++){const r=await this._store.key(t);r&&r.indexOf(this._prefix)===0&&e.push(r.substr(this._prefix.length))}return e}},HN="code",zN="openid",WN="client_secret_post",YN=900,Yp=class{constructor({authority:a,metadataUrl:e,metadata:t,signingKeys:r,metadataSeed:n,client_id:s,client_secret:l,response_type:c=HN,scope:d=zN,redirect_uri:h,post_logout_redirect_uri:v,client_authentication:p=WN,token_endpoint_auth_signing_alg:m="HS256",prompt:_,display:b,max_age:E,ui_locales:M,acr_values:O,resource:C,response_mode:U,filterProtocolClaims:I=!0,loadUserInfo:D=!1,requestTimeoutInSeconds:w,staleStateAgeInSeconds:N=YN,mergeClaimsStrategy:A={array:"replace"},disablePKCE:K=!1,stateStore:z,revokeTokenAdditionalContentTypes:de,fetchRequestCredentials:_e,refreshTokenAllowedScope:le,extraQueryParams:Ce={},extraTokenParams:V={},extraHeaders:B={},dpop:te,omitScopeWhenRequesting:he=!1}){var be;if(this.authority=a,e?this.metadataUrl=e:(this.metadataUrl=a,a&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=t,this.metadataSeed=n,this.signingKeys=r,this.client_id=s,this.client_secret=l,this.response_type=c,this.scope=d,this.redirect_uri=h,this.post_logout_redirect_uri=v,this.client_authentication=p,this.token_endpoint_auth_signing_alg=m,this.prompt=_,this.display=b,this.max_age=E,this.ui_locales=M,this.acr_values=O,this.resource=C,this.response_mode=U,this.filterProtocolClaims=I??!0,this.loadUserInfo=!!D,this.staleStateAgeInSeconds=N,this.mergeClaimsStrategy=A,this.omitScopeWhenRequesting=he,this.disablePKCE=!!K,this.revokeTokenAdditionalContentTypes=de,this.fetchRequestCredentials=_e||"same-origin",this.requestTimeoutInSeconds=w,z)this.stateStore=z;else{const De=typeof window<"u"?window.localStorage:new GN;this.stateStore=new Xf({store:De})}if(this.refreshTokenAllowedScope=le,this.extraQueryParams=Ce,this.extraTokenParams=V,this.extraHeaders=B,this.dpop=te,this.dpop&&!((be=this.dpop)!=null&&be.store))throw new Error("A DPoPStore is required when dpop is enabled")}},JN=class{constructor(a,e){this._settings=a,this._metadataService=e,this._logger=new rr("UserInfoService"),this._getClaimsFromJwt=async t=>{const r=this._logger.create("_getClaimsFromJwt");try{const n=dc.decode(t);return r.debug("JWT decoding successful"),n}catch(n){throw r.error("Error parsing JWT response"),n}},this._jsonService=new Bm(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(a){const e=this._logger.create("getClaims");a||this._logger.throw(new Error("No token passed"));const t=await this._metadataService.getUserInfoEndpoint();e.debug("got userinfo url",t);const r=await this._jsonService.getJson(t,{token:a,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("got claims",r),r}},JR=class{constructor(a,e){this._settings=a,this._metadataService=e,this._logger=new rr("TokenClient"),this._jsonService=new Bm(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:a="authorization_code",redirect_uri:e=this._settings.redirect_uri,client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,extraHeaders:n,...s}){const l=this._logger.create("exchangeCode");t||l.throw(new Error("A client_id is required")),e||l.throw(new Error("A redirect_uri is required")),s.code||l.throw(new Error("A code is required"));const c=new URLSearchParams({grant_type:a,redirect_uri:e});for(const[p,m]of Object.entries(s))m!=null&&c.set(p,m);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&r==null)throw l.throw(new Error("A client_secret is required")),null;let d;const h=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":d=kr.generateBasicAuth(t,r);break;case"client_secret_post":c.append("client_id",t),r&&c.append("client_secret",r);break;case"client_secret_jwt":{const p=await kr.generateClientAssertionJwt(t,r,h,this._settings.token_endpoint_auth_signing_alg);c.append("client_id",t),c.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),c.append("client_assertion",p);break}}l.debug("got token endpoint");const v=await this._jsonService.postForm(h,{body:c,basicAuth:d,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return l.debug("got response"),v}async exchangeCredentials({grant_type:a="password",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,scope:r=this._settings.scope,...n}){const s=this._logger.create("exchangeCredentials");e||s.throw(new Error("A client_id is required"));const l=new URLSearchParams({grant_type:a});this._settings.omitScopeWhenRequesting||l.set("scope",r);for(const[v,p]of Object.entries(n))p!=null&&l.set(v,p);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&t==null)throw s.throw(new Error("A client_secret is required")),null;let c;const d=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":c=kr.generateBasicAuth(e,t);break;case"client_secret_post":l.append("client_id",e),t&&l.append("client_secret",t);break;case"client_secret_jwt":{const v=await kr.generateClientAssertionJwt(e,t,d,this._settings.token_endpoint_auth_signing_alg);l.append("client_id",e),l.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),l.append("client_assertion",v);break}}s.debug("got token endpoint");const h=await this._jsonService.postForm(d,{body:l,basicAuth:c,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return s.debug("got response"),h}async exchangeRefreshToken({grant_type:a="refresh_token",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,timeoutInSeconds:r,extraHeaders:n,...s}){const l=this._logger.create("exchangeRefreshToken");e||l.throw(new Error("A client_id is required")),s.refresh_token||l.throw(new Error("A refresh_token is required"));const c=new URLSearchParams({grant_type:a});for(const[p,m]of Object.entries(s))Array.isArray(m)?m.forEach(_=>c.append(p,_)):m!=null&&c.set(p,m);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&t==null)throw l.throw(new Error("A client_secret is required")),null;let d;const h=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":d=kr.generateBasicAuth(e,t);break;case"client_secret_post":c.append("client_id",e),t&&c.append("client_secret",t);break;case"client_secret_jwt":{const p=await kr.generateClientAssertionJwt(e,t,h,this._settings.token_endpoint_auth_signing_alg);c.append("client_id",e),c.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),c.append("client_assertion",p);break}}l.debug("got token endpoint");const v=await this._jsonService.postForm(h,{body:c,basicAuth:d,timeoutInSeconds:r,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return l.debug("got response"),v}async revoke(a){var e;const t=this._logger.create("revoke");a.token||t.throw(new Error("A token is required"));const r=await this._metadataService.getRevocationEndpoint(!1);t.debug(`got revocation endpoint, revoking ${(e=a.token_type_hint)!=null?e:"default token type"}`);const n=new URLSearchParams;for(const[s,l]of Object.entries(a))l!=null&&n.set(s,l);n.set("client_id",this._settings.client_id),this._settings.client_secret&&n.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(r,{body:n,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),t.debug("got response")}},QN=class{constructor(a,e,t){this._settings=a,this._metadataService=e,this._claimsService=t,this._logger=new rr("ResponseValidator"),this._userInfoService=new JN(this._settings,this._metadataService),this._tokenClient=new JR(this._settings,this._metadataService)}async validateSigninResponse(a,e,t){const r=this._logger.create("validateSigninResponse");this._processSigninState(a,e),r.debug("state processed"),await this._processCode(a,e,t),r.debug("code processed"),a.isOpenId&&this._validateIdTokenAttributes(a),r.debug("tokens validated"),await this._processClaims(a,e==null?void 0:e.skipUserInfo,a.isOpenId),r.debug("claims processed")}async validateCredentialsResponse(a,e){const t=this._logger.create("validateCredentialsResponse"),r=a.isOpenId&&!!a.id_token;r&&this._validateIdTokenAttributes(a),t.debug("tokens validated"),await this._processClaims(a,e,r),t.debug("claims processed")}async validateRefreshResponse(a,e){var t,r;const n=this._logger.create("validateRefreshResponse");a.userState=e.data,(t=a.session_state)!=null||(a.session_state=e.session_state),(r=a.scope)!=null||(a.scope=e.scope),a.isOpenId&&a.id_token&&(this._validateIdTokenAttributes(a,e.id_token),n.debug("ID Token validated")),a.id_token||(a.id_token=e.id_token,a.profile=e.profile);const s=a.isOpenId&&!!a.id_token;await this._processClaims(a,!1,s),n.debug("claims processed")}validateSignoutResponse(a,e){const t=this._logger.create("validateSignoutResponse");if(e.id!==a.state&&t.throw(new Error("State does not match")),t.debug("state validated"),a.userState=e.data,a.error)throw t.warn("Response was error",a.error),new fc(a)}_processSigninState(a,e){var t;const r=this._logger.create("_processSigninState");if(e.id!==a.state&&r.throw(new Error("State does not match")),e.client_id||r.throw(new Error("No client_id on state")),e.authority||r.throw(new Error("No authority on state")),this._settings.authority!==e.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==e.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),a.userState=e.data,a.url_state=e.url_state,(t=a.scope)!=null||(a.scope=e.scope),a.error)throw r.warn("Response was error",a.error),new fc(a);e.code_verifier&&!a.code&&r.throw(new Error("Expected code in response"))}async _processClaims(a,e=!1,t=!0){const r=this._logger.create("_processClaims");if(a.profile=this._claimsService.filterProtocolClaims(a.profile),e||!this._settings.loadUserInfo||!a.access_token){r.debug("not loading user info");return}r.debug("loading user info");const n=await this._userInfoService.getClaims(a.access_token);r.debug("user info claims received from user info endpoint"),t&&n.sub!==a.profile.sub&&r.throw(new Error("subject from UserInfo response does not match subject in ID Token")),a.profile=this._claimsService.mergeClaims(a.profile,this._claimsService.filterProtocolClaims(n)),r.debug("user info claims received, updated profile:",a.profile)}async _processCode(a,e,t){const r=this._logger.create("_processCode");if(a.code){r.debug("Validating code");const n=await this._tokenClient.exchangeCode({client_id:e.client_id,client_secret:e.client_secret,code:a.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier,extraHeaders:t,...e.extraTokenParams});Object.assign(a,n)}else r.debug("No code to process")}_validateIdTokenAttributes(a,e){var t;const r=this._logger.create("_validateIdTokenAttributes");r.debug("decoding ID Token JWT");const n=dc.decode((t=a.id_token)!=null?t:"");if(n.sub||r.throw(new Error("ID Token is missing a subject claim")),e){const s=dc.decode(e);n.sub!==s.sub&&r.throw(new Error("sub in id_token does not match current sub")),n.auth_time&&n.auth_time!==s.auth_time&&r.throw(new Error("auth_time in id_token does not match original auth_time")),n.azp&&n.azp!==s.azp&&r.throw(new Error("azp in id_token does not match original azp")),!n.azp&&s.azp&&r.throw(new Error("azp not in id_token, but present in original id_token"))}a.profile=n}},Nf=class Jp{constructor(e){this.id=e.id||kr.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=Mf.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new rr("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return rr.createStatic("State","fromStorageString"),Promise.resolve(new Jp(JSON.parse(e)))}static async clearStaleState(e,t){const r=rr.createStatic("State","clearStaleState"),n=Mf.getEpochTime()-t,s=await e.getAllKeys();r.debug("got keys",s);for(let l=0;l<s.length;l++){const c=s[l],d=await e.get(c);let h=!1;if(d)try{const v=await Jp.fromStorageString(d);r.debug("got item from key:",c,v.created),v.created<=n&&(h=!0)}catch(v){r.error("Error parsing state for key:",c,v),h=!0}else r.debug("no item in storage for key:",c),h=!0;h&&(r.debug("removed item for key:",c),e.remove(c))}}},Km=class Qp extends Nf{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?kr.generateCodeVerifier():e.code_verifier||void 0,r=t?await kr.generateCodeChallenge(t):void 0;return new Qp({...e,code_verifier:t,code_challenge:r})}toStorageString(){return new rr("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){rr.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return Qp.create(t)}},QR=class XR{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:r,redirect_uri:n,response_type:s,scope:l,state_data:c,response_mode:d,request_type:h,client_secret:v,nonce:p,url_state:m,resource:_,skipUserInfo:b,extraQueryParams:E,extraTokenParams:M,disablePKCE:O,dpopJkt:C,omitScopeWhenRequesting:U,...I}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!r)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!n)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!s)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!l)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const D=await Km.create({data:c,request_type:h,url_state:m,code_verifier:!O,client_id:r,authority:t,redirect_uri:n,response_mode:d,client_secret:v,scope:l,extraTokenParams:M,skipUserInfo:b}),w=new URL(e);w.searchParams.append("client_id",r),w.searchParams.append("redirect_uri",n),w.searchParams.append("response_type",s),U||w.searchParams.append("scope",l),p&&w.searchParams.append("nonce",p),C&&w.searchParams.append("dpop_jkt",C);let N=D.id;m&&(N=`${N}${tl}${m}`),w.searchParams.append("state",N),D.code_challenge&&(w.searchParams.append("code_challenge",D.code_challenge),w.searchParams.append("code_challenge_method","S256")),_&&(Array.isArray(_)?_:[_]).forEach(K=>w.searchParams.append("resource",K));for(const[A,K]of Object.entries({response_mode:d,...I,...E}))K!=null&&w.searchParams.append(A,K.toString());return new XR({url:w.href,state:D})}};QR._logger=new rr("SigninRequest");var XN=QR,$N="openid",pf=class{constructor(a){if(this.access_token="",this.token_type="",this.profile={},this.state=a.get("state"),this.session_state=a.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(tl);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(tl))}this.error=a.get("error"),this.error_description=a.get("error_description"),this.error_uri=a.get("error_uri"),this.code=a.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-Mf.getEpochTime()}set expires_in(a){typeof a=="string"&&(a=Number(a)),a!==void 0&&a>=0&&(this.expires_at=Math.floor(a)+Mf.getEpochTime())}get isOpenId(){var a;return((a=this.scope)==null?void 0:a.split(" ").includes($N))||!!this.id_token}},ZN=class{constructor({url:a,state_data:e,id_token_hint:t,post_logout_redirect_uri:r,extraQueryParams:n,request_type:s,client_id:l,url_state:c}){if(this._logger=new rr("SignoutRequest"),!a)throw this._logger.error("ctor: No url passed"),new Error("url");const d=new URL(a);if(t&&d.searchParams.append("id_token_hint",t),l&&d.searchParams.append("client_id",l),r&&(d.searchParams.append("post_logout_redirect_uri",r),e||c)){this.state=new Nf({data:e,request_type:s,url_state:c});let h=this.state.id;c&&(h=`${h}${tl}${c}`),d.searchParams.append("state",h)}for(const[h,v]of Object.entries({...n}))v!=null&&d.searchParams.append(h,v.toString());this.url=d.href}},eU=class{constructor(a){if(this.state=a.get("state"),this.state){const e=decodeURIComponent(this.state).split(tl);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(tl))}this.error=a.get("error"),this.error_description=a.get("error_description"),this.error_uri=a.get("error_uri")}},tU=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],rU=["sub","iss","aud","exp","iat"],nU=class{constructor(a){this._settings=a,this._logger=new rr("ClaimsService")}filterProtocolClaims(a){const e={...a};if(this._settings.filterProtocolClaims){let t;Array.isArray(this._settings.filterProtocolClaims)?t=this._settings.filterProtocolClaims:t=tU;for(const r of t)rU.includes(r)||delete e[r]}return e}mergeClaims(a,e){const t={...a};for(const[r,n]of Object.entries(e))if(t[r]!==n)if(Array.isArray(t[r])||Array.isArray(n))if(this._settings.mergeClaimsStrategy.array=="replace")t[r]=n;else{const s=Array.isArray(t[r])?t[r]:[t[r]];for(const l of Array.isArray(n)?n:[n])s.includes(l)||s.push(l);t[r]=s}else typeof t[r]=="object"&&typeof n=="object"?t[r]=this.mergeClaims(t[r],n):t[r]=n;return t}},iU=class{constructor(a,e){this.keys=a,this.nonce=e}},jm=class{constructor(a,e){this._logger=new rr("OidcClient"),this.settings=a instanceof Yp?a:new Yp(a),this.metadataService=e??new YR(this.settings),this._claimsService=new nU(this.settings),this._validator=new QN(this.settings,this.metadataService,this._claimsService),this._tokenClient=new JR(this.settings,this.metadataService)}async createSigninRequest({state:a,request:e,request_uri:t,request_type:r,id_token_hint:n,login_hint:s,skipUserInfo:l,nonce:c,url_state:d,response_type:h=this.settings.response_type,scope:v=this.settings.scope,redirect_uri:p=this.settings.redirect_uri,prompt:m=this.settings.prompt,display:_=this.settings.display,max_age:b=this.settings.max_age,ui_locales:E=this.settings.ui_locales,acr_values:M=this.settings.acr_values,resource:O=this.settings.resource,response_mode:C=this.settings.response_mode,extraQueryParams:U=this.settings.extraQueryParams,extraTokenParams:I=this.settings.extraTokenParams,dpopJkt:D,omitScopeWhenRequesting:w=this.settings.omitScopeWhenRequesting}){const N=this._logger.create("createSigninRequest");if(h!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const A=await this.metadataService.getAuthorizationEndpoint();N.debug("Received authorization endpoint",A);const K=await XN.create({url:A,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:p,response_type:h,scope:v,state_data:a,url_state:d,prompt:m,display:_,max_age:b,ui_locales:E,id_token_hint:n,login_hint:s,acr_values:M,dpopJkt:D,resource:O,request:e,request_uri:t,extraQueryParams:U,extraTokenParams:I,request_type:r,response_mode:C,client_secret:this.settings.client_secret,skipUserInfo:l,nonce:c,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:w});await this.clearStaleState();const z=K.state;return await this.settings.stateStore.set(z.id,z.toStorageString()),K}async readSigninResponseState(a,e=!1){const t=this._logger.create("readSigninResponseState"),r=new pf(qT.readParams(a,this.settings.response_mode));if(!r.state)throw t.throw(new Error("No state in response")),null;const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await Km.fromStorageString(n),response:r}}async processSigninResponse(a,e,t=!0){const r=this._logger.create("processSigninResponse"),{state:n,response:s}=await this.readSigninResponseState(a,t);if(r.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const l=await this.getDpopProof(this.settings.dpop.store);e={...e,DPoP:l}}try{await this._validator.validateSigninResponse(s,n,e)}catch(l){if(l instanceof Wp&&this.settings.dpop){const c=await this.getDpopProof(this.settings.dpop.store,l.nonce);e.DPoP=c,await this._validator.validateSigninResponse(s,n,e)}else throw l}return s}async getDpopProof(a,e){let t,r;return(await a.getAllKeys()).includes(this.settings.client_id)?(r=await a.get(this.settings.client_id),r.nonce!==e&&e&&(r.nonce=e,await a.set(this.settings.client_id,r))):(t=await kr.generateDPoPKeys(),r=new iU(t,e),await a.set(this.settings.client_id,r)),await kr.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:r.keys,nonce:r.nonce})}async processResourceOwnerPasswordCredentials({username:a,password:e,skipUserInfo:t=!1,extraTokenParams:r={}}){const n=await this._tokenClient.exchangeCredentials({username:a,password:e,...r}),s=new pf(new URLSearchParams);return Object.assign(s,n),await this._validator.validateCredentialsResponse(s,t),s}async useRefreshToken({state:a,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,extraTokenParams:s}){var l;const c=this._logger.create("useRefreshToken");let d;if(this.settings.refreshTokenAllowedScope===void 0)d=a.scope;else{const p=this.settings.refreshTokenAllowedScope.split(" ");d=(((l=a.scope)==null?void 0:l.split(" "))||[]).filter(_=>p.includes(_)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const p=await this.getDpopProof(this.settings.dpop.store);n={...n,DPoP:p}}let h;try{h=await this._tokenClient.exchangeRefreshToken({refresh_token:a.refresh_token,scope:d,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...s})}catch(p){if(p instanceof Wp&&this.settings.dpop)n.DPoP=await this.getDpopProof(this.settings.dpop.store,p.nonce),h=await this._tokenClient.exchangeRefreshToken({refresh_token:a.refresh_token,scope:d,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...s});else throw p}const v=new pf(new URLSearchParams);return Object.assign(v,h),c.debug("validating response",v),await this._validator.validateRefreshResponse(v,{...a,scope:d}),v}async createSignoutRequest({state:a,id_token_hint:e,client_id:t,request_type:r,url_state:n,post_logout_redirect_uri:s=this.settings.post_logout_redirect_uri,extraQueryParams:l=this.settings.extraQueryParams}={}){const c=this._logger.create("createSignoutRequest"),d=await this.metadataService.getEndSessionEndpoint();if(!d)throw c.throw(new Error("No end session endpoint")),null;c.debug("Received end session endpoint",d),!t&&s&&!e&&(t=this.settings.client_id);const h=new ZN({url:d,id_token_hint:e,client_id:t,post_logout_redirect_uri:s,state_data:a,extraQueryParams:l,request_type:r,url_state:n});await this.clearStaleState();const v=h.state;return v&&(c.debug("Signout request has state to persist"),await this.settings.stateStore.set(v.id,v.toStorageString())),h}async readSignoutResponseState(a,e=!1){const t=this._logger.create("readSignoutResponseState"),r=new eU(qT.readParams(a,this.settings.response_mode));if(!r.state){if(t.debug("No state in response"),r.error)throw t.warn("Response was error:",r.error),new fc(r);return{state:void 0,response:r}}const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await Nf.fromStorageString(n),response:r}}async processSignoutResponse(a){const e=this._logger.create("processSignoutResponse"),{state:t,response:r}=await this.readSignoutResponseState(a,!0);return t?(e.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(r,t)):e.debug("No state from storage; skipping response validation"),r}clearStaleState(){return this._logger.create("clearStaleState"),Nf.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(a,e){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:a,token_type_hint:e})}},Pr=(function(a){return a.NotSupported="OIDC authentication not supported",a.Misconfigured="OIDC is misconfigured",a.General="Something went wrong with OIDC discovery",a.OpSupport="Configured OIDC OP does not support required functions",a.DynamicRegistrationNotSupported="Dynamic registration not supported",a.DynamicRegistrationFailed="Dynamic registration failed",a.DynamicRegistrationInvalid="Dynamic registration invalid response",a.CodeExchangeFailed="Failed to exchange code for token",a.InvalidBearerTokenResponse="Invalid bearer token response",a.InvalidIdToken="Invalid ID token",a.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",a})({}),Fm=a=>!!a&&typeof a=="object"&&!Array.isArray(a),xa=(a,e)=>!a[e]||!Xu(a,e)?(T.error("Missing or invalid property: ".concat(e)),!1):!0,Xu=(a,e)=>a[e]&&typeof a[e]!="string"?(T.error("Invalid property: ".concat(e)),!1):!0,aU=(a,e)=>a[e]&&(!Array.isArray(a[e])||!a[e].every(t=>typeof t=="string"))?(T.error("Invalid property: ".concat(e)),!1):!0,zg=(a,e,t)=>{var r=a[e];return!r||!Array.isArray(r)||!r.includes(t)?(T.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},qm=a=>{if(!Fm(a))throw T.error("Issuer configuration not found or malformed"),new Error(Pr.OpSupport);var e=[xa(a,"authorization_endpoint"),xa(a,"token_endpoint"),xa(a,"revocation_endpoint"),Xu(a,"registration_endpoint"),Xu(a,"account_management_uri"),Xu(a,"device_authorization_endpoint"),aU(a,"account_management_actions_supported"),zg(a,"response_types_supported","code"),zg(a,"grant_types_supported","authorization_code"),zg(a,"code_challenge_methods_supported","S256")].some(t=>!t);if(!e)return{authorizationEndpoint:a.authorization_endpoint,tokenEndpoint:a.token_endpoint,registrationEndpoint:a.registration_endpoint,accountManagementEndpoint:a.account_management_uri,accountManagementActionsSupported:a.account_management_actions_supported};throw T.error("Issuer configuration not valid"),new Error(Pr.OpSupport)};function $R(a){qm(a)}var ZR=a=>{try{return zR(a)}catch(e){throw T.error("Could not decode id_token",e),e}},eC=(a,e,t,r)=>{try{if(!a)throw new Error("No ID token");var n=ZR(a);if(n.iss!==e)throw new Error("Invalid issuer");if(n.aud!==t)throw new Error("Invalid audience");if(r!==void 0&&n.nonce!==r)throw new Error("Invalid nonce");if(!n.exp||Date.now()>n.exp*1e3)throw new Error("Invalid expiry")}catch(s){throw T.error("Invalid ID token",s),new Error(Pr.InvalidIdToken)}};function tC(a){if(!Fm(a))throw T.error("Stored user state not found"),new Error(Pr.MissingOrInvalidStoredState);var e=[xa(a,"homeserverUrl"),xa(a,"nonce"),Xu(a,"identityServerUrl")].some(t=>!t);if(e)throw new Error(Pr.MissingOrInvalidStoredState)}var sU=a=>Fm(a)&&xa(a,"token_type")&&a.token_type.toLowerCase()==="bearer"&&xa(a,"access_token")&&xa(a,"refresh_token")&&(!("expires_in"in a)||typeof a.expires_in=="number");function rC(a){if(!sU(a))throw new Error(Pr.InvalidBearerTokenResponse)}function VT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function Uf(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?VT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):VT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var $f=a=>{var e=a??Qn(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},oU=(function(){var a=R(function*(e){if(!globalThis.crypto.subtle)return T.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield AR(e);return Gf(t)});return function(t){return a.apply(this,arguments)}})(),lU=a=>{var{redirectUri:e}=a;return{scope:$f(),redirectUri:e,state:Qn(8),nonce:Qn(8),codeVerifier:Qn(64)}},uU=(function(){var a=R(function*(e,t,r){var{scope:n,redirectUri:s,state:l,nonce:c,codeVerifier:d}=r,h=new URL(e);return h.searchParams.append("response_mode","query"),h.searchParams.append("response_type","code"),h.searchParams.append("redirect_uri",s),h.searchParams.append("client_id",t),h.searchParams.append("state",l),h.searchParams.append("scope",n),h.searchParams.append("nonce",c),h.searchParams.append("code_challenge_method","S256"),h.searchParams.append("code_challenge",yield oU(d)),h.toString()});return function(t,r,n){return a.apply(this,arguments)}})(),cU=(function(){var a=R(function*(e){var{metadata:t,redirectUri:r,clientId:n,homeserverUrl:s,identityServerUrl:l,nonce:c,prompt:d,urlState:h}=e,v=$f(),p=new jm(Uf(Uf({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:v,stateStore:new Xf({prefix:"mx_oidc_",store:window.sessionStorage})})),m={homeserverUrl:s,nonce:c,identityServerUrl:l},_=yield p.createSigninRequest({state:m,nonce:c,prompt:d,url_state:h});return _.url});return function(t){return a.apply(this,arguments)}})(),dU=a=>({id_token:a.id_token,scope:a.scope,expires_at:a.expires_at,refresh_token:a.refresh_token,access_token:a.access_token,token_type:"Bearer"}),fU=(function(){var a=R(function*(e,t){var r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),cc.setLogger(T);try{var n=new pf(r.searchParams),s=new Xf({prefix:"mx_oidc_",store:window.sessionStorage}),l=yield s.get(n.state);if(!l)throw new Error(Pr.MissingOrInvalidStoredState);var c=yield Km.fromStorageString(l),d=new jm(Uf(Uf({},c),{},{stateStore:s})),h=yield d.processSigninResponse(r.href),v=h.userState;tC(v),rC(h),eC(h.id_token,d.settings.authority,d.settings.client_id,v.nonce);var p=dU(h);return{oidcClientSettings:{clientId:d.settings.client_id,issuer:d.settings.authority},tokenResponse:p,homeserverUrl:v.homeserverUrl,identityServerUrl:v.identityServerUrl,idTokenClaims:h.profile}}catch(_){T.error("Oidc login failed",_);var m=_.message;throw Object.values(Pr).includes(m)?_:new Error(Pr.CodeExchangeFailed)}});return function(t,r){return a.apply(this,arguments)}})();function GT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function HT(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?GT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):GT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}var nC=(function(){var a=R(function*(e){var t,r=new URL(".well-known/openid-configuration",e),n=yield fetch(r,{method:se.Get,signal:Ff(5e3)}),s=yield n.json(),l=qm(s),c=new Yp({authority:e,redirect_uri:"",client_id:""}),d=new YR(c),h=yield d.getMetadata(),v=(t=yield d.getSigningKeys())!==null&&t!==void 0?t:void 0;return $R(h),HT(HT({},l),{},{metadata:h,signingKeys:v})});return function(t){return a.apply(this,arguments)}})(),hU="urn:ietf:params:oauth:grant-type:device_code",vU=(function(){var a=R(function*(e,t){if(!e.registrationEndpoint)throw new Error(Pr.DynamicRegistrationNotSupported);var r=["authorization_code","refresh_token"];if(r.some(h=>!e.metadata.grant_types_supported.includes(h)))throw new Error(Pr.DynamicRegistrationNotSupported);var n={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,logo_uri:t.logoUri,contacts:t.contacts,policy_uri:t.policyUri,tos_uri:t.tosUri},s={Accept:"application/json","Content-Type":"application/json"};try{var l=yield fetch(e.registrationEndpoint,{method:se.Post,headers:s,body:JSON.stringify(n)});if(l.status>=400)throw new Error(Pr.DynamicRegistrationFailed);var c=yield l.json(),d=c.client_id;if(!d||typeof d!="string")throw new Error(Pr.DynamicRegistrationInvalid);return d}catch(h){throw Object.values(Pr).includes(h.message)?h:(T.error("Dynamic registration request failed",h),new Error(Pr.DynamicRegistrationFailed))}});return function(t,r){return a.apply(this,arguments)}})();function zT(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(a,n).enumerable})),t.push.apply(t,r)}return t}function WT(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zT(Object(t),!0).forEach(function(r){y(a,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):zT(Object(t)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(t,r))})}return a}class gU{constructor(e,t,r,n,s){this.idTokenClaims=s,y(this,"oidcClientReady",void 0),y(this,"oidcClient",void 0),y(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,n,r)}initialiseOidcClient(e,t,r,n){var s=this;return R(function*(){try{var l=yield nC(e),c=$f(r);s.oidcClient=new jm(WT(WT({},l.metadata),{},{client_id:t,scope:c,redirect_uri:n,authority:l.metadata.issuer,stateStore:new Xf({prefix:"mx_oidc_",store:window.sessionStorage})}))}catch(d){throw T.error("Failed to initialise OIDC client.",d),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return R(function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var r=yield t.inflightRefreshRequest;return r}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return R(function*(){})()}getNewTokens(e){var t=this;return R(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var r={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},n=yield t.oidcClient.useRefreshToken({state:r,timeoutInSeconds:300}),s={accessToken:n.access_token,refreshToken:n.refresh_token};return yield t.persistTokens(s),s})()}}var YT=function(){},pU=10;class mU{constructor(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,y(this,"windowLimit",void 0),y(this,"start",void 0),y(this,"end",void 0),y(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3,(r=t.room)===null||r===void 0||r.on(Ue.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,r=n=>{if(!n)throw new Error("No timeline given to initFields");var s,l=n.getEvents();if(!e)s=l.length;else if(s=l.findIndex(h=>h.getId()===e),s<0)throw new Error("getEventTimeline result didn't include requested event");var c=Math.min(l.length,s+Math.ceil(t/2)),d=Math.max(0,c-t);this.start=new Xp(n,d-n.getBaseIndex()),this.end=new Xp(n,c-n.getBaseIndex()),this.eventCount=c-d};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==ke.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==ke.FORWARDS){var r;return(r=this.end)!==null&&r!==void 0?r:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var r=this.getTimelineIndex(e);if(!r)return!1;var n=e==ke.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,YT("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");var s=this.eventCount-this.windowLimit;return s>0&&this.unpaginate(s,e!=ke.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==ke.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return!!r||!!n}paginate(e,t){var r=arguments,n=this;return R(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!0,l=r.length>3&&r[3]!==void 0?r[3]:pU,c=n.getTimelineIndex(e);if(!c)return!1;if(c.pendingPaginate)return c.pendingPaginate;if(n.extend(e,t))return!0;if(!s||l===0)return!1;var d=c.timeline.getPaginationToken(e);if(!d)return!1;var h=n.client.paginateEventTimeline(c.timeline,{backwards:e==ke.BACKWARDS,limit:t}).finally(function(){c.pendingPaginate=void 0}).then(v=>v?n.paginate(e,t,!0,l-1):n.paginate(e,t,!1,0));return c.pendingPaginate=h,h})()}unpaginate(e,t){var r=t?this.start:this.end;if(!r)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,YT("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var r,n,s=t.getEvents(),l=0,c=s.length;t===this.start.timeline&&(l=this.start.index+t.getBaseIndex()),t===((r=this.end)===null||r===void 0?void 0:r.timeline)&&(c=this.end.index+t.getBaseIndex());for(var d=l;d<c;d++)e.push(s[d]);if(t===((n=this.end)===null||n===void 0?void 0:n.timeline))break;t=t.getNeighbouringTimeline(ke.FORWARDS)}return e}}class Xp{constructor(e,t){this.timeline=e,this.index=t,y(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?ke.BACKWARDS:ke.FORWARDS);return r?(this.timeline=r,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}}var Pu="m.login.email.identity",JT="m.login.msisdn",$p=(function(a){return a.Password="m.login.password",a.Recaptcha="m.login.recaptcha",a.Terms="m.login.terms",a.Email="m.login.email.identity",a.Msisdn="m.login.msisdn",a.Sso="m.login.sso",a.SsoUnstable="org.matrix.login.sso",a.Dummy="m.login.dummy",a.RegistrationToken="m.login.registration_token",a.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",a})({});class iC extends Error{constructor(e,t,r){super(e),this.required_stages=t,this.flows=r,y(this,"name","NoAuthFlowFoundError")}}class yU{constructor(e){var t=this;y(this,"matrixClient",void 0),y(this,"inputs",void 0),y(this,"clientSecret",void 0),y(this,"requestCallback",void 0),y(this,"busyChangedCallback",void 0),y(this,"stateUpdatedCallback",void 0),y(this,"requestEmailTokenCallback",void 0),y(this,"supportedStages",void 0),y(this,"data",void 0),y(this,"emailSid",void 0),y(this,"requestingEmailToken",!1),y(this,"attemptAuthDeferred",null),y(this,"chosenFlow",null),y(this,"currentStage",null),y(this,"emailAttempt",1),y(this,"submitPromise",null),y(this,"requestEmailToken",R(function*(){if(t.requestingEmailToken)T.warn("Could not request email token: Already requesting");else{T.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var r=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=r.sid,T.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return R(function*(){var t;e.attemptAuthDeferred=qa();var r=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var n;(n=e.busyChangedCallback)===null||n===void 0||n.call(e,!0);var s=e.data.session?{session:e.data.session}:null;e.doRequest(s).finally(()=>{var l;(l=e.busyChangedCallback)===null||l===void 0||l.call(e,!1)})}return r})()}poll(){var e=this;return R(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==Pu&&e.emailSid){var r={sid:e.emailSid,client_secret:e.clientSecret},n=e.matrixClient.getIdentityServerUrl();n&&(r.id_server=new URL(n).host),t={type:Pu,threepid_creds:r}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,r=this;return R(function*(){var n,s=t.length>1&&t[1]!==void 0?t[1]:!1;if(!r.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!s){var l;(l=r.busyChangedCallback)===null||l===void 0||l.call(r,!0)}for(;r.submitPromise;)try{yield r.submitPromise}catch{}var c;(n=r.data)!==null&&n!==void 0&&n.session?(c={session:r.data.session},Object.assign(c,e)):c=e;try{r.submitPromise=r.doRequest(c,s),yield r.submitPromise}finally{if(r.submitPromise=null,!s){var d;(d=r.busyChangedCallback)===null||d===void 0||d.call(r,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,r=this;return R(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;try{var s=yield r.requestCallback(e,n);r.attemptAuthDeferred.resolve(s),r.attemptAuthDeferred=null}catch(b){var l,c,d,h,v=b instanceof hr?b:null,p=(l=v==null||(c=v.data)===null||c===void 0?void 0:c.flows)!==null&&l!==void 0?l:null,m=((d=r.data)===null||d===void 0?void 0:d.flows)||!!p;if(!v||v.httpStatus!==401||!v.data||!m)if(n)T.log("Background poll request failed doing UI auth: ignoring",b);else{var _;(_=r.attemptAuthDeferred)===null||_===void 0||_.reject(b)}v&&!v.data&&(v.data={}),v&&!v.data.flows&&!v.data.completed&&!v.data.session&&(v.data.flows=r.data.flows,v.data.completed=r.data.completed,v.data.session=r.data.session),v&&(r.data=v.data);try{r.startNextAuthStage()}catch(E){r.attemptAuthDeferred.reject(E),r.attemptAuthDeferred=null;return}if(!r.emailSid&&(h=r.chosenFlow)!==null&&h!==void 0&&h.stages.includes($p.Email))try{yield r.requestEmailToken()}catch(E){r.attemptAuthDeferred.reject(E),r.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,r=this.chooseStage();if(!r)throw new Error("No incomplete flows from the server");if(this.currentStage=r,r===$p.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var n,s;this.stateUpdatedCallback(r,{errcode:((n=this.data)===null||n===void 0?void 0:n.errcode)||"",error:((s=this.data)===null||s===void 0?void 0:s.error)||""});return}this.stateUpdatedCallback(r,r===Pu?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),T.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return T.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(r=>!this.supportedStages.has(r)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],r=!!this.inputs.emailAddress||!!this.emailSid,n=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((v,p)=>this.scoreFlow(v)-this.scoreFlow(p));for(var s of t){var l=!1,c=!1;for(var d of s.stages)d===Pu?l=!0:d==JT&&(c=!0);if(l==r&&c==n)return s}var h=[];throw r&&h.push(Pu),n&&h.push(JT),new iC("No appropriate authentication flow found",h,t)}firstUncompletedStage(e){var t,r=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(n=>!r.includes(n))}}var aC=[a=>{a.createObjectStore("users",{keyPath:["userId"]}),a.createObjectStore("accountData",{keyPath:["type"]}),a.createObjectStore("sync",{keyPath:["clobber"]})},a=>{var e=a.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},a=>{a.createObjectStore("client_options",{keyPath:["clobber"]})},a=>{a.createObjectStore("to_device_queue",{autoIncrement:!0})}],SU=aC.length;function Zd(a,e,t){var r=a.openCursor(e);return new Promise((n,s)=>{var l=[];r.onerror=()=>{s(new Error("Query failed: "+r.error))},r.onsuccess=()=>{var c=r.result;if(!c){n(l);return}l.push(t(c)),c.continue()}})}function ys(a){return new Promise((e,t)=>{a.oncomplete=function(r){e(r)},a.onerror=function(){t(a.error)}})}function sC(a){return new Promise((e,t)=>{a.onsuccess=function(r){e(r)},a.onerror=function(){t(a.error)}})}function bU(a){return new Promise((e,t)=>{a.onsuccess=()=>e(a),a.onerror=r=>t(r)})}function Wg(a){return sC(a).then(e=>a.result)}class QT{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),cR(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,y(this,"dbName",void 0),y(this,"syncAccumulator",void 0),y(this,"db",void 0),y(this,"disconnected",!0),y(this,"_isNewlyCreated",!1),y(this,"syncToDatabasePromise",void 0),y(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new HR}connect(e){var t=this;if(!this.disconnected)return T.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,T.log("LocalIndexedDBStoreBackend.connect: connecting...");var r=this.indexedDB.open(this.dbName,SU);return r.onupgradeneeded=n=>{var s=r.result,l=n.oldVersion;T.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(l)),l<1&&(this._isNewlyCreated=!0),aC.forEach((c,d)=>{l<=d&&c(s)})},r.onblocked=()=>{T.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},T.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),sC(r).then(R(function*(){T.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=r.result,t.db.onversionchange=()=>{var n;(n=t.db)===null||n===void 0||n.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e==null||e()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,r]=e;T.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,r)=>{var n=this.db.transaction(["oob_membership_events"],"readonly"),s=n.objectStore("oob_membership_events"),l=s.index("room"),c=IDBKeyRange.only(e),d=l.openCursor(c),h=[],v=!1;d.onsuccess=()=>{var p=d.result;if(!p)return!h.length&&!v?t(null):t(h);var m=p.value;m.oob_written?v=!0:h.push(m),p.continue()},d.onerror=p=>{r(p)}}).then(t=>(T.log("LL: got ".concat(t==null?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var r=this;return R(function*(){T.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var n=r.db.transaction(["oob_membership_events"],"readwrite"),s=n.objectStore("oob_membership_events");t.forEach(c=>{s.put(c)});var l={room_id:e,oob_written:!0,state_key:0};s.put(l),yield ys(n),T.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return R(function*(){var r=t.db.transaction(["oob_membership_events"],"readonly"),n=r.objectStore("oob_membership_events"),s=n.index("room"),l=IDBKeyRange.only(e),c=Wg(s.openKeyCursor(l,"next")).then(b=>(b==null?void 0:b.primaryKey)[1]),d=Wg(s.openKeyCursor(l,"prev")).then(b=>(b==null?void 0:b.primaryKey)[1]),[h,v]=yield Promise.all([c,d]),p=t.db.transaction(["oob_membership_events"],"readwrite"),m=p.objectStore("oob_membership_events"),_=IDBKeyRange.bound([e,h],[e,v]);T.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,h],[e,v]),yield bU(m.delete(_))})()}clearDatabase(){return new Promise(e=>{var t;T.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{T.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{T.warn("unable to delete js-sdk store indexeddb: ".concat(r.error)),e()},r.onsuccess=()=>{T.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(xf(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return R(function*(){return t.syncToDatabasePromise?(T.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return R(function*(){try{var r=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(r.accountData),t.persistSyncData(r.nextBatch,r.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return T.log("Persisting sync data up to",e),bs(()=>{var r=this.db.transaction(["sync"],"readwrite"),n=r.objectStore("sync");return n.put({clobber:"-",nextBatch:e,roomsData:t}),ys(r).then(()=>{T.log("Persisted sync data up to",e)})})}persistAccountData(e){return bs(()=>{var t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(var n of e)r.put(n);return ys(t).then()})}persistUserPresenceEvents(e){return bs(()=>{var t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(var n of e)r.put({userId:n[0],event:n[1]});return ys(t).then()})}getUserPresenceEvents(){return bs(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return Zd(t,void 0,r=>[r.value.userId,r.value.event])})}loadAccountData(){return T.log("LocalIndexedDBStoreBackend: loading account data..."),bs(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return Zd(t,void 0,r=>r.value).then(r=>(T.log("LocalIndexedDBStoreBackend: loaded account data"),r))})}loadSyncData(){return T.log("LocalIndexedDBStoreBackend: loading sync data..."),bs(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return Zd(t,void 0,r=>r.value).then(r=>(T.log("LocalIndexedDBStoreBackend: loaded sync data"),r.length>1&&T.warn("loadSyncData: More than 1 sync row found."),r.length>0?r[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return Zd(t,void 0,r=>{var n;return(n=r.value)===null||n===void 0?void 0:n.options}).then(r=>r[0])})}storeClientOptions(e){var t=this;return R(function*(){var r=t.db.transaction(["client_options"],"readwrite"),n=r.objectStore("client_options");n.put({clobber:"-",options:e}),yield ys(r)})()}saveToDeviceBatches(e){var t=this;return R(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");for(var s of e)n.add(s);yield ys(r)})()}getOldestToDeviceBatch(){var e=this;return R(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),r=t.objectStore("to_device_queue"),n=yield Wg(r.openCursor());if(!n)return null;var s=n.value;return{id:n.key,txnId:s.txnId,eventType:s.eventType,batch:s.batch}})()}removeToDeviceBatch(e){var t=this;return R(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");n.delete(e),yield ys(r)})()}destroy(){var e=this;return R(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}}class _U{constructor(e,t){this.workerFactory=e,this.dbName=t,y(this,"worker",void 0),y(this,"nextSeq",0),y(this,"inFlight",{}),y(this,"startPromise",void 0),y(this,"onWorkerMessage",r=>{var n=r.data;if(n.command=="closed"){var s;(s=this.onClose)===null||s===void 0||s.call(this)}else if(n.command=="cmd_success"||n.command=="cmd_fail"){if(n.seq===void 0){T.error("Got reply from worker with no seq");return}var l=this.inFlight[n.seq];if(l===void 0){T.error("Got reply for unknown seq "+n.seq);return}if(delete this.inFlight[n.seq],n.command=="cmd_success")l.resolve(n.result);else{var c=new Error(n.error.message);c.name=n.error.name,l.reject(c)}}else T.warn("Unrecognised message from worker: ",n)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return R(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return R(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return R(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{T.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var r,n=this.nextSeq++,s=qa();return this.inFlight[n]=s,(r=this.worker)===null||r===void 0||r.postMessage({command:e,seq:n,args:t}),s.promise})}destroy(){var e=this;return R(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}}var EU=1e3*60*5;class TU extends km{static exists(e,t){return QT.exists(e,t)}constructor(e){if(super(e),y(this,"backend",void 0),y(this,"startedUp",!1),y(this,"syncTs",0),y(this,"userModifiedMap",{}),y(this,"emitter",new Pt),y(this,"onClose",()=>{this.emitter.emit("closed")}),y(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),y(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),y(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),y(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{T.log("Deleted indexeddb data.")},t=>{throw T.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),y(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var r of this.getUsers())this.userModifiedMap[r.userId]!==r.getLastModifiedTime()&&r.events.presence&&(t.push([r.userId,r.events.presence.event]),this.userModifiedMap[r.userId]=r.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),y(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),y(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),y(this,"setOutOfBandMembers",this.degradable((t,r)=>(super.setOutOfBandMembers(t,r),this.backend.setOutOfBandMembers(t,r)),"setOutOfBandMembers")),y(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),y(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),y(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new _U(e.workerFactory,e.dbName):this.backend=new QT(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(T.log("IndexedDBStore.startup: already started"),Promise.resolve()):(T.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(T.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{T.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[r,n]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var s=this.createUser(r);n&&s.setPresenceEvent(new _r(n)),this.userModifiedMap[s.userId]=s.getLastModifiedTime(),this.storeUser(s)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>EU}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var r=this,n=t?super[t]:null;return R(function*(){for(var s=arguments.length,l=new Array(s),c=0;c<s;c++)l[c]=arguments[c];try{return yield e.call(r,...l)}catch(d){T.error("IndexedDBStore failure, degrading to MemoryStore",d),r.emitter.emit("degraded",d);try{T.log("IndexedDBStore trying to delete degraded data"),yield r.backend.clearDatabase(),T.log("IndexedDBStore delete after degrading succeeded")}catch(h){T.warn("IndexedDBStore delete after degrading failed",h)}if(n)return n.call(r,...l)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,r=this;return R(function*(){if(!r.localStorage)return t().call(r,e);var n=r.localStorage.getItem(Yg(e));if(n)try{return JSON.parse(n)}catch(s){T.error("Could not parse persisted pending events",s)}return[]})()}setPendingEvents(e,t){var r=()=>super.setPendingEvents,n=this;return R(function*(){if(!n.localStorage)return r().call(n,e,t);t.length>0?n.localStorage.setItem(Yg(e),JSON.stringify(t)):n.localStorage.removeItem(Yg(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function Yg(a){return"mx_pending_events_".concat(a)}var wU=(function(a){return a.Email="email",a.Phone="msisdn",a})({}),RU=new Wt("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),CU=(function(a){return a.Gitlab="gitlab",a.Github="github",a.Apple="apple",a.Google="google",a.Facebook="facebook",a.Twitter="twitter",a})({}),IU=(function(a){return a.LOGIN="login",a.REGISTER="register",a})({}),OU=(function(a){return a.Global="Global",a.SetItemError="setItem",a.GetItemError="getItem",a.RemoveItemError="removeItem",a.ClearError="clear",a.QuotaExceededError="QuotaExceededError",a})({});class kU extends Pt{}new kU;var oC=()=>new Bf;function lC(a){oC=a}function uC(a){var e,t,r;return a.store=(e=a.store)!==null&&e!==void 0?e:new km({localStorage:globalThis.localStorage}),a.scheduler=(t=a.scheduler)!==null&&t!==void 0?t:new $o,a.cryptoStore=(r=a.cryptoStore)!==null&&r!==void 0?r:oC(),a}function Vm(a){return new ll(uC(a))}function AU(a,e,t,r){var n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new GR(a,e,t,uC(r),n)}const DU=Object.freeze(Object.defineProperty({__proto__:null,AuthType:$p,AutoDiscovery:Ye,AutoDiscoveryAction:Sn,AutoDiscoveryError:Nn,Beacon:Kw,BeaconEvent:Bt,CRYPTO_ENABLED:_N,CallEvent:et,CallFeedEvent:ai,Category:Ki,ClientEvent:Pe,ClientPrefix:qt,ClientStoppedError:DD,ConditionKind:lr,ConditionOperator:hD,ConnectionError:Sc,ContentHelpers:Zk,Crypto:xD,CryptoEvent:at,DELEGATED_OIDC_COMPATIBILITY:RU,DEVICE_CODE_SCOPE:hU,DMMemberCountCondition:vD,Device:nR,DeviceVerification:Hi,Direction:tt,DuplicateStrategy:Gu,EVENT_VISIBILITY_CHANGE_TYPE:Is,EventEmitterEvents:bw,EventStatus:Ve,EventTimeline:ke,EventTimelineSet:Lo,EventType:$,FILTER_RELATED_BY_REL_TYPES:Go,FILTER_RELATED_BY_SENDERS:Vo,FeatureSupport:Ur,Filter:$r,GET_LOGIN_TOKEN_CAPABILITY:TN,GroupCall:gm,GroupCallEvent:Dt,GroupCallIntent:aR,GroupCallState:Gt,GroupCallStatsReportEvent:Ku,GroupCallType:Hf,GuestAccess:Df,HTTPError:Yo,HistoryVisibility:Om,HttpApiEvent:dp,IdentityPrefix:Bi,IdentityProviderBrand:CU,IndexedDBCryptoStore:Oe,IndexedDBStore:TU,InteractiveAuth:yU,InvalidCryptoStoreError:bm,InvalidCryptoStoreState:Sm,JoinRule:RR,KNOWN_SAFE_ROOM_VERSION:$w,KeySignatureUploadError:ju,KnownMembership:We,LOCAL_NOTIFICATION_SETTINGS_PREFIX:ww,LocalStorageCryptoStore:Wf,LocalStorageErrors:OU,LocationAssetType:Ho,MAIN_ROOM_TIMELINE:yc,MSC3912_RELATION_BASED_REDACTIONS_PROP:sp,M_ASSET:pc,M_BEACON:rp,M_BEACON_INFO:om,M_HTML:Sk,M_LOCATION:mc,M_MESSAGE:yk,M_POLL_END:bf,M_POLL_KIND_DISCLOSED:Nk,M_POLL_KIND_UNDISCLOSED:Uk,M_POLL_RESPONSE:rc,M_POLL_START:Pk,M_TEXT:am,M_TIMESTAMP:Fa,M_TOPIC:um,MatrixClient:ll,MatrixError:hr,MatrixEvent:_r,MatrixEventEvent:ct,MatrixHttpApi:Jw,MatrixScheduler:$o,MediaHandlerEvent:ws,MediaPrefix:Bo,MemoryCryptoStore:Bf,MemoryStore:km,Method:se,MsgType:Xn,NoAuthFlowFoundError:iC,NotificationCountType:pt,OidcError:Pr,OidcTokenRefresher:gU,PUSHER_DEVICE_ID:Lk,PUSHER_ENABLED:op,PendingEventOrdering:Zo,Poll:qw,PollEvent:Da,Preset:Im,PushRuleActionName:La,PushRuleKind:Sr,REFERENCE_RELATION:hw,ReceiptType:xr,RelationType:Ht,Relations:lm,RelationsEvent:sf,RestrictedAllowType:tN,Room:qf,RoomCreateTypeField:_f,RoomEvent:Ue,RoomMember:Tf,RoomMemberEvent:jr,RoomNameType:ii,RoomState:uc,RoomStateEvent:$e,RoomSummary:Iw,RoomType:xo,RoomVersionStability:Qw,RoomWidgetClient:GR,RoomWidgetClientEvent:vf,RuleId:yr,SERVICE_TYPES:Cp,SSOAction:IU,SearchOrderBy:CR,SearchResult:Jf,SecretStorage:cM,ServerCapabilities:Xw,SetPresence:Zw,SlidingSyncEvent:Vp,StatsReport:zi,SyncAccumulator:HR,SyncState:bt,THREAD_RELATION_TYPE:Ot,Thread:Ut,ThreadEvent:Br,ThreadFilterType:Vn,ThreepidMedium:wU,TimelineIndex:Xp,TimelineWindow:mU,ToDeviceMessageId:Fr,TweakName:pm,TypedEventEmitter:Pt,UNSIGNED_MEMBERSHIP_FIELD:Rw,UNSIGNED_THREAD_ID_FIELD:Ef,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:Tw,UNSTABLE_MSC2666_MUTUAL_ROOMS:MR,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:NR,UNSTABLE_MSC2666_SHARED_ROOMS:DR,UNSTABLE_MSC2716_MARKER:Ew,UNSTABLE_MSC3088_ENABLED:ip,UNSTABLE_MSC3088_PURPOSE:np,UNSTABLE_MSC3089_BRANCH:qi,UNSTABLE_MSC3089_LEAF:_w,UNSTABLE_MSC3089_TREE_SUBTYPE:ap,UNSTABLE_MSC3852_LAST_SEEN_UA:EN,UNSTABLE_MSC4133_EXTENDED_PROFILES:UR,UNSTABLE_MSC4140_DELAYED_EVENTS:di,UpdateDelayedEventAction:cf,User:Wi,UserEvent:mn,Visibility:eN,anySignal:zw,calculateRetryBackoff:Yw,completeAuthorizationCodeGrant:fU,createClient:Vm,createNewMatrixCall:ic,createRoomWidgetClient:AU,decodeBase64:Ar,decodeIdToken:ZR,determineFeatureSupport:ff,discoverAndValidateOIDCIssuerWellKnown:nC,encodeBase64:Kr,encodeUnpaddedBase64:Vf,encodeUnpaddedBase64Url:Gf,fixNotificationCountOnDecryption:PR,generateAuthorizationParams:lU,generateAuthorizationUrl:uU,generateOidcAuthorizationUrl:cU,generateScope:$f,getBeaconInfoIdentifier:wf,getHttpUriForMxc:Kf,inMainTimelineForReceipt:lc,isDmMemberCountCondition:gD,isEventTypeSame:bk,isPollEvent:Vw,isTimestampInDuration:up,isValidatedIssuerMetadata:$R,parseErrorResponse:fm,registerOidcClient:vU,retryNetworkOperation:Ww,safeGetRetryAfterMs:dm,setCryptoStoreFactory:lC,threadFilterTypeToFilter:LR,threadIdForReceipt:el,timeoutSignal:Ff,validateBearerTokenResponse:rC,validateIdToken:eC,validateOIDCIssuerWellKnown:qm,validateStoredUserState:tC},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var Zp;try{Zp=globalThis.indexedDB}catch{}Zp&&lC(()=>new Oe(Zp,"matrix-js-sdk:crypto"));globalThis.matrixcs=DU;let bn=null;const Gm="amino_matrix_session";function MU(){try{const a=sessionStorage.getItem(Gm);return a?JSON.parse(a):null}catch{return null}}function NU(a){sessionStorage.setItem(Gm,JSON.stringify(a))}function XT(){sessionStorage.removeItem(Gm),bn&&(bn.stopClient(),bn=null)}async function UU(a,e,t){const n=await Vm({baseUrl:a}).login("m.login.password",{user:e,password:t,initial_device_display_name:"Amino Habeas App"});return NU({baseUrl:a,userId:n.user_id,accessToken:n.access_token,deviceId:n.device_id}),cC(a,n.user_id,n.access_token)}async function cC(a,e,t){return bn&&bn.stopClient(),bn=Vm({baseUrl:a,userId:e,accessToken:t}),await bn.startClient({initialSyncLimit:0}),await new Promise(r=>{const n=s=>{s==="PREPARED"&&(bn.removeListener("sync",n),r())};bn.on("sync",n)}),bn}function vi(){if(!bn)throw new Error("Matrix client not initialized");return bn}function Ss(){return bn!==null}async function Ps(a,e,t,r){await vi().sendStateEvent(a,e,t,r)}async function Ls(a,e,t){await vi().sendEvent(a,e,t)}function PU({onLogin:a}){const[e,t]=kt.useState(""),[r,n]=kt.useState(""),[s,l]=kt.useState(""),[c,d]=kt.useState(!1),h="https://app.aminoimmigration.com",v=async p=>{var m;p.preventDefault(),l(""),d(!0);try{await UU(h,e,r),a()}catch(_){l(((m=_==null?void 0:_.data)==null?void 0:m.error)||(_==null?void 0:_.message)||"Login failed. Check your credentials.")}finally{d(!1)}};return F.jsx("div",{className:"login-wrap",children:F.jsxs("form",{className:"login-box",onSubmit:v,children:[F.jsx("div",{className:"login-brand",children:"Habeas"}),F.jsx("div",{className:"login-sub",children:"Amino Immigration"}),s&&F.jsx("div",{className:"login-error",children:s}),F.jsxs("div",{className:"frow",children:[F.jsx("label",{className:"flbl",children:"Username"}),F.jsx("input",{className:"finp",type:"text",value:e,onChange:p=>t(p.target.value),placeholder:"attorney",autoFocus:!0,disabled:c})]}),F.jsxs("div",{className:"frow",children:[F.jsx("label",{className:"flbl",children:"Password"}),F.jsx("input",{className:"finp",type:"password",value:r,onChange:p=>n(p.target.value),placeholder:"password",disabled:c})]}),F.jsx("button",{type:"submit",className:"hbtn accent login-btn",disabled:c||!e||!r,children:c?"Signing in...":"Sign In"}),F.jsxs("div",{className:"login-server",children:["Server: ",h.replace("https://","")]})]})})}const $T=a=>{let e;const t=new Set,r=(h,v)=>{const p=typeof h=="function"?h(e):h;if(!Object.is(p,e)){const m=e;e=v??(typeof p!="object"||p===null)?p:Object.assign({},e,p),t.forEach(_=>_(e,m))}},n=()=>e,c={setState:r,getState:n,getInitialState:()=>d,subscribe:h=>(t.add(h),()=>t.delete(h))},d=e=a(r,n,c);return c},LU=(a=>a?$T(a):$T),xU=a=>a;function BU(a,e=xU){const t=Ud.useSyncExternalStore(a.subscribe,Ud.useCallback(()=>e(a.getState()),[a,e]),Ud.useCallback(()=>e(a.getInitialState()),[a,e]));return Ud.useDebugValue(t),t}const ZT=a=>{const e=LU(a),t=r=>BU(e,r);return Object.assign(t,e),t},KU=(a=>a?ZT(a):ZT),Ds=KU(a=>({facilities:{},courts:{},attProfiles:{},national:{iceDirector:"",iceDirectorTitle:"",dhsSecretary:"",attorneyGeneral:""},clients:{},petitions:{},log:[],role:null,currentUser:"",currentView:"board",selectedClientId:null,selectedPetitionId:null,editorTab:"client",setFacilities:e=>a({facilities:e}),setCourts:e=>a({courts:e}),setAttProfiles:e=>a({attProfiles:e}),setNational:e=>a({national:e}),setClients:e=>a({clients:e}),setPetitions:e=>a({petitions:e}),setRole:e=>a({role:e}),setCurrentUser:e=>a({currentUser:e}),setView:e=>a({currentView:e}),selectClient:e=>a({selectedClientId:e}),selectPetition:e=>a({selectedPetitionId:e}),setEditorTab:e=>a({editorTab:e}),pushLog:e=>a(t=>({log:[...t.log,e]})),updateFacility:(e,t)=>a(r=>({facilities:{...r.facilities,[e]:t}})),removeFacility:e=>a(t=>{const r={...t.facilities};return delete r[e],{facilities:r}}),updateCourt:(e,t)=>a(r=>({courts:{...r.courts,[e]:t}})),removeCourt:e=>a(t=>{const r={...t.courts};return delete r[e],{courts:r}}),updateAttProfile:(e,t)=>a(r=>({attProfiles:{...r.attProfiles,[e]:t}})),removeAttProfile:e=>a(t=>{const r={...t.attProfiles};return delete r[e],{attProfiles:r}}),updateClient:(e,t)=>a(r=>({clients:{...r.clients,[e]:t}})),updatePetition:(e,t)=>a(r=>({petitions:{...r.petitions,[e]:t}}))})),$u=()=>Math.random().toString(36).slice(2,10),gt=()=>new Date().toISOString(),mf=a=>{try{return new Date(a).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"})}catch{return a}},Ra=["drafted","reviewed","submitted"],hc={drafted:{color:"#c9a040",bg:"#faf5e4",label:"Drafted"},reviewed:{color:"#5a9e6f",bg:"#eaf5ee",label:"Reviewed"},submitted:{color:"#4a7ab5",bg:"#e8f0fa",label:"Submitted"}};function dC(a,e,t,r,n){return a=a||{},e=e||{},t=t||{},r=r||{},n=n||{},{COURT_DISTRICT:e.district||"",COURT_DIVISION:e.division||"",CASE_NUMBER:e.caseNumber||"",PETITIONER_FULL_NAME:a.name||"",PETITIONER_COUNTRY:a.country||"",PETITIONER_YEARS_IN_US:a.yearsInUS||"",PETITIONER_ENTRY_DATE:a.entryDate||"",PETITIONER_ENTRY_METHOD:a.entryMethod||"",PETITIONER_APPREHENSION_LOCATION:a.apprehensionLocation||"",PETITIONER_APPREHENSION_DATE:a.apprehensionDate||"",PETITIONER_CRIMINAL_HISTORY:a.criminalHistory||"",PETITIONER_COMMUNITY_TIES:a.communityTies||"",DETENTION_FACILITY_NAME:e.facilityName||"",DETENTION_FACILITY_CITY:e.facilityCity||"",DETENTION_FACILITY_STATE:e.facilityState||"",WARDEN_NAME:e.warden||"",FIELD_OFFICE_DIRECTOR:e.fieldOfficeDirector||"",FIELD_OFFICE_NAME:e.fieldOfficeName||"",ICE_DIRECTOR:n.iceDirector||"",ICE_DIRECTOR_TITLE:n.iceDirectorTitle||"",DHS_SECRETARY:n.dhsSecretary||"",ATTORNEY_GENERAL:n.attorneyGeneral||"",FILING_DATE:e.filingDate||"",FILING_DAY:e.filingDay||"",FILING_MONTH_YEAR:e.filingMonthYear||"",ATTORNEY1_NAME:t.name||"",ATTORNEY1_BAR_NO:t.barNo||"",ATTORNEY1_FIRM:t.firm||"",ATTORNEY1_ADDRESS:t.address||"",ATTORNEY1_CITY_STATE_ZIP:t.cityStateZip||"",ATTORNEY1_PHONE:t.phone||"",ATTORNEY1_FAX:t.fax||"",ATTORNEY1_EMAIL:t.email||"",ATTORNEY2_NAME:r.name||"",ATTORNEY2_BAR_NO:r.barNo||"",ATTORNEY2_FIRM:r.firm||"",ATTORNEY2_ADDRESS:r.address||"",ATTORNEY2_CITY_STATE_ZIP:r.cityStateZip||"",ATTORNEY2_PHONE:r.phone||"",ATTORNEY2_EMAIL:r.email||"",ATTORNEY2_PRO_HAC:r.proHacVice||""}}const fC=[{key:"name",label:"Facility Name",ph:"South Louisiana ICE Processing Center"},{key:"city",label:"City",ph:"Basile"},{key:"state",label:"State",ph:"Louisiana"},{key:"warden",label:"Warden",ph:"John Smith"},{key:"fieldOfficeName",label:"Field Office",ph:"New Orleans Field Office"},{key:"fieldOfficeDirector",label:"Field Office Director",ph:"Jane Doe"}],hC=[{key:"district",label:"District",ph:"Middle District of Tennessee"},{key:"division",label:"Division",ph:"Nashville Division"}],jU=[{key:"iceDirector",label:"ICE Director",ph:"Tom Homan"},{key:"iceDirectorTitle",label:"ICE Title",ph:"Director"},{key:"dhsSecretary",label:"DHS Secretary",ph:"Kristi Noem"},{key:"attorneyGeneral",label:"Attorney General",ph:"Pam Bondi"}],FU=[{key:"name",label:"Name",ph:""},{key:"barNo",label:"Bar No.",ph:""},{key:"firm",label:"Firm",ph:""},{key:"address",label:"Address",ph:""},{key:"cityStateZip",label:"City/St/Zip",ph:""},{key:"phone",label:"Phone",ph:""},{key:"fax",label:"Fax",ph:""},{key:"email",label:"Email",ph:""},{key:"proHacVice",label:"Pro Hac Vice",ph:"*Pro hac vice pending"}],vC=[{key:"name",label:"Full Name",ph:"Juan Carlos Rivera"},{key:"country",label:"Country",ph:"Honduras"},{key:"yearsInUS",label:"Years in U.S.",ph:"12"},{key:"entryDate",label:"Entry Date",ph:"approximately 2013"},{key:"entryMethod",label:"Entry Method",ph:"without inspection"},{key:"apprehensionLocation",label:"Arrest Location",ph:"Nashville, Tennessee"},{key:"apprehensionDate",label:"Arrest Date",ph:"January 15, 2026"},{key:"criminalHistory",label:"Criminal History",ph:"has no criminal record"},{key:"communityTies",label:"Community Ties",ph:"has strong family and community ties"}],qU=[{key:"filingDate",label:"Filing Date",ph:"February 19, 2026"},{key:"filingDay",label:"Filing Day",ph:"19th"},{key:"filingMonthYear",label:"Month & Year",ph:"February, 2026"}],VU=[{key:"warden",label:"Warden",ph:""},{key:"fieldOfficeDirector",label:"FOD",ph:""},{key:"fieldOfficeName",label:"Field Office",ph:""}];function GU(){const{petitions:a,clients:e,role:t,currentUser:r,selectPetition:n,setView:s}=Ds(),l=Ds(p=>p.updatePetition),c=Ds(p=>p.pushLog),d=Object.values(a),h=t==="admin"?d:d.filter(p=>p.createdBy===r),v=(p,m)=>{const _=a[p];if(!_)return;const b=Ra.indexOf(_.stage),E=m==="advance"?b+1:b-1;if(E<0||E>=Ra.length)return;const M=Ra[E],O=new Date().toISOString();c({op:"STAGE",target:p,payload:M,frame:{t:O,prior:_.stage}}),l(p,{..._,stage:M,stageHistory:[..._.stageHistory,{stage:M,at:O}]})};return F.jsxs("div",{className:"board-view",children:[F.jsx("div",{className:"kanban",children:Ra.map(p=>{const m=h.filter(b=>b.stage===p).sort((b,E)=>new Date(E.createdAt).getTime()-new Date(b.createdAt).getTime()),_=hc[p];return F.jsxs("div",{className:"kb-col",children:[F.jsxs("div",{className:"kb-col-head",style:{borderBottomColor:_.color},children:[F.jsx("span",{className:"kb-col-title",children:_.label}),F.jsx("span",{className:"kb-col-count",style:{background:_.color},children:m.length})]}),F.jsxs("div",{className:"kb-col-body",children:[m.length===0&&F.jsx("div",{className:"kb-empty",children:"None"}),m.map(b=>{var O;const E=e[b.clientId],M=Ra.indexOf(b.stage);return F.jsxs("div",{className:"kb-card",style:{borderLeftColor:_.color},children:[F.jsx("div",{className:"kb-card-name",onClick:()=>{n(b.id),s("editor")},children:(E==null?void 0:E.name)||"Unnamed"}),F.jsxs("div",{className:"kb-card-meta",children:[b.caseNumber||"No case no.",b.district?`  ${b.district}`:""]}),F.jsx("div",{className:"kb-card-meta",children:b.facilityName||""}),F.jsx("div",{className:"kb-card-date",children:new Date(b.createdAt).toLocaleDateString()}),((O=b.stageHistory)==null?void 0:O.length)>1&&F.jsx("div",{className:"kb-dots",children:b.stageHistory.map((C,U)=>{var I;return F.jsx("span",{className:"kb-dot",style:{background:(I=hc[C.stage])==null?void 0:I.color},title:`${C.stage} ${mf(C.at)}`},U)})}),F.jsxs("div",{className:"kb-card-actions",children:[M>0&&F.jsxs("button",{className:"kb-btn",onClick:()=>v(b.id,"revert"),children:[" ",Ra[M-1]]}),M<Ra.length-1&&F.jsxs("button",{className:"kb-btn accent",onClick:()=>v(b.id,"advance"),children:[Ra[M+1]," "]})]})]},b.id)})]})]},p)})}),Object.keys(a).length===0&&F.jsx("div",{className:"board-empty",children:F.jsxs("p",{children:["No petitions yet. Go to ",F.jsx("strong",{children:"Clients"})," to create one, or set up ",F.jsx("strong",{children:"Directory"})," first."]})})]})}function Uo({title:a,fields:e,data:t,onChange:r}){return F.jsxs("div",{className:"fg",children:[F.jsx("div",{className:"fg-title",children:a}),e.map(n=>{var s;return F.jsxs("div",{className:"frow",children:[F.jsxs("label",{className:"flbl",children:[n.label,((s=t[n.key])==null?void 0:s.trim())&&F.jsx("span",{className:"fchk",children:""})]}),F.jsx("input",{type:"text",className:"finp",value:t[n.key]||"",placeholder:n.ph||"",onChange:l=>r(n.key,l.target.value)})]},n.key)})]})}const HU=[{id:"ct-1",type:"title",content:"UNITED STATES DISTRICT COURT"},{id:"ct-2",type:"title",content:"FOR THE {{COURT_DISTRICT}}"},{id:"ct-3",type:"title",content:"{{COURT_DIVISION}}"},{id:"cap-pet",type:"cap-name",content:"{{PETITIONER_FULL_NAME}},"},{id:"cap-role",type:"cap-center",content:"Petitioner-Plaintiff,"},{id:"cap-v",type:"cap-center",content:"v."},{id:"cap-r1",type:"cap-resp",content:"{{WARDEN_NAME}}, Warden of {{DETENTION_FACILITY_NAME}};"},{id:"cap-r2",type:"cap-resp",content:"{{FIELD_OFFICE_DIRECTOR}}, FOD, {{FIELD_OFFICE_NAME}}, ERO, ICE;"},{id:"cap-r3",type:"cap-resp",content:"U.S. Department of Homeland Security;"},{id:"cap-r4",type:"cap-resp",content:"{{ICE_DIRECTOR}}, {{ICE_DIRECTOR_TITLE}}, ICE, DHS;"},{id:"cap-r5",type:"cap-resp",content:"{{DHS_SECRETARY}}, Secretary, DHS; and"},{id:"cap-r6",type:"cap-resp",content:"{{ATTORNEY_GENERAL}}, Attorney General; Respondents-Defendants."},{id:"cap-case",type:"cap-case",content:"C/A No. {{CASE_NUMBER}}"},{id:"cap-title",type:"cap-doctitle",content:"PETITION FOR WRIT OF HABEAS CORPUS AND COMPLAINT FOR DECLARATORY AND INJUNCTIVE RELIEF"},{id:"h-intro",type:"heading",content:"INTRODUCTION"},{id:"p-1",type:"para",content:'1. {{PETITIONER_FULL_NAME}} ("Petitioner") is a citizen of {{PETITIONER_COUNTRY}} who has resided in the U.S. for {{PETITIONER_YEARS_IN_US}} years. ICE apprehended him in {{PETITIONER_APPREHENSION_LOCATION}} on or about {{PETITIONER_APPREHENSION_DATE}}.'},{id:"p-2",type:"para",content:"2. Petitioner is detained at {{DETENTION_FACILITY_NAME}} in {{DETENTION_FACILITY_CITY}}, {{DETENTION_FACILITY_STATE}}."},{id:"p-3",type:"para",content:"3. The BIA reinterpreted the INA. <em>Matter of Yajure Hurtado</em>, 29 I&N Dec. 216 (BIA 2025). Petitioner is subject to mandatory detention under  1225(b)(2)(A) with no bond."},{id:"p-4",type:"para",content:'4. This violates the INA. Petitioner, residing nearly {{PETITIONER_YEARS_IN_US}} years, is not an "applicant for admission." He should be under  1226(a), which allows bond.'},{id:"p-5",type:"para",content:"5. Petitioner seeks declaratory relief under  1226(a) and asks for release or a bond hearing."},{id:"h-cust",type:"heading",content:"CUSTODY"},{id:"p-6",type:"para",content:"6. Petitioner is in ICE custody at {{DETENTION_FACILITY_NAME}} in {{DETENTION_FACILITY_CITY}}, {{DETENTION_FACILITY_STATE}}. <em>Jones v. Cunningham</em>, 371 U.S. 236, 243 (1963)."},{id:"h-jur",type:"heading",content:"JURISDICTION"},{id:"p-7",type:"para",content:"7. Jurisdiction under 28 U.S.C.  2241,  1331, the Suspension Clause, and the INA."},{id:"h-ven",type:"heading",content:"VENUE"},{id:"p-12",type:"para",content:"12. Venue proper under 28 U.S.C.  1391(e). Petitioner is under ICEs {{FIELD_OFFICE_NAME}} and detained at {{DETENTION_FACILITY_NAME}}."},{id:"h-par",type:"heading",content:"PARTIES"},{id:"p-16",type:"para",content:"16. Petitioner {{PETITIONER_FULL_NAME}} is from {{PETITIONER_COUNTRY}}, in the U.S. since {{PETITIONER_ENTRY_DATE}}."},{id:"p-17",type:"para",content:"1721. Respondents {{WARDEN_NAME}}, {{FIELD_OFFICE_DIRECTOR}}, {{ICE_DIRECTOR}}, {{DHS_SECRETARY}}, and {{ATTORNEY_GENERAL}} are sued in their official capacities."},{id:"h-leg",type:"heading",content:"LEGAL BACKGROUND"},{id:"p-22",type:"para",content:"2237.  1226(a) allows bond.  1225(b) is for those seeking admission at borders. The BIAs reinterpretation in <em>Yajure Hurtado</em> is contrary to statute, regulations, and precedent. Under <em>Loper Bright</em>, 603 U.S. 369 (2024), no deference is owed."},{id:"h-facts",type:"heading",content:"STATEMENT OF FACTS"},{id:"p-38",type:"para",content:"3843. Petitioner is from {{PETITIONER_COUNTRY}}, entered {{PETITIONER_ENTRY_METHOD}} in {{PETITIONER_ENTRY_DATE}}, {{PETITIONER_CRIMINAL_HISTORY}}, arrested in {{PETITIONER_APPREHENSION_LOCATION}} on {{PETITIONER_APPREHENSION_DATE}}, detained at {{DETENTION_FACILITY_NAME}}."},{id:"h-c1",type:"heading",content:"COUNT I  Violation of  1226(a)"},{id:"p-45",type:"para",content:"45. Petitioner is entitled to a bond hearing under  1226(a). His detention is unlawful."},{id:"h-c2",type:"heading",content:"COUNT II  Violation of Bond Regulations"},{id:"p-51",type:"para",content:"51. Application of  1225(b)(2) violates 8 C.F.R.  236.1, 1236.1, 1003.19."},{id:"h-c3",type:"heading",content:"COUNT III  Fifth Amendment Due Process"},{id:"p-57",type:"para",content:"57. Petitioner {{PETITIONER_CRIMINAL_HISTORY}} and {{PETITIONER_COMMUNITY_TIES}}. Risk of erroneous deprivation is high."},{id:"h-pray",type:"heading",content:"PRAYER FOR RELIEF"},{id:"p-pray",type:"para",content:"WHEREFORE: (1) jurisdiction; (2) expedited; (3) no transfer; (4) OSC; (5) declare unlawful; (6) Writ with bond hearing; (7) EAJA fees; (8) further relief."},{id:"sig-date",type:"sig",content:"Date: {{FILING_DATE}}"},{id:"sig-sub",type:"sig",content:"Respectfully Submitted,"},{id:"sig-a1",type:"sig",content:`/s/ {{ATTORNEY1_NAME}}
{{ATTORNEY1_BAR_NO}}
{{ATTORNEY1_FIRM}}
{{ATTORNEY1_ADDRESS}}
{{ATTORNEY1_CITY_STATE_ZIP}}
{{ATTORNEY1_PHONE}}  {{ATTORNEY1_FAX}}
{{ATTORNEY1_EMAIL}}`},{id:"sig-a2",type:"sig",content:`/s/ {{ATTORNEY2_NAME}}
{{ATTORNEY2_BAR_NO}}*
{{ATTORNEY2_FIRM}}
{{ATTORNEY2_ADDRESS}}
{{ATTORNEY2_CITY_STATE_ZIP}}
{{ATTORNEY2_PHONE}}
{{ATTORNEY2_EMAIL}}
{{ATTORNEY2_PRO_HAC}}`},{id:"sig-role",type:"sig-label",content:"Attorneys for Petitioner"},{id:"h-ver",type:"heading",content:"VERIFICATION  28 U.S.C.  2242"},{id:"p-ver",type:"para",content:"I represent {{PETITIONER_FULL_NAME}} and verify the foregoing. Dated {{FILING_DAY}} day of {{FILING_MONTH_YEAR}}."},{id:"sig-ver",type:"sig",content:`/s/ {{ATTORNEY2_NAME}}
Attorney for Petitioner Pro Hac Vice`}];function zU(){const{clients:a,petitions:e,currentUser:t,selectedClientId:r,selectClient:n,selectPetition:s,updateClient:l,updatePetition:c,setView:d,setEditorTab:h,pushLog:v}=Ds(),p=()=>{const O=$u(),C={id:O,name:"",country:"",yearsInUS:"",entryDate:"",entryMethod:"without inspection",apprehensionLocation:"",apprehensionDate:"",criminalHistory:"has no criminal record",communityTies:"",createdAt:gt(),roomId:""};l(O,C),v({op:"CREATE",target:O,payload:null,frame:{t:gt(),entity:"client"}}),n(O)},m=(O,C,U)=>{const I=a[O];I&&(l(O,{...I,[C]:U}),v({op:"FILL",target:`client.${C}`,payload:U,frame:{t:gt(),entity:"client",id:O}}))},_=O=>{var I;const C=$u(),U={id:C,clientId:O,createdBy:t,stage:"drafted",stageHistory:[{stage:"drafted",at:gt()}],blocks:HU.map(D=>({...D})),district:"",division:"",caseNumber:"",facilityName:"",facilityCity:"",facilityState:"",warden:"",fieldOfficeDirector:"",fieldOfficeName:"",filingDate:"",filingDay:"",filingMonthYear:"",createdAt:gt(),roomId:((I=a[O])==null?void 0:I.roomId)||""};c(C,U),v({op:"CREATE",target:C,payload:null,frame:{t:gt(),entity:"petition",clientId:O}}),s(C),h("court"),d("editor")},b=r?a[r]:null,E=b?Object.values(e).filter(O=>O.clientId===b.id):[],M=Object.values(a);return F.jsxs("div",{className:"clients-view",children:[F.jsxs("div",{className:"cv-sidebar",children:[F.jsxs("div",{className:"cv-head",children:[F.jsx("span",{className:"cv-title",children:"Clients"}),F.jsx("button",{className:"hbtn accent",onClick:p,children:"+ New"})]}),F.jsxs("div",{className:"cv-list",children:[M.length===0&&F.jsx("div",{className:"cv-empty",children:"No clients yet."}),M.map(O=>{const C=Object.values(e).filter(U=>U.clientId===O.id);return F.jsxs("div",{className:`cv-item ${r===O.id?"on":""}`,onClick:()=>n(O.id),children:[F.jsx("div",{className:"cv-item-name",children:O.name||"Unnamed"}),F.jsxs("div",{className:"cv-item-meta",children:[O.country,C.length>0&&`  ${C.length} pet.`]}),C.map(U=>F.jsx("span",{className:"stage-badge sm",style:{background:hc[U.stage].color},children:U.stage},U.id))]},O.id)})]})]}),F.jsx("div",{className:"cv-detail",children:b?F.jsxs(F.Fragment,{children:[F.jsxs("div",{className:"cv-detail-head",children:[F.jsx("h2",{children:b.name||"New Client"}),F.jsx("button",{className:"hbtn accent",onClick:()=>_(b.id),children:"+ New Petition"})]}),F.jsx(Uo,{title:"Client Information",fields:vC,data:b,onChange:(O,C)=>m(b.id,O,C)}),E.length>0&&F.jsxs("div",{className:"fg",children:[F.jsx("div",{className:"fg-title",children:"Petitions"}),E.map(O=>F.jsxs("div",{className:"pet-row",onClick:()=>{s(O.id),d("editor")},children:[F.jsx("span",{className:"stage-badge",style:{background:hc[O.stage].color},children:O.stage}),F.jsx("span",{style:{flex:1,fontSize:12},children:O.caseNumber||"No case no."}),F.jsx("span",{style:{fontSize:11,color:"#aaa"},children:new Date(O.createdAt).toLocaleDateString()})]},O.id))]})]}):F.jsxs("div",{className:"cv-empty-detail",children:[F.jsx("div",{style:{fontSize:48,opacity:.3,marginBottom:16},children:""}),F.jsx("p",{children:"Select or create a client."})]})})]})}function ef({record:a}){return a!=null&&a.createdBy?F.jsxs("div",{className:"prov",children:[F.jsxs("span",{className:"prov-item",children:["Created by ",F.jsx("strong",{children:a.createdBy})," ",a.createdAt&&mf(a.createdAt)]}),a.updatedAt&&a.updatedAt!==a.createdAt&&F.jsxs("span",{className:"prov-item",children:["Updated by ",F.jsx("strong",{children:a.updatedBy})," ",mf(a.updatedAt)]}),a.history&&a.history.length>0&&F.jsxs("details",{className:"prov-details",children:[F.jsxs("summary",{className:"prov-sum",children:[a.history.length," change",a.history.length>1?"s":""]}),F.jsx("div",{className:"prov-log",children:a.history.map((e,t)=>F.jsxs("div",{className:"prov-entry",children:[F.jsx("span",{className:"prov-ts",children:mf(e.at)})," ",F.jsx("strong",{children:e.by}),": ",e.change]},t))})]})]}):null}const gC="com.amino.config.national",Hm="com.amino.facility",zm="com.amino.court",Wm="com.amino.attorney",pC="com.amino.client",WU="com.amino.petition",YU="com.amino.petition.blocks",xs="com.amino.op";let tf=null;const JU="#org:aminoimmigration.com";async function Un(){return tf||(tf=(await vi().getRoomIdForAlias(JU)).room_id,tf)}function mC(){return vi().getRooms().filter(t=>{try{const r=t.currentState.getStateEvents(pC,"");return r&&r.getContent()&&!r.getContent().deleted}catch{return!1}}).map(t=>t.roomId)}function Ym(a,e){const r=vi().getRoom(a);return(r==null?void 0:r.currentState).getStateEvents(e)||[]}function QU(a,e,t){const n=vi().getRoom(a);return(n==null?void 0:n.currentState).getStateEvents(e,t)}async function XU(){const a=await Un(),e=Ym(a,Hm),t={};for(const r of e){const n=r.getStateKey(),s=r.getContent();n&&(s!=null&&s.name)&&!s.deleted&&(t[n]={id:n,...s,createdBy:r.getSender()??void 0,updatedAt:new Date(r.getTs()).toISOString()})}return t}async function $U(){const a=await Un(),e=Ym(a,zm),t={};for(const r of e){const n=r.getStateKey(),s=r.getContent();n&&(s!=null&&s.district)&&!s.deleted&&(t[n]={id:n,...s,createdBy:r.getSender()??void 0,updatedAt:new Date(r.getTs()).toISOString()})}return t}async function ZU(){const a=await Un(),e=Ym(a,Wm),t={};for(const r of e){const n=r.getStateKey(),s=r.getContent();n&&(s!=null&&s.name)&&!s.deleted&&(t[n]={id:n,...s,createdBy:r.getSender()??void 0,updatedAt:new Date(r.getTs()).toISOString()})}return t}async function yC(){const a=await Un(),e=QU(a,gC,"");if(e){const t=e.getContent();return{iceDirector:t.iceDirector||"",iceDirectorTitle:t.iceDirectorTitle||"",dhsSecretary:t.dhsSecretary||"",attorneyGeneral:t.attorneyGeneral||"",createdBy:e.getSender()??void 0,updatedAt:new Date(e.getTs()).toISOString()}}return{iceDirector:"",iceDirectorTitle:"",dhsSecretary:"",attorneyGeneral:""}}async function eP(a){const e=await Un();await Ps(e,Hm,{name:a.name,city:a.city,state:a.state,warden:a.warden,fieldOfficeName:a.fieldOfficeName,fieldOfficeDirector:a.fieldOfficeDirector},a.id),await Ls(e,xs,{op:"UPDATE",target:`facility.${a.id}`,payload:a.name,frame:{entity:"facility"}})}async function tP(a){const e=await Un();await Ps(e,Hm,{deleted:!0},a),await Ls(e,xs,{op:"DELETE",target:`facility.${a}`,payload:null,frame:{entity:"facility"}})}async function rP(a){const e=await Un();await Ps(e,zm,{district:a.district,division:a.division},a.id),await Ls(e,xs,{op:"UPDATE",target:`court.${a.id}`,payload:a.district,frame:{entity:"court"}})}async function nP(a){const e=await Un();await Ps(e,zm,{deleted:!0},a),await Ls(e,xs,{op:"DELETE",target:`court.${a}`,payload:null,frame:{entity:"court"}})}async function iP(a){const e=await Un();await Ps(e,Wm,{name:a.name,barNo:a.barNo,firm:a.firm,address:a.address,cityStateZip:a.cityStateZip,phone:a.phone,fax:a.fax,email:a.email,proHacVice:a.proHacVice},a.id),await Ls(e,xs,{op:"UPDATE",target:`attorney.${a.id}`,payload:a.name,frame:{entity:"attorney"}})}async function aP(a){const e=await Un();await Ps(e,Wm,{deleted:!0},a),await Ls(e,xs,{op:"DELETE",target:`attorney.${a}`,payload:null,frame:{entity:"attorney"}})}async function sP(a){const e=await Un(),t=await yC();await Ps(e,gC,{iceDirector:a.iceDirector??t.iceDirector,iceDirectorTitle:a.iceDirectorTitle??t.iceDirectorTitle,dhsSecretary:a.dhsSecretary??t.dhsSecretary,attorneyGeneral:a.attorneyGeneral??t.attorneyGeneral},""),await Ls(e,xs,{op:"UPDATE",target:"national",payload:JSON.stringify(a),frame:{entity:"national"}})}function oP(){const{facilities:a,courts:e,national:t,attProfiles:r,currentUser:n,updateFacility:s,removeFacility:l,updateCourt:c,removeCourt:d,setNational:h,updateAttProfile:v,removeAttProfile:p,pushLog:m}=Ds(),[_,b]=kt.useState("facilities"),[E,M]=kt.useState(null),[O,C]=kt.useState({}),U=V=>{M(V.id),C({...V})},I=()=>{M(null),C({})},D=()=>{const V=$u(),B={id:V,name:"",city:"",state:"",warden:"",fieldOfficeName:"",fieldOfficeDirector:"",createdBy:n,createdAt:gt(),updatedBy:n,updatedAt:gt()};s(V,B),m({op:"CREATE",target:V,payload:null,frame:{t:gt(),entity:"facility"}}),U(B)},w=async()=>{const V=O;if(s(V.id,{...V,updatedBy:n,updatedAt:gt()}),Ss())try{await eP(V)}catch(B){console.error("Failed to sync facility:",B)}m({op:"UPDATE",target:V.id,payload:V.name,frame:{t:gt(),entity:"facility"}}),I()},N=async V=>{if(l(V),Ss())try{await tP(V)}catch(B){console.error("Failed to delete facility:",B)}m({op:"DELETE",target:V,payload:null,frame:{t:gt(),entity:"facility"}}),I()},A=()=>{const V=$u(),B={id:V,district:"",division:"",createdBy:n,createdAt:gt(),updatedBy:n,updatedAt:gt()};c(V,B),m({op:"CREATE",target:V,payload:null,frame:{t:gt(),entity:"court"}}),U(B)},K=async()=>{const V=O;if(c(V.id,{...V,updatedBy:n,updatedAt:gt()}),Ss())try{await rP(V)}catch(B){console.error("Failed to sync court:",B)}m({op:"UPDATE",target:V.id,payload:V.district,frame:{t:gt(),entity:"court"}}),I()},z=async V=>{if(d(V),Ss())try{await nP(V)}catch(B){console.error("Failed to delete court:",B)}m({op:"DELETE",target:V,payload:null,frame:{t:gt(),entity:"court"}}),I()},de=()=>{const V=$u(),B={id:V,name:"",barNo:"",firm:"",address:"",cityStateZip:"",phone:"",fax:"",email:"",proHacVice:"",createdBy:n,createdAt:gt(),updatedBy:n,updatedAt:gt()};v(V,B),m({op:"CREATE",target:V,payload:null,frame:{t:gt(),entity:"attorney_profile"}}),U(B)},_e=async()=>{const V=O;if(v(V.id,{...V,updatedBy:n,updatedAt:gt()}),Ss())try{await iP(V)}catch(B){console.error("Failed to sync attorney:",B)}m({op:"UPDATE",target:V.id,payload:V.name,frame:{t:gt(),entity:"attorney_profile"}}),I()},le=async V=>{if(p(V),Ss())try{await aP(V)}catch(B){console.error("Failed to delete attorney:",B)}m({op:"DELETE",target:V,payload:null,frame:{t:gt(),entity:"attorney_profile"}}),I()},Ce=async(V,B)=>{const te={...t,[V]:B,updatedBy:n,updatedAt:gt()};if(h(te),Ss())try{await sP({[V]:B})}catch(he){console.error("Failed to sync national:",he)}m({op:"UPDATE",target:"national",payload:B,frame:{t:gt(),field:V}})};return F.jsxs("div",{className:"dir-view",children:[F.jsx("div",{className:"dir-tabs",children:[["facilities",`Facilities (${Object.keys(a).length})`],["courts",`Courts (${Object.keys(e).length})`],["attorneys",`Attorney Profiles (${Object.keys(r).length})`],["national","National Defaults"]].map(([V,B])=>F.jsx("button",{className:`dir-tab ${_===V?"on":""}`,onClick:()=>{b(V),I()},children:B},V))}),F.jsxs("div",{className:"dir-body",children:[_==="facilities"&&F.jsxs("div",{className:"dir-section",children:[F.jsxs("div",{className:"dir-head",children:[F.jsx("h3",{children:"Detention Facilities"}),F.jsx("button",{className:"hbtn accent",onClick:D,children:"+ Add Facility"})]}),F.jsx("p",{className:"dir-desc",children:"Each facility bundles its warden, location, and linked field office. Selecting a facility on a petition auto-fills all six fields."}),F.jsxs("div",{className:"dir-list",children:[Object.values(a).map(V=>F.jsx("div",{className:`dir-card ${E===V.id?"editing":""}`,children:E===V.id?F.jsxs(F.Fragment,{children:[fC.map(B=>F.jsxs("div",{className:"frow",children:[F.jsx("label",{className:"flbl",children:B.label}),F.jsx("input",{className:"finp",value:O[B.key]||"",placeholder:B.ph||"",onChange:te=>C(he=>({...he,[B.key]:te.target.value}))})]},B.key)),F.jsxs("div",{className:"dir-card-actions",children:[F.jsx("button",{className:"hbtn accent",onClick:w,children:"Save"}),F.jsx("button",{className:"hbtn",onClick:I,children:"Cancel"}),F.jsx("button",{className:"hbtn danger",onClick:()=>N(V.id),children:"Delete"})]})]}):F.jsxs(F.Fragment,{children:[F.jsxs("div",{className:"dir-card-head",onClick:()=>U(V),children:[F.jsx("strong",{children:V.name||"Unnamed Facility"}),F.jsxs("span",{className:"dir-card-sub",children:[V.city,", ",V.state]})]}),F.jsxs("div",{className:"dir-card-detail",children:["Warden: ",V.warden||"","  FO:"," ",V.fieldOfficeName||"","  FOD:"," ",V.fieldOfficeDirector||""]}),F.jsx(ef,{record:V})]})},V.id)),Object.keys(a).length===0&&F.jsx("div",{className:"dir-empty",children:"No facilities yet. Add one to get started."})]})]}),_==="courts"&&F.jsxs("div",{className:"dir-section",children:[F.jsxs("div",{className:"dir-head",children:[F.jsx("h3",{children:"Courts"}),F.jsx("button",{className:"hbtn accent",onClick:A,children:"+ Add Court"})]}),F.jsx("p",{className:"dir-desc",children:"District + division combos. Selecting a court on a petition fills both fields."}),F.jsxs("div",{className:"dir-list",children:[Object.values(e).map(V=>F.jsx("div",{className:`dir-card ${E===V.id?"editing":""}`,children:E===V.id?F.jsxs(F.Fragment,{children:[hC.map(B=>F.jsxs("div",{className:"frow",children:[F.jsx("label",{className:"flbl",children:B.label}),F.jsx("input",{className:"finp",value:O[B.key]||"",placeholder:B.ph||"",onChange:te=>C(he=>({...he,[B.key]:te.target.value}))})]},B.key)),F.jsxs("div",{className:"dir-card-actions",children:[F.jsx("button",{className:"hbtn accent",onClick:K,children:"Save"}),F.jsx("button",{className:"hbtn",onClick:I,children:"Cancel"}),F.jsx("button",{className:"hbtn danger",onClick:()=>z(V.id),children:"Delete"})]})]}):F.jsxs(F.Fragment,{children:[F.jsxs("div",{className:"dir-card-head",onClick:()=>U(V),children:[F.jsx("strong",{children:V.district||"Unnamed"}),F.jsx("span",{className:"dir-card-sub",children:V.division})]}),F.jsx(ef,{record:V})]})},V.id)),Object.keys(e).length===0&&F.jsx("div",{className:"dir-empty",children:"No courts yet."})]})]}),_==="attorneys"&&F.jsxs("div",{className:"dir-section",children:[F.jsxs("div",{className:"dir-head",children:[F.jsx("h3",{children:"Attorney Profiles"}),F.jsx("button",{className:"hbtn accent",onClick:de,children:"+ Add Attorney"})]}),F.jsx("p",{className:"dir-desc",children:"Reusable attorney profiles. Select as Attorney 1 or 2 on any petition."}),F.jsxs("div",{className:"dir-list",children:[Object.values(r).map(V=>F.jsx("div",{className:`dir-card ${E===V.id?"editing":""}`,children:E===V.id?F.jsxs(F.Fragment,{children:[FU.map(B=>F.jsxs("div",{className:"frow",children:[F.jsx("label",{className:"flbl",children:B.label}),F.jsx("input",{className:"finp",value:O[B.key]||"",placeholder:B.ph||"",onChange:te=>C(he=>({...he,[B.key]:te.target.value}))})]},B.key)),F.jsxs("div",{className:"dir-card-actions",children:[F.jsx("button",{className:"hbtn accent",onClick:_e,children:"Save"}),F.jsx("button",{className:"hbtn",onClick:I,children:"Cancel"}),F.jsx("button",{className:"hbtn danger",onClick:()=>le(V.id),children:"Delete"})]})]}):F.jsxs(F.Fragment,{children:[F.jsxs("div",{className:"dir-card-head",onClick:()=>U(V),children:[F.jsx("strong",{children:V.name||"Unnamed"}),F.jsxs("span",{className:"dir-card-sub",children:[V.firm,"  ",V.barNo]})]}),F.jsxs("div",{className:"dir-card-detail",children:[V.email,"  ",V.phone]}),F.jsx(ef,{record:V})]})},V.id)),Object.keys(r).length===0&&F.jsx("div",{className:"dir-empty",children:"No attorney profiles yet."})]})]}),_==="national"&&F.jsxs("div",{className:"dir-section",children:[F.jsx("div",{className:"dir-head",children:F.jsx("h3",{children:"National Defaults"})}),F.jsx("p",{className:"dir-desc",children:"These auto-fill on every petition. Update when officials change."}),F.jsxs("div",{className:"dir-card editing",children:[jU.map(V=>F.jsxs("div",{className:"frow",children:[F.jsx("label",{className:"flbl",children:V.label}),F.jsx("input",{className:"finp",value:t[V.key]||"",placeholder:V.ph||"",onChange:B=>Ce(V.key,B.target.value)})]},V.key)),F.jsx(ef,{record:t})]})]})]})]})}const lP={title:"blk-title",heading:"blk-heading",para:"blk-para","cap-name":"blk-cap-name","cap-center":"blk-cap-center","cap-resp":"blk-cap-resp","cap-case":"blk-cap-case","cap-doctitle":"blk-cap-doctitle",sig:"blk-sig","sig-label":"blk-sig-label"};function Lu({block:a,vars:e,onEdit:t,readOnly:r}){const n=kt.useRef(null),s=kt.useRef(!1),l=kt.useCallback(d=>d.replace(/\n/g,"<br/>").replace(/\{\{(\w+)\}\}/g,(v,p)=>{var _;const m=(_=e[p])==null?void 0:_.trim();return m?`<span data-var="${p}" contenteditable="false" class="vf">${m}</span>`:`<span data-var="${p}" contenteditable="false" class="ve">${p}</span>`}),[e]),c=kt.useCallback(d=>{const h=d.cloneNode(!0);return h.querySelectorAll("br").forEach(v=>v.replaceWith(`
`)),h.querySelectorAll("[data-var]").forEach(v=>v.replaceWith(`{{${v.dataset.var}}}`)),h.textContent||""},[]);return kt.useEffect(()=>{!s.current&&n.current&&(n.current.innerHTML=l(a.content))},[a.content,e,l]),F.jsx("div",{ref:n,contentEditable:!r,suppressContentEditableWarning:!0,onFocus:r?void 0:()=>{s.current=!0},onBlur:r?void 0:()=>{if(s.current=!1,!n.current)return;const d=c(n.current),h=v=>v.replace(/\s+/g," ").trim();h(d)!==h(a.content)&&(t==null||t(a.id,d,a.content)),n.current.innerHTML=l(h(d)!==h(a.content)?d:a.content)},className:`blk ${lP[a.type]||"blk-para"}`,"data-block-id":a.id})}const ew=816,SC=1056,qu=96,tw=SC-2*qu-28,bC=new Set(["ct-1","ct-2","ct-3"]),_C=["cap-pet","cap-role","cap-v","cap-r1","cap-r2","cap-r3","cap-r4","cap-r5","cap-r6"],EC=["cap-case","cap-title"],uP=new Set([...bC,..._C,...EC]);function cP({blocks:a,vars:e,onEdit:t,caseNo:r}){const n=kt.useRef(null),[s,l]=kt.useState([]),[c,d]=kt.useState(0),h=kt.useMemo(()=>a.filter(_=>!uP.has(_.id)),[a]);kt.useEffect(()=>{d(_=>_+1)},[a,e]),kt.useLayoutEffect(()=>{var D;const _=n.current;if(!_)return;const b=((D=_.querySelector("[data-mr='cap']"))==null?void 0:D.offsetHeight)||0,M=Array.from(_.querySelectorAll("[data-mr='body']>[data-block-id]")).map(w=>({id:w.dataset.blockId,h:w.offsetHeight})),O=[];let C=[],U=tw-b,I=0;for(const{id:w,h:N}of M)N>U&&C.length>0&&(O.push({ids:C,first:I===0}),C=[],U=tw,I++),C.push(w),U-=N;(C.length>0||O.length===0)&&O.push({ids:C,first:I===0}),l(O)},[c]);const v=kt.useMemo(()=>{const _={};return a.forEach(b=>{_[b.id]=b}),_},[a]),p=s.length||1,m=_=>F.jsxs(F.Fragment,{children:[a.filter(b=>bC.has(b.id)).map(b=>F.jsx(Lu,{block:b,vars:e,onEdit:_?t:()=>{},readOnly:!_},b.id)),F.jsxs("div",{className:"caption-grid",children:[F.jsx("div",{className:"cap-left-col",children:a.filter(b=>_C.includes(b.id)).map(b=>F.jsx(Lu,{block:b,vars:e,onEdit:_?t:()=>{},readOnly:!_},b.id))}),F.jsx("div",{className:"cap-mid-col",children:Array.from({length:24}).map((b,E)=>F.jsx("div",{children:")"},E))}),F.jsx("div",{className:"cap-right-col",children:a.filter(b=>EC.includes(b.id)).map(b=>F.jsx(Lu,{block:b,vars:e,onEdit:_?t:()=>{},readOnly:!_},b.id))})]})]});return F.jsxs(F.Fragment,{children:[F.jsxs("div",{ref:n,className:"measure-box","aria-hidden":"true",style:{width:ew-2*qu},children:[F.jsx("div",{"data-mr":"cap",children:m(!1)}),F.jsx("div",{"data-mr":"body",children:h.map(_=>F.jsx(Lu,{block:_,vars:e,onEdit:()=>{},readOnly:!0},_.id))})]}),s.map((_,b)=>F.jsx("div",{className:"page-shell",children:F.jsxs("div",{className:"page-paper",style:{width:ew,height:SC},children:[F.jsxs("div",{className:"page-margin",style:{padding:qu,paddingBottom:0},children:[_.first&&m(!0),_.ids.map(E=>{const M=v[E];return M?F.jsx(Lu,{block:M,vars:e,onEdit:t},M.id):null})]}),F.jsxs("div",{className:"page-foot",style:{height:qu,padding:`12px ${qu}px 0`},children:[F.jsx("span",{children:r}),F.jsxs("span",{children:["Page ",b+1," of ",p]})]})]})},b))]})}function rf({label:a,items:e,displayKey:t,value:r,onChange:n,onNew:s}){return F.jsxs("div",{className:"picker",children:[F.jsx("label",{className:"flbl",children:a}),F.jsxs("div",{className:"picker-row",children:[F.jsxs("select",{className:"finp picker-sel",value:r||"",onChange:l=>n(l.target.value),children:[F.jsx("option",{value:"",children:" Select "}),e.map(l=>F.jsx("option",{value:l.id,children:typeof t=="function"?t(l):l[t]||l.id},l.id))]}),s&&F.jsx("button",{className:"hbtn sm",onClick:s,children:"+"})]})]})}function dP(){var _e;const{petitions:a,clients:e,facilities:t,courts:r,attProfiles:n,national:s,selectedPetitionId:l,editorTab:c,log:d,setEditorTab:h,updatePetition:v,updateClient:p,pushLog:m,setView:_}=Ds(),b=kt.useRef(null),E=l?a[l]:null,M=E?e[E.clientId]:null,O=E!=null&&E._att1Id?n[E._att1Id]:null,C=E!=null&&E._att2Id?n[E._att2Id]:null,U=E?dC(M||{},E,O||{},C||{},s):{},I=(_e=E==null?void 0:E.caseNumber)!=null&&_e.trim()?`C/A No. ${E.caseNumber}`:"",D=kt.useCallback((le,Ce,V)=>{E&&(v(E.id,{...E,blocks:E.blocks.map(B=>B.id===le?{...B,content:Ce}:B)}),m({op:"REVISE",target:le,payload:Ce,frame:{t:gt(),prior:V,petition:E.id}}))},[E,v,m]),w=(le,Ce)=>{E&&(v(E.id,{...E,[le]:Ce}),m({op:"FILL",target:`petition.${le}`,payload:Ce,frame:{t:gt(),entity:"petition",id:E.id}}))},N=(le,Ce)=>{M&&(p(M.id,{...M,[le]:Ce}),m({op:"FILL",target:`client.${le}`,payload:Ce,frame:{t:gt(),entity:"client",id:M.id}}))},A=le=>{if(!E)return;const Ce=t[le];Ce&&(v(E.id,{...E,facilityName:Ce.name,facilityCity:Ce.city,facilityState:Ce.state,warden:Ce.warden,fieldOfficeName:Ce.fieldOfficeName,fieldOfficeDirector:Ce.fieldOfficeDirector,_facilityId:le}),m({op:"APPLY",target:"facility",payload:le,frame:{t:gt(),petition:E.id}}))},K=le=>{if(!E)return;const Ce=r[le];Ce&&(v(E.id,{...E,district:Ce.district,division:Ce.division,_courtId:le}),m({op:"APPLY",target:"court",payload:le,frame:{t:gt(),petition:E.id}}))},z=(le,Ce)=>{E&&(v(E.id,{...E,[le]:Ce}),m({op:"APPLY",target:le==="_att1Id"?"att1":"att2",payload:Ce,frame:{t:gt(),petition:E.id}}))},de=Object.values(n);return E?F.jsxs("div",{className:"editor-view",children:[F.jsxs("div",{className:"ed-sidebar",children:[F.jsx("div",{className:"ed-tabs",children:[["client","Client"],["court","Court + Facility"],["atty","Attorneys"],["filing","Filing"],["log",`Log (${d.length})`]].map(([le,Ce])=>F.jsx("button",{className:`ed-tab ${c===le?"on":""}`,onClick:()=>h(le),children:Ce},le))}),F.jsxs("div",{className:"ed-fields",children:[c==="client"&&M&&F.jsx(Uo,{title:"Client (shared)",fields:vC,data:M,onChange:N}),c==="court"&&F.jsxs(F.Fragment,{children:[F.jsx(rf,{label:"Select Court",items:Object.values(r),displayKey:le=>`${le.district}  ${le.division}`,value:E._courtId||"",onChange:K,onNew:()=>_("directory")}),F.jsx(Uo,{title:"Court (manual override)",fields:hC,data:E,onChange:w}),F.jsx("div",{style:{height:8}}),F.jsx(rf,{label:"Select Facility",items:Object.values(t),displayKey:le=>`${le.name}  ${le.city}, ${le.state}`,value:E._facilityId||"",onChange:A,onNew:()=>_("directory")}),F.jsx(Uo,{title:"Facility (manual override)",fields:fC,data:E,onChange:w}),F.jsx(Uo,{title:"Respondents (manual override)",fields:VU,data:E,onChange:w})]}),c==="atty"&&F.jsxs(F.Fragment,{children:[F.jsx(rf,{label:"Attorney 1",items:de,displayKey:le=>`${le.name}  ${le.firm}`,value:E._att1Id||"",onChange:le=>z("_att1Id",le),onNew:()=>_("directory")}),F.jsx(rf,{label:"Attorney 2",items:de,displayKey:le=>`${le.name}  ${le.firm}`,value:E._att2Id||"",onChange:le=>z("_att2Id",le),onNew:()=>_("directory")}),!E._att1Id&&!E._att2Id&&F.jsx("p",{style:{fontSize:11,color:"#aaa",marginTop:8},children:"Select attorney profiles from the Directory, or add new ones with +"})]}),c==="filing"&&F.jsx(Uo,{title:"Filing",fields:qU,data:E,onChange:w}),c==="log"&&F.jsxs("div",{className:"lscroll",children:[d.length===0&&F.jsx("div",{className:"lempty",children:"No operations yet."}),d.map((le,Ce)=>{const V={FILL:"#5aa06f",REVISE:"#c9a040",CREATE:"#7a70c0",STAGE:"#4a7ab5",APPLY:"#60a0d0",UPDATE:"#a08540",DELETE:"#c05050"};return F.jsxs("div",{className:"lentry",children:[F.jsx("span",{className:"lts",children:new Date(le.frame.t).toLocaleTimeString("en-US",{hour12:!1})})," ",F.jsx("span",{style:{color:V[le.op]||"#888",fontWeight:600},children:le.op}),F.jsx("span",{className:"ld",children:"("}),F.jsx("span",{className:"lt",children:le.target}),le.payload!=null&&F.jsxs(F.Fragment,{children:[F.jsx("span",{className:"ld",children:", "}),F.jsx("span",{className:"lp",children:typeof le.payload=="string"?`"${le.payload.slice(0,25)}${le.payload.length>25?"":""}"`:""})]}),F.jsx("span",{className:"ld",children:")"})]},Ce)}),F.jsx("div",{ref:b})]})]})]}),F.jsxs("div",{className:"doc-scroll",children:[F.jsx(cP,{blocks:E.blocks,vars:U,onEdit:D,caseNo:I}),F.jsx("div",{style:{height:60,flexShrink:0}})]})]}):F.jsx("div",{className:"editor-view",children:F.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#aaa"},children:"No petition selected."})})}function fP(a,e){const r=vi().getRoom(a);return(r==null?void 0:r.currentState).getStateEvents(e)||[]}function TC(a,e,t){const n=vi().getRoom(a);return(n==null?void 0:n.currentState).getStateEvents(e,t)}async function hP(){vi();const a=mC(),e={};for(const t of a){const r=TC(t,pC,"");if(r){const n=r.getContent();if(n&&!n.deleted){const s=n.id||t;e[s]={id:s,name:n.name||"",country:n.country||"",yearsInUS:n.yearsInUS||"",entryDate:n.entryDate||"",entryMethod:n.entryMethod||"without inspection",apprehensionLocation:n.apprehensionLocation||"",apprehensionDate:n.apprehensionDate||"",criminalHistory:n.criminalHistory||"",communityTies:n.communityTies||"",createdAt:new Date(r.getTs()).toISOString(),roomId:t}}}}return e}async function vP(){var t;const a=mC(),e={};for(const r of a){const n=fP(r,WU);for(const s of n){const l=s.getStateKey(),c=s.getContent();if(!l||!c||c.deleted)continue;const d=TC(r,YU,l),h=((t=d==null?void 0:d.getContent())==null?void 0:t.blocks)||[];e[l]={id:l,clientId:c.clientId||"",createdBy:s.getSender()||"",stage:c.stage||"drafted",stageHistory:c.stageHistory||[{stage:"drafted",at:new Date(s.getTs()).toISOString()}],blocks:h,district:c.district||"",division:c.division||"",caseNumber:c.caseNumber||"",facilityName:c.facilityName||"",facilityCity:c.facilityCity||"",facilityState:c.facilityState||"",warden:c.warden||"",fieldOfficeDirector:c.fieldOfficeDirector||"",fieldOfficeName:c.fieldOfficeName||"",filingDate:c.filingDate||"",filingDay:c.filingDay||"",filingMonthYear:c.filingMonthYear||"",templateId:c.templateId,att1Id:c.att1Id,att2Id:c.att2Id,_facilityId:c._facilityId,_courtId:c._courtId,_att1Id:c._att1Id,_att2Id:c._att2Id,createdAt:new Date(s.getTs()).toISOString(),roomId:r}}}return e}const wC=new Set(["ct-1","ct-2","ct-3"]),RC=["cap-pet","cap-role","cap-v","cap-r1","cap-r2","cap-r3","cap-r4","cap-r5","cap-r6"],CC=["cap-case","cap-title"],gP=new Set([...wC,...RC,...CC]);function pP(a,e){return a.replace(/\{\{(\w+)\}\}/g,(t,r)=>{var n;return((n=e[r])==null?void 0:n.trim())||`[${r}]`})}function xu(a,e){return pP(a,e).replace(/\n/g,"<br>")}function IC(a,e){const t=a.filter(c=>wC.has(c.id)).map(c=>`<div class="title">${xu(c.content,e)}</div>`).join(""),r=a.filter(c=>RC.includes(c.id)).map(c=>`<div class="${c.type==="cap-name"?"cn":c.type==="cap-center"?"cc":"rr"}">${xu(c.content,e)}</div>`).join(""),n=a.filter(c=>CC.includes(c.id)).map(c=>`<div class="${c.type==="cap-case"?"ck":"cd"}">${xu(c.content,e)}</div>`).join(""),s=a.filter(c=>!gP.has(c.id)).map(c=>{const d=c.type==="heading"?"heading":c.type==="sig"?"sig":c.type==="sig-label"?"sig-label":"para",h=c.type==="heading"?xu(c.content,e).toUpperCase():xu(c.content,e);return`<div class="${d}">${h}</div>`}).join(""),l=Array(24).fill(")").join("<br>");return`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>@page{size:8.5in 11in;margin:1in}body{font-family:"Times New Roman",serif;font-size:12pt;line-height:1.35}.title{text-align:center;font-weight:bold;margin:0}.heading{font-weight:bold;text-transform:uppercase;margin:18pt 0 6pt}.para{margin:0 0 10pt;text-align:justify}.sig{white-space:pre-line;margin:0 0 10pt}.sig-label{font-style:italic}table.c{width:100%;border-collapse:collapse;margin:18pt 0}table.c td{vertical-align:top;padding:0 4pt}.cl{width:55%}.cm{width:5%;text-align:center}.cr{width:40%}.cn{text-align:center;font-weight:bold}.cc{text-align:center;margin:10pt 0}.rr{margin:0 0 8pt}.ck{margin:0 0 12pt}.cd{font-weight:bold}</style></head><body>${t}<table class="c"><tr><td class="cl">${r}</td><td class="cm">${l}</td><td class="cr">${n}</td></tr></table>${s}</body></html>`}function mP(a,e,t){const r=IC(a,e),n=new Blob(["\uFEFF"+r],{type:"application/msword"}),s=URL.createObjectURL(n),l=document.createElement("a");l.href=s,l.download=`habeas-${(t||"petition").replace(/\s+/g,"-").toLowerCase()}-${new Date().toISOString().slice(0,10)}.doc`,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(s)},100)}function yP(a,e){const t=window.open("","_blank","width=850,height=1100");if(!t){alert("Allow popups for PDF export");return}t.document.write(IC(a,e)),t.document.close(),setTimeout(()=>{t.focus(),t.print()},500)}function SP(){var Ce;const[a,e]=kt.useState(!1),[t,r]=kt.useState(!0),[n,s]=kt.useState(""),{currentView:l,selectedPetitionId:c,petitions:d,clients:h,national:v,attProfiles:p,role:m,setView:_,setRole:b,setCurrentUser:E,setFacilities:M,setCourts:O,setAttProfiles:C,setNational:U,setClients:I,setPetitions:D}=Ds(),w=kt.useCallback(async()=>{var V,B;try{const[te,he,be,De]=await Promise.all([XU(),$U(),ZU(),yC()]);M(te),O(he),C(be),U(De);const W=await hP();I(W);const ue=await vP();D(ue);const we=vi(),Z=await Un(),pe=we.getRoom(Z);if(pe){const G=pe.currentState.getStateEvents("m.room.power_levels",""),q=((B=(V=G==null?void 0:G.getContent())==null?void 0:V.users)==null?void 0:B[we.getUserId()])??0;b(q>=50?"admin":"attorney")}else b("attorney");E(we.getUserId()||"")}catch(te){console.error("Hydration error:",te),s((te==null?void 0:te.message)||"Failed to sync data from server")}},[M,O,C,U,I,D,b,E]);kt.useEffect(()=>{(async()=>{const B=MU();if(B)try{await cC(B.baseUrl,B.userId,B.accessToken),e(!0),await w()}catch(te){console.error("Session restore failed:",te),XT()}r(!1)})()},[w]);const N=async()=>{e(!0);try{await w()}catch(V){s((V==null?void 0:V.message)||"Failed to load data. The app will work in local mode.")}},A=()=>{XT(),e(!1),s("")};if(t)return F.jsx("div",{className:"loading-wrap",children:F.jsx("div",{className:"loading-text",children:"Connecting..."})});if(!a)return F.jsx(PU,{onLogin:N});const K=c?d[c]:null,z=K?h[K.clientId]:null,de=K!=null&&K._att1Id?p[K._att1Id]:null,_e=K!=null&&K._att2Id?p[K._att2Id]:null,le=K?dC(z||{},K,de||{},_e||{},v):{};return F.jsxs("div",{className:"root",children:[n&&F.jsxs("div",{className:"sync-banner",children:[n,F.jsx("button",{onClick:()=>s(""),style:{marginLeft:12,background:"none",border:"1px solid rgba(255,255,255,.4)",color:"#fff",padding:"2px 8px",borderRadius:3,cursor:"pointer",fontSize:11},children:"Dismiss"})]}),F.jsxs("header",{className:"hdr",children:[F.jsxs("div",{className:"hdr-left",children:[F.jsx("span",{className:"hdr-brand",children:"Habeas"}),F.jsx("nav",{className:"hdr-nav",children:[["board","Board"],["clients","Clients"],["directory","Directory"],...K?[["editor","Editor"]]:[]].map(([V,B])=>F.jsx("button",{className:`nav-btn ${l===V?"on":""}`,onClick:()=>_(V),children:B},V))})]}),F.jsxs("div",{className:"hdr-right",children:[F.jsx("span",{className:"role-badge",style:{color:m==="admin"?"#a08540":"#8a8a9a"},children:m==="admin"?"Admin":"Attorney"}),K&&F.jsxs(F.Fragment,{children:[F.jsx("span",{className:"stage-badge",style:{background:(Ce=hc[K.stage])==null?void 0:Ce.color},children:K.stage}),F.jsx("button",{className:"hbtn export",onClick:()=>mP(K.blocks,le,z==null?void 0:z.name),children:"Word"}),F.jsx("button",{className:"hbtn export",onClick:()=>yP(K.blocks,le),children:"PDF"})]}),F.jsx("button",{className:"hbtn",onClick:A,children:"Sign Out"})]})]}),l==="board"&&F.jsx(GU,{}),l==="directory"&&F.jsx(oP,{}),l==="clients"&&F.jsx(zU,{}),l==="editor"&&F.jsx(dP,{})]})}QO.createRoot(document.getElementById("root")).render(F.jsx(kt.StrictMode,{children:F.jsx(SP,{})}));export{PD as A,Yi as B,tr as C,Em as D,$ as E,F0 as F,ct as G,Om as H,Xt as I,dr as J,We as K,bP as L,se as M,zt as N,Oa as O,No as P,Oe as Q,zo as R,ci as S,Fr as T,Ju as U,Ts as V,bc as W,y as _,R as a,EP as b,Ie as c,Ar as d,Vf as e,Yw as f,Hi as g,nR as h,Pt as i,al as j,Va as k,T as l,Rm as m,Xn as n,Yf as o,qa as p,hr as q,qt as r,Ba as s,DD as t,Kr as u,hR as v,Tm as w,Qn as x,_m as y,If as z};
